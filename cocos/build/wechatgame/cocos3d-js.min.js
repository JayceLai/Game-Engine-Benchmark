var cc_modular=function(Zt){"use strict";function fe(e){return(fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function S(e){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function T(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_(e):t}function o(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}function p(e,t,i){return(p="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=o(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function a(e,t,i,n){return(a="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,a=o(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else s(n,t,i);return!0})(e,t,i,n)}function b(e,t,i,n,r){if(!a(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function x(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function m(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function c(i,n,e,t,r){var a={};return Object.keys(t).forEach(function(e){a[e]=t[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(i,n,a),a=null),a}var r="undefined"==typeof window?global:window,e=r.cc=r.cc||{};function t(e,t){void 0===r[e]&&(r[e]=t)}e.internal=e.internal||{},e._global=r,t("CC_BUILD",!1),r.CC_BUILD=!0,r.CC_TEST=!1,r.CC_EDITOR=!1,r.CC_PREVIEW=!1,r.CC_DEV=!1,r.CC_DEBUG=!1,r.CC_JSB=!1,r.CC_WECHATGAME_SUB=!1,r.CC_WECHATGAME=!0,r.CC_QQPLAY=!1,r.CC_RUNTIME=!1,r.CC_SUPPORT_JIT=!1,r.CC_PHYSICS_BUILT_IN=!1,r.CC_PHYSICS_CANNON=!1,r.CC_PHYSICS_AMMO=!1;r.CocosEngine=e.ENGINE_VERSION="1.0.0 beta";var u=null,h=console.log,f=console.log,v=console.log,g=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+E.apply(void 0,[t].concat(n)))}};function E(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function w(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return h.apply(void 0,[e].concat(i))}function A(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return f.apply(void 0,[e].concat(i))}function C(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return v.apply(void 0,[e].concat(i))}function k(e,t){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return g.apply(void 0,[e,t].concat(n))}function R(e){if(h=f=v=g=function(){},e!==B.NONE){if(e>B.ERROR){var a=function(e){if(cc.game.canvas){if(!u){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(u=document.createElement("textarea")).setAttribute("rows","20"),u.setAttribute("cols","30"),u.setAttribute("disabled","true");var n=u.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(u),cc.game.canvas.parentNode.appendChild(t)}u.value=u.value+e+"\r\n",u.scrollTop=u.scrollHeight}};v=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("ERROR :  "+E.apply(void 0,[e].concat(i)))},g=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];a("ASSERT: "+E.apply(void 0,[t].concat(n)))}},e!==B.ERROR_FOR_WEB_PAGE&&(f=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("WARN :  "+E.apply(void 0,[e].concat(i)))}),e===B.INFO_FOR_WEB_PAGE&&(h=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a(E.apply(void 0,[e].concat(i)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),v=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},g=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=E.apply(void 0,[t].concat(n));throw new Error(a)}});e!==B.ERROR&&(f=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===B.INFO&&(h=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function O(e){var t=e.stack;C(t||e)}function M(a){return function(e){for(var t="".concat(a," ").concat(e,", please go to ").concat("https://github.com/cocos-creator/engine/blob/master/EngineErrorMap.md","#").concat(e," to see details."),i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return 0===n.length?t:t+" Arguments: "+n.join(", ")}}var L=M("Log");function I(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];w(L.apply(void 0,[e].concat(i)))}var F=M("Warning");function P(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];A(F.apply(void 0,[e].concat(i)))}var D=M("Error");function z(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];C(D.apply(void 0,[e].concat(i)))}var B,N,U=M("Assert");function G(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];k(!1,U.apply(void 0,[t].concat(n)))}}function V(e,t){return D(e,t)}function H(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}(N=B||(B={}))[N.NONE=0]="NONE",N[N.INFO=1]="INFO",N[N.WARN=2]="WARN",N[N.ERROR=3]="ERROR",N[N.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",N[N.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",N[N.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE";var j=Object.freeze({log:w,warn:A,error:C,assert:k,_resetDebugSetting:R,_throw:O,logID:I,warnID:P,errorID:z,assertID:G,get DebugMode(){return B},getError:V,isDisplayStats:function(){return!!cc.profiler&&cc.profiler.isShowingStats()},setDisplayStats:H}),W=/(\.[^\.\/\?\\]*)(\?.*)?$/,X=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,q=/[^\.\/]+\/\.\.\//;function Y(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){e=(e+(""===e?"":"/")+a[r]).replace(/(\/|\\\\)$/,"")}return e}function K(e){var t=W.exec(e);return t?t[1]:""}function Q(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Z(e,t){var i=e.indexOf("?");0<i&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function J(e){var t=X.exec(e);return t?t[2]:""}function $(e,t){t=t||"";var i=e.indexOf("?"),n="";return 0<i&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function ee(e,t,i){if(0===t.indexOf("."))return $(e,t);var n=e.indexOf("?"),r="",a=i?K(e):"";return 0<n&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function te(e){for(var t=e=String(e);e=(t=e).replace(q,""),t.length!==e.length;);return e}function ie(e){return e.replace(/[\/\\]$/,"")}function ne(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}var re=Object.freeze({join:Y,extname:K,mainFileName:Q,basename:Z,dirname:J,changeExtname:$,changeBasename:ee,_normalize:te,stripSep:ie,getSeperator:ne});cc.log=w,cc.warn=A,cc.error=C,cc.assert=k,cc._throw=O,cc.logID=I,cc.warnID=P,cc.errorID=z,cc.assertID=G,cc.debug=j,cc.path={join:Y,extname:K,mainFileName:Q,basename:Z,dirname:J,changeExtname:$,changeBasename:ee,_normalize:te,stripSep:ie,get sep(){return ne()}};var ae=function(){function t(e){y(this,t),this.array=e,this.i=0}return l(t,[{key:"remove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),t}();function se(e,t){e.splice(t,1)}function oe(e,t){var i=e.indexOf(t);return 0<=i&&(se(e,i),!0)}function le(e,t){return 0<=e.indexOf(t)}var ce=Object.freeze({removeAt:se,fastRemoveAt:function(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)},remove:oe,fastRemove:function(e,t){var i=e.indexOf(t);0<=i&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(0<=i){var n=e[i];return se(e,i),n}},verifyType:function(e,t){if(e&&0<e.length){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(!(a instanceof t))return cc.logID(1300),!1}}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)oe(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(x(t))),e},indexOf:function(e,t,i){return Array.prototype.indexOf.call(e,[t,i])},contains:le,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:ae}),ue=function(){function t(e){y(this,t),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return l(t,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),t}();ue.global=new ue("global");var he=new ue("TmpCId.");function _e(e){return"number"==typeof e||e instanceof Number}function de(e){return"string"==typeof e||e instanceof String}var pe,me,ve,ye,ge=(pe={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){pe.value=i,pe.writable=n,pe.enumerable=r,Object.defineProperty(e,t,pe),pe.value=void 0}),be=(me={get:void 0,set:void 0,enumerable:!1},function(e,t,i,n){var r=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=5<arguments.length&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof n&&(r=n,n=void 0),me.get=i,me.set=n,me.enumerable=r,me.configurable=a,Object.defineProperty(e,t,me),me.get=void 0,me.set=void 0}),Se=(ve={get:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){ve.get=i,ve.enumerable=n,ve.configurable=r,Object.defineProperty(e,t,ve),ve.get=void 0}),Te=(ye={set:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){ye.set=i,ye.enumerable=n,ye.configurable=r,Object.defineProperty(e,t,ye),ye.set=void 0});function xe(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function Ee(e){if("function"!=typeof e)return e&&e.constructor?Ee(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}function we(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],s=r.exec(i)[0];function o(){return this[s]}n?be(e,a,o,function(e){this[s]=e}):Se(e,a,o)}function Ae(e,t,i,n){for(var r in i){we(e,t+"."+r,i[r],n)}}var Ce=/(%d)|(%s)/,ke=/%s/;function Re(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&Ce.test(e))for(var r=0,a=i;r<a.length;r++){var s=a[r],o="number"==typeof s?Ce:ke;o.test(e)?e=e.replace(o,s):e+=" "+s}else for(var l=0,c=i;l<c.length;l++){e+=" "+c[l]}return e}function Oe(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Me(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function Le(e,t,i){var n=Me(t,e);n&&Object.defineProperty(i,e,n)}function Ie(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==fe(s)){cc.errorID(5402,s);continue}for(var o in s)o in e||Le(o,s,e)}}return e}function Fe(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==fe(s)){cc.errorID(5403,s);continue}for(var o in s)Le(o,s,e)}}return e}function Pe(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function De(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function ze(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=De(e)))return!1;if(e===t)return!0}}return!1}function Be(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var Ne={},Ue={};function Ge(e,t){var i="__cid__",n=Ne;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],ge(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a='A Class already exists with the same __cid__ : "'+e+'".';0,cc.error(a)}else n[e]=t}}function Ve(e,t){if(function(e,t){var i="__classname__",n=Ue;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],ge(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||he.getNewId();i&&Ge(i,t)}}function He(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n].prototype,s=a.__cid__;s&&delete Ne[s];var o=a.__classname__;o&&delete Ue[o]}}function je(e){return Ne[e]}function We(e){return Ue[e]}function Xe(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var qe=function(){function r(e,t){y(this,r),this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}return l(r,[{key:"get",value:function(){return this._get()}}]),l(r,[{key:"_get",value:function(){if(0<this.count){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),r}(),Ye=ce,Ke={IDGenerator:ue,Pool:qe,array:ce,isNumber:_e,isString:de,getPropertyDescriptor:Me,addon:Ie,mixin:Fe,extend:Pe,getSuper:De,isChildClassOf:ze,clear:Be,value:ge,getset:be,get:Se,set:Te,unregisterClass:He,getClassName:Ee,setClassName:Ve,getClassByName:We,_getClassId:Xe,_setClassId:Ge,_getClassById:je,obsolete:we,obsoletes:Ae,formatStr:Re,shiftArguments:Oe,createMap:xe};cc.js=Ke;var Qe=Object.freeze({array:Ye,js:Ke,IDGenerator:ue,Pool:qe,isNumber:_e,isString:de,value:ge,getset:be,get:Se,set:Te,createMap:xe,getClassName:Ee,obsolete:we,obsoletes:Ae,formatStr:Re,shiftArguments:Oe,getPropertyDescriptor:Me,addon:Ie,mixin:Fe,extend:Pe,getSuper:De,isChildClassOf:ze,clear:Be,_idToClass:Ne,_nameToClass:Ue,_setClassId:Ge,setClassName:Ve,unregisterClass:He,_getClassById:je,getClassByName:We,_getClassId:Xe}),Ze=function(){function n(e,t){y(this,n),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=e,this._idx=t-1,this._frees=new Array(t);for(var i=0;i<t;++i)this._frees[i]=e()}return l(n,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),n}(),Je=Ye.fastRemoveAt;function $e(){}var et=function(){function e(){y(this,e),this.callback=$e,this.target=void 0,this.once=!1}return l(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),tt=new Ze(function(){return new et},32),it=function(){function e(){y(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return l(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(tt.free(i),Je(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(tt.free(i),Je(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(tt.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(tt.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;0<=e;--e){this.callbackInfos[e]||Je(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),nt=new Ze(function(){return new it},16),rt=function(){function e(){y(this,e),this._callbackTable=xe(!0)}return l(e,[{key:"on",value:function(e,t,i,n){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=nt.alloc());var a=tt.alloc();a.set(t,i,n),r.callbackInfos.push(a)}},{key:"hasEventListener",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=this._callbackTable[e];if(!n)return!1;var r=n.callbackInfos;if(!t){if(n.isInvoking){var a=r,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}if(l)return!0}return!1}return 0<r.length}var c=r,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}var f=_;if(f&&f.callback===t&&f.target===i)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),nt.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var s=r[a];s&&s.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.callback===t&&s.target===i){n.isInvoking?n.cancel(a):(Je(r,a),tt.free(s));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var n=t.callbackInfos,r=arguments.length,a=new Array(1<r?r-1:0),s=1;s<r;s++)a[s-1]=arguments[s];for(var o=0,l=n.length;o<l;++o){var c=n[o];if(c){var u=c.callback,h=c.target;c.once&&this.off(e,u,h),h?u.call.apply(u,[h].concat(a)):u.apply(void 0,a)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var at=Ye.fastRemove,st=function(e){function r(){return y(this,r),T(this,S(r).apply(this,arguments))}return d(r,rt),l(r,[{key:"on",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){p(S(r.prototype),"on",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"off",value:function(e,t,i){if(t){p(S(r.prototype),"off",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?at(n.__eventTargets,this):n.node&&n.node.__eventTargets&&at(n.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){p(S(r.prototype),"on",this).call(this,e,t,i,!0);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}}]),r}();cc.EventTarget=st;var ot=function(){function i(e,t){y(this,i),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}return l(i,[{key:"unuse",value:function(){this.type=i.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=i.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),i}();ot.NO_TYPE="no_type",ot.TOUCH="touch",ot.MOUSE="mouse",ot.KEYBOARD="keyboard",ot.ACCELERATION="acceleration",ot.NONE=0,ot.CAPTURING_PHASE=1,ot.AT_TARGET=2,ot.BUBBLING_PHASE=3,cc.Event=ot;var lt=2147483647;function ct(e){return(0<e)-(e<0)}function ut(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}var ht=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(ht);for(var _t=Object.freeze({INT_BITS:32,INT_MAX:lt,INT_MIN:-1<<31,sign:ct,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(65535<e)<<4,t|=i=(255<(e>>>=t))<<3,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1},log10:function(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:ut,nextPow2:function(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)},prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return ht[255&e]<<24|ht[e>>>8&255]<<16|ht[e>>>16&255]<<8|ht[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return 1+t|(~t&-~t)-1>>>ut(e)+1}}),ft=/^(?:cc|dragonBones|sp|ccsg)\..+/,dt=new Array(123),pt=0;pt<123;++pt)dt[pt]=64;for(var mt=0;mt<64;++mt)dt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(mt)]=mt;var vt=dt;function yt(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];be(e,t,a,e[n])}}for(var r,a=e.prototype,s=0;s<t.length;s++){var o=(r=t[s])[0].toUpperCase()+r.slice(1);n(a,r,"get"+o,"set"+o)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function gt(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function bt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function St(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function Tt(e){return"object"===("undefined"==typeof window?"undefined":fe(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===fe(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function xt(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function Et(e,t,i,n){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(n)}function wt(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function At(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}cc.misc={BUILTIN_CLASSID_RE:ft,BASE64_VALUES:vt,propertyDefine:yt,nextPOT:gt,pushToMap:bt,contains:St,isDomNode:Tt,callInNextTick:xt,tryCatchFunctor_EDITOR:Et,isPlainEmptyObj_DEV:wt,cloneable_DEV:At};var Ct=Object.freeze({BUILTIN_CLASSID_RE:ft,BASE64_VALUES:vt,propertyDefine:yt,nextPOT:gt,pushToMap:bt,contains:St,isDomNode:Tt,callInNextTick:xt,tryCatchFunctor_EDITOR:Et,isPlainEmptyObj_DEV:wt,cloneable_DEV:At});function kt(e){if("__enums__"in e)return e;ge(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&ge(e,s,r)}return e}function Rt(e){"__enums__"in e||ge(e,"__enums__",null,!0)}kt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},kt.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.Enum=kt;var Ot="$_$";function Mt(e,t,i){var n;n=function(){},i&&Pe(n,i.constructor);var r=new n;return ge(e,"__attrs__",r),r}function Lt(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;0<=n;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||Mt(r,0,(t=i[n+1])&&t.__attrs__)}return Mt(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function It(e,t,i){var n,r;if("function"==typeof e)r=(n=Ft(e)).constructor.prototype;else{var a=e;if(!(n=a.__attrs__))n=Mt(a,0,Ft(e=a.constructor));r=n}if(void 0===i){var s=t+Ot,o={};for(var l in n)l.startsWith(s)&&(o[l.slice(s.length)]=n[l]);return o}if("object"===fe(i))for(var c in i)95!==c.charCodeAt(0)&&(r[t+Ot+c]=i[c]);else 0}function Ft(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||Lt(e)}function Pt(e){return Ft(e).constructor.prototype}function Dt(e,t,i,n){Pt(e)[t+Ot+i]=n}var zt=function(){function i(e,t){y(this,i),this.name=void 0,this.default=void 0,this.name=e,this.default=t}return l(i,[{key:"toString",value:function(){return this.name}}]),i}(),Bt=new zt("Integer",0);cc.Integer=Bt,cc.CCInteger=Bt;var Nt=new zt("Float",0);cc.Float=Nt,cc.CCFloat=Nt;var Ut=new zt("Boolean",!1);cc.Boolean=Ut,cc.CCBoolean=Ut;var Gt=new zt("String","");function Vt(l,c){return function(e,t){var i='"'+Ee(e)+"."+t+'"',n=It(e,t);if(!n.saveUrlAsAsset){var r=n.type;if(r===Bt||r===Nt?r="Number":r!==Gt&&r!==Ut||(r=r.toString()),r!==l)return void P(3604,i)}if(n.hasOwnProperty("default")){var a=n.default;if(void 0!==a)if(!(Array.isArray(a)||wt(a))){var s=fe(a),o=l.toLowerCase();if(s===o){if(!n.saveUrlAsAsset)if("object"===o){if(!a||a instanceof n.ctor)return;P(3605,i,Ee(n.ctor))}else"Number"!==l&&P(3606,c,i,l)}else{if("function"===s)return;l===Gt.default&&null==a?ze(n.ctor,cc.RawAsset)||P(3607,i):P(3611,c,i,s)}delete n.type}}}}function Ht(s){return function(e,t){Vt("Object","type")(e,t);var i=Ft(e)[t+Ot+"default"],n=cc.Class.getDefault(i);if(!Array.isArray(n)&&ze(s,cc.ValueType)){var r=Ee(s),a=Re('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Ee(e),t,r);i?w(a):P(3612,a,r,Ee(e),t,r)}}}cc.String=Gt,cc.CCString=Gt;var jt=Object.freeze({DELIMETER:Ot,createAttrsSingle:Mt,createAttrs:Lt,attr:It,getClassAttrs:Ft,getClassAttrsProto:Pt,setClassAttr:Dt,PrimitiveType:zt,CCInteger:Bt,CCFloat:Nt,CCBoolean:Ut,CCString:Gt,getTypeChecker:Vt,getObjTypeChecker:Ht}),Wt={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Xt(e,t,i,n){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var s in n[r]=a,Wt){var o=Wt[s];e.hasOwnProperty(s)&&(a[s]=e[s],o.canUsedInGet||delete e[s])}}else 0}function qt(e,t,i,n){if(Array.isArray(t)){if(!(0<t.length))return z(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Yt(e,t,i){if(e&&e.constructor===Object)return null;if(Array.isArray(e)&&0<e.length){e[0];return{default:[],type:e,_short:!0}}if("function"!=typeof e)return e instanceof zt?{default:e.default,_short:!0}:{default:e,_short:!0};var n=e;return cc.RawAsset.isRawAssetType(n)?{default:"",url:n,_short:!0}:{default:ze(n,cc.ValueType)?new n:null,type:n,_short:!0}}var Kt=[];function Qt(){return Kt[Kt.length-1]}cc._RF={push:function(e,t,i){void 0===i&&(i=t,t=""),Kt.push({uuid:t,script:i,module:e,exports:e.exports,beh:null})},pop:function(){var e=Kt.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:Qt};var Jt=Ot,$t=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function ei(e,t){e.indexOf(t)<0&&e.push(t)}var ti={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout(function(){t.init()},0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=Ee(n);r?mi(n,a,r,n.$super,i.mixins):z(3633,a)}this.datas=null}}};function ii(e,t){ei(e.__props__,t)}var ni=[];function ri(e,t,i,n,r){var a=n.default;Dt(e,i,"default",a),ii(e,i);var s=bi(e,n,t,i,!1);if(s){for(var o=ni,l=0;l<s.length;l++){var c=s[l];It(e,i,c),!1===c.serializable&&ei(e.__values__,i),c._onAfterProp&&o.push(c._onAfterProp)}for(var u=0;u<o.length;u++)o[u](e,i);ni.length=0,s.length=0}}function ai(e,t,i,n,r){var a=n.get,s=n.set,o=e.prototype,l=Object.getOwnPropertyDescriptor(o,i),c=!l;if(a){0;for(var u=bi(e,n,t,i,!0),h=0;h<u.length;h++)It(e,i,u[h]);u.length=0,Dt(e,i,"serializable",!1),r||Se(o,i,a,c,c)}s&&(r||Te(o,i,s,c,c))}function si(e){return"function"==typeof e?e():e}function oi(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,Me(t,n))}function li(e,t,i,n){var r,a,s=n.__ctor__,o=n.ctor,l=n.__ES6__;l?(r=[o],a=o):(r=s?[s]:function(e,t,i){function n(e){return vi._isCCClass(e)?e.__ctors__||[]:[e]}for(var r=[],a=[e].concat(t),s=0;s<a.length;s++){var o=a[s];if(o)for(var l=n(o),c=0;c<l.length;c++)ei(r,l[c])}var u=i.ctor;u&&r.push(u);return r}(t,i,n),a=_i(r,t,e,n),ge(a,"extend",function(e){return e.extends=this,vi(e)},!0)),ge(a,"__ctors__",0<r.length?r:null,!0);var c=a.prototype;if(t&&(l||(Pe(a,t),c=a.prototype),a.$super=t),i){for(var u=function(e){var t=i[e];oi(c,t.prototype),oi(a,t,function(e){return t.hasOwnProperty(e)&&!0}),vi._isCCClass(t)&&oi(Ft(a).constructor.prototype,Ft(t).constructor.prototype)},h=i.length-1;0<=h;h--)u(h);c.constructor=a}return l||(c.__initProps__=hi),Ve(e,a),a}function ci(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var ui=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function hi(e){var t=Ft(e),i=e.__props__;null===i&&(ti.init(),i=e.__props__);var n=function(e,t){for(var a=[],s=[],o=[],l=[],i=0;i<t.length;++i){var n=t[i],r=n+Jt+"default";if(r in e){var c=e[r];"object"===fe(c)&&c||"function"==typeof c?(a.push(n),s.push(c)):(o.push(n),l.push(c))}}return function(){for(var e=0;e<o.length;++e)this[o[e]]=l[e];for(var t=0;t<a.length;t++){var i=a[t],n=void 0,r=s[t];n="object"===fe(r)?r instanceof cc.ValueType?r.clone():Array.isArray(r)?[]:{}:r(),this[i]=n}}}(t,i);(e.prototype.__initProps__=n).call(this)}var _i=function(t,e,i,n){var r,a=e&&pi(e,n,i),s=t.length;return r=0<s?a?2===s?function(){this._super=null,this.__initProps__(r),t[0].apply(this,arguments),t[1].apply(this,arguments)}:function(){this._super=null,this.__initProps__(r);for(var e=0;e<t.length;++e)t[e].apply(this,arguments)}:3===s?function(){this.__initProps__(r),t[0].apply(this,arguments),t[1].apply(this,arguments),t[2].apply(this,arguments)}:function(){this.__initProps__(r);for(var e=r.__ctors__,t=0;t<e.length;++t)e[t].apply(this,arguments)}:function(){a&&(this._super=null),this.__initProps__(r)}};var fi=/xyz/.test(function(){}.toString()),di=fi?/\b\._super\b/:/.*/;function pi(e,t,i){var n=!1;for(var r in t)if(!(0<=$t.indexOf(r))){var a=t[r];if("function"==typeof a){var s=Me(e.prototype,r);if(s){var o=s.value;if("function"==typeof o){di.test(a)&&(n=!0,t[r]=function(i,n){return function(){var e=this._super;this._super=i;var t=n.apply(this,arguments);return this._super=e,t}}(o,a));continue}}0}}return n}function mi(t,e,i,n,r,a){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var s=0;s<r.length;++s){var o=r[s];o.__props__&&(t.__props__=t.__props__.concat(o.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i)for(var l in function(e,t,i,n){for(var r in e){var a=e[r],s=Yt(a);if(s&&(a=e[r]=s),a){var o=a.notify;o&&Xt(a,r,o,e),"type"in a&&qt(a,a.type,t,r),"url"in a&&(c=(l=a).url,Array.isArray(c)&&0<c.length&&(c=c[0]),l.type=c),"type"in a&&a.type}}var l,c}(i,e),i){var c=i[l];"default"in c?ri(t,e,l,c):ai(t,e,l,c,a)}var u=Ft(t);t.__values__=t.__props__.filter(function(e){return!1!==u[e+Jt+"serializable"]})}function vi(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=Qt();if(a&&ze(t,r)){if(ze(a.cls,r))return z(3615),null;e=e||a.script}var s=li(e,t,i,n);if(a)if(ze(t,r)){var o=a.uuid;o&&Ge(o,s),a.cls=s}else ze(a.cls,r)||(a.cls=s);return s}(t,i,n,e);t||(t=cc.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some(function(e){return null===e.__props__})?(ti.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):mi(r,t,a,i,e.mixins,e.__ES6__);var s,o,l=e.statics;if(l)for(s in l)r[s]=l[s];for(var c in e)if(!(0<=$t.indexOf(c))){var u=e[c];("function"==typeof(o=u)||null===o)&&ge(r.prototype,c,u,!0,!0)}var h=e.editor;return h&&ze(i,cc.Component)&&cc.Component._registerEditorProps(r,h),r}vi._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},vi.fastDefine=function(e,t,i){Ve(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=Pt(t),a=0;a<n.length;a++){var s=n[a];r[s+Jt+"visible"]=!1,r[s+Jt+"default"]=i[s]}},vi.Attr=jt,vi.attr=It,vi.getInheritanceChain=function(e){for(var t=[];e=De(e);)e!==Object&&t.push(e);return t};var yi={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},gi=[];function bi(e,n,t,i,r){var a=null,s="";function o(){return s=i+Jt,a=Pt(e)}gi.length=0;var l=gi,c=n.type;if(c){var u=yi[c];if(u)l.push({type:c,_onAfterProp:void 0});else if("Object"===c)0;else if("object"===fe(c))kt.isEnum(c)&&l.push({type:"Enum",enumList:kt.getList(c)});else if("function"==typeof c){var h;0,l.push({type:"Object",ctor:c,_onAfterProp:h})}else 0}var _=function(e,t){if(e in n){var i=n[e];fe(i)===t&&((a||o())[s+e]=i)}};n.editorOnly&&((a||o())[s+"editorOnly"]=!0),n.url&&((a||o())[s+"saveUrlAsAsset"]=!0),!1===n.serializable&&((a||o())[s+"serializable"]=!1),_("formerlySerializedAs","string");var f=n.range;return f&&Array.isArray(f)&&2<=f.length&&((a||o())[s+"min"]=f[0],(a||o())[s+"max"]=f[1],2<f.length&&((a||o())[s+"step"]=f[2])),_("min","number"),_("max","number"),_("step","number"),l}vi.isArray=function(e){return e=si(e),Array.isArray(e)},vi.getDefault=si,vi.escapeForJS=ci,vi.IDENTIFIER_RE=ui,vi.getNewValueTypeCode=!1,cc.Class=vi;var Si=function(){function e(){y(this,e)}return l(e,[{key:"clone",value:function(){return z(100,Ee(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){z(100,Ee(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}();Ve("cc.ValueType",Si),cc.ValueType=Si;var Ti=Math.PI/180,xi=180/Math.PI,Ei=1e-6;function wi(e,t,i){if(i<t){var n=t;t=i,i=n}return e<t?t:i<e?i:e}function Ai(e){return e<0?0:1<e?1:e}function Ci(e,t,i){return e+(t-e)*i}function ki(e){return e*Ti}function Ri(e){return e*xi}var Oi=Math.random;function Mi(e,t){return Math.random()*(t-e)+e}function Li(e,t){return Math.floor(Mi(e,t))}function Ii(e){return(e=(9301*e+49297)%233280)/233280}function Fi(e,t,i){return Ii(e)*(i-t)+t}function Pi(e,t){return e-Math.floor(e/t)*t}function Di(e,t){return e=Pi(e,2*t),e=t-Math.abs(e-t)}function zi(e,t,i){return(i-e)/(t-e)}var Bi=0,Ni=0,Ui=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this))).x=void 0,i.y=void 0,e&&"object"===fe(e)?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}return d(n,Si),l(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){return Bi=t.x-e.x,Ni=t.y-e.y,Math.sqrt(Bi*Bi+Ni*Ni)}},{key:"squaredDistance",value:function(e,t){return Bi=t.x-e.x,Ni=t.y-e.y,Bi*Bi+Ni*Ni}},{key:"len",value:function(e){return Bi=e.x,Ni=e.y,Math.sqrt(Bi*Bi+Ni*Ni)}},{key:"lengthSqr",value:function(e){return Bi=e.x,Ni=e.y,Bi*Bi+Ni*Ni}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){return Bi=t.x,Ni=t.y,Math.abs(Bi)<Ei?e.x=0:e.x=1/Bi,Math.abs(Ni)<Ei?e.y=0:e.y=1/Ni,e}},{key:"normalize",value:function(e,t){Bi=t.x,Ni=t.y;var i=Bi*Bi+Ni*Ni;return 0<i&&(i=1/Math.sqrt(i),e.x=Bi*i,e.y=Ni*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){return Bi=t.x,Ni=t.y,e.x=Bi+n*(i.x-Bi),e.y=Ni+n*(i.y-Ni),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Oi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){return Bi=t.x,Ni=t.y,e.x=i.m00*Bi+i.m03*Ni+i.m06,e.y=i.m01*Bi+i.m04*Ni+i.m07,e}},{key:"transformMat4",value:function(e,t,i){return Bi=t.x,Ni=t.y,e.x=i.m00*Bi+i.m04*Ni+i.m12,e.y=i.m01*Bi+i.m05*Ni+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(Gi,e),n.normalize(Vi,t);var i=n.dot(Gi,Vi);return 1<i?0:i<-1?Math.PI:Math.acos(i)}}]),l(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===fe(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ei;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){return Bi=this.x,Ni=this.y,this.x=Bi+t*(e.x-Bi),this.y=Ni+t*(e.y-Ni),this}},{key:"clampf",value:function(e,t){return this.x=wi(this.x,e.x,t.x),this.y=wi(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===fe(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==fe(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){Bi=this.x,Ni=this.y;var e=Bi*Bi+Ni*Ni;return 0<e&&(e=1/Math.sqrt(e),this.x=this.x*e,this.y=this.y*e),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=wi(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){Bi=this.x,Ni=this.y;var t=Math.sin(e),i=Math.cos(e);return this.x=i*Bi-t*Ni,this.y=t*Bi+i*Ni,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){return Bi=this.x,Ni=this.y,this.x=e.m00*Bi+e.m04*Ni+e.m12,this.y=e.m01*Bi+e.m05*Ni+e.m13,this}}]),n}();Ui.ZERO=Object.freeze(new Ui(0,0)),Ui.ONE=Object.freeze(new Ui(1,1)),Ui.NEG_ONE=Object.freeze(new Ui(-1,-1)),Ui.UNIT_X=Object.freeze(new Ui(1,0)),Ui.UNIT_Y=Object.freeze(new Ui(0,1));var Gi=new Ui,Vi=new Ui;vi.fastDefine("cc.Vec2",Ui,{x:0,y:0}),cc.Vec2=Ui,cc.v2=function(e,t){return new Ui(e,t)};var Hi=0,ji=0,Wi=0,Xi=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this))).x=void 0,n.y=void 0,n.z=void 0,e&&"object"===fe(e)?(n.x=e.x,n.y=e.y,n.z=e.z):(n.x=e||0,n.y=t||0,n.z=i||0),n}return d(r,Si),l(r,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){return Hi=t.x-e.x,ji=t.y-e.y,Wi=t.z-e.z,Math.sqrt(Hi*Hi+ji*ji+Wi*Wi)}},{key:"squaredDistance",value:function(e,t){return Hi=t.x-e.x,ji=t.y-e.y,Wi=t.z-e.z,Hi*Hi+ji*ji+Wi*Wi}},{key:"len",value:function(e){return Hi=e.x,ji=e.y,Wi=e.z,Math.sqrt(Hi*Hi+ji*ji+Wi*Wi)}},{key:"lengthSqr",value:function(e){return Hi=e.x,ji=e.y,Wi=e.z,Hi*Hi+ji*ji+Wi*Wi}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){return Hi=t.x,ji=t.y,Wi=t.z,Math.abs(Hi)<Ei?e.x=0:e.x=1/Hi,Math.abs(ji)<Ei?e.y=0:e.y=1/ji,Math.abs(Wi)<Ei?e.z=0:e.z=1/Wi,e}},{key:"normalize",value:function(e,t){Hi=t.x,ji=t.y,Wi=t.z;var i=Hi*Hi+ji*ji+Wi*Wi;return 0<i&&(i=1/Math.sqrt(i),e.x=Hi*i,e.y=ji*i,e.z=Wi*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){return e.x=t.y*i.z-t.z*i.y,e.y=t.z*i.x-t.x*i.z,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Oi()*Math.PI,n=2*Oi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){Hi=t.x,ji=t.y,Wi=t.z;var n=i.m03*Hi+i.m07*ji+i.m11*Wi+i.m15;return n=n?1/n:1,e.x=(i.m00*Hi+i.m04*ji+i.m08*Wi+i.m12)*n,e.y=(i.m01*Hi+i.m05*ji+i.m09*Wi+i.m13)*n,e.z=(i.m02*Hi+i.m06*ji+i.m10*Wi+i.m14)*n,e}},{key:"transformMat4Normal",value:function(e,t,i){Hi=t.x,ji=t.y,Wi=t.z;var n=i.m03*Hi+i.m07*ji+i.m11*Wi;return n=n?1/n:1,e.x=(i.m00*Hi+i.m04*ji+i.m08*Wi)*n,e.y=(i.m01*Hi+i.m05*ji+i.m09*Wi)*n,e.z=(i.m02*Hi+i.m06*ji+i.m10*Wi)*n,e}},{key:"transformMat3",value:function(e,t,i){return Hi=t.x,ji=t.y,Wi=t.z,e.x=Hi*i.m00+ji*i.m03+Wi*i.m06,e.y=Hi*i.m01+ji*i.m04+Wi*i.m07,e.z=Hi*i.m02+ji*i.m05+Wi*i.m08,e}},{key:"transformAffine",value:function(e,t,i){return Hi=t.x,ji=t.y,Wi=t.z,e.x=i.m00*Hi+i.m01*ji+i.m02*Wi+i.m03,e.y=i.m04*Hi+i.m05*ji+i.m06*Wi+i.m07,e.x=i.m08*Hi+i.m09*ji+i.m10*Wi+i.m11,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,s=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+s*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+s*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+s*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,s=t.y*r.y,o=t.z*r.z,l=i.w*a+i.y*o-i.z*s,c=i.w*s+i.z*a-i.x*o,u=i.w*o+i.x*s-i.y*a,h=-i.x*a-i.y*s-i.z*o;return e.x=l*i.w+h*-i.x+c*-i.z-u*-i.y+n.x,e.y=c*i.w+h*-i.y+u*-i.x-l*-i.z+n.y,e.z=u*i.w+h*-i.z+l*-i.y-c*-i.x+n.z,e}},{key:"rotateX",value:function(e,t,i,n){Hi=t.x-i.x,ji=t.y-i.y,Wi=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Hi,o=ji*r-Wi*a,l=ji*a+Wi*r;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateY",value:function(e,t,i,n){Hi=t.x-i.x,ji=t.y-i.y,Wi=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Wi*a+Hi*r,o=ji,l=Wi*r-Hi*a;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){Hi=t.x-i.x,ji=t.y-i.y,Wi=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Hi*r-ji*a,o=Hi*a+ji*r,l=Wi;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei,n=e.x,r=e.y,a=e.z,s=t.x,o=t.y,l=t.z;return Math.abs(n-s)<=i*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-o)<=i*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=i*Math.max(1,Math.abs(a),Math.abs(l))}},{key:"angle",value:function(e,t){r.normalize(qi,e),r.normalize(Yi,t);var i=r.dot(qi,Yi);return 1<i?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return r.subtract(e,t,r.project(e,t,i))}},{key:"project",value:function(e,t,i){var n=r.lengthSqr(i);return n<1e-6?r.set(e,0,0,0):r.multiplyScalar(e,i,r.dot(t,i)/n)}}]),l(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z)}},{key:"set",value:function(e,t,i){return e&&"object"===fe(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}},{key:"equals",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ei;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:Ei;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===fe(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==fe(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=wi(this.x,e.x,t.x),this.y=wi(this.y,e.y,t.y),this.z=wi(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){Hi=this.x,ji=this.y,Wi=this.z;var e=Hi*Hi+ji*ji+Wi*Wi;return 0<e&&(e=1/Math.sqrt(e),this.x=Hi*e,this.y=ji*e,this.z=Wi*e),this}},{key:"transformMat4",value:function(e){Hi=this.x,ji=this.y,Wi=this.z;var t=e.m03*Hi+e.m07*ji+e.m11*Wi+e.m15;return t=t?1/t:1,this.x=(e.m00*Hi+e.m04*ji+e.m08*Wi+e.m12)*t,this.y=(e.m01*Hi+e.m05*ji+e.m09*Wi+e.m13)*t,this.z=(e.m02*Hi+e.m06*ji+e.m10*Wi+e.m14)*t,this}}]),r}();Xi.UNIT_X=Object.freeze(new Xi(1,0,0)),Xi.UNIT_Y=Object.freeze(new Xi(0,1,0)),Xi.UNIT_Z=Object.freeze(new Xi(0,0,1)),Xi.ZERO=Object.freeze(new Xi(0,0,0)),Xi.ONE=Object.freeze(new Xi(1,1,1)),Xi.NEG_ONE=Object.freeze(new Xi(-1,-1,-1));var qi=new Xi,Yi=new Xi;vi.fastDefine("cc.Vec3",Xi,{x:0,y:0,z:0}),cc.Vec3=Xi,cc.v3=function(e,t,i){return new Xi(e,t,i)};var Ki=0,Qi=0,Zi=0,Ji=0,$i=function(e){function a(e,t,i,n){var r;return y(this,a),(r=T(this,S(a).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===fe(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||0),r}return d(a,Si),l(a,null,[{key:"clone",value:function(e){return new a(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){return Ki=e.x,Qi=e.y,Zi=e.z,Ji=e.w,Math.sqrt(Ki*Ki+Qi*Qi+Zi*Zi+Ji*Ji)}},{key:"lengthSqr",value:function(e){return Ki=e.x,Qi=e.y,Zi=e.z,Ji=e.w,Ki*Ki+Qi*Qi+Zi*Zi+Ji*Ji}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){return Ki=t.x,Qi=t.y,Zi=t.z,Ji=t.w,Math.abs(Ki)<Ei?e.x=0:e.x=1/Ki,Math.abs(Qi)<Ei?e.y=0:e.y=1/Qi,Math.abs(Zi)<Ei?e.z=0:e.z=1/Zi,Math.abs(Ji)<Ei?e.w=0:e.w=1/Ji,e}},{key:"normalize",value:function(e,t){Ki=t.x,Qi=t.y,Zi=t.z,Ji=t.w;var i=Ki*Ki+Qi*Qi+Zi*Zi+Ji*Ji;return 0<i&&(i=1/Math.sqrt(i),e.x=Ki*i,e.y=Qi*i,e.z=Zi*i,e.w=Ji*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Oi()*Math.PI,n=2*Oi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){return Ki=t.x,Qi=t.y,Zi=t.z,Ji=t.w,e.x=i.m00*Ki+i.m04*Qi+i.m08*Zi+i.m12*Ji,e.y=i.m01*Ki+i.m05*Qi+i.m09*Zi+i.m13*Ji,e.z=i.m02*Ki+i.m06*Qi+i.m10*Zi+i.m14*Ji,e.w=i.m03*Ki+i.m07*Qi+i.m11*Zi+i.m15*Ji,e}},{key:"transformAffine",value:function(e,t,i){return Ki=t.x,Qi=t.y,Zi=t.z,Ji=t.w,e.x=i.m00*Ki+i.m01*Qi+i.m02*Zi+i.m03*Ji,e.y=i.m04*Ki+i.m05*Qi+i.m06*Zi+i.m07*Ji,e.x=i.m08*Ki+i.m09*Qi+i.m10*Zi+i.m11*Ji,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;Ki=i.x,Qi=i.y,Zi=i.z;var s=(Ji=i.w)*n+Qi*a-Zi*r,o=Ji*r+Zi*n-Ki*a,l=Ji*a+Ki*r-Qi*n,c=-Ki*n-Qi*r-Zi*a;return e.x=s*Ji+c*-Ki+o*-Zi-l*-Qi,e.y=o*Ji+c*-Qi+l*-Ki-s*-Zi,e.z=l*Ji+c*-Zi+s*-Qi-o*-Ki,e.w=t.w,e}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===fe(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}},{key:"equals",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ei;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n){var r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:Ei;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){return Ki=this.x,Qi=this.y,Zi=this.z,Ji=this.w,this.x=Ki+t*(e.x-Ki),this.y=Qi+t*(e.y-Qi),this.z=Zi+t*(e.z-Zi),this.w=Ji+t*(e.w-Ji),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=wi(this.x,e.x,t.x),this.y=wi(this.y,e.y,t.y),this.z=wi(this.z,e.z,t.z),this.w=wi(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===fe(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==fe(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Ki=this.x,Qi=this.y,Zi=this.z,Ji=this.w,Math.sqrt(Ki*Ki+Qi*Qi+Zi*Zi+Ji*Ji)}},{key:"lengthSqr",value:function(){return Ki=this.x,Qi=this.y,Zi=this.z,Ji=this.w,Ki*Ki+Qi*Qi+Zi*Zi+Ji*Ji}},{key:"normalize",value:function(){Ki=this.x,Qi=this.y,Zi=this.z,Ji=this.w;var e=Ki*Ki+Qi*Qi+Zi*Zi+Ji*Ji;return 0<e&&(e=1/Math.sqrt(e),this.x=Ki*e,this.y=Qi*e,this.z=Zi*e,this.w=Ji*e),this}},{key:"transformMat4",value:function(e){return Ki=this.x,Qi=this.y,Zi=this.z,Ji=this.w,this.x=e.m00*Ki+e.m04*Qi+e.m08*Zi+e.m12*Ji,this.y=e.m01*Ki+e.m05*Qi+e.m09*Zi+e.m13*Ji,this.z=e.m02*Ki+e.m06*Qi+e.m10*Zi+e.m14*Ji,this.w=e.m03*Ki+e.m07*Qi+e.m11*Zi+e.m15*Ji,this}}]),a}();$i.ZERO=Object.freeze(new $i(0,0,0,0)),$i.ONE=Object.freeze(new $i(1,1,1,1)),$i.NEG_ONE=Object.freeze(new $i(-1,-1,-1,-1)),vi.fastDefine("cc.Vec4",$i,{x:0,y:0,z:0,w:0}),cc.Vec4=$i,cc.v4=function(e,t,i,n){return new $i(e,t,i,n)};var en=0,tn=0,nn=0,rn=0,an=0,sn=0,on=0,ln=0,cn=0,un=function(e){function u(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;return y(this,u),(e=T(this,S(u).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,"object"===fe(t)?(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08):(e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c),e}return d(u,Si),l(u,null,[{key:"clone",value:function(e){return new u(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){return e===t?(tn=t.m01,nn=t.m02,sn=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=tn,e.m05=t.m07,e.m06=nn,e.m07=sn):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e}},{key:"invert",value:function(e,t){en=t.m00,tn=t.m01,nn=t.m02,rn=t.m03,an=t.m04,sn=t.m05,on=t.m06,ln=t.m07;var i=(cn=t.m08)*an-sn*ln,n=-cn*rn+sn*on,r=ln*rn-an*on,a=en*i+tn*n+nn*r;return a&&(a=1/a,e.m00=i*a,e.m01=(-cn*tn+nn*ln)*a,e.m02=(sn*tn-nn*an)*a,e.m03=n*a,e.m04=(cn*en-nn*on)*a,e.m05=(-sn*en+nn*rn)*a,e.m06=r*a,e.m07=(-ln*en+tn*on)*a,e.m08=(an*en-tn*rn)*a),e}},{key:"determinant",value:function(e){return en=e.m00,tn=e.m01,nn=e.m02,rn=e.m03,an=e.m04,sn=e.m05,on=e.m06,ln=e.m07,cn=e.m08,en*(cn*an-sn*ln)+tn*(-cn*rn+sn*on)+nn*(ln*rn-an*on)}},{key:"multiply",value:function(e,t,i){en=t.m00,tn=t.m01,nn=t.m02,rn=t.m03,an=t.m04,sn=t.m05,on=t.m06,ln=t.m07,cn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m03,o=i.m04,l=i.m05,c=i.m06,u=i.m07,h=i.m08;return e.m00=n*en+r*rn+a*on,e.m01=n*tn+r*an+a*ln,e.m02=n*nn+r*sn+a*cn,e.m03=s*en+o*rn+l*on,e.m04=s*tn+o*an+l*ln,e.m05=s*nn+o*sn+l*cn,e.m06=c*en+u*rn+h*on,e.m07=c*tn+u*an+h*ln,e.m08=c*nn+u*sn+h*cn,e}},{key:"multiplyMat4",value:function(e,t,i){en=t.m00,tn=t.m01,nn=t.m02,rn=t.m03,an=t.m04,sn=t.m05,on=t.m06,ln=t.m07,cn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m04,o=i.m05,l=i.m06,c=i.m08,u=i.m09,h=i.m10;return e.m00=n*en+r*rn+a*on,e.m01=n*tn+r*an+a*ln,e.m02=n*nn+r*sn+a*cn,e.m03=s*en+o*rn+l*on,e.m04=s*tn+o*an+l*ln,e.m05=s*nn+o*sn+l*cn,e.m06=c*en+u*rn+h*on,e.m07=c*tn+u*an+h*ln,e.m08=c*nn+u*sn+h*cn,e}},{key:"transfrom",value:function(e,t,i){en=t.m00,tn=t.m01,nn=t.m02,rn=t.m03,an=t.m04,sn=t.m05,on=t.m06,ln=t.m07,cn=t.m08;var n=i.x,r=i.y;return e.m00=en,e.m01=tn,e.m02=nn,e.m03=rn,e.m04=an,e.m05=sn,e.m06=n*en+r*rn+on,e.m07=n*tn+r*an+ln,e.m08=n*nn+r*sn+cn,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){en=t.m00,tn=t.m01,nn=t.m02,rn=t.m03,an=t.m04,sn=t.m05,on=t.m06,ln=t.m07,cn=t.m08;var n=Math.sin(i),r=Math.cos(i);return e.m00=r*en+n*rn,e.m01=r*tn+n*an,e.m02=r*nn+n*sn,e.m03=r*rn-n*en,e.m04=r*an-n*tn,e.m05=r*sn-n*nn,e.m06=on,e.m07=ln,e.m08=cn,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return Xi.lengthSqr(t)<1e-12?(u.identity(e),e):(i=i||Xi.UNIT_Y,Xi.normalize(hn,Xi.cross(hn,i,t)),Xi.lengthSqr(hn)<1e-12?u.identity(e):(Xi.cross(_n,t,hn),u.set(e,hn.x,hn.y,hn.z,_n.x,_n.y,_n.z,t.x,t.y,t.z)),e)}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,c=i*s,u=n*s,h=n*o,_=r*s,f=r*o,d=r*l,p=a*s,m=a*o,v=a*l;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-c-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-c-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*c-a*s,S=n*l-r*o,T=n*c-a*o,x=r*c-a*l,E=u*p-h*d,w=u*m-_*d,A=u*v-f*d,C=h*m-_*p,k=h*v-f*p,R=_*v-f*m,O=y*R-g*k+b*C+S*A-T*w+x*E;return O?(O=1/O,e.m00=(o*R-l*k+c*C)*O,e.m01=(l*A-s*R-c*w)*O,e.m02=(s*k-o*A+c*E)*O,e.m03=(r*k-n*R-a*C)*O,e.m04=(i*R-r*A+a*w)*O,e.m05=(n*A-i*k-a*E)*O,e.m06=(p*x-m*T+v*S)*O,e.m07=(m*b-d*x-v*g)*O,e.m08=(d*T-p*b+v*y)*O,e):null}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),l(u,[{key:"clone",value:function(){return new u(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08)}},{key:"set",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;return"object"===fe(e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=a,this.m06=s,this.m07=o,this.m08=l),this}},{key:"equals",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ei;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+",\n"+this.m03+",\n"+this.m04+", "+this.m05+",\n"+this.m06+", "+this.m07+",\n"+this.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){en=this.m00,tn=this.m01,nn=this.m02,rn=this.m03,an=this.m04,sn=this.m05,on=this.m06,ln=this.m07;var e=(cn=this.m08)*an-sn*ln,t=-cn*rn+sn*on,i=ln*rn-an*on,n=en*e+tn*t+nn*i;return n?(n=1/n,this.m00=e*n,this.m01=(-cn*tn+nn*ln)*n,this.m02=(sn*tn-nn*an)*n,this.m03=t*n,this.m04=(cn*en-nn*on)*n,this.m05=(-sn*en+nn*rn)*n,this.m06=i*n,this.m07=(-ln*en+tn*on)*n,this.m08=(an*en-tn*rn)*n,this):null}},{key:"determinant",value:function(){return en=this.m00,tn=this.m01,nn=this.m02,rn=this.m03,an=this.m04,sn=this.m05,on=this.m06,ln=this.m07,cn=this.m08,en*(cn*an-sn*ln)+tn*(-cn*rn+sn*on)+nn*(ln*rn-an*on)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,s=this.m05,o=this.m06,l=this.m07,c=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,y=e.m08;return this.m00=u*t+h*r+_*o,this.m01=u*i+h*a+_*l,this.m02=u*n+h*s+_*c,this.m03=f*t+d*r+p*o,this.m04=f*i+d*a+p*l,this.m05=f*n+d*s+p*c,this.m06=m*t+v*r+y*o,this.m07=m*i+v*a+y*l,this.m08=m*n+v*s+y*c,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){en=this.m00,tn=this.m01,nn=this.m02,rn=this.m03,an=this.m04,sn=this.m05,on=this.m06,ln=this.m07,cn=this.m08;var t=Math.sin(e),i=Math.cos(e);return this.m00=i*en+t*rn,this.m01=i*tn+t*an,this.m02=i*nn+t*sn,this.m03=i*rn-t*en,this.m04=i*an-t*tn,this.m05=i*sn-t*nn,this.m06=on,this.m07=ln,this.m08=cn,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,c=i*a,u=i*s,h=n*a,_=n*s,f=n*o,d=r*a,p=r*s,m=r*o;return this.m00=1-u-f,this.m03=c-m,this.m06=h+p,this.m01=c+m,this.m04=1-l-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-l-u,this}}]),u}();un.IDENTITY=Object.freeze(new un);var hn=new Xi,_n=new Xi;vi.fastDefine("cc.Mat3",un,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=un;var fn=0,dn=0,pn=0,mn=0,vn=function(e){function s(e,t,i,n){var r;return y(this,s),(r=T(this,S(s).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===fe(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||1),r}return d(s,Si),l(s,null,[{key:"clone",value:function(e){return new s(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var n=Xi.dot(t,i);return n<-.999999?(Xi.cross(bn,Xi.UNIT_X,t),bn.length()<1e-6&&Xi.cross(bn,Xi.UNIT_Y,t),Xi.normalize(bn,bn),s.fromAxisAngle(e,bn,Math.PI),e):.999999<n?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Xi.cross(bn,t,i),e.x=bn.x,e.y=bn.y,e.z=bn.z,e.w=1+n,s.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){return fn=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,dn=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,pn=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,mn=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z,e.x=fn,e.y=dn,e.z=pn,e.w=mn,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.w*n,e.y=t.y*r+t.z*n,e.z=t.z*r-t.y*n,e.w=t.w*r-t.x*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r-t.z*n,e.y=t.y*r+t.w*n,e.z=t.z*r+t.x*n,e.w=t.w*r-t.y*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.y*n,e.y=t.y*r-t.x*n,e.z=t.z*r+t.w*n,e.w=t.w*r-t.z*n,e}},{key:"rotateAround",value:function(e,t,i,n){return s.invert(yn,t),Xi.transformQuat(bn,i,yn),s.fromAxisAngle(yn,bn,n),s.multiply(e,t,yn),e}},{key:"rotateAroundLocal",value:function(e,t,i,n){return s.fromAxisAngle(yn,i,n),s.multiply(e,t,yn),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,s=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(s<0&&(s=-s,i.x=-i.x,i.y=-i.y,i.z=-i.z,i.w=-i.w),1e-6<1-s){var o=Math.acos(s),l=Math.sin(o);r=Math.sin((1-n)*o)/l,a=Math.sin(n*o)/l}else r=1-n,a=n;return e.x=r*t.x+a*i.x,e.y=r*t.y+a*i.y,e.z=r*t.z+a*i.z,e.w=r*t.w+a*i.w,e}},{key:"sqlerp",value:function(e,t,i,n,r,a){return s.slerp(yn,t,r,a),s.slerp(gn,i,n,a),s.slerp(e,yn,gn,2*a*(1-a)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return 0<i&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,n){return un.set(Sn,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),s.normalize(e,s.fromMat3(e,Sn))}},{key:"fromViewUp",value:function(e,t,i){return un.fromViewUp(Sn,t,i),s.normalize(e,s.fromMat3(e,Sn))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,s=t.m04,o=t.m07,l=t.m02,c=t.m05,u=t.m08,h=i+s+u;if(0<h){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(c-o)*_,e.y=(r-l)*_,e.z=(a-n)*_}else if(s<i&&u<i){var f=2*Math.sqrt(1+i-s-u);e.w=(c-o)/f,e.x=.25*f,e.y=(n+a)/f,e.z=(r+l)/f}else if(u<s){var d=2*Math.sqrt(1+s-i-u);e.w=(r-l)/d,e.x=(n+a)/d,e.y=.25*d,e.z=(o+c)/d}else{var p=2*Math.sqrt(1+u-i-s);e.w=(a-n)/p,e.x=(r+l)/p,e.y=(o+c)/p,e.z=.25*p}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=Tn,i*=Tn,n*=Tn;var r=Math.sin(t),a=Math.cos(t),s=Math.sin(i),o=Math.cos(i),l=Math.sin(n),c=Math.cos(n);return e.x=r*o*c+a*s*l,e.y=a*s*c+r*o*l,e.z=a*o*l-r*s*c,e.w=a*o*c-r*s*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=0,l=0,c=0,u=n*r+a*s;if(.499999<u)o=0,l=Ri(2*Math.atan2(n,s)),c=90;else if(u<-.499999)o=0,l=-Ri(2*Math.atan2(n,s)),c=-90;else{var h=n*n,_=r*r,f=a*a;o=Ri(Math.atan2(2*n*s-2*r*a,1-2*h-2*f)),l=Ri(Math.atan2(2*r*s-2*n*a,1-2*_-2*f)),c=Ri(Math.asin(2*u)),i&&(o=-180*Math.sign(o+1e-6)+o,l=-180*Math.sign(l+1e-6)+l,c=180*Math.sign(c+1e-6)-c)}return e.x=o,e.y=l,e.z=c,e}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),l(s,[{key:"clone",value:function(){return new s(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===fe(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||1),this}},{key:"equals",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ei;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return s.toEuler(e,this)}},{key:"lerp",value:function(e,t){var i=0,n=0,r=this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;if(r<0&&(r=-r,e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),1e-6<1-r){var a=Math.acos(r),s=Math.sin(a);i=Math.sin((1-t)*a)/s,n=Math.sin(t*a)/s}else i=1-t,n=t;return this.x=i*this.x+n*e.x,this.y=i*this.y+n*e.y,this.z=i*this.z+n*e.z,this.w=i*this.w+n*e.w,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),s}();vn.IDENTITY=Object.freeze(new vn);var yn=new vn,gn=new vn,bn=new Xi,Sn=new un,Tn=.5*Math.PI/180;vi.fastDefine("cc.Quat",vn,{x:0,y:0,z:0,w:1}),cc.Quat=vn,cc.quat=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;return new vn(e,t,i,n)};var xn=0,En=0,wn=0,An=0,Cn=0,kn=0,Rn=0,On=0,Mn=0,Ln=0,In=0,Fn=0,Pn=0,Dn=0,zn=0,Bn=0,Nn=function(e){function v(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,h=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,_=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,f=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,d=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,m=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return y(this,v),(e=T(this,S(v).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===fe(t)?(e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e.m00=t.m00):(e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e.m00=t),e}return d(v,Si),l(v,null,[{key:"clone",value:function(e){return new v(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,_,f,d,p,m){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,s=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=s,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){xn=t.m00,En=t.m01,wn=t.m02,An=t.m03,Cn=t.m04,kn=t.m05,Rn=t.m06,On=t.m07,Mn=t.m08,Ln=t.m09,In=t.m10,Fn=t.m11,Pn=t.m12,Dn=t.m13,zn=t.m14,Bn=t.m15;var i=xn*kn-En*Cn,n=xn*Rn-wn*Cn,r=xn*On-An*Cn,a=En*Rn-wn*kn,s=En*On-An*kn,o=wn*On-An*Rn,l=Mn*Dn-Ln*Pn,c=Mn*zn-In*Pn,u=Mn*Bn-Fn*Pn,h=Ln*zn-In*Dn,_=Ln*Bn-Fn*Dn,f=In*Bn-Fn*zn,d=i*f-n*_+r*h+a*u-s*c+o*l;return 0===d?null:(d=1/d,e.m00=(kn*f-Rn*_+On*h)*d,e.m01=(wn*_-En*f-An*h)*d,e.m02=(Dn*o-zn*s+Bn*a)*d,e.m03=(In*s-Ln*o-Fn*a)*d,e.m04=(Rn*u-Cn*f-On*c)*d,e.m05=(xn*f-wn*u+An*c)*d,e.m06=(zn*r-Pn*o-Bn*n)*d,e.m07=(Mn*o-In*r+Fn*n)*d,e.m08=(Cn*_-kn*u+On*l)*d,e.m09=(En*u-xn*_-An*l)*d,e.m10=(Pn*s-Dn*r+Bn*i)*d,e.m11=(Ln*r-Mn*s-Fn*i)*d,e.m12=(kn*c-Cn*h-Rn*l)*d,e.m13=(xn*h-En*c+wn*l)*d,e.m14=(Dn*n-Pn*a-zn*i)*d,e.m15=(Mn*a-Ln*n+In*i)*d,e)}},{key:"determinant",value:function(e){return xn=e.m00,En=e.m01,wn=e.m02,An=e.m03,Cn=e.m04,kn=e.m05,Rn=e.m06,On=e.m07,Mn=e.m08,Ln=e.m09,In=e.m10,Fn=e.m11,Pn=e.m12,Dn=e.m13,zn=e.m14,Bn=e.m15,(xn*kn-En*Cn)*(In*Bn-Fn*zn)-(xn*Rn-wn*Cn)*(Ln*Bn-Fn*Dn)+(xn*On-An*Cn)*(Ln*zn-In*Dn)+(En*Rn-wn*kn)*(Mn*Bn-Fn*Pn)-(En*On-An*kn)*(Mn*zn-In*Pn)+(wn*On-An*Rn)*(Mn*Dn-Ln*Pn)}},{key:"multiply",value:function(e,t,i){xn=t.m00,En=t.m01,wn=t.m02,An=t.m03,Cn=t.m04,kn=t.m05,Rn=t.m06,On=t.m07,Mn=t.m08,Ln=t.m09,In=t.m10,Fn=t.m11,Pn=t.m12,Dn=t.m13,zn=t.m14,Bn=t.m15;var n=i.m00,r=i.m01,a=i.m02,s=i.m03;return e.m00=n*xn+r*Cn+a*Mn+s*Pn,e.m01=n*En+r*kn+a*Ln+s*Dn,e.m02=n*wn+r*Rn+a*In+s*zn,e.m03=n*An+r*On+a*Fn+s*Bn,n=i.m04,r=i.m05,a=i.m06,s=i.m07,e.m04=n*xn+r*Cn+a*Mn+s*Pn,e.m05=n*En+r*kn+a*Ln+s*Dn,e.m06=n*wn+r*Rn+a*In+s*zn,e.m07=n*An+r*On+a*Fn+s*Bn,n=i.m08,r=i.m09,a=i.m10,s=i.m11,e.m08=n*xn+r*Cn+a*Mn+s*Pn,e.m09=n*En+r*kn+a*Ln+s*Dn,e.m10=n*wn+r*Rn+a*In+s*zn,e.m11=n*An+r*On+a*Fn+s*Bn,n=i.m12,r=i.m13,a=i.m14,s=i.m15,e.m12=n*xn+r*Cn+a*Mn+s*Pn,e.m13=n*En+r*kn+a*Ln+s*Dn,e.m14=n*wn+r*Rn+a*In+s*zn,e.m15=n*An+r*On+a*Fn+s*Bn,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return t===e?(e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15):(xn=t.m00,En=t.m01,wn=t.m02,An=t.m03,Cn=t.m04,kn=t.m05,Rn=t.m06,On=t.m07,Mn=t.m08,Ln=t.m09,In=t.m10,Fn=t.m11,Pn=t.m12,Dn=t.m13,zn=t.m14,Bn=t.m15,e.m00=xn,e.m01=En,e.m02=wn,e.m03=An,e.m04=Cn,e.m05=kn,e.m06=Rn,e.m07=On,e.m08=Mn,e.m09=Ln,e.m10=In,e.m11=Fn,e.m12=xn*n+Cn*r+Mn*a+t.m12,e.m13=En*n+kn*r+Ln*a+t.m13,e.m14=wn*n+Rn*r+In*a+t.m14,e.m15=An*n+On*r+Fn*a+t.m15),e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.y):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,s=n.z,o=Math.sqrt(r*r+a*a+s*s);if(Math.abs(o)<Ei)return null;r*=o=1/o,a*=o,s*=o;var l=Math.sin(i),c=Math.cos(i),u=1-c;xn=t.m00,En=t.m01,wn=t.m02,An=t.m03,Cn=t.m04,kn=t.m05,Rn=t.m06,On=t.m07,Mn=t.m08,Ln=t.m09,In=t.m10,Fn=t.m11;var h=r*r*u+c,_=a*r*u+s*l,f=s*r*u-a*l,d=r*a*u-s*l,p=a*a*u+c,m=s*a*u+r*l,v=r*s*u+a*l,y=a*s*u-r*l,g=s*s*u+c;return e.m00=xn*h+Cn*_+Mn*f,e.m01=En*h+kn*_+Ln*f,e.m02=wn*h+Rn*_+In*f,e.m03=An*h+On*_+Fn*f,e.m04=xn*d+Cn*p+Mn*m,e.m05=En*d+kn*p+Ln*m,e.m06=wn*d+Rn*p+In*m,e.m07=An*d+On*p+Fn*m,e.m08=xn*v+Cn*y+Mn*g,e.m09=En*v+kn*y+Ln*g,e.m10=wn*v+Rn*y+In*g,e.m11=An*v+On*y+Fn*g,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,s=t.m05,o=t.m06,l=t.m07,c=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+c*n,e.m05=s*r+u*n,e.m06=o*r+h*n,e.m07=l*r+_*n,e.m08=c*r-a*n,e.m09=u*r-s*n,e.m10=h*r-o*n,e.m11=_*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,c=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-c*n,e.m01=s*r-u*n,e.m02=o*r-h*n,e.m03=l*r-_*n,e.m08=a*n+c*r,e.m09=s*n+u*r,e.m10=o*n+h*r,e.m11=l*n+_*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,c=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+c*n,e.m01=s*r+u*n,e.m02=o*r+h*n,e.m03=l*r+_*n,e.m04=c*r-a*n,e.m05=u*r-s*n,e.m06=h*r-o*n,e.m07=_*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,s=Math.sqrt(n*n+r*r+a*a);if(Math.abs(s)<Ei)return null;n*=s=1/s,r*=s,a*=s;var o=Math.sin(t),l=Math.cos(t),c=1-l;return e.m00=n*n*c+l,e.m01=r*n*c+a*o,e.m02=a*n*c-r*o,e.m03=0,e.m04=n*r*c-a*o,e.m05=r*r*c+l,e.m06=a*r*c+n*o,e.m07=0,e.m08=n*a*c+r*o,e.m09=r*a*c-n*o,e.m10=a*a*c+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=n+n,l=r+r,c=a+a,u=n*o,h=n*l,_=n*c,f=r*l,d=r*c,p=a*c,m=s*o,v=s*l,y=s*c;return e.m00=1-(f+p),e.m01=h+y,e.m02=_-v,e.m03=0,e.m04=h-y,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=Gn.m00=t.m00,n=Gn.m01=t.m01,r=Gn.m02=t.m02,a=Gn.m03=t.m04,s=Gn.m04=t.m05,o=Gn.m05=t.m06,l=Gn.m06=t.m08,c=Gn.m07=t.m09,u=Gn.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+s*s+o*o),e.z=Math.sqrt(l*l+c*c+u*u),un.determinant(Gn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return 0<i?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=Xi.set(Un,e.m00,e.m01,e.m02).length(),Gn.m00=e.m00/n.x,Gn.m01=e.m01/n.x,Gn.m02=e.m02/n.x,n.y=Xi.set(Un,e.m04,e.m05,e.m06).length(),Gn.m03=e.m04/n.y,Gn.m04=e.m05/n.y,Gn.m05=e.m06/n.y,n.z=Xi.set(Un,e.m08,e.m09,e.m10).length(),Gn.m06=e.m08/n.z,Gn.m07=e.m09/n.z,Gn.m08=e.m10/n.z,un.determinant(Gn)<0&&(n.x*=-1,Gn.m00*=-1,Gn.m01*=-1,Gn.m02*=-1),vn.fromMat3(t,Gn),Xi.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=r+r,c=a+a,u=s+s,h=r*l,_=r*c,f=r*u,d=a*c,p=a*u,m=s*u,v=o*l,y=o*c,g=o*u,b=n.x,S=n.y,T=n.z;return e.m00=(1-(d+m))*b,e.m01=(_+g)*b,e.m02=(f-y)*b,e.m03=0,e.m04=(_-g)*S,e.m05=(1-(h+m))*S,e.m06=(p+v)*S,e.m07=0,e.m08=(f+y)*T,e.m09=(p-v)*T,e.m10=(1-(h+d))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,s=t.y,o=t.z,l=t.w,c=a+a,u=s+s,h=o+o,_=a*c,f=a*u,d=a*h,p=s*u,m=s*h,v=o*h,y=l*c,g=l*u,b=l*h,S=n.x,T=n.y,x=n.z,E=r.x,w=r.y,A=r.z;return e.m00=(1-(p+v))*S,e.m01=(f+b)*S,e.m02=(d-g)*S,e.m03=0,e.m04=(f-b)*T,e.m05=(1-(_+v))*T,e.m06=(m+y)*T,e.m07=0,e.m08=(d+g)*x,e.m09=(m-y)*x,e.m10=(1-(_+p))*x,e.m11=0,e.m12=i.x+E-(e.m00*E+e.m04*w+e.m08*A),e.m13=i.y+w-(e.m01*E+e.m05*w+e.m09*A),e.m14=i.z+A-(e.m02*E+e.m06*w+e.m10*A),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,c=i*s,u=n*s,h=n*o,_=r*s,f=r*o,d=r*l,p=a*s,m=a*o,v=a*l;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-c-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-c-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,s){var o=1/(i-t),l=1/(r-n),c=1/(a-s);return e.m00=2*a*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*l,e.m10=(s+a)*c,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*a*2*c,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=1/Math.tan(t/2),s=1/(n-r);return e.m00=a/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,s){var o=1/(t-i),l=1/(n-r),c=1/(a-s);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*c,e.m11=0,e.m12=(t+i)*o,e.m13=(r+n)*l,e.m14=(s+a)*c,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=n.x,l=n.y,c=n.z,u=r-i.x,h=a-i.y,_=s-i.z,f=1/Math.sqrt(u*u+h*h+_*_),d=l*(_*=f)-c*(h*=f),p=c*(u*=f)-o*_,m=o*h-l*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),y=_*(d*=f)-u*m,g=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=y,e.m06=h,e.m07=0,e.m08=m,e.m09=g,e.m10=_,e.m11=0,e.m12=-(d*r+p*a+m*s),e.m13=-(v*r+y*a+g*s),e.m14=-(u*r+h*a+_*s),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){xn=t.m00,En=t.m01,wn=t.m02,An=t.m03,Cn=t.m04,kn=t.m05,Rn=t.m06,On=t.m07,Mn=t.m08,Ln=t.m09,In=t.m10,Fn=t.m11,Pn=t.m12,Dn=t.m13,zn=t.m14,Bn=t.m15;var i=xn*kn-En*Cn,n=xn*Rn-wn*Cn,r=xn*On-An*Cn,a=En*Rn-wn*kn,s=En*On-An*kn,o=wn*On-An*Rn,l=Mn*Dn-Ln*Pn,c=Mn*zn-In*Pn,u=Mn*Bn-Fn*Pn,h=Ln*zn-In*Dn,_=Ln*Bn-Fn*Dn,f=In*Bn-Fn*zn,d=i*f-n*_+r*h+a*u-s*c+o*l;return d?(d=1/d,e.m00=(kn*f-Rn*_+On*h)*d,e.m01=(Rn*u-Cn*f-On*c)*d,e.m02=(Cn*_-kn*u+On*l)*d,e.m03=0,e.m04=(wn*_-En*f-An*h)*d,e.m05=(xn*f-wn*u+An*c)*d,e.m06=(En*u-xn*_-An*l)*d,e.m07=0,e.m08=(Dn*o-zn*s+Bn*a)*d,e.m09=(zn*r-Pn*o-Bn*n)*d,e.m10=(Pn*s-Dn*r+Bn*i)*d,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),l(v,[{key:"clone",value:function(){var e=this;return new v(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,_=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,f=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,d=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,p=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return"object"===fe(e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=a,this.m06=s,this.m07=o,this.m08=l,this.m09=c,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this}},{key:"equals",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ei;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){xn=this.m00,En=this.m01,wn=this.m02,An=this.m03,Cn=this.m04,kn=this.m05,Rn=this.m06,On=this.m07,Mn=this.m08,Ln=this.m09,In=this.m10,Fn=this.m11,Pn=this.m12,Dn=this.m13,zn=this.m14,Bn=this.m15;var e=xn*kn-En*Cn,t=xn*Rn-wn*Cn,i=xn*On-An*Cn,n=En*Rn-wn*kn,r=En*On-An*kn,a=wn*On-An*Rn,s=Mn*Dn-Ln*Pn,o=Mn*zn-In*Pn,l=Mn*Bn-Fn*Pn,c=Ln*zn-In*Dn,u=Ln*Bn-Fn*Dn,h=In*Bn-Fn*zn,_=e*h-t*u+i*c+n*l-r*o+a*s;return 0===_?null:(_=1/_,this.m00=(kn*h-Rn*u+On*c)*_,this.m01=(wn*u-En*h-An*c)*_,this.m02=(Dn*a-zn*r+Bn*n)*_,this.m03=(In*r-Ln*a-Fn*n)*_,this.m04=(Rn*l-Cn*h-On*o)*_,this.m05=(xn*h-wn*l+An*o)*_,this.m06=(zn*i-Pn*a-Bn*t)*_,this.m07=(Mn*a-In*i+Fn*t)*_,this.m08=(Cn*u-kn*l+On*s)*_,this.m09=(En*l-xn*u-An*s)*_,this.m10=(Pn*r-Dn*i+Bn*e)*_,this.m11=(Ln*i-Mn*r-Fn*e)*_,this.m12=(kn*o-Cn*c-Rn*s)*_,this.m13=(xn*c-En*o+wn*s)*_,this.m14=(Dn*t-Pn*n-zn*e)*_,this.m15=(Mn*n-Ln*t+In*e)*_,this)}},{key:"determinant",value:function(){return xn=this.m00,En=this.m01,wn=this.m02,An=this.m03,Cn=this.m04,kn=this.m05,Rn=this.m06,On=this.m07,Mn=this.m08,Ln=this.m09,In=this.m10,Fn=this.m11,Pn=this.m12,Dn=this.m13,zn=this.m14,Bn=this.m15,(xn*kn-En*Cn)*(In*Bn-Fn*zn)-(xn*Rn-wn*Cn)*(Ln*Bn-Fn*Dn)+(xn*On-An*Cn)*(Ln*zn-In*Dn)+(En*Rn-wn*kn)*(Mn*Bn-Fn*Pn)-(En*On-An*kn)*(Mn*zn-In*Pn)+(wn*On-An*Rn)*(Mn*Dn-Ln*Pn)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){xn=this.m00,En=this.m01,wn=this.m02,An=this.m03,Cn=this.m04,kn=this.m05,Rn=this.m06,On=this.m07,Mn=this.m08,Ln=this.m09,In=this.m10,Fn=this.m11,Pn=this.m12,Dn=this.m13,zn=this.m14,Bn=this.m15;var t=e.m00,i=e.m01,n=e.m02,r=e.m03;return this.m00=t*xn+i*Cn+n*Mn+r*Pn,this.m01=t*En+i*kn+n*Ln+r*Dn,this.m02=t*wn+i*Rn+n*In+r*zn,this.m03=t*An+i*On+n*Fn+r*Bn,t=e.m04,i=e.m05,n=e.m06,r=e.m07,this.m04=t*xn+i*Cn+n*Mn+r*Pn,this.m05=t*En+i*kn+n*Ln+r*Dn,this.m06=t*wn+i*Rn+n*In+r*zn,this.m07=t*An+i*On+n*Fn+r*Bn,t=e.m08,i=e.m09,n=e.m10,r=e.m11,this.m08=t*xn+i*Cn+n*Mn+r*Pn,this.m09=t*En+i*kn+n*Ln+r*Dn,this.m10=t*wn+i*Rn+n*In+r*zn,this.m11=t*An+i*On+n*Fn+r*Bn,t=e.m12,i=e.m13,n=e.m14,r=e.m15,this.m12=t*xn+i*Cn+n*Mn+r*Pn,this.m13=t*En+i*kn+n*Ln+r*Dn,this.m14=t*wn+i*Rn+n*In+r*zn,this.m15=t*An+i*On+n*Fn+r*Bn,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.y,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<Ei)return null;i*=a=1/a,n*=a,r*=a;var s=Math.sin(e),o=Math.cos(e),l=1-o;xn=this.m00,En=this.m01,wn=this.m02,An=this.m03,Cn=this.m04,kn=this.m05,Rn=this.m06,On=this.m07,Mn=this.m08,Ln=this.m09,In=this.m10,Fn=this.m11;var c=i*i*l+o,u=n*i*l+r*s,h=r*i*l-n*s,_=i*n*l-r*s,f=n*n*l+o,d=r*n*l+i*s,p=i*r*l+n*s,m=n*r*l-i*s,v=r*r*l+o;return this.m00=xn*c+Cn*u+Mn*h,this.m01=En*c+kn*u+Ln*h,this.m02=wn*c+Rn*u+In*h,this.m03=An*c+On*u+Fn*h,this.m04=xn*_+Cn*f+Mn*d,this.m05=En*_+kn*f+Ln*d,this.m06=wn*_+Rn*f+In*d,this.m07=An*_+On*f+Fn*d,this.m08=xn*p+Cn*m+Mn*v,this.m09=En*p+kn*m+Ln*v,this.m10=wn*p+Rn*m+In*v,this.m11=An*p+On*m+Fn*v,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=Gn.m00=this.m00,i=Gn.m01=this.m01,n=Gn.m02=this.m02,r=Gn.m03=this.m04,a=Gn.m04=this.m05,s=Gn.m05=this.m06,o=Gn.m06=this.m08,l=Gn.m07=this.m09,c=Gn.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+s*s),e.z=Math.sqrt(o*o+l*l+c*c),un.determinant(Gn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return 0<t?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,s=e.w,o=n+n,l=r+r,c=a+a,u=n*o,h=n*l,_=n*c,f=r*l,d=r*c,p=a*c,m=s*o,v=s*l,y=s*c,g=i.x,b=i.y,S=i.z;return this.m00=(1-(f+p))*g,this.m01=(h+y)*g,this.m02=(_-v)*g,this.m03=0,this.m04=(h-y)*b,this.m05=(1-(u+p))*b,this.m06=(d+m)*b,this.m07=0,this.m08=(_+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,c=i*a,u=i*s,h=n*a,_=n*s,f=n*o,d=r*a,p=r*s,m=r*o;return this.m00=1-u-f,this.m01=c+m,this.m02=h-p,this.m03=0,this.m04=c-m,this.m05=1-l-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-l-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),v}();Nn.IDENTITY=Object.freeze(new Nn);var Un=new Xi,Gn=new un;vi.fastDefine("cc.Mat4",Nn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=Nn,cc.mat4=function(e,t,i,n,r,a,s,o,l,c,u,h,_,f,d,p){return new Nn(e,t,i,n,r,a,s,o,l,c,u,h,_,f,d,p)};var Vn=0,Hn=0,jn=0,Wn=0,Xn=0,qn=0,Yn=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;y(this,s),this.a=void 0,this.b=void 0,this.c=void 0,this.d=void 0,this.tx=void 0,this.ty=void 0,this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a}return l(s,null,[{key:"identity",value:function(){return new s}},{key:"clone",value:function(e){return new s(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"concat",value:function(e,t,i){Vn=t.a,Hn=t.b,jn=t.c,Wn=t.d,Xn=t.tx,qn=t.ty,e.a=Vn*i.a+Hn*i.c,e.b=Vn*i.b+Hn*i.d,e.c=jn*i.a+Wn*i.c,e.d=jn*i.b+Wn*i.d,e.tx=Xn*i.a+qn*i.c+i.tx,e.ty=Xn*i.b+qn*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;a=void 0===n?(n=i,r=t.x,t.y):(r=t,i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,s=i.b*t.x+i.d*t.y+i.ty,o=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,c=i.a*t.x+i.c*r+i.tx,u=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,_=i.b*n+i.d*r+i.ty,f=Math.min(a,o,c,h),d=Math.max(a,o,c,h),p=Math.min(s,l,u,_),m=Math.max(s,l,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p}},{key:"transformObb",value:function(e,t,i,n,r,a){var s=a.a*r.x+a.c*r.y+a.tx,o=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,c=a.b*r.width,u=a.c*r.height,h=a.d*r.height;t.x=s,t.y=o,i.x=l+s,i.y=c+o,e.x=u+s,e.y=h+o,n.x=l+u+s,n.y=c+h+o}}]),s}();cc.AffineTransform=Yn;var Kn=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this))).width=void 0,i.height=void 0,e&&"object"===fe(e)?(i.height=e.height,i.width=e.width):(i.width=e||0,i.height=t||0),i}return d(n,Si),l(n,null,[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}},{key:"ZERO",get:function(){return new n(0,0)}}]),l(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===fe(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}();vi.fastDefine("cc.Size",Kn,{width:0,height:0}),cc.size=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return new Kn(e,t)},cc.Size=Kn;var Qn=0,Zn=0,Jn=0,$n=0,er=function(e){function a(e,t,i,n){var r;return y(this,a),(r=T(this,S(a).call(this))).x=void 0,r.y=void 0,r.width=void 0,r.height=void 0,e&&"object"===fe(e)?(r.y=e.y,r.width=e.width,r.height=e.height,r.x=e.x):(r.x=e||0,r.y=t||0,r.width=i||0,r.height=n||0),r}return d(a,Si),l(a,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Ui(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Kn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),s=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=s-r,e}},{key:"lerp",value:function(e,t,i,n){return Qn=t.x,Zn=t.y,Jn=t.width,$n=t.height,e.x=Qn+(i.x-Qn)*n,e.y=Zn+(i.y-Zn)*n,e.width=Jn+(i.width-Jn)*n,e.height=$n+(i.height-$n)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,s=t.y+t.height,o=i.x,l=i.y,c=i.x+i.width,u=i.y+i.height;return e.x=Math.max(n,o),e.y=Math.max(r,l),e.width=Math.min(a,c)-e.x,e.height=Math.min(s,u)-e.y,e}},{key:"union",value:function(e,t,i){Qn=t.x,Zn=t.y,Jn=t.width,$n=t.height;var n=i.x,r=i.y,a=i.width,s=i.height;return e.x=Math.min(Qn,n),e.y=Math.min(Zn,r),e.width=Math.max(Qn+Jn,n+a)-e.x,e.height=Math.max(Zn+$n,r+s)-e.y,e}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,i,n){return e&&"object"===fe(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return Qn=this.x,Zn=this.y,Jn=this.width,$n=this.height,this.x=Qn+(e.x-Qn)*t,this.y=Zn+(e.y-Zn)*t,this.width=Jn+(e.width-Jn)*t,this.height=$n+(e.height-$n)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,s=e.m01*t+e.m05*i+e.m13,o=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,c=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,_=e.m01*n+e.m05*r+e.m13,f=Math.min(a,o,c,h),d=Math.max(a,o,c,h),p=Math.min(s,l,u,_),m=Math.max(s,l,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this}}]),a}();function tr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;return new er(e,t,i,n)}vi.fastDefine("cc.Rect",er,{x:0,y:0,width:0,height:0}),cc.Rect=er,cc.rect=tr;var ir=1/255,nr=0,rr=0,ar=0,sr=0,or=function(e){function a(e,t,i,n){var r;return y(this,a),(r=T(this,S(a).call(this)))._val=0,"string"==typeof e?r.fromHEX(e):("object"===fe(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,r._val=(n<<24>>>0)+(i<<16)+(t<<8)+e),r}return d(a,Si),l(a,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~cc.math.clamp(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~cc.math.clamp(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~cc.math.clamp(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~cc.math.clamp(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*ir},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*ir},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*ir},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*ir},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new a;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHex",value:function(e,t){return e.r=(t>>24)/255,e.g=(t>>16&255)/255,e.b=(t>>8&255)/255,e.a=(255&t)/255,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){return nr=t.r,rr=t.g,ar=t.b,sr=t.a,nr+=(i.r-nr)*n,rr+=(i.g-rr)*n,ar+=(i.b-ar)*n,sr+=(i.a-sr)*n,e._val=Math.floor((sr<<24>>>0)+(ar<<16)+(rr<<8)+nr),e}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=t instanceof cc.Color||1<t.a?1/255:1;return e[i+0]=t.r*n,e[i+1]=t.g*n,e[i+2]=t.b*n,e[i+3]=t.a*n,e}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ei;return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),l(a,[{key:"clone",value:function(){var e=new a;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){return nr=this.r,rr=this.g,ar=this.b,sr=this.a,nr+=(e.r-nr)*t,rr+=(e.g-rr)*t,ar+=(e.b-ar)*t,sr+=(e.a-sr)*t,this._val=Math.floor((sr<<24>>>0)+(ar<<16)+(rr<<8)+nr),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*ir).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){return e=0===e.indexOf("#")?e.substring(1):e,nr=parseInt(e.substr(0,2),16)||0,rr=parseInt(e.substr(2,2),16)||0,ar=parseInt(e.substr(4,2),16)||0,sr=parseInt(e.substr(6,2),16)||255,this._val=(sr<<24>>>0)+(ar<<16)+(rr<<8)+nr,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){if((ar=rr=nr=0)===t)nr=rr=ar=i;else if(0===i)nr=rr=ar=0;else{1===e&&(e=0),e*=6,t=t,i=i;var n=Math.floor(e),r=e-n,a=i*(1-t),s=i*(1-t*r),o=i*(1-t*(1-r));switch(n){case 0:nr=i,rr=o,ar=a;break;case 1:nr=s,rr=i,ar=a;break;case 2:nr=a,rr=i,ar=o;break;case 3:nr=a,rr=s,ar=i;break;case 4:nr=o,rr=a,ar=i;break;case 5:nr=i,rr=a,ar=s}}return nr*=255,rr*=255,ar*=255,this._val=(this.a<<24>>>0)+(ar<<16)+(rr<<8)+nr,this}},{key:"toHSV",value:function(){nr=this.r*ir,rr=this.g*ir,ar=this.b*ir;var e={h:0,s:0,v:0},t=Math.max(nr,rr,ar),i=Math.min(nr,rr,ar),n=0;return e.v=t,e.s=t?(t-i)/t:0,e.s?(n=t-i,e.h=nr===t?(rr-ar)/n:rr===t?2+(ar-nr)/n:4+(nr-rr)/n,e.h/=6,e.h<0&&(e.h+=1)):e.h=0,e}},{key:"set",value:function(e,t,i,n){return"object"===fe(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e,this}},{key:"multiply",value:function(e){return nr=(255&this._val)*e.r>>8,rr=(65280&this._val)*e.g>>8,ar=(16711680&this._val)*e.b>>8,sr=((4278190080&this._val)>>>8)*e.a,this._val=4278190080&sr|16711680&ar|65280&rr|255&nr,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),a}();or.WHITE=Object.freeze(new or(255,255,255,255)),or.GRAY=Object.freeze(new or(127,127,127,255)),or.BLACK=Object.freeze(new or(0,0,0,255)),or.TRANSPARENT=Object.freeze(new or(0,0,0,0)),or.RED=Object.freeze(new or(255,0,0,255)),or.GREEN=Object.freeze(new or(0,255,0,255)),or.BLUE=Object.freeze(new or(0,0,255,255)),or.CYAN=Object.freeze(new or(0,255,255,255)),or.MAGENTA=Object.freeze(new or(255,0,255,255)),or.YELLOW=Object.freeze(new or(255,255,0,255)),vi.fastDefine("cc.Color",or,{r:0,g:0,b:0,a:255}),cc.Color=or,cc.color=function(e,t,i,n){return new or(e,t,i,n)};var lr,cr,ur,hr=10;var _r=0,fr=new Map;lr=function(e,t,i,n,r,a){var s=fr.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),s.count++)},Zt.replaceProperty=function(o,l,e){null!=o&&e.forEach(function(t){var i=_r++;fr.set(i,{id:i,count:0,logTimes:void 0!==t.logTimes?t.logTimes:hr});var n=null!=t.target?t.target:o,r=null!=t.newName?t.newName:t.name,a=null!=t.targetName?t.targetName:l;if(null!=t.customFunction)o[t.name]=function(){return lr(l,t.name,a,r,A,i),t.customFunction.call(this,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3],arguments.length<=4?void 0:arguments[4],arguments.length<=5?void 0:arguments[5],arguments.length<=6?void 0:arguments[6],arguments.length<=7?void 0:arguments[7],arguments.length<=8?void 0:arguments[8],arguments.length<=9?void 0:arguments[9],arguments.length<=10?void 0:arguments[10],arguments.length<=11?void 0:arguments[11])};else if(null!=t.customSetter||null!=t.customGetter){var e=null!=t.customSetter,s=null!=t.customGetter;e&&s?Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,A,i),t.customGetter.call(this)},set:function(e){lr(l,t.name,a,r,A,i),t.customSetter.call(this,e)}}):e?Object.defineProperty(o,t.name,{set:function(e){lr(l,t.name,a,r,A,i),t.customSetter.call(this,e)}}):s&&Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,A,i),t.customGetter.call(this)}})}else Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,A,i),n[r]},set:function(e){lr(l,t.name,a,r,A,i),n[r]=e}})})},ur=function(e,t,i,n){var r=fr.get(n);r&&r.logTimes>r.count&&(i("'%s' has been removed.","".concat(e,".").concat(t)),r.count++)},Zt.removeProperty=function(i,n,e){null!=i&&e.forEach(function(e){var t=_r++;fr.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:hr}),Object.defineProperty(i,e.name,{get:function(){return ur(n,e.name,C,t)},set:function(){ur(n,e.name,C,t)}})})},cr=function(e,t,i,n){var r=fr.get(n);r&&r.logTimes>r.count&&(i("'%s' is deprecated.","".concat(e,".").concat(t)),r.count++)},Zt.markAsWarning=function(a,s,e){if(null!=a){var o=function(e,t,i,n,r,a,s){if(i.get){var o=i.get();i.get=function(){return cr(n,r,a,s),o.call(this)}}if(i.set){var l=Object.create(i.set);i.set=function(e){cr(n,r,a,s),l.call(this,e)}}};e.forEach(function(e){var t=e.name,i=Object.getOwnPropertyDescriptor(a,t);if(i){var n=_r++;if(fr.set(n,{id:n,count:0,logTimes:void 0!==e.logTimes?e.logTimes:hr}),null!=i.value)if("function"==typeof i.value){var r=i.value;a[t]=function(){return cr(s,t,A,n),r.call(this)}}else o(0,0,i,s,t,A,n);else o(0,0,i,s,t,A,n)}})}},Zt.replaceProperty(Ui,"Vec2",[{name:"sub",newName:"subtract",target:Ui,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Ui,targetName:"Vec2"},{name:"div",newName:"divide",target:Ui,targetName:"Vec2"},{name:"dist",newName:"distance",target:Ui,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Ui,targetName:"Vec2"},{name:"mag",newName:"len",target:Ui,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Ui,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ui,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ui,targetName:"Vec2"}]),Zt.replaceProperty(Ui.prototype,"Vec2",[{name:"mag",newName:"length",target:Ui.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Ui.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ui.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ui.prototype,targetName:"Vec2"}]),Zt.removeProperty(Ui.prototype,"vmath",[{name:"divide"}]),Zt.replaceProperty(Xi,"Vec3",[{name:"sub",newName:"subtract",target:Xi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Xi,targetName:"Vec3"},{name:"div",newName:"divide",target:Xi,targetName:"Vec3"},{name:"dist",newName:"distance",target:Xi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Xi,targetName:"Vec3"},{name:"mag",newName:"len",target:Xi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Xi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Xi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Xi,targetName:"Vec3"}]),Zt.replaceProperty(Xi.prototype,"Vec3",[{name:"mag",newName:"length",target:Xi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Xi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Xi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Xi.prototype,targetName:"Vec3"}]),Zt.removeProperty(Xi.prototype,"vmath",[{name:"divide"}]),Zt.replaceProperty($i,"Vec4",[{name:"sub",newName:"subtract",target:$i,targetName:"Vec4"},{name:"mul",newName:"multiply",target:$i,targetName:"Vec4"},{name:"div",newName:"divide",target:$i,targetName:"Vec4"},{name:"dist",newName:"distance",target:$i,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:$i,targetName:"Vec4"},{name:"mag",newName:"len",target:$i,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:$i,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:$i,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:$i,targetName:"Vec4"}]),Zt.replaceProperty($i.prototype,"Vec4",[{name:"mag",newName:"length",target:$i.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:$i.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:$i.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:$i.prototype,targetName:"Vec4"}]),Zt.removeProperty($i.prototype,"vmath",[{name:"divide"}]),Zt.replaceProperty(vn,"Quat",[{name:"mag",newName:"len",target:vn,targetName:"Quat"},{name:"mul",newName:"multiply",target:vn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:vn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:vn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:vn,targetName:"Quat"}]),Zt.replaceProperty(vn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:vn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:vn.prototype,targetName:"Quat"}]),Zt.replaceProperty(or,"Color",[{name:"sub",newName:"subtract",target:or,targetName:"Color"},{name:"mul",newName:"multiply",target:or,targetName:"Color"},{name:"div",newName:"divide",target:or,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:or,targetName:"Color"}]),Zt.replaceProperty(un,"Mat3",[{name:"sub",newName:"subtract",target:un,targetName:"Mat3"},{name:"mul",newName:"multiply",target:un,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:un,targetName:"Mat3"}]),Zt.replaceProperty(un.prototype,"Mat3",[{name:"sub",newName:"subtract",target:un.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:un.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:un.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:un.prototype,targetName:"Mat3"}]),Zt.replaceProperty(Nn,"Mat4",[{name:"sub",newName:"subtract",target:Nn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Nn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Mat4"}]),Zt.replaceProperty(Nn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Nn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Nn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Nn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Mat4"}]);var dr=Object.freeze({bits:_t,Vec2:Ui,Vec3:Xi,Vec4:$i,Quat:vn,Mat3:un,Mat4:Nn,AffineTransform:Yn,Size:Kn,Rect:er,Color:or,EPSILON:Ei,equals:function(e,t){return Math.abs(e-t)<=Ei*Math.max(1,Math.abs(e),Math.abs(t))},approx:function(e,t,i){return i=i||Ei,Math.abs(e-t)<=i},clamp:wi,clamp01:Ai,lerp:Ci,toRadian:ki,toDegree:Ri,random:Oi,randomRange:Mi,randomRangeInt:Li,pseudoRandom:Ii,pseudoRandomRange:Fi,pseudoRandomRangeInt:function(e,t,i){return Math.floor(Fi(e,t,i))},nextPow2:function(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},repeat:Pi,pingPong:Di,inverseLerp:zi}),pr=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,ot.MOUSE,t))).movementX=0,i.movementY=0,i._eventType=void 0,i._button=0,i._x=0,i._y=0,i._prevX=0,i._prevY=0,i._scrollX=0,i._scrollY=0,i._eventType=e,i}return d(n,ot),l(n,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new Ui),Ui.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new Ui),Ui.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new Ui),Ui.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e||(e=new Ui),Ui.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Ui),Ui.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Ui),Ui.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new Ui),Ui.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),n}();pr.NONE=0,pr.DOWN=1,pr.UP=2,pr.MOVE=3,pr.SCROLL=4,pr.BUTTON_LEFT=0,pr.BUTTON_RIGHT=2,pr.BUTTON_MIDDLE=1,pr.BUTTON_4=3,pr.BUTTON_5=4,pr.BUTTON_6=5,pr.BUTTON_7=6,pr.BUTTON_8=7;var mr=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,ot.TOUCH,t))).touch=null,i._eventCode=0,i.simulate=!1,i._touches=void 0,i._eventCode=0,i._touches=e||[],i}return d(n,ot),l(n,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Ui}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Ui}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Ui}},{key:"getUILocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Ui}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Ui}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Ui}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Ui}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Ui}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Ui}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),n}();mr.MAX_TOUCHES=5,mr.BEGAN=0,mr.MOVED=1,mr.ENDED=2,mr.CANCELLED=3;var vr=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,ot.ACCELERATION,t))).acc=void 0,i.acc=e,i}return d(n,ot),n}(),yr=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,ot.KEYBOARD,i))).keyCode=void 0,n.rawEvent=void 0,n.isPressed=void 0,"number"==typeof e?n.keyCode=e:(n.keyCode=e.keyCode,n.rawEvent=e),n.isPressed=t,n}return d(r,ot),r}();ot.EventMouse=pr,ot.EventTouch=mr,ot.EventAcceleration=vr,ot.EventKeyboard=yr;var gr=function(){function n(e,t,i){y(this,n),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}return l(n,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new Tr:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new xr:t===cc.EventListener.MOUSE?i=new Sr:t===cc.EventListener.KEYBOARD?i=new wr:t===cc.EventListener.ACCELERATION&&(i=new Er(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),l(n,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),n}();gr.UNKNOWN=0,gr.TOUCH_ONE_BY_ONE=1,gr.TOUCH_ALL_AT_ONCE=2,gr.KEYBOARD=3,gr.MOUSE=4,gr.ACCELERATION=6,gr.CUSTOM=8,gr.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var br=gr.ListenerID,Sr=function(e){function i(){var t;return y(this,i),(t=T(this,S(i).call(this,gr.MOUSE,br.MOUSE,null))).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}return d(i,gr),l(i,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new i;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),i}(),Tr=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,gr.TOUCH_ONE_BY_ONE,br.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return d(t,gr),l(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),xr=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,gr.TOUCH_ALL_AT_ONCE,br.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return d(t,gr),l(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),Er=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,gr.ACCELERATION,br.ACCELERATION,null)))._onAccelerationEvent=null,t._onEvent=function(e){return t._callback(e)},t._onAccelerationEvent=e,t}return d(i,gr),l(i,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new i(this._onAccelerationEvent)}}]),i}(),wr=function(e){function i(){var t;return y(this,i),(t=T(this,S(i).call(this,gr.KEYBOARD,br.KEYBOARD,null))).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}return d(i,gr),l(i,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new i;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),i}(),Ar=(cc.EventListener=gr).ListenerID;var Cr=function(){function e(){y(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return l(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var kr=new(function(){function e(){y(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[]}return l(e,[{key:"pauseTarget",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){i[n]._setPaused(!0)}if(!0===t){var r=e.children;if(r)for(var a=0;a<r.length;++a){var s=r[a];this.pauseTarget(s,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){i[n]._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&0<e.children.length){var r=e.children;if(r)for(var a=0;a<r.length;++a){var s=r[a];this.resumeTarget(s,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!function(e){for(;e;){if(e.getComponent("cc.CanvasComponent"))return!0;e=e.parent}return!1}(t))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=gr.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var o=this._toAddedListeners,l=o.length-1;0<=l;l--){var c=o[l];if(c===e){cc.js.array.removeAt(o,l),c._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var i=this._nodeListenersMap[e._id];if(i){for(var n=cc.js.array.copy(i),r=0;r<n.length;++r){var a=n[r];this.removeListener(a)}delete this._nodeListenersMap[e._id]}for(var s=this._toAddedListeners,o=0;o<s.length;){var l=s[o];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),s.splice(o,1)):++o}if(!0===t)for(var c=e.getChildren(),u=0;u<c.length;++u){var h=c[u];this.removeListeners(h,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Ar.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Ar.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(Ar.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(Ar.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(Ar.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=ot,i=e.type;return i===t.ACCELERATION?Ar.ACCELERATION:i===t.KEYBOARD?Ar.KEYBOARD:i.startsWith(t.MOUSE)?Ar.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(0<e.children.length)for(var a=e.children,s=0,o=a?a.length:0;s<o;s++)this._setDirtyForNode(a[s])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new Cr,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;0<=i;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;0<=a;a--){var s=r[a];s&&s._getListenerID()===e&&cc.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;(i[e]&&(t=i[e]),0!==t)&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy))return-1;if(!e||!i||!i._activeInHierarchy)return 1;for(var r=i,a=n,s=!1;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(s=!0)&&n:r.parent,a=null===a.parent.parent?(s=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var o=r.getSiblingIndex(),l=a.getSiblingIndex();return s?o-l:l-o}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(0<=i[n]._getFixedPriority());)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;0<=r;r--){var a=i[r];if(!a._isRegistered()){cc.js.array.removeAt(i,r);var s=n.indexOf(a);-1!==s&&n.splice(s,1)}}if(t)for(var o=t.length-1;0<=o;o--){var l=t[o];if(!l._isRegistered()){cc.js.array.removeAt(t,o);var c=n.indexOf(l);-1!==c&&n.splice(c,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(0<t,3508),!(1<t)){var i;(i=this._listenersMap[Ar.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[Ar.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var s=a.indexOf(i);-1!==s&&a.splice(s,1)}if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r,a=!1,s=i.getEventCode();return s===mr.BEGAN?e.onTouchBegan&&(a=e.onTouchBegan(n,i))&&e._isRegistered()&&e._claimedTouches.push(n):0<e._claimedTouches.length&&-1!==(r=e._claimedTouches.indexOf(n))&&(a=!0,s===mr.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):s===mr.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1)):s===mr.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1))),i.isStopped()?(kr._updateTouchListeners(i),!0):!!(a&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(Ar.TOUCH_ONE_BY_ONE),this._sortEventListeners(Ar.TOUCH_ALL_AT_ONCE);var t=this._getListeners(Ar.TOUCH_ONE_BY_ONE),i=this._getListeners(Ar.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var s=0;s<n.length;++s){var o=n[s];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&0<r.length&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===mr.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===mr.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===mr.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===mr.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(kr._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),s=0;if(r&&0!==r.length)for(;s<e.gt0Index;++s){var o=r[s];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var c=a[l];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}if(r&&!n)for(;s<r.length;++s){var u=r[s];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}());cc.eventManager=kr;var Rr={SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat:cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Ui(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1};cc.macro=Rr;var Or,Mr={};Mr.LANGUAGE_ENGLISH="en",Mr.LANGUAGE_CHINESE="zh",Mr.LANGUAGE_FRENCH="fr",Mr.LANGUAGE_ITALIAN="it",Mr.LANGUAGE_GERMAN="de",Mr.LANGUAGE_SPANISH="es",Mr.LANGUAGE_DUTCH="du",Mr.LANGUAGE_RUSSIAN="ru",Mr.LANGUAGE_KOREAN="ko",Mr.LANGUAGE_JAPANESE="ja",Mr.LANGUAGE_HUNGARIAN="hu",Mr.LANGUAGE_PORTUGUESE="pt",Mr.LANGUAGE_ARABIC="ar",Mr.LANGUAGE_NORWEGIAN="no",Mr.LANGUAGE_POLISH="pl",Mr.LANGUAGE_TURKISH="tr",Mr.LANGUAGE_UKRAINIAN="uk",Mr.LANGUAGE_ROMANIAN="ro",Mr.LANGUAGE_BULGARIAN="bg",Mr.LANGUAGE_UNKNOWN="unknown",Mr.OS_IOS="iOS",Mr.OS_ANDROID="Android",Mr.OS_WINDOWS="Windows",Mr.OS_MARMALADE="Marmalade",Mr.OS_LINUX="Linux",Mr.OS_BADA="Bada",Mr.OS_BLACKBERRY="Blackberry",Mr.OS_OSX="OS X",Mr.OS_WP8="WP8",Mr.OS_WINRT="WINRT",Mr.OS_UNKNOWN="Unknown",Mr.UNKNOWN=-1,Mr.WIN32=0,Mr.LINUX=1,Mr.MACOS=2,Mr.ANDROID=3,Mr.IPHONE=4,Mr.IPAD=5,Mr.BLACKBERRY=6,Mr.NACL=7,Mr.EMSCRIPTEN=8,Mr.TIZEN=9,Mr.WINRT=10,Mr.WP8=11,Mr.MOBILE_BROWSER=100,Mr.DESKTOP_BROWSER=101,Mr.EDITOR_PAGE=102,Mr.EDITOR_CORE=103,Mr.WECHAT_GAME=104,Mr.QQ_PLAY=105,Mr.BROWSER_TYPE_WECHAT="wechat",Mr.BROWSER_TYPE_WECHAT_GAME="wechatgame",Mr.BROWSER_TYPE_WECHAT_GAME_SUB="wechatgamesub",Mr.BROWSER_TYPE_QQ_PLAY="qqplay",Mr.BROWSER_TYPE_ANDROID="androidbrowser",Mr.BROWSER_TYPE_IE="ie",Mr.BROWSER_TYPE_QQ="qqbrowser",Mr.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",Mr.BROWSER_TYPE_UC="ucbrowser",Mr.BROWSER_TYPE_UCBS="ucbs",Mr.BROWSER_TYPE_360="360browser",Mr.BROWSER_TYPE_BAIDU_APP="baiduboxapp",Mr.BROWSER_TYPE_BAIDU="baidubrowser",Mr.BROWSER_TYPE_MAXTHON="maxthon",Mr.BROWSER_TYPE_OPERA="opera",Mr.BROWSER_TYPE_OUPENG="oupeng",Mr.BROWSER_TYPE_MIUI="miuibrowser",Mr.BROWSER_TYPE_FIREFOX="firefox",Mr.BROWSER_TYPE_SAFARI="safari",Mr.BROWSER_TYPE_CHROME="chrome",Mr.BROWSER_TYPE_LIEBAO="liebao",Mr.BROWSER_TYPE_QZONE="qzone",Mr.BROWSER_TYPE_SOUGOU="sogou",Mr.BROWSER_TYPE_UNKNOWN="unknown",Mr.isNative=!1,Mr.isBrowser="object"===("undefined"==typeof window?"undefined":fe(window))&&"object"===("undefined"==typeof document?"undefined":fe(document))&&!1,Mr.isLittleEndian=(Or=new ArrayBuffer(2),new DataView(Or).setInt16(0,256,!0),256===new Int16Array(Or)[0]);var Lr=wx.getSystemInfoSync();Mr.isMobile=!0,Mr.platform=Mr.WECHAT_GAME,Mr.language=Lr.language.substr(0,2);var Ir=Lr.system.toLowerCase();"android"===Lr.platform?Mr.os=Mr.OS_ANDROID:"ios"===Lr.platform?Mr.os=Mr.OS_IOS:"devtools"===Lr.platform&&(Mr.isMobile=!1,-1<Ir.indexOf("android")?Mr.os=Mr.OS_ANDROID:-1<Ir.indexOf("ios")&&(Mr.os=Mr.OS_IOS)),"android p"===Ir&&(Ir="android p 9.0");var Fr=/[\d\.]+/.exec(Ir);Mr.osVersion=Fr?Fr[0]:Ir,Mr.osMainVersion=parseInt(Mr.osVersion),wx.getFileSystemManager?Mr.browserType=Mr.BROWSER_TYPE_WECHAT_GAME:Mr.browserType=Mr.BROWSER_TYPE_WECHAT_GAME_SUB,Mr.browserVersion=Lr.version;var Pr=Lr.windowWidth,Dr=Lr.windowHeight,zr=Lr.pixelRatio||1;Mr.windowPixelResolution={width:zr*Pr,height:zr*Dr},Mr.localStorage=window.localStorage,Mr.capabilities={canvas:!0,opengl:Mr.browserType!==Mr.BROWSER_TYPE_WECHAT_GAME_SUB,webp:!1},Mr.__audioSupport={ONLY_ONE:!1,WEB_AUDIO:!1,DELAY_CREATE_CTX:!1,format:[".mp3"]},Mr.NetworkType={NONE:0,LAN:1,WWAN:2},Mr.getNetworkType=function(){return Mr.NetworkType.LAN},Mr.getBatteryLevel=function(){return 1},Mr.garbageCollect=function(){},Mr.dumpRoot=function(){},Mr.restartVM=function(){},Mr.cleanScript=function(e){},Mr.isObjectValid=function(e){return!!e},Mr.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},Mr.openURL=function(e){window.open(e)},Mr.now=function(){return Date.now?Date.now():+new Date},cc.sys=Mr;var Br=new Ui,Nr=function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;y(this,n),this._point=new Ui,this._prevPoint=new Ui,this._lastModified=0,this._id=null,this._startPoint=new Ui,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}return l(n,[{key:"getLocation",value:function(e){return e||(e=new Ui),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new Ui),e.set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new Ui),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Ui),e.set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new Ui),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new Ui),e.set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Ui),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new Ui),Br.set(this._point),Br.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),Ui.divide(e,Br,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new Ui),e.set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new Ui),e.set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new Ui),e.set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length?arguments[1]:void 0,i=2<arguments.length?arguments[2]:void 0;this._prevPoint=this._point,this._point=new Ui(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new Ui(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,t){"object"===fe(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0)}},{key:"_setPrevPoint",value:function(e,t){"object"===fe(e)?this._prevPoint=new Ui(e.x,e.y):this._prevPoint=new Ui(e||0,t||0)}}]),n}();cc.Touch=Nr;var Ur,Gr,Vr=Rr.TOUCH_TIMEOUT,Hr=new Ui,jr=new Ui,Wr=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=i,this.z=n,this.timestamp=r},Xr=new(function(){function e(){y(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Ui,this._prevMousePoint=new Ui,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return l(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=Mr.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s)if(void 0===i[s]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}var l=new Nr(a._point.x,a._point.y,a.getID());(this._touches[o]=l)._lastModified=n,l._setPrevPoint(a._prevPoint),i[s]=o,t.push(l)}}if(0<t.length){var c=new mr(t);c._eventCode=mr.BEGAN,kr.dispatchEvent(c)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=Mr.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=this._touchesIntegerDict[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),i[o]._lastModified=n,t.push(i[o]))}}if(0<t.length){var l=new mr(t);l._eventCode=mr.MOVED,kr.dispatchEvent(l)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new mr(t);i._eventCode=mr.ENDED,kr.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new mr(t);i._eventCode=mr.CANCELLED,kr.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=n[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),t.push(i[o]),this._removeUsedIndexBit(o),delete n[s])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(Mr.platform===Mr.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=window.pageXOffset-t.clientLeft,n=window.pageYOffset-t.clientTop;if(e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var s=new Nr(a.x,a.y,0);return s._setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,s}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new pr(i);return r._setPrevCursor(n.x,n.y),n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(Mr.platform===Mr.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,s=0;s<a;s++){var o=e.changedTouches[s];if(o){var l=void 0;l=Mr.BROWSER_TYPE_FIREFOX===Mr.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,Hr):n.convertToLocationInView(o.clientX,o.clientY,t,Hr);var c=void 0;null!=o.identifier?(c=new Nr(l.x,l.y,o.identifier),this.getPreTouch(c).getLocation(jr),c._setPrevPoint(jr.x,jr.y),this.setPreTouch(c)):(c=new Nr(l.x,l.y))._setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(c)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent){this._glView=cc.view;var t=Mr.isMobile,i="mouse"in Mr.capabilities,n="touches"in Mr.capabilities;Mr.platform===Mr.WECHAT_GAME&&(i=!(n=!(t=!1))),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var s=e;i=(s.gamma||0)/90*.981,n=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,kr.dispatchEvent(new vr(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n._lastModified>Vr){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var t=this,e=function(){var e=cc.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}},{key:"_registerWindowMouseEvents",value:function(r){var a=this;window.addEventListener("mousedown",function(){a._mousePressed=!0},!1),window.addEventListener("mouseup",function(e){if(a._mousePressed){a._mousePressed=!1;var t=a.getHTMLElementPosition(r),i=a.getPointByEvent(e,t);if(!tr(t.left,t.top,t.width,t.height).contains(new Ui(i.x,i.y))){a.handleTouchesEnd([a.getTouchByXY(e,i.x,i.y,t)]);var n=a.getMouseEvent(i,t,pr.UP);n.setButton(e.button),kr.dispatchEvent(n)}}},!1)}},{key:"_registerElementMouseEvents",value:function(s,e){var o=this,t=function(e,r,a){s.addEventListener(e,function(e){var t=o.getHTMLElementPosition(s),i=o.getPointByEvent(e,t),n=o.getMouseEvent(i,t,r);n.setButton(e.button),a(e,n,i,t),kr.dispatchEvent(n),e.stopPropagation(),e.preventDefault()})};e||(t("mousedown",pr.DOWN,function(e,t,i,n){o._mousePressed=!0,o.handleTouchesBegin([o.getTouchByXY(e,i.x,i.y,n)]),s.focus()}),t("mouseup",pr.UP,function(e,t,i,n){o._mousePressed=!1,o.handleTouchesEnd([o.getTouchByXY(e,i.x,i.y,n)])}),t("mousemove",pr.MOVE,function(e,t,i,n){o.handleTouchesMove([o.getTouchByXY(e,i.x,i.y,n)]),o._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),t("mousewheel",pr.SCROLL,function(e,t,i,n){t.setScrollData(0,e.wheelDelta)}),t("DOMMouseScroll",pr.SCROLL,function(e,t,i,n){t.setScrollData(0,-120*e.detail)})}},{key:"_registerMousePointerEvents",value:function(n){var r=this,t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},e=function(e){var i=t[e];n.addEventListener(e,function(e){var t=r.getHTMLElementPosition(n);t.left-=document.documentElement.scrollLeft,t.top-=document.documentElement.scrollTop,i.call(r,[r.getTouchByXY(e,e.clientX,e.clientY,t)]),e.stopPropagation()},!1)};for(var i in t)e(i)}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(r){var a=this,e=function(n){return function(e){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t))}};wx.onTouchStart(e(function(e){a.handleTouchesBegin(e)})),wx.onTouchEnd(e(function(e){a.handleTouchesEnd(e)})),wx.onTouchMove(e(function(e){a.handleTouchesMove(e)})),wx.onTouchCancel(e(function(e){a.handleTouchesCancel(e)}))}},{key:"_registerHTMLTouchEvents",value:function(r){var a=this,e=function(n){return function(e){if(e.changedTouches){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t)),e.stopPropagation(),e.preventDefault()}}};r.addEventListener("touchstart",e(function(e){a.handleTouchesBegin(e),Mr.platform!==Mr.WECHAT_GAME&&r.focus()}),!1),r.addEventListener("touchmove",e(function(e){a.handleTouchesMove(e)}),!1),r.addEventListener("touchend",e(function(e){a.handleTouchesEnd(e)}),!1),r.addEventListener("touchcancel",e(function(e){a.handleTouchesCancel(e)}),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",function(e){kr.dispatchEvent(new yr(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",function(e){kr.dispatchEvent(new yr(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new Wr,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),Ur=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,Ur,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";Ur&&window.removeEventListener(e,Ur,!1)}}]),e}());cc.internal.inputManager=Xr,(Gr=Zt.SystemEventType||(Zt.SystemEventType={})).TOUCH_START="touch-start",Gr.TOUCH_MOVE="touch-move",Gr.TOUCH_END="touch-end",Gr.TOUCH_CANCEL="touch-cancel",Gr.MOUSE_DOWN="mouse-down",Gr.MOUSE_MOVE="mouse-move",Gr.MOUSE_UP="mouse-up",Gr.MOUSE_WHEEL="mouse-wheel",Gr.MOUSE_ENTER="mouse-enter",Gr.MOUSE_LEAVE="mouse-leave",Gr.KEY_DOWN="keydown",Gr.KEY_UP="keyup",Gr.DEVICEMOTION="devicemotion",Gr.TRANSFORM_CHANGED="transform-changed",Gr.POSITION_PART="position-part",Gr.ROTATION_PART="rotation-part",Gr.SCALE_PART="scale-part",Gr.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",Gr.SIZE_CHANGED="size-changed",Gr.ANCHOR_CHANGED="anchor-changed",Gr.CHILD_ADDED="child-added",Gr.CHILD_REMOVED="child-removed",Rt(Zt.SystemEventType),cc.SystemEventType=Zt.SystemEventType;var qr=null,Yr=null,Kr=null,Qr=null,Zr=function(e){function f(){return y(this,f),T(this,S(f).call(this))}return d(f,st),l(f,[{key:"setAccelerometerEnabled",value:function(e){Xr.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){Xr.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i){return p(S(f.prototype),"on",this).call(this,e,t,i),e!==Zt.SystemEventType.KEY_DOWN&&e!==Zt.SystemEventType.KEY_UP||qr||(qr=gr.create({event:gr.KEYBOARD,onKeyPressed:function(e,t){t.type=Zt.SystemEventType.KEY_DOWN,Jr.emit(t.type,t)},onKeyReleased:function(e,t){t.type=Zt.SystemEventType.KEY_UP,Jr.emit(t.type,t)}}),kr.addListener(qr,256)),e===Zt.SystemEventType.DEVICEMOTION&&(Yr||(Yr=gr.create({event:gr.ACCELERATION,callback:function(e,t){t.type=Zt.SystemEventType.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),kr.addListener(Yr,256))),e!==Zt.SystemEventType.TOUCH_START&&e!==Zt.SystemEventType.TOUCH_MOVE&&e!==Zt.SystemEventType.TOUCH_END&&e!==Zt.SystemEventType.TOUCH_CANCEL||Kr||(Kr=gr.create({event:gr.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=Zt.SystemEventType.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=Zt.SystemEventType.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=Zt.SystemEventType.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=Zt.SystemEventType.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),kr.addListener(Kr,256)),e!==Zt.SystemEventType.MOUSE_DOWN&&e!==Zt.SystemEventType.MOUSE_MOVE&&e!==Zt.SystemEventType.MOUSE_UP&&e!==Zt.SystemEventType.MOUSE_WHEEL||Qr||(Qr=gr.create({event:gr.MOUSE,onMouseDown:function(e){e.type=Zt.SystemEventType.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=Zt.SystemEventType.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=Zt.SystemEventType.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=Zt.SystemEventType.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),kr.addListener(Qr,256)),t}},{key:"off",value:function(e,t,i){if(p(S(f.prototype),"off",this).call(this,e,t,i),qr&&(e===Zt.SystemEventType.KEY_DOWN||e===Zt.SystemEventType.KEY_UP)){var n=this.hasEventListener(Zt.SystemEventType.KEY_DOWN),r=this.hasEventListener(Zt.SystemEventType.KEY_UP);n||r||(kr.removeListener(qr),qr=null)}if(Yr&&e===Zt.SystemEventType.DEVICEMOTION&&(kr.removeListener(Yr),Yr=null),Kr&&(e===Zt.SystemEventType.TOUCH_START||e===Zt.SystemEventType.TOUCH_MOVE||e===Zt.SystemEventType.TOUCH_END||e===Zt.SystemEventType.TOUCH_CANCEL)){var a=this.hasEventListener(Zt.SystemEventType.TOUCH_START),s=this.hasEventListener(Zt.SystemEventType.TOUCH_MOVE),o=this.hasEventListener(Zt.SystemEventType.TOUCH_END),l=this.hasEventListener(Zt.SystemEventType.TOUCH_CANCEL);a||s||o||l||(kr.removeListener(Kr),Kr=null)}if(Qr&&(e===Zt.SystemEventType.MOUSE_DOWN||e===Zt.SystemEventType.MOUSE_MOVE||e===Zt.SystemEventType.MOUSE_UP||e===Zt.SystemEventType.MOUSE_WHEEL)){var c=this.hasEventListener(Zt.SystemEventType.MOUSE_DOWN),u=this.hasEventListener(Zt.SystemEventType.MOUSE_MOVE),h=this.hasEventListener(Zt.SystemEventType.MOUSE_UP),_=this.hasEventListener(Zt.SystemEventType.MOUSE_WHEEL);c||u||h||_||(kr.removeListener(Qr),Qr=null)}}}]),f}();Zr.EventType=Zt.SystemEventType;var Jr=new(cc.SystemEvent=Zr);cc.systemEvent=Jr;var $r=Ye.fastRemove,ea=new Array(16),ta=null,ia=new Ui,na=[Zt.SystemEventType.TOUCH_START.toString(),Zt.SystemEventType.TOUCH_MOVE.toString(),Zt.SystemEventType.TOUCH_END.toString(),Zt.SystemEventType.TOUCH_CANCEL.toString()],ra=[Zt.SystemEventType.MOUSE_DOWN.toString(),Zt.SystemEventType.MOUSE_ENTER.toString(),Zt.SystemEventType.MOUSE_MOVE.toString(),Zt.SystemEventType.MOUSE_LEAVE.toString(),Zt.SystemEventType.MOUSE_UP.toString(),Zt.SystemEventType.MOUSE_WHEEL.toString()];function aa(e,t){var i=this.owner;return!(!i||!i.uiTransfromComp)&&(e.getUILocation(ia),!!i.uiTransfromComp.isHit(ia,this)&&(t.type=Zt.SystemEventType.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function sa(e,t){var i=this.owner;if(!i||!i.uiTransfromComp)return!1;t.type=Zt.SystemEventType.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function oa(e,t){var i=this.owner;i&&i.uiTransfromComp&&(e.getUILocation(ia),i.uiTransfromComp.isHit(ia,this)?t.type=Zt.SystemEventType.TOUCH_END.toString():t.type=Zt.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function la(e,t){var i=this.owner;i&&i.uiTransfromComp&&(t.type=Zt.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function ca(e){var t=this.owner;t&&t.uiTransfromComp&&(ia=e.getUILocation(),t.uiTransfromComp.isHit(ia,this)&&(e.type=Zt.SystemEventType.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function ua(e){var t=this.owner;if(t&&t.uiTransfromComp){if(ia=e.getUILocation(),t.uiTransfromComp.isHit(ia,this))this._previousIn||(ta&&ta.eventProcessor.mouseListener&&(e.type=Zt.SystemEventType.MOUSE_LEAVE,ta.dispatchEvent(e),ta.eventProcessor.mouseListener&&(ta.eventProcessor.mouseListener._previousIn=!1)),ta=t,e.type=Zt.SystemEventType.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=Zt.SystemEventType.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=Zt.SystemEventType.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,ta=null}e.propagationStopped=!0}}function ha(e){var t=this.owner;t&&t.uiTransfromComp&&(ia=e.getUILocation(),t.uiTransfromComp.isHit(ia,this)&&(e.type=Zt.SystemEventType.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function _a(e){var t=this.owner;t&&t.uiTransfromComp&&(ia=e.getUILocation(),t.uiTransfromComp.isHit(ia,this)&&(e.type=Zt.SystemEventType.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function fa(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&cc.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function da(e,t){if(e._persistNode)return!0;var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}var pa=function(){function t(e){y(this,t),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}return l(t,[{key:"node",get:function(){return this._node}}]),l(t,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=fa(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=fa(this._node))}},{key:"destroy",value:function(){ta===this._node&&(ta=null),(this.touchListener||this.mouseListener)&&(kr.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new st),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){(this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new st:this.bubblingTargets=this.bubblingTargets||new st).once(e,t,i)}},{key:"off",value:function(e,t,i,n){var r=-1!==na.indexOf(e),a=!r&&-1!==ra.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!da(this._node,na)&&(kr.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!da(this._node,ra)&&(kr.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this.bubblingTargets).emit.apply(t,[e].concat(n))}}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,ea.length=0,e.eventProcessor.getCapturingTargets(t.type,ea),t.eventPhase=1,n=ea.length-1;0<=n;--n)if((i=ea[n]).eventProcessor.capturingTargets&&((t.currentTarget=i).eventProcessor.capturingTargets.emit(t.type,t,ea),t.propagationStopped))return ea.length=0;if(ea.length=0,t.eventPhase=2,(t.currentTarget=e).eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,ea),t.eventPhase=3,n=0;n<ea.length;++n)if((i=ea[n]).eventProcessor.bubblingTargets&&((t.currentTarget=i).eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return ea.length=0;ea.length=0}(this._node,e),ea.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!da(this.node,na)&&(kr.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!da(this.node,ra)&&(kr.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==na.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:fa(this._node),onTouchBegan:aa,onTouchMoved:sa,onTouchEnded:oa,onTouchCancelled:la}),kr.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==ra.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:fa(this._node),onMouseDown:ca,onMouseMove:ua,onMouseUp:ha,onMouseScroll:_a}),kr.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule(function(){t._node.activeInHierarchy||kr.pauseTarget(t._node)},this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;if(!(r=n?this.capturingTargets=this.capturingTargets||new st:this.bubblingTargets=this.bubblingTargets||new st).hasEventListener(e,t,i)){r.on(e,t,i);var a=i;i&&(a.__eventTargets?a.__eventTargets.push(this):a.node&&a.node.__eventTargets&&a.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;if(r){r.off(e,t,i);var a=i;i&&(a.__eventTargets?$r(a.__eventTargets,this):a.node&&a.node.__eventTargets&&$r(a.node.__eventTargets,this))}}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),t}();cc.NodeEventProcessor=pa;var ma="__ccclassCache__";function va(e){return e}function ya(e,t){return e[t]||(e[t]={})}function ga(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function ba(e,i,t){return function(t){return function(e){return i(e,t)}}}var Sa=ba.bind(null,!1);function Ta(e){return ba.bind(null,!1)}var xa=Ta(),Ea=Ta();function wa(e,t){return ya(e,ma)}function Aa(e,t,i,n,r,a){var s;n&&(s=(s=Yt(n))||n);var o=Fe(t[i]||{},s||{});if(r&&(r.get||r.set)){r.get&&(o.get=r.get),r.set&&(o.set=r.set)}else{var l;0;if(r)r.initializer&&(l=function(t){var e;try{e=t()}catch(e){return t}return"object"!==fe(e)||null===e?e:t}(r.initializer),!0);else{var c=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));c.hasOwnProperty(i)&&(l=c[i],!0)}0,o.default=l}t[i]=o}var Ca=ga(function(e,t){var i=De(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e[ma];if(r){var a=r.proto;a&&Fe(n,a),e[ma]=void 0}return cc.Class(n)});function ka(e,t,i){var a=null;function n(e,t,i){var n=wa(e.constructor);if(n){var r=ya(ya(n,"proto"),"properties");Aa(e.constructor,r,t,a,i,n)}}if(void 0===t)return a=e,n;n(e,t,i)}function Ra(e,r,a){return e(function(e,t){var i=wa(e);if(i){var n=void 0!==a?a:t;ya(ya(i,"proto"),"editor")[r]=n}},r)}function Oa(e){return e(va)}var Ma=Oa(ga),La=Ra(Sa,"requireComponent"),Ia=Oa(xa),Fa=Ra(Ea,"executionOrder"),Pa=Oa(ga),Da=Oa(ga),za=Oa(xa),Ba=Oa(xa),Na=Oa(xa);var Ua=Object.freeze({ccclass:Ca,property:ka,executeInEditMode:Ma,requireComponent:La,menu:Ia,executionOrder:Fa,disallowMultiple:Pa,playOnFocus:Da,inspector:za,icon:Ba,help:Na,mixins:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=e<0||arguments.length<=e?void 0:arguments[e];return function(e){var t=wa(e);t&&(ya(t,"proto").mixins=i)}}}),Ga=[];var Va,Ha=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";y(this,t),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}return l(t,null,[{key:"_deferredDestroy",value:function(){for(var e=Ga.length,t=0;t<e;++t){var i=Ga[t];1&i._objFlags||i._destroyImmediate()}e===Ga.length?Ga.length=0:Ga.splice(0,e)}}]),l(t,[{key:"destroy",value:function(){return 1&this._objFlags?(cc.warnID(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,Ga.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof cc._BaseNode||e instanceof cc.Component,r=n?"_id":null,a={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(fe(e[i])){case"string":a[i]="";break;case"object":case"function":a[i]=null}}if(vi._isCCClass(t))for(var s=cc.Class.Attr.getClassAttrs(t),o=t.__props__,l=0;l<o.length;l++){var c=(i=o[l])+cc.Class.Attr.DELIMETER+"default";if(c in s){if(n&&"_id"===i)continue;switch(fe(s[c])){case"string":a[i]="";break;case"object":case"function":a[i]=null;break;case"undefined":a[i]=void 0}}}return function(e){for(var t in a)e[t]=a[t]}}(this,e),ge(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?cc.errorID(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}(),ja=Ha.prototype;ja._deserialize=null,ja._onPreDestroy=null,vi.fastDefine("cc.Object",Ha,{_name:"",_objFlags:0}),ge(Ha,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=function(e,t){return"object"===fe(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e},cc.Object=Ha;var Wa,Xa,qa,Ya,Ka,Qa,Za,Ja=Ca("cc.RawAsset")(Va=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._uuid=void 0,Object.defineProperty(_(t),"_uuid",{value:"",writable:!0}),t}return d(a,Ha),l(a,null,[{key:"isRawAssetType",value:function(e){return ze(e,cc.RawAsset)&&!ze(e,cc.Asset)}}]),a}())||Va;function $a(i,e){e.forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){"constructor"!==e&&Object.defineProperty(i.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})})}cc.RawAsset=Ja;var es=(Wa=Ca("cc.Asset"),Xa=ka({visible:!1}),Wa((Za=Qa=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).loaded=!0,m(t,"_native",Ka,_(t)),t._file=null,t._callbackTable=xe(!0),t}return d(a,Ja),l(a,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),l(a,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||void 0:"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}]),a}(),Qa.preventDeferredLoadDependents=!1,Qa.preventPreloadNativeObject=!1,Ka=c((Ya=Za).prototype,"_native",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),c(Ya.prototype,"nativeUrl",[Xa],Object.getOwnPropertyDescriptor(Ya.prototype,"nativeUrl"),Ya.prototype),c(Ya.prototype,"_nativeAsset",[ka],Object.getOwnPropertyDescriptor(Ya.prototype,"_nativeAsset"),Ya.prototype),qa=Ya))||qa);function ts(e){var t=[];return function e(t,i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}$a(es,[rt,st]),es.prototype.createNode=null,cc.Asset=es;var is=Ha.Flags.Destroyed,ns=Ha.Flags.PersistentMask,rs=Ot+"default",as=vi.IDENTIFIER_RE,ss="var ",os="o",ls={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},cs=vi.escapeForJS,us=function(){function i(e,t){y(this,i),this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return l(i,[{key:"toString",value:function(){return ss+this.varName+"="+this.expression+";"}}]),i}();function hs(e,t){return t instanceof us?new us(t.varName,e+t.expression):e+t}function _s(e,t,i){Array.isArray(i)?(i[0]=hs(t,i[0]),e.push(i)):e.push(hs(t,i)+";")}var fs=function(){function t(e){y(this,t),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}return l(t,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(1<this._exps.length)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];_s(e,t+ds(n[0])+"=",n[1])}}}]),t}();function ds(e){return as.test(e)?"."+e:"["+cs(e)+"]"}fs.pool=void 0,fs.pool=new qe(function(e){e._exps.length=0,e._targetExp=null},1),fs.pool.get=function(e){var t=this._get()||new fs;return t._targetExp=e,t};var ps,ms,vs,ys,gs,bs,Ss,Ts=function(){function s(e,t){var i;y(this,s),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=xe(),Fe(this.funcModuleCache,ls),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),0<this.globalVariables.length&&(i=ss+this.globalVariables.join(",")+";");var n=ts(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}return l(s,[{key:"getFuncModule",value:function(e,t){var i=Ee(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=fs.pool.get(n),a=t.constructor.__props__;a||(a=Object.keys(t));for(var s=0;s<a.length;s++){var o=a[s],l=i[o];if(t[o]!==l){var c=this.enumerateField(i,o,l);r.append(o,c)}}r.writeCode(e),fs.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,i){for(var n=i.__values__,r=Ft(i),a=0;a<n.length;a++){var s=n[a],o=t[s],l=r[s+rs];if(!xs(l,o))if("object"===fe(o)&&o instanceof cc.ValueType&&(l=vi.getDefault(l))&&l.constructor===o.constructor){var c=os+ds(s);this.setValueType(e,l,o,c)}else this.setObjProp(e,t,s,o)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new us(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){_s(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===fe(i)&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=n.source[0];n.source[0]=hs(r+"=",a)}return r}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?cs(i):("_objFlags"===t&&e instanceof Ha&&(i&=ns),i)}},{key:"setObjProp",value:function(e,t,i,n){_s(e,os+ds(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var n in t)if(t.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=t[n];"object"===fe(r)&&r&&r===t._iN$t||this.setObjProp(e,t,n,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return vi.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&is)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new us(os,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new us(os,"{}");else{if(i)return this.getObjRef(e);t=new us(os,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),s}();function xs(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function Es(e){var t=e instanceof cc._BaseNode&&e;return new Ts(e,t).result}var ws,As,Cs,ks=kt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Rs=Ca("cc.Prefab")((Ss=bs=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"data",vs,_(e)),m(e,"optimizationPolicy",ys,_(e)),m(e,"asyncLoadAssets",gs,_(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return d(t,es),l(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=Es(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e,t=!1;return t?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(),bs.OptimizationPolicy=ks,bs.OptimizationPolicyThreshold=3,vs=c((ms=Ss).prototype,"data",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ys=c(ms.prototype,"optimizationPolicy",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ks.AUTO}}),gs=c(ms.prototype,"asyncLoadAssets",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ps=ms))||ps;cc.Prefab=Rs,we(cc,"cc._Prefab","Prefab");var Os=Ca("cc.Script")(ws=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,es),t}())||ws;cc._Script=Os;var Ms=Ca("cc.JavaScript")(As=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,Os),t}())||As;cc._JavaScript=Ms;var Ls,Is,Fs,Ps,Ds=Ca("cc.TypeScript")(Cs=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,Os),t}())||Cs;cc._TypeScript=Ds;var zs=Ca("cc.SceneAsset")((Fs=c((Is=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"scene",Fs,_(t)),m(t,"asyncLoadAssets",Ps,_(t)),t}return d(a,es),a}()).prototype,"scene",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ps=c(Is.prototype,"asyncLoadAssets",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ls=Is))||Ls;function Bs(e,t){for(var i=e.length,n=t^i,r=0;4<=i;){var a=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}cc.SceneAsset=zs;var Ns,Us,Gs,Vs;(Us=Ns||(Ns={}))[Us.UNKNOWN=0]="UNKNOWN",Us[Us.BUFFER=1]="BUFFER",Us[Us.TEXTURE=2]="TEXTURE",Us[Us.TEXTURE_VIEW=3]="TEXTURE_VIEW",Us[Us.RENDER_PASS=4]="RENDER_PASS",Us[Us.FRAMEBUFFER=5]="FRAMEBUFFER",Us[Us.SAMPLER=6]="SAMPLER",Us[Us.SHADER=7]="SHADER",Us[Us.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",Us[Us.PIPELINE_STATE=9]="PIPELINE_STATE",Us[Us.BINDING_LAYOUT=10]="BINDING_LAYOUT",Us[Us.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",Us[Us.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",Us[Us.COMMAND_BUFFER=13]="COMMAND_BUFFER",Us[Us.QUEUE=14]="QUEUE",Us[Us.WINDOW=15]="WINDOW",(Vs=Gs||(Gs={}))[Vs.UNREADY=0]="UNREADY",Vs[Vs.FAILED=1]="FAILED",Vs[Vs.SUCCESS=2]="SUCCESS";var Hs,js,Ws,Xs,qs,Ys,Ks,Qs,Zs,Js,$s,eo,to,io,no,ro,ao,so,oo,lo,co,uo,ho,_o,fo,po,mo,vo,yo,go,bo,So,To,xo,Eo,wo,Ao,Co,ko,Ro,Oo,Mo,Lo,Io,Fo,Po,Do,zo,Bo,No,Uo,Go,Vo,Ho,jo,Wo,Xo,qo,Yo,Ko,Qo,Zo,Jo,$o=function(){function t(e){y(this,t),this._gfxType=Ns.UNKNOWN,this._status=Gs.UNREADY,this._gfxType=e}return l(t,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),t}();(Hs=Zt.GFXAttributeName||(Zt.GFXAttributeName={})).ATTR_POSITION="a_position",Hs.ATTR_NORMAL="a_normal",Hs.ATTR_TANGENT="a_tangent",Hs.ATTR_BITANGENT="a_bitangent",Hs.ATTR_WEIGHTS="a_weights",Hs.ATTR_JOINTS="a_joints",Hs.ATTR_COLOR="a_color",Hs.ATTR_COLOR1="a_color1",Hs.ATTR_COLOR2="a_color2",Hs.ATTR_TEX_COORD="a_texCoord",Hs.ATTR_TEX_COORD1="a_texCoord1",Hs.ATTR_TEX_COORD2="a_texCoord2",Hs.ATTR_TEX_COORD3="a_texCoord3",Hs.ATTR_TEX_COORD4="a_texCoord4",Hs.ATTR_TEX_COORD5="a_texCoord5",Hs.ATTR_TEX_COORD6="a_texCoord6",Hs.ATTR_TEX_COORD7="a_texCoord7",Hs.ATTR_TEX_COORD8="a_texCoord8",Hs.ATTR_BATCH_ID="a_batch_id",Hs.ATTR_BATCH_UV="a_batch_uv",(Ws=js||(js={}))[Ws.UNKNOWN=0]="UNKNOWN",Ws[Ws.BOOL=1]="BOOL",Ws[Ws.BOOL2=2]="BOOL2",Ws[Ws.BOOL3=3]="BOOL3",Ws[Ws.BOOL4=4]="BOOL4",Ws[Ws.INT=5]="INT",Ws[Ws.INT2=6]="INT2",Ws[Ws.INT3=7]="INT3",Ws[Ws.INT4=8]="INT4",Ws[Ws.UINT=9]="UINT",Ws[Ws.UINT2=10]="UINT2",Ws[Ws.UINT3=11]="UINT3",Ws[Ws.UINT4=12]="UINT4",Ws[Ws.FLOAT=13]="FLOAT",Ws[Ws.FLOAT2=14]="FLOAT2",Ws[Ws.FLOAT3=15]="FLOAT3",Ws[Ws.FLOAT4=16]="FLOAT4",Ws[Ws.MAT2=17]="MAT2",Ws[Ws.MAT2X3=18]="MAT2X3",Ws[Ws.MAT2X4=19]="MAT2X4",Ws[Ws.MAT3X2=20]="MAT3X2",Ws[Ws.MAT3=21]="MAT3",Ws[Ws.MAT3X4=22]="MAT3X4",Ws[Ws.MAT4X2=23]="MAT4X2",Ws[Ws.MAT4X3=24]="MAT4X3",Ws[Ws.MAT4=25]="MAT4",Ws[Ws.SAMPLER1D=26]="SAMPLER1D",Ws[Ws.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",Ws[Ws.SAMPLER2D=28]="SAMPLER2D",Ws[Ws.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",Ws[Ws.SAMPLER3D=30]="SAMPLER3D",Ws[Ws.SAMPLER_CUBE=31]="SAMPLER_CUBE",Ws[Ws.COUNT=32]="COUNT",(Xs=Zt.GFXFormat||(Zt.GFXFormat={}))[Xs.UNKNOWN=0]="UNKNOWN",Xs[Xs.A8=1]="A8",Xs[Xs.L8=2]="L8",Xs[Xs.LA8=3]="LA8",Xs[Xs.R8=4]="R8",Xs[Xs.R8SN=5]="R8SN",Xs[Xs.R8UI=6]="R8UI",Xs[Xs.R8I=7]="R8I",Xs[Xs.R16F=8]="R16F",Xs[Xs.R16UI=9]="R16UI",Xs[Xs.R16I=10]="R16I",Xs[Xs.R32F=11]="R32F",Xs[Xs.R32UI=12]="R32UI",Xs[Xs.R32I=13]="R32I",Xs[Xs.RG8=14]="RG8",Xs[Xs.RG8SN=15]="RG8SN",Xs[Xs.RG8UI=16]="RG8UI",Xs[Xs.RG8I=17]="RG8I",Xs[Xs.RG16F=18]="RG16F",Xs[Xs.RG16UI=19]="RG16UI",Xs[Xs.RG16I=20]="RG16I",Xs[Xs.RG32F=21]="RG32F",Xs[Xs.RG32UI=22]="RG32UI",Xs[Xs.RG32I=23]="RG32I",Xs[Xs.RGB8=24]="RGB8",Xs[Xs.SRGB8=25]="SRGB8",Xs[Xs.RGB8SN=26]="RGB8SN",Xs[Xs.RGB8UI=27]="RGB8UI",Xs[Xs.RGB8I=28]="RGB8I",Xs[Xs.RGB16F=29]="RGB16F",Xs[Xs.RGB16UI=30]="RGB16UI",Xs[Xs.RGB16I=31]="RGB16I",Xs[Xs.RGB32F=32]="RGB32F",Xs[Xs.RGB32UI=33]="RGB32UI",Xs[Xs.RGB32I=34]="RGB32I",Xs[Xs.RGBA8=35]="RGBA8",Xs[Xs.SRGB8_A8=36]="SRGB8_A8",Xs[Xs.RGBA8SN=37]="RGBA8SN",Xs[Xs.RGBA8UI=38]="RGBA8UI",Xs[Xs.RGBA8I=39]="RGBA8I",Xs[Xs.RGBA16F=40]="RGBA16F",Xs[Xs.RGBA16UI=41]="RGBA16UI",Xs[Xs.RGBA16I=42]="RGBA16I",Xs[Xs.RGBA32F=43]="RGBA32F",Xs[Xs.RGBA32UI=44]="RGBA32UI",Xs[Xs.RGBA32I=45]="RGBA32I",Xs[Xs.R5G6B5=46]="R5G6B5",Xs[Xs.R11G11B10F=47]="R11G11B10F",Xs[Xs.RGB5A1=48]="RGB5A1",Xs[Xs.RGBA4=49]="RGBA4",Xs[Xs.RGB10A2=50]="RGB10A2",Xs[Xs.RGB10A2UI=51]="RGB10A2UI",Xs[Xs.RGB9E5=52]="RGB9E5",Xs[Xs.D16=53]="D16",Xs[Xs.D16S8=54]="D16S8",Xs[Xs.D24=55]="D24",Xs[Xs.D24S8=56]="D24S8",Xs[Xs.D32F=57]="D32F",Xs[Xs.D32F_S8=58]="D32F_S8",Xs[Xs.BC1=59]="BC1",Xs[Xs.BC1_ALPHA=60]="BC1_ALPHA",Xs[Xs.BC1_SRGB=61]="BC1_SRGB",Xs[Xs.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",Xs[Xs.BC2=63]="BC2",Xs[Xs.BC2_SRGB=64]="BC2_SRGB",Xs[Xs.BC3=65]="BC3",Xs[Xs.BC3_SRGB=66]="BC3_SRGB",Xs[Xs.BC4=67]="BC4",Xs[Xs.BC4_SNORM=68]="BC4_SNORM",Xs[Xs.BC5=69]="BC5",Xs[Xs.BC5_SNORM=70]="BC5_SNORM",Xs[Xs.BC6H_UF16=71]="BC6H_UF16",Xs[Xs.BC6H_SF16=72]="BC6H_SF16",Xs[Xs.BC7=73]="BC7",Xs[Xs.BC7_SRGB=74]="BC7_SRGB",Xs[Xs.ETC_RGB8=75]="ETC_RGB8",Xs[Xs.ETC2_RGB8=76]="ETC2_RGB8",Xs[Xs.ETC2_SRGB8=77]="ETC2_SRGB8",Xs[Xs.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",Xs[Xs.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",Xs[Xs.ETC2_RGBA8=80]="ETC2_RGBA8",Xs[Xs.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",Xs[Xs.EAC_R11=82]="EAC_R11",Xs[Xs.EAC_R11SN=83]="EAC_R11SN",Xs[Xs.EAC_RG11=84]="EAC_RG11",Xs[Xs.EAC_RG11SN=85]="EAC_RG11SN",Xs[Xs.PVRTC_RGB2=86]="PVRTC_RGB2",Xs[Xs.PVRTC_RGBA2=87]="PVRTC_RGBA2",Xs[Xs.PVRTC_RGB4=88]="PVRTC_RGB4",Xs[Xs.PVRTC_RGBA4=89]="PVRTC_RGBA4",Xs[Xs.PVRTC2_2BPP=90]="PVRTC2_2BPP",Xs[Xs.PVRTC2_4BPP=91]="PVRTC2_4BPP",(Ys=qs||(qs={}))[Ys.NONE=0]="NONE",Ys[Ys.TRANSFER_SRC=1]="TRANSFER_SRC",Ys[Ys.TRANSFER_DST=2]="TRANSFER_DST",Ys[Ys.INDEX=4]="INDEX",Ys[Ys.VERTEX=8]="VERTEX",Ys[Ys.UNIFORM=16]="UNIFORM",Ys[Ys.STORAGE=32]="STORAGE",Ys[Ys.INDIRECT=64]="INDIRECT",(Qs=Ks||(Ks={}))[Qs.NONE=0]="NONE",Qs[Qs.DEVICE=1]="DEVICE",Qs[Qs.HOST=2]="HOST",(Js=Zs||(Zs={}))[Js.NONE=0]="NONE",Js[Js.READ=1]="READ",Js[Js.WRITE=2]="WRITE",($s=Zt.GFXPrimitiveMode||(Zt.GFXPrimitiveMode={}))[$s.POINT_LIST=0]="POINT_LIST",$s[$s.LINE_LIST=1]="LINE_LIST",$s[$s.LINE_STRIP=2]="LINE_STRIP",$s[$s.LINE_LOOP=3]="LINE_LOOP",$s[$s.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",$s[$s.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",$s[$s.ISO_LINE_LIST=6]="ISO_LINE_LIST",$s[$s.TRIANGLE_LIST=7]="TRIANGLE_LIST",$s[$s.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",$s[$s.TRIANGLE_FAN=9]="TRIANGLE_FAN",$s[$s.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",$s[$s.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",$s[$s.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",$s[$s.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(to=eo||(eo={}))[to.FILL=0]="FILL",to[to.POINT=1]="POINT",to[to.LINE=2]="LINE",(no=io||(io={}))[no.GOURAND=0]="GOURAND",no[no.FLAT=1]="FLAT",(ao=ro||(ro={}))[ao.NONE=0]="NONE",ao[ao.FRONT=1]="FRONT",ao[ao.BACK=2]="BACK",(oo=so||(so={}))[oo.NEVER=0]="NEVER",oo[oo.LESS=1]="LESS",oo[oo.EQUAL=2]="EQUAL",oo[oo.LESS_EQUAL=3]="LESS_EQUAL",oo[oo.GREATER=4]="GREATER",oo[oo.NOT_EQUAL=5]="NOT_EQUAL",oo[oo.GREATER_EQUAL=6]="GREATER_EQUAL",oo[oo.ALWAYS=7]="ALWAYS",(co=lo||(lo={}))[co.ZERO=0]="ZERO",co[co.KEEP=1]="KEEP",co[co.REPLACE=2]="REPLACE",co[co.INCR=3]="INCR",co[co.DECR=4]="DECR",co[co.INVERT=5]="INVERT",co[co.INCR_WRAP=6]="INCR_WRAP",co[co.DECR_WRAP=7]="DECR_WRAP",(ho=uo||(uo={}))[ho.ADD=0]="ADD",ho[ho.SUB=1]="SUB",ho[ho.REV_SUB=2]="REV_SUB",ho[ho.MIN=3]="MIN",ho[ho.MAX=4]="MAX",(fo=_o||(_o={}))[fo.ZERO=0]="ZERO",fo[fo.ONE=1]="ONE",fo[fo.SRC_ALPHA=2]="SRC_ALPHA",fo[fo.DST_ALPHA=3]="DST_ALPHA",fo[fo.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",fo[fo.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",fo[fo.SRC_COLOR=6]="SRC_COLOR",fo[fo.DST_COLOR=7]="DST_COLOR",fo[fo.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",fo[fo.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",fo[fo.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",fo[fo.CONSTANT_COLOR=11]="CONSTANT_COLOR",fo[fo.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",fo[fo.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",fo[fo.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(mo=po||(po={}))[mo.NONE=0]="NONE",mo[mo.R=1]="R",mo[mo.G=2]="G",mo[mo.B=4]="B",mo[mo.A=8]="A",mo[mo.ALL=15]="ALL",(yo=vo||(vo={}))[yo.NONE=0]="NONE",yo[yo.POINT=1]="POINT",yo[yo.LINEAR=2]="LINEAR",yo[yo.ANISOTROPIC=3]="ANISOTROPIC",(bo=go||(go={}))[bo.WRAP=0]="WRAP",bo[bo.MIRROR=1]="MIRROR",bo[bo.CLAMP=2]="CLAMP",bo[bo.BORDER=3]="BORDER",(To=So||(So={}))[To.TEX1D=0]="TEX1D",To[To.TEX2D=1]="TEX2D",To[To.TEX3D=2]="TEX3D",(Eo=xo||(xo={}))[Eo.NONE=0]="NONE",Eo[Eo.TRANSFER_SRC=1]="TRANSFER_SRC",Eo[Eo.TRANSFER_DST=2]="TRANSFER_DST",Eo[Eo.SAMPLED=4]="SAMPLED",Eo[Eo.STORAGE=8]="STORAGE",Eo[Eo.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",Eo[Eo.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",Eo[Eo.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",Eo[Eo.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT",(Ao=wo||(wo={}))[Ao.X1=0]="X1",Ao[Ao.X2=1]="X2",Ao[Ao.X4=2]="X4",Ao[Ao.X8=3]="X8",Ao[Ao.X16=4]="X16",Ao[Ao.X32=5]="X32",Ao[Ao.X64=6]="X64",(ko=Co||(Co={}))[ko.NONE=0]="NONE",ko[ko.GEN_MIPMAP=1]="GEN_MIPMAP",ko[ko.CUBEMAP=2]="CUBEMAP",ko[ko.BAKUP_BUFFER=4]="BAKUP_BUFFER",(Oo=Ro||(Ro={}))[Oo.TV1D=0]="TV1D",Oo[Oo.TV2D=1]="TV2D",Oo[Oo.TV3D=2]="TV3D",Oo[Oo.CUBE=3]="CUBE",Oo[Oo.TV1D_ARRAY=4]="TV1D_ARRAY",Oo[Oo.TV2D_ARRAY=5]="TV2D_ARRAY",(Lo=Mo||(Mo={}))[Lo.VERTEX=0]="VERTEX",Lo[Lo.HULL=1]="HULL",Lo[Lo.DOMAIN=2]="DOMAIN",Lo[Lo.GEOMETRY=3]="GEOMETRY",Lo[Lo.FRAGMENT=4]="FRAGMENT",Lo[Lo.COMPUTE=5]="COMPUTE",Lo[Lo.COUNT=6]="COUNT",(Fo=Io||(Io={}))[Fo.UNKNOWN=0]="UNKNOWN",Fo[Fo.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",Fo[Fo.SAMPLER=2]="SAMPLER",Fo[Fo.STORAGE_BUFFER=3]="STORAGE_BUFFER",(Do=Po||(Po={}))[Do.PRIMARY=0]="PRIMARY",Do[Do.SECONDARY=1]="SECONDARY",(Bo=zo||(zo={}))[Bo.LOAD=0]="LOAD",Bo[Bo.CLEAR=1]="CLEAR",Bo[Bo.DISCARD=2]="DISCARD",(Uo=No||(No={}))[Uo.STORE=0]="STORE",Uo[Uo.DISCARD=1]="DISCARD",(Vo=Go||(Go={}))[Vo.UNDEFINED=0]="UNDEFINED",Vo[Vo.GENERAL=1]="GENERAL",Vo[Vo.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",Vo[Vo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",Vo[Vo.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",Vo[Vo.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",Vo[Vo.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",Vo[Vo.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",Vo[Vo.PREINITIALIZED=8]="PREINITIALIZED",Vo[Vo.PRESENT_SRC=9]="PRESENT_SRC",(jo=Ho||(Ho={}))[jo.GRAPHICS=0]="GRAPHICS",jo[jo.COMPUTE=1]="COMPUTE",jo[jo.RAY_TRACING=2]="RAY_TRACING",(Xo=Wo||(Wo={}))[Xo.VIEWPORT=0]="VIEWPORT",Xo[Xo.SCISSOR=1]="SCISSOR",Xo[Xo.LINE_WIDTH=2]="LINE_WIDTH",Xo[Xo.DEPTH_BIAS=3]="DEPTH_BIAS",Xo[Xo.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",Xo[Xo.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",Xo[Xo.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",Xo[Xo.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK",(Yo=qo||(qo={}))[Yo.FRONT=0]="FRONT",Yo[Yo.BACK=1]="BACK",Yo[Yo.ALL=2]="ALL",(Qo=Ko||(Ko={}))[Qo.GRAPHICS=0]="GRAPHICS",Qo[Qo.COMPUTE=1]="COMPUTE",Qo[Qo.TRANSFER=2]="TRANSFER",(Jo=Zo||(Zo={}))[Jo.NONE=0]="NONE",Jo[Jo.COLOR=1]="COLOR",Jo[Jo.DEPTH=2]="DEPTH",Jo[Jo.STENCIL=4]="STENCIL",Jo[Jo.DEPTH_STENCIL=6]="DEPTH_STENCIL",Jo[Jo.ALL=7]="ALL";var el,tl,il=function e(){y(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1},nl=function e(){y(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new il};(tl=el||(el={}))[tl.NONE=0]="NONE",tl[tl.UNORM=1]="UNORM",tl[tl.SNORM=2]="SNORM",tl[tl.UINT=3]="UINT",tl[tl.INT=4]="INT",tl[tl.UFLOAT=5]="UFLOAT",tl[tl.FLOAT=6]="FLOAT";var rl=[{name:"UNKNOWN",size:0,count:0,type:el.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:el.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:el.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:el.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:el.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:el.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:el.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:el.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:el.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:el.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:el.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:el.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:el.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:el.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:el.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:el.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:el.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:el.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:el.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:el.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:el.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:el.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:el.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:el.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:el.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}];function al(e,t,i,n){if(!rl[e].isCompressed)return t*i*n*rl[e].size;switch(e){case Zt.GFXFormat.BC1:case Zt.GFXFormat.BC1_ALPHA:case Zt.GFXFormat.BC1_SRGB:case Zt.GFXFormat.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Zt.GFXFormat.BC2:case Zt.GFXFormat.BC2_SRGB:case Zt.GFXFormat.BC3:case Zt.GFXFormat.BC3_SRGB:case Zt.GFXFormat.BC4:case Zt.GFXFormat.BC4_SNORM:case Zt.GFXFormat.BC6H_SF16:case Zt.GFXFormat.BC6H_UF16:case Zt.GFXFormat.BC7:case Zt.GFXFormat.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Zt.GFXFormat.BC5:case Zt.GFXFormat.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case Zt.GFXFormat.ETC_RGB8:case Zt.GFXFormat.ETC2_RGB8:case Zt.GFXFormat.ETC2_SRGB8:case Zt.GFXFormat.ETC2_RGB8_A1:case Zt.GFXFormat.ETC2_SRGB8_A1:case Zt.GFXFormat.EAC_R11:case Zt.GFXFormat.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Zt.GFXFormat.EAC_RG11:case Zt.GFXFormat.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Zt.GFXFormat.PVRTC_RGB2:case Zt.GFXFormat.PVRTC_RGBA2:case Zt.GFXFormat.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case Zt.GFXFormat.PVRTC_RGB4:case Zt.GFXFormat.PVRTC_RGBA4:case Zt.GFXFormat.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function sl(e,t,i,n,r){for(var a=0,s=0;s<r;++s)a+=al(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a}function ol(e){switch(e){case js.BOOL:case js.INT:case js.UINT:case js.FLOAT:return 4;case js.BOOL2:case js.INT2:case js.UINT2:case js.FLOAT2:return 8;case js.BOOL3:case js.INT3:case js.UINT3:case js.FLOAT3:return 12;case js.BOOL4:case js.INT4:case js.UINT4:case js.FLOAT4:case js.MAT2:return 16;case js.MAT2X3:return 24;case js.MAT2X4:return 32;case js.MAT3X2:return 24;case js.MAT3:return 36;case js.MAT3X4:return 48;case js.MAT4X2:case js.MAT4X2:return 32;case js.MAT4:return 64;case js.SAMPLER1D:case js.SAMPLER1D_ARRAY:case js.SAMPLER2D:case js.SAMPLER2D_ARRAY:case js.SAMPLER3D:case js.SAMPLER_CUBE:return 4;default:return 0}}var ll,cl,ul,hl,_l,fl,dl,pl,ml,vl,yl,gl,bl=Object.freeze({GFX_MAX_VERTEX_ATTRIBUTES:16,GFX_MAX_TEXTURE_UNITS:16,GFX_MAX_ATTACHMENTS:4,GFX_MAX_BUFFER_BINDINGS:24,get GFXObjectType(){return Ns},get GFXStatus(){return Gs},GFXObject:$o,get GFXAttributeName(){return Zt.GFXAttributeName},get GFXType(){return js},get GFXFormat(){return Zt.GFXFormat},get GFXBufferUsageBit(){return qs},get GFXMemoryUsageBit(){return Ks},get GFXBufferAccessBit(){return Zs},get GFXPrimitiveMode(){return Zt.GFXPrimitiveMode},get GFXPolygonMode(){return eo},get GFXShadeModel(){return io},get GFXCullMode(){return ro},get GFXComparisonFunc(){return so},get GFXStencilOp(){return lo},get GFXBlendOp(){return uo},get GFXBlendFactor(){return _o},get GFXColorMask(){return po},get GFXFilter(){return vo},get GFXAddress(){return go},get GFXTextureType(){return So},get GFXTextureUsageBit(){return xo},get GFXSampleCount(){return wo},get GFXTextureFlagBit(){return Co},get GFXTextureViewType(){return Ro},get GFXShaderType(){return Mo},get GFXBindingType(){return Io},get GFXCommandBufferType(){return Po},get GFXLoadOp(){return zo},get GFXStoreOp(){return No},get GFXTextureLayout(){return Go},get GFXPipelineBindPoint(){return Ho},get GFXDynamicState(){return Wo},get GFXStencilFace(){return qo},get GFXQueueType(){return Ko},get GFXClearFlag(){return Zo},GFXTextureSubres:il,GFXTextureCopy:function e(){y(this,e),this.srcSubres=new il,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new il,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}},GFXBufferTextureCopy:nl,get GFXFormatType(){return el},GFXFormatInfos:rl,GFXFormatSize:al,GFXFormatSurfaceSize:sl,GFXGetTypeSize:ol});(cl=ll||(ll={}))[cl.RGB565=Zt.GFXFormat.R5G6B5]="RGB565",cl[cl.RGB5A1=Zt.GFXFormat.RGB5A1]="RGB5A1",cl[cl.RGBA4444=Zt.GFXFormat.RGBA4]="RGBA4444",cl[cl.RGB888=Zt.GFXFormat.RGB8]="RGB888",cl[cl.RGBA8888=Zt.GFXFormat.RGBA8]="RGBA8888",cl[cl.RGBA32F=Zt.GFXFormat.RGBA32F]="RGBA32F",cl[cl.A8=Zt.GFXFormat.A8]="A8",cl[cl.I8=Zt.GFXFormat.L8]="I8",cl[cl.AI8=Zt.GFXFormat.LA8]="AI8",cl[cl.RGB_PVRTC_2BPPV1=Zt.GFXFormat.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",cl[cl.RGBA_PVRTC_2BPPV1=Zt.GFXFormat.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",cl[cl.RGB_PVRTC_4BPPV1=Zt.GFXFormat.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",cl[cl.RGBA_PVRTC_4BPPV1=Zt.GFXFormat.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",cl[cl.RGB_ETC1=Zt.GFXFormat.ETC_RGB8]="RGB_ETC1",cl[cl.RGB_ETC2=Zt.GFXFormat.ETC2_RGB8]="RGB_ETC2",cl[cl.RGBA_ETC2=Zt.GFXFormat.ETC2_RGBA8]="RGBA_ETC2",(hl=ul||(ul={}))[hl.REPEAT=go.WRAP]="REPEAT",hl[hl.CLAMP_TO_EDGE=go.CLAMP]="CLAMP_TO_EDGE",hl[hl.MIRRORED_REPEAT=go.MIRROR]="MIRRORED_REPEAT",hl[hl.CLAMP_TO_BORDER=go.BORDER]="CLAMP_TO_BORDER",(fl=_l||(_l={}))[fl.NONE=vo.NONE]="NONE",fl[fl.LINEAR=vo.LINEAR]="LINEAR",fl[fl.NEAREST=vo.POINT]="NEAREST",(pl=dl||(dl={}))[pl.NONE=Zt.GFXFormat.UNKNOWN]="NONE",pl[pl.DEPTH_16=Zt.GFXFormat.D16]="DEPTH_16",pl[pl.DEPTH_24=Zt.GFXFormat.D24]="DEPTH_24",pl[pl.DEPTH_32=Zt.GFXFormat.D32F]="DEPTH_32",pl[pl.DEPTH_16_STENCIL_8=Zt.GFXFormat.D16S8]="DEPTH_16_STENCIL_8",pl[pl.DEPTH_24_STENCIL_8=Zt.GFXFormat.D24S8]="DEPTH_24_STENCIL_8",pl[pl.DEPTH_32_STENCIL_8=Zt.GFXFormat.D32F_S8]="DEPTH_32_STENCIL_8",Rt(Zt.GFXFormat),(vl=ml||(ml={}))[vl.UNKNOWN=0]="UNKNOWN",vl[vl.WEBGL=1]="WEBGL",vl[vl.WEBGL2=2]="WEBGL2",(gl=yl||(yl={}))[gl.COLOR_FLOAT=0]="COLOR_FLOAT",gl[gl.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",gl[gl.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",gl[gl.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",gl[gl.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",gl[gl.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",gl[gl.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",gl[gl.FORMAT_D24S8=7]="FORMAT_D24S8",gl[gl.FORMAT_ETC1=8]="FORMAT_ETC1",gl[gl.FORMAT_ETC2=9]="FORMAT_ETC2",gl[gl.FORMAT_DXT=10]="FORMAT_DXT",gl[gl.FORMAT_PVRTC=11]="FORMAT_PVRTC",gl[gl.FORMAT_ASTC=12]="FORMAT_ASTC",gl[gl.MSAA=13]="MSAA",gl[gl.COUNT=14]="COUNT";var Sl,Tl,xl,El,wl,Al,Cl,kl,Rl=function(){function e(){y(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=ml.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(yl.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=24,this._maxUniformBlockSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=Zt.GFXFormat.UNKNOWN,this._depthStencilFmt=Zt.GFXFormat.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return l(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}}]),e}(),Ol=(Sl=Ca("cc.ImageAsset"),Tl=ka({override:!0}),Sl((Al=wl=function(e){function b(e){var t;return y(this,b),(t=T(this,S(b).call(this)))._nativeData=void 0,t._url=void 0,t._exportedExts=void 0,t._format=ll.RGBA8888,t._width=0,t._height=0,t._url="",t.loaded=!1,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&(t._nativeAsset=e),t}return d(b,es),l(b,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){return"_data"in this._nativeData?this._nativeData._data:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=ll.RGB_ETC1&&this._format<=ll.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}}]),l(b,[{key:"reset",value:function(e){e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._nativeData.format=this._format),this._onDataComplete()}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var t=[],i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.split("@"),l=b.extnames.indexOf(o[0]),c=l<0?s:"".concat(l);o[1]&&(c+="@"+o[1]),t.push(c)}return{fmt:t.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,t){var i="";i="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt);var n=cc.director&&cc.director.root?cc.director.root.device:null,r=i.split("_"),a=Number.MAX_VALUE,s=this._format,o="",l=cc.macro.SUPPORT_TEXTURE_FORMATS,c=r,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}var f=_.split("@"),d=parseInt(f[0],void 0),p=b.extnames[d]||f.join(),m=l.indexOf(p);if(-1!==m&&m<a){var v=f[1]?parseInt(f[1]):this._format;if(!(".pvr"!==p||n&&n.hasFeature(yl.FORMAT_PVRTC)))continue;if(!(v!==ll.RGB_ETC1||n&&n.hasFeature(yl.FORMAT_ETC1)))continue;if(!(v!==ll.RGB_ETC2&&v!==ll.RGBA_ETC2||n&&n.hasFeature(yl.FORMAT_ETC2)))continue;if(".webp"===p&&!cc.sys.capabilities.webp)continue;a=m,o=p,s=v}}o&&(this._setRawAsset(o),this._format=s);var y=t.customEnv,g=y&&y.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),b}(),wl.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],c((El=Al).prototype,"_nativeAsset",[Tl],Object.getOwnPropertyDescriptor(El.prototype,"_nativeAsset"),El.prototype),xl=El))||xl);cc.ImageAsset=Ol,(kl=Cl||(Cl={}))[kl.minFilter=0]="minFilter",kl[kl.magFilter=1]="magFilter",kl[kl.mipFilter=2]="mipFilter",kl[kl.addressU=3]="addressU",kl[kl.addressV=4]="addressV",kl[kl.addressW=5]="addressW",kl[kl.maxAnisotropy=6]="maxAnisotropy",kl[kl.cmpFunc=7]="cmpFunc",kl[kl.minLOD=8]="minLOD",kl[kl.maxLOD=9]="maxLOD",kl[kl.mipLODBias=10]="mipLODBias",kl[kl.borderColor=11]="borderColor",kl[kl.total=15]="total";var Ml=[vo.LINEAR,vo.LINEAR,vo.NONE,go.WRAP,go.WRAP,go.WRAP,16,so.NEVER,0,0,0,0,0,0,0],Ll={};function Il(e){for(var t=0,i=0,n=0;n<Ml.length;n++)switch(t=e[n]||Ml[n],n){case Cl.minFilter:i|=t;break;case Cl.magFilter:i|=t<<2;break;case Cl.mipFilter:i|=t<<4;break;case Cl.addressU:i|=t<<6;break;case Cl.addressV:i|=t<<8;break;case Cl.addressW:i|=t<<10;break;case Cl.maxAnisotropy:i|=t<<12;break;case Cl.cmpFunc:i|=t<<16;break;case Cl.minLOD:i|=t<<20;break;case Cl.maxLOD:i|=t<<24;break;case Cl.mipLODBias:i|=t<<28}return i}var Fl,Pl,Dl,zl,Bl,Nl,Ul,Gl,Vl,Hl,jl,Wl,Xl,ql,Yl=new(function(){function e(){y(this,e),this._cache={}}return l(e,[{key:"getSampler",value:function(e,t){var i=this._cache[t];return i||(0===t&&(t=Il(Ml)),Ll.minFilter=3&t,Ll.magFilter=t>>2&3,Ll.mipFilter=t>>4&3,Ll.addressU=t>>6&3,Ll.addressV=t>>8&3,Ll.addressW=t>>10&3,Ll.maxAnisotropy=t>>12&15,Ll.cmpFunc=t>>16&15,Ll.minLOD=t>>20&15,Ll.maxLOD=t>>24&15,Ll.mipLODBias=t>>28&15,Ll.borderColor={r:0,g:0,b:0,a:0},this._cache[t]=e.createSampler(Ll))}}]),e}()),Kl=new ue("Tex"),Ql=Ca("cc.TextureBase")((ql=Xl=function(e){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return y(this,i),m(e=T(this,S(i).call(this)),"_format",Dl,_(e)),m(e,"_premultiplyAlpha",zl,_(e)),m(e,"_flipY",Bl,_(e)),m(e,"_minFilter",Nl,_(e)),m(e,"_magFilter",Ul,_(e)),m(e,"_mipFilter",Gl,_(e)),m(e,"_wrapS",Vl,_(e)),m(e,"_wrapT",Hl,_(e)),m(e,"_wrapR",jl,_(e)),m(e,"_anisotropy",Wl,_(e)),e._width=0,e._height=0,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._flipY=t,e._id=Kl.getNewId(),e.loaded=!1,e}return d(i,es),l(i,[{key:"isCompressed",get:function(){return this._format>=ll.RGB_ETC1&&this._format<=ll.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Cl.addressU]=e,this._wrapT=t,this._samplerInfo[Cl.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Cl.addressW]=i),this._samplerHash=Il(this._samplerInfo)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Cl.minFilter]=e,this._magFilter=t,this._samplerInfo[Cl.magFilter]=t,this._samplerHash=Il(this._samplerInfo)}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Cl.mipFilter]=e,this._samplerInfo[Cl.maxLOD]=e===_l.NONE?0:1e3,this._samplerHash=Il(this._samplerInfo)}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Cl.maxAnisotropy]=e,this._samplerHash=Il(this._samplerInfo)}},{key:"destroy",value:function(){return p(S(i.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),6<=i.length&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),8<=i.length&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),9<=i.length&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?ll.RGBA8888:e}}]),i}(),Xl.PixelFormat=ll,Xl.WrapMode=ul,Xl.Filter=_l,Dl=c((Pl=ql).prototype,"_format",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ll.RGBA8888}}),zl=c(Pl.prototype,"_premultiplyAlpha",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bl=c(Pl.prototype,"_flipY",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Nl=c(Pl.prototype,"_minFilter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.LINEAR}}),Ul=c(Pl.prototype,"_magFilter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.LINEAR}}),Gl=c(Pl.prototype,"_mipFilter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.NONE}}),Vl=c(Pl.prototype,"_wrapS",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ul.REPEAT}}),Hl=c(Pl.prototype,"_wrapT",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ul.REPEAT}}),jl=c(Pl.prototype,"_wrapR",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ul.REPEAT}}),Wl=c(Pl.prototype,"_anisotropy",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 16}}),Fl=Pl))||Fl;cc.TextureBase=Ql;var Zl={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=Zl;var Jl=0|998*Math.random(),$l=xe(!0),ec=[],tc={WORKING:1,COMPLETE:2,ERROR:3},ic=xe(!0);function nc(t,e){var i="object"===fe(t)?t.url:t,n={queueId:e,id:i,url:i,rawUrl:void 0,urlParam:function(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach(function(e){var t=e.split("=");i[t[0]]=t[1]}),i}}}(i),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:t.uuid&&cc.game._sceneInfos.find(function(e){return e.uuid===t.uuid})};if("object"===fe(t)&&(Fe(n,t),t.skips))for(var r=0;r<t.skips.length;r++){var a=t.skips[r];n.states[a]=tc.COMPLETE}return n.rawUrl=n.url,i&&!n.type&&(n.type=K(i).toLowerCase().substr(1)),n}var rc=[];function ac(e,t,i){if(!e||!t)return!1;var n=!1;if(rc.push(t.id),t.deps){var r,a,s=t.deps;for(r=0;r<s.length;r++){if((a=s[r]).id===e.id){n=!0;break}if(!(0<=rc.indexOf(a.id))&&(a.deps&&ac(e,a,!0))){n=!0;break}}}return i||(rc.length=0),n}var sc=function(e){function u(e,t,i,n){var r;return y(this,u),(r=T(this,S(u).call(this)))._id=++Jl,$l[r._id]=_(r),r._pipeline=e,r._errorUrls=[],r._appending=!1,r._ownerQueue=null,r.onProgress=i,r.onComplete=n,r.map=xe(!0),r.completed={},r.totalCount=0,r.completedCount=0,r._pipeline?r.active=!0:r.active=!1,t&&(0<t.length?r.append(t):r.allComplete()),r}return d(u,rt),l(u,[{key:"append",value:function(e,t){if(!this.active)return[];t&&!t.deps&&(t.deps=[]),this._appending=!0;var i,n,r,a,s=[];for(i=0;i<e.length;++i)if(!(n=e[i]).queueId||this.map[n.id]){if("string"==typeof((a=n).url||a)){var o=(r=nc(n,this._id)).id;this.map[o]||(this.map[o]=r,this.totalCount++,t&&t.deps.push(r),u.registerQueueDep(t||this._id,o),s.push(r))}}else{if(this.map[n.id]=n,t&&t.deps.push(n),n.complete||ac(t,n)){this.totalCount++,this.itemComplete(n.id);continue}var l=this,c=$l[n.queueId];c&&(this.totalCount++,u.registerQueueDep(t||this._id,n.id),c.addListener(n.id,function(e){l.itemComplete(e.id)}))}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(s),s}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=ic[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var t=this.map[e];if(t){var i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),this.completed[e]=t,this.completedCount++,u.finishDep(t.id),this.onProgress){var n=ic[this._id];this.onProgress(n?n.completed.length:this.completedCount,n?n.deps.length:this.totalCount,t)}this.emit(e,t),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=null,this.onComplete=null,this.map=xe(!0),this.completed={},this.totalCount=0,this.completedCount=0,rt.call(this),$l[this._id]=null,ic[this._id]&&(ic[this._id].completed.length=0,ic[this._id].deps.length=0),-1===ec.indexOf(this)&&ec.length<10&&ec.push(this)}}],[{key:"create",value:function(e,t,i,n){void 0===i?"function"==typeof t&&(n=t,t=i=null):void 0===n&&("function"==typeof t?(n=i,i=t,t=null):(n=i,i=null));var r=ec.pop();return r?(r._pipeline=e,r.onProgress=i,r.onComplete=n,($l[r._id]=r)._pipeline&&(r.active=!0),t&&r.append(t)):r=new u(e,t,i,n),r}},{key:"getQueue",value:function(e){return e.queueId?$l[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=$l[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=ic[e._id];t?(t.completed.length=0,t.deps.length=0):t=ic[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=ic[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in ic){var a=ic[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in ic){var i=ic[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),u}();sc.ItemState=new cc.Enum(tc);var oc=sc.prototype;oc.addListener=rt.prototype.on,oc.hasListener=rt.prototype.hasEventListener,oc.removeListener=rt.prototype.off,oc.removeAllListeners=rt.prototype.removeAll;var lc=(cc.LoadingItems=sc).ItemState;function uc(e,i){var n=e.id,t=i.states[n],r=e.next,a=e.pipeline;if(!i.error&&t!==lc.WORKING&&t!==lc.ERROR)if(t===lc.COMPLETE)r?uc(r,i):a.flowOut(i);else{i.states[n]=lc.WORKING;var s=e.handle(i,function(e,t){e?(i.error=e,i.states[n]=lc.ERROR,a.flowOut(i)):(t&&(i.content=t),i.states[n]=lc.COMPLETE,r?uc(r,i):a.flowOut(i))});s instanceof Error?(i.error=s,i.states[n]=lc.ERROR,a.flowOut(i)):void 0!==s&&(null!==s&&(i.content=s),i.states[n]=lc.COMPLETE,r?uc(r,i):a.flowOut(i))}}var hc=function(){function n(e){y(this,n),this._pipes=e,this._cache=xe(!0);for(var t=0;t<e.length;++t){var i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}return l(n,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(0<this._pipes.indexOf(e))cc.warnID(4922);else{var i=null;t<(e.pipeline=this)._pipes.length&&(i=this._pipes[t]);var n=null;0<t&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,0<this._pipes.length&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)uc(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return sc.create(this,function(e,t){i(e,t),t.destroy()}).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,sc.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t&&t.alias&&(t=t.alias),t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),n}();hc.ItemState=lc,cc.Pipeline=hc;var _c=function(){function e(){y(this,e),this.jsons={}}return l(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),fc=function(){function e(){y(this,e),this.contents={}}return l(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}();var dc=/\?/;function pc(e){return cc.game.config.noCache&&"string"==typeof e&&(dc.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function mc(e,t){if(Array.isArray(e))for(var i=0,n=e.length;i<n;i++)mc(e[i],t);else if("object"===fe(e))for(var r in e)mc(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}var vc={Invalid:0,Removed:1,Downloading:2,Loaded:3};function yc(){this.unpacker=null,this.state=vc.Invalid}var gc={},bc={},Sc={};function Tc(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function xc(e){for(var t in bc=e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;bt(gc,r,t,a)}}function Ec(n,r,a){var e=cc.AssetLibrary.getLibUrlNoExt(r)+".json";cc.loader.load({url:e,ignoreMaxConcurrency:!0},function(e,t){if(e)return cc.errorID(4916,n),a(e);var i=Ac(n,r,t);i?a(null,i):a(Tc(n,r))})}function wc(e,t){var i=Sc[e];i||((i=Sc[e]=new yc).state=vc.Downloading),i.state!==vc.Loaded&&(i.unpacker=new _c,i.unpacker.load(bc[e],t),i.state=vc.Loaded)}function Ac(e,t,i){var n=Sc[t];if(n.state!==vc.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;mc(i=i.data,r)}Array.isArray(i)?n.unpacker=new _c:i.type===cc.js._getClassId(cc.Texture2D)&&(n.unpacker=new fc),n.unpacker.load(bc[t],i),n.state=vc.Loaded}return n.unpacker.retrieve(e)}function Cc(e){for(var t=vc.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=Sc[r];if(a){var s=a.state;if(s===vc.Loaded)return r;t<s&&(t=s,i=r)}}return t!==vc.Invalid?i:e[0]}function kc(e,t){var i=e.uuid,n=gc[i];if(n){Array.isArray(n)&&(n=Cc(n));var r=Sc[n];if(r&&r.state===vc.Loaded){var a=r.unpacker.retrieve(i);return a||Tc(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=Sc[n]=new yc).state=vc.Downloading),Ec(i,n,t),null}}var Rc=Object.freeze({initPacks:xc,_loadNewPack:Ec,_doPreload:wc,_doLoadNewPack:Ac,_selectLoadedPack:Cc,load:kc});function Oc(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function Mc(e,t){var i=e.url;i=pc(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}var Lc,Ic,Fc,Pc,Dc,zc,Bc,Nc,Uc={INITIALIZING:0,PLAYING:1,STOPPED:2},Gc=function(){function t(e){y(this,t),this._state=Uc.STOPPED,this._duration=0,this._eventTarget=void 0,this._duration=e.duration,this._eventTarget=e.eventTarget}return l(t,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){}}]),t}(),Vc=(Mr.__audioSupport,function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._audio=e.clip,t._audio.onPlay(function(){t._startTime=performance.now(),t._state=Uc.PLAYING,t._eventTarget.emit("started")}),t._audio.onPause(function(){t._offset+=performance.now()-t._startTime,t._state=Uc.STOPPED,t._oneShoting=!1}),t._audio.onStop(function(){t._state=Uc.STOPPED,t._oneShoting=!1,t._offset=0,t._audio.seek(0)}),t._audio.onEnded(function(){t._offset=0,t._startTime=performance.now(),t._state=Uc.STOPPED,t._eventTarget.emit("ended"),t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1)}),t._audio.onError(function(e){return console.error(e.errMsg)}),t}return d(i,Gc),l(i,[{key:"play",value:function(){this._audio&&this._state!==Uc.PLAYING&&this._audio.play()}},{key:"pause",value:function(){this._audio&&this._state===Uc.PLAYING&&this._audio.pause()}},{key:"stop",value:function(){this._audio&&this._audio.stop()}},{key:"playOneShot",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;this._audio&&(this._offset=0,this._audio.seek(0),this._audio.volume=e,this._oneShoting||(this._audio.loop=!1,this._oneShoting=!0,this._audio.play()))}},{key:"getCurrentTime",value:function(){if(this._state!==Uc.PLAYING)return this._offset/1e3;var e=(performance.now()-this._startTime+this._offset)/1e3;return e>this._duration&&(e-=this._duration,this._startTime+=1e3*this._duration),e}},{key:"setCurrentTime",value:function(e){this._audio&&(this._startTime=performance.now(),this._offset=1e3*e,this._audio.seek(e))}},{key:"getVolume",value:function(){return this._volume}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"destroy",value:function(){this._audio&&this._audio.destroy()}}]),i}()),Hc=kt({WEB_AUDIO:0,DOM_AUDIO:1,WX_GAME_AUDIO:2,UNKNOWN_AUDIO:3}),jc=(Lc=Ca("cc.AudioClip"),Ic=ka({type:Hc}),Lc((Nc=Bc=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_duration",Dc,_(e)),m(e,"_loadMode",zc,_(e)),e._audio=null,e._player=null,e.loaded=!1,e}return d(t,es),l(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),p(S(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_nativeAsset",set:function(e){var t;(this._audio=e)?(t=Vc,this._loadMode=Hc.WX_GAME_AUDIO,this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")):(this._player=null,this._loadMode=Hc.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():Uc.INITIALIZING}}]),t}(),Bc.PlayingState=Uc,Bc.AudioType=Hc,Bc.preventDeferredLoadDependents=!0,Dc=c((Pc=Nc).prototype,"_duration",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zc=c(Pc.prototype,"_loadMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hc.UNKNOWN_AUDIO}}),Fc=Pc))||Fc);cc.AudioClip=jc;var Wc=Mr.__audioSupport,Xc=Wc.format;function qc(e,t){var i=wx.createInnerAudioContext();i.src=e.url,i.onCanplay(function(){return t(null,i)})}function Yc(e,t){if(0===Xc.length)return new Error(V(4927));qc(e,t)}function Kc(){return null}function Qc(e,t,i){var n=e.url,r=document,a=document.createElement("script");function s(){a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(null,n)}function o(){a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(new Error(V(4928,n)))}a.async=i,a.src=pc(n),a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),r.body.appendChild(a)}function Zc(t,i,e,n){void 0===e&&(e=!0);var r=pc(t.url);if(n=n||new Image,e&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&0<n.naturalWidth&&n.src===r)return n;var a=function e(){n.removeEventListener("load",e),n.removeEventListener("error",s),n.id=t.id,i(null,n)},s=function e(){n.removeEventListener("load",a),n.removeEventListener("error",e),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?Zc(t,i,!1,n):i(new Error(V(4930,r)))};n.addEventListener("load",a),n.addEventListener("error",s),n.src=r}var Jc={js:Qc,png:Zc,jpg:Zc,bmp:Zc,jpeg:Zc,gif:Zc,ico:Zc,tiff:Zc,webp:function(e,t,i,n){return cc.sys.capabilities.webp?Zc(e,t,i,n):new Error(V(4929,e.url))},image:Zc,pvr:Oc,pkm:Oc,mp3:Yc,ogg:Yc,wav:Yc,m4a:Yc,txt:Mc,xml:Mc,vsh:Mc,fsh:Mc,atlas:Mc,tmx:Mc,tsx:Mc,json:Mc,ExportJson:Mc,plist:Mc,fnt:Mc,font:Kc,eot:Kc,ttf:Kc,woff:Kc,svg:Kc,ttc:Kc,uuid:function(e,t){var i=kc(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:Oc,bin:Oc,default:Mc},$c="Downloader",eu=function(){function t(e){y(this,t),this.id=$c,this.async=!0,this.pipeline=null,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=Fe(e,Jc)}return l(t,[{key:"addHandlers",value:function(e){Fe(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,i){var n=this,t=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=t.call(this,e,function(e,t){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),i&&i(e,t)})))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=t.call(this,e,i)))return r}else this._loadQueue.push({item:e,callback:i})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():Qc({url:i.path},function(e){e||(i.loaded=!0),t&&t(e)}):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),t}();eu.ID=$c,eu.PackDownloader=Rc,hc.Downloader=eu;var tu=function(){function e(){y(this,e),window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return l(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),iu=new(function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,tu),l(t,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),t}()),nu=function(){function e(){y(this,e),this.assignAssetsBy=void 0,this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=xe(!0)}return l(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,Be(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();nu.pool=void 0,nu.pool=new qe(function(e){e.reset()},10),nu.pool.get=function(){return this._get()||new nu};var ru=function(e,d){var p,m=ft.test(Xe(d)),h=cc.js.isChildClassOf(d,cc._BaseNode)||cc.js.isChildClassOf(d,cc.Component),v=[],y=v,g=[],b=g,S=[],T=[];return function(){var e=d.__values__;p="_$erialized"===e[e.length-1];for(var t=Ft(d),i=Ot+"type",n=Ot+"default",r=Ot+"saveUrlAsAsset",a=Ot+"formerlySerializedAs",s=0;s<e.length;s++){var o=e[s],l=o;t[o+a]&&(l=t[o+a]);var c=t[o+r],u=vi.getDefault(t[o+n]),h=!1;if(m){var _=t[o+i];if(void 0===u&&_)h=_===cc.String||_===cc.Integer||_===cc.Float||_===cc.Boolean;else{var f=fe(u);h="string"===f&&!c||"number"===f||"boolean"===f}}m&&h?(l!==o&&y===v&&(y=v.slice()),v.push(o),y!==v&&y.push(l)):(l!==o&&b===g&&(b=g.slice()),g.push(o),b!==g&&b.push(l),S.push(c),T.push(u instanceof cc.ValueType&&u.constructor))}}(),function(e,t,i,n,r){for(var a=0;a<v.length;++a){var s=i[y[a]];void 0!==s&&(t[v[a]]=s)}for(var o=0;o<g.length;++o){var l=g[o],c=i[b[o]];if(void 0!==c)if(m||"object"===fe(c)){var u=T[o];u?m||c?e._deserializeTypedObject(t[l],c,u):t[l]=null:c?e._deserializeObjField(t,c,l,null,S[o]):t[l]=null}else t[l]=c}h&&i._id&&(t._id=i._id),p&&(t._$erialized=JSON.parse(JSON.stringify(i)),e._deserializePrimitiveObject(t._$erialized,i))}};function au(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=ru(e,n),ge(n,"__deserialize__",a,!0)),a(e,t,i,n,r),t.__postDeserialize&&t.__postDeserialize()}var su=function(){function a(e,t,i,n,r){y(this,a),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return l(a,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++){if(t[n])this.deserializedList[n]=this._deserializeObject(t[n],!1)}this.deserializedData=0<i?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,s=e._idList,o=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<s.length;t++)i=a[t],n=s[t],o[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n,r){var a,s=null,o=null,l=e.__type__;if("TypedArray"===l){var c=e.array;s=new window[e.ctor](c.length);for(var u=0;u<c.length;++u)s[u]=c[u];return s}if(l){var h=function(){(s=new o)._deserialize?s._deserialize(e.content,_):cc.Class._isCCClass(o)?au(_,s,e,o,i):_._deserializeTypedObject(s,e,o)};if(!(o=this._classFinder(l,e,n,r)))return this._classFinder===je&&cc.deserialize.reportMissingClass(l),null;var _=this;h()}else if(Array.isArray(e)){s=new Array(e.length);for(var f=0;f<e.length;f++)"object"===fe(a=e[f])&&a?this._deserializeObjField(s,a,""+f,null,t):s[f]=a}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var s=t.__uuid__;s?this.result.push(e,i,s,r):e[i]=this._deserializeObject(t,r)}else{var o=this.deserializedList[a];o?e[i]=o:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"object"!==fe(n)?"__type__"!==i&&(e[i]=n):n?this._deserializeObjField(e,n,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=Ot+"default",r=Ft(i),a=i.__props__||Object.keys(e),s=0;s<a.length;s++){var o=a[s],l=t[o];void 0!==l&&t.hasOwnProperty(o)||(l=vi.getDefault(r[o+n])),"object"!==fe(l)?e[o]=l:l?this._deserializeObjField(e,l,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}}}]),a}();function ou(e,t,i){var n=(i=i||{}).classFinder||je,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||nu.pool.get();var l=su.pool.get(t,!1,n,a,s);cc.game._isCloning=!0;var c=l.deserialize(e);return cc.game._isCloning=!1,su.pool.put(l),r&&t.assignAssetsBy(Editor.serialize.asAsset),o&&nu.pool.put(t),c}function lu(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function cu(t,i){var e,n;if("string"==typeof t.content)try{if((e=JSON.parse(t.content)).keys&&e.data){var r=e.keys;mc(e=e.data,r)}}catch(e){return new Error(V(4923,t.id,e.stack))}else{if("object"!==fe(t.content))return new Error(V(4924));e=t.content}if(null==e)return new Error(V(4923,t.id));var a=lu(e);n=a?cc._MissingScript.safeFindClass:function(e){var t=je(e);return t||(cc.warnID(4903,e),Object)};var s,o=cc.deserialize.Details.pool.get();try{s=cc.deserialize(e,o,{classFinder:n,target:t.existingAsset,customEnv:t})}catch(e){return cc.deserialize.Details.pool.put(o),console.error(e),new Error("Failed to load asset ".concat(t.id,", exception occurs during deserialization: ").concat(e.stack,"."))}s._uuid=t.uuid;var l=function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(n=e.asyncLoadAssets),n}(s,t,a),c=function(e,t,i,n){var r,a,s,o=i.uuidList,l=i.uuidObjList,c=i.uuidPropList,u=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<o.length;a++){s=o[a];var _=l[a],f=c[a],d=cc.AssetLibrary._getAssetInfoInRuntime(s);if(d.raw){var p=d.url;_[f]=p,h.push(p)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:_,_ownerProp:f,_stillUseUrl:u[a]})}else{for(r=new Array(o.length),a=0;a<o.length;a++)s=o[a],r[a]={type:"uuid",uuid:s,_owner:l[a],_ownerProp:c[a],_stillUseUrl:u[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(t,s,o,l);cc.deserialize.Details.pool.put(o);var u=function(t,e){if(!t&&e.onLoaded)try{e.onLoaded()}catch(e){t=e}i(t,e)};if(0===c.length)return u(null,s);!function(e,t,f,d,p){t.content=f;var m=t.dependKeys;e.flowInDeps(t,d,function(e,t){var i,n=t.map;for(var r in n)(i=n[r]).uuid&&i.content&&(i.content._uuid=i.uuid);for(var a=0;a<d.length;a++){var s=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==f._uuid&&m.indexOf(e.id)<0&&m.push(e.id)},o=d[a],l=o.uuid,c=o.url;if(o._owner,o._ownerProp,i=n[c]){var u=o;if(i.complete||i.content)i.error?cc._throw(i.error):s.call(u,i);else{var h=sc.getQueue(i),_=h._callbackTable[l];_?_.unshift(s,u):h.addListener(l,s,u)}}}p(e,f)})}(this.pipeline,t,s,c,u)}su.pool=void 0,su.pool=new qe(function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),su.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new su(e,t,i,n,r)},ou.Details=nu,ou.reportMissingClass=function(e){cc.warnID(5302,e)},cc.deserialize=ou,cu.isSceneObj=lu;var uu=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,hu=/^[!,.:;'}\]%\?>、‘“》？。，！]/,_u=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,fu=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,du=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function pu(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function mu(e){var t=e.charCodeAt(0);return 9<=t&&t<=13||32===t||133===t||160===t||5760===t||8192<=t&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function vu(e,t){var i=e.measureText(t);return i&&i.width||0}function yu(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;i<t&&1<a.length;){for(var s=a.length*(i/t)|0,o=a.substr(s),l=t-n(o),c=o,u=0,h=0;i<l&&h++<10;)s*=i/l,s|=0,l=t-n(o=a.substr(s));for(h=0;l<=i&&h++<10;){if(o){var _=uu.exec(o);u=_?_[0].length:1,c=o}s+=u,l=t-n(o=a.substr(s))}0===(s-=u)&&(s=1,c=c.substr(1));var f=a.substr(0,s),d=void 0;hu.test(c||o)&&(0===(s-=(d=_u.exec(f))?d[0].length:0)&&(s=1),c=a.substr(s),f=a.substr(0,s)),du.test(c)&&(d=fu.exec(f))&&f!==d[0]&&(s-=d[0].length,c=a.substr(s),f=a.substr(0,s)),0===r.length?r.push(f):0<(f=f.trim()).length&&r.push(f),t=n(a=c||o)}return 0===r.length?r.push(a):0<(a=a.trim()).length&&r.push(a),r}var gu=null,bu="BES bswy:->@",Su={},Tu=-1,xu=[],Eu=6e4;function wu(){for(var e=!0,t=Date.now(),i=xu.length-1;0<=i;i--){var n=xu[i],r=n.fontFamilyName;if(t-n.startTime>Eu)cc.warnID(4933,r),n.callback(null,r),xu.splice(i,1);else{var a=n.refWidth;gu.font="40px "+r,a!==vu(gu,bu)?(xu.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(Tu),Tu=-1)}function Au(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(Su[n])return n;if(!gu){var r=document.createElement("canvas");r.width=100,r.height=100,gu=r.getContext("2d")}var a="40px "+n;gu.font=a;var s=vu(gu,bu),o=document.createElement("style");o.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",o.textContent=l+"}",document.body.appendChild(o);var c=document.createElement("div"),u=c.style;u.fontFamily=n,c.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(c);var h={fontFamilyName:n,refWidth:s,callback:t,startTime:Date.now()};xu.push(h),Su[n]=o,-1===Tu&&(Tu=setInterval(wu,100))}function Cu(t){if("string"!=typeof t.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(t.content)}catch(e){return new Error("JSON Loader: Parse json ["+t.id+"] failed : "+e)}}function ku(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;var i=e.rawUrl,n=e.imageAsset||new Ol;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function Ru(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function Ou(e){return e.load?e.load(e.content):e.content}function Mu(e,t){return e[t]<<8|e[t+1]}var Lu={png:ku,jpg:ku,bmp:ku,jpeg:ku,gif:ku,ico:ku,tiff:ku,webp:ku,image:ku,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176!==i[11])return new Error("Invalid magic number in PVR header");var s=i[0],o=i[1],l=i[2];return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:o}},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=Mu(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=Mu(i,12),a=Mu(i,14);return Mu(i,8),Mu(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:Ru,ogg:Ru,wav:Ru,m4a:Ru,json:Cu,ExportJson:Cu,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=iu.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:cu,prefab:cu,fire:cu,scene:cu,binary:Ou,bin:Ou,font:Au,eot:Au,ttf:Au,woff:Au,svg:Au,ttc:Au,default:function(){return null}},Iu=function(){function t(e){y(this,t),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=Fe(e,Lu)}return l(t,[{key:"addHandlers",value:function(e){this.extMap=Fe(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),t}();Iu.ID="Loader",hc.Loader=Iu;var Fu="AssetLoader",Pu=[],Du=function(){function t(e){y(this,t),this.id=Fu,this.async=!0,this.pipeline=null}return l(t,[{key:"handle",value:function(a,s){var o=a.uuid;if(!o)return a.content||null;cc.AssetLibrary.queryAssetInfo(o,function(e,t,i){if(e)s(e);else if(a.url=a.rawUrl=t,a.isRawAsset=i){var n=K(t).toLowerCase();if(!n)return void s(new Error(V(4931,o)));n=n.substr(1);var r=sc.getQueue(a);Pu[0]={queueId:a.queueId,id:t,url:t,type:n,error:null,alias:a,complete:!0},r.append(Pu),a.type=n,s(null,a.content)}else a.type="uuid",s(null,a.content)})}}]),t}();function zu(e,t){this.uuid=e,this.type=t}Du.ID=Fu,hc.AssetLoader=Du;var Bu=function(){function e(){y(this,e),this._pathToUuid=xe(!0)}return l(e,[{key:"getUuid",value:function(e,t){e=cc.url.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(ze(r.type,t))return r.uuid}}else{if(!t||ze(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=cc.url.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n,r,a=this._pathToUuid,s=[];for(var o in a)if(o.startsWith(e)&&(r=e,!((n=o).length>r.length)||47===n.charCodeAt(r.length))||!e){var l=a[o];if(Array.isArray(l))for(var c=0;c<l.length;c++){var u=l[c];(!t||ze(u.type,t))&&(s.push(u.uuid),i&&i.push(o))}else(!t||ze(l.type,t))&&(s.push(l.uuid),i&&i.push(o))}return s}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-cc.path.extname(e).length));var r=new zu(t,i);bt(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],s=i[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(s.uuid===e)return t.path=a,t.type=s.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=xe(!0)}}]),e}();function Nu(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,Nu(a,t))}}}function Uu(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,Nu(i,t))}}function Gu(e,t){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=e[i[n]];if("object"===fe(r)&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var s=r[a];s instanceof cc.RawAsset&&Uu(s,t)}else if(r.constructor&&r.constructor!==Object)r instanceof cc.RawAsset&&Uu(r,t);else for(var o=Object.getOwnPropertyNames(r),l=0;l<o.length;l++){var c=r[o[l]];c instanceof cc.RawAsset&&Uu(c,t)}}}function Vu(e,t){for(var i=0;i<e._components.length;i++)Gu(e._components[i],t);for(var n=0;n<e._children.length;n++)Vu(e._children[n],t)}function Hu(e){var t={};return Nu(e,t),Object.keys(t)}var ju=Object.create(null);function Wu(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}ju.assets=new Bu,ju.internal=new Bu;var Xu={url:null,raw:!1};function qu(e){var t,i,n;if("object"===fe(e)){if((i=e).url)return i;t=e.uuid}else i={},t=e;return n=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,Xu),i.url=n?Xu.url:t,Xu.url&&"uuid"===i.type&&Xu.raw?(i.type=null,i.isRawAsset=!0):n||(i.isRawAsset=!0),i}var Yu=[],Ku=[],Qu=function(e){function r(){var e;y(this,r);var t=new Du,i=new eu,n=new Iu;return(e=T(this,S(r).call(this,[t,i,n]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=Wu,e.assetLoader=t,e.md5Pipe=null,e.downloader=i,e.loader=n,e.onProgress=null,e._assetTables=ju,e._autoReleaseSetting=xe(!0),e}return d(r,hc),l(r,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var r,a=this,s=!1;e instanceof Array||(e=e?(s=!0,[e]):[]);for(var i=Yu.length=0;i<e.length;++i){var o=e[i];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(r=qu(o)).url||r.uuid){var l=this._cache[r.url];Yu.push(l||r)}}var c=sc.create(this,t,function(t,i){xt(function(){if(n){if(s){var e=r.url;n.call(a,i.getError(e),i.getContent(e))}else n.call(a,t,i);n=null}i.destroy()})});sc.initQueueDeps(c),c.append(Yu),Yu.length=0}},{key:"flowInDeps",value:function(i,e,n){for(var t=Ku.length=0;t<e.length;++t){var r=qu(e[t]);if(r.url||r.uuid){var a=this._cache[r.url];a?Ku.push(a):Ku.push(r)}}var s=sc.create(this,i?function(e,t,i){s._ownerQueue&&s._ownerQueue.onProgress&&s._ownerQueue._childOnProgress(i)}:null,function(e,t){n(e,t),i&&i.deps&&(i.deps.length=0),t.destroy()});if(i){var o=sc.getQueue(i);s._ownerQueue=o._ownerQueue||o}var l=s.append(Ku,i);return Ku.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=this,o=s._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},n,function(e,t){t&&s.setAutoReleaseRecursively(o,!1),r&&r(e,t)}):s._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,l){if(5!==arguments.length&&(l=n,n=i,i="assets"),ju[i]){var r=this._parseLoadResArgs(t,n,l);t=r.type,n=r.onProgress,l=r.onComplete;var a=[],s=ju[i].getUuidArray(e,t,a);this._loadResUuids(s,n,function(e,t,i){for(var n=t.length,r=0;r<n;++r)if(t[r]instanceof cc.SpriteAtlas){var a=t[r].getSpriteFrames();for(var s in a){var o=a[s];t.push(o),i&&i.push("".concat(i[r],"/").concat(o.name))}}l&&l(e,t,i)},a)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var s=[],o=0;o<e.length;o++){var l=e[o],c=this._getResUuid(l,t,i,!0);if(!c)return void this._urlNotFound(l,t,r);s.push(c)}this._loadResUuids(s,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=Hu(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cc.Asset){var a=e.nativeUrl;a&&this.release(a),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(ju[i=i||"assets"])for(var n=ju[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=hc.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=Hu(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r=ju[i=i||"assets"];if(!e||!r)return null;var a=e.indexOf("?");-1!==a&&(e=e.substr(0,a));var s=r.getUuid(e,t);if(!s){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(s=r.getUuid(e,t))&&!n&&cc.warnID(4901,e,o))}return s}},{key:"_getReferenceKey",value:function(e){var t;return"object"===fe(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,null,null,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,Xu),this._cache[Xu.url]?Xu.url:t):(cc.warnID(4800,e),t)}},{key:"_urlNotFound",value:function(t,i,n){xt(function(){t=cc.url.normalize(t);var e="".concat(i?Ee(i):"Asset",' in "resources/').concat(t,'" does not exist.');n&&n(new Error(e),[])})}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=ze(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,l,c){if(0<e.length){var u=this,h=e.map(function(e){return{type:"uuid",uuid:e}});this.load(h,t,function(e,t){if(l){for(var i=[],n=c&&[],r=0;r<h.length;++r){var a=h[r].uuid,s=u._getReferenceKey(a),o=t.getContent(s);o&&(u.setAutoReleaseRecursively(a,!1),i.push(o),n&&n.push(c[r]))}c?l(e,i,n):l(e,i)}})}else l&&xt(function(){c?l(null,[],[]):l(null,[])})}}]),r}(),Zu=cc.loader=new Qu;function Ju(i,n){i.loaded?n&&n():i.nativeUrl?Zu.load({url:i.nativeUrl,skips:i.isCompressed?void 0:["Loader"]},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}var $u,eh,th,ih,nh,rh,ah=Object.freeze({loadImage:function(e,i,n){G(!!e,3103);var r=Zu.getRes(e);return r?r.loaded?i&&i.call(n,null,r):r.once("load",function(){i&&i.call(n,null,r)},n):(r=new Ol,Zu.load({url:e,imageAsset:r},function(e,t){if(e)return i&&i.call(n,e||new Error("Unknown error")),r;i&&i.call(n,null,t)})),r},cacheImage:function(e,t){if(e&&t){var i=new Ol(t),n={id:e,url:e,error:null,content:i,complete:!1};return Zu.flowOut(n),i}},postLoadImage:Ju}),sh=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}],oh=Ca("cc.SimpleTexture")($u=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._mipmapLevel=1,t._gfxTexture=null,t._gfxTextureView=null,t}return d(a,Ql),l(a,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),p(S(a.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=t)){var n=this._getGFXDevice();if(n){var r=sh[0];r.texExtent.width=this._gfxTexture.width>>t,r.texExtent.height=this._gfxTexture.height>>t,r.texSubres.baseMipLevel=t,r.texSubres.baseArrayLayer=i,e instanceof ArrayBuffer?n.copyBuffersToTexture([e],this._gfxTexture,sh):n.copyTexImagesToTexture([e],this._gfxTexture,sh)}}}},{key:"_assignImage",value:function(i,n,r){var a=this,e=function(){var e,t=i.data;t&&(e=ArrayBuffer.isView(t)?t.buffer:t,a.uploadData(e,n,r),a._checkTextureLoaded())};if(i.loaded)e();else{if(i.once("load",function(){e()}),!this.isCompressed){var t=cc.builtinResMgr.get("black-texture").image;this.uploadData(t.data,n,r)}Ju(i)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=this._getGfxTextureCreateInfo({usage:xo.SAMPLED|xo.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:this._mipFilter!==_l.NONE?Co.GEN_MIPMAP:Co.NONE});if(t){var i=e.createTexture(t),n=this._getGfxTextureViewCreateInfo({texture:i,format:this._getGFXFormat()});if(n){var r=e.createTextureView(n);r?(this._gfxTexture=i,this._gfxTextureView=r):i.destroy()}else i.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}}]),a}())||$u;cc.SimpleTexture=oh;var lh,ch,uh,hh,_h,fh=(eh=Ca("cc.Texture2D"),th=ka([Ol]),eh((rh=c((nh=function(e){function a(){var e;return y(this,a),m(e=T(this,S(a).call(this,!0)),"_mipmaps",rh,_(e)),e}return d(a,oh),l(a,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;if(this._mipmaps=e,0<this._mipmaps.length){var t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),l(a,[{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:ll.RGBA8888,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:i,mipmapLevel:n})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],p(S(a.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(t){return{base:p(S(a.prototype),"_serialize",this).call(this,t),mipmaps:this._mipmaps.map(function(e){return t?Editor.Utils.UuidUtils.compressUuid(e._uuid,!0):e._uuid})}}},{key:"_deserialize",value:function(e,t){var i=e;p(S(a.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]=new Ol;var r=i.mipmaps[n];t.result.push(this._mipmaps,"".concat(n),r)}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:So.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:Ro.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,t=0;t<this._mipmaps.length;++t){if(!this._mipmaps[t].loaded){e=!1;break}}e&&p(S(a.prototype),"_textureReady",this).call(this)}}]),a}()).prototype,"_mipmaps",[th],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ih=nh))||ih);cc.Texture2D=fh,Rt(dl);var dh,ph=Ca("cc.RenderTexture")((_h=hh=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._window=null,m(t,"_depthStencilFormat",uh,_(t)),t}return d(a,Ql),l(a,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,this._format=e.colorFormat,this._depthStencilFormat=e.depthStencilFormat,this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),p(S(a.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow(),this.loaded=!0,this.emit("load")}},{key:"_serialize",value:function(e){return{base:p(S(a.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,t){p(S(a.prototype),"_deserialize",this).call(this,e.base,t);var i=e;this.name=i.name||"",this._width=i.width,this._height=i.height,this._format=i.colorFormat,this._depthStencilFormat=i.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),a}(),hh.DepthStencilFormat=dl,uh=c((ch=_h).prototype,"_depthStencilFormat",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dl.NONE}}),c(ch.prototype,"width",[ka],Object.getOwnPropertyDescriptor(ch.prototype,"width"),ch.prototype),c(ch.prototype,"height",[ka],Object.getOwnPropertyDescriptor(ch.prototype,"height"),ch.prototype),c(ch.prototype,"depthStencilFormat",[ka],Object.getOwnPropertyDescriptor(ch.prototype,"depthStencilFormat"),ch.prototype),lh=ch))||lh;cc.RenderTexture=ph;var mh,vh,yh,gh=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],bh=Ca("cc.SpriteFrame")(dh=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e._image=null,e.uvSliced=[],e._rect=new er,e._offset=new Ui,e._originalSize=new Kn,e._rotated=!1,e._capInsets=[0,0,0,0],e._original=null,e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e._texture=new fh,e._texture.on("load",e._textureLoaded,_(e)),e}return d(t,es),l(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]=e,this._calculateSlicedUV()}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]=e,this._calculateSlicedUV()}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]=e,this._calculateSlicedUV()}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]=e,this._calculateSlicedUV()}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.set(e),this._calculateUV()}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.set(e),this._calculateUV()}},{key:"_imageSource",set:function(e){this._image=e,this._texture.image=this._image,this._calculateUV()}},{key:"texture",get:function(){return this._texture},set:function(e){e?(this.reset({texture:e},!0),this._texture instanceof ph&&this.onLoaded()):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"original",get:function(){return this._original}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}}]),l(t,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this._rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this._rect.set(e)}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this._originalSize.set(e)}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this._offset.set(e)}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"reset",value:function(e){var t=!1;1<arguments.length&&void 0!==arguments[1]&&arguments[1]&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],t=!(this._rotated=!1)),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._texture.off("load"),this._texture=e.texture,this.checkRect(this._texture),this._texture.on("load",this._textureLoaded,this)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),this._rotated=!!e.isRotate,this._flipUv=!!e.isFlipUv,this._texture instanceof ph&&(this._flipUv=!0),t=!0),t&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(cc.errorID(3400,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this._texture.width,i=this._texture.height,n=this._capInsets[0],r=this._capInsets[2],a=e.width-n-r,s=this._capInsets[1],o=this._capInsets[3],l=e.height-s-o,c=this.uvSliced;if(c.length=0,this._rotated){gh[0].u=(e.x+e.height)/t,gh[1].u=(e.x+o+l)/t,gh[2].u=(e.x+o)/t,gh[3].u=e.x/t,gh[3].v=(e.y+e.width)/i,gh[2].v=(e.y+n+a)/i,gh[1].v=(e.y+n)/i,gh[0].v=e.y/i;for(var u=0;u<4;++u)for(var h=gh[u],_=0;_<4;++_){var f=gh[3-_];c.push({u:h.u,v:f.v})}}else{gh[0].u=e.x/t,gh[1].u=(e.x+n)/t,gh[2].u=(e.x+n+a)/t,gh[3].u=(e.x+e.width)/t,gh[3].v=e.y/i,gh[2].v=(e.y+s)/i,gh[1].v=(e.y+s+l)/i,gh[0].v=(e.y+e.height)/i;for(var d=0;d<4;++d)for(var p=gh[d],m=0;m<4;++m){var v=gh[m];c.push({u:v.u,v:p.v})}}}},{key:"_setDynamicAtlasFrame",value:function(e){!e||this._texture instanceof ph||(this._original={spriteframe:this,x:this._rect.x,y:this._rect.y},this._rect.x=e._rect.x,this._rect.y=e._rect.y,this._image=e._image,this._texture.image=this._image)}},{key:"_resetDynamicAtlasFrame",value:function(){!this._original||this._texture instanceof ph||(this._rect.x=this._original.x,this._rect.y=this._original.y,this._image=this._original.spriteframe._image,this._texture.image=this._image,this._original=null)}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this._texture.width,n=this._texture.height;if(this._rotated){var r=0===i?0:e.x/i,a=0===i?0:(e.x+e.height)/i,s=0===n?0:(e.y+e.width)/n,o=0===n?0:e.y/n;this._flipUv?(t[0]=r,t[1]=o,t[2]=r,t[3]=s,t[4]=a,t[5]=o,t[6]=a,t[7]=s):(t[0]=a,t[1]=s,t[2]=a,t[3]=o,t[4]=r,t[5]=s,t[6]=r,t[7]=o)}else{var l=0===i?0:e.x/i,c=0===i?0:(e.x+e.width)/i,u=0===n?0:(e.y+e.height)/n,h=0===n?0:e.y/n;this._flipUv?(t[0]=l,t[1]=h,t[2]=c,t[3]=h,t[4]=l,t[5]=u,t[6]=c,t[7]=u):(t[0]=l,t[1]=u,t[2]=c,t[3]=u,t[4]=l,t[5]=h,t[6]=c,t[7]=h)}for(var _="",f=0;f<t.length;f++)_+=t[f];this.uvHash=Bs(_,666);var d=this.vertices;if(d){d.nu.length=0;for(var p=d.nv.length=0;p<d.u.length;p++)d.nu[p]=d.u[p]/i,d.nv[p]=d.v[p]/n}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,n=this._offset,r=this._originalSize,a=this._uuid;return a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{image:this._image?e?Editor.Utils.UuidUtils.compressUuid(this._image._uuid,!0):this._image._uuid:void 0,name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:n,originalSize:r,rotated:this._rotated,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&this.setRect(new er(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&this.setOffset(new Ui(r.x,r.y));var a=i.originalSize;i.originalSize&&this.setOriginalSize(new Kn(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var s=i.capInsets;s&&(this._capInsets[0]=s[0],this._capInsets[1]=s[1],this._capInsets[2]=s[2],this._capInsets[3]=s[3]),t.result.push(this,"_imageSource",i.image),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new er(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||this._originalSize.width>e.width||this._originalSize.height>e.height)&&(t.originalSize=new Kn(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}}]),t}())||dh;cc.SpriteFrame=bh;var Sh,Th,xh,Eh=Ca("cc.SpriteAtlas")((yh=c((vh=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"spriteFrames",yh,_(t)),t}return d(a,es),l(a,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(0<e.length){var t=this.spriteFrames[e[0]];return t&&t._image}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],s=a?a._uuid:"";s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(s,!0)),t.push(r),t.push(s)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=xe();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),a}()).prototype,"spriteFrames",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xe()}}),mh=vh))||mh;cc.SpriteAtlas=Eh;var wh,Ah,Ch,kh=Ca("cc.TextAsset")((xh=c((Th=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"text",xh,_(t)),t}return d(a,es),l(a,[{key:"toString",value:function(){return this.text}}]),a}()).prototype,"text",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Sh=Th))||Sh;cc.TextAsset=kh;var Rh=Ca("cc.JsonAsset")((Ch=c((Ah=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"json",Ch,_(t)),t}return d(a,es),a}()).prototype,"json",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wh=Ah))||wh;cc.JsonAsset=Rh;var Oh="0123456789abcdef".split(""),Mh=["","","",""],Lh=Mh.concat(Mh,"-",Mh,"-",Mh,"-",Mh,"-",Mh,Mh,Mh),Ih=Lh.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function Fh(e){var t=e.split("@")[0];if(22!==t.length)return e;Lh[0]=e[0],Lh[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=vt[e.charCodeAt(i)],a=vt[e.charCodeAt(i+1)];Lh[Ih[n++]]=Oh[r>>2],Lh[Ih[n++]]=Oh[(3&r)<<2|a>>4],Lh[Ih[n++]]=Oh[15&a]}return e.replace(t,Lh.join(""))}var Ph=Object.freeze({default:Fh}),Dh="MD5Pipe",zh=/(\.[^.\n\\/]*)$/,Bh=/([^/\\]*)\.[^\.]*$/;var Nh=function(){function n(e,t,i){y(this,n),this.id=Dh,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}return l(n,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(Bh);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=cc.path.dirname(e),a=cc.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var s=!1;e=e.replace(zh,function(e,t){return s=!0,"."+n+t}),s||(e=e+"."+n)}}return e}}]),n}();Nh.ID=Dh,hc.MD5Pipe=Nh;var Uh,Gh,Vh=(Uh=Ph)&&Uh.default||Uh,Hh=(function(e){var n="SubPackPipe",r=/([^/\\]*)\.[^\.]*$/;var a=Object.create(null),t=function(e){for(var t in this.id=n,this.async=!1,this.pipeline=null,e){var i=e[t];i.uuids&&i.uuids.forEach(function(e){var t=Vh(e);a[t]=i.path})}};t.ID=n,t.prototype.handle=function(e){return e.url=this.transformURL(e.url),null},t.prototype.transformURL=function(e){var t=function(e){var t=e.match(r);return t?t[1]:""}(e);if(t){var i=a[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e},hc.SubPackPipe=e.exports=t}(Gh={exports:{}},Gh.exports),Gh.exports),jh="",Wh="",Xh=xe(!0);function qh(e,t){this.url=e,this.type=t}var Yh,Kh={_uuidToAsset:{},loadAsset:function(n,r,e){if("string"!=typeof n)return xt(r,new Error("[AssetLibrary] uuid must be string"),null);var t={uuid:n,type:"uuid"};e&&e.existingAsset&&(t.existingAsset=e.existingAsset),cc.loader.load(t,function(e,t){if(e||!t)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error"));else if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(n);t.scene.dependAssets=Hu(i)}r&&r(e,t)})},getLibUrlNoExt:function(e,t){return e=(e=Fh(e)).split("@").map(function(e){return encodeURIComponent(e)}).join("@"),(t?Wh+"assets/":jh)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){0},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=Xh[e];return i&&!ze(i.type,cc.Asset)?(t.url=Wh+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in Xh},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,r){var a=""+((new Date).getTime()+Math.random()),t={uuid:a,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(t,function(e,t){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(a);t.scene.dependAssets=Hu(i)}if(function(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}(t)){var n=cc.loader._getReferenceKey(a);cc.loader.removeItem(n)}}t._uuid="",r&&r(e,t)})},getAssetByUuid:function(e){return Kh._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),jh=cc.path.stripSep(t)+"/",Wh=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=xe(!0),a=i.import;for(n=0;n<a.length;n+=2)r[Fh(a[n])]=a[n+1];var s=xe(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2)s[Fh(a[n])]=a[n+1];var o=new Nh(r,s,jh);cc.loader.insertPipeAfter(cc.loader.assetLoader,o),cc.loader.md5Pipe=o}if(e.subpackages){var l=new Hh(e.subpackages);cc.loader.insertPipeAfter(cc.loader.assetLoader,l),cc.loader.subPackPipe=l}var c=Zu._assetTables;for(var u in c)c[u].reset();var h=e.rawAssets;if(h)for(var _ in h){var f=h[_];for(var d in f){var p=f[d],m=p[0],v=p[1],y=je(v);if(y){Xh[d]=new qh(_+"/"+m,y);var g=1===p[2];c[_]||(c[_]=new Bu),c[_].add(m,d,y,!g)}else cc.error("Cannot get",v)}}e.packedAssets&&xc(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||Wh+"assets")}};cc.AssetLibrary=Kh;var Qh,Zh,Jh,$h,e_,t_=Ca("cc.Font")(Yh=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,es),t}())||Yh;cc.Font=t_;var i_,n_,r_,a_,s_,o_,l_,c_,u_=(Qh=Ca("cc.TTFFont"),Zh=ka({type:cc.String,override:!0}),Qh((e_=c(($h=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_fontFamily",e_,_(t)),t}return d(a,t_),l(a,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),a}()).prototype,"_fontFamily",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c($h.prototype,"_nativeAsset",[Zh],Object.getOwnPropertyDescriptor($h.prototype,"_nativeAsset"),$h.prototype),Jh=$h))||Jh);cc.TTFFont=u_;var h_,__=(i_=Ca("cc.BitmapFont"),n_=ka({type:bh}),i_((s_=c((a_=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"fntDataStr",s_,_(t)),m(t,"spriteFrame",o_,_(t)),m(t,"fontSize",l_,_(t)),m(t,"fntConfig",c_,_(t)),t}return d(a,t_),a}()).prototype,"fntDataStr",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),o_=c(a_.prototype,"spriteFrame",[n_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l_=c(a_.prototype,"fontSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),c_=c(a_.prototype,"fntConfig",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r_=a_))||r_);cc.BitmapFont=__;var f_,d_,p_,m_,v_,y_,g_,b_,S_,T_,x_,E_,w_,A_=Ca("cc.LabelAtlas")(h_=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,__),t}())||h_;cc.LabelAtlas=A_;var C_=new ue("Comp"),k_=(Ha.Flags.IsOnEnableCalled,Ha.Flags.IsOnLoadCalled),R_=(f_=Ca("cc.Component"),d_=ka({visible:!1}),p_=ka({visible:!1}),m_=ka({displayName:"Script",type:Os,tooltip:void 0}),v_=ka({visible:!1}),y_=ka({visible:!1}),g_=ka({visible:!1}),f_((w_=E_=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"node",T_,_(t)),m(t,"_enabled",x_,_(t)),t._sceneGetter=null,t._id=C_.getNewId(),t._eventTargets=[],t}return d(a,Ha),l(a,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){p(S(a.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var n=e[t];n&&n.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=cc.instantiate._clone(this,this)),e.node=null,e}},{key:"schedule",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:cc.macro.REPEAT_FOREVER,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;cc.assertID(e,1619),cc.assertID(0<=t,1620),t=t||0,i=isNaN(i)?cc.macro.REPEAT_FOREVER:i,n=n||0;var r=cc.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,i,n,a)}},{key:"scheduleOnce",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=Ee(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&k_}}]),a}(),E_.system=null,c((S_=w_).prototype,"name",[d_],Object.getOwnPropertyDescriptor(S_.prototype,"name"),S_.prototype),c(S_.prototype,"uuid",[p_],Object.getOwnPropertyDescriptor(S_.prototype,"uuid"),S_.prototype),c(S_.prototype,"__scriptAsset",[m_],Object.getOwnPropertyDescriptor(S_.prototype,"__scriptAsset"),S_.prototype),c(S_.prototype,"enabled",[v_],Object.getOwnPropertyDescriptor(S_.prototype,"enabled"),S_.prototype),c(S_.prototype,"enabledInHierarchy",[y_],Object.getOwnPropertyDescriptor(S_.prototype,"enabledInHierarchy"),S_.prototype),T_=c(S_.prototype,"node",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x_=c(S_.prototype,"_enabled",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),b_=S_))||b_),O_=R_.prototype;O_.update=null,O_.lateUpdate=null,O_.__preload=null,O_.onLoad=null,O_.start=null,O_.onEnable=null,O_.onDisable=null,O_.onDestroy=null,O_.onFocusInEditor=null,O_.onLostFocusInEditor=null,O_.resetInEditor=null,O_._getLocalBounds=null,O_.onRestore=null,R_._requireComponent=null,R_._executionOrder=0,ge(R_,"_registerEditorProps",function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)}),cc.Component=R_;var M_,L_,I_,F_,P_,D_,z_,B_,N_;Ha.Flags.Destroying;var U_=Ha.Flags.Destroying,G_=Ha.Flags.DontDestroy,V_=Ha.Flags.Deactivating,H_=new ue("Node");function j_(e){return e?"string"==typeof e?We(e):e:(cc.errorID(3804),null)}var W_=Ca("cc._BaseNode")((N_=B_=function(e){function c(e){var t;return y(this,c),m(t=T(this,S(c).call(this,e)),"_parent",I_,_(t)),m(t,"_children",F_,_(t)),m(t,"_active",P_,_(t)),m(t,"_components",D_,_(t)),m(t,"_prefab",z_,_(t)),t._scene=null,t._activeInHierarchy=!1,t._id=H_.getNewId(),t.__eventTargets=[],t._siblingIndex=0,t._name=void 0!==e?e:"New Node",cc.director&&cc.director._scheduler&&cc.director._scheduler.enableForTarget(_(t)),t}return d(c,Ha),l(c,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&G_)},set:function(e){e?this._objFlags|=G_:this._objFlags&=~G_}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var s=0;s<n.length;++s){var o=n[s];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var s=r[a];s.constructor===t&&i.push(s)}else for(var o=0;o<r.length;++o){var l=r[o];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var n=e[i],r=c._findComponent(n,t);if(r)return r;if(0<n._children.length&&(r=c._findChildComponent(n._children,t)))return r}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var n=0;n<e.length;++n){var r=e[n];c._findComponents(r,t,i),0<r._children.length&&c._findChildComponents(r._children,t,i)}}}]),l(c,[{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var i=this._parent;if(this._parent=e,this._siblingIndex=0,this._onSetParent(i,t),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(Zt.SystemEventType.CHILD_ADDED,this)),i&&!(i._objFlags&U_)){var n=i._children.indexOf(this);0,i._children.splice(n,1),i._updateSiblingIndex(),i.emit&&i.emit(Zt.SystemEventType.CHILD_REMOVED,this)}this._onHierarchyChanged(i)}}},{key:"attr",value:function(e){Fe(this,e)}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var n=e.split("/"),r=this,t=function(e){var t=n[e];if(0===t.length)return"continue";var i=r.children.find(function(e){return e.name===t});if(!i)return{v:null};r=i},i=0;i<n.length;++i){var a=t(i);switch(a){case"continue":continue;default:if("object"===fe(a))return a.v}}return r}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&V_)cc.errorID(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"walk",value:function(e,t){var i=1,n=null,r=null,a=0,s=c._stacks[c._stackId];s||(s=[],c._stacks.push(s)),c._stackId++,s.length=0,s[0]=this;for(var o=null,l=!1;i;)if(r=s[--i])if(!l&&e?e(r):l&&t&&t(r),s[i]=null,l){if(l=!1,n)if(n[++a])s[i]=n[a],i++;else if(o&&(s[i]=o,i++,l=!0,o._parent?(a=(n=o._parent._children).indexOf(o),o=o._parent):n=o=null,a<0))break}else 0<r._children.length?(n=(o=r)._children,a=0,s[i]=n[a],i++):(s[i]=r,i++,l=!0);s.length=0,c._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){-1<this._children.indexOf(e)&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;0<=t;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=j_(e);return t?c._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=j_(e),i=[];return t&&c._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=j_(e);return t?c._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=j_(e),i=[];return t&&(c._findComponents(this,t,i),c._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=We(e)))return cc.errorID(3807,e),cc._RF.peek()&&cc.errorID(3808,e),null}else{if(!e)return cc.errorID(3804),null;t=e}if("function"!=typeof t)return cc.errorID(3809),null;if(!ze(t,cc.Component))return cc.errorID(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return(n.node=this)._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof R_?e:this.getComponent(e))&&t.destroy()}else cc.errorID(3813)}},{key:"destroy",value:function(){return!!p(S(c.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&U_)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&cc.errorID(3815)}}else cc.errorID(3814)}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(function(e){c._setScene(e)}))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=cc.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=U_;var e=this._parent,t=null!==e&&0!=(e._objFlags&U_);for(var i=this._children,n=0;n<i.length;++n)i[n]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();for(var s=this.__eventTargets,o=0;o<s.length;++o){var l=s[o];l&&l.targetOff(this)}if(s.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){var c=e._children.indexOf(this);e._children.splice(c,1),this._siblingIndex=0,e.emit&&e.emit("child-removed",this)}return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),c}(),B_.idGenerator=H_,B_._stacks=[[]],B_._stackId=0,c((L_=N_).prototype,"_persistNode",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"_persistNode"),L_.prototype),c(L_.prototype,"name",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"name"),L_.prototype),c(L_.prototype,"uuid",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"uuid"),L_.prototype),c(L_.prototype,"children",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"children"),L_.prototype),c(L_.prototype,"active",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"active"),L_.prototype),c(L_.prototype,"activeInHierarchy",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"activeInHierarchy"),L_.prototype),c(L_.prototype,"parent",[ka],Object.getOwnPropertyDescriptor(L_.prototype,"parent"),L_.prototype),I_=c(L_.prototype,"_parent",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F_=c(L_.prototype,"_children",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),P_=c(L_.prototype,"_active",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),D_=c(L_.prototype,"_components",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z_=c(L_.prototype,"_prefab",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M_=L_))||M_;cc._BaseNode=W_;var X_,q_,Y_,K_,Q_,Z_,J_,$_,ef,tf,nf,rf,af,sf,of,lf=function(){function t(){y(this,t)}return l(t,null,[{key:"addLayer",value:function(e){if(!(31<t._nextAvailable))return t[e]=1<<t._nextAvailable++;console.warn("maximum layers reached.")}},{key:"makeInclusiveMask",value:function(e){var t=0,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t|=a}return t}},{key:"makeExclusiveMask",value:function(e){return~t.makeInclusiveMask(e)}},{key:"check",value:function(e,t){return(e&t)===e}}]),t}();lf.Default=1<<30,lf.Always=1<<29,lf.IgnoreRaycast=1<<20,lf.Gizmos=1<<21,lf.Editor=1<<22,lf.UI=1<<23,lf.All=lf.makeExclusiveMask([lf.Gizmos,lf.Editor]),lf.RaycastMask=lf.makeExclusiveMask([lf.Gizmos,lf.Editor,lf.IgnoreRaycast]),lf._nextAvailable=8,cc.Layers=lf,(q_=X_||(X_={}))[q_.LOCAL=0]="LOCAL",q_[q_.WORLD=1]="WORLD",(K_=Y_||(Y_={}))[K_.NONE=0]="NONE",K_[K_.POSITION=1]="POSITION",K_[K_.ROTATION=2]="ROTATION",K_[K_.SCALE=4]="SCALE",K_[K_.RS=K_.ROTATION|K_.SCALE]="RS",K_[K_.TRS=K_.POSITION|K_.ROTATION|K_.SCALE]="TRS",K_[K_.TRS_MASK=~K_.TRS]="TRS_MASK";var cf,uf,hf,_f,ff,df,pf,mf=new Xi,vf=new vn,yf=new vn,gf=new Array(10),bf=new vn,Sf=new un,Tf=new un,xf=(Q_=Ca("cc.Node"),Z_=ka({type:Xi}),Q_((of=sf=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._pos=new Xi,t._rot=new vn,t._scale=new Xi(1,1,1),t._mat=new Nn,m(t,"_lpos",ef,_(t)),m(t,"_lrot",tf,_(t)),m(t,"_lscale",nf,_(t)),m(t,"_layer",rf,_(t)),m(t,"_euler",af,_(t)),t._dirtyFlags=Y_.NONE,t._hasChangedFlags=Y_.NONE,t._eulerDirty=!1,t._eventProcessor=new cc.NodeEventProcessor(_(t)),t._eventMask=0,t._uiTransfromComp=null,t._uiComp=null,t}return d(a,W_),l(a,[{key:"setParent",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];t&&this.updateWorldTransform(),p(S(a.prototype),"setParent",this).call(this,e,t)}},{key:"_onSetParent",value:function(e,t){if(p(S(a.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent,n=this._lpos;i?(i.updateWorldTransform(),Xi.subtract(n,this._pos,i._pos),Xi.transformQuat(n,n,vn.conjugate(vf,i._rot)),Xi.divide(n,n,i._scale),vn.multiply(this._lrot,vn.conjugate(vf,i._rot),this._rot),Xi.divide(this._lscale,this._scale,i._scale)):(Xi.copy(this._lpos,this._pos),vn.copy(this._lrot,this._rot),Xi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this._onBatchCreated()}},{key:"_onBatchCreated",value:function(){p(S(a.prototype),"_onBatchCreated",this).call(this),this._dirtyFlags=this._hasChangedFlags=Y_.TRS;for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||X_.LOCAL;if(i===X_.LOCAL)Xi.transformQuat(mf,e,this._lrot),this._lpos.x+=mf.x,this._lpos.y+=mf.y,this._lpos.z+=mf.z;else if(i===X_.WORLD)if(this._parent){vn.invert(vf,this.worldRotation),Xi.transformQuat(mf,e,vf);var n=this.worldScale;this._lpos.x+=mf.x/n.x,this._lpos.y+=mf.y/n.y,this._lpos.z+=mf.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Y_.POSITION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.POSITION_PART)}},{key:"rotate",value:function(e,t){var i=t||X_.LOCAL;if(vn.normalize(vf,e),i===X_.LOCAL)vn.multiply(this._lrot,this._lrot,vf);else if(i===X_.WORLD){var n=this.worldRotation;vn.multiply(yf,vf,n),vn.invert(vf,n),vn.multiply(yf,vf,yf),vn.multiply(this._lrot,this._lrot,yf)}this._eulerDirty=!0,this.invalidateChildren(Y_.ROTATION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.ROTATION_PART)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(mf),Xi.subtract(mf,mf,e),Xi.normalize(mf,mf),vn.fromViewUp(vf,mf,t),this.setWorldRotation(vf)}},{key:"resetHasChangedFlags",value:function(){this._hasChangedFlags=Y_.NONE;for(var e=this._children.length,t=0;t<e;++t)this._children[t].resetHasChangedFlags()}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this._hasChangedFlags&e)!==e){this._dirtyFlags|=e,this._hasChangedFlags|=e,e|=Y_.POSITION;for(var t=this._children.length,i=0;i<t;++i)this._children[i].invalidateChildren(e)}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)t=(gf[i++]=t)._parent;for(var n=0;i;)n|=(e=gf[--i])._dirtyFlags,t?(n&Y_.POSITION&&(Xi.transformRTS(e._pos,e._lpos,t._rot,t._pos,t._scale),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Y_.RS&&(Nn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Nn.multiply(e._mat,t._mat,e._mat),n&Y_.ROTATION&&vn.multiply(e._rot,t._rot,e._lrot),un.fromQuat(Sf,vn.conjugate(bf,e._rot)),un.multiplyMat4(Sf,Sf,e._mat),e._scale.x=Sf.m00,e._scale.y=Sf.m04,e._scale.z=Sf.m08)):(n&Y_.POSITION&&(Xi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Y_.RS&&(n&Y_.ROTATION?vn.copy(e._rot,e._lrot):Xi.copy(e._scale,e._lscale),Nn.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=Y_.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?Xi.copy(this._lpos,e):Xi.set(this._lpos,e,t,i),this.invalidateChildren(Y_.POSITION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.POSITION_PART)}},{key:"getPosition",value:function(e){return e?Xi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Xi.copy(new Xi,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?vn.copy(this._lrot,e):vn.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Y_.ROTATION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.ROTATION_PART)}},{key:"setRotationFromEuler",value:function(e,t,i){Xi.set(this._euler,e,t,i),vn.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(Y_.ROTATION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.ROTATION_PART)}},{key:"getRotation",value:function(e){return e?vn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):vn.copy(new vn,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Xi.copy(this._lscale,e):Xi.set(this._lscale,e,t,i),this.invalidateChildren(Y_.SCALE),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.SCALE_PART)}},{key:"getScale",value:function(e){return e?Xi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Xi.copy(new Xi,this._lscale)}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Xi.copy(this._pos,e):Xi.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),Xi.subtract(r,this._pos,n._pos),Xi.transformQuat(r,r,vn.conjugate(vf,n._rot)),Xi.divide(r,r,n._scale)):Xi.copy(r,this._pos),this.invalidateChildren(Y_.POSITION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.POSITION_PART)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Xi.copy(e,this._pos):Xi.copy(new Xi,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?vn.copy(this._rot,e):vn.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),vn.multiply(this._lrot,vn.conjugate(this._lrot,this._parent._rot),this._rot)):vn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Y_.ROTATION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.ROTATION_PART)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){vn.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),vn.multiply(this._lrot,vn.conjugate(this._lrot,this._parent._rot),this._rot)):vn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Y_.ROTATION),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.ROTATION_PART)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?vn.copy(e,this._rot):vn.copy(new vn,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Xi.copy(this._scale,e):Xi.set(this._scale,e,t,i);var n=this._parent;n?(n.updateWorldTransform(),un.fromQuat(Sf,vn.conjugate(bf,n._rot)),un.multiplyMat4(Sf,Sf,n._mat),un.fromScaling(Tf,this._scale),Tf.m08=this._scale.z,un.multiply(Sf,Tf,un.invert(Sf,Sf)),this._lscale.x=Sf.m00,this._lscale.y=Sf.m04,this._lscale.z=Sf.m08):Xi.copy(this._lscale,this._scale),this.invalidateChildren(Y_.SCALE),1&this._eventMask&&this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.SCALE_PART)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Xi.copy(e,this._scale):Xi.copy(new Xi,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e||(e=new Nn),Nn.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e||(e=new Nn),Nn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new Nn),Nn.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return e||(e=new Ui),e.set(this.uiTransfromComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this.uiTransfromComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return e||(e=new Kn),e.set(this.uiTransfromComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this.uiTransfromComp.setContentSize(e,t)}},{key:"on",value:function(e,t,i,n){switch(e){case Zt.SystemEventType.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i,n){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case Zt.SystemEventType.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this._eventProcessor).emit.apply(t,[e].concat(n))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Zt.SystemEventType.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"pauseSystemEvents",value:function(e){kr.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){kr.resumeTarget(this,e)}},{key:"_onPostActivated",value:function(e){e?(kr.resumeTarget(this),this.eventProcessor.reattach()):kr.pauseTarget(this)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),p(S(a.prototype),"_onPreDestroy",this).call(this)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(vn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Nn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Y_.TRS),1&this._eventMask&&(this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.POSITION_PART),this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.ROTATION_PART),this.emit(Zt.SystemEventType.TRANSFORM_CHANGED,Zt.SystemEventType.SCALE_PART))}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return this.getWorldRotation(vf),Xi.transformQuat(new Xi,Xi.UNIT_Z,vf)},set:function(e){var t=e.length();Xi.multiplyScalar(mf,e,-1/t),vn.fromViewUp(vf,mf),this.setWorldRotation(vf)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlags}},{key:"uiTransfromComp",get:function(){return this._uiTransfromComp||(this._uiTransfromComp=this.getComponent("cc.UITransformComponent")),this._uiTransfromComp},set:function(e){this._uiTransfromComp=e}},{key:"width",get:function(){return this.uiTransfromComp.width},set:function(e){this.uiTransfromComp.width=e}},{key:"height",get:function(){return this.uiTransfromComp.height},set:function(e){this.uiTransfromComp.height=e}},{key:"anchorX",get:function(){return this.uiTransfromComp.anchorX},set:function(e){this.uiTransfromComp.anchorX=e}},{key:"anchorY",get:function(){return this.uiTransfromComp.anchorY},set:function(e){this.uiTransfromComp.anchorY=e}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"isNode",value:function(e){return e instanceof a&&(e.constructor===a||!(e instanceof cc.Scene))}}]),a}(),sf.EventType=Zt.SystemEventType,sf.NodeSpace=X_,sf.TransformDirtyBit=Y_,ef=c(($_=of).prototype,"_lpos",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi}}),tf=c($_.prototype,"_lrot",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vn}}),nf=c($_.prototype,"_lscale",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(1,1,1)}}),rf=c($_.prototype,"_layer",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lf.Default}}),af=c($_.prototype,"_euler",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi}}),c($_.prototype,"eulerAngles",[Z_],Object.getOwnPropertyDescriptor($_.prototype,"eulerAngles"),$_.prototype),c($_.prototype,"layer",[ka],Object.getOwnPropertyDescriptor($_.prototype,"layer"),$_.prototype),J_=$_))||J_);cc.Node=xf,(pf=df||(df={}))[pf.right=0]="right",pf[pf.left=1]="left",pf[pf.top=2]="top",pf[pf.bottom=3]="bottom",pf[pf.front=4]="front",pf[pf.back=5]="back";var Ef=Ca("cc.TextureCube")((ff=_f=function(e){function s(){var e;return y(this,s),m(e=T(this,S(s).call(this)),"_mipmaps",hf,_(e)),e}return d(s,oh),l(s,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var n=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){wf(e,function(e,t){n._assignImage(e,i,t)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],n=e.length/6,r=0;r<n;r++){var a=6*r;i.push({front:e[a+df.front].image,back:e[a+df.back].image,left:e[a+df.left].image,right:e[a+df.right].image,top:e[a+df.top].image,bottom:e[a+df.bottom].image})}return(t=t||new s).mipmaps=i,t}}]),l(s,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var n=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;wf(n._mipmaps[i],function(e,t){n._assignImage(e,i,t)})},a=0;a<i;++a)r(a)}},{key:"destroy",value:function(){return this._mipmaps=[],p(S(s.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:p(S(s.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map(function(e){return t?{front:Editor.Utils.UuidUtils.compressUuid(e.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(e.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(e.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(e.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(e.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(e.bottom._uuid,!0)}:{front:e.front._uuid,back:e.back._uuid,left:e.left._uuid,right:e.right._uuid,top:e.top._uuid,bottom:e.bottom._uuid}})}}},{key:"_deserialize",value:function(e,t){var i=e;p(S(s.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]={front:new Ol,back:new Ol,left:new Ol,right:new Ol,top:new Ol,bottom:new Ol};var r=i.mipmaps[n];t.result.push(this._mipmaps[n],"front",r.front),t.result.push(this._mipmaps[n],"back",r.back),t.result.push(this._mipmaps[n],"left",r.left),t.result.push(this._mipmaps[n],"right",r.right),t.result.push(this._mipmaps[n],"top",r.top),t.result.push(this._mipmaps[n],"bottom",r.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:So.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|Co.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:Ro.CUBE,layerCount:6},e)}}]),s}(),_f.FaceIndex=df,hf=c((uf=ff).prototype,"_mipmaps",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cf=uf))||cf;function wf(e,t){t(e.front,df.front),t(e.back,df.back),t(e.left,df.left),t(e.right,df.right),t(e.top,df.top),t(e.bottom,df.bottom)}cc.TextureCube=Ef;var Af,Cf,kf,Rf,Of,Mf,Lf,If,Ff,Pf,Df,zf,Bf,Nf,Uf,Gf,Vf,Hf,jf,Wf,Xf,qf,Yf,Kf,Qf,Zf,Jf,$f,ed,td,id,nd,rd,ad,sd,od,ld,cd,ud,hd,_d,fd=function(){function t(e){y(this,t),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=t.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=e}return l(t,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),l(t,[{key:"update",value:function(){}}]),t}();fd.SUN_ILLUM=65e3,fd.SKY_ILLUM=2e4;var dd=new Xi(0,1,0),pd=new Xi,md=new vn,vd=(Af=Ca("cc.AmbientInfo"),Cf=ka({type:or}),kf=ka({type:Nt}),Rf=ka({type:or}),Af((Lf=c((Mf=function(){function e(){y(this,e),m(this,"_skyColor",Lf,this),m(this,"_skyIllum",If,this),m(this,"_groundAlbedo",Ff,this),this._resource=null}return l(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&or.array(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&or.array(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(51,128,204,1)}}),If=c(Mf.prototype,"_skyIllum",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fd.SKY_ILLUM}}),Ff=c(Mf.prototype,"_groundAlbedo",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(51,51,51,255)}}),c(Mf.prototype,"skyColor",[Cf],Object.getOwnPropertyDescriptor(Mf.prototype,"skyColor"),Mf.prototype),c(Mf.prototype,"skyIllum",[kf],Object.getOwnPropertyDescriptor(Mf.prototype,"skyIllum"),Mf.prototype),c(Mf.prototype,"groundAlbedo",[Rf],Object.getOwnPropertyDescriptor(Mf.prototype,"groundAlbedo"),Mf.prototype),Of=Mf))||Of);cc.AmbientInfo=vd;var yd=(Pf=Ca("cc.SkyboxInfo"),Df=ka(Ef),zf=ka({type:Ut}),Bf=ka({type:Ut}),Nf=ka({type:Ef}),Uf=ka({type:Ut}),Pf((Hf=c((Vf=function(){function e(){y(this,e),m(this,"_envmap",Hf,this),m(this,"_isRGBE",jf,this),m(this,"_enabled",Wf,this),m(this,"_useIBL",Xf,this),this._resource=null}return l(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[Df],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jf=c(Vf.prototype,"_isRGBE",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wf=c(Vf.prototype,"_enabled",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xf=c(Vf.prototype,"_useIBL",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(Vf.prototype,"enabled",[zf],Object.getOwnPropertyDescriptor(Vf.prototype,"enabled"),Vf.prototype),c(Vf.prototype,"useIBL",[Bf],Object.getOwnPropertyDescriptor(Vf.prototype,"useIBL"),Vf.prototype),c(Vf.prototype,"envmap",[Nf],Object.getOwnPropertyDescriptor(Vf.prototype,"envmap"),Vf.prototype),c(Vf.prototype,"isRGBE",[Uf],Object.getOwnPropertyDescriptor(Vf.prototype,"isRGBE"),Vf.prototype),Gf=Vf))||Gf);cc.SkyboxInfo=yd;var gd=(qf=Ca("cc.PlanarShadowInfo"),Yf=ka({type:Ut}),Kf=ka({type:Xi}),Qf=ka({type:Nt}),Zf=ka({type:or}),qf((ed=c(($f=function(){function e(){y(this,e),m(this,"_enabled",ed,this),m(this,"_normal",td,this),m(this,"_distance",id,this),m(this,"_shadowColor",nd,this),this._resource=null}return l(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(md),this.normal=Xi.transformQuat(pd,dd,md),e.getWorldPosition(pd),this.distance=Xi.dot(this._normal,pd)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Xi.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),td=c($f.prototype,"_normal",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(0,1,0)}}),id=c($f.prototype,"_distance",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nd=c($f.prototype,"_shadowColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(0,0,0,76)}}),c($f.prototype,"enabled",[Yf],Object.getOwnPropertyDescriptor($f.prototype,"enabled"),$f.prototype),c($f.prototype,"normal",[Kf],Object.getOwnPropertyDescriptor($f.prototype,"normal"),$f.prototype),c($f.prototype,"distance",[Qf],Object.getOwnPropertyDescriptor($f.prototype,"distance"),$f.prototype),c($f.prototype,"shadowColor",[Zf],Object.getOwnPropertyDescriptor($f.prototype,"shadowColor"),$f.prototype),Jf=$f))||Jf);cc.PlanarShadowInfo=gd;var bd,Sd,Td,xd,Ed=(rd=Ca("cc.SceneGlobals"),ad=ka({type:vd}),sd=ka({type:yd}),od=ka({type:gd}),rd((ud=c((cd=function(){function e(){y(this,e),m(this,"ambient",ud,this),m(this,"skybox",hd,this),m(this,"planarShadows",_d,this)}return l(e,[{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[ad],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vd}}),hd=c(cd.prototype,"skybox",[sd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yd}}),_d=c(cd.prototype,"planarShadows",[od],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gd}}),ld=cd))||ld);cc.SceneGlobals=Ed;var wd,Ad=Ca("cc.Scene")((Td=c((Sd=function(e){function i(e){var t;return y(this,i),m(t=T(this,S(i).call(this,e)),"autoReleaseAssets",Td,_(t)),m(t,"_globals",xd,_(t)),t._renderScene=null,t.dependAssets=null,t._inited=void 0,t._prefabSyncedInLiveReload=!1,t._activeInHierarchy=!1,cc.director&&cc.director.root&&(t._renderScene=cc.director.root.createScene({})),t._inited=!cc.game||!cc.game._isCloning,t}return d(i,xf),l(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),l(i,[{key:"destroy",value:function(){var e=p(S(i.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"_onHierarchyChanged",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(W_._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}}]),i}()).prototype,"autoReleaseAssets",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xd=c(Sd.prototype,"_globals",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ed}}),bd=Sd))||bd;function Cd(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.Scene=Ad,cc.find=Cd;var kd=Ha.Flags.HideInHierarchy,Rd=Ca("cc.PrivateNode")(wd=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._objFlags|=kd,t}return d(i,xf),i}())||wd;cc.PrivateNode=Rd;var Od=Ye.fastRemoveAt,Md=Ha.Flags.IsStartCalled,Ld=Ha.Flags.IsOnEnableCalled,Id=(Ha.Flags.IsEditorOnEnableCalled,function(e){e.start(),e._objFlags|=Md}),Fd=function(e,t){e.update(t)},Pd=function(e,t){e.lateUpdate(t)};function Dd(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,s=a>>>1;r<=a;s=r+a>>>1){var o=e[s],l=o.constructor._executionOrder;if(i<l)a=s-1;else if(l<i)r=s+1;else{var c=o._id;if(n<c)a=s-1;else{if(!(c<n))return s;r=s+1}}}return~r}function zd(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}var Bd=function e(t){y(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var i=ae;this._zero=new i([]),this._neg=new i([]),this._pos=new i([]),this._invoke=t};function Nd(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}Bd.stableRemoveInactive=zd;var Ud=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,Bd),l(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){zd(this._zero,e),zd(this._neg,e),zd(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;0<e.array.length&&(e.array.sort(Nd),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;0<t.array.length&&(t.array.sort(Nd),this._invoke(t),t.array.length=0)}}]),t}(),Gd=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,Bd),l(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=Dd(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=Dd(i.array,e);0<=n&&i.removeAt(n)}}},{key:"invoke",value:function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)}}]),t}();function Vd(r,e){if("function"==typeof r)return e?function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];r(n,t)}}:function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];r(i)}};var t="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+r+"}";return e?Function("it","dt",t):Function("it",t)}var Hd=function(){function e(){y(this,e),this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this.scheduleInNextFrame=void 0,this._updating=void 0,this.unscheduleAll()}return l(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new Ud(Vd(Id)),this.updateInvoker=new Gd(Vd(Fd,!0)),this.lateUpdateInvoker=new Gd(Vd(Pd,!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=Ld,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~Ld;var t=this.scheduleInNextFrame.indexOf(e);0<=t?Od(this.scheduleInNextFrame,t):(!e.start||e._objFlags&Md||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&Ld)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&Ld&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,0<this.scheduleInNextFrame.length&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&Md||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var n=e[t];this._scheduleImmediate(n)}e.length=0}}]),e}();Hd.LifeCycleInvoker=Bd,Hd.OneOffInvoker=Ud,Hd.createInvokeImpl=Vd,Hd.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n)}};var jd=Ha.Flags.IsPreloadStarted,Wd=Ha.Flags.IsOnLoadStarted,Xd=Ha.Flags.IsOnLoadCalled,qd=Ha.Flags.Deactivating,Yd=function(e){e.__preload()},Kd=function(e){e.onLoad(),e._objFlags|=Xd},Qd=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,Hd.LifeCycleInvoker),l(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){Hd.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(),Zd=Hd.createInvokeImpl(Yd),Jd=Hd.createInvokeImpl(Kd),$d=new qe(4);$d.get=function(){var e=this._get()||{preload:new Qd(Zd),onLoad:new Hd.OneOffInvoker(Jd),onEnable:new Hd.OneOffInvoker(Hd.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var ep=function(){function e(){y(this,e),this.resetComp=void 0,this._activatingStack=void 0,this.reset()}return l(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=$d.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),$d.put(i)}else{this._deactivateNodeRecursively(e);var n=this._activatingStack,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.preload.cancelInactive(jd),o.onLoad.cancelInactive(Wd),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&jd||(e._objFlags|=jd,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&Wd||(e._objFlags|=Wd,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=Xd):e._objFlags|=Xd),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&Xd&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&qd)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r,a,s,o=e._components.length,l=0;l<o;++l){var c=e._components[l];c instanceof cc.Component?this.activateComp(c,t,i,n):(r=e,s=l,(a=c)?r._removeComponent(a):Ye.removeAt(r._components,s),--l,--o)}e._childArrivalOrder=e._children.length;for(var u=0,h=e._children.length;u<h;++u){var _=e._children[u];_._active&&this._activateNodeRecursively(_,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=qd,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~qd)}for(var r=0,a=e._children.length;r<a;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~qd)}e._onPostActivated(!1),e._objFlags&=~qd}}]),e}();Zt.replaceProperty(W_.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]);var tp,ip,np,rp,ap,sp,op,lp=/^(click)(\s)*=|(param)(\s)*=/,cp=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,up=function(){function e(){y(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return l(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=-1<r?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return-1<r&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var s="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match(cp);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"src"===n?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(l=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(l=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===n?t.imageHeight=parseInt(o):"width"===n?t.imageWidth=parseInt(o):"click"===n&&(t.event=this._processEventHandler(n+"="+o)),t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match(cp);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var c={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),u=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+u):"color"===n?c.color=u:"width"===n&&(c.width=parseInt(u)),t.event&&"param"===n&&(t.event[n]=u.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=c}if((i=e.match(/^(on|u|b|i)(\s)*/))&&0<i[0].length){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(lp),r=!1;n;){var a=n[0],s="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))-1<(t=e.indexOf('"',1))&&(s=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))-1<(t=e.indexOf("'",1))&&(s=e.substring(1,t).trim(),r=!0),t++;else{var o=e.match(/(\S)+/);t=(s=o?o[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=s),n=(e=e.substring(t).trim()).match(lp)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a[0],o=a[1];e=e.replace(s,o)}return e}}]),e}();var hp=Ca("cc.PrefabInfo")((np=c((ip=function e(){y(this,e),m(this,"root",np,this),m(this,"asset",rp,this),m(this,"fileId",ap,this),m(this,"sync",sp,this),m(this,"_synced",op,this)}).prototype,"root",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rp=c(ip.prototype,"asset",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ap=c(ip.prototype,"fileId",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sp=c(ip.prototype,"sync",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),op=c(ip.prototype,"_synced",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),tp=ip))||tp;cc._PrefabInfo=hp;var _p=Ha.Flags.Destroyed,fp=Ha.Flags.PersistentMask,dp=[];function pp(e,t){if(!t){if("object"!==fe(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var i;if(e instanceof Ha){if((e=e)._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=mp(e),cc.game._isCloning=!1,i}function mp(e,t){if(Array.isArray(e))return null;if(Tt(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new e.constructor}else i=Object.create(null);vp(e,i,t);for(var n=0,r=dp.length;n<r;++n)dp[n]._iN$t=null;return dp.length=0,i}function vp(e,t,i){ge(e,"_iN$t",t,!0),dp.push(e);var n=e.constructor;if(cc.Class._isCCClass(n))!function(e,t,i,n){for(var r=e.__values__,a=0;a<r.length;a++){var s=r[a],o=t[s];if("object"===fe(o)&&o){var l=i[s];l instanceof Si&&l.constructor===o.constructor?l.set(o):i[s]=o._iN$t||yp(o,n)}else i[s]=o}}(n,e,t,i);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=e[r];if("object"===fe(a)&&a){if(a===t)continue;t[r]=a._iN$t||yp(a,i)}else t[r]=a}e instanceof Ha&&(t._objFlags&=fp)}function yp(e,t){if(e instanceof Si)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var n=e.length;i=new Array(n),e._iN$t=i;for(var r=0;r<n;++r){var a=e[r];"object"===fe(a)&&a?i[r]=a._iN$t||yp(a,t):i[r]=a}return dp.push(e),i}if(e._objFlags&_p)return null;var s=e.constructor;if(cc.Class._isCCClass(s)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new s}else if(s===Object)i={};else{if(s)return e;i=Object.create(null)}return vp(e,i,t),i}pp._clone=mp,cc.instantiate=pp,cc._decorator=Ua;var gp={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,s=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=s,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=s,this.right.y=r+i/2}};cc.visibleRect=gp;var bp=function(e){function f(){var e,t;y(this,f);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(f)).call.apply(e,[this].concat(n)))).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=p(S(f.prototype),"on",_(t)),t.eventTargetOnce=p(S(f.prototype),"once",_(t)),t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._prepared=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t._lastTime=null,t._frameTime=null,t._sceneInfos=[],t.collisionMatrix=[],t.groupList=[],t}return d(f,st),l(f,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0)}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()})}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,t,i){this._prepared&&e===f.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i)}},{key:"once",value:function(e,t,i){this._prepared&&e===f.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"run",value:function(e,t){this._initConfig(e),this.onStart=t,this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void cc.warnID(3801);if(e.parent!==i)return void cc.warnID(3802)}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0}}else cc.warnID(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(t){if(this._prepared)t&&t();else{var e=this.config.jsList;if(e&&0<e.length){var i=this;cc.loader.load(e,function(e){if(e)throw new Error(JSON.stringify(e));i._prepareFinished(t)})}else this._prepareFinished(t)}}},{key:"_initEngine",value:function(){this._rendererInitialized||(this._initRenderer(),this._initEvents(),this.emit(f.EVENT_ENGINE_INITED))}},{key:"_prepareFinished",value:function(e){this._prepared=!0,this._initEngine(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION),this._setAnimFrame(),this._runMainLoop(),this.emit(f.EVENT_GAME_INITED),e&&e()}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,window.cancelAnimationFrame=this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(function(){e()},i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var t,i=this,e=i.config,n=cc.director,r=!0,a=e.frameRate;H(e.showFPS),t=function(e){if(!i._paused){if(i._intervalId=window.requestAnimationFrame(t),30===a&&(r=!r))return;n.mainLoop(e)}},i._intervalId=window.requestAnimationFrame(t),i._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||2<t||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],R(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode)||0;this.renderType=f.RENDER_TYPE_CANVAS;var i=!1;if(0===t?cc.sys.capabilities.opengl?(this.renderType=f.RENDER_TYPE_WEBGL,i=!0):cc.sys.capabilities.canvas&&(this.renderType=f.RENDER_TYPE_CANVAS,i=!0):1===t&&cc.sys.capabilities.canvas?(this.renderType=f.RENDER_TYPE_CANVAS,i=!0):2===t&&cc.sys.capabilities.opengl&&(this.renderType=f.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(V(3820,t))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e,t,i,n,r,a,s=this.config.id,o=cc.sys.platform===cc.sys.WECHAT_GAME,l=cc.sys.platform===cc.sys.QQ_PLAY;if(o)this.container=n=document.createElement("div"),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,i=cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?window.sharedCanvas||wx.getSharedCanvas():window.canvas,this.canvas=i;else if(l)this.container=cc.container=document.createElement("div"),this.frame=document.documentElement,this.canvas=i=window.canvas;else{var c=s instanceof HTMLElement?s:document.querySelector(s)||document.querySelector("#"+s);"CANVAS"===c.tagName?(e=c.width,t=c.height,this.canvas=i=c,this.container=n=document.createElement("div"),i&&i.parentNode&&i.parentNode.insertBefore(n,i)):("DIV"!==c.tagName&&cc.warnID(3819),e=c.clientWidth,t=c.clientHeight,this.canvas=i=document.createElement("CANVAS"),this.container=n=document.createElement("div"),c.appendChild(n)),n.setAttribute("id","Cocos3dGameContainer"),n.appendChild(i),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,a="gameCanvas",-1<(" "+(r=i).className+" ").indexOf(" "+a+" ")||(r.className&&(r.className+=" "),r.className+=a),i.setAttribute("width",e||"480"),i.setAttribute("height",t||"320"),i.setAttribute("tabindex","99")}if(this._determineRenderType(),this.renderType===f.RENDER_TYPE_WEBGL){var u=!!window.WebGL2RenderingContext,h=navigator.userAgent.toLowerCase();-1!==h.indexOf("safari")&&-1===h.indexOf("chrome")&&(u=!1),u&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var _={canvasElm:i,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(_)&&u&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(_))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=f.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1},this._rendererInitialized=!0}}},{key:"_initEvents",value:function(){var i,e=window;this.config.registerSystemEvent&&Xr.registerSystemEvent(this.canvas),void 0!==document.hidden?i="hidden":void 0!==document.mozHidden?i="mozHidden":void 0!==document.msHidden?i="msHidden":void 0!==document.webkitHidden&&(i="webkitHidden");var t=!1;function n(){t||(t=!0,cc.game.emit(f.EVENT_HIDE))}function r(){t&&(t=!1,cc.game.emit(f.EVENT_SHOW))}if(i)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<a.length;s++)document.addEventListener(a[s],function(e){var t=document[i];(t=t||e.hidden)?n():r()});else e.addEventListener("blur",n),e.addEventListener("focus",r);-1<navigator.userAgent.indexOf("MicroMessenger")&&(e.onfocus=r),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&(wx.onShow&&wx.onShow(r),wx.onHide&&wx.onHide(n)),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",n),e.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r)),this.on(f.EVENT_HIDE,function(){cc.game.pause()}),this.on(f.EVENT_SHOW,function(){cc.game.resume()})}}]),f}();bp.EVENT_HIDE="game_on_hide",bp.EVENT_SHOW="game_on_show",bp.EVENT_GAME_INITED="game_inited",bp.EVENT_ENGINE_INITED="engine_inited",bp.EVENT_RENDERER_INITED="engine_inited",bp.RENDER_TYPE_CANVAS=0,bp.RENDER_TYPE_WEBGL=1,bp.RENDER_TYPE_OPENGL=2,cc.Game=bp,cc.game=new bp;var Sp=0,Tp=new(function(){function e(){y(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return l(e,[{key:"init",value:function(){0}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(cc.sys.os===cc.sys.OS_IOS&&(Tp.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?Tp.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:Tp.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME,Tp.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:Tp.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_WECHAT_GAME:Tp.availWidth=function(){return window.innerWidth},Tp.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var xp=window.sharedCanvas||wx.getSharedCanvas();Tp.availWidth=function(){return xp.width},Tp.availHeight=function(){return xp.height}}var Ep=null,wp=function(e){function n(){var e;y(this,n),(e=T(this,S(n).call(this)))._frameSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._resizeWithBrowserSize=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;_(e);var t=Ap,i=Cp;return e._frameSize=new Kn(0,0),e._designResolutionSize=new Kn(0,0),e._originalDesignResolutionSize=new Kn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new er(0,0,0,0),e._visibleRect=new er(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new kp(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new kp(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new kp(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new kp(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new kp(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),cc.game.once(bp.EVENT_ENGINE_INITED,e.init,_(e)),e}return d(n,st),l(n,[{key:"init",value:function(){Tp.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===bp.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===bp.RENDER_TYPE_CANVAS){var s=cc.game.canvas.getContext("2d");s.imageSmoothingEnabled=e,s.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof kp)t._resolutionPolicy=e;else{var i=kp;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(0<e||0<t){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,s=this._visibleRect,o=r.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY;cc.game._renderContext.viewport(e*r+this._viewportRect.x,t*a+this._viewportRect.y,i*r,n*a)}},{key:"setScissorInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY,s=Math.ceil(e*r+this._viewportRect.x),o=Math.ceil(t*a+this._viewportRect.y),l=Math.ceil(i*r),c=Math.ceil(n*a),u=cc.game._renderContext;if(!Ep){var h=u.getParameter(u.SCISSOR_BOX);Ep=new er(h[0],h[1],h[2],h[3])}Ep.x===s&&Ep.y===o&&Ep.width===l&&Ep.height===c||(Ep.x=s,Ep.y=o,Ep.width=l,Ep.height=c,u.scissor(s,o,l,c))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!Ep){var t=e.getParameter(e.SCISSOR_BOX);Ep=new er(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,n=1/this._scaleY;return new er((Ep.x-this._viewportRect.x)*i,(Ep.y-this._viewportRect.y)*n,Ep.width*i,Ep.height*n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||cc.v2(),a=this._devicePixelRatio*(e-i.left),s=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-s,r.y=a):(r.x=a,r.y=s),r}},{key:"_resizeEvent",value:function(){var e=cc.director.getTotalFrames();if(Sp!==e){var t;Sp=e;var i=(t=this.setDesignResolutionSize?this:cc.view)._frameSize.width,n=t._frameSize.height,r=t._isRotated;if(cc.sys.isMobile){var a=cc.game.container.style,s=a.margin;a.margin="0",a.display="none",t._initFrameSize(),a.margin=s,a.display="block"}else t._initFrameSize();if(t._orientationChanging||t._isRotated!==r||t._frameSize.width!==i||t._frameSize.height!==n){var o=t._originalDesignResolutionSize.width,l=t._originalDesignResolutionSize.height;t._resizing=!0,0<o&&t.setDesignResolutionSize(o,l,t._resolutionPolicy),t._resizing=!1,t._resizeCallback&&t._resizeCallback.call()}}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=Tp.availWidth(cc.game.frame),i=Tp.availHeight(cc.game.frame),n=i<=t;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(function(){cc.view._orientationChanging=!1},1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,s=document.getElementsByName("viewport"),o=s?s[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport,0}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,s=0;s<e.length;s++){var o=e[s];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),n}(),Ap=function(){function e(){y(this,e),this.name="ContainerStrategy"}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();Ap.EQUAL_TO_FRAME=void 0,Ap.PROPORTION_TO_FRAME=void 0;var Cp=function(){function e(){y(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var s=new er(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return cc.game.renderType,bp.RENDER_TYPE_CANVAS,this._result.scale=[r,a],this._result.viewport=s,this._result}}]),e}();Cp.EXACT_FIT=void 0,Cp.SHOW_ALL=void 0,Cp.NO_BORDER=void 0,Cp.FIXED_HEIGHT=void 0,Cp.FIXED_WIDTH=void 0,function(){var e=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="EqualToFrame",t}return d(a,Ap),l(a,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),a}(),t=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="ProportionalToFrame",t}return d(a,Ap),l(a,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,s=cc.game.container.style,o=t.width,l=t.height,c=r/o,u=a/l;n=c<u?(i=r,l*c):(i=o*u,a);var h=Math.round((r-i)/2),_=Math.round((a-n)/2);i=r-2*h,n=a-2*_,this._setupContainer(e,i,n),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=h+"px",s.paddingRight=h+"px",s.paddingTop=_+"px",s.paddingBottom=_+"px"}}]),a}();Ap.EQUAL_TO_FRAME=new e,Ap.PROPORTION_TO_FRAME=new t;var i=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="ExactFit",t}return d(a,Cp),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),a}(),n=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="ShowAll",t}return d(a,Cp),l(a,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,s=t.width,o=t.height,l=r/s,c=a/o,u=0;return n=l<c?(i=r,o*(u=l)):(i=s*(u=c),a),this._buildResult(r,a,i,n,u,u)}}]),a}(),r=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="NoBorder",t}return d(a,Cp),l(a,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,s=cc.game.canvas.height,o=t.width,l=t.height,c=a/o,u=s/l;return r=c<u?(n=o*(i=u),s):(n=a,l*(i=c)),this._buildResult(a,s,n,r,i,i)}}]),a}(),a=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="FixedHeight",t}return d(a,Cp),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}(),s=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="FixedWidth",t}return d(a,Cp),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}();Cp.EXACT_FIT=new i,Cp.SHOW_ALL=new n,Cp.NO_BORDER=new r,Cp.FIXED_HEIGHT=new a,Cp.FIXED_WIDTH=new s}();var kp=function(){function i(e,t){y(this,i),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}return l(i,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof Ap&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof Cp&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),i}();kp.EXACT_FIT=void 0,kp.SHOW_ALL=void 0,kp.NO_BORDER=void 0,kp.FIXED_HEIGHT=void 0,kp.FIXED_WIDTH=void 0,kp.UNKNOWN=void 0,kp.ContainerStrategy=void 0,kp.ContentStrategy=void 0,kp.EXACT_FIT=0,kp.NO_BORDER=1,kp.SHOW_ALL=2,kp.FIXED_HEIGHT=3,kp.FIXED_WIDTH=4,kp.UNKNOWN=5,kp.ContainerStrategy=Ap,kp.ContentStrategy=Cp,cc.ResolutionPolicy=kp;cc.view=new wp;cc.winSize=cc.v2();var Rp={_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(t,i){t=t||document.body;var n=cc.game.canvas||t,r=this;this.requestFullScreen(t,i),n.addEventListener(this._touchEvent,function e(){n.removeEventListener(r._touchEvent,e),r.requestFullScreen(t,i)})}};Rp.init(),cc.screen=Rp;var Op=new ue("Scheduler"),Mp=function e(t,i,n,r){y(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=i,this.paused=n,this.markedForDeletion=r};Mp.get=function(e,t,i,n){var r=Mp._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new Mp(e,t,i,n),r},Mp.put=function(e){Mp._listEntries.length<20&&(e.target=null,Mp._listEntries.push(e))},Mp._listEntries=[];var Lp=function e(t,i,n,r){y(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=i,this.target=n,this.callback=r};Lp.get=function(e,t,i,n){var r=Lp._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new Lp(e,t,i,n),r},Lp.put=function(e){Lp._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,Lp._hashUpdateEntries.push(e))},Lp._hashUpdateEntries=[];var Ip=function e(t,i,n,r,a,s){y(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=i,this.timerIndex=n,this.currentTimer=r,this.currentTimerSalvaged=a,this.paused=s};Ip.get=function(e,t,i,n,r,a){var s=Ip._hashTimerEntries.pop();return s?(s.timers=e,s.target=t,s.timerIndex=i,s.currentTimer=n,s.currentTimerSalvaged=r,s.paused=a):s=new Ip(e,t,i,n,r,a),s},Ip.put=function(e){Ip._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,Ip._hashTimerEntries.push(e))},Ip._hashTimerEntries=[];var Fp=function(){function e(){y(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return l(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=0<this._delay,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();Fp._timers=[],Fp.get=function(){return Fp._timers.pop()||new Fp},Fp.put=function(e){Fp._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,Fp._timers.push(e))};var Pp=function(){function e(){y(this,e),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=xe(!0),this._hashForTimers=xe(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}return l(e,[{key:"enableForTarget",value:function(e){e._id||(e.__instanceId?cc.warnID(1513):e._id=Op.getNewId())}},{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var s=this._arrayForTimers;for(t=0;t<s.length;t++){if(a=s[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var s=e;e=t,t=s}4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var o=t._id;o||(t.__instanceId?(cc.warnID(1513),o=t._id=t.__instanceId):cc.errorID(1510));var l,c,u=this._hashForTimers[o];if(u?u.paused!==a&&cc.warnID(1511):(u=Ip.get(null,t,0,null,null,a),this._arrayForTimers.push(u),this._hashForTimers[o]=u),null==u.timers)u.timers=[];else for(c=0;c<u.timers.length;++c)if((l=u.timers[c])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=Fp.get()).initWithCallback(this,e,t,i,n,r),u.timers.push(l),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e._id;n||(e.__instanceId?(cc.warnID(1513),n=e._id=e.__instanceId):cc.errorID(1510));var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,s=Mp.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,s)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,s,t)),this._hashForUpdates[n]=Lp.get(a,s,e,null)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t._id;i||(t.__instanceId?(cc.warnID(1513),i=t._id=t.__instanceId):cc.errorID(1510));var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,s=r.length;a<s;a++){var o=r[a];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),Fp.put(o),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];if(i){var n=i.timers;-1<n.indexOf(i.currentTimer)&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)Fp.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;0<=t;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t._id;i||(t.__instanceId?(cc.warnID(1513),i=t._id=t.__instanceId):cc.errorID(1510));var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],s=this._arrayForTimers;for(i=0,n=s.length;i<n;i++)(t=s[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){delete this._hashForTimers[e.target._id];for(var t=this._arrayForTimers,i=0,n=t.length;i<n;i++)if(t[i]===e){t.splice(i,1);break}Ip.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target._id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,s=n.length;a<s;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],Mp.put(r),Lp.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),e}();Pp.PRIORITY_SYSTEM=1<<31,Pp.PRIORITY_NON_SYSTEM=Pp.PRIORITY_SYSTEM+1,cc.Scheduler=Pp;var Dp=32,zp=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function Bp(e){return e<1e5?e<100?e<10?0:1:e<1e4?e<1e3?2:3:4:e<1e7?e<1e6?5:6:e<1e9?e<1e8?7:8:9}function Np(e,t){if(e===t)return 0;if(~~e===e&&~~t===t){if(0===e||0===t)return e<t?-1:1;if(e<0||t<0){if(0<=t)return-1;if(0<=e)return 1;e=-e,t=-t}var i=Bp(e),n=Bp(t),r=0;return i<n?(e*=zp[n-i-1],t/=10,r=-1):n<i&&(t*=zp[i-n-1],e/=10,r=1),e===t?r:e<t?-1:1}var a=String(e),s=String(t);return a===s?0:a<s?-1:1}function Up(e,t,i,n){var r=t+1;if(r===i)return 1;if(n(e[r++],e[t])<0){for(;r<i&&n(e[r],e[r-1])<0;)r++;!function(e,t,i){i--;for(;t<i;){var n=e[t];e[t++]=e[i],e[i--]=n}}(e,t,r)}else for(;r<i&&0<=n(e[r],e[r-1]);)r++;return r-t}function Gp(e,t,i,n,r){for(n===t&&n++;n<i;n++){for(var a=e[n],s=t,o=n;s<o;){var l=s+o>>>1;r(a,e[l])<0?o=l:s=1+l}var c=n-s;switch(c){case 3:e[s+3]=e[s+2];case 2:e[s+2]=e[s+1];case 1:e[s+1]=e[s];break;default:for(;0<c;)e[s+c]=e[s+c-1],c--}e[s]=a}}function Vp(e,t,i,n,r,a){var s=0,o=0,l=1;if(0<a(e,t[i+r])){for(o=n-r;l<o&&0<a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}else{for(o=r+1;l<o&&a(e,t[i+r-l])<=0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var c=s;s=r-l,l=r-c}for(s++;s<l;){var u=s+(l-s>>>1);0<a(e,t[i+u])?s=u+1:l=u}return l}function Hp(e,t,i,n,r,a){var s=0,o=0,l=1;if(a(e,t[i+r])<0){for(o=r+1;l<o&&a(e,t[i+r-l])<0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var c=s;s=r-l,l=r-c}else{for(o=n-r;l<o&&0<=a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}for(s++;s<l;){var u=s+(l-s>>>1);a(e,t[i+u])<0?l=u:s=u+1}return l}var jp=function(){function i(e,t){y(this,i),this.array=void 0,this.compare=void 0,this.minGallop=void 0,this.length=void 0,this.tmpStorageLength=void 0,this.tmp=void 0,this.stackLength=void 0,this.runStart=void 0,this.runLength=void 0,this.stackSize=void 0,this.array=e,this.compare=t,this.minGallop=7,this.length=e.length,this.tmpStorageLength=256,this.length<512&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength),this.stackSize=0}return l(i,[{key:"pushRun",value:function(e,t){this.runStart[this.stackSize]=e,this.runLength[this.stackSize]=t,this.stackSize+=1}},{key:"mergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;if(1<=e&&this.runLength[e-1]<=this.runLength[e]+this.runLength[e+1]||2<=e&&this.runLength[e-2]<=this.runLength[e]+this.runLength[e-1])this.runLength[e-1]<this.runLength[e+1]&&e--;else if(this.runLength[e]>this.runLength[e+1])break;this.mergeAt(e)}}},{key:"forceMergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;0<e&&this.runLength[e-1]<this.runLength[e+1]&&e--,this.mergeAt(e)}}},{key:"mergeAt",value:function(e){var t=this.compare,i=this.array,n=this.runStart[e],r=this.runLength[e],a=this.runStart[e+1],s=this.runLength[e+1];this.runLength[e]=r+s,e===this.stackSize-3&&(this.runStart[e+1]=this.runStart[e+2],this.runLength[e+1]=this.runLength[e+2]),this.stackSize--;var o=Hp(i[a],i,n,r,0,t);n+=o,0!==(r-=o)&&0!==(s=Vp(i[n+r-1],i,a,s,s-1,t))&&(r<=s?this.mergeLow(n,r,a,s):this.mergeHigh(n,r,a,s))}},{key:"mergeLow",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<t;o++)s[o]=a[e+o];var l=0,c=i,u=e;if(a[u++]=a[c++],0!=--n)if(1!==t){for(var h=this.minGallop;;){var _=0,f=0,d=!1;do{if(r(a[c],s[l])<0){if(a[u++]=a[c++],f++,(_=0)==--n){d=!0;break}}else if(a[u++]=s[l++],_++,f=0,1==--t){d=!0;break}}while((_|f)<h);if(d)break;do{if(0!==(_=Hp(a[c],s,l,t,0,r))){for(o=0;o<_;o++)a[u+o]=s[l+o];if(u+=_,l+=_,(t-=_)<=1){d=!0;break}}if(a[u++]=a[c++],0==--n){d=!0;break}if(0!==(f=Vp(s[l],a,c,n,0,r))){for(o=0;o<f;o++)a[u+o]=a[c+o];if(u+=f,c+=f,0===(n-=f)){d=!0;break}}if(a[u++]=s[l++],1==--t){d=!0;break}h--}while(7<=_||7<=f);if(d)break;h<0&&(h=0),h+=2}if((this.minGallop=h)<1&&(this.minGallop=1),1===t){for(o=0;o<n;o++)a[u+o]=a[c+o];a[u+n]=s[l]}else{if(0===t)throw new Error("mergeLow preconditions were not respected");for(o=0;o<t;o++)a[u+o]=s[l+o]}}else{for(o=0;o<n;o++)a[u+o]=a[c+o];a[u+n]=s[l]}else for(o=0;o<t;o++)a[u+o]=s[l+o]}},{key:"mergeHigh",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<n;o++)s[o]=a[i+o];var l=e+t-1,c=n-1,u=i+n-1,h=0,_=0;if(a[u--]=a[l--],0!=--t)if(1!==n){for(var f=this.minGallop;;){var d=0,p=0,m=!1;do{if(r(s[c],a[l])<0){if(a[u--]=a[l--],d++,(p=0)==--t){m=!0;break}}else if(a[u--]=s[c--],p++,d=0,1==--n){m=!0;break}}while((d|p)<f);if(m)break;do{if(0!==(d=t-Hp(s[c],a,e,t,t-1,r))){for(t-=d,_=(u-=d)+1,h=(l-=d)+1,o=d-1;0<=o;o--)a[_+o]=a[h+o];if(0===t){m=!0;break}}if(a[u--]=s[c--],1==--n){m=!0;break}if(0!==(p=n-Vp(a[l],s,0,n,n-1,r))){for(n-=p,_=(u-=p)+1,h=(c-=p)+1,o=0;o<p;o++)a[_+o]=s[h+o];if(n<=1){m=!0;break}}if(a[u--]=a[l--],0==--t){m=!0;break}f--}while(7<=d||7<=p);if(m)break;f<0&&(f=0),f+=2}if((this.minGallop=f)<1&&(this.minGallop=1),1===n){for(_=(u-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[_+o]=a[h+o];a[u]=s[c]}else{if(0===n)throw new Error("mergeHigh preconditions were not respected");for(h=u-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}else{for(_=(u-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[_+o]=a[h+o];a[u]=s[c]}else for(h=u-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}]),i}();function Wp(e,t,i,n){if(!Array.isArray(e))throw new TypeError("Can only sort arrays");void 0===t&&(t=0),void 0===i&&(i=e.length),void 0===n&&(n=Np);var r=i-t;if(!(r<2)){var a=0;if(r<Dp)Gp(e,t,i,t+(a=Up(e,t,i,n)),n);else{var s=new jp(e,n),o=function(e){for(var t=0;Dp<=e;)t|=1&e,e>>=1;return e+t}(r);do{if((a=Up(e,t,i,n))<o){var l=r;o<l&&(l=o),Gp(e,t,t+l,t+a,n),a=l}s.pushRun(t,a),s.mergeRuns(),r-=a,t+=a}while(0!==r);s.forceMergeRuns()}}}var Xp,qp,Yp,Kp,Qp=function(){function n(e,t){y(this,n),this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"sort",value:function(e){return Wp(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),n}(),Zp=function e(){y(this,e),this.material=null,this.vertexCount=0,this.indiceCount=0},Jp=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._datas=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}return d(a,Zp),l(a,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)em.free(t[n]);for(n=i;n<e;n++)t[n]=em.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return tm.add()}},{key:"remove",value:function(e){var t=tm.data.indexOf(e);-1!==t&&(tm.data[t].clear(),tm.removeAt(t))}}]),a}(),$p=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),t.iData=new Uint16Array(1536),t.vertexStart=0,t.indiceStart=0,t.byteStart=0,t.byteCount=0,t._formatByte=9*Float32Array.BYTES_PER_ELEMENT,t}return d(a,Zp),l(a,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(65535<e+this.vertexCount)return!1;var r=this.vData.byteLength,a=this.iData.length,s=this.vData.length,o=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)r=4*(s*=2),a=o*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(s),this.vData.set(l,0);var c=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(c,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),a}(),em=new Ze(function(){return{x:0,y:0,z:0,u:0,v:0,color:or.WHITE.clone()}},128),tm=new Qp(function(){return new Jp},32);(qp=Xp||(Xp={}))[qp.DEFAULT=100]="DEFAULT",(Kp=Yp||(Yp={}))[Kp.MIN=0]="MIN",Kp[Kp.MAX=255]="MAX",Kp[Kp.DEFAULT=128]="DEFAULT";var im,nm;(nm=im||(im={}))[nm.UBO_GLOBAL=23]="UBO_GLOBAL",nm[nm.UBO_SHADOW=22]="UBO_SHADOW",nm[nm.UBO_LOCAL=21]="UBO_LOCAL",nm[nm.UBO_FORWARD_LIGHTS=20]="UBO_FORWARD_LIGHTS",nm[nm.UBO_SKINNING=19]="UBO_SKINNING",nm[nm.UBO_SKINNING_TEXTURE=18]="UBO_SKINNING_TEXTURE",nm[nm.UBO_UI=17]="UBO_UI",nm[nm.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",nm[nm.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",nm[nm.CUSTUM_UBO_BINDING_END_POINT=17]="CUSTUM_UBO_BINDING_END_POINT",nm[nm.CUSTOM_SAMPLER_BINDING_START_POINT=30]="CUSTOM_SAMPLER_BINDING_START_POINT";var rm=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};rm.SIZE=4*(rm.COUNT=(rm.AMBIENT_GROUND_OFFSET=(rm.AMBIENT_SKY_OFFSET=(rm.MAIN_LIT_COLOR_OFFSET=(rm.MAIN_LIT_DIR_OFFSET=(rm.EXPOSURE_OFFSET=(rm.CAMERA_POS_OFFSET=(rm.MAT_VIEW_PROJ_INV_OFFSET=(rm.MAT_VIEW_PROJ_OFFSET=(rm.MAT_PROJ_INV_OFFSET=(rm.MAT_PROJ_OFFSET=(rm.MAT_VIEW_INV_OFFSET=(rm.MAT_VIEW_OFFSET=(rm.NATIVE_SIZE_OFFSET=(rm.SCREEN_SCALE_OFFSET=(rm.SCREEN_SIZE_OFFSET=(rm.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),rm.BLOCK={binding:im.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:js.FLOAT4,count:1},{name:"cc_screenSize",type:js.FLOAT4,count:1},{name:"cc_screenScale",type:js.FLOAT4,count:1},{name:"cc_nativeSize",type:js.FLOAT4,count:1},{name:"cc_matView",type:js.MAT4,count:1},{name:"cc_matViewInv",type:js.MAT4,count:1},{name:"cc_matProj",type:js.MAT4,count:1},{name:"cc_matProjInv",type:js.MAT4,count:1},{name:"cc_matViewProj",type:js.MAT4,count:1},{name:"cc_matViewProjInv",type:js.MAT4,count:1},{name:"cc_cameraPos",type:js.FLOAT4,count:1},{name:"cc_exposure",type:js.FLOAT4,count:1},{name:"cc_mainLitDir",type:js.FLOAT4,count:1},{name:"cc_mainLitColor",type:js.FLOAT4,count:1},{name:"cc_ambientSky",type:js.FLOAT4,count:1},{name:"cc_ambientGround",type:js.FLOAT4,count:1}]};var am=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};am.SIZE=4*(am.COUNT=(am.SHADOW_COLOR_OFFSET=(am.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),am.BLOCK={binding:im.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:js.MAT4,count:1},{name:"cc_shadowColor",type:js.FLOAT4,count:1}]};var sm={binding:im.SAMPLER_ENVIRONMENT,name:"cc_environment",type:js.SAMPLER_CUBE,count:1},om=new Map,lm=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};lm.SIZE=4*(lm.COUNT=(lm.MAT_WORLD_IT_OFFSET=(lm.MAT_WORLD_OFFSET=0)+16)+16),lm.BLOCK={binding:im.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:js.MAT4,count:1},{name:"cc_matWorldIT",type:js.MAT4,count:1}]},om.set(lm.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:lm.BLOCK});var cm=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};cm.MAX_SPHERE_LIGHTS=2,cm.MAX_SPOT_LIGHTS=2,cm.SIZE=4*(cm.COUNT=(cm.SPOT_LIGHT_COLOR_OFFSET=(cm.SPOT_LIGHT_DIR_OFFSET=(cm.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(cm.SPOT_LIGHT_POS_OFFSET=(cm.SPHERE_LIGHT_COLOR_OFFSET=(cm.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(cm.SPHERE_LIGHT_POS_OFFSET=0)+4*cm.MAX_SPHERE_LIGHTS)+4*cm.MAX_SPHERE_LIGHTS)+4*cm.MAX_SPOT_LIGHTS)+4*cm.MAX_SPOT_LIGHTS)+4*cm.MAX_SPOT_LIGHTS)+4*cm.MAX_SPOT_LIGHTS)+4*cm.MAX_SPOT_LIGHTS),cm.BLOCK={binding:im.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:js.FLOAT4,count:cm.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:js.FLOAT4,count:cm.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:js.FLOAT4,count:cm.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:js.FLOAT4,count:cm.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:js.FLOAT4,count:cm.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:js.FLOAT4,count:cm.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:js.FLOAT4,count:cm.MAX_SPOT_LIGHTS}]},om.set(cm.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:cm.BLOCK});var um=function e(){y(this,e)};um.SIZE=4*(um.COUNT=(um.JOINTS_TEXTURE_INFO_OFFSET=0)+4),um.BLOCK={binding:im.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureInfo",type:js.FLOAT4,count:1}]},om.set(um.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:um.BLOCK});var hm={binding:im.SAMPLER_JOINTS,name:"cc_jointsTexture",type:js.SAMPLER2D,count:1};om.set(hm.name,{type:Io.SAMPLER,samplerInfo:hm});var _m,fm,dm,pm,mm,vm,ym,gm=0,bm=function(e){return Math.ceil(Math.log2(Math.max(e,2)))},Sm=function(e,t){switch(e.type){case"boolean":return t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"},Tm=function(e,t,i){var n=e.builtins[i],r=e.blocks,a=n.blocks,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l,u=t.get(c.name);if(u&&u.type===Io.UNIFORM_BUFFER){var h=Object.assign({defines:c.defines},u.blockInfo);r.push(h)}else console.warn("builtin UBO '".concat(c.name,"' not available!"))}var _=e.samplers,f=n.samplers,d=Array.isArray(f),p=0;for(f=d?f:f[Symbol.iterator]();;){var m;if(d){if(p>=f.length)break;m=f[p++]}else{if((p=f.next()).done)break;m=p.value}var v=m,y=t.get(v.name);if(y&&y.type===Io.SAMPLER){var g=Object.assign({defines:v.defines},y.samplerInfo);_.push(g)}else console.warn("builtin sampler '".concat(v.name,"' not available!"))}},xm=new(function(){function e(){y(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return l(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=Object.assign({id:++gm},e);i.localsInited||(Tm(i,om,"locals"),i.localsInited=!0);var r=0,n=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var i=l,e=1;if("number"===i.type){var t=i.range;e=bm(t[1]-t[0]),i._map=function(e){return e-t[0]<<i._offset}}else if("string"===i.type){var n=[0,i.options.length-1];e=bm(n[1]-n[0]),i._map=function(t){return Math.max(0,i.options.findIndex(function(e){return e===t}))<<i._offset}}else"boolean"===i.type&&(i._map=function(e){return e?1<<i._offset:0});i._offset=r,r+=e},a=i.defines,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===n())break}this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=0,r=i.defines,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=t[l.name];void 0!==c&&l._map&&(n|=l._map(c))}return n<<8|255&i.id}},{key:"destroyShaderByDefines",value:function(e){var i=this,n=Object.keys(e);if(n.length){var r=n.map(function(e){var t=n[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(e+t)}),t=Object.keys(this._cache).filter(function(t){return r.every(function(e){return e.test(i._cache[t].name)})}),a=Array.isArray(t),s=0;for(t=a?t:t[Symbol.iterator]();;){var o;if(a){if(s>=t.length)break;o=t[s++]}else{if((s=t.next()).done)break;o=s.value}var l=o;console.log("destroyed shader ".concat(this._cache[l].name)),this._cache[l].destroy(),delete this._cache[l]}}}},{key:"getGFXShader",value:function(e,t,i,n){Object.assign(i,n.macros);var r=this.getKey(t,i),a=this._cache[r];if(void 0!==a)return a;var s=this._templates[t];s.globalsInited||(Tm(s,n.globalBindings,"globals"),s.globalsInited=!0);var o=function(e,t){var i=[],n=t,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name,c=Sm(o,e[l]);i.push({name:l,result:c})}return i}(i,s.defines);!function(e,t,i){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name;"0"!==o.result&&i[l]&&!t[i[l]]&&(console.warn("".concat(i[l]," not supported on this platform, disabled ").concat(l)),o.result="0")}}(o,e,s.dependencies);var l=o.reduce(function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.result,"\n")},""),c="",u="";return u=e.gfxAPI===ml.WEBGL2?(c="#version 300 es\n".concat(l,"\n").concat(s.glsl3.vert),"#version 300 es\n".concat(l,"\n").concat(s.glsl3.frag)):(c="#version 100\n".concat(l,"\n").concat(s.glsl1.vert),"#version 100\n".concat(l,"\n").concat(s.glsl1.frag)),a=e.createShader({name:function(e,t){return e+t.reduce(function(e,t){return"0"!==t.result?"".concat(e,"|").concat(t.name).concat(t.result):e},"")}(t,o),blocks:s.blocks,samplers:s.samplers,stages:[{type:Mo.VERTEX,source:c},{type:Mo.FRAGMENT,source:u}]}),this._cache[r]=a}}]),e}());cc.programLib=xm;var Em={},wm=Ca("cc.EffectAsset")((ym=vm=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"techniques",dm,_(t)),m(t,"shaders",pm,_(t)),m(t,"combinations",mm,_(t)),t}return d(a,es),l(a,[{key:"onLoaded",value:function(){this.shaders.forEach(function(e){return xm.define(e)}),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),a.register(this)}},{key:"_precompile",value:function(){for(var i=this,n=cc.director.root,e=function(e){var t=i.shaders[e],a=i.combinations[e];if(!a)return"continue";Object.keys(a).reduce(function(e,r){return e.reduce(function(e,t){var i=a[r],n=[t].concat(x(Array(i.length-1)).map(function(){return Object.assign({},t)}));return n.forEach(function(e,t){return e[r]=i[t]}),e.concat(n)},[])},[{}]).forEach(function(e){return xm.getGFXShader(n.device,t.name,e,n.pipeline)})},t=0;t<this.shaders.length;t++)e(t)}}],[{key:"register",value:function(e){Em[e.name]=e}},{key:"remove",value:function(e){if(Em[e])delete Em[e];else for(var t in Em)if(Em[t]._uuid===e)return void delete Em[t]}},{key:"get",value:function(e){if(Em[e])return Em[e];for(var t in Em)if(Em[t]._uuid===e)return Em[t];return null}},{key:"getAll",value:function(){return Em}}]),a}(),vm._effects={},dm=c((fm=ym).prototype,"techniques",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pm=c(fm.prototype,"shaders",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mm=c(fm.prototype,"combinations",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_m=fm))||_m;cc.EffectAsset=wm;var Am,Cm,km,Rm,Om=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.TEXTURE_VIEW)))._device=void 0,t._texture=null,t._type=Ro.TV2D,t._format=Zt.GFXFormat.UNKNOWN,t._baseLevel=0,t._levelCount=1,t._baseLayer=0,t._layerCount=1,t._device=e,t}return d(i,$o),l(i,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),i}(),Mm=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.BUFFER)))._device=void 0,t._usage=qs.NONE,t._memUsage=Ks.NONE,t._size=0,t._stride=1,t._count=0,t._device=e,t}return d(i,$o),l(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}}]),i}(),Lm=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.COMMAND_BUFFER)))._device=void 0,t._allocator=null,t._type=Po.PRIMARY,t._numDrawCalls=0,t._numTris=0,t._device=e,t}return d(i,$o),l(i,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),i}(),Im=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.FRAMEBUFFER)))._device=void 0,t._renderPass=null,t._colorViews=[],t._depthStencilView=null,t._isOffscreen=!0,t._device=e,t}return d(i,$o),l(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),i}(),Fm=function(){function e(){y(this,e),this._arrayBufferOrPaddings=[],this._length=0}return l(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!=t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer}}]),e}();var Pm=function(){function t(e){y(this,t),this._subMeshes=e}return l(t,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"clearSubMeshes",value:function(){var e=this._subMeshes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.vertexBuffers,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.destroy()}r.indexBuffer&&r.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.clearSubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),t}(),Dm=Ca("cc.Mesh")((km=c((Cm=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_struct",km,_(e)),m(e,"_dataLength",Rm,_(e)),e._data=null,e._initialized=!1,e._renderingMesh=null,e.loaded=!1,e}return d(t,es),l(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}}]),l(t,[{key:"initialize",value:function(){var u=this;if(!this._initialized){this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),function(i,n){i.loaded?n&&n():i.nativeUrl?cc.loader.load({url:i.nativeUrl},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}(this));var h=this._data.buffer,_=cc.director.root.device,f=this._createVertexBuffers(_,h),d=[],e=function(){if(m){if(v>=p.length)return"break";y=p[v++]}else{if((v=p.next()).done)return"break";y=v.value}var e=y;if(0===e.vertexBundelIndices.length)return"continue";var t=null,i=null;if(e.indexView){var n=e.indexView;t=_.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:n.length,stride:n.stride}),i=new(function(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}(n.stride))(h,n.offset,n.count),u.loaded?t.update(i):u.once("load",function(){t.update(i)})}var r=e.vertexBundelIndices.map(function(e){return f[e]}),a=[];if(0<e.vertexBundelIndices.length){var s=e.vertexBundelIndices[0];a=u._struct.vertexBundles[s].attributes}var o={primitiveMode:e.primitiveMode,vertexBuffers:r,indexBuffer:t,attributes:a};if(e.geometricInfo){var l=e.geometricInfo,c=new Float32Array(h,l.view.offset,l.view.length/4);o.geometricInfo={indices:i,positions:c}}d.push(o)};var p=this._struct.primitives,m=Array.isArray(p),v=0;e:for(p=m?p:p[Symbol.iterator]();;){var y;switch(e()){case"break":break e;case"continue":continue}}this._renderingMesh=new Pm(d)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),p(S(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t){if(void 0!==t&&t&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;if(!this._initialized&&e._data){var i=JSON.parse(JSON.stringify(e._struct)),n=e._data.slice();return this.reset({struct:i,data:n}),this.initialize(),!0}for(var r,a,s,o,l,c=new Fm,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,y=!1,g=new Array(this._struct.vertexBundles.length),b=0;b<this._struct.vertexBundles.length;++b){var S=this._struct.vertexBundles[b],T=e._struct.vertexBundles[b];_=S.view.offset,f=T.view.offset,h=S.view.stride,u=S.view.count+T.view.count,r=new ArrayBuffer(u*h),a=new Uint8Array(r),_+=(s=this._data.subarray(_,_+S.view.length)).length,f+=(o=e._data.subarray(f,f+T.view.length)).length,a.set(s),d=0;var x=S.attributes,E=Array.isArray(x),w=0;for(x=E?x:x[Symbol.iterator]();;){var A;if(E){if(w>=x.length)break;A=x[w++]}else{if((w=x.next()).done)break;A=w.value}var C=A;m=0,y=!1;var k=T.attributes,R=Array.isArray(k),O=0;for(k=R?k:k[Symbol.iterator]();;){var M;if(R){if(O>=k.length)break;M=k[O++]}else{if((O=k.next()).done)break;M=O.value}var L=M;if(C.name===L.name&&C.format===L.format){y=!0;break}m+=rl[L.format].size}if(y){v=rl[C.format].size,p=S.view.length+d;for(var I=0;I<T.view.count;++I)l=o.subarray(m,m+v),a.set(l,p),p+=S.view.stride,m+=T.view.stride}d+=rl[C.format].size}g[b]={attributes:S.attributes,view:{offset:c.getLength(),length:r.byteLength,count:u,stride:h}},c.addBuffer(r)}for(var F,P,D,z=0,B=2,N=0,U=new Array(this._struct.primitives.length),G=0;G<this._struct.primitives.length;++G){var V=this._struct.primitives[G],H=e._struct.primitives[G];U[G]={primitiveMode:V.primitiveMode,vertexBundelIndices:V.vertexBundelIndices};var j=V.vertexBundelIndices,W=Array.isArray(j),X=0;for(j=W?j:j[Symbol.iterator]();;){var q;if(W){if(X>=j.length)break;q=j[X++]}else{if((X=j.next()).done)break;q=X.value}var Y=q;N=Math.max(N,this._struct.vertexBundles[Y].view.count)}if(V.indexView&&H.indexView){z=V.indexView.count,z+=H.indexView.count,_=V.indexView.offset,f=H.indexView.offset,B=z<256?1:z<65536?2:4;var K=new ArrayBuffer(z*B);if(F=2===B?new Uint16Array(K):1===B?new Uint8Array(K):new Uint32Array(K),P=2===V.indexView.stride?new Uint16Array(this._data.buffer,_,V.indexView.count):1===V.indexView.stride?new Uint8Array(this._data.buffer,_,V.indexView.count):new Uint32Array(this._data.buffer,_,V.indexView.count),B===V.indexView.stride)F.set(P);else for(var Q=0;Q<V.indexView.count;++Q)F[Q]=P[Q];_+=V.indexView.length,D=2===H.indexView.stride?new Uint16Array(e._data.buffer,f,H.indexView.count):1===H.indexView.stride?new Uint8Array(e._data.buffer,f,H.indexView.count):new Uint32Array(e._data.buffer,f,H.indexView.count);for(var Z=0;Z<H.indexView.count;++Z)F[V.indexView.count+Z]=N+D[Z];f+=H.indexView.length,U[G].indexView={offset:c.getLength(),length:K.byteLength,count:z,stride:B},c.setNextAlignment(B),c.addBuffer(K)}if(V.geometricInfo&&H.geometricInfo){var J=V.geometricInfo.view.length+H.geometricInfo.view.length,$=new ArrayBuffer(J),ee=new Uint8Array($),te=new Uint8Array(this._data.buffer,V.geometricInfo.view.offset,V.geometricInfo.view.length),ie=new Uint8Array(e._data.buffer,H.geometricInfo.view.offset,H.geometricInfo.view.length);ee.set(te),ee.set(ie,te.length),c.setNextAlignment(4),U[G].geometricInfo={doubleSided:V.geometricInfo.doubleSided,view:{offset:c.getLength(),length:ee.length,count:V.geometricInfo.view.count+H.geometricInfo.view.count,stride:V.geometricInfo.view.stride}},c.addBuffer($)}}var ne={vertexBundles:g,primitives:U,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ne.minPosition&&e._struct.minPosition&&Xi.min(ne.minPosition,ne.minPosition,e._struct.minPosition),ne.maxPosition&&e._struct.maxPosition&&Xi.max(ne.maxPosition,ne.maxPosition,e._struct.maxPosition),this.reset({struct:ne,data:new Uint8Array(c.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var s=this._struct.primitives[a],o=e._struct.primitives[a];if(s.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var l=0;l<s.vertexBundelIndices.length;++l)if(s.vertexBundelIndices[l]!==o.vertexBundelIndices[l])return!1;if(s.primitiveMode!==o.primitiveMode)return!1;if(s.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var f=this,d=null;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(f._data.buffer,e.view.offset+zm(e.attributes,t)),r=rl[i],a=Bm(i),s=Um(n,i);if(a&&s){for(var o=e.view.count,l=r.count,c=new a(o*l),u=e.view.stride,h=0;h<o;++h)for(var _=0;_<l;++_)c[l*h+_]=s(u*h+c.BYTES_PER_ELEMENT*_);d=c}}),d}},{key:"copyAttribute",value:function(e,t,m,v,y){var g=this,b=!1;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(g._data.buffer,e.view.offset+zm(e.attributes,t)),r=new DataView(m,y),a=rl[i],s=Um(n,i),o=function(i,e){var t=rl[e],n=t.size/t.count;switch(t.type){case el.UNORM:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,Nm)};case 4:return function(e,t){return i.setUint32(e,t,Nm)}}break;case el.SNORM:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,Nm)};case 4:return function(e,t){return i.setInt32(e,t,Nm)}}break;case el.INT:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,Nm)};case 4:return function(e,t){return i.setInt32(e,t,Nm)}}break;case el.UINT:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,Nm)};case 4:return function(e,t){return i.setUint32(e,t,Nm)}}break;case el.FLOAT:return function(e,t){return i.setFloat32(e,t,Nm)}}return null}(r,i);if(s&&o){for(var l=e.view.count,c=a.count,u=e.view.stride,h=function(e){var t=rl[e];return t.size/t.count}(i),_=v,f=h,d=0;d<l;++d)for(var p=0;p<c;++p){o(_*d+f*p,s(u*d+h*p))}b=!0}}),b}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,n=i<256?Zt.GFXFormat.R8UI:i<65536?Zt.GFXFormat.R16UI:Zt.GFXFormat.R32UI,r=new(Bm(n))(i),a=Um(new DataView(this._data.buffer),n),s=0;s<i;++s)r[s]=a(t.indexView.offset+r.BYTES_PER_ELEMENT*s);return r}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?Zt.GFXFormat.R8UI:2===i.indexView.stride?Zt.GFXFormat.R16UI:Zt.GFXFormat.R32UI,a=Um(new DataView(this._data.buffer),r),s=0;s<n;++s)t[s]=a(i.indexView.offset+rl[r].size*s);return!0}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var n=this._struct.primitives[e].vertexBundelIndices,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=this._struct.vertexBundles[o],c=l.attributes.findIndex(function(e){return e.name===t});if(!(c<0)){i(l,c);break}}}}},{key:"_createVertexBuffers",value:function(n,r){var a=this;return this._struct.vertexBundles.map(function(e){var t=n.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:e.view.length,stride:e.view.stride}),i=new Uint8Array(r,e.view.offset,e.view.length);return a.loaded?t.update(i):a.once("load",function(){t.update(i)}),t})}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}()).prototype,"_struct",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Rm=c(Cm.prototype,"_dataLength",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Am=Cm))||Am;function zm(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=rl[r.format].size}return i}function Bm(e){var t=rl[e],i=t.size/t.count;switch(t.type){case el.UNORM:case el.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case el.SNORM:case el.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case el.FLOAT:return Float32Array}return null}cc.Mesh=Dm;var Nm=cc.sys.isLittleEndian;function Um(t,e){var i=rl[e],n=i.size/i.count;switch(i.type){case el.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Nm)};case 4:return function(e){return t.getUint32(e,Nm)}}break;case el.SNORM:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Nm)};case 4:return function(e){return t.getInt32(e,Nm)}}break;case el.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Nm)};case 4:return function(e){return t.getInt32(e,Nm)}}break;case el.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Nm)};case 4:return function(e){return t.getUint32(e,Nm)}}break;case el.FLOAT:return function(e){return t.getFloat32(e,Nm)}}return null}var Gm={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256},Vm=new Xi,Hm=new Xi,jm=new Xi,Wm=new Xi,Xm=new Xi,qm=new Xi,Ym=new Array(3),Km=new Array(3);function Qm(e,t){return Xi.dot(t.n,e)-t.d}function Zm(e,t,i){return Xi.copy(e,t),Xi.subtract(Xm,i.center,i.halfExtents),Xi.add(qm,i.center,i.halfExtents),e.x=e.x<Xm.x?Xm.x:e.x,e.y=e.y<Xm.x?Xm.y:e.y,e.z=e.z<Xm.x?Xm.z:e.z,e.x=e.x>qm.x?qm.x:e.x,e.y=e.y>qm.x?qm.y:e.y,e.z=e.z>qm.x?qm.z:e.z,e}function Jm(e,t,i){Xi.set(Vm,i.orientation.m00,i.orientation.m01,i.orientation.m02),Xi.set(Hm,i.orientation.m03,i.orientation.m04,i.orientation.m05),Xi.set(jm,i.orientation.m06,i.orientation.m07,i.orientation.m08),Ym[0]=Vm,Ym[1]=Hm,Ym[2]=jm,Km[0]=i.halfExtents.x,Km[1]=i.halfExtents.y,Km[2]=i.halfExtents.z,Xi.subtract(Wm,t,i.center),Xi.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Xi.dot(Wm,Ym[n]);r>Km[n]&&(r=Km[n]),r<-Km[n]&&(r=-Km[n]),e.x+=r*Ym[n].x,e.y+=r*Ym[n].y,e.z+=r*Ym[n].z}return e}var $m,ev,tv,iv,nv,rv,av,sv,ov,lv,cv,uv,hv,_v,fv,dv,pv,mv,vv,yv,gv,bv,Sv,Tv,xv,Ev,wv,Av,Cv,kv,Rv,Ov,Mv,Lv,Iv,Fv,Pv,Dv,zv=Object.freeze({point_plane:Qm,pt_point_plane:function(e,t,i){var n=Qm(t,i);return Xi.subtract(e,t,Xi.multiplyScalar(e,i.n,n))},pt_point_aabb:Zm,pt_point_obb:Jm}),Bv=($m=new Xi(0,0,0),function(e,t){var i=Xi.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Xi.multiplyScalar($m,t.n,t.d);var n=Xi.dot(Xi.subtract($m,$m,e.o),t.n)/i;return n<0?0:n}),Nv=(ev=new Xi(0,0,0),function(e,t){Xi.subtract(ev,e.e,e.s);var i=(t.d-Xi.dot(e.s,t.n))/Xi.dot(ev,t.n);return i<0||1<i?0:i}),Uv=(tv=new Xi(0,0,0),iv=new Xi(0,0,0),nv=new Xi(0,0,0),rv=new Xi(0,0,0),av=new Xi(0,0,0),function(e,t,i){Xi.subtract(tv,t.b,t.a),Xi.subtract(iv,t.c,t.a),Xi.cross(nv,e.d,iv);var n=Xi.dot(tv,nv);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Xi.subtract(rv,e.o,t.a);var a=Xi.dot(rv,nv)*r;if(a<0||1<a)return 0;Xi.cross(av,rv,tv);var s=Xi.dot(e.d,av)*r;if(s<0||1<a+s)return 0;var o=Xi.dot(iv,av)*r;return o<0?0:o}),Gv=(sv=new Xi(0,0,0),ov=new Xi(0,0,0),lv=new Xi(0,0,0),cv=new Xi(0,0,0),uv=new Xi(0,0,0),hv=new Xi(0,0,0),function(e,t,i){Xi.subtract(sv,t.b,t.a),Xi.subtract(ov,t.c,t.a),Xi.subtract(lv,e.s,e.e),Xi.cross(uv,sv,ov);var n=Xi.dot(lv,uv);if(n<=0)return 0;Xi.subtract(cv,e.s,t.a);var r=Xi.dot(cv,uv);if(r<0||n<r)return 0;Xi.cross(hv,lv,cv);var a=Xi.dot(ov,hv);if(a<0||n<a)return 0;var s=-Xi.dot(sv,hv);if(s<0||n<a+s)return 0;if(i){var o=1/n,l=1-(a*=o)-(s*=o);Xi.set(i,t.a.x*l+t.b.x*a+t.c.x*s,t.a.y*l+t.b.y*a+t.c.y*s,t.a.z*l+t.b.z*a+t.c.z*s)}return 1}),Vv=(_v=new Xi(0,0,0),fv=new Xi(0,0,0),dv=new Xi(0,0,0),pv=new Xi(0,0,0),mv=new Xi(0,0,0),vv=new Xi(0,0,0),yv=new Xi(0,0,0),function(e,t,i,n,r,a,s){Xi.subtract(_v,t,e),Xi.subtract(fv,i,e),Xi.subtract(dv,n,e),Xi.subtract(pv,r,e),Xi.cross(vv,pv,_v);var o=Xi.dot(fv,vv);if(0<=o){var l=-Xi.dot(dv,vv);if(l<0)return 0;var c=Xi.dot(Xi.cross(yv,_v,dv),fv);if(c<0)return 0;if(s){var u=1/(l+o+c);l*=u,o*=u,c*=u,Xi.set(s,i.x*l+n.x*o+r.x*c,i.y*l+n.y*o+r.y*c,i.z*l+n.z*o+r.z*c)}}else{Xi.subtract(mv,a,e);var h=Xi.dot(mv,vv);if(h<0)return 0;var _=Xi.dot(Xi.cross(yv,_v,fv),mv);if(_<0)return 0;if(s){var f=1/(h+(o=-o)+_);h*=f,o*=f,_*=f,Xi.set(s,i.x*h+a.x*o+r.x*_,i.y*h+a.y*o+r.y*_,i.z*h+a.z*o+r.z*_)}}return 1}),Hv=(gv=new Xi(0,0,0),function(e,t){var i=t.radius,n=t.center,r=e.o,a=e.d,s=i*i;Xi.subtract(gv,n,r);var o=gv.lengthSqr(),l=Xi.dot(gv,a),c=s-(o-l*l);if(c<0)return 0;var u=Math.sqrt(c),h=o<s?l+u:l-u;return h<0?0:h}),jv=(bv=new Xi,Sv=new Xi,function(e,t){var i=e.o,n=e.d,r=1/n.x,a=1/n.y,s=1/n.z;Xi.subtract(bv,t.center,t.halfExtents),Xi.add(Sv,t.center,t.halfExtents);var o=(bv.x-i.x)*r,l=(Sv.x-i.x)*r,c=(bv.y-i.y)*a,u=(Sv.y-i.y)*a,h=(bv.z-i.z)*s,_=(Sv.z-i.z)*s,f=Math.max(Math.max(Math.min(o,l),Math.min(c,u)),Math.min(h,_)),d=Math.min(Math.min(Math.max(o,l),Math.max(c,u)),Math.max(h,_));return d<0||d<f?0:f}),Wv=(Tv=new Xi,xv=new Xi,Ev=new Xi,wv=new Xi,Av=new Xi,Cv=new Xi,kv=new Xi,Rv=new Array(3),Ov=new Array(3),Mv=new Array(3),Lv=new Array(6),function(e,t){Rv[0]=t.halfExtents.x,Rv[1]=t.halfExtents.y,Rv[2]=t.halfExtents.z,Tv=t.center,xv=e.o,Ev=e.d,Xi.set(wv,t.orientation.m00,t.orientation.m01,t.orientation.m02),Xi.set(Av,t.orientation.m03,t.orientation.m04,t.orientation.m05),Xi.set(Cv,t.orientation.m06,t.orientation.m07,t.orientation.m08),Xi.subtract(kv,Tv,xv),Ov[0]=Xi.dot(wv,Ev),Ov[1]=Xi.dot(Av,Ev),Ov[2]=Xi.dot(Cv,Ev),Mv[0]=Xi.dot(wv,kv),Mv[1]=Xi.dot(Av,kv),Mv[2]=Xi.dot(Cv,kv);for(var i=0;i<3;++i){if(0===Ov[i]){if(0<-Mv[i]-Rv[i]||-Mv[i]+Rv[i]<0)return 0;Ov[i]=1e-7}Lv[2*i+0]=(Mv[i]+Rv[i])/Ov[i],Lv[2*i+1]=(Mv[i]-Rv[i])/Ov[i]}var n=Math.max(Math.max(Math.min(Lv[0],Lv[1]),Math.min(Lv[2],Lv[3])),Math.min(Lv[4],Lv[5])),r=Math.min(Math.min(Math.max(Lv[0],Lv[1]),Math.max(Lv[2],Lv[3])),Math.max(Lv[4],Lv[5]));return r<0||r<n||n<0?0:n}),Xv=(Iv=new Xi,Fv=new Xi,Pv=new Xi,Dv=new Xi,function(e,t){return Xi.subtract(Iv,e.center,e.halfExtents),Xi.add(Fv,e.center,e.halfExtents),Xi.subtract(Pv,t.center,t.halfExtents),Xi.add(Dv,t.center,t.halfExtents),Iv.x<=Dv.x&&Fv.x>=Pv.x&&Iv.y<=Dv.y&&Fv.y>=Pv.y&&Iv.z<=Dv.z&&Fv.z>=Pv.z});function qv(e,t,i,n,r,a){Xi.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),Xi.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),Xi.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),Xi.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),Xi.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),Xi.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),Xi.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),Xi.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function Yv(e,t){for(var i=Xi.dot(t,e[0]),n=i,r=1;r<8;++r){var a=Xi.dot(t,e[r]);i=a<i?a:i,n=n<a?a:n}return[i,n]}var Kv,Qv,Zv,Jv,$v,ey,ty,iy=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Xi(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Xi(0,0,0),l[t]=new Xi(0,0,0);var c=new Xi,u=new Xi;return function(e,t){Xi.set(s[0],1,0,0),Xi.set(s[1],0,1,0),Xi.set(s[2],0,0,1),Xi.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Xi.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Xi.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Xi.cross(s[6+3*i+0],s[i],s[0]),Xi.cross(s[6+3*i+1],s[i],s[1]),Xi.cross(s[6+3*i+1],s[i],s[2]);Xi.subtract(c,e.center,e.halfExtents),Xi.add(u,e.center,e.halfExtents),function(e,t,i){Xi.set(i[0],e.x,t.y,t.z),Xi.set(i[1],e.x,t.y,e.z),Xi.set(i[2],e.x,e.y,t.z),Xi.set(i[3],e.x,e.y,e.z),Xi.set(i[4],t.x,t.y,t.z),Xi.set(i[5],t.x,t.y,e.z),Xi.set(i[6],t.x,e.y,t.z),Xi.set(i[7],t.x,e.y,e.z)}(c,u,o),qv(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=Yv(o,s[n]),a=Yv(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),ny=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=Xi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},ry=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===ny(e,t.planes[i]))return 0;return 1},ay=function(){for(var c=new Array(8),u=0,h=0,e=0;e<c.length;e++)c[e]=new Xi(0,0,0);return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=ny(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Xi.subtract(c[a],t.vertices[a],e.center);for(var s=h=u=0;s<t.vertices.length;s++)c[s].x>e.halfExtents.x?u++:c[s].x<-e.halfExtents.x&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var o=h=u=0;o<t.vertices.length;o++)c[o].y>e.halfExtents.y?u++:c[o].y<-e.halfExtents.y&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var l=h=u=0;l<t.vertices.length;l++)c[l].z>e.halfExtents.z?u++:c[l].z<-e.halfExtents.z&&h++;return u===t.vertices.length||h===t.vertices.length?0:1}}(),sy=(Kv=new Xi(0,0,0),Qv=new un,function(e,t){return Xi.subtract(Kv,t,e.center),Xi.transformMat3(Kv,Kv,un.transpose(Qv,e.orientation)),function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z}(Kv,e.halfExtents)}),oy=(Zv=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*Zv(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Zv(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Zv(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=Xi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),ly=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===oy(e,t.planes[i]))return 0;return 1},cy=function(){for(var c=new Array(8),u=0,h=0,_=0,e=0;e<c.length;e++)c[e]=new Xi(0,0,0);var f=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=oy(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Xi.subtract(c[a],t.vertices[a],e.center);for(var s=_=h=0;s<t.vertices.length;s++)(u=f(c[s],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:u<-e.halfExtents.x&&_++;if(h===t.vertices.length||_===t.vertices.length)return 0;for(var o=_=h=0;o<t.vertices.length;o++)(u=f(c[o],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:u<-e.halfExtents.y&&_++;if(h===t.vertices.length||_===t.vertices.length)return 0;for(var l=_=h=0;l<t.vertices.length;l++)(u=f(c[l],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:u<-e.halfExtents.z&&_++;return h===t.vertices.length||_===t.vertices.length?0:1}}(),uy=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Xi(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Xi(0,0,0),l[t]=new Xi(0,0,0);return function(e,t){Xi.set(s[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Xi.set(s[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Xi.set(s[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Xi.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Xi.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Xi.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Xi.cross(s[6+3*i+0],s[i],s[0]),Xi.cross(s[6+3*i+1],s[i],s[1]),Xi.cross(s[6+3*i+1],s[i],s[2]);qv(e.center,e.halfExtents,s[0],s[1],s[2],o),qv(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=Yv(o,s[n]),a=Yv(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),hy=function(e,t){var i=Xi.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},_y=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===hy(e,t.planes[i]))return 0;return 1},fy=(Jv=new Xi(0,0,0),$v=[1,-1,1,-1,1,-1],function(e,t){for(var i=0;i<6;i++){var n=t.planes[i],r=e.radius,a=e.center,s=n.n,o=n.d,l=Xi.dot(s,a);if(l+r<o)return 0;if(!(o<l-r)){Xi.add(Jv,a,Xi.multiplyScalar(Jv,s,r));for(var c=0;c<6;c++)if(c!==i&&c!==i+$v[i]){var u=t.planes[c];if(Xi.dot(u.n,Jv)<u.d)return 0}}}return 1}),dy=function(e,t){var i=e.radius+t.radius;return Xi.squaredDistance(e.center,t.center)<i*i},py=(ey=new Xi,function(e,t){return Zm(ey,e.center,t),Xi.squaredDistance(e.center,ey)<e.radius*e.radius}),my=(ty=new Xi,function(e,t){return Jm(ty,e.center,t),Xi.squaredDistance(e.center,ty)<e.radius*e.radius}),vy={ray_sphere:Hv,ray_aabb:jv,ray_obb:Wv,ray_plane:Bv,ray_triangle:Uv,line_plane:Nv,line_triangle:Gv,line_quad:Vv,sphere_sphere:dy,sphere_aabb:py,sphere_obb:my,sphere_plane:hy,sphere_frustum:_y,sphere_frustum_accurate:fy,aabb_aabb:Xv,aabb_obb:iy,aabb_plane:ny,aabb_frustum:ry,aabb_frustum_accurate:ay,obb_obb:uy,obb_plane:oy,obb_frustum:ly,obb_frustum_accurate:cy,obb_point:sy,resolve:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=e._type,r=t._type,a=this[n|r];return n<r?a(e,t,i):a(t,e,i)}};vy[Gm.SHAPE_RAY|Gm.SHAPE_SPHERE]=Hv,vy[Gm.SHAPE_RAY|Gm.SHAPE_AABB]=jv,vy[Gm.SHAPE_RAY|Gm.SHAPE_OBB]=Wv,vy[Gm.SHAPE_RAY|Gm.SHAPE_PLANE]=Bv,vy[Gm.SHAPE_RAY|Gm.SHAPE_TRIANGLE]=Uv,vy[Gm.SHAPE_LINE|Gm.SHAPE_PLANE]=Nv,vy[Gm.SHAPE_LINE|Gm.SHAPE_TRIANGLE]=Gv,vy[Gm.SHAPE_SPHERE]=dy,vy[Gm.SHAPE_SPHERE|Gm.SHAPE_AABB]=py,vy[Gm.SHAPE_SPHERE|Gm.SHAPE_OBB]=my,vy[Gm.SHAPE_SPHERE|Gm.SHAPE_PLANE]=hy,vy[Gm.SHAPE_SPHERE|Gm.SHAPE_FRUSTUM]=_y,vy[Gm.SHAPE_SPHERE|Gm.SHAPE_FRUSTUM_ACCURATE]=fy,vy[Gm.SHAPE_AABB]=Xv,vy[Gm.SHAPE_AABB|Gm.SHAPE_OBB]=iy,vy[Gm.SHAPE_AABB|Gm.SHAPE_PLANE]=ny,vy[Gm.SHAPE_AABB|Gm.SHAPE_FRUSTUM]=ry,vy[Gm.SHAPE_AABB|Gm.SHAPE_FRUSTUM_ACCURATE]=ay,vy[Gm.SHAPE_OBB]=uy,vy[Gm.SHAPE_OBB|Gm.SHAPE_PLANE]=oy,vy[Gm.SHAPE_OBB|Gm.SHAPE_FRUSTUM]=ly,vy[Gm.SHAPE_OBB|Gm.SHAPE_FRUSTUM_ACCURATE]=cy;var yy=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Gm.SHAPE_LINE,this.s=new Xi(e,t,i),this.e=new Xi(n,r,a)}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}},{key:"copy",value:function(e,t){return Xi.copy(e.s,t.s),Xi.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Xi.copy(e.s,t),Xi.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=s,e}},{key:"len",value:function(e){return Xi.distance(e.s,e.e)}}]),l(s,[{key:"length",value:function(){return Xi.distance(this.s,this.e)}}]),s}(),gy=new Xi(0,0,0),by=new Xi(0,0,0),Sy=cc.mat4(),Ty=cc.v4(),xy=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,r),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Gm.SHAPE_PLANE,this.n=new Xi(e,t,i),this.d=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.n.x,e.n.y,e.n.z,e.d)}},{key:"copy",value:function(e,t){return Xi.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return Xi.subtract(gy,i,t),Xi.subtract(by,n,t),Xi.normalize(e.n,Xi.cross(e.n,gy,by)),e.d=Xi.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Xi.copy(e.n,t),e.d=Xi.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return Xi.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e}}]),l(r,[{key:"transform",value:function(e){Nn.invert(Sy,e),Nn.transpose(Sy,Sy),$i.set(Ty,this.n.x,this.n.y,this.n.z,this.d),$i.transformMat4(Ty,Ty,Sy),Xi.set(this.n,Ty.x,Ty.y,Ty.z),this.d=Ty.w}}]),r}(),Ey=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Gm.SHAPE_RAY,this.o=new Xi(e,t,i),this.d=new Xi(n,r,a)}return l(s,null,[{key:"create",value:function(){return new s(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,5<arguments.length&&void 0!==arguments[5]?arguments[5]:1)}},{key:"clone",value:function(e){return new s(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}},{key:"copy",value:function(e,t){return Xi.copy(e.o,t.o),Xi.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Xi.copy(e.o,t),Xi.normalize(e.d,Xi.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=s,e}}]),s}(),wy=function(){function c(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:1,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0;y(this,c),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Gm.SHAPE_TRIANGLE,this.a=new Xi(e,t,i),this.b=new Xi(n,r,a),this.c=new Xi(s,o,l)}return l(c,null,[{key:"create",value:function(){return new c(0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,8<arguments.length&&void 0!==arguments[8]?arguments[8]:1)}},{key:"clone",value:function(e){return new c(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}},{key:"copy",value:function(e,t){return Xi.copy(e.a,t.a),Xi.copy(e.b,t.b),Xi.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return Xi.copy(e.a,t),Xi.copy(e.b,i),Xi.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=s,e.c.x=o,e.c.y=l,e.c.z=c,e}}]),c}(),Ay=new Xi;function Cy(e){return Math.max(Math.max(e.x,e.y),e.z)}var ky=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=Gm.SHAPE_SPHERE,this.center=new Xi(e,t,i),this.radius=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.center.x,e.center.y,e.center.z,e.radius)}},{key:"copy",value:function(e,t){return Xi.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Xi.multiplyScalar(e.center,Xi.add(Ay,t,i),.5),e.radius=.5*Xi.subtract(Ay,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),l(r,[{key:"clone",value:function(){return r.clone(this)}},{key:"copy",value:function(e){return r.copy(this,e)}},{key:"getBoundary",value:function(e,t){Xi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Xi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){Xi.transformMat4(r.center,this.center,e),r.radius=this.radius*Cy(n)}},{key:"translateAndRotate",value:function(e,t,i){Xi.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*Cy(e)}}]),r}(),Ry=new Xi,Oy=new Xi,My=new Xi,Ly=new Xi,Iy=new un,Fy=function(e,t,i){Iy.m00=Math.abs(i.m00),Iy.m01=Math.abs(i.m01),Iy.m02=Math.abs(i.m02),Iy.m03=Math.abs(i.m04),Iy.m04=Math.abs(i.m05),Iy.m05=Math.abs(i.m06),Iy.m06=Math.abs(i.m08),Iy.m07=Math.abs(i.m09),Iy.m08=Math.abs(i.m10),Xi.transformMat3(e,t,Iy)},Py=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1;y(this,s),this.center=void 0,this.halfExtents=void 0,this._type=Gm.SHAPE_AABB,this.center=new Xi(e,t,i),this.halfExtents=new Xi(n,r,a)}return l(s,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}},{key:"copy",value:function(e,t){return Xi.copy(e.center,t.center),Xi.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Xi.multiplyScalar(e.center,Xi.add(Ry,t,i),.5),Xi.multiplyScalar(e.halfExtents,Xi.subtract(Oy,i,t),.5),e}},{key:"set",value:function(e,t,i,n,r,a,s){return Xi.set(e.center,t,i,n),Xi.set(e.halfExtents,r,a,s),e}},{key:"merge",value:function(e,t,i){return Xi.subtract(Ry,t.center,t.halfExtents),Xi.subtract(Oy,i.center,i.halfExtents),Xi.add(My,t.center,t.halfExtents),Xi.add(Ly,i.center,i.halfExtents),Xi.max(Ly,My,Ly),Xi.min(My,Ry,Oy),s.fromPoints(e,My,Ly)}},{key:"transform",value:function(e,t,i){return Xi.transformMat4(e.center,t.center,i),Fy(e.halfExtents,t.halfExtents,i),e}}]),l(s,[{key:"getBoundary",value:function(e,t){Xi.subtract(e,this.center,this.halfExtents),Xi.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){Xi.transformMat4(r.center,this.center,e),Fy(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return s.clone(this)}},{key:"copy",value:function(e){return s.copy(this,e)}}]),s}(),Dy=new Xi,zy=new Xi,By=new un,Ny=function(){function p(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:1,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,_=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,f=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,d=14<arguments.length&&void 0!==arguments[14]?arguments[14]:1;y(this,p),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Gm.SHAPE_OBB,this.center=new Xi(e,t,i),this.halfExtents=new Xi(n,r,a),this.orientation=new un(s,o,l,c,u,h,_,f,d)}return l(p,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a,s,o,l,c,u,h,_,f,d){return new p(e,t,i,n,r,a,s,o,l,c,u,h,_,f,d)}},{key:"clone",value:function(e){return new p(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}},{key:"copy",value:function(e,t){return Xi.copy(e.center,t.center),Xi.copy(e.halfExtents,t.halfExtents),un.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Xi.multiplyScalar(e.center,Xi.add(Dy,t,i),.5),Xi.multiplyScalar(e.halfExtents,Xi.subtract(zy,i,t),.5),un.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,_,f,d,p){return Xi.set(e.center,t,i,n),Xi.set(e.halfExtents,r,a,s),un.set(e.orientation,o,l,c,u,h,_,f,d,p),e}}]),l(p,[{key:"getBoundary",value:function(e,t){!function(e,t,i){By.m00=Math.abs(i.m00),By.m01=Math.abs(i.m01),By.m02=Math.abs(i.m02),By.m03=Math.abs(i.m03),By.m04=Math.abs(i.m04),By.m05=Math.abs(i.m05),By.m06=Math.abs(i.m06),By.m07=Math.abs(i.m07),By.m08=Math.abs(i.m08),Xi.transformMat3(e,t,By)}(Dy,this.halfExtents,this.orientation),Xi.subtract(e,this.center,Dy),Xi.add(t,this.center,Dy)}},{key:"transform",value:function(e,t,i,n,r){Xi.transformMat4(r.center,this.center,e),un.fromQuat(r.orientation,i),Xi.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){Xi.transformMat4(i.center,this.center,e),un.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Xi.multiply(t.halfExtents,this.halfExtents,e)}}]),p}(),Uy=new Array(8);Uy[0]=new Xi(1,1,1),Uy[1]=new Xi(-1,1,1),Uy[2]=new Xi(-1,-1,1),Uy[3]=new Xi(1,-1,1),Uy[4]=new Xi(1,1,-1),Uy[5]=new Xi(-1,1,-1),Uy[6]=new Xi(-1,-1,-1),Uy[7]=new Xi(1,-1,-1);var Gy,Vy=function(){function i(){y(this,i),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=Gm.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=xy.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Xi}return l(i,[{key:"accurate",set:function(e){this._type=e?Gm.SHAPE_FRUSTUM_ACCURATE:Gm.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new i}},{key:"clone",value:function(e){return i.copy(new i,e)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)xy.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)Xi.copy(e.vertices[n],t.vertices[n]);return e}}]),l(i,[{key:"update",value:function(e,t){if(Xi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Xi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Xi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Xi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Xi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Xi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===Gm.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();Xi.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)Xi.transformMat4(this.vertices[a],Uy[a],t)}}},{key:"transform",value:function(e){if(this._type===Gm.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Xi.transformMat4(this.vertices[t],this.vertices[t],e);xy.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),xy.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),xy.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),xy.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),xy.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),xy.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),i}();Vy.createOrtho=(Gy=new Xi,function(e,t,i,n,r,a){var s=t/2,o=i/2;Xi.set(Gy,s,o,n),Xi.transformMat4(e.vertices[0],Gy,a),Xi.set(Gy,-s,o,n),Xi.transformMat4(e.vertices[1],Gy,a),Xi.set(Gy,-s,-o,n),Xi.transformMat4(e.vertices[2],Gy,a),Xi.set(Gy,s,-o,n),Xi.transformMat4(e.vertices[3],Gy,a),Xi.set(Gy,s,o,r),Xi.transformMat4(e.vertices[4],Gy,a),Xi.set(Gy,-s,o,r),Xi.transformMat4(e.vertices[5],Gy,a),Xi.set(Gy,-s,-o,r),Xi.transformMat4(e.vertices[6],Gy,a),Xi.set(Gy,s,-o,r),Xi.transformMat4(e.vertices[7],Gy,a),xy.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),xy.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),xy.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),xy.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),xy.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),xy.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])});for(var Hy=function(){function n(e,t){y(this,n),this._cursor=void 0,this._data=void 0,this._cursor=0,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"request",value:function(){var e=this._data[this._cursor];return this._cursor=(this._cursor+1)%this._data.length,e}}]),n}(),jy=function(){function t(e){y(this,t),this._count=void 0,this._data=void 0,this._count=0,this._data=new Array(e)}return l(t,[{key:"_resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=void 0}},{key:"reset",value:function(){for(var e=0;e<this._count;++e)this._data[e]=void 0;this._count=0}},{key:"push",value:function(e){this._count>=this._data.length&&this._resize(2*this._data.length),this._data[this._count]=e,++this._count}},{key:"pop",value:function(){--this._count,this._count<0&&(this._count=0);var e=this._data[this._count];return this._data[this._count]=void 0,e}},{key:"fastRemove",value:function(e){if(!(e>=this._count||e<0)){var t=this._count-1;this._data[e]=this._data[t],this._data[t]=void 0,this._count-=1}}},{key:"indexOf",value:function(e){return this._data.indexOf(e)}},{key:"sort",value:function(e){return Wp(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(),Wy=function(){function i(e,t){y(this,i),this._fn=void 0,this._count=void 0,this._head=void 0,this._tail=void 0,this._pool=void 0,this._fn=e,this._count=0,this._head=null,this._tail=null,this._pool=new Ze(e,t)}return l(i,[{key:"add",value:function(){var e=this._pool.alloc();return this._tail?(this._tail._next=e)._prev=this._tail:this._head=e,this._tail=e,this._count+=1,e}},{key:"remove",value:function(e){e._prev?e._prev._next=e._next:this._head=e._next,e._next?e._next._prev=e._prev:this._tail=e._prev,e._next=null,e._prev=null,this._pool.free(e),this._count-=1}},{key:"forEach",value:function(e,t){var i=this._head;if(i){t&&(e=e.bind(t));for(var n=0,r=i;i;)r=i._next,e(i,n,this),i=r,++n}}},{key:"head",get:function(){return this._head}},{key:"tail",get:function(){return this._tail}},{key:"length",get:function(){return this._count}}]),i}(),Xy=Array(8),qy=0;qy<8;++qy)Xy[qy]=[];function Yy(e){var t=(65535<e)<<4,i=(255<(e>>>=t))<<3;return t|=i,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function Ky(e){var t=function(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}(e),i=Xy[Yy(t)>>2];return 0<i.length?i.pop():new ArrayBuffer(t)}var Qy={alloc_int8:function(e){var t=new Int8Array(Ky(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint8:function(e){var t=new Uint8Array(Ky(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int16:function(e){var t=new Int16Array(Ky(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint16:function(e){var t=new Uint16Array(Ky(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int32:function(e){var t=new Int32Array(Ky(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint32:function(e){var t=new Uint32Array(Ky(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float32:function(e){var t=new Float32Array(Ky(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float64:function(e){var t=new Float64Array(Ky(8*e),0,e);return t.length!==e?t.subarray(0,e):t},free:function(e){!function(e){Xy[Yy(e.byteLength)>>2].push(e)}(e.buffer)},reset:function(){Xy=Array(8);for(var e=0;e<8;++e)Xy[e]=[]}},Zy=function(e,t,i,n,r){return Xi.set(e,t.x*i,t.y*n,t.z*r)},Jy=function(){function s(e,t,i,n,r,a){y(this,s),this.minPos=void 0,this.maxPos=void 0,this.boundingBox=void 0,this.capacity=void 0,this.depth=void 0,this.maxDepth=void 0,this.blocks=void 0,this.entries=void 0,this._getBoundingShape=void 0,this.minPos=e,this.maxPos=t,this.boundingBox=Py.fromPoints(Py.create(),e,t),this.capacity=i,this.depth=n,this.maxDepth=r,this._getBoundingShape=a,this.blocks=null,this.entries=new jy(this.capacity)}return l(s,[{key:"addEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else{var a=this._getBoundingShape(e);if(!vy.resolve(this.boundingBox,a))return;this.entries.push(e),this.entries.length>=this.capacity&&this.depth<this.maxDepth&&(this.blocks=$y.createBlocks(this.minPos,this.maxPos,this.entries,this.capacity,this.depth,this.maxDepth,this._getBoundingShape),this.entries.reset())}}},{key:"removeEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.entries.fastRemove(this.entries.indexOf(e))}},{key:"select",value:function(e,t){if(vy.resolve(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.select(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}},{key:"frustumSelect",value:function(e,t){if(vy.aabb_frustum(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.frustumSelect(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}}]),s}(),$y=function(){function u(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:32,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5;y(this,u),this.blockCapacity=void 0,this.maxDepth=void 0,this.blocks=void 0,this.dynamics=void 0,this._selection=void 0,this._getBoundingShape=void 0,this.blockCapacity=t,this.maxDepth=i,this.blocks=[],this.dynamics=[],this._selection=new Set,this._getBoundingShape=function(){return e._getBoundingShape}}return l(u,null,[{key:"createBlocks",value:function(e,t,i,n,r,a,s){var o=[],l=new Xi;Xi.multiplyScalar(l,Xi.subtract(l,t,e),.5);for(var c=0;c<2;c++)for(var u=0;u<2;u++)for(var h=0;h<2;h++){var _=new Xi,f=new Xi;Xi.add(_,e,Zy(_,l,c,u,h)),Xi.add(f,e,Zy(f,l,c+1,u+1,h+1));for(var d=new Jy(_,f,n,r+1,a,s),p=0;p<i.length;p++){var m=(i.data||i)[p];d.addEntry(m)}o.push(d)}return o}}]),l(u,[{key:"build",value:function(e,t){var i=new Xi(1/0,1/0,1/0),n=new Xi(-1/0,-1/0,-1/0),r=new Xi,a=new Xi,s=[];this.dynamics=[];for(var o=0;o<e.length;o++){var l=(e.data||e)[o],c=t(l);c?(c.getBoundary(r,a),Xi.min(i,i,r),Xi.max(n,n,a),s.push(l)):this.dynamics.push(l)}this.blocks=u.createBlocks(i,n,s,this.blockCapacity,0,this.maxDepth,t),this._getBoundingShape=t}},{key:"addEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else this.dynamics.push(e)}},{key:"removeEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.dynamics.splice(this.dynamics.indexOf(e),1)}},{key:"select",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.select(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;this._selection.add(c)}return this._selection}},{key:"frustumSelect",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.frustumSelect(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;this._selection.add(c)}return this._selection}}]),u}(),eg=kt({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4}),tg=function e(){y(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};vi.fastDefine("cc.Keyframe",tg,{time:0,value:0,inTangent:0,outTangent:0});var ig=function(){function e(){y(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return l(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var ng=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;y(this,t),this.keyFrames=void 0,this.preWrapMode=eg.Loop,this.postWrapMode=eg.Loop,this.cachedKey=void 0,this.keyFrames=e||[].concat(t.defaultKF),this.cachedKey=new ig}return l(t,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case eg.Loop:t=Pi(e-n,r-n)+n;break;case eg.PingPong:t=Di(e-n,r-n)+n;break;case eg.ClampForever:t=wi(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var s=0;s<this.keyFrames.length-1;s++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[s+1].time){a=s;break}var o=this.keyFrames[a],l=this.keyFrames[a+1],c=zi(o.time,l.time,t),u=l.time-o.time,h=o.outTangent*u,_=l.inTangent*u,f=c*c,d=f*c,p=d-2*f+c,m=d-f,v=-2*d+3*f;return(2*d-3*f+1)*o.value+p*h+m*_+v*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case eg.Loop:t=Pi(e-n,r-n)+n;break;case eg.PingPong:t=Di(e-n,r-n)+n;break;case eg.ClampForever:t=wi(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),s=a+1;return s===this.keyFrames.length&&(s-=1),this.calcOptimizedKey(this.cachedKey,a,s),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,s=r.value-n.value,o=1/(a*a),l=n.outTangent*a,c=r.inTangent*a;e.coefficient[0]=(l+c-s-s)*o/a,e.coefficient[1]=(s+s+s-l-l-c)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(this.keyFrames[i].time<t)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var s=i-a;if(0<=s&&this.keyFrames[s-1].time<=t)return s-1}for(var o=0,l=this.keyFrames.length,c=Math.floor((o+l)/2);1<l-o;)this.keyFrames[c].time>=t?l=c:o=c+1,c=Math.floor((o+l)/2);return o}}]),t}();ng.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],vi.fastDefine("cc.AnimationCurve",ng,{preWrapMode:eg.Default,postWrapMode:eg.Default,keyFrames:[]}),Zt.replaceProperty(yy.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]);var rg,ag,sg,og=Object.freeze({distance:zv,enums:Gm,intersect:vy,line:yy,plane:xy,ray:Ey,triangle:wy,sphere:ky,aabb:Py,obb:Ny,frustum:Vy,Octree:$y,Keyframe:tg,AnimationCurve:ng});(sg=ag||(ag={}))[sg.positions=Zt.GFXAttributeName.ATTR_POSITION]="positions",sg[sg.normals=Zt.GFXAttributeName.ATTR_NORMAL]="normals",sg[sg.uvs=Zt.GFXAttributeName.ATTR_TEX_COORD]="uvs",sg[sg.colors=Zt.GFXAttributeName.ATTR_COLOR]="colors";var lg=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_NORMAL,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RG32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA32F}],cg=new Xi;function ug(e,t,i){i=i||{};var n,r=[],a=0,s=[],o=0;if(0<e.positions.length){if(n=null,e.attributes){var l=e.attributes,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var _=h;if(_.name===Zt.GFXAttributeName.ATTR_POSITION){n=_;break}}}n||(n=lg[0]);var f=rl[n.format];r.push(n),o=Math.max(o,Math.floor(e.positions.length/f.count)),s.push({offset:a,data:e.positions,attribute:n}),a+=f.size}if(e.normals&&0<e.normals.length){if(n=null,e.attributes){var d=e.attributes,p=Array.isArray(d),m=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(m>=d.length)break;v=d[m++]}else{if((m=d.next()).done)break;v=m.value}var y=v;if(y.name===Zt.GFXAttributeName.ATTR_NORMAL){n=y;break}}}n||(n=lg[1]);var g=rl[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/g.count)),s.push({offset:a,data:e.normals,attribute:n}),a+=g.size}if(e.uvs&&0<e.uvs.length){if(n=null,e.attributes){var b=e.attributes,S=Array.isArray(b),T=0;for(b=S?b:b[Symbol.iterator]();;){var x;if(S){if(T>=b.length)break;x=b[T++]}else{if((T=b.next()).done)break;x=T.value}var E=x;if(E.name===Zt.GFXAttributeName.ATTR_TEX_COORD){n=E;break}}}n||(n=lg[2]);var w=rl[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/w.count)),s.push({offset:a,data:e.uvs,attribute:n}),a+=w.size}if(e.colors&&0<e.colors.length){if(n=null,e.attributes){var A=e.attributes,C=Array.isArray(A),k=0;for(A=C?A:A[Symbol.iterator]();;){var R;if(C){if(k>=A.length)break;R=A[k++]}else{if((k=A.next()).done)break;R=k.value}var O=R;if(O.name===Zt.GFXAttributeName.ATTR_COLOR){n=O;break}}}n||(n=lg[3]);var M=rl[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/M.count)),s.push({offset:a,data:e.colors,attribute:n}),a+=M.size}if(e.customAttributes){var L=e.customAttributes,I=Array.isArray(L),F=0;for(L=I?L:L[Symbol.iterator]();;){var P;if(I){if(F>=L.length)break;P=L[F++]}else{if((F=L.next()).done)break;P=F.value}var D=P,z=rl[D.attr.format];r.push(D.attr),o=Math.max(o,Math.floor(D.values.length/z.count)),s.push({offset:a,data:D.values,attribute:D.attr}),a+=z.size}}for(var B=new Fm,N=new ArrayBuffer(o*a),U=new DataView(N),G=0,V=s;G<V.length;G++){var H=V[G];dg(U,H.data,H.attribute.format,H.offset,a)}B.setNextAlignment(0);var j={attributes:r,view:{offset:B.getLength(),length:N.byteLength,count:o,stride:a}};B.addBuffer(N);var W=null,X=0;if(e.indices){var q=e.indices;X=q.length,W=new ArrayBuffer(2*X),dg(new DataView(W),q,Zt.GFXFormat.R16UI)}var Y={primitiveMode:e.primitiveMode||Zt.GFXPrimitiveMode.TRIANGLE_LIST,vertexBundelIndices:[0]};if(Y.primitiveMode>=Zt.GFXPrimitiveMode.TRIANGLE_LIST){var K=Float32Array.from(e.positions);B.setNextAlignment(4),Y.geometricInfo={doubleSided:e.doubleSided,view:{offset:B.getLength(),length:K.byteLength,count:e.positions.length/4,stride:4}},B.addBuffer(K.buffer)}W&&(B.setNextAlignment(2),Y.indexView={offset:B.getLength(),length:W.byteLength,count:X,stride:2},B.addBuffer(W));var Q=e.minPos;if(!Q&&i.calculateBounds){Q=Xi.set(new Xi,1/0,1/0,1/0);for(var Z=0;Z<o;++Z)Xi.set(cg,e.positions[3*Z+0],e.positions[3*Z+1],e.positions[3*Z+2]),Xi.min(Q,Q,cg)}var J=e.maxPos;if(!J&&i.calculateBounds){J=Xi.set(new Xi,-1/0,-1/0,-1/0);for(var $=0;$<o;++$)Xi.set(cg,e.positions[3*$+0],e.positions[3*$+1],e.positions[3*$+2]),Xi.max(J,J,cg)}var ee={vertexBundles:[j],primitives:[Y]};return Q&&(ee.minPosition=new Xi(Q.x,Q.y,Q.z)),J&&(ee.maxPosition=new Xi(J.x,J.y,J.z)),t||(t=new Dm),t.reset({struct:ee,data:new Uint8Array(B.getCombined())}),t}var hg=cc.sys.isLittleEndian,_g=(s(rg={},el.UNORM,"Uint"),s(rg,el.SNORM,"Int"),s(rg,el.UINT,"Uint"),s(rg,el.INT,"Int"),s(rg,el.UFLOAT,"Float"),s(rg,el.FLOAT,"Float"),s(rg,"default","Uint"),rg);function fg(e){return(_g[e.type]||_g.default)+e.size/e.count*8}function dg(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Zt.GFXFormat.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=rl[i];r||(r=a.size);for(var s="set"+fg(a),o=a.size/a.count,l=Math.floor(t.length/a.count),c=0;c<l;++c)for(var u=n+r*c,h=0;h<a.count;++h){var _=u+o*h;e[s](_,t[a.count*c+h],hg)}}function pg(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Zt.GFXFormat.R32F,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],s=rl[t];r||(r=s.size);for(var o="get"+fg(s),l=s.size/s.count,c=Math.floor(n/r),u=0;u<c;++u)for(var h=i+r*u,_=0;_<s.count;++_){var f=h+l*_;a[s.count*u+_]=e[o](f,hg)}return a}function mg(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Zt.GFXFormat.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length?arguments[6]:void 0;s||(s=new DataView(new ArrayBuffer(e.byteLength)));var o=rl[i];a||(a=o.size);for(var l="set"+fg(o),c="get"+fg(o),u=o.size/o.count,h=Math.floor(r/a),_=0;_<h;++_)for(var f=n+a*_,d=0;d<o.count;++d){var p=f+u*d,m=e[c](p,hg);s[l](p,t(m,d,e),hg)}return s}var vg=[],yg=function(e,t){if(e===t)return e;var i=t;for(vg.length=0;i;)vg.push(i),i=i.parent;for(i=e;i;){if(vg.find(function(e){return e===i}))return i;i=i.parent}return null},gg=new Xi;var bg=new(function(){function e(){y(this,e),this._cached=new Map}return l(e,[{key:"use",value:function(e,t){var i=this._cached.get(e);i||(i=new Map,this._cached.set(e,i));var n=i.get(t);return n||(n={bounds:function(e,t){for(var i=new Array(t.joints.length),n=0;n<i.length;++n)i[n]={hasValue:!1,min:new Xi(1/0,1/0,1/0),max:new Xi(-1/0,-1/0,-1/0)};for(var r=0;r<e.struct.primitives.length;++r){var a=e.readAttribute(r,Zt.GFXAttributeName.ATTR_JOINTS);if(a){var s=e.readAttribute(r,Zt.GFXAttributeName.ATTR_WEIGHTS);if(s){var o=e.readAttribute(r,Zt.GFXAttributeName.ATTR_POSITION);if(o)for(var l=Math.min(a.length/4,s.length/4,o.length/3),c=0;c<l;++c){Xi.set(cg,o[3*c+0],o[3*c+1],o[3*c+2]);for(var u=0;u<4;++u)if(0!==s[4*c+u]){var h=a[4*c+u];if(!(h>=t.joints.length)){t.bindposes?Xi.transformMat4(gg,cg,t.bindposes[h]):Xi.copy(gg,cg);var _=i[h];_.hasValue=!0,Xi.min(_.min,_.min,gg),Xi.max(_.max,_.max,gg)}}}}}}return i.map(function(e){return e.hasValue?Py.fromPoints(new Py,e.min,e.max):null})}(e,t),referenceCount:0},i.set(t,n)),++n.referenceCount,n.bounds}},{key:"unuse",value:function(e,t){var i=this._cached.get(e);if(i){var n=i.get(t);n&&(--n.referenceCount,0===n.referenceCount&&i.delete(t)),0===i.size&&this._cached.delete(e)}}}]),e}()),Sg=new Nn,Tg=new Nn,xg=new Py,Eg=new Xi,wg=new Xi;var Ag=Object.freeze({toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter(function(e,t){return t%4<3}).toString(),"\n")},createMesh:ug,readMesh:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},n=new DataView(e._nativeAsset),r=e.struct,a=r.primitives[t],s=a.vertexBundelIndices,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c,h=r.vertexBundles[u],_=h.view.offset,f=h.view,d=f.length,p=f.stride,m=h.attributes,v=Array.isArray(m),y=0;for(m=v?m:m[Symbol.iterator]();;){var g;if(v){if(y>=m.length)break;g=m[y++]}else{if((y=m.next()).done)break;g=y.value}var b=g,S=ag[b.name];S&&(i[S]=(i[S]||[]).concat(pg(n,b.format,_,d,p))),_+=rl[b.format].size}}var T=a.indexView;return i.indices=pg(n,Zt.GFXFormat["R".concat(8*T.stride,"UI")],T.offset,T.length),i},writeBuffer:dg,readBuffer:pg,mapBuffer:mg,LCA:yg,calculateSkinnedBounds:function(e,t){if(t.model&&t.mesh){var i=t.skeleton,n=t.skinningRoot,r=t.model.uploadedAnim;if(!i||!n||!r){if(!t.model.worldBounds)return;return Py.copy(e,t.model.worldBounds),!0}Xi.set(Eg,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Xi.set(wg,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n.getWorldMatrix(Sg);for(var a=bg.use(t.mesh,i),s=i.joints.length,o=r.convertedData,l=t.model.getFrameID(),c=0;c<s;++c){var u=a[c],h=o[i.joints[c]];if(u&&h&&h.props){var _=h.props.worldMatrix.values[l];Nn.multiply(Tg,Sg,_),Py.transform(xg,u,Tg),xg.getBoundary(cg,gg),Xi.min(Eg,Eg,cg),Xi.max(wg,wg,gg)}}return Py.fromPoints(e,Eg,wg),!0}},find:Cd}),Cg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.INPUT_ASSEMBLER)))._device=void 0,t._attributes=[],t._vertexBuffers=[],t._indexBuffer=null,t._vertexCount=0,t._firstVertex=0,t._indexCount=0,t._firstIndex=0,t._vertexOffset=0,t._instanceCount=0,t._firstInstance=0,t._isIndirect=!1,t._indirectBuffer=null,t._device=e,t}return d(i,$o),l(i,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),l(i,[{key:"getVertexBuffer",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],a=0,s=Zt.GFXFormat.UNKNOWN,o=this._attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===t){s=h.format;break}a+=rl[h.format].size}var _=this._vertexBuffers[n];s&&_&&(dg(new DataView(e),i,s,a,_.stride),r&&_.update(e,0,_.stride*_.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,n=this._indexBuffer;i&&n&&(dg(new DataView(e),t,Zt.GFXFormat["R".concat(8*n.stride,"UI")]),n.update(e,0,n.stride*n.count),this._indexCount=t.length)}}]),i}(),kg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.PIPELINE_LAYOUT)))._device=void 0,t._pushConstantsRanges=[],t._layouts=[],t._device=e,t}return d(i,$o),l(i,[{key:"layouts",get:function(){return this._layouts}}]),i}(),Rg=function(){function e(){y(this,e),this.isDiscard=!1,this.polygonMode=eo.FILL,this.shadeModel=io.GOURAND,this.cullMode=ro.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return l(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),Og=function(){function e(){y(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=so.LESS,this.stencilTestFront=!1,this.stencilFuncFront=so.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=lo.KEEP,this.stencilZFailOpFront=lo.KEEP,this.stencilPassOpFront=lo.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=so.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=lo.KEEP,this.stencilZFailOpBack=lo.KEEP,this.stencilPassOpBack=lo.KEEP,this.stencilRefBack=1}return l(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),Mg=function(){function e(){y(this,e),this.blend=!1,this.blendSrc=_o.ONE,this.blendDst=_o.ZERO,this.blendEq=uo.ADD,this.blendSrcAlpha=_o.ONE,this.blendDstAlpha=_o.ZERO,this.blendAlphaEq=uo.ADD,this.blendColorMask=po.ALL}return l(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),Lg=function e(){y(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new Mg]},Ig=function e(){y(this,e),this.attributes=[]},Fg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.PIPELINE_STATE)))._device=void 0,t._shader=null,t._primitive=Zt.GFXPrimitiveMode.TRIANGLE_LIST,t._is=null,t._rs=null,t._dss=null,t._bs=null,t._dynamicStates=[],t._layout=null,t._renderPass=null,t._device=e,t}return d(i,$o),l(i,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}}]),i}(),Pg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.QUEUE)))._device=void 0,t._type=Ko.GRAPHICS,t._device=e,t}return d(i,$o),l(i,[{key:"type",get:function(){return this._type}}]),i}(),Dg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.RENDER_PASS)))._device=void 0,t._colorInfos=[],t._depthStencilInfo=null,t._device=e,t}return d(i,$o),i}(),zg=function(){function e(){y(this,e),this.name="",this.minFilter=vo.LINEAR,this.magFilter=vo.LINEAR,this.mipFilter=vo.NONE,this.addressU=go.WRAP,this.addressV=go.WRAP,this.addressW=go.WRAP,this.maxAnisotropy=16,this.cmpFunc=so.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return l(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),Bg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.SAMPLER)))._device=void 0,t._state=new zg,t._device=e,t}return d(i,$o),l(i,[{key:"state",get:function(){return this._state}}]),i}(),Ng=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.SHADER)))._device=void 0,t._id=void 0,t._name="",t._stages=[],t._blocks=[],t._samplers=[],t._device=e,t._id=e.genShaderId(),t}return d(i,$o),l(i,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),i}(),Ug=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.TEXTURE)))._device=void 0,t._type=So.TEX2D,t._usage=xo.NONE,t._format=Zt.GFXFormat.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._arrayLayer=1,t._mipLevel=1,t._samples=wo.X1,t._flags=Co.NONE,t._isPowerOf2=!1,t._size=0,t._buffer=null,t._device=e,t}return d(i,$o),l(i,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),i}();cc.GFXDevice=Rl,cc.GFXBuffer=Mm,cc.GFXTexture=Ug,cc.GFXTextureView=Om,cc.GFXSampler=Bg,cc.GFXShader=Ng,cc.GFXInputAssembler=Cg,cc.GFXRenderPass=Dg,cc.GFXFramebuffer=Im,cc.GFXPipelineLayout=kg,cc.GFXPipelineState=Fg,cc.GFXCommandBuffer=Lm,cc.GFXQueue=Pg,Object.assign(cc,bl);var Gg,Vg,Hg,jg=function(){function t(e){y(this,t),this._device=void 0,this._format=Zt.GFXFormat.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new nl,this._region1=new nl,this._region2=new nl,this._roundUpFn=null,this._inOrderFree=!1,this._device=e}return l(t,[{key:"initialize",value:function(e){return this._format=e.format,this._formatSize=rl[this._format].size,this._chunks=new Array(e.maxChunks),this._roundUpFn=e.roundUpFn||null,this._inOrderFree=e.inOrderFree||!1,!0}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.splice(0),this._handles.splice(0)}},{key:"alloc",value:function(l){var c=this;if(0===l)return null;for(var e=function(t){var e=c._chunks[t],i=!1,n=e.start;if(n+l<=e.end)i=!0;else if(c._inOrderFree)n>e.end?n+l<=e.size?i=!0:l<=e.end&&(e.start=n=0,i=!0):n===e.end&&(e.start=n=0,e.end=e.size,l<=e.end&&(i=!0));else{n=0;for(var r=c._handles.filter(function(e){return e.chunkIdx===t}).sort(function(e,t){return e.start-t.start}),a=0;a<r.length;a++){var s=r[a];if(n+l<=s.start){i=!0;break}n=s.end}!i&&n+l<=e.size&&(i=!0)}if(i){e.start+=l;var o={chunkIdx:t,start:n,end:n+l,texture:e.texture,texView:e.texView};return c._handles.push(o),{v:o}}},t=0;t<this._chunkCount;++t){var i=e(t);if("object"===fe(i))return i.v}if(this._chunkCount>=this._chunks.length)return console.error("TextureBufferPool: Reach max chunk count."),null;var n=Math.sqrt(l/this._formatSize),r=this._roundUpFn&&this._roundUpFn(n)||Math.max(1024,function(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}(n)),a=r*r*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+a);var s=this._device.createTexture({type:So.TEX2D,usage:xo.SAMPLED,format:this._format,width:r,height:r,mipLevel:1}),o=this._device.createTextureView({texture:s,type:Ro.TV2D,format:this._format}),u={chunkIdx:this._chunkCount,start:0,end:l,texture:s,texView:o};return this._handles.push(u),this._chunks[this._chunkCount++]={texture:s,texView:o,size:a,start:l,end:a},u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,s=r%e.texture.width,o=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-s,a),c=0;0<s&&(this._region0.texOffset.x=s,this._region0.texOffset.y=o,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(t.slice(c*this._formatSize,(c+l)*this._formatSize)),n.push(this._region0),s=0,o+=1,a-=l,c+=l),0<a&&(this._region1.texOffset.x=s,this._region1.texOffset.y=o,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(t.slice(c*this._formatSize,(c+l)*this._formatSize)),n.push(this._region1),s=0,o+=this._region1.texExtent.height,a-=l,c+=l),0<a&&(this._region2.texOffset.x=s,this._region2.texOffset.y=o,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(t.slice(c*this._formatSize,(c+a)*this._formatSize)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}}]),t}(),Wg=function(e,t,i,n){Nn.toRTS(i,Jg,Zg,$g),n?vn.copy(Kg,Jg):vn.dot(Kg,Jg)<0&&vn.multiplyScalar(Jg,Jg,-1);vn.set(Qg,Zg.x,Zg.y,Zg.z,0),vn.multiplyScalar(Qg,vn.multiply(Qg,Qg,Jg),.5),e[t+0]=Jg.x,e[t+1]=Jg.y,e[t+2]=Jg.z,e[t+3]=Jg.w,e[t+4]=Qg.x,e[t+5]=Qg.y,e[t+6]=Qg.z,e[t+7]=Qg.w,e[t+8]=$g.x,e[t+9]=$g.y,e[t+10]=$g.z};function Xg(e){return e.hasFeature(yl.TEXTURE_FLOAT)?Vg.RGBA32F:Vg.RGBA8}(Hg=Vg||(Vg={}))[Hg.NONE=0]="NONE",Hg[Hg.RGBA8=1]="RGBA8",Hg[Hg.RGBA32F=2]="RGBA32F";var qg=Object.freeze(new Nn),Yg=new Nn,Kg=new vn,Qg=new vn,Zg=new Xi,Jg=new vn,$g=new Xi;function eb(e){return Math.max(180,12*Math.ceil(e/12))}var tb,ib,nb,rb,ab=(s(Gg={},Vg.RGBA8,Zt.GFXFormat.RGBA8),s(Gg,Vg.RGBA32F,Zt.GFXFormat.RGBA32F),Gg),sb=function(){function t(e){y(this,t),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=0,this._device=e,this._pool=new jg(e)}return l(t,[{key:"initialize",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:8,t=ab[Xg(this._device)];this._formatSize=rl[t].size;var i=16/this._formatSize;this._pool.initialize({format:t,maxChunks:e*i,roundUpFn:eb})}},{key:"destroy",value:function(){this._pool.destroy()}},{key:"getDefaultJointsTexture",value:function(e){var t=e&&e.joints.length||1,i=this._textureBuffers.get(t)||null;if(i)return i.refCount++,i;var n=this._pool.alloc(12*t*Float32Array.BYTES_PER_ELEMENT);if(!n)return null;i={pixelOffset:n.start/this._formatSize,refCount:1,hash:t,handle:n};for(var r=new Float32Array(12*t),a=0;a<t;a++)Wg(r,12*a,qg,0===a);return this._pool.update(n,r.buffer),this._textureBuffers.set(t,i),i}},{key:"getJointsTextureWithAnimation",value:function(e,t){var i=e.hash^t.hash,n=this._textureBuffers.get(i)||null;if(n)return n.refCount++,n;var r=t.keys[0].length,a=12*e.joints.length*r,s=this._pool.alloc(a*Float32Array.BYTES_PER_ELEMENT);if(!s)return null;n={pixelOffset:s.start/this._formatSize,refCount:1,hash:i,handle:s};for(var o=new Float32Array(a),l=t.convertedData,c=0;c<e.joints.length;c++){var u=l[e.joints[c]];if(u&&u.props)for(var h=e.bindposes[c],_=u.props.worldMatrix.values,f=0;f<r;f++){var d=_[f];Nn.multiply(Yg,d,h),Wg(o,12*(r*c+f),Yg,0===c)}}return this._pool.update(s,o.buffer),this._textureBuffers.set(i,n),n}},{key:"releaseTexture",value:function(e){0==--e.refCount&&(this._pool.free(e.handle),this._textureBuffers.delete(e.hash))}}]),t}(),ob=[{name:"builtin-billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:2102903729,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2715236896,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    if (camUp.y < 0.) {\n        camUp *= -1.;\n    }\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    if (camUp.y < 0.) {\n        camUp *= -1.;\n    }\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture2D(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean",defines:[]},{name:"CC_USE_WORLD_SPACE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:1172010056,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    in vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n#if CC_USE_MESH\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_texCoord3, 1);\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), a_position);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), a_position, compScale);\n    pos = xform * pos;\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n#else\n    vec4 pos = vec4(a_position, 1);\n    #if CC_USE_STRETCHED_BILLBOARD\n        vec4 velocity = vec4(a_color1.xyz, 0);\n    #endif\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), a_texCoord1\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    attribute vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n#if CC_USE_MESH\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_texCoord3, 1);\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), a_position);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), a_position, compScale);\n    pos = xform * pos;\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n#else\n    vec4 pos = vec4(a_position, 1);\n    #if CC_USE_STRETCHED_BILLBOARD\n        vec4 velocity = vec4(a_color1.xyz, 0);\n    #endif\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), a_texCoord1\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_USE_WORLD_SPACE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:3858821905,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean",defines:[]},{name:"USE_TEXTURE",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}],dependencies:{}}]},{name:"builtin-standard",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},albedo:{value:[1,1,1,1],inspector:{type:"color"},type:16},albedoScale:{value:[1,1,1,0],type:16},pbrParams:{value:[.8,.6,1,1],type:16},pbrScale:{value:[1,1,1,1],type:16},emissive:{value:[0,0,0,1],inspector:{type:"color"},type:16},emissiveScale:{value:[1,1,1,1],type:16},albedoMap:{value:"grey",type:28},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:1460149064,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  vec4 pos = cc_matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((cc_matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((cc_matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_tangent, v_normal) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL+V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL+V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec3 albedo;\n  float alpha;\n  vec3 position;\n  vec3 normal;\n  float roughness;\n  float metallic;\n  float occlusion;\n  vec3 emissive;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec3 env = SRGBToLinear(texture(cc_environment, R).rgb) * cc_ambientSky.w;\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.alpha);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nin vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 v_uv;\n#endif\nin vec3 v_normal;\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor.rgb * albedoScale.xyz;\n  s.alpha = baseColor.a;\n  #if USE_ALPHA_TEST\n    if(s.ALPHA_TEST_CHANNEL < albedoScale.w)\n      discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform mat4 cc_matWorldIT;\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform vec4 tilingOffset;\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  vec4 pos = cc_matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((cc_matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((cc_matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_tangent, v_normal) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_cameraPos;\nuniform vec4 cc_exposure;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_mainLitColor;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL+V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL+V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec3 albedo;\n  float alpha;\n  vec3 position;\n  vec3 normal;\n  float roughness;\n  float metallic;\n  float occlusion;\n  vec3 emissive;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec3 env = SRGBToLinear(textureCube(cc_environment, R).rgb) * cc_ambientSky.w;\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.alpha);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScale;\nuniform vec4 pbrParams;\nuniform vec4 pbrScale;\nuniform vec4 emissive;\nuniform vec4 emissiveScale;\nvarying vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  varying vec2 v_uv;\n#endif\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor.rgb * albedoScale.xyz;\n  s.alpha = baseColor.a;\n  #if USE_ALPHA_TEST\n    if(s.ALPHA_TEST_CHANNEL < albedoScale.w)\n      discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture2D(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture2D(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,2]},{name:"USE_NORMAL_MAP",type:"boolean",defines:[]},{name:"USE_ALBEDO_MAP",type:"boolean",defines:[]},{name:"CC_USE_IBL",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_PBR_MAP",type:"boolean",defines:[]},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean",defines:[]},{name:"USE_OCCLUSION_MAP",type:"boolean",defines:[]},{name:"USE_EMISSIVE_MAP",type:"boolean",defines:[]},{name:"ROUGHNESS_CHANNEL",type:"string",defines:[],options:["r","g","b","a"]},{name:"METALLIC_CHANNEL",type:"string",defines:[],options:["g","r","b","a"]},{name:"OCCLUSION_CHANNEL",type:"string",defines:[],options:["b","r","g","a"]},{name:"USE_ALPHA_TEST",type:"boolean",defines:[]},{name:"ALPHA_TEST_CHANNEL",type:"string",defines:["USE_ALPHA_TEST"],options:["alpha","albedo.r","albedo.g","albedo.b"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScale",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"pbrScale",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScale",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}],dependencies:{}}]},{name:"builtin-terrain",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:3405213441,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 uvw;\nout vec2 uv0;\nout vec2 uv1;\nout vec2 uv2;\nout vec2 uv3;\nout vec3 diffuse;\nuniform TexCoords {\n  vec4 UVScale;\n};\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 uvw;\nvarying vec2 uv0;\nvarying vec2 uv1;\nvarying vec2 uv2;\nvarying vec2 uv3;\nvarying vec3 diffuse;\nuniform vec4 UVScale;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"LAYERS",type:"number",defines:[],range:[0,3]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:30},{name:"detailMap0",type:28,count:1,defines:[],binding:31},{name:"detailMap1",type:28,count:1,defines:[],binding:32},{name:"detailMap2",type:28,count:1,defines:[],binding:33},{name:"detailMap3",type:28,count:1,defines:[],binding:34}],dependencies:{}}]},{name:"builtin-unlit",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{color:{value:[1,1,1,1],inspector:{type:"color"},type:16},tilingOffset:{value:[1,1,0,0],type:16},mainTexture:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:3672903250,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp vec4 pos = cc_matViewProj * cc_matWorld * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n  #if FLIP_UV\n    v_uv.y = 1.0 - v_uv.y;\n  #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform Constant {\n    vec4 color;\n  };\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp vec4 pos = cc_matViewProj * cc_matWorld * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n  #if FLIP_UV\n    v_uv.y = 1.0 - v_uv.y;\n  #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean",defines:[]},{name:"USE_TEXTURE",type:"boolean",defines:[]},{name:"FLIP_UV",type:"boolean",defines:["USE_TEXTURE"]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_COLOR",type:"boolean",defines:[]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:["USE_COLOR"],binding:1,members:[{name:"color",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}],dependencies:{}}]},{name:"editor/terrain-circle-brush",techniques:[{name:"transparent",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"editor/terrain-circle-brush|terrain-brush-vs:vert|terrain-brush-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{BrushPos:{value:[0,0,0,1],type:16},BrushParams:{value:[2.5,2.5,0,0],type:16}}}]}],shaders:[{name:"editor/terrain-circle-brush|terrain-brush-vs:vert|terrain-brush-fs:frag",hash:502409078,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nout vec4 wposition;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  wposition = cc_matWorld * pos;\n  wposition.y += 0.01;\n  pos = cc_matViewProj * wposition;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec4 wposition;\nuniform TexCoords {\n  vec4 BrushPos;\n  vec4 BrushParams;\n};\nvec4 frag () {\n  float Radius = BrushParams.x;\n  float Falloff = BrushParams.y;\n  float Distance = length(wposition.xz - BrushPos.xz);\n  float k = 0.0;\n  #if LINEAR\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n  #elif SMOOTH\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Distance - Radius) / Falloff;\n      k = sqrt(1.0 - y * y);\n    }\n  #elif SPHERICAL\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n    k = k*k*(3 - 2 * k);\n  #elif TIP\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Falloff + Radius - Distance) / Falloff;\n      k = 1.0 - sqrt(1.0 - y * y);\n    }\n  #endif\n  vec4 color = vec4(0, 0, 0, 0);\n  color.rgb = vec3(100, 100, 135) / 255.0;\n  color.a = 0.85 * k;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvarying vec4 wposition;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  wposition = cc_matWorld * pos;\n  wposition.y += 0.01;\n  pos = cc_matViewProj * wposition;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec4 wposition;\nuniform vec4 BrushPos;\nuniform vec4 BrushParams;\nvec4 frag () {\n  float Radius = BrushParams.x;\n  float Falloff = BrushParams.y;\n  float Distance = length(wposition.xz - BrushPos.xz);\n  float k = 0.0;\n  #if LINEAR\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n  #elif SMOOTH\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Distance - Radius) / Falloff;\n      k = sqrt(1.0 - y * y);\n    }\n  #elif SPHERICAL\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n    k = k*k*(3 - 2 * k);\n  #elif TIP\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Falloff + Radius - Distance) / Falloff;\n      k = 1.0 - sqrt(1.0 - y * y);\n    }\n  #endif\n  vec4 color = vec4(0, 0, 0, 0);\n  color.rgb = vec3(100, 100, 135) / 255.0;\n  color.a = 0.85 * k;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"LINEAR",type:"boolean",defines:[]},{name:"SMOOTH",type:"boolean",defines:[]},{name:"SPHERICAL",type:"boolean",defines:[]},{name:"TIP",type:"boolean",defines:[]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"BrushPos",type:16,count:1},{name:"BrushParams",type:16,count:1}]}],samplers:[],dependencies:{}}]},{name:"pipeline/planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilWriteMaskBack:128,stencilWriteMaskFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilRefBack:128,stencilRefFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3864035573,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  position = cc_matViewProj * cc_matLightPlaneProj * cc_matWorld * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsTextureInfo.z * i + cc_jointsTextureInfo.w) + cc_jointsTextureInfo.y;\n    highp float invSize = 1.0 / cc_jointsTextureInfo.x;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  position = cc_matViewProj * cc_matLightPlaneProj * cc_matWorld * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_shadowColor;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,2]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[],samplers:[],dependencies:{}}]},{name:"pipeline/skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:3895563201,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nout vec4 viewDir;\nvec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = cc_matProj * matViewRotOnly * viewDir;\n  pos.z = pos.w * 0.99999;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n    c = LinearToSRGB(c / (1.0 + c));\n    vec4 o = vec4(c, 1.0);\n  #else\n    vec4 o = texture(cc_environment, viewDir.xyz);\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nvarying vec4 viewDir;\nvec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = cc_matProj * matViewRotOnly * viewDir;\n  pos.z = pos.w * 0.99999;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform vec4 cc_exposure;\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n    c = LinearToSRGB(c / (1.0 + c));\n    vec4 o = vec4(c, 1.0);\n  #else\n    vec4 o = textureCube(cc_environment, viewDir.xyz);\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_RGBE_CUBEMAP",type:"boolean",defines:[]}],blocks:[],samplers:[],dependencies:{}}]},{name:"pipeline/smaa",techniques:[{name:"smaa",passes:[{program:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{type:28,samplerHash:66186}}},{program:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_edgeTexSampler:{type:28,samplerHash:66186},u_areaTexSampler:{type:28,samplerHash:66186},u_searchTexSampler:{type:28,samplerHash:66181}}}]}],shaders:[{name:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",hash:734353496,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture2D(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture2D(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture2D(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture2D(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture2D(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture2D(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture2D(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30}],dependencies:{}},{name:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",hash:1697076750,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nout vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 v_uv;\nin vec4 v_offsets[3];\nin vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture2D(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture2D(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture2D(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture2D(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture2D(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[],samplers:[{name:"u_edgeTexSampler",type:28,count:1,defines:[],binding:30},{name:"u_areaTexSampler",type:28,count:1,defines:[],binding:31},{name:"u_searchTexSampler",type:28,count:1,defines:[],binding:32}],dependencies:{}}]},{name:"pipeline/tonemap",techniques:[{name:"tonemap",passes:[{program:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{type:28,samplerHash:66186},u_blendTexSampler:{type:28,samplerHash:66186}}}]}],shaders:[{name:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",hash:433933566,glsl3:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture(u_blendTexSampler, v_uv).rb;\n    a.g = texture(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture2D(u_blendTexSampler, v_uv).rb;\n    a.g = texture2D(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture2D(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture2D(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture2D(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture2D(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture2D(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"CC_USE_SMAA",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30},{name:"u_blendTexSampler",type:28,count:1,defines:[],binding:31}],dependencies:{}}]},{name:"util/profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},offset:{type:16}}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:3710757766,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nin vec2 a_texCoord;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n};\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_texCoord;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 offset;\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_texCoord;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]}],lb=function(){function e(){y(this,e),this._device=null,this._resources={}}return l(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new Ol(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var s=new fh;s._uuid="black-texture",s.image=r,t[s._uuid]=s;var o=new Ef;o._uuid="black-cube-texture",o.setMipFilter(Ef.Filter.LINEAR),o.image={front:new Ol(i),back:new Ol(i),left:new Ol(i),right:new Ol(i),top:new Ol(i),bottom:new Ol(i)},o.onLoaded(),t[o._uuid]=o,n.fillStyle="#777",n.fillRect(0,0,a,a);var l=new fh;l._uuid="grey-texture",l.image=r,l.onLoaded(),t[l._uuid]=l,n.fillStyle="#fff",n.fillRect(0,0,a,a);var c=new fh;c._uuid="white-texture",c.image=r,c.onLoaded(),t[c._uuid]=c;var u=new Ef;u._uuid="white-cube-texture",u.setMipFilter(Ef.Filter.LINEAR),u.image={front:new Ol(i),back:new Ol(i),left:new Ol(i),right:new Ol(i),top:new Ol(i),bottom:new Ol(i)},u.onLoaded(),t[u._uuid]=u,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var h=new fh;h._uuid="normal-texture",h.image=r,t[h._uuid]=h,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var _=new fh;_._uuid="default-texture",_.image=r,_.onLoaded(),t[_._uuid]=_;var f=new Ef;f.setMipFilter(Ef.Filter.LINEAR),f._uuid="default-cube-texture",f.image={front:new Ol(i),back:new Ol(i),left:new Ol(i),right:new Ol(i),top:new Ol(i),bottom:new Ol(i)},f.onLoaded(),t[f._uuid]=f;var d=new bh;d.texture.image=r,d._uuid="default-spriteframe",t[d._uuid]=d,ob.forEach(function(e){Object.assign(new cc.EffectAsset,e).onLoaded()});var p=new cc.Material;p._uuid="standard-material",p.initialize({effectName:"builtin-standard"}),p.onLoaded(),t[p._uuid]=p;var m=new cc.Material;m._uuid="missing-material",m.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),m.setProperty("color",cc.color("#ff00ff")),m.onLoaded(),t[m._uuid]=m;var v=new cc.Material;v._uuid="missing-skinning-material";var y=Xg(e);v.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,CC_USE_SKINNING:y}}),v.setProperty("color",cc.color("#ff00ff")),v.onLoaded(),t[v._uuid]=v;var g=new cc.Material;g._uuid="missing-effect-material",g.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),g.setProperty("color",cc.color("#ffff00")),g.onLoaded(),t[g._uuid]=g;var b=new cc.Material;b._uuid="ui-base-material",b.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),b.onLoaded(),t[b._uuid]=b;var S=new cc.Material;S._uuid="ui-sprite-material",S.initialize({defines:{USE_TEXTURE:!0},effectName:"builtin-sprite"}),S.onLoaded(),t[S._uuid]=S;var T=new cc.Material;T._uuid="default-particle-material",T.initialize({effectName:"builtin-particle"}),T.onLoaded(),t[T._uuid]=T;var x=new cc.Material;x._uuid="default-trail-material",x.initialize({effectName:"builtin-particle-trail"}),x.onLoaded(),t[x._uuid]=x;var E=new cc.Material;E._uuid="default-billboard-material",E.initialize({effectName:"builtin-billboard"}),E.onLoaded(),t[E._uuid]=E}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),cb=cc.builtinResMgr=new lb,ub=(tb=new Map,ib=0,function(e){return tb.has(e)||(tb.set(e,1<<ib),ib++),tb.get(e)}),hb=(s(nb={},js.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(nb,js.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ui.array(e,t,2*i)}),s(nb,js.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Xi.array(e,t,3*i)}),s(nb,js.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return $i.array(e,t,4*i)}),s(nb,js.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(nb,js.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ui.array(e,t,2*i)}),s(nb,js.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Xi.array(e,t,3*i)}),s(nb,js.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return $i.array(e,t,4*i)}),s(nb,js.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return un.array(e,t,9*i)}),s(nb,js.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Nn.array(e,t,16*i)}),nb),_b=(s(rb={},js.INT,[0]),s(rb,js.INT2,[0,0]),s(rb,js.INT3,[0,0,0]),s(rb,js.INT4,[0,0,0,0]),s(rb,js.FLOAT,[0]),s(rb,js.FLOAT2,[0,0]),s(rb,js.FLOAT3,[0,0,0]),s(rb,js.FLOAT4,[0,0,0,0]),s(rb,js.MAT3,[1,0,0,0,1,0,0,0,1]),s(rb,js.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),s(rb,js.SAMPLER2D,"default-texture"),s(rb,js.SAMPLER_CUBE,"default-cube-texture"),rb),fb=4026531840,db=264241152,pb=function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;return e<<28&fb|i<<22&db|t<<11&4192256|2047&n},mb=function(e){return e>=im.CUSTUM_UBO_BINDING_END_POINT},vb=function(){function _(e){y(this,_),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=0,this._idxInTech=0,this._programName="",this._priority=Yp.DEFAULT,this._primitive=Zt.GFXPrimitiveMode.TRIANGLE_LIST,this._stage=Xp.DEFAULT,this._bindings=[],this._bs=new Lg,this._dss=new Og,this._rs=new Rg,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._device=void 0,this._renderPass=null,this._shader=null,this._device=e}return l(_,null,[{key:"createPasses",value:function(e,t){if(!e.techniques)return[];for(var i=t.techIdx,n=t.defines,r=t.states,a=e.techniques[i||0],s=a.passes.length,o=[],l=0;l<s;++l){var c=a.passes[l],u=c.curDefs=n.length>l?n[l]:{};if(!c.switch||u[c.switch]){c.states=r.length>l?r[l]:{},c.idxInTech=l;var h=new _(cc.game._gfxDevice);h.initialize(c),o.push(h)}}return o}}]),l(_,[{key:"initialize",value:function(e){var o=this;this._idxInTech=e.idxInTech,this._programName=e.program,this._defines=e.curDefs,this._shaderInfo=xm.getTemplate(e.program),this._properties=e.properties||this._properties;var t=this._device;this._fillinPipelineInfo(e),this._fillinPipelineInfo(e.states);var i=function(){if(r){if(l>=n.length)return"break";c=n[l++]}else{if((l=n.next()).done)return"break";c=l.value}var a=c;if(mb(a.binding))return"continue";var e=a.members.reduce(function(e,t){return e+ol(t.type)*t.count},0);o._buffers[a.binding]=t.createBuffer({memUsage:Ks.HOST|Ks.DEVICE,size:16*Math.ceil(e/16),usage:qs.UNIFORM|qs.TRANSFER_DST});var s=o._blocks[a.binding]={buffer:new ArrayBuffer(e),dirty:!1,views:[]};a.members.reduce(function(e,t,i){var n=ol(t.type)*t.count,r=new Float32Array(s.buffer,e,n/Float32Array.BYTES_PER_ELEMENT);return s.views.push(r),o._handleMap[t.name]=pb(Io.UNIFORM_BUFFER,a.binding,t.type,i),e+n},0)};var n=this._shaderInfo.blocks,r=Array.isArray(n),l=0;e:for(n=r?n:n[Symbol.iterator]();;){var c;switch(i()){case"break":break e;case"continue":continue}}var a=this._shaderInfo.samplers,s=Array.isArray(a),u=0;for(a=s?a:a[Symbol.iterator]();;){var h;if(s){if(u>=a.length)break;h=a[u++]}else{if((u=a.next()).done)break;h=u.value}var _=h;this._handleMap[_.name]=pb(Io.SAMPLER,_.binding,_.type)}this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){return this._handleMap[e]}},{key:"getBinding",value:function(e){var t=this.getHandle(e);if(void 0!==t)return _.getBindingFromHandle(t)}},{key:"setUniform",value:function(e,t){var i=_.getBindingFromHandle(e),n=_.getTypeFromHandle(e),r=_.getIndexFromHandle(e),a=this._blocks[i];hb[n](a.views[r],t),a.dirty=!0}},{key:"setUniformArray",value:function(e,t){for(var i=_.getBindingFromHandle(e),n=_.getTypeFromHandle(e),r=_.getIndexFromHandle(e),a=this._blocks[i],s=0;s<t.length;s++)null!==t[s]&&hb[n](a.views[r],t[s],s);a.dirty=!0}},{key:"bindBuffer",value:function(e,t){this._buffers[e]=t;var i=this._resources,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.bindingLayout.bindBuffer(e,t)}}},{key:"bindTextureView",value:function(e,t){this._textureViews[e]=t;var i=this._resources,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.bindingLayout.bindTextureView(e,t)}}},{key:"bindSampler",value:function(e,t){this._samplers[e]=t;var i=this._resources,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.bindingLayout.bindSampler(e,t)}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){this._bs=new Lg,this._dss=new Og,this._rs=new Rg,this._fillinPipelineInfo(e),this._fillinPipelineInfo(t)}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals.samplers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=n.get(l.name);c.sampler&&this.bindSampler(c.samplerInfo.binding,c.sampler),this.bindTextureView(c.samplerInfo.binding,c.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;mb(r.binding)||this._buffers[r.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={}}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!mb(r.binding)){for(var a=this._blocks[r.binding],s=0;s<r.members.length;s++)for(var o=r.members[s],l=a.views[s],c=this._properties[o.name],u=c&&c.value,h=u||_b[o.type],_=0;_<o.count;_++)l.set(h,_*h.length);a.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._device,t=this._shaderInfo.samplers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=this._properties[a.name];s&&void 0!==s.samplerHash&&(this._samplers[a.binding]=Yl.getSampler(e,s.samplerHash));var o=s&&s.value?s.value+"-texture":_b[a.type],l=cb.get(o);if(l){this._textureViews[a.binding]=l.getGFXTextureView();var c=l.getSamplerHash();(!this._samplers[a.binding]||0<c)&&(this._samplers[a.binding]=Yl.getSampler(e,c))}else console.warn("illegal texture default value "+o)}}},{key:"tryCompile",value:function(e){var i=this;e&&Object.assign(this._defines,e);var t=cc.director.root.pipeline;return!!t&&(this._renderPass=t.getRenderPass(this._stage),this._renderPass?(this._shader=xm.getGFXShader(this._device,this._programName,this._defines,t),this._shader?(this._bindings=this._shaderInfo.blocks.reduce(function(e,t){return t.defines.every(function(e){return i._defines[e]})&&e.push({name:t.name,binding:t.binding,type:Io.UNIFORM_BUFFER}),e},[]).concat(this._shaderInfo.samplers.reduce(function(e,t){return t.defines.every(function(e){return i._defines[e]})&&e.push({name:t.name,binding:t.binding,type:Io.SAMPLER}),e},[])),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):(console.warn("illegal pass stage."),!1))}},{key:"createPipelineState",value:function(){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;for(var e=this._device.createBindingLayout({bindings:this._bindings}),t=0,i=Object.keys(this._buffers);t<i.length;t++){var n=i[t];e.bindBuffer(parseInt(n),this._buffers[n])}for(var r=0,a=Object.keys(this._samplers);r<a.length;r++){var s=a[r];e.bindSampler(parseInt(s),this._samplers[s])}for(var o=0,l=Object.keys(this._textureViews);o<l.length;o++){var c=l[o];e.bindTextureView(parseInt(c),this._textureViews[c])}var u=cc.director.root.pipeline.globalBindings,h=this._shaderInfo.builtins.globals,_=h.blocks,f=Array.isArray(_),d=0;for(_=f?_:_[Symbol.iterator]();;){var p;if(f){if(d>=_.length)break;p=_[d++]}else{if((d=_.next()).done)break;p=d.value}var m=p,v=u.get(m.name);v&&v.type===Io.UNIFORM_BUFFER?e.bindBuffer(v.blockInfo.binding,v.buffer):console.warn("builtin UBO '".concat(m.name,"' not available!"))}var y=h.samplers,g=Array.isArray(y),b=0;for(y=g?y:y[Symbol.iterator]();;){var S;if(g){if(b>=y.length)break;S=y[b++]}else{if((b=y.next()).done)break;S=b.value}var T=S,x=u.get(T.name);x&&x.type===Io.SAMPLER?(x.sampler&&e.bindSampler(x.samplerInfo.binding,x.sampler),e.bindTextureView(x.samplerInfo.binding,x.textureView)):console.warn("builtin texture '".concat(T.name,"' not available!"))}var E=this._device.createPipelineLayout({layouts:[e]}),w=this._device.createPipelineState({bs:this._bs,dss:this._dss,dynamicStates:this._dynamicStates,is:new Ig,layout:E,primitive:this._primitive,renderPass:this._renderPass,rs:this._rs,shader:this._shader});return this._resources.push({bindingLayout:e,pipelineLayout:E,pipelineState:w}),w}},{key:"destroyPipelineState",value:function(t){var e=this._resources.findIndex(function(e){return e.pipelineState===t});if(0<=e){var i=this._resources[e],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(e,1)}}},{key:"serializePipelineStates",value:function(){var e=xm.getKey(this._programName,this._defines),t="".concat(e,",").concat(this._stage,",").concat(this._primitive);return t+=Fb(this._bs),t+=Db(this._dss),t+=Pb(this._rs)}},{key:"_fillinPipelineInfo",value:function(e){if(void 0!==e.priority&&(this._priority=e.priority),void 0!==e.primitive&&(this._primitive=e.primitive),void 0!==e.stage&&(this._stage=e.stage),void 0!==e.dynamics&&(this._dynamicStates=e.dynamics),e.customizations&&(this._customizations=e.customizations),0===this._phase){var t=e.phase||"default";this._phase=ub(t)}var i=this._bs;if(e.blendState){var n=Object.assign({},e.blendState);n.targets&&n.targets.forEach(function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new Mg),e)}),delete n.targets,Object.assign(i,n)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState)}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"programName",get:function(){return this._programName}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"bindings",get:function(){return this._bindings}},{key:"blendState",get:function(){return this._bs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"rasterizerState",get:function(){return this._rs}},{key:"dynamics",get:function(){return this._dynamics}},{key:"customizations",get:function(){return this._customizations}},{key:"shader",get:function(){return this._shader}}]),_}();vb.getBindingTypeFromHandle=function(e){return(e&fb)>>>28},vb.getTypeFromHandle=function(e){return(e&db)>>>22},vb.getBindingFromHandle=function(e){return(4192256&e)>>>11},vb.getIndexFromHandle=function(e){return 2047&e};var yb,gb,bb,Sb,Tb,xb,Eb,wb,Ab,Cb,kb,Rb,Ob,Mb,Lb,Ib,Fb=function(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=",bt,".concat(s.blend,",").concat(s.blendEq,",").concat(s.blendAlphaEq,",").concat(s.blendColorMask),t+=",".concat(s.blendSrc,",").concat(s.blendDst,",").concat(s.blendSrcAlpha,",").concat(s.blendDstAlpha)}return t},Pb=function(e){return",rs,".concat(e.cullMode,",").concat(e.depthBias,",").concat(e.isFrontFaceCCW)},Db=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)},zb=(yb=Ca("cc.Material"),gb=ka(wm),yb((Tb=c((Sb=function(e){function r(){var e;return y(this,r),m(e=T(this,S(r).call(this)),"_effectAsset",Tb,_(e)),m(e,"_techIdx",xb,_(e)),m(e,"_defines",Eb,_(e)),m(e,"_states",wb,_(e)),m(e,"_props",Ab,_(e)),e._passes=[],e._owner=null,e._hash=0,e.loaded=!1,e}return d(r,es),l(r,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}}],[{key:"getInstantiatedMaterial",value:function(e,t,i){if(e._owner===t)return e;var n=new r;return n.copy(e),n._native=e._native+" (Instance)",n._owner=t,i&&(n._uuid=e._uuid),n}}]),l(r,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=wm.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"destroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}return this._passes=[],this._effectAsset=null,this._props=[],this._defines=[],this._states=[],p(S(r.prototype),"destroy",this).call(this)}},{key:"resetUniforms",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(this._props.length=this._passes.length,this._props.fill({}),e){var t=this._passes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.resetUBOs(),a.resetTextures()}}}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this._effectAsset){if(void 0===t){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.tryCompile(e)}}else this._passes[t].tryCompile(e);this._onPassesChange()}}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this._effectAsset){var i=this._effectAsset.techniques[this._techIdx].passes;if(void 0===t){var n=this._passes,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.overridePipelineStates(i[o.idxInTech],e)}}else this._passes[t].overridePipelineStates(i[t],e);this._onPassesChange()}}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,s=0;s<a;s++){var o=r[s];this._uploadProperty(o,e,t)&&(this._props[s][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++)for(var a=i[r],s=0,o=Object.keys(a);s<o.length;s++){var l=o[s];if(l===e)return a[l]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;for(var c=this._props[t],u=0,h=Object.keys(c);u<h.length;u++){var _=h[u];if(_===e)return c[_]}}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length,this._props.fill({});for(var t=0;t<e._props.length;t++)Object.assign(this._props[t],e._props[t]);this._defines.length=e._defines.length,this._defines.fill({});for(var i=0;i<e._defines.length;i++)Object.assign(this._defines[i],e._defines[i]);Object.assign(this._states,e._states),this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;n++)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_update",value:function(){var s=this,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length){var t=this._passes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}}this._passes=vb.createPasses(this._effectAsset,{techIdx:this._techIdx,defines:this._defines,states:this._states});var a=this._effectAsset.techniques[this._techIdx].passes.length;this._props.length=a,e?this._passes.forEach(function(e,t){var i=s._props[e.idxInTech];i||(i=s._props[t]={});for(var n=0,r=Object.keys(i);n<r.length;n++){var a=r[n];i[a]&&s._uploadProperty(e,a,i[a])}}):this._props.fill({})}else this._passes=cb.get("missing-effect-material")._passes.slice();this._onPassesChange()}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=vb.getBindingTypeFromHandle(n);if(r===Io.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):e.setUniform(n,i);else if(r===Io.SAMPLER){var a=vb.getBindingFromHandle(n);if(i instanceof Om)e.bindTextureView(a,i);else if(i instanceof Ql){var s=i.getGFXTextureView();if(!s||!s.texture.width||!s.texture.height)return!1;e.bindTextureView(a,s),e.bindSampler(a,Yl.getSampler(cc.game._gfxDevice,i.getSamplerHash()))}}return!0}},{key:"_onPassesChange",value:function(){var t=this,e="",i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}e+=a.serializePipelineStates()}if(this._hash=Bs(e,666),this._owner){var s=this._owner,o=s.sharedMaterials.findIndex(function(e){return e===t});0<=o&&s._onRebuildPSO(o,this)}}}]),r}()).prototype,"_effectAsset",[gb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xb=c(Sb.prototype,"_techIdx",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eb=c(Sb.prototype,"_defines",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wb=c(Sb.prototype,"_states",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ab=c(Sb.prototype,"_props",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bb=Sb))||bb);cc.Material=zb;var Bb,Nb,Ub,Gb,Vb=(Cb=Ca("cc.Skeleton"),kb=ka([Gt]),Rb=ka([Nn]),Cb((Lb=c((Mb=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_joints",Lb,_(t)),m(t,"_bindposes",Ib,_(t)),t._bindTRS=[],t._hash=0,t}return d(a,es),l(a,[{key:"onLoaded",value:function(){this.bindposes=this._bindposes}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e,this._bindTRS=e.map(function(e){var t=new Xi,i=new vn,n=new Xi;return Nn.toRTS(e,i,t,n),{position:t,rotation:i,scale:n}}),this._hash=Bs(this.bindposes.reduce(function(e,t){return e+t.m00.toPrecision(2)+" "+t.m01.toPrecision(2)+" "+t.m02.toPrecision(2)+" "+t.m03.toPrecision(2)+" "+t.m04.toPrecision(2)+" "+t.m05.toPrecision(2)+" "+t.m06.toPrecision(2)+" "+t.m07.toPrecision(2)+" "+t.m08.toPrecision(2)+" "+t.m09.toPrecision(2)+" "+t.m10.toPrecision(2)+" "+t.m11.toPrecision(2)+" "+t.m12.toPrecision(2)+" "+t.m13.toPrecision(2)+" "+t.m14.toPrecision(2)+" "+t.m15.toPrecision(2)+"\n"},""),666)}},{key:"bindTRS",get:function(){return this._bindTRS}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"hash",get:function(){return this._hash}}]),a}()).prototype,"_joints",[kb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ib=c(Mb.prototype,"_bindposes",[Rb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ob=Mb))||Ob);cc.Skeleton=Vb;var Hb=Ca("cc.PhysicsMaterial")((Ub=c((Nb=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_friction",Ub,_(e)),m(e,"_restitution",Gb,_(e)),e}return d(t,es),l(t,[{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e}}]),t}()).prototype,"_friction",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Gb=c(Nb.prototype,"_restitution",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Bb=Nb))||Bb;cc.PhysicsMaterial=Hb;var jb=function(){function t(e){y(this,t),this._onAttach=void 0,this._onDetach=void 0,this._models={},this._onAttach=e.onAttach,this._onDetach=e.onDetach}return l(t,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||0<--t[i]||this._onDetach&&this._onDetach(e)}}]),t}(),Wb=new(function(){function e(){y(this,e),this._customs={}}return l(e,[{key:"register",value:function(e,t){this._customs[e]=new jb(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}());cc.customizationManager=Wb;var Xb,qb,Yb=function(){function e(){y(this,e),this._subMeshObject=void 0,this._inputAssembler=void 0,this._material=void 0,this._cmdBuffers=void 0,this._psos=void 0,this._priority=void 0,this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=Yp.DEFAULT}return l(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:Po.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===Gs.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:Po.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){null!=(this._material=e)&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),Kb=new Nn,Qb=new Ze(function(){return new Yb},32);function Zb(e){var t=0,i=e.members,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=ol(s.type)*s.count}return t}(qb=Xb||(Xb={}))[qb.GENERAL=0]="GENERAL",qb[qb.ALWAYS=536870912]="ALWAYS",qb[qb.PROFILER=268435456]="PROFILER";var Jb,$b,eS,tS,iS,nS,rS,aS,sS,oS,lS,cS,uS,hS,_S,fS,dS,pS,mS,vS,yS,gS,bS,SS,TS,xS,ES,wS,AS,CS=function(){function i(e,t){y(this,i),this._type="default",this._device=void 0,this._scene=void 0,this._node=void 0,this._transform=void 0,this._id=void 0,this._enabled=!1,this._visFlags=Xb.GENERAL,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._matPSORecord=void 0,this._matRefCount=void 0,this._uboLocal=void 0,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._transformUpdated=!0,this._device=cc.director.root.device,this._scene=e,this._id=this._scene.generateModelId(),this._transform=this._node=t,this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new lm}return l(i,[{key:"scene",set:function(e){this._scene=e,this._id=this._scene.generateModelId()},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),l(i,[{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.destroy(),Qb.free(r)}for(var a=this._localBindings.values(),s=a.next();!s.done;){var o=s.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),s=a.next()}this._localBindings.has(cm.BLOCK.name)&&this._localBindings.delete(cm.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;(e._hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;if(this._uboUpdated=!0,this._transformUpdated){var e=this._transform._mat;Nn.array(this._uboLocal.view,e,lm.MAT_WORLD_OFFSET),Nn.inverseTranspose(Kb,e),Nn.array(this._uboLocal.view,Kb,lm.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(lm.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view),this._transformUpdated=!1}return this._matPSORecord.forEach(this._updatePass,this),!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=Py.fromPoints(Py.create(),e,t),this._worldBounds=Py.clone(this._modelBounds),this._transform.updateWorldTransform(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=Qb.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=Qb.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineState(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineState(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onPipelineChange",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}for(var r=n,a=r.material,s=this._matPSORecord.get(a),o=0;o<a.passes.length;o++){var l=a.passes[o];l.tryCompile(),l.destroyPipelineState(s[o]),s[o]=this._doCreatePSO(l),s[o].pipelineLayout.layouts[0].update()}r.updateCommandBuffer()}}},{key:"createPipelineState",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var n=e.passes[i],r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;Wb.attach(l,this)}t[i]=this._doCreatePSO(n)}return t}},{key:"destroyPipelineState",value:function(e,t){for(var i=0;i<e.passes.length;i++){var n=e.passes[i];n.destroyPipelineState(t[i]);var r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;Wb.detach(l,this)}}}},{key:"_doCreatePSO",value:function(e){var t=e.createPipelineState();return t.pipelineLayout.layouts[0].bindBuffer(lm.BLOCK.binding,this._localBindings.get(lm.BLOCK.name).buffer),this._localBindings.has(cm.BLOCK.name)&&t.pipelineLayout.layouts[0].bindBuffer(cm.BLOCK.binding,this._localBindings.get(cm.BLOCK.name).buffer),t}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(lm.BLOCK.name)||this._localBindings.set(lm.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:lm.BLOCK});var t=!1,i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.bindings.find(function(e){return e.name===cm.BLOCK.name})){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(cm.BLOCK.name)||this._localBindings.set(cm.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:cm.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var n=i.value;n.buffer||(n.buffer=this._device.createBuffer({usage:qs.UNIFORM|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:Zb(n.blockInfo)})),i=t.next()}}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var n=0;n<e.length;n++)e[n].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineState(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineState(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),i}(),kS=ka,RS=(Jb=Ca("cc.RenderableComponent"),$b=kS({type:[zb]}),eS=kS({type:zb,displayName:"Materials"}),Jb((nS=c((iS=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_materials",nS,_(e)),m(e,"_visFlags",rS,_(e)),e}return d(t,R_),l(t,[{key:"getMaterial",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=this._materials[e];if(!n)return null;var r=zb.getInstantiatedMaterial(n,this,t);return r!==this._materials[e]&&this.setMaterial(r,e,i||!t),this._materials[e]}},{key:"getSharedMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){var i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];this._materials[t]=e,i&&this._onMaterialModified(t,e)}},{key:"_getModel",value:function(){return null}},{key:"recreateModel",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materials[e]=this.getMaterial(e);return this._materials},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials=this._materials.concat(new Array(t).fill(null));else if(t<0){for(var i=-t;i<this._materials.length;++i)this.setMaterial(null,i);this._materials=this._materials.splice(-t)}}},{key:"material",get:function(){return this.getMaterial(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterial(e,0)}},{key:"sharedMaterial",get:function(){return this.getSharedMaterial(0)}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisiblityChange(e)}}]),t}()).prototype,"_materials",[$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rS=c(iS.prototype,"_visFlags",[kS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xb.GENERAL}}),c(iS.prototype,"sharedMaterials",[eS],Object.getOwnPropertyDescriptor(iS.prototype,"sharedMaterials"),iS.prototype),c(iS.prototype,"visibility",[kS],Object.getOwnPropertyDescriptor(iS.prototype,"visibility"),iS.prototype),tS=iS))||tS),OS=(aS=Ca("cc.ClickEvent"),sS=ka(cc.Node),aS((c((lS=function(){function o(){y(this,o),m(this,"target",cS,this),m(this,"component",uS,this),m(this,"_componentId",hS,this),m(this,"handler",_S,this),m(this,"customEventData",fS,this)}return l(o,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=e.length;r<a;r++){var s=e[r];s instanceof o&&s.emit(i)}}}]),o}()).prototype,"_componentName",[ka],Object.getOwnPropertyDescriptor(lS.prototype,"_componentName"),lS.prototype),cS=c(lS.prototype,"target",[sS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uS=c(lS.prototype,"component",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hS=c(lS.prototype,"_componentId",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_S=c(lS.prototype,"handler",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fS=c(lS.prototype,"customEventData",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oS=lS))||oS);cc.Component.EventHandler=OS;var MS,LS=(dS=Ca("cc.MissingClass"),pS=ka({visible:!1,editorOnly:!0}),dS((yS=c((vS=function e(){y(this,e),m(this,"_$erialized",yS,this)}).prototype,"_$erialized",[pS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mS=vS))||mS),IS=(gS=Ca("cc.MissingScript"),bS=za("packages://inspector/inspectors/comps/missing-script.js"),SS=ka({serializable:!1}),TS=ka({visible:!1,editorOnly:!0}),gS(xS=bS((wS=c((ES=function(e){function n(){var e;return y(this,n),m(e=T(this,S(n).call(this)),"compiled",wS,_(e)),m(e,"_$erialized",AS,_(e)),e}return d(n,R_),l(n,null,[{key:"safeFindClass",value:function(e,t){var i=je(e);return i||(e?(cc.deserialize.reportMissingClass(e),n.getMissingWrapper(e,t)):null)}},{key:"getMissingWrapper",value:function(e,t){return t.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||ft.test(e))?n:LS}}]),l(n,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),n}()).prototype,"compiled",[SS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AS=c(ES.prototype,"_$erialized",[TS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xS=ES))||xS)||xS);cc._MissingScript=IS;var FS=[Zt.SystemEventType.TOUCH_START,Zt.SystemEventType.TOUCH_END,Zt.SystemEventType.TOUCH_MOVE,Zt.SystemEventType.MOUSE_DOWN,Zt.SystemEventType.MOUSE_MOVE,Zt.SystemEventType.MOUSE_UP,Zt.SystemEventType.MOUSE_ENTER,Zt.SystemEventType.MOUSE_LEAVE,Zt.SystemEventType.MOUSE_WHEEL];function PS(e){e.propagationStopped=!0}var DS,zS,BS,NS,US,GS,VS,HS,jS,WS,XS,qS=Ca("cc.BlockInputEventsComponent")(MS=Ia("Components/BlockInputEventsComponent")(MS=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,R_),l(t,[{key:"onEnable",value:function(){for(var e=0;e<FS.length;e++)this.node.on(FS[e],PS,this)}},{key:"onDisable",value:function(){for(var e=0;e<FS.length;e++)this.node.off(FS[e],PS,this)}}]),t}())||MS)||MS;cc.BlockInputEventsComponent=qS;var YS,KS,QS,ZS,JS,$S,eT,tT,iT,nT,rT=new Ui,aT=new Ui,sT=new Nn,oT=new Nn,lT=new Nn,cT=(DS=Ca("cc.UITransformComponent"),zS=Fa(110),BS=Ia("UI/UITransform"),NS=ka({displayOrder:0}),US=ka({displayOrder:1}),DS(GS=zS(GS=BS(GS=Ma((XS=WS=function(e){function h(){var e,t;y(this,h);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(h)).call.apply(e,[this].concat(n))),"_contentSize",HS,_(t)),m(t,"_anchorPoint",jS,_(t)),t}return d(h,R_),l(h,[{key:"__preload",value:function(){(this.node.uiTransfromComp=this).node.layer=cc.Layers.UI}},{key:"onDestroy",value:function(){this.node.uiTransfromComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(Zt.SystemEventType.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(Zt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=rT,a=aT,s=-1,o=this.node.getComponent(cc.UIRenderComponent);s=o?o.visibility:this._getVisibility();var l=cc.director.root.ui.getScreen(s);if(l){l.node.getWorldRT(sT);var c=sT.m12,u=sT.m13,h=cc.visibleRect.center;if(sT.m12=h.x-(sT.m00*c+sT.m04*u),sT.m13=h.y-(sT.m01*c+sT.m05*u),Nn.invert(sT,sT),Ui.transformMat4(r,e,sT),this.node.getWorldMatrix(lT),Nn.invert(sT,lT),Ui.transformMat4(a,r,sT),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,0<=a.x&&0<=a.y&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var _=t.mask,f=this.node,d=0;f&&d<_.index;++d,f=f.parent);if(f!==_.node)return!(t.mask=null);var p=f.getComponent(cc.MaskComponent);return!p||!p.enabledInHierarchy||p.isHit(r)}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(lT),Nn.invert(sT,lT),t||(t=new Xi),Xi.transformMat4(t,e,sT)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(lT),t||(t=new Xi),Xi.transformMat4(t,e,lT)}},{key:"getBoundingBox",value:function(){Nn.fromRTS(oT,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new er(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(oT),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(lT),this.getBoundingBoxTo(lT)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Nn.fromRTS(oT,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,n=new er(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(Nn.multiply(lT,e,oT),n.transformMat4(lT),!this.node.children)return n;var r=this.node.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;if(l&&l.active){var c=l.getComponent(h);if(c){var u=c.getBoundingBoxTo(e);u&&er.union(n,n,u)}}}return n}},{key:"getComputeAABB",value:function(e){var t=this.getBoundingBoxToWorld(),i=t.center.x,n=t.center.y,r=this.node.worldPosition.z,a=t.width/2,s=t.height/2;if(null==e)return new Py(i,n,r,a,s,.01);Py.set(e,i,n,r,a,s,.01)}},{key:"_getVisibility",value:function(){for(var e=-1,t=this.node;t;){if(t){var i=t.getComponent("cc.CanvasComponent");if(i){e=i.visibility;break}}t=t.parent}return e}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(Zt.SystemEventType.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(Zt.SystemEventType.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(Zt.SystemEventType.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(Zt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(Zt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(Zt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}}]),h}(),WS.EventType=Zt.SystemEventType,c((VS=XS).prototype,"contentSize",[NS],Object.getOwnPropertyDescriptor(VS.prototype,"contentSize"),VS.prototype),c(VS.prototype,"anchorPoint",[US],Object.getOwnPropertyDescriptor(VS.prototype,"anchorPoint"),VS.prototype),HS=c(VS.prototype,"_contentSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(100,100)}}),jS=c(VS.prototype,"_anchorPoint",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ui(.5,.5)}}),GS=VS))||GS)||GS)||GS)||GS);cc.UITransformComponent=cT;var uT,hT,_T,fT=new Xi,dT=(YS=Ca("cc.CanvasComponent"),KS=Fa(100),QS=La(cT),ZS=Ia("UI/Canvas"),JS=ka(),$S=ka({type:ph}),YS(eT=KS(eT=QS(eT=ZS(eT=Ma(eT=Pa((c((tT=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_priority",iT,_(e)),m(e,"_targetTexture",nT,_(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new Xi,e._thisOnResized=e.alignWithScreen.bind(_(e)),e}return d(t,R_),l(t,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),l(t,[{key:"__preload",value:function(){var e=new xf("UICamera_"+this.node.name);e.setPosition(0,0,1e3),this._camera=cc.director.root.ui.renderScene.createCamera({name:"ui_"+this.node.name,node:e,projection:cc.CameraComponent.ProjectionType.ORTHO,priority:this._priority,isUI:!0,farClip:2e3,flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=Zo.COLOR|Zo.DEPTH|Zo.STENCIL;var t=cc.director.root.device;if(this._camera.resize(t.width,t.height),this._targetTexture){var i=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(i),this._camera.setFixedSize(i.width,i.height)}cc.view.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),cc.director.root.ui.addScreen(this)}},{key:"onDestroy",value:function(){this._camera&&cc.director.root.ui.renderScene.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),cc.view.off("design-resolution-changed",this._thisOnResized),cc.director.root.ui.removeScreen(this)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=cc.visibleRect;e=i,t=cc.view.getDesignResolutionSize();var n=0,r=0;if(cc.view.getResolutionPolicy()===cc.ResolutionPolicy.NO_BORDER&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),Xi.set(fT,.5*i.width+n,.5*i.height+r,0),this._pos.equals(fT)||this.node.setPosition(fT),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(fT),this._camera){var a=cc.view.getVisibleSize();this._camera.resize(a.width,a.height),this._camera.orthoHeight=this._camera.height/2,this._camera.node.setPosition(fT.x,fT.y,999),this._camera.update()}}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera)if(this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}else this._camera.changeTargetWindow(),this._camera.isWindowSize=!0}}]),t}()).prototype,"priority",[JS],Object.getOwnPropertyDescriptor(tT.prototype,"priority"),tT.prototype),c(tT.prototype,"targetTexture",[$S],Object.getOwnPropertyDescriptor(tT.prototype,"targetTexture"),tT.prototype),iT=c(tT.prototype,"_priority",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nT=c(tT.prototype,"_targetTexture",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eT=tT))||eT)||eT)||eT)||eT)||eT)||eT);cc.CanvasComponent=dT;var pT,mT,vT,yT,gT,bT,ST,TT,xT,ET,wT,AT,CT,kT,RT,OT,MT,LT=Ca("cc.UIComponent")(uT=Fa(110)(uT=Pa(uT=Ma((c((hT=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_priority",_T,_(t)),t._visibility=-1,t._lastParent=null,t}return d(a,R_),l(a,[{key:"onEnable",value:function(){this._lastParent=this.node.parent,this._updateVisibility(),this._lastParent&&this.node.on(Zt.SystemEventType.CHILD_REMOVED,this._parentChanged,this),(this.node._uiComp=this)._sortSiblings()}},{key:"onDisable",value:function(){this._cancelEventFromParent(),this.node._uiComp===this&&(this.node._uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}},{key:"setVisibility",value:function(e){this._visibility=e}},{key:"_parentChanged",value:function(e){return e===this.node&&(this._updateVisibility(),this._cancelEventFromParent(),this._lastParent=this.node.parent,this._sortSiblings(),!0)}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&e.sort(function(e,t){var i=e._uiComp,n=t._uiComp;return(i?i.priority:0)-(n?n.priority:0)})}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent(dT);if(t){this._visibility=t.visibility;break}}e=e.parent}}},{key:"_cancelEventFromParent",value:function(){this._lastParent&&(this._lastParent.off(Zt.SystemEventType.CHILD_REMOVED,this._parentChanged,this),this._lastParent=null),this._visibility=-1}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._priority=e,this._sortSiblings())}},{key:"visibility",get:function(){return this._visibility}}]),a}()).prototype,"priority",[ka],Object.getOwnPropertyDescriptor(hT.prototype,"priority"),hT.prototype),_T=c(hT.prototype,"_priority",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uT=hT))||uT)||uT)||uT)||uT;Rt(_o),(MT=OT||(OT={}))[MT.ADDCOLOR=0]="ADDCOLOR",MT[MT.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE";var IT,FT,PT,DT,zT,BT,NT,UT,GT,VT,HT,jT,WT,XT,qT,YT,KT,QT,ZT,JT,$T,ex,tx,ix,nx,rx,ax,sx,ox,lx,cx,ux,hx,_x=(pT=Ca("cc.UIRenderComponent"),mT=Fa(110),vT=La(cT),yT=ka({type:_o,displayOrder:0}),gT=ka({type:_o,displayOrder:1}),bT=ka({displayOrder:2}),ST=ka({type:zb,displayOrder:3}),pT(TT=mT(TT=vT(TT=Ma((RT=kT=function(e){function s(){var e,t;y(this,s);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(s)).call.apply(e,[this].concat(n))),"_srcBlendFactor",ET,_(t)),m(t,"_dstBlendFactor",wT,_(t)),m(t,"_color",AT,_(t)),m(t,"_sharedMaterial",CT,_(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._material=null,t._instanceMaterialType=OT.ADDCOLORANDTEXTURE,t._blendTemplate={blendState:{targets:[{blendSrc:_o.SRC_ALPHA,blendDst:_o.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},t}return d(s,LT),l(s,[{key:"__preload",value:function(){this._instanceMaterial(),this._flushAssembler&&this._flushAssembler(),this._updateColor()}},{key:"onEnable",value:function(){p(S(s.prototype),"onEnable",this).call(this),this.node.on(Zt.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Zt.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){p(S(s.prototype),"onDisable",this).call(this),this.node.off(Zt.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Zt.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){this.destroyRenderData(),this._material&&(this._material.destroy(),cc.director.root.ui._removeUIMaterial(this._material.hash)),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)}},{key:"requestRenderData",value:function(){var e=Jp.add();return this._renderData=e}},{key:"destroyRenderData",value:function(){this._renderData&&(Jp.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){p(S(s.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){p(S(s.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&this.enabledInHierarchy}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();var t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.getComponent(s);a&&a.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(this._sharedMaterial)e=zb.getInstantiatedMaterial(this._sharedMaterial,new RS,!1);else switch(this._instanceMaterialType){case OT.ADDCOLOR:e=zb.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new RS,!1);break;case OT.ADDCOLORANDTEXTURE:e=zb.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-material"),new RS,!1)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}}]),s}(),kT.BlendState=_o,kT.Assembler=null,kT.PostAssembler=null,c((xT=RT).prototype,"srcBlendFactor",[yT],Object.getOwnPropertyDescriptor(xT.prototype,"srcBlendFactor"),xT.prototype),c(xT.prototype,"dstBlendFactor",[gT],Object.getOwnPropertyDescriptor(xT.prototype,"dstBlendFactor"),xT.prototype),c(xT.prototype,"color",[bT],Object.getOwnPropertyDescriptor(xT.prototype,"color"),xT.prototype),c(xT.prototype,"sharedMaterial",[ST],Object.getOwnPropertyDescriptor(xT.prototype,"sharedMaterial"),xT.prototype),ET=c(xT.prototype,"_srcBlendFactor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _o.SRC_ALPHA}}),wT=c(xT.prototype,"_dstBlendFactor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _o.ONE_MINUS_SRC_ALPHA}}),AT=c(xT.prototype,"_color",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.WHITE.clone()}}),CT=c(xT.prototype,"_sharedMaterial",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TT=xT))||TT)||TT)||TT)||TT);cc.UIRenderComponent=_x,(cx=lx||(lx={}))[cx.ONCE=0]="ONCE",cx[cx.ALWAYS=1]="ALWAYS",Rt(lx),(hx=ux||(ux={}))[hx.TOP=1]="TOP",hx[hx.MID=2]="MID",hx[hx.BOT=4]="BOT",hx[hx.LEFT=8]="LEFT",hx[hx.CENTER=16]="CENTER",hx[hx.RIGHT=32]="RIGHT",hx[hx.HORIZONTAL=56]="HORIZONTAL",hx[hx.VERTICAL=7]="VERTICAL";var fx=ux.TOP|ux.BOT,dx=ux.LEFT|ux.RIGHT,px=(IT=Ca("cc.WidgetComponent"),FT=Fa(110),PT=Ia("UI/Widget"),DT=La(cT),zT=ka({type:cc.Node}),BT=ka({visible:!1}),NT=ka({visible:!1}),UT=ka({type:lx}),IT(GT=FT(GT=PT(GT=DT(GT=Ma((ox=sx=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._lastPos=new Xi,t._lastSize=new Kn,t._dirty=!0,m(t,"_alignFlags",HT,_(t)),m(t,"_target",jT,_(t)),m(t,"_left",WT,_(t)),m(t,"_right",XT,_(t)),m(t,"_top",qT,_(t)),m(t,"_bottom",YT,_(t)),m(t,"_horizontalCenter",KT,_(t)),m(t,"_verticalCenter",QT,_(t)),m(t,"_isAbsLeft",ZT,_(t)),m(t,"_isAbsRight",JT,_(t)),m(t,"_isAbsTop",$T,_(t)),m(t,"_isAbsBottom",ex,_(t)),m(t,"_isAbsHorizontalCenter",tx,_(t)),m(t,"_isAbsVerticalCenter",ix,_(t)),m(t,"_originalWidth",nx,_(t)),m(t,"_originalHeight",rx,_(t)),m(t,"_alignMode",ax,_(t)),t}return d(a,R_),l(a,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerTargetEvents()}},{key:"update",value:function(){this._dirty||this.node.hasChangedFlags&&this._recursiveDirty()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterTargetEvents()}},{key:"_aotuChangedValue",value:function(e,t){if(0<(this._alignFlags&e)&&this.node.parent&&this.node.parent.uiTransfromComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===ux.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===ux.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===ux.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===ux.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===ux.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===ux.MID&&(this._verticalCenter=t?this._verticalCenter*i.height:this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;(this._target=e)&&(e.on(Zt.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(Zt.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(Zt.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(Zt.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==0<(this._alignFlags&e)){var i=0<(e&dx);t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||this.node.getComponentsInChildren(a).forEach(function(e){e._dirty=!0})}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&ux.TOP)},set:function(e){this._setAlign(ux.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&ux.BOT)},set:function(e){this._setAlign(ux.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&ux.LEFT)},set:function(e){this._setAlign(ux.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&ux.RIGHT)},set:function(e){this._setAlign(ux.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&ux.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=ux.MID):this._alignFlags&=~ux.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&ux.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=ux.CENTER):this._alignFlags&=~ux.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&dx)==dx}},{key:"isStretchHeight",get:function(){return(this._alignFlags&fx)==fx}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._aotuChangedValue(ux.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._aotuChangedValue(ux.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._aotuChangedValue(ux.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._aotuChangedValue(ux.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._aotuChangedValue(ux.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._aotuChangedValue(ux.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),a}(),sx.AlignMode=lx,c((VT=ox).prototype,"target",[zT],Object.getOwnPropertyDescriptor(VT.prototype,"target"),VT.prototype),c(VT.prototype,"isAlignTop",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAlignTop"),VT.prototype),c(VT.prototype,"isAlignBottom",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAlignBottom"),VT.prototype),c(VT.prototype,"isAlignLeft",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAlignLeft"),VT.prototype),c(VT.prototype,"isAlignRight",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAlignRight"),VT.prototype),c(VT.prototype,"isAlignVerticalCenter",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAlignVerticalCenter"),VT.prototype),c(VT.prototype,"isAlignHorizontalCenter",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAlignHorizontalCenter"),VT.prototype),c(VT.prototype,"isStretchWidth",[BT],Object.getOwnPropertyDescriptor(VT.prototype,"isStretchWidth"),VT.prototype),c(VT.prototype,"isStretchHeight",[NT],Object.getOwnPropertyDescriptor(VT.prototype,"isStretchHeight"),VT.prototype),c(VT.prototype,"top",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"top"),VT.prototype),c(VT.prototype,"bottom",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"bottom"),VT.prototype),c(VT.prototype,"left",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"left"),VT.prototype),c(VT.prototype,"right",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"right"),VT.prototype),c(VT.prototype,"horizontalCenter",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"horizontalCenter"),VT.prototype),c(VT.prototype,"verticalCenter",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"verticalCenter"),VT.prototype),c(VT.prototype,"isAbsoluteTop",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAbsoluteTop"),VT.prototype),c(VT.prototype,"isAbsoluteBottom",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAbsoluteBottom"),VT.prototype),c(VT.prototype,"isAbsoluteLeft",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAbsoluteLeft"),VT.prototype),c(VT.prototype,"isAbsoluteRight",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAbsoluteRight"),VT.prototype),c(VT.prototype,"alignMode",[UT],Object.getOwnPropertyDescriptor(VT.prototype,"alignMode"),VT.prototype),c(VT.prototype,"isAbsoluteHorizontalCenter",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAbsoluteHorizontalCenter"),VT.prototype),c(VT.prototype,"isAbsoluteVerticalCenter",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"isAbsoluteVerticalCenter"),VT.prototype),c(VT.prototype,"alignFlags",[ka],Object.getOwnPropertyDescriptor(VT.prototype,"alignFlags"),VT.prototype),HT=c(VT.prototype,"_alignFlags",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jT=c(VT.prototype,"_target",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WT=c(VT.prototype,"_left",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XT=c(VT.prototype,"_right",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qT=c(VT.prototype,"_top",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YT=c(VT.prototype,"_bottom",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KT=c(VT.prototype,"_horizontalCenter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QT=c(VT.prototype,"_verticalCenter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZT=c(VT.prototype,"_isAbsLeft",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JT=c(VT.prototype,"_isAbsRight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$T=c(VT.prototype,"_isAbsTop",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ex=c(VT.prototype,"_isAbsBottom",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tx=c(VT.prototype,"_isAbsHorizontalCenter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ix=c(VT.prototype,"_isAbsVerticalCenter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nx=c(VT.prototype,"_originalWidth",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rx=c(VT.prototype,"_originalHeight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ax=c(VT.prototype,"_alignMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lx.ALWAYS}}),GT=VT))||GT)||GT)||GT)||GT)||GT);cc.WidgetComponent=px;var mx=new Xi,vx=new Xi,yx=new Ui;function gx(e){return e instanceof cc.Scene?cc.visibleRect:e.getContentSize()}function bx(e,t,i,n){for(var r=e.parent?e.parent.getScale():vx,a=r.x,s=r.y,o=0,l=0,c=e.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);var u=c.getPosition();if(o+=u.x,l+=u.y,(c=c.parent)===t)break;var h=(r=c?c.getScale():vx).x,_=r.y;o*=h,l*=_,a*=h,s*=_}n.x=0!==a?1/a:1,n.y=0!==s?1/s:1,i.x=-o,i.y=-l}var Sx=new Xi,Tx=new Xi(1,1,1);function xx(e,t){var i,n=t.target,r=Sx,a=Tx;n?bx(e,i=n,r,a):i=e.parent;var s=gx(i),o=i instanceof cc.Scene,l=o?yx:i.getAnchorPoint(),c=o;e.getPosition(mx);var u=mx.x,h=mx.y,_=e.getAnchorPoint(),f=e.getScale();if(t.alignFlags&ux.HORIZONTAL){var d=0,p=0,m=s.width;p=c?(d=cc.visibleRect.left.x,cc.visibleRect.right.x):(d=-l.x*m)+m,d+=t.isAbsoluteLeft?t.left:t.left*m,p-=t.isAbsoluteRight?t.right:t.right*m,n&&(d+=r.x,d*=a.x,p+=r.x,p*=a.x);var v=0,y=_.x,g=f.x;if(g<0&&(y=1-y,g=-g),t.isStretchWidth)v=p-d,0!==g&&(e.width=v/g),u=d+y*v;else if(v=e.width*g,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*m,S=(.5-l.x)*s.width;n&&(b*=a.x,S+=r.x,S*=a.x),u=S+(y-.5)*v+b}else u=t.isAlignLeft?d+y*v:p+(y-1)*v;t._lastSize.width=v}if(t.alignFlags&ux.VERTICAL){var T=0,x=0,E=s.height;T=c?(x=cc.visibleRect.bottom.y,cc.visibleRect.top.y):(x=-l.y*E)+E,x+=t.isAbsoluteBottom?t.bottom:t.bottom*E,T-=t.isAbsoluteTop?t.top:t.top*E,n&&(x+=r.y,x*=a.y,T+=r.y,T*=a.y);var w=0,A=_.y,C=f.y;if(C<0&&(A=1-A,C=-C),t.isStretchHeight)w=T-x,0!==C&&(e.height=w/C),h=x+A*w;else if(w=e.height*C,t.isAlignVerticalCenter){var k=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*E,R=(.5-l.y)*s.height;n&&(k*=a.y,R+=r.y,R*=a.y),h=R+(A-.5)*w+k}else h=t.isAlignBottom?x+A*w:T+(A-1)*w;t._lastSize.height=w}e.setPosition(u,h,mx.z),Xi.set(t._lastPos,u,h,mx.z)}function Ex(){var e=cc.director.getScene();if(e){if(Ix.isAligning=!0,Ix._nodesOrderDirty)Rx.length=0,function e(t){var i=t.getComponent(px);i&&(xx(t,i),i.alignMode!==lx.ALWAYS?i.enabled=!1:Rx.push(i));var n=t.children,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.active&&e(o)}}(e),Ix._nodesOrderDirty=!1;else{var t=null,i=Ix._activeWidgetsIterator;for(i.i=0;i.i<Rx.length;++i.i)(t=Rx[i.i])._dirty&&(xx(t.node,t),t._dirty=!1)}Ix.isAligning=!1}}function Ax(e){if(e===Zt.SystemEventType.POSITION_PART&&!Ix.isAligning){var t=this,i=t.node.getPosition(),n=this._lastPos,r=new Xi(i);r.subtract(n);var a=t.node.parent,s=new Xi(1,1,1);t.target&&(a=t.target,bx(t.node,a,new Xi,s));var o=gx(a),l=new Xi;0!==o.width&&0!==o.height&&Xi.set(l,r.x/o.width,r.y/o.height,l.z),t.isAlignTop&&(t.top-=(t.isAbsoluteTop?r.y:l.y)*s.y),t.isAlignBottom&&(t.bottom+=(t.isAbsoluteBottom?r.y:l.y)*s.y),t.isAlignLeft&&(t.left+=(t.isAbsoluteLeft?r.x:l.x)*s.x),t.isAlignRight&&(t.right-=(t.isAbsoluteRight?r.x:l.x)*s.x),t.isAlignHorizontalCenter&&(t.horizontalCenter+=(t.isAbsoluteHorizontalCenter?r.x:l.x)*s.x),t.isAlignVerticalCenter&&(t.verticalCenter+=(t.isAbsoluteVerticalCenter?r.y:l.y)*s.y)}}function Cx(){if(!Ix.isAligning){this.setDirty();var e=this,t=e.node.getContentSize(),i=this._lastSize,n=new Xi(t.width-i.width,t.height-i.height,0),r=e.node.parent,a=new Xi(1,1,1);e.target&&(r=e.target,bx(e.node,r,new Xi,a));var s=gx(r),o=new Xi;0!==s.width&&0!==s.height&&Xi.set(o,n.x/s.width,n.y/s.height,o.z);var l=e.node.getAnchorPoint();e.isAlignTop&&(e.top-=(e.isAbsoluteTop?n.y:o.y)*(1-l.y)*a.y),e.isAlignBottom&&(e.bottom-=(e.isAbsoluteBottom?n.y:o.y)*l.y*a.y),e.isAlignLeft&&(e.left-=(e.isAbsoluteLeft?n.x:o.x)*l.x*a.x),e.isAlignRight&&(e.right-=(e.isAbsoluteRight?n.x:o.x)*(1-l.x)*a.x)}}function kx(){this.setDirty()}var Rx=[];var Ox,Mx,Lx=[],Ix=cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ye.MutableForwardIterator(Rx),animationState:null,init:function(e){e.on(cc.Director.EVENT_AFTER_UPDATE,Ex),cc.sys.isMobile?window.addEventListener("resize",this.onResized.bind(this)):cc.view.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=e.node.getComponent(_x);if(t){var i=cc.director.root.ui.getScreen(t.visibility);i&&-1===Lx.indexOf(i)&&(Lx.push(i),i.node.on("design-resolution-changed",this.onResized,this))}e.node.on(Zt.SystemEventType.TRANSFORM_CHANGED,Ax,e),e.node.on(Zt.SystemEventType.SIZE_CHANGED,Cx,e),e.node.on(Zt.SystemEventType.ANCHOR_CHANGED,kx,e)},remove:function(e){this._activeWidgetsIterator.remove(e),e.node.off(Zt.SystemEventType.TRANSFORM_CHANGED,Ax,e),e.node.off(Zt.SystemEventType.SIZE_CHANGED,Cx,e),e.node.off(Zt.SystemEventType.ANCHOR_CHANGED,kx,e)},onResized:function(){var e=cc.director.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(cc.Node.isNode(e)){var t=e.getComponent(px);if(t&&t.alignFlags===lx.ALWAYS)return}var i=e.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;this.refreshWidgetOnResized(s)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var n=e.node,r=n.parent;if(r){var a=new Xi,s=new Xi(1,1,1);if(e.target&&bx(n,r=e.target,a,s),!t)return;var o=r.getAnchorPoint(),l=gx(r),c=n.getAnchorPoint(),u=n.getPosition(),h=ux,_=n.getScale(),f=0;if(t&h.LEFT){var d=-o.x*l.width;d+=a.x,d*=s.x,f=u.x-c.x*n.width*_.x-d,e.isAbsoluteLeft||(f/=l.width),f/=s.x,e.left=i(e.left,f)}if(t&h.RIGHT){var p=(1-o.x)*l.width;p+=a.x,f=(p*=s.x)-(u.x+(1-c.x)*n.width*_.x),e.isAbsoluteRight||(f/=l.width),f/=s.x,e.right=i(e.right,f)}if(t&h.TOP){var m=(1-o.y)*l.height;m+=a.y,f=(m*=s.y)-(u.y+(1-c.y)*n.height*_.y),e.isAbsoluteTop||(f/=l.height),f/=s.y,e.top=i(e.top,f)}if(t&h.BOT){var v=-o.y*l.height;v+=a.y,v*=s.y,f=u.y-c.y*n.height*_.y-v,e.isAbsoluteBottom||(f/=l.height),f/=s.y,e.bottom=i(e.bottom,f)}}},updateAlignment:function e(t){var i=t.parent;i&&cc.Node.isNode(i)&&e(i);var n=t.getComponent(px);n&&i&&xx(t,n)},AlignMode:lx,AlignFlags:ux};(Mx=Ox||(Ox={}))[Mx.DIRECTIONAL=0]="DIRECTIONAL",Mx[Mx.SPHERE=1]="SPHERE",Mx[Mx.SPOT=2]="SPOT",Mx[Mx.UNKNOWN=3]="UNKNOWN";var Fx=function(e){return 4*Math.PI*Math.PI*e*e},Px=function(){function n(e,t,i){y(this,n),this._enabled=!0,this._color=new Xi(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Xi(1,1,1),this._scene=void 0,this._node=void 0,this._type=void 0,this._name=void 0,this._scene=e,this._name=t,this._type=Ox.UNKNOWN,this._node=i}return l(n,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,function(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,s=3*n/a,o=2*r/a,l=1/o*s,c=1/o*(1-s-o);e.x=3.2404542*l-1.5371385+-.4985314*c,e.y=-.969266*l+1.8760108+.041556*c,e.z=.0556434*l-.2040259+1.0572252*c}(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}}]),l(n,[{key:"update",value:function(){}}]),n}();(Dx=new Vy).accurate=!0;var Dx,zx=function(){var o=cc.v3(),l=cc.v3(),c=cc.quat(),u=new Vy;u.accurate=!0;var h=cc.mat4(),_=cc.mat4(),f=cc.v3(),d=cc.v3();return function(e,t,i,n,r,a){Nn.fromRT(h,i.node.getWorldRotation(c),t.node.getWorldPosition(o)),Nn.invert(_,h),t.getSplitFrustum(u,n,r),u.transform(_),Xi.set(f,u.vertices[0].x,u.vertices[0].y,u.vertices[0].z),Xi.copy(d,f);for(var s=1;s<u.vertices.length;s++)f.x=Math.min(f.x,u.vertices[s].x),f.y=Math.min(f.y,u.vertices[s].y),f.z=Math.min(f.z,u.vertices[s].z),d.x=Math.max(d.x,u.vertices[s].x),d.y=Math.max(d.y,u.vertices[s].y),d.z=Math.max(d.z,u.vertices[s].z);Xi.set(l,(f.x+d.x)/2,(f.y+d.y)/2,d.z),l.z+=a,Xi.transformMat4(o,l,h),Nn.fromRT(h,i.node.getWorldRotation(c),o),Vy.createOrtho(e,d.x-f.x,d.y-f.y,0,f.z-a-d.z,h)}}(),Bx=function(){function t(e){y(this,t),this._device=void 0,this._pipeline=void 0,this._name="",this._priority=0,this._stages=[],this._material=new zb,this._device=e.device,this._pipeline=e}return l(t,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}}]),l(t,[{key:"resize",value:function(e,t){var i=this._stages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.resize(e,t)}}},{key:"render",value:function(e){var t=this._stages,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"createStage",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._stages.push(i),this._stages.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyStages",value:function(){var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._stages=[]}}]),t}(),Nx=function(){function t(e){if(y(this,t),this._flow=void 0,this._pipeline=void 0,this._device=void 0,this._name="",this._priority=0,this._framebuffer=null,this._cmdBuff=null,this._clearColors=void 0,this._clearDepth=1,this._clearStencil=0,this._renderArea=void 0,this._pass=null,this._pso=null,this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0}}return l(t,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),l(t,[{key:"setClearColor",value:function(e){0<this._clearColors.length?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}}]),t}(),Ux=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._hTexSampler=0,t._hBlendTexSampler=0,t._bindingLayout=null,t}return d(i,Nx),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Po.PRIMARY}),this.rebuild(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(rm.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(rm.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.smaaBlendTexView)),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,Zo.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}this._device.queue.submit([this._cmdBuff])}}]),i}(),Gx=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return d(t,Bx),l(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}});var t=this._pipeline.root.mainWindow.framebuffer;return this.createStage(Ux,{name:"ToneMapStage",priority:0,framebuffer:t}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&(this._material.destroy(),this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}}));var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}}]),t}(),Vx=new Float32Array(4),Hx=new Nn,jx=new Xi,Wx=new $i(0,0,0,0),Xx=function(){function t(e){y(this,t),this._root=void 0,this._device=void 0,this._name="BasePipeline",this._renderObjects=[],this._renderPasses=new Map,this._flows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._shadingPass=null,this._fboCount=0,this._msaaShadingTex=null,this._msaaShadingTexView=null,this._msaaDepthStencilTex=null,this._msaaDepthStencilTexView=null,this._msaaShadingFBO=null,this._colorFmt=Zt.GFXFormat.UNKNOWN,this._depthStencilFmt=Zt.GFXFormat.UNKNOWN,this._shadingTextures=[],this._shadingTexViews=[],this._depthStencilTex=null,this._depthStencilTexView=null,this._shadingFBOs=[],this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx=0,this._prevIdx=1,this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._smaaPass=null,this._smaaEdgeFBO=null,this._smaaEdgeTex=null,this._smaaEdgeTexView=null,this._smaaBlendFBO=null,this._smaaBlendTex=null,this._smaaBlendTexView=null,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new rm,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._root=e,this._device=e.device}return l(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return this._name}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"curShadingTexView",get:function(){return this._shadingTexViews[this._curIdx]}},{key:"prevShadingTexView",get:function(){return this._shadingTexViews[this._prevIdx]}},{key:"curShadingFBO",get:function(){return this._shadingFBOs[this._curIdx]}},{key:"prevShadingFBO",get:function(){return this._shadingFBOs[this._prevIdx]}},{key:"msaaShadingFBO",get:function(){return this._msaaShadingFBO}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"smaaEdgeTexView",get:function(){return this._smaaEdgeTexView}},{key:"smaaEdgeFBO",get:function(){return this._smaaEdgeFBO}},{key:"smaaBlendTexView",get:function(){return this._smaaBlendTexView}},{key:"smaaBlendFBO",get:function(){return this._smaaBlendFBO}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}}]),l(t,[{key:"render",value:function(e){e.camera.update(),this.sceneCulling(e),this.updateUBOs(e);var t=e.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);var r=this._flows,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.resize(e,t)}}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"createFlow",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._flows.push(i),this._flows.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyFlows",value:function(){var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._flows=[]}},{key:"getFlow",value:function(e){var t=this._flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===e)return a}return null}},{key:"updateMacros",value:function(){xm.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;var e=this._root.scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}}},{key:"_initialize",value:function(e){if(void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:this._usePostProcess=!1,this._usePostProcess&&((this._device.hasFeature(yl.FORMAT_R11G11B10F)||this._device.hasFeature(yl.TEXTURE_HALF_FLOAT)||this._device.hasFeature(yl.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._shadingTextures=new Array(this._fboCount),this._shadingTexViews=new Array(this._fboCount),this._shadingFBOs=new Array(this._fboCount),this._isHDR=void 0===e.enableHDR||e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,this._useMSAA&&(this._useMSAA=this.device.hasFeature(yl.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(yl.COLOR_HALF_FLOAT)&&this._device.hasFeature(yl.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(yl.FORMAT_R11G11B10F)?(this._colorFmt=Zt.GFXFormat.R11G11B10F,this._isHDR=!0):this._device.hasFeature(yl.TEXTURE_HALF_FLOAT)&&(this._colorFmt=Zt.GFXFormat.RGBA16F,this._isHDR=!0):this._device.hasFeature(yl.COLOR_FLOAT)&&this._device.hasFeature(yl.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(yl.TEXTURE_FLOAT)&&(this._colorFmt=Zt.GFXFormat.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=Zt.GFXFormat.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=Zt.GFXFormat.D24S8:this._depthStencilFmt=Zt.GFXFormat.D24:this._depthStencilFmt=Zt.GFXFormat.D16,this.updateMacros(),this._shadingScale=1,this._shadingWidth=Math.floor(this._device.nativeWidth),this._shadingHeight=Math.floor(this._device.nativeHeight),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+rl[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+rl[this._depthStencilFmt].name),this._shadingPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:zo.CLEAR,storeOp:No.STORE,sampleCount:1,beginLayout:Go.COLOR_ATTACHMENT_OPTIMAL,endLayout:Go.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:zo.CLEAR,depthStoreOp:No.STORE,stencilLoadOp:zo.CLEAR,stencilStoreOp:No.STORE,sampleCount:1,beginLayout:Go.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Go.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),this._useMSAA&&(this._msaaShadingTex=this._device.createTexture({type:So.TEX2D,usage:xo.COLOR_ATTACHMENT|xo.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaShadingTexView=this._device.createTextureView({texture:this._msaaShadingTex,type:Ro.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex=this._device.createTexture({type:So.TEX2D,usage:xo.DEPTH_STENCIL_ATTACHMENT|xo.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaDepthStencilTexView=this._device.createTextureView({texture:this._msaaDepthStencilTex,type:Ro.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),0<this._fboCount){this._depthStencilTex=this._device.createTexture({type:So.TEX2D,usage:xo.DEPTH_STENCIL_ATTACHMENT|xo.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Ro.TV2D,format:this._depthStencilFmt});for(var t=0;t<this._fboCount;++t)this._shadingTextures[t]=this._device.createTexture({type:So.TEX2D,usage:xo.COLOR_ATTACHMENT|xo.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._shadingTexViews[t]=this._device.createTextureView({texture:this._shadingTextures[t],type:Ro.TV2D,format:this._colorFmt}),this._shadingFBOs[t]=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[t]],depthStencilView:this._depthStencilTexView})}if(this._useSMAA){var i=Zt.GFXFormat.RGBA8;this._smaaPass=this._device.createRenderPass({colorAttachments:[{format:i,loadOp:zo.CLEAR,storeOp:No.STORE,sampleCount:1,beginLayout:Go.COLOR_ATTACHMENT_OPTIMAL,endLayout:Go.COLOR_ATTACHMENT_OPTIMAL}]}),this._smaaEdgeTex=this._device.createTexture({type:So.TEX2D,usage:xo.COLOR_ATTACHMENT|xo.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaEdgeTexView=this._device.createTextureView({texture:this._smaaEdgeTex,type:Ro.TV2D,format:i}),this._smaaEdgeFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex=this._device.createTexture({type:So.TEX2D,usage:xo.COLOR_ATTACHMENT|xo.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaBlendTexView=this._device.createTextureView({texture:this._smaaBlendTex,type:Ro.TV2D,format:i}),this._smaaBlendFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}return!!this.createQuadInputAssembler()&&!!this.createUBOs()}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs(),this._smaaEdgeTexView&&(this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView=null),this._smaaEdgeTex&&(this._smaaEdgeTex.destroy(),this._smaaEdgeTex=null),this._smaaEdgeFBO&&(this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO=null),this._smaaBlendTexView&&(this._smaaBlendTexView.destroy(),this._smaaBlendTexView=null),this._smaaBlendTex&&(this._smaaBlendTex.destroy(),this._smaaBlendTex=null),this._smaaBlendFBO&&(this._smaaBlendFBO.destroy(),this._smaaBlendFBO=null),this._msaaShadingTexView&&(this._msaaShadingTexView.destroy(),this._msaaShadingTexView=null),this._msaaShadingTex&&(this._msaaShadingTex.destroy(),this._msaaShadingTex=null),this._msaaDepthStencilTexView&&(this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView=null),this._msaaDepthStencilTex&&(this._msaaDepthStencilTex.destroy(),this._msaaDepthStencilTex=null),this._msaaShadingFBO&&(this._msaaShadingFBO.destroy(),this._msaaShadingFBO=null);for(var e=0;e<this._shadingTexViews.length;++e)this._shadingTexViews[e]&&this._shadingTexViews[e].destroy(),this._shadingTextures[e]&&this._shadingTextures[e].destroy(),this._shadingFBOs[e]&&this._shadingFBOs[e].destroy();this._shadingTexViews.splice(0),this._shadingTextures.splice(0),this._shadingFBOs.splice(0),this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._shadingPass&&(this._shadingPass.destroy(),this._shadingPass=null)}},{key:"resizeFBOs",value:function(e,t){this._shadingWidth=e,this._shadingHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Ro.TV2D,format:this._depthStencilFmt}));for(var i=0;i<this._fboCount;++i)this._shadingTextures[i].resize(e,t),this._shadingTexViews[i].destroy(),this._shadingTexViews[i].initialize({texture:this._shadingTextures[i],type:Ro.TV2D,format:this._colorFmt}),this._shadingFBOs[i].destroy(),this._shadingFBOs[i].initialize({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[i]],depthStencilView:this._depthStencilTexView});if(this._useMSAA&&(this._msaaShadingTex.resize(e,t),this._msaaShadingTexView.destroy(),this._msaaShadingTexView.initialize({texture:this._msaaShadingTex,type:Ro.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex.resize(e,t),this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView.initialize({texture:this._msaaDepthStencilTex,type:Ro.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO.destroy(),this._msaaShadingFBO.initialize({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._useSMAA){var n=this._smaaEdgeTex.format;this._smaaEdgeTex.resize(e,t),this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView.initialize({texture:this._smaaEdgeTex,type:Ro.TV2D,format:n}),this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex.resize(e,t),this._smaaBlendTexView.destroy(),this._smaaBlendTexView.initialize({texture:this._smaaBlendTex,type:Ro.TV2D,format:n}),this._smaaBlendFBO.destroy(),this._smaaBlendFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,this._quadIB.update(s);var o=[{name:"a_position",format:Zt.GFXFormat.RG32F},{name:"a_texCoord",format:Zt.GFXFormat.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(rm.BLOCK.name)){var e=this._root.device.createBuffer({usage:qs.UNIFORM|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:rm.SIZE});this._globalBindings.set(rm.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:rm.BLOCK,buffer:e})}if(!this._globalBindings.get(am.BLOCK.name)){var t=this._root.device.createBuffer({usage:qs.UNIFORM|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:am.SIZE});this._globalBindings.set(am.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:am.BLOCK,buffer:t})}return this._globalBindings.get(sm.name)||this._globalBindings.set(sm.name,{type:Io.SAMPLER,samplerInfo:sm}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(rm.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(rm.BLOCK.name));var t=this._globalBindings.get(am.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(am.BLOCK.name))}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,s=this._uboGlobal.view;s[rm.TIME_OFFSET]=this._root.cumulativeTime,s[rm.SCREEN_SIZE_OFFSET]=n.width,s[rm.SCREEN_SIZE_OFFSET+1]=n.height,s[rm.SCREEN_SIZE_OFFSET+2]=1/s[rm.SCREEN_SIZE_OFFSET],s[rm.SCREEN_SIZE_OFFSET+3]=1/s[rm.SCREEN_SIZE_OFFSET+1],s[rm.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,s[rm.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,s[rm.SCREEN_SCALE_OFFSET+2]=1/s[rm.SCREEN_SCALE_OFFSET],s[rm.SCREEN_SCALE_OFFSET+3]=1/s[rm.SCREEN_SCALE_OFFSET+1],s[rm.NATIVE_SIZE_OFFSET]=this._shadingWidth,s[rm.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,s[rm.NATIVE_SIZE_OFFSET+2]=1/s[rm.NATIVE_SIZE_OFFSET],s[rm.NATIVE_SIZE_OFFSET+3]=1/s[rm.NATIVE_SIZE_OFFSET+1],Nn.array(s,t.matView,rm.MAT_VIEW_OFFSET),Nn.invert(Hx,t.matView),Nn.array(s,Hx,rm.MAT_VIEW_INV_OFFSET),Nn.array(s,t.matProj,rm.MAT_PROJ_OFFSET),Nn.invert(Hx,t.matProj),Nn.array(s,Hx,rm.MAT_PROJ_INV_OFFSET),Nn.array(s,t.matViewProj,rm.MAT_VIEW_PROJ_OFFSET),Nn.array(s,t.matViewProjInv,rm.MAT_VIEW_PROJ_INV_OFFSET),Xi.array(s,t.position,rm.CAMERA_POS_OFFSET);var o=t.exposure;if(s[rm.EXPOSURE_OFFSET]=o,s[rm.EXPOSURE_OFFSET+1]=1/o,s[rm.EXPOSURE_OFFSET+2]=this._isHDR?1:0,s[rm.EXPOSURE_OFFSET+3]=this._fpScale/o,Xi.array(s,r.direction,rm.MAIN_LIT_DIR_OFFSET),r.enabled){if(Xi.array(s,r.color,rm.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;s[rm.MAIN_LIT_COLOR_OFFSET]*=l.x,s[rm.MAIN_LIT_COLOR_OFFSET+1]*=l.y,s[rm.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?s[rm.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:s[rm.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*o}else $i.array(s,Wx,rm.MAIN_LIT_COLOR_OFFSET);Vx.set(a.skyColor),this._isHDR?Vx[3]=a.skyIllum*this._fpScale:Vx[3]=a.skyIllum*o,this._uboGlobal.view.set(Vx,rm.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,rm.AMBIENT_GROUND_OFFSET),this._globalBindings.get(rm.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.splice(0);var n=i.mainLight;n&&n.enabled&&n.update();var r=i.planarShadows;r.enabled&&n.node.hasChangedFlags&&r.updateDirLight(n),i.skybox.enabled&&this.addVisibleModel(i.skybox,t);var a=i.models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;if(c._resetUBOUpdateFlag(),c.enabled&&(c.node&&e.visibility&c.node.layer||e.visibility&c.visFlags)){if(c.updateTransform(),c.worldBounds&&!vy.aabb_frustum(c.worldBounds,t.frustum))continue;c.updateUBOs(),this.addVisibleModel(c,t)}}r.enabled&&r.updateCommandBuffers()}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(e.node.getWorldPosition(jx),Xi.subtract(jx,jx,t.position),i=Xi.dot(jx,t.forward)),this._renderObjects.push({model:e,depth:i})}}]),t}(),qx=function(){function i(e,t){y(this,i),this.array=void 0,this.length=0,this.cache=void 0,this._compareFn=void 0,this.array=new Array(e),this.cache=this.array,this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}return l(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[this.length--]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.cache.fill(null),this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e.array[t]}},{key:"append",value:function(e){var t=e,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;this.array[this.length++]=a}}}]),i}();function Yx(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function Kx(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var Qx=function(){function t(e){y(this,t),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passDesc=e,this.cmdBuffs=new qx(64),this.queue=new qx(64,this._passDesc.sortFunc)}return l(t,[{key:"clear",value:function(){this.queue.clear(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i;return this.queue.push({hash:s,depth:e.depth,shaderId:a.shader.id,subModel:n,cmdBuff:n.commandBuffers[i]}),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),t}(),Zx=[],Jx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._uiQueue=void 0,t._uiQueue=new Qx({isTransparent:!0,phases:ub("default"),sortFunc:Kx}),t}return d(i,Nx),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Po.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._uiQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._uiQueue.insertRenderPass(a,s,o)}this._uiQueue.sort();var l=e.window.framebuffer,c=this._cmdBuff,u=e.camera;this._renderArea.width=this.flow.pipeline.root.device.width,this._renderArea.height=this.flow.pipeline.root.device.height,c.begin(),c.beginRenderPass(l,this._renderArea,Zo.DEPTH_STENCIL,[],u.clearDepth,u.clearStencil),c.execute(this._uiQueue.cmdBuffs.array,this._uiQueue.cmdBuffCount),c.endRenderPass(),c.end(),Zx[0]=c,this._device.queue.submit(Zx)}}]),i}(),$x=function(e){function i(e){return y(this,i),T(this,S(i).call(this,e))}return d(i,Bx),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._pipeline.root.mainWindow;return!(!t||!t.framebuffer)&&(this.createStage(Jx,{name:"UIStage",priority:0,framebuffer:t.framebuffer}),!0)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=this.pipeline.defaultGlobalUBOData[rm.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[rm.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(rm.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),p(S(i.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[rm.EXPOSURE_OFFSET+2]=t,this.pipeline.globalBindings.get(rm.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),i}();var eE,tE,iE=[],nE=[],rE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._opaqueQueue=void 0,t._transparentQueue=void 0,t._opaqueQueue=new Qx({isTransparent:!1,phases:ub("default"),sortFunc:Yx}),t._transparentQueue=new Qx({isTransparent:!0,phases:ub("default")|ub("planarShadow"),sortFunc:Kx}),t}return d(i,Nx),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Po.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueQueue.clear(),this._transparentQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._opaqueQueue.insertRenderPass(a,s,o),this._transparentQueue.insertRenderPass(a,s,o)}this._opaqueQueue.sort(),this._transparentQueue.sort();var l=e.camera,c=this._cmdBuff,u=l.viewport;if(this._renderArea.x=u.x*l.width,this._renderArea.y=u.y*l.height,this._renderArea.width=u.width*l.width*this.pipeline.shadingScale,this._renderArea.height=u.height*l.height*this.pipeline.shadingScale,l.clearFlag&Zo.COLOR){if(iE[0]=l.clearColor,this._pipeline.isHDR){iE[0]=function(e){return{r:Math.pow(e.r,2.2),g:Math.pow(e.g,2.2),b:Math.pow(e.b,2.2),a:1}}(iE[0]);var h=this._pipeline.fpScale/l.exposure;iE[0].r*=h,iE[0].g*=h,iE[0].b*=h}iE.length=1}this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.msaaShadingFBO:this._framebuffer=this._pipeline.curShadingFBO:this._framebuffer=e.window.framebuffer;var _=l.scene.planarShadows;c.begin(),c.beginRenderPass(this._framebuffer,this._renderArea,l.clearFlag,iE,l.clearDepth,l.clearStencil),c.execute(this._opaqueQueue.cmdBuffs.array,this._opaqueQueue.cmdBuffCount),c.execute(_.cmdBuffs.array,_.cmdBuffCount),c.execute(this._transparentQueue.cmdBuffs.array,this._transparentQueue.cmdBuffCount),c.endRenderPass(),c.end(),nE[0]=c,this._device.queue.submit(nE),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.curShadingFBO,this._renderArea,this._renderArea,vo.POINT)}}]),i}();(tE=eE||(eE={}))[tE.FORWARD=0]="FORWARD";var aE,sE,oE=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return d(t,Bx),l(t,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this.createStage(rE,{name:"ForwardStage",priority:eE.FORWARD}),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}();(sE=aE||(aE={}))[sE.FORWARD=0]="FORWARD",sE[sE.UI=10]="UI";var lE,cE,uE,hE,_E,fE,dE,pE,mE=new Float32Array(4),vE=ky.create(0,0,0,1),yE=[],gE=[],bE=new Xi,SE=function(e){function _(e){var t;return y(this,_),(t=T(this,S(_).call(this,e)))._uboLights=new cm,t._lightsUBO=null,t._validLights=void 0,t._lightIndexOffset=void 0,t._lightIndices=void 0,t._validLights=[],t._lightIndexOffset=[],t._lightIndices=[],t}return d(_,Xx),l(_,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),l(_,[{key:"initialize",value:function(e){if(!this._initialize(e))return!1;if(this._name="ForwardPipeline",!this._globalBindings.get(cm.BLOCK.name)){var t=this._root.device.createBuffer({usage:qs.UNIFORM|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:cm.SIZE});if(!t)return!1;this._globalBindings.set(cm.BLOCK.name,{type:Io.UNIFORM_BUFFER,blockInfo:cm.BLOCK,buffer:t})}var i=this._root.mainWindow,n=null;return i&&(n=i.renderPass),n?(this.addRenderPass(Xp.DEFAULT,n),this.createFlow(oE,{name:"ForwardFlow",priority:aE.FORWARD}),this._usePostProcess&&(this._useSMAA,this.createFlow(Gx,{name:"ToneMapFlow",priority:0})),this.createFlow($x,{name:"UIFlow",priority:aE.UI}),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"destroy",value:function(){var e=this._globalBindings.get(cm.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(cm.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){p(S(_.prototype),"rebuild",this).call(this);var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}},{key:"updateUBOs",value:function(e){p(S(_.prototype),"updateUBOs",this).call(this,e);for(var t=e.camera.exposure,i=0;i<this._renderObjects.length;i++){this._uboLights.view.fill(0);var n=i+1<this._renderObjects.length?this._lightIndexOffset[i+1]:this._lightIndices.length;if(this._renderObjects[i].model.localBindings.get(cm.BLOCK.name)){for(var r=0,a=0,s=this._lightIndexOffset[i];s<n;s++){var o=this._validLights[this._lightIndices[s]];if(o&&o.enabled)switch(o.type){case Ox.SPHERE:if(cm.MAX_SPHERE_LIGHTS<=r)continue;var l=o;if(Xi.array(mE,l.position),this._uboLights.view.set(mE,cm.SPHERE_LIGHT_POS_OFFSET+4*r),mE[0]=l.size,mE[1]=l.range,mE[2]=0,this._uboLights.view.set(mE,cm.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*r),Xi.array(mE,o.color),o.useColorTemperature){var c=o.colorTemperatureRGB;mE[0]*=c.x,mE[1]*=c.y,mE[2]*=c.z}mE[3]=l.luminance*this._lightMeterScale,this._isHDR?mE[3]=l.luminance*this._fpScale*this._lightMeterScale:mE[3]=l.luminance*t*this._lightMeterScale,this._uboLights.view.set(mE,cm.SPHERE_LIGHT_COLOR_OFFSET+4*r),r++;break;case Ox.SPOT:if(cm.MAX_SPOT_LIGHTS<=a)continue;var u=o;if(Xi.array(mE,u.position),mE[3]=u.size,this._uboLights.view.set(mE,cm.SPOT_LIGHT_POS_OFFSET+4*a),mE[0]=u.size,mE[1]=u.range,mE[2]=u.spotAngle,this._uboLights.view.set(mE,cm.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*a),Xi.array(mE,u.direction),this._uboLights.view.set(mE,cm.SPOT_LIGHT_DIR_OFFSET+4*a),Xi.array(mE,o.color),o.useColorTemperature){var h=o.colorTemperatureRGB;mE[0]*=h.x,mE[1]*=h.y,mE[2]*=h.z}this._isHDR?mE[3]=u.luminance*this._fpScale*this._lightMeterScale:mE[3]=u.luminance*t*this._lightMeterScale,this._uboLights.view.set(mE,cm.SPOT_LIGHT_COLOR_OFFSET+4*a),a++}}this._renderObjects[i].model.localBindings.get(cm.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){p(S(_.prototype),"sceneCulling",this).call(this,e),this._validLights.splice(0);var t=e.camera.scene.sphereLights,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.enabled&&(a.update(),ky.set(vE,a.position.x,a.position.y,a.position.z,a.range),vy.sphere_frustum(vE,e.camera.frustum)&&this._validLights.push(a))}var s=e.camera.scene.spotLights,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;u.enabled&&(u.update(),ky.set(vE,u.position.x,u.position.y,u.position.z,u.range),vy.sphere_frustum(vE,e.camera.frustum)&&this._validLights.push(u))}this._lightIndexOffset.splice(0),this._lightIndices.splice(0);for(var h=0;h<this._renderObjects.length;h++)this._lightIndexOffset[h]=this._lightIndices.length,this._renderObjects[h].model.localBindings.get(cm.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[h].model)}},{key:"cullLightPerModel",value:function(e){var t,i,n,r,a;yE.splice(0);for(var s=0;s<this._validLights.length;s++){var o=!1;switch(this._validLights[s].type){case Ox.DIRECTIONAL:this._validLights[s],o=!1;break;case Ox.SPHERE:r=this._validLights[s],o=!(!(a=e).worldBounds||vy.aabb_aabb(a.worldBounds,r.aabb));break;case Ox.SPOT:i=this._validLights[s],o=!(!(n=e).worldBounds||vy.aabb_aabb(n.worldBounds,i.aabb)&&vy.aabb_frustum(n.worldBounds,i.frustum))}o||(yE.push(s),this._validLights[s].type===Ox.DIRECTIONAL?gE[s]=0:gE[s]=Xi.distance(this._validLights[s].position,e.node.getWorldPosition(bE)))}yE.sort(this.sortLight),(t=this._lightIndices).push.apply(t,yE)}},{key:"sortLight",value:function(e,t){return gE[e]-gE[t]}}]),_}();(cE=lE||(lE={}))[cE.ORTHO=0]="ORTHO",cE[cE.PERSPECTIVE=1]="PERSPECTIVE",(hE=uE||(uE={}))[hE.F1_8=0]="F1_8",hE[hE.F2_0=1]="F2_0",hE[hE.F2_2=2]="F2_2",hE[hE.F2_5=3]="F2_5",hE[hE.F2_8=4]="F2_8",hE[hE.F3_2=5]="F3_2",hE[hE.F3_5=6]="F3_5",hE[hE.F4_0=7]="F4_0",hE[hE.F4_5=8]="F4_5",hE[hE.F5_0=9]="F5_0",hE[hE.F5_6=10]="F5_6",hE[hE.F6_3=11]="F6_3",hE[hE.F7_1=12]="F7_1",hE[hE.F8_0=13]="F8_0",hE[hE.F9_0=14]="F9_0",hE[hE.F10_0=15]="F10_0",hE[hE.F11_0=16]="F11_0",hE[hE.F13_0=17]="F13_0",hE[hE.F14_0=18]="F14_0",hE[hE.F16_0=19]="F16_0",hE[hE.F18_0=20]="F18_0",hE[hE.F20_0=21]="F20_0",hE[hE.F22_0=22]="F22_0",(fE=_E||(_E={}))[fE.ISO100=0]="ISO100",fE[fE.ISO200=1]="ISO200",fE[fE.ISO400=2]="ISO400",fE[fE.ISO800=3]="ISO800",(pE=dE||(dE={}))[pE.D1=0]="D1",pE[pE.D2=1]="D2",pE[pE.D4=2]="D4",pE[pE.D8=3]="D8",pE[pE.D15=4]="D15",pE[pE.D30=5]="D30",pE[pE.D60=6]="D60",pE[pE.D125=7]="D125",pE[pE.D250=8]="D250",pE[pE.D500=9]="D500",pE[pE.D1000=10]="D1000",pE[pE.D2000=11]="D2000",pE[pE.D4000=12]="D4000";var TE,xE,EE=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],wE=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],AE=[100,200,400,800],CE=cc.v3(),kE=cc.v3(),RE=cc.mat4(),OE=cc.mat4();(xE=TE||(TE={}))[xE.GENERAL=1610612736]="GENERAL",xE[xE.PROFILER=268435456]="PROFILER";var ME,LE,IE=function(){function n(e,t){y(this,n),this._scene=void 0,this._name=void 0,this._enabled=!1,this._proj=void 0,this._isWindowSize=!0,this._width=void 0,this._height=void 0,this._screenScale=void 0,this._aspect=void 0,this._orthoHeight=10,this._fov=ki(45),this._nearClip=1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=Zo.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new er(0,0,1,1),this._isProjDirty=!0,this._matView=new Nn,this._matProj=new Nn,this._matViewProj=new Nn,this._matViewProjInv=new Nn,this._frustum=new Vy,this._forward=new Xi,this._position=new Xi,this._node=null,this._view=void 0,this._visibility=TE.GENERAL,this._priority=0,this._aperture=uE.F16_0,this._apertureValue=void 0,this._shutter=dE.D125,this._shutterValue=0,this._iso=_E.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._scene=e,this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._apertureValue=EE[this._aperture],this._shutterValue=wE[this._shutter],this._isoValue=AE[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1;var i=void 0!==t.isUI&&t.isUI;this._view=this._scene.root.createView({camera:this,name:this._name,priority:this._priority,isUI:i,flows:t.flows}),this.changeTargetWindow(t.window),console.log("Create Camera: "+this._name+" "+this._width+" x "+this._height)}return l(n,[{key:"destroy",value:function(){this._scene.root.destroyView(this._view)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(this._node){if((this._node.hasChangedFlags||e)&&(Nn.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty)if(this._proj===lE.PERSPECTIVE)Nn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var t=this._orthoHeight*this._aspect,i=this._orthoHeight;Nn.ortho(this._matProj,-t,t,-i,i,this._nearClip,this._farClip)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(Nn.multiply(this._matViewProj,this._matProj,this._matView),Nn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),Nn.invert(this._matView,this.node.worldMatrix),this._proj===lE.PERSPECTIVE)Nn.perspective(RE,this._fov,this._aspect,t,i);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;Nn.ortho(RE,-n,n,-r,r,t,i)}Nn.multiply(OE,RE,this._matView),Nn.invert(RE,OE),e.update(OE,RE)}}},{key:"changeTargetWindow",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=this._scene,i=e||t.root.mainWindow;i&&(this._view.window=i,this.resize(i.width,i.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this._viewport.x*this._width,r=this._viewport.y*this._height,a=this._viewport.width*this._width,s=this._viewport.height*this._height;return Xi.set(CE,(t-n)/a*2-1,(i-r)/s*2-1,1),Xi.transformMat4(CE,CE,this._matViewProjInv),this._proj===lE.PERSPECTIVE?this._node&&this._node.getWorldPosition(kE):(Xi.set(kE,(t-n)/a*2-1,(i-r)/s*2-1,-1),Xi.transformMat4(kE,kE,this._matViewProjInv)),Ey.fromPoints(e,kE,CE)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return this._proj===lE.PERSPECTIVE?(Xi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),Xi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(CE),Xi.lerp(e,CE,e,Ci(this._nearClip/this._farClip,1,t.z))):(Xi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),Xi.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return Xi.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize},set:function(e){this._isWindowSize=e}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum}},{key:"forward",get:function(){return this._forward}},{key:"position",get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view.visibility=e},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view.priority},set:function(e){this._priority=e,this._view.priority=this._priority}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=EE[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=wE[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=AE[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}}]),n}();(LE=ME||(ME={}))[LE.GENERAL=100]="GENERAL";var FE=function(){function i(e,t){y(this,i),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=TE.GENERAL,this._camera=void 0,this._isEnable=!0,this._isUI=!1,this._flows=[],this._root=e,this._camera=t}return l(i,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this.isUI&&(this._priority|=1<<30)}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"isUI",get:function(){return this._isUI}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(e){e._createViewFun=function(e,t){return new i(e,t)}}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._isUI=e.isUI,this.priority=e.priority,e.flows||(e.flows=["ForwardFlow","ToneMapFlow","SMAAFlow"]);var t=cc.director.root.pipeline.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;-1!==e.flows.indexOf(a.name)&&this.flows.push(a)}return!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}}]),i}(),PE=new Xi(0,0,-1),DE=new Xi,zE=new vn,BE=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._dir=new Xi(1,-1,-1),n._illum=65e3,n._type=Ox.DIRECTIONAL,n}return d(r,Px),l(r,[{key:"direction",set:function(e){this._dir=e,Xi.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),l(r,[{key:"update",value:function(){this._node&&(this._dir=Xi.transformQuat(DE,PE,this._node.getWorldRotation(zE)),Xi.normalize(this._dir,this._dir))}}]),r}(),NE=Il([vo.POINT,vo.POINT,vo.NONE,go.CLAMP,go.CLAMP,go.CLAMP]),UE=function(e){function s(e,t){var i;y(this,s),(i=T(this,S(s).call(this,e,t))).uploadedAnim=null,i._jointsMedium=void 0,i._skeleton=null,i._type="skinning";var n=new Float32Array(4),r=i._scene.texturePool.getDefaultJointsTexture();return i._jointsMedium={buffer:null,jointsTextureInfo:n,texture:r},i}return d(s,CS),l(s,[{key:"worldBounds",get:function(){return this.uploadedAnim?null:this._worldBounds}}]),l(s,[{key:"destroy",value:function(){p(S(s.prototype),"destroy",this).call(this),this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null)}},{key:"bindSkeleton",value:function(e,t){(this._skeleton=e)&&t&&(this._transform=t,this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:qs.UNIFORM|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:um.SIZE,stride:um.SIZE})),this.uploadAnimation(this.uploadedAnim))}},{key:"uploadAnimation",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;if(this._skeleton){this.uploadedAnim=e;var t=this.uploadedAnim?this._scene.texturePool.getJointsTextureWithAnimation(this._skeleton,this.uploadedAnim):this._scene.texturePool.getDefaultJointsTexture(this._skeleton);this._applyJointsTexture(t)}}},{key:"setFrameID",value:function(e){var t=this._jointsMedium,i=t.buffer,n=t.jointsTextureInfo;n[3]=e,i&&i.update(n)}},{key:"getFrameID",value:function(){return this._jointsMedium.jointsTextureInfo[3]}},{key:"_applyJointsTexture",value:function(e){if(e){this._jointsMedium.texture=e;var t=this._jointsMedium,i=t.buffer,n=t.jointsTextureInfo;n[0]=e.handle.texture.width,n[1]=e.pixelOffset+.1,n[2]=this.uploadedAnim?this.uploadedAnim.keys[0].length:1,n[3]=0,i&&i.update(n);var r=Yl.getSampler(this._device,NE),a=this._subModels,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;if(c.psos){var u=c.psos,h=Array.isArray(u),_=0;for(u=h?u:u[Symbol.iterator]();;){var f;if(h){if(_>=u.length)break;f=u[_++]}else{if((_=u.next()).done)break;f=_.value}var d=f;d.pipelineLayout.layouts[0].bindTextureView(hm.binding,e.handle.texView),d.pipelineLayout.layouts[0].bindSampler(hm.binding,r)}}}}}},{key:"_doCreatePSO",value:function(e){var t=p(S(s.prototype),"_doCreatePSO",this).call(this,e),i=this._jointsMedium,n=i.buffer,r=i.texture;t.pipelineLayout.layouts[0].bindBuffer(um.BLOCK.binding,n);var a=Yl.getSampler(this._device,NE);return r&&(t.pipelineLayout.layouts[0].bindTextureView(hm.binding,r.handle.texView),t.pipelineLayout.layouts[0].bindSampler(hm.binding,a)),t}}]),s}(),GE=new Xi(0,0,-1),VE=new Xi,HE=new vn,jE=function(){function n(e){y(this,n),this._scene=void 0,this._enabled=!1,this._normal=new Xi(0,1,0),this._distance=0,this._matLight=new Nn,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._cmdBuffs=void 0,this._cmdBuffCount=0,this._psoRecord=new Map,this._cbRecord=new Map,this._passNormal=void 0,this._passSkinning=void 0,this._scene=e,this._globalBindings=e.root.pipeline.globalBindings.get(am.BLOCK.name),this._cmdBuffs=new qx(64);var t=wm.get("pipeline/planar-shadow"),i={CC_USE_SKINNING:Xg(e.root.device)};this._passNormal=vb.createPasses(t,{techIdx:0,defines:[],states:[]})[0],this._passSkinning=vb.createPasses(t,{techIdx:0,defines:[i],states:[]})[0]}return l(n,[{key:"enabled",set:function(e){this._enabled=e,this.updateDirLight(),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){Xi.copy(this._normal,e),this.updateDirLight()},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this.updateDirLight()},get:function(){return this._distance}},{key:"shadowColor",set:function(e){or.array(this._data,e,am.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),l(n,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(VE);var t=this._normal,i=this._distance,n=Xi.dot(t,VE),r=VE.x,a=VE.y,s=VE.z,o=t.x,l=t.y,c=t.z,u=this._matLight;u.m00=n-i-r*o,u.m01=-a*o,u.m02=-s*o,u.m03=-o,u.m04=-r*l,u.m05=n-i-a*l,u.m06=-s*l,u.m07=-l,u.m08=-r*c,u.m09=-a*c,u.m10=n-i-s*c,u.m11=-c,u.m12=r*i,u.m13=a*i,u.m14=s*i,u.m15=n,Nn.array(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(){(0<arguments.length&&void 0!==arguments[0]?arguments[0]:this._scene.mainLight).node.getWorldRotation(HE),Xi.transformQuat(VE,GE,HE);var e=this._normal,t=this._distance,i=1/Xi.dot(e,VE),n=VE.x*i,r=VE.y*i,a=VE.z*i,s=e.x,o=e.y,l=e.z,c=this._matLight;c.m00=1-s*n,c.m01=-s*r,c.m02=-s*a,c.m03=0,c.m04=-o*n,c.m05=1-o*r,c.m06=-o*a,c.m07=0,c.m08=-l*n,c.m09=-l*r,c.m10=1-l*a,c.m11=0,c.m12=n*t,c.m13=r*t,c.m14=a*t,c.m15=1,Nn.array(this.data,this._matLight,am.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(){if(this._cmdBuffs.clear(),this._scene.mainLight.enabled){var e=this._scene.models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(r.enabled&&r.node&&r.castShadow){var a=this._psoRecord.get(r);a||(a=this._createPSO(r),this._psoRecord.set(r,a)),r.UBOUpdated||r.updateUBOs();for(var s=0;s<r.subModelNum;s++){var o=r.getSubModel(s).inputAssembler;if(o){var l=this._cbRecord.get(o);l||((l=this._createCommandBuffer()).begin(),l.bindPipelineState(a),l.bindBindingLayout(a.pipelineLayout.layouts[0]),l.bindInputAssembler(o),l.draw(o),l.end(),this._cbRecord.set(o,l)),this.cmdBuffs.push(l)}}}}}}},{key:"onPipelineChange",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._psoRecord.keys(),n=i.next();!n.done;){(n.value instanceof UE?this._passSkinning:this._passNormal).destroyPipelineState(this._psoRecord.get(n.value)),n=i.next()}this._psoRecord.clear()}},{key:"destroy",value:function(){this.onPipelineChange(),this._passNormal.destroy(),this._passSkinning.destroy()}},{key:"_createPSO",value:function(e){var t=e instanceof UE?this._passSkinning:this._passNormal,i=e._doCreatePSO(t);return i.pipelineLayout.layouts[0].update(),i}},{key:"_createCommandBuffer",value:function(){var e=this._scene.root.device;return e.createCommandBuffer({allocator:e.commandAllocator,type:Po.SECONDARY})}}]),n}();function WE(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function XE(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,s=(e.length||1)/2,p=[Xi.set(ZE,-r,-a,s),Xi.set(JE,r,-a,s),Xi.set($E,r,a,s),Xi.set(ew,-r,a,s),Xi.set(tw,r,-a,-s),Xi.set(iw,-r,-a,-s),Xi.set(nw,-r,a,-s),Xi.set(rw,r,a,-s)],m=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],v=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],y=[],g=[],b=[],S=[],o=new Xi(-r,-a,-s),l=new Xi(r,a,s),c=Math.sqrt(r*r+a*a+s*s);function u(e,t,i){var n,r,a,s,o=y.length/3,l=m[e],c=v[e];for(s=0;s<=i;s++)for(a=0;a<=t;a++)if(n=a/t,r=s/i,Xi.lerp(qE,p[l[0]],p[l[1]],n),Xi.lerp(YE,p[l[0]],p[l[2]],r),Xi.subtract(KE,YE,p[l[0]]),Xi.add(QE,qE,KE),y.push(QE.x,QE.y,QE.z),g.push(c[0],c[1],c[2]),b.push(n,r),a<t&&s<i){var u=t+1,h=a+s*u,_=a+(s+1)*u,f=a+1+(s+1)*u,d=a+1+s*u;S.push(o+h,o+d,o+_),S.push(o+_,o+d,o+f)}}return u(0,t,i),u(4,n,i),u(1,t,i),u(5,n,i),u(3,t,n),u(2,t,n),{positions:y,normals:g,uvs:b,indices:S,minPos:o,maxPos:l,boundingRadius:c}}var qE=new Xi,YE=new Xi,KE=new Xi,QE=new Xi,ZE=new Xi,JE=new Xi,$E=new Xi,ew=new Xi,tw=new Xi,iw=new Xi,nw=new Xi,rw=new Xi,aw=new Xi(0,0,0),sw=new Xi(0,0,0);function ow(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},S=.5*b,T=e.radialSegments||32,x=e.heightSegments||1,t=void 0===e.capped||e.capped,E=e.arc||2*Math.PI,i=0;t||(0<y&&i++,0<g&&i++);var n=(T+1)*(x+1);t&&(n+=(T+1)*i+T*i);var r=T*x*2*3;t&&(r+=T*i*3);var w=new Array(r),A=new Array(3*n),C=new Array(3*n),k=new Array(2*n),a=Math.max(y,g),s=new Xi(-a,-S,-a),o=new Xi(a,S,a),l=Math.sqrt(a*a+S*S),R=0,O=0;return function(){for(var e=[],t=y-g,i=t*t/b*Math.sign(t),n=0;n<=x;n++){for(var r=[],a=n/x,s=a*t+g,o=0;o<=T;++o){var l=o/T,c=l*E,u=Math.sin(c),h=Math.cos(c);A[3*R]=s*u,A[3*R+1]=a*b-S,A[3*R+2]=s*h,Xi.normalize(aw,Xi.set(sw,u,-i,h)),C[3*R]=aw.x,C[3*R+1]=aw.y,C[3*R+2]=aw.z,k[2*R]=2*(1-l)%1,k[2*R+1]=a,r.push(R),++R}e.push(r)}for(var _=0;_<x;++_)for(var f=0;f<T;++f){var d=e[_][f],p=e[_+1][f],m=e[_+1][f+1],v=e[_][f+1];w[O]=d,w[++O]=v,w[++O]=p,w[++O]=v,w[++O]=m,w[++O]=p,++O}}(),t&&(0<g&&c(!1),0<y&&c(!0)),{positions:A,normals:C,uvs:k,indices:w,minPos:s,maxPos:o,boundingRadius:l};function c(e){for(var t=e?y:g,i=e?1:-1,n=R,r=1;r<=T;++r)A[3*R]=0,A[3*R+1]=S*i,A[3*R+2]=0,C[3*R]=0,C[3*R+1]=i,C[3*R+2]=0,k[2*R]=.5,k[2*R+1]=.5,++R;for(var a=R,s=0;s<=T;++s){var o=s/T*E,l=Math.cos(o),c=Math.sin(o);A[3*R]=t*c,A[3*R+1]=S*i,A[3*R+2]=t*l,C[3*R]=0,C[3*R+1]=i,C[3*R+2]=0,k[2*R]=.5-.5*c*i,k[2*R+1]=.5+.5*l,++R}for(var u=0;u<T;++u){var h=n+u,_=a+u;e?(w[O]=_+1,w[++O]=h):(w[O]=h,w[++O]=_+1),w[++O]=_,++O}}}var lw=new Xi(0,0,0),cw=new Xi(0,0,0),uw=new Xi(0,0,0),hw=new Xi(0,0,0),_w=new Xi(0,0,0),fw=new Xi(0,0,0),dw=new Xi(0,0,0);var pw=new Xi(0,0,0),mw=new Xi(0,0,0);var vw,yw,gw,bw,Sw,Tw,xw,Ew,ww,Aw,Cw,kw,Rw,Ow,Mw,Lw,Iw,Fw,Pw,Dw,zw,Bw,Nw,Uw,Gw,Vw,Hw,jw,Ww=Object.freeze({box:XE,cone:function(){return ow(0,0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:{})},cylinder:ow,plane:function(e){var t=function(e){return(e=WE(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,s=.5*i,o=.5*n,l=[],c=[],u=[],h=new Xi(-s,0,-o),_=new Xi(s,0,o),f=Math.sqrt(i*i+n*n);Xi.set(_w,-s,0,o),Xi.set(fw,s,0,o),Xi.set(dw,-s,0,-o);for(var d=0;d<=a;d++)for(var p=0;p<=r;p++){var m=p/r,v=d/a;if(Xi.lerp(lw,_w,fw,m),Xi.lerp(cw,_w,dw,v),Xi.subtract(uw,cw,_w),Xi.add(hw,lw,uw),l.push(hw.x,hw.y,hw.z),t.includeUV&&c.push(m,v),p<r&&d<a){var y=r+1,g=p+d*y,b=p+(d+1)*y,S=p+1+(d+1)*y,T=p+1+d*y;u.push(g,T,b),u.push(T,S,b)}}var x={positions:l,indices:u,minPos:h,maxPos:_,boundingRadius:f};if(t.includeNormal){var E=(a+1)*(r+1),w=new Array(3*E);x.normals=w;for(var A=0;A<E;++A)w[3*A+0]=0,w[3*A+1]=1,w[3*A+2]=0}return t.includeUV&&(x.uvs=c),x},quad:function(e){var t=WE(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],s=[],o=new Xi(-e,-e,-e),l=new Xi(e,e,e),c=e,u=0;u<=i;++u)for(var h=u*Math.PI/i,_=Math.sin(h),f=-Math.cos(h),d=0;d<=i;++d){var p=2*d*Math.PI/i-Math.PI/2,m=Math.sin(p)*_,v=f,y=Math.cos(p)*_,g=d/i,b=u/i;if(n.push(m*e,v*e,y*e),r.push(m,v,y),a.push(g,b),u<i&&d<i){var S=i+1,T=S*u+d,x=S*(u+1)+d,E=S*(u+1)+d+1,w=S*u+d+1;s.push(T,w,x),s.push(w,E,x)}}return{positions:n,indices:s,normals:r,uvs:a,minPos:o,maxPos:l,boundingRadius:c}},torus:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,s=[],o=[],l=[],c=[],u=new Xi(-e-t,-t,-e-t),h=new Xi(e+t,t,e+t),_=e+t,f=0;f<=n;f++)for(var d=0;d<=r;d++){var p=d/r,m=f/n,v=p*a,y=m*Math.PI*2,g=(e+t*Math.cos(y))*Math.sin(v),b=t*Math.sin(y),S=(e+t*Math.cos(y))*Math.cos(v),T=Math.sin(v)*Math.cos(y),x=Math.sin(y),E=Math.cos(v)*Math.cos(y);if(s.push(g,b,S),o.push(T,x,E),l.push(p,m),d<r&&f<n){var w=r+1,A=w*f+d,C=w*(f+1)+d,k=w*(f+1)+d+1,R=w*f+d+1;c.push(A,R,C),c.push(R,k,C)}}return{positions:s,normals:o,uvs:l,indices:c,minPos:u,maxPos:h,boundingRadius:_}},capsule:function(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},v=e-y-g,b=t.sides||32,S=t.heightSegments||32,T=g/e,x=v/e,E=y/e,w=Math.floor(S*T),A=Math.floor(S*E),C=Math.floor(S*x),k=v+g-e/2,R=g-e/2,O=g-e/2,M=t.arc||2*Math.PI,L=[],I=[],F=[],P=[],i=Math.max(y,g),n=new Xi(-i,-e/2,-i),r=new Xi(i,e/2,i),a=e/2,D=0,z=[];return function(){for(var e=0;e<=w;++e)for(var t=e*Math.PI/w/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,c=n,u=o*i,h=r/b,_=e/S;if(L.push(l*g,c*g+O,u*g),I.push(l,c,u),F.push(h,_),e<w&&r<b){var f=b+1,d=f*e+r,p=f*(e+1)+r,m=f*(e+1)+r+1,v=f*e+r+1;P.push(d,v,p),P.push(v,m,p)}++D}}(),function(){for(var e=(y-g)/v,t=0;t<=C;t++){for(var i=[],n=t/C,r=n*(y-g)+g,a=0;a<=b;++a){var s=a/b,o=n*x+T,l=s*M-M/4,c=Math.sin(l),u=Math.cos(l);L.push(r*c),L.push(n*v+R),L.push(r*u),Xi.normalize(pw,Xi.set(mw,c,-e,u)),I.push(pw.x),I.push(pw.y),I.push(pw.z),F.push(s,o),i.push(D),++D}z.push(i)}for(var h=0;h<C;++h)for(var _=0;_<b;++_){var f=z[h][_],d=z[h+1][_],p=z[h+1][_+1],m=z[h][_+1];P.push(f),P.push(m),P.push(d),P.push(m),P.push(p),P.push(d)}}(),function(){for(var e=0;e<=A;++e)for(var t=e*Math.PI/A/2+Math.PI/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,c=n,u=o*i,h=r/b,_=e/S+(1-E);if(L.push(l*y,c*y+k,u*y),I.push(l,c,u),F.push(h,_),e<A&&r<b){var f=b+1,d=f*e+r+z[C][b]+1,p=f*(e+1)+r+z[C][b]+1,m=f*(e+1)+r+1+z[C][b]+1,v=f*e+r+1+z[C][b]+1;P.push(d,v,p),P.push(v,m,p)}}}(),{positions:L,normals:I,uvs:F,indices:P,minPos:n,maxPos:r,boundingRadius:a}},circle:function(e){var t=function(e){return(e=WE(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var s=r*a,o=Math.cos(s),l=Math.sin(s),c=3*(a+1);i[0+c]=o,i[1+c]=l,i[2+c]=0;var u=2*a;n[1+u]=a+1,n[1+u+1]=a+2}return 0<t&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Zt.GFXPrimitiveMode.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,c=3*s+2;e.positions[o]=e.positions[o]+i,e.positions[l]=e.positions[l]+n,e.positions[c]=e.positions[c]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,c=3*s+2;e.positions[o]*=i,e.positions[l]*=n,e.positions[c]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Zt.GFXPrimitiveMode.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var s=0;s<3;++s){var o=t[a+i[s][0]],l=t[a+i[s][1]],c=l<o?l<<16|o:o<<16|l;void 0===r[c]&&(r[c]=0,n.push(o,l))}return e.indices=n,e.primitiveMode=Zt.GFXPrimitiveMode.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var s=e[r+t[a][0]],o=e[r+t[a][1]],l=o<s?o<<16|s:s<<16|o;void 0===n[l]&&(n[l]=0,i.push(s,o))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Zt.GFXPrimitiveMode.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,s=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},o="",l=0;l<i.length;l+=3)o+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var c=0;c<n.length;c+=2)o+="vt ".concat(n[c]," ").concat(n[c+1],"\n");for(var u=0;u<r.length;u+=3)o+="vn ".concat(r[u]," ").concat(r[u+1]," ").concat(r[u+2],"\n");for(var h=0;h<a.length;h+=3)o+="f ".concat(s(h)," ").concat(s(h+1)," ").concat(s(h+2),"\n");return o},normals:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,s=6*r;n[0+s]=e[0+a],n[1+s]=e[1+a],n[2+s]=e[2+a],n[3+s]=e[0+a]+t[0+a]*i,n[4+s]=e[1+a]+t[1+a]*i,n[5+s]=e[2+a]+t[2+a]*i}return n},applyDefaultGeometryOptions:WE}),Xw=function(e){function n(e){var t;y(this,n),(t=T(this,S(n).call(this,e,null)))._default=cb.get("default-cube-texture"),t._envmap=t._default,t._isRGBE=!1,t._useIBL=!1,t._material=new zb,t._globalBinding=void 0,t._scene=e,t._material.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t._isRGBE}}),t._globalBinding=t._scene.root.pipeline.globalBindings.get(sm.name);var i=ug(XE({width:2,height:2,length:2})).renderingMesh.getSubmesh(0);return t.initSubModel(0,i,t._material),t._updateGlobalBinding(),t}return d(n,CS),l(n,[{key:"useIBL",set:function(e){this._useIBL=e;var t=this._scene.root.pipeline;!!t.macros.CC_USE_IBL!==e&&(t.macros.CC_USE_IBL=e,this._scene.onPipelineChange(),this._updateGlobalBinding())},get:function(){return this._useIBL}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._updateGlobalBinding()},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){e!==this._isRGBE&&(this._isRGBE=e,this._material.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,this._material),this._updateGlobalBinding())},get:function(){return this._isRGBE}}]),l(n,[{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=Yl.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=this._material;i.passes[0].bindSampler(sm.binding,t),i.passes[0].bindTextureView(sm.binding,e);var n=this._matPSORecord.get(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s.pipelineLayout.layouts[0].update()}}}]),n}(),qw=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._size=.15,n._range=1,n._luminance=1700/Fx(n._size),n._pos=void 0,n._aabb=void 0,n._type=Ox.SPHERE,n._aabb=Py.create(),n._pos=new Xi,n}return d(r,Px),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),Py.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range))}}]),r}(),Yw=new Xi(0,0,-1),Kw=new Xi,Qw=new vn,Zw=new Nn,Jw=new Nn,$w=new Nn,eA=new Nn,tA=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._dir=new Xi(1,-1,-1),n._size=.15,n._range=5,n._luminance=1700/Fx(n._size),n._spotAngle=Math.cos(Math.PI/6),n._pos=void 0,n._aabb=void 0,n._frustum=void 0,n._angle=0,n._type=Ox.SPOT,n._aabb=Py.create(),n._frustum=Vy.create(),n._pos=new Xi,n}return d(r,Px),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),this._dir=Xi.transformQuat(Kw,Yw,this._node.getWorldRotation(Qw)),Xi.normalize(this._dir,this._dir),Py.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Zw),Nn.invert(Zw,Zw),Nn.perspective(Jw,this._angle,1,.001,this._range),Nn.multiply($w,Jw,Zw),Nn.invert(eA,$w),this._frustum.update($w,eA))}}]),r}(),iA=function(){function t(e){y(this,t),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._mainLight=void 0,this._defaultMainLightNode=void 0,this._sphereLights=[],this._spotLights=[],this._models=[],this._modelId=0,this._texturePool=void 0,this._root=e,this._ambient=new fd(this),this._defaultMainLightNode=new xf("Main Light"),this._mainLight=new BE(this,"Main Light",this._defaultMainLightNode),this._mainLight.illuminance=fd.SUN_ILLUM,this._mainLight.enabled=!1,this._ambient=new fd(this),this._skybox=new Xw(this),this._planarShadows=new jE(this),this._texturePool=new sb(e.device)}return l(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"defaultMainLightNode",get:function(){return this._defaultMainLightNode}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"texturePool",get:function(){return this._texturePool}}],[{key:"registerCreateFunc",value:function(e){e._createSceneFun=function(e){return new t(e)}}}]),l(t,[{key:"initialize",value:function(e){return this._name=e.name,this._texturePool.initialize(),!0}},{key:"destroy",value:function(){this.destroyCameras(),this.destroyPointLights(),this.destroySpotLights(),this.destroyModels(),this._planarShadows.destroy(),this._texturePool.destroy()}},{key:"createCamera",value:function(e){var t=new IE(this,e);return this._cameras.push(t),t}},{key:"destroyCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return e.destroy(),void this._cameras.splice(t,1)}},{key:"destroyCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._cameras.splice(0)}},{key:"createSphereLight",value:function(e,t){var i=new qw(this,e,t);return this._sphereLights.push(i),i}},{key:"destroySphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return void this._sphereLights.splice(t,1)}},{key:"createSpotLight",value:function(e,t){var i=new tA(this,e,t);return this._spotLights.push(i),i}},{key:"destroySpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return void this._spotLights.splice(t,1)}},{key:"destroyPointLights",value:function(){this._sphereLights=[]}},{key:"destroySpotLights",value:function(){this._spotLights=[]}},{key:"createModel",value:function(e,t){var i=new e(this,t);return this._models.push(i),i}},{key:"destroyModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return void this._models.splice(t,1)[0].destroy()}},{key:"destroyModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._models=[]}},{key:"onPipelineChange",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}this._skybox.onPipelineChange(),this._planarShadows.onPipelineChange()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycast",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:lf.RaycastMask;lA.reset();var i=this._models,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.transform;if(o&&s.enabled&&cc.Layers.check(s.node.layer,t)&&s.modelBounds&&(Nn.invert(aA,o.getWorldMatrix(aA)),Xi.transformMat4(nA.o,e.o,aA),Xi.normalize(nA.d,Xi.transformMat4Normal(nA.d,e.d,aA)),!((sA=vy.ray_aabb(nA,s.modelBounds))<=0)))for(var l=0;l<s.subModelNum;++l){var c=s.getSubModel(l).subMeshData;if(c&&c.geometricInfo){var u=c.geometricInfo,h=u.positions,_=u.indices,f=u.doubleSided;fA(h,_,c.primitiveMode,f)}if(sA<1/0){var d=lA.add();d.node=s.node,d.distance=sA*Xi.multiply(rA,nA.d,o.worldScale).length(),cA[lA.length-1]=d}}}return cA.length=lA.length,cA}},{key:"raycastUI",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:lf.UI;hA.reset();var i=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=i&&0<i.length){var n=i[0].node;null!=n&&n.active&&this._raycastUINodeRecursiveChildren(e,t,n)}return _A.length=hA.length,_A}},{key:"raycastUINode",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:lf.UI,i=2<arguments.length?arguments[2]:void 0,n=i.uiTransfromComp;if(null!=n&&cc.Layers.check(i.layer,t)&&(n.getComputeAABB(uA),!((sA=vy.ray_aabb(e,uA))<=0))){var r=hA.add();return r.node=i,r.distance=sA,r}}},{key:"_raycastUINodeRecursiveChildren",value:function(e,t,i){var n=this.raycastUINode(e,t,i);null!=n&&(_A[hA.length-1]=n);var r=i.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;null!=l&&l.active&&this._raycastUINodeRecursiveChildren(e,t,l)}}}]),t}(),nA=Ey.create(),rA=new Xi,aA=new Nn,sA=1/0,oA=wy.create(),lA=new Qp(function(){return{node:null,distance:1/0}},8),cA=[],uA=new Py,hA=new Qp(function(){return{node:null,distance:1/0}},8),_A=[],fA=function(e,t,i,n){if(sA=1/0,i===Zt.GFXPrimitiveMode.TRIANGLE_LIST)for(var r=t.length,a=0;a<r;a+=3){var s=3*t[a],o=3*t[a+1],l=3*t[a+2];Xi.set(oA.a,e[s],e[1+s],e[2+s]),Xi.set(oA.b,e[o],e[1+o],e[2+o]),Xi.set(oA.c,e[l],e[1+l],e[2+l]);var c=vy.ray_triangle(nA,oA,n);c<=0||sA<c||(sA=c)}else if(i===Zt.GFXPrimitiveMode.TRIANGLE_STRIP)for(var u=t.length-2,h=0,_=0;_<u;_+=1){var f=3*t[_-h],d=3*t[_+h+1],p=3*t[_+2];Xi.set(oA.a,e[f],e[1+f],e[2+f]),Xi.set(oA.b,e[d],e[1+d],e[2+d]),Xi.set(oA.c,e[p],e[1+p],e[2+p]),h=~h;var m=vy.ray_triangle(nA,oA,n);m<=0||sA<m||(sA=m)}else if(i===Zt.GFXPrimitiveMode.TRIANGLE_FAN){var v=t.length-1,y=3*t[0];Xi.set(oA.a,e[y],e[1+y],e[2+y]);for(var g=1;g<v;g+=1){var b=3*t[g],S=3*t[g+1];Xi.set(oA.b,e[b],e[1+b],e[2+b]),Xi.set(oA.c,e[S],e[1+S],e[2+S]);var T=vy.ray_triangle(nA,oA,n);T<=0||sA<T||(sA=T)}}},dA=new Xi,pA=new Nn;function mA(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);var u=a.vData,h=a.iData;e.getWorldMatrix(pA);for(var _=0;_<o;_++){var f=r[_];Xi.set(dA,f.x,f.y,0),Xi.transformMat4(dA,dA,pA),u[s++]=dA.x,u[s++]=dA.y,u[s++]=dA.z,u[s++]=f.u,u[s++]=f.v,or.array(u,n,s),s+=4}for(var d=0,p=o/4;d<p;d++){var m=c+4*d;h[l++]=m,h[l++]=m+1,h[l++]=m+2,h[l++]=m+1,h[l++]=m+3,h[l++]=m+2}}(Uw=Nw||(Nw={}))[Uw.SIMPLE=0]="SIMPLE",Uw[Uw.SLICED=1]="SLICED",Uw[Uw.FILLED=3]="FILLED",Rt(Nw),(Vw=Gw||(Gw={}))[Vw.HORIZONTAL=0]="HORIZONTAL",Vw[Vw.VERTICAL=1]="VERTICAL",Vw[Vw.RADIAL=2]="RADIAL",Rt(Gw),(jw=Hw||(Hw={}))[jw.CUSTOM=0]="CUSTOM",jw[jw.TRIMMED=1]="TRIMMED",jw[jw.RAW=2]="RAW",Rt(Hw);var vA,yA,gA,bA,SA,TA,xA,EA,wA,AA,CA,kA,RA,OA,MA,LA,IA,FA,PA,DA,zA,BA,NA,UA,GA,VA,HA,jA,WA,XA,qA,YA,KA,QA,ZA=(vw=Ca("cc.SpriteComponent"),yw=Fa(110),gw=Ia("UI/Render/Sprite"),bw=ka({type:Eh,displayOrder:4}),Sw=ka({type:bh,displayOrder:5}),Tw=ka({type:Nw,displayOrder:6}),xw=ka({type:Gw}),Ew=ka({displayOrder:8}),ww=ka({type:Hw,displayOrder:7}),vw(Aw=yw(Aw=gw((Bw=zw=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_spriteFrame",kw,_(t)),m(t,"_type",Rw,_(t)),m(t,"_fillType",Ow,_(t)),m(t,"_sizeMode",Mw,_(t)),m(t,"_fillCenter",Lw,_(t)),m(t,"_fillStart",Iw,_(t)),m(t,"_fillRange",Fw,_(t)),m(t,"_isTrimmedMode",Pw,_(t)),m(t,"_atlas",Dw,_(t)),t}return d(a,_x),l(a,[{key:"__preload",value:function(){p(S(a.prototype),"__preload",this)&&p(S(a.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){p(S(a.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){p(S(a.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler)}},{key:"_canRender",value:function(){if(!p(S(a.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=a.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(Hw.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(Hw.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_applyAtlas",value:function(e){}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e,this.spriteFrame=null)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===Gw.RADIAL||this._fillType===Gw.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===Nw.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=wi(e,-1,1),this._type===Nw.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=wi(e,0,1),this._type===Nw.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===Nw.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e)!==Hw.CUSTOM&&this._applySpriteSize()}}]),a}(),zw.FillType=Gw,zw.Type=Nw,zw.SizeMode=Hw,c((Cw=Bw).prototype,"spriteAtlas",[bw],Object.getOwnPropertyDescriptor(Cw.prototype,"spriteAtlas"),Cw.prototype),c(Cw.prototype,"spriteFrame",[Sw],Object.getOwnPropertyDescriptor(Cw.prototype,"spriteFrame"),Cw.prototype),c(Cw.prototype,"type",[Tw],Object.getOwnPropertyDescriptor(Cw.prototype,"type"),Cw.prototype),c(Cw.prototype,"fillType",[xw],Object.getOwnPropertyDescriptor(Cw.prototype,"fillType"),Cw.prototype),c(Cw.prototype,"fillCenter",[ka],Object.getOwnPropertyDescriptor(Cw.prototype,"fillCenter"),Cw.prototype),c(Cw.prototype,"fillStart",[ka],Object.getOwnPropertyDescriptor(Cw.prototype,"fillStart"),Cw.prototype),c(Cw.prototype,"fillRange",[ka],Object.getOwnPropertyDescriptor(Cw.prototype,"fillRange"),Cw.prototype),c(Cw.prototype,"trim",[Ew],Object.getOwnPropertyDescriptor(Cw.prototype,"trim"),Cw.prototype),c(Cw.prototype,"sizeMode",[ww],Object.getOwnPropertyDescriptor(Cw.prototype,"sizeMode"),Cw.prototype),kw=c(Cw.prototype,"_spriteFrame",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rw=c(Cw.prototype,"_type",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nw.SIMPLE}}),Ow=c(Cw.prototype,"_fillType",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gw.HORIZONTAL}}),Mw=c(Cw.prototype,"_sizeMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hw.TRIMMED}}),Lw=c(Cw.prototype,"_fillCenter",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ui(0,0)}}),Iw=c(Cw.prototype,"_fillStart",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fw=c(Cw.prototype,"_fillRange",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pw=c(Cw.prototype,"_isTrimmedMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dw=c(Cw.prototype,"_atlas",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Aw=Cw))||Aw)||Aw)||Aw);cc.SpriteComponent=ZA,(YA=qA||(qA={}))[YA.NONE=0]="NONE",YA[YA.COLOR=1]="COLOR",YA[YA.SPRITE=2]="SPRITE",YA[YA.SCALE=3]="SCALE",Rt(qA),(QA=KA||(KA={})).NORMAL="normal",QA.HOVER="hover",QA.PRESSED="pressed",QA.DISABLED="disabled";var JA=(vA=Ca("cc.ButtonComponent"),yA=Fa(110),gA=Ia("UI/Button"),bA=ka({displayOrder:1}),SA=ka({type:qA,displayOrder:2}),TA=ka({min:0,max:10}),xA=ka({type:bh}),EA=ka({type:bh}),wA=ka({type:bh}),AA=ka({type:bh}),CA=ka({type:xf,displayOrder:0}),kA=ka({type:OS,displayOrder:3}),vA(RA=yA(RA=gA((XA=WA=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"clickEvents",MA,_(t)),m(t,"_interactable",LA,_(t)),m(t,"_transition",IA,_(t)),m(t,"_normalColor",FA,_(t)),m(t,"_hoverColor",PA,_(t)),m(t,"_pressColor",DA,_(t)),m(t,"_disabledColor",zA,_(t)),m(t,"_normalSprite",BA,_(t)),m(t,"_hoverSprite",NA,_(t)),m(t,"_pressedSprite",UA,_(t)),m(t,"_disabledSprite",GA,_(t)),m(t,"_duration",VA,_(t)),m(t,"_zoomScale",HA,_(t)),m(t,"_target",jA,_(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new or,t._toColor=new or,t._time=0,t._transitionFinished=!0,t._fromScale=new Xi,t._toScale=new Xi,t._originalScale=new Xi,t._sprite=null,t._targetScale=new Xi,t}return d(a,R_),l(a,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(ZA);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(Zt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(Zt.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(Zt.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Zt.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Zt.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===qA.COLOR||this._transition===qA.SCALE)){this._time+=e;var i=1;0<this._duration&&(i=this._time/this._duration),1<=i&&(i=1,this._transitionFinished=!0);var n=t.getComponent(_x);n&&(this._transition===qA.COLOR?or.lerp(n.color,this._fromColor,this._toColor,i):this.transition===qA.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=Ci(this._fromScale.x,this._toScale.x,i),this._targetScale.y=Ci(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(_x);if(t){var i=this._transition;i===qA.COLOR&&this._interactable?t.color=this._normalColor:i===qA.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(Zt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(Zt.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(Zt.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Zt.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Zt.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(ZA)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Xi.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node.uiTransfromComp.isHit(t.getUILocation());if(this._transition===qA.SCALE&&this._target)n?(Xi.copy(this._fromScale,this._originalScale),Xi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?KA.PRESSED:KA.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(OS.emitEvents(this.clickEvents,e),this.node.emit("click",this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==qA.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=KA.NORMAL;return this._interactable?this._pressed?e=KA.PRESSED:this._hovered&&(e=KA.HOVER):e=KA.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(_x);n&&(e===KA.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===KA.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Xi.copy(this._fromScale,this._originalScale),Xi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Xi.copy(this._fromScale,this._target.getScale()),Xi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===qA.COLOR?this._updateColorTransition(e):t===qA.SPRITE?this._updateSpriteTransition(e):t===qA.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(ZA);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),a}(),WA.Transition=qA,c((OA=XA).prototype,"interactable",[bA],Object.getOwnPropertyDescriptor(OA.prototype,"interactable"),OA.prototype),c(OA.prototype,"transition",[SA],Object.getOwnPropertyDescriptor(OA.prototype,"transition"),OA.prototype),c(OA.prototype,"normalColor",[ka],Object.getOwnPropertyDescriptor(OA.prototype,"normalColor"),OA.prototype),c(OA.prototype,"pressedColor",[ka],Object.getOwnPropertyDescriptor(OA.prototype,"pressedColor"),OA.prototype),c(OA.prototype,"hoverColor",[ka],Object.getOwnPropertyDescriptor(OA.prototype,"hoverColor"),OA.prototype),c(OA.prototype,"disabledColor",[ka],Object.getOwnPropertyDescriptor(OA.prototype,"disabledColor"),OA.prototype),c(OA.prototype,"duration",[TA],Object.getOwnPropertyDescriptor(OA.prototype,"duration"),OA.prototype),c(OA.prototype,"zoomScale",[ka],Object.getOwnPropertyDescriptor(OA.prototype,"zoomScale"),OA.prototype),c(OA.prototype,"normalSprite",[xA],Object.getOwnPropertyDescriptor(OA.prototype,"normalSprite"),OA.prototype),c(OA.prototype,"pressedSprite",[EA],Object.getOwnPropertyDescriptor(OA.prototype,"pressedSprite"),OA.prototype),c(OA.prototype,"hoverSprite",[wA],Object.getOwnPropertyDescriptor(OA.prototype,"hoverSprite"),OA.prototype),c(OA.prototype,"disabledSprite",[AA],Object.getOwnPropertyDescriptor(OA.prototype,"disabledSprite"),OA.prototype),c(OA.prototype,"target",[CA],Object.getOwnPropertyDescriptor(OA.prototype,"target"),OA.prototype),MA=c(OA.prototype,"clickEvents",[kA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LA=c(OA.prototype,"_interactable",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),IA=c(OA.prototype,"_transition",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qA.NONE}}),FA=c(OA.prototype,"_normalColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(214,214,214,255)}}),PA=c(OA.prototype,"_hoverColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(211,211,211,255)}}),DA=c(OA.prototype,"_pressColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.WHITE.clone()}}),zA=c(OA.prototype,"_disabledColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(124,124,124,255)}}),BA=c(OA.prototype,"_normalSprite",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NA=c(OA.prototype,"_hoverSprite",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UA=c(OA.prototype,"_pressedSprite",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GA=c(OA.prototype,"_disabledSprite",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VA=c(OA.prototype,"_duration",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),HA=c(OA.prototype,"_zoomScale",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),jA=c(OA.prototype,"_target",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RA=OA))||RA)||RA)||RA);cc.ButtonComponent=JA;var $A,eC,tC,iC,nC,rC,aC,sC,oC,lC,cC,uC,hC,_C,fC,dC,pC,mC,vC,yC,gC,bC,SC,TC,xC,EC,wC,AC,CC,kC,RC,OC,MC,LC,IC,FC,PC,DC,zC,BC,NC,UC,GC,VC=function(){function e(){y(this,e),this.pool=[]}return l(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){32<=this.pool.length||this.pool.push(e)}}]),e}();(zC=Zt.HorizontalTextAlignment||(Zt.HorizontalTextAlignment={}))[zC.LEFT=0]="LEFT",zC[zC.CENTER=1]="CENTER",zC[zC.RIGHT=2]="RIGHT",Rt(Zt.HorizontalTextAlignment),(BC=Zt.VerticalTextAlignment||(Zt.VerticalTextAlignment={}))[BC.TOP=0]="TOP",BC[BC.CENTER=1]="CENTER",BC[BC.BOTTOM=2]="BOTTOM",Rt(Zt.VerticalTextAlignment),(NC=Zt.Overflow||(Zt.Overflow={}))[NC.NONE=0]="NONE",NC[NC.CLAMP=1]="CLAMP",NC[NC.SHRINK=2]="SHRINK",NC[NC.RESIZE_HEIGHT=3]="RESIZE_HEIGHT",Rt(Zt.Overflow),(GC=UC||(UC={}))[GC.NONE=0]="NONE",GC[GC.BITMAP=1]="BITMAP",GC[GC.CHAR=2]="CHAR",Rt(UC);var HC,jC,WC,XC,qC,YC,KC,QC=($A=Ca("cc.LabelComponent"),eC=Fa(110),tC=Ia("UI/Render/Label"),iC=ka({displayOrder:4,multiline:!0}),nC=ka({type:Zt.HorizontalTextAlignment,displayOrder:5}),rC=ka({type:Zt.VerticalTextAlignment,displayOrder:6}),aC=ka({readonly:!0,displayName:"Actual Font Size",visible:!1}),sC=ka({displayOrder:7}),oC=ka({displayOrder:8}),lC=ka({displayOrder:8}),cC=ka({type:Zt.Overflow,displayOrder:9}),uC=ka({displayOrder:10}),hC=ka({type:t_,displayOrder:11}),_C=ka({displayOrder:12}),fC=ka({type:UC,displayOrder:13}),dC=ka({displayOrder:15}),pC=ka({displayOrder:16}),mC=ka({displayOrder:17}),$A(vC=eC(vC=tC((DC=PC=function(e){function i(){var e;return y(this,i),m(e=T(this,S(i).call(this)),"_useOriginalSize",gC,_(e)),m(e,"_string",bC,_(e)),m(e,"_horizontalAlign",SC,_(e)),m(e,"_verticalAlign",TC,_(e)),m(e,"_actualFontSize",xC,_(e)),m(e,"_fontSize",EC,_(e)),m(e,"_fontFamily",wC,_(e)),m(e,"_lineHeight",AC,_(e)),m(e,"_overflow",CC,_(e)),m(e,"_enableWrapText",kC,_(e)),m(e,"_font",RC,_(e)),m(e,"_isSystemFontUsed",OC,_(e)),e._spacingX=0,m(e,"_isItalic",MC,_(e)),m(e,"_isBold",LC,_(e)),m(e,"_isUnderline",IC,_(e)),m(e,"_cacheMode",FC,_(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return d(i,_x),l(i,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,"string"==typeof(this._font=e)&&cc.warnID(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===UC.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof __?this._font.fontSize:-1}}]),l(i,[{key:"onEnable",value:function(){p(S(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){p(S(i.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame&&(this._ttfSpriteFrame.destroy(),this._ttfSpriteFrame=null),p(S(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.markForUpdateRenderData(),e&&(this._flushAssembler(),this._applyFontTexture(e))}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler)}},{key:"_updateColor",value:function(){this._font instanceof __?p(S(i.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!p(S(i.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof __){var t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){var e=this._material;e&&e.setProperty("mainTexture",this._texture),this._updateMaterial(e)}},{key:"_applyFontTexture",value:function(e){var t=this,i=this._font;if(i instanceof __){var n=i.spriteFrame,r=this;n&&n.loaded&&(r._texture=n,r._flushMaterial(),e&&t._renderFlag&&t._assembler&&t._renderData&&t._assembler.updateRenderData(t))}else{if(this.cacheMode===UC.CHAR&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new bh,this._assemblerData=this._assembler.getAssemblerData();var a=new Ol(this._assemblerData.canvas);this._ttfSpriteFrame.texture.image=a}this.cacheMode!==UC.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial()}e&&this._renderFlag&&this._assembler&&this._renderData&&this._assembler.updateRenderData(this)}}]),i}(),PC.HorizontalAlign=Zt.HorizontalTextAlignment,PC.VerticalAlign=Zt.VerticalTextAlignment,PC.Overflow=Zt.Overflow,PC.CacheMode=UC,PC.CanvasPool=new VC,c((yC=DC).prototype,"string",[iC],Object.getOwnPropertyDescriptor(yC.prototype,"string"),yC.prototype),c(yC.prototype,"horizontalAlign",[nC],Object.getOwnPropertyDescriptor(yC.prototype,"horizontalAlign"),yC.prototype),c(yC.prototype,"verticalAlign",[rC],Object.getOwnPropertyDescriptor(yC.prototype,"verticalAlign"),yC.prototype),c(yC.prototype,"actualFontSize",[aC],Object.getOwnPropertyDescriptor(yC.prototype,"actualFontSize"),yC.prototype),c(yC.prototype,"fontSize",[sC],Object.getOwnPropertyDescriptor(yC.prototype,"fontSize"),yC.prototype),c(yC.prototype,"fontFamily",[oC],Object.getOwnPropertyDescriptor(yC.prototype,"fontFamily"),yC.prototype),c(yC.prototype,"lineHeight",[lC],Object.getOwnPropertyDescriptor(yC.prototype,"lineHeight"),yC.prototype),c(yC.prototype,"overflow",[cC],Object.getOwnPropertyDescriptor(yC.prototype,"overflow"),yC.prototype),c(yC.prototype,"enableWrapText",[uC],Object.getOwnPropertyDescriptor(yC.prototype,"enableWrapText"),yC.prototype),c(yC.prototype,"font",[hC],Object.getOwnPropertyDescriptor(yC.prototype,"font"),yC.prototype),c(yC.prototype,"useSystemFont",[_C],Object.getOwnPropertyDescriptor(yC.prototype,"useSystemFont"),yC.prototype),c(yC.prototype,"cacheMode",[fC],Object.getOwnPropertyDescriptor(yC.prototype,"cacheMode"),yC.prototype),c(yC.prototype,"isBold",[dC],Object.getOwnPropertyDescriptor(yC.prototype,"isBold"),yC.prototype),c(yC.prototype,"isItalic",[pC],Object.getOwnPropertyDescriptor(yC.prototype,"isItalic"),yC.prototype),c(yC.prototype,"isUnderline",[mC],Object.getOwnPropertyDescriptor(yC.prototype,"isUnderline"),yC.prototype),gC=c(yC.prototype,"_useOriginalSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bC=c(yC.prototype,"_string",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),SC=c(yC.prototype,"_horizontalAlign",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zt.HorizontalTextAlignment.CENTER}}),TC=c(yC.prototype,"_verticalAlign",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zt.VerticalTextAlignment.CENTER}}),xC=c(yC.prototype,"_actualFontSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EC=c(yC.prototype,"_fontSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),wC=c(yC.prototype,"_fontFamily",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),AC=c(yC.prototype,"_lineHeight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),CC=c(yC.prototype,"_overflow",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zt.Overflow.NONE}}),kC=c(yC.prototype,"_enableWrapText",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RC=c(yC.prototype,"_font",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OC=c(yC.prototype,"_isSystemFontUsed",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),MC=c(yC.prototype,"_isItalic",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LC=c(yC.prototype,"_isBold",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IC=c(yC.prototype,"_isUnderline",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FC=c(yC.prototype,"_cacheMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UC.NONE}}),vC=yC))||vC)||vC)||vC);cc.LabelComponent=QC,(jC=HC||(HC={}))[jC.DEFAULT=0]="DEFAULT",jC[jC.DONE=1]="DONE",jC[jC.SEND=2]="SEND",jC[jC.SEARCH=3]="SEARCH",jC[jC.GO=4]="GO",jC[jC.NEXT=5]="NEXT",kt(HC),(XC=WC||(WC={}))[XC.ANY=0]="ANY",XC[XC.EMAIL_ADDR=1]="EMAIL_ADDR",XC[XC.NUMERIC=2]="NUMERIC",XC[XC.PHONE_NUMBER=3]="PHONE_NUMBER",XC[XC.URL=4]="URL",XC[XC.DECIMAL=5]="DECIMAL",XC[XC.SINGLE_LINE=6]="SINGLE_LINE",kt(WC),(YC=qC||(qC={}))[YC.PASSWORD=0]="PASSWORD",YC[YC.SENSITIVE=1]="SENSITIVE",YC[YC.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",YC[YC.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",YC[YC.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",YC[YC.DEFAULT=5]="DEFAULT",kt(qC);var ZC=new Nn,JC=new Nn,$C=new Xi,ek=null,tk={zoomInvalid:!1};cc.sys.OS_ANDROID!==cc.sys.os||cc.sys.browserType!==cc.sys.BROWSER_TYPE_SOUGOU&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_360||(tk.zoomInvalid=!0);var ik,nk,rk,ak,sk,ok,lk,ck,uk,hk,_k,fk,dk,pk,mk,vk,yk,gk,bk,Sk,Tk,xk,Ek,wk,Ak,Ck,kk,Rk,Ok,Mk,Lk,Ik,Fk,Pk,Dk,zk=Ca(KC=function(){function e(){y(this,e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=HC.DEFAULT,this._maxLength=50,this._text="",this._placeholderText="",this._alwaysOnTop=!1,this._size=cc.size(),this._node=null,this._editing=!1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__rotateScreen=!1,this.__orientationChanged=void 0,this._edTxt=null,this._textColor=or.WHITE.clone(),this._edFontSize=14,this._isTextArea=!1}return l(e,[{key:"onEnable",value:function(){this._edTxt&&(this._alwaysOnTop?this._edTxt.style.display="":this._edTxt.style.display="none")}},{key:"onDisable",value:function(){this._edTxt&&(this._edTxt.style.display="none")}},{key:"setTabIndex",value:function(e){this._edTxt&&(this._edTxt.tabIndex=e)}},{key:"setFocus",value:function(){this._beginEditing()}},{key:"isFocused",value:function(){return this._edTxt?document.activeElement===this._edTxt:(cc.warnID(4700),!1)}},{key:"stayOnTop",value:function(e){this._alwaysOnTop!==e&&this._edTxt&&(this._alwaysOnTop=e,this._edTxt.style.display=e?"":"none")}},{key:"setMaxLength",value:function(e){isNaN(e)||(e<0&&(e=65535),this._maxLength=e,this._edTxt&&(this._edTxt.maxLength=e))}},{key:"setString",value:function(e){this._text=e,this._edTxt&&(this._edTxt.value=e)}},{key:"getString",value:function(){return this._text}},{key:"setPlaceholderText",value:function(e){this._placeholderText=e}},{key:"getPlaceholderText",value:function(){return this._placeholderText}},{key:"setDelegate",value:function(e){this._delegate=e}},{key:"setInputMode",value:function(e){this._inputMode!==e&&(this._inputMode=e,this.createInput(),this._updateDomInputType(),this._updateSize(this._size.width,this._size.height))}},{key:"setInputFlag",value:function(e){if(this._inputFlag!==e){this._inputFlag=e,this._updateDomInputType();var t="none";e===qC.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":e===qC.INITIAL_CAPS_WORD&&(t="capitalize"),this._edTxt&&(this._edTxt.style.textTransform=t,this._edTxt.value=this._text)}}},{key:"setReturnType",value:function(e){this._returnType=e,this._updateDomInputType()}},{key:"setFontSize",value:function(e){this._edFontSize=e||this._edFontSize,this._edTxt&&(this._edTxt.style.fontSize=this._edFontSize+"px")}},{key:"setFontColor",value:function(e){this._textColor=e,this._edTxt&&(this._edTxt.style.color=e.toCSS("rgba"))}},{key:"setSize",value:function(e,t){this._size.width=e,this._size.height=t,this._updateSize(e,t)}},{key:"setNode",value:function(e){this._node=e}},{key:"update",value:function(){this._updateMatrix()}},{key:"clear",value:function(){this._node=null,this.setDelegate(null),this.removeDom()}},{key:"_onTouchBegan",value:function(e){}},{key:"_onTouchEnded",value:function(){this._beginEditing()}},{key:"_beginEditing",value:function(){cc.sys.isMobile&&!this._editing&&this._beginEditingOnMobile();var e=this;function t(){e._edTxt&&e._edTxt.focus()}this._edTxt&&(this._edTxt.style.display="",cc.sys.browserType===cc.sys.BROWSER_TYPE_UC?setTimeout(t,400):cc.sys.browserType===cc.sys.BROWSER_TYPE_FIREFOX?setTimeout(t,0):t()),this._editing=!0}},{key:"_endEditing",value:function(){var e=this,t=function(){!e._alwaysOnTop&&e._edTxt&&(e._edTxt.style.display="none"),e._delegate&&e._delegate.editBoxEditingDidEnded&&e._delegate.editBoxEditingDidEnded()};this._editing&&(cc.sys.isMobile?setTimeout(function(){e._endEditingOnMobile(),t()},400):t()),this._editing=!1}},{key:"_updateDomInputType",value:function(){var e=this._inputMode,t=this._edTxt;if(t){if(this._isTextArea){t=t;var i="none";return this._inputFlag===qC.INITIAL_CAPS_ALL_CHARACTERS?i="uppercase":this._inputFlag===qC.INITIAL_CAPS_WORD&&(i="capitalize"),void(t.style.textTransform=i)}if(t=t,this._inputFlag!==qC.PASSWORD){var n=t.type;e===WC.EMAIL_ADDR?n="email":e===WC.NUMERIC||e===WC.DECIMAL?n="number":e===WC.PHONE_NUMBER?(n="number",t.pattern="[0-9]*"):e===WC.URL?n="url":(n="text",this._returnType===HC.SEARCH&&(n="search")),t.type=n}else t.type="password"}}},{key:"_updateSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._node,t=cc.view._scaleX,i=cc.view._scaleY,n=cc.view._viewportRect,r=cc.view._devicePixelRatio;e.getWorldMatrix(ZC);var a=e.uiTransfromComp;a&&Xi.set($C,-a.anchorX*a.width,-a.anchorY*a.height,$C.z),Nn.transform(ZC,ZC,$C);var s=e.getComponent(_x);if(!s)return!1;var o=cc.director.root.ui.getScreen(s.visibility);if(o){o.node.getWorldRT(JC);var l=JC.m12,c=JC.m13,u=cc.visibleRect.center;JC.m12=u.x-(JC.m00*l+JC.m04*c),JC.m13=u.y-(JC.m01*l+JC.m05*c),Nn.multiply(JC,JC,ZC),t/=r,i/=r;var h=cc.game.container,_=JC.m00*t,f=ZC.m01,d=ZC.m04,p=JC.m05*i,m=h&&h.style.paddingLeft&&parseInt(h.style.paddingLeft);m+=n.x/r;var v=h&&h.style.paddingBottom&&parseInt(h.style.paddingBottom);v+=n.y/r;var y=JC.m12*t+m,g=JC.m13*i+v;tk.zoomInvalid&&(this._updateSize(this._size.width*_,this._size.height*p),p=_=1);var b="matrix("+_+","+-f+","+-d+","+p+","+y+","+-g+")";this._edTxt.style.transform=b,this._edTxt.style["-webkit-transform"]=b,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_adjustEditBoxPosition",value:function(){this._node.getWorldMatrix(ZC);var t=ZC.m13,i=cc.visibleRect.height,e=cc.visibleRect.width,n=.5;i<e&&(n=.7),setTimeout(function(){if(window.scrollY<40&&t<i*n){var e=i*n-t-window.scrollY;e<35&&(e=35),320<e&&(e=320),window.scrollTo(0,e)}},400)}},{key:"createInput",value:function(){this._isTextArea=!1,this._inputMode===WC.ANY?(this._isTextArea=!0,this._createDomTextArea()):this._createDomInput()}},{key:"_beginEditingOnMobile",value:function(){var e=this;this.__orientationChanged=function(){e._adjustEditBoxPosition()},window.addEventListener("orientationchange",this.__orientationChanged),cc.view.isAutoFullScreenEnabled()?(this.__fullscreen=!0,cc.view.enableAutoFullScreen(!1),cc.screen.exitFullScreen()):this.__fullscreen=!1,this.__autoResize=cc.view._resizeWithBrowserSize,cc.view.resizeWithBrowserSize(!1),ek=this}},{key:"_endEditingOnMobile",value:function(){if(this.__rotateScreen){cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)";var e=cc.view,t=e._originalDesignResolutionSize.width,i=e._originalDesignResolutionSize.height;0<t&&e.setDesignResolutionSize(t,i,e._resolutionPolicy),this.__rotateScreen=!1}this.__orientationChanged&&window.removeEventListener("orientationchange",this.__orientationChanged),this.__fullscreen&&cc.view.enableAutoFullScreen(!0),this.__autoResize&&ek===this&&cc.view.resizeWithBrowserSize(!0)}},{key:"_createDomInput",value:function(){this.removeDom();var e=this._edTxt=document.createElement("input");return e.type="text",e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.style["-moz-appearance"]="textfield",e.className="cocosEditBox",e.style.fontFamily="Arial",Nk(e,this),e}},{key:"_createDomTextArea",value:function(){this.removeDom();var e=this._edTxt=document.createElement("textarea");return e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.resize="none",e.style.textTransform="uppercase",e.style.overflowY="scroll",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",Nk(e,this,!0),e}},{key:"_addDomToGameContainer",value:function(){cc.game.container.appendChild(this._edTxt)}},{key:"removeDom",value:function(){var e=this._edTxt;if(e){var t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionstart),e.removeEventListener("compositionend",t.compositionend),e.removeEventListener("input",t.input),e.removeEventListener("focus",t.focus),e.removeEventListener("keypress",t.keypress),e.removeEventListener("blur",t.blur),t.compositionstart=null,t.compositionend=null,t.input=null,t.focus=null,t.keypress=null,t.blur=null,St(cc.game.container,e)&&cc.game.container.removeChild(e)}this._edTxt=null}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"textColor",get:function(){return this._textColor}},{key:"fontSize",get:function(){return this._edFontSize}},{key:"returnType",set:function(e){this._returnType=e}},{key:"alwayOnTop",get:function(){return this._alwaysOnTop}},{key:"editing",get:function(){return this._editing},set:function(e){this._editing=e}},{key:"delegate",get:function(){return this._delegate}},{key:"eventListeners",get:function(){return this.__eventListeners}}]),e}())||KC;function Bk(e,t){e.value.length>t._maxLength&&(e.value=e.value.slice(0,t._maxLength)),t._delegate&&t._delegate.editBoxTextChanged&&t._text!==e.value&&(t._text=e.value,t._delegate.editBoxTextChanged(t._text))}function Nk(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=!1,r=t.eventListeners;r.compositionstart=function(){n=!0},e.addEventListener("compositionstart",r.compositionstart),r.compositionend=function(){n=!1,Bk(this,t)},e.addEventListener("compositionend",r.compositionend),r.input=function(){n||Bk(this,t)},e.addEventListener("input",r.input),r.focus=function(){this.style.fontSize=t.fontSize+"px",this.style.color=t.textColor.toCSS("rgba"),t.alwayOnTop&&(t.editing=!0),cc.sys.isMobile&&t._beginEditingOnMobile(),t.delegate&&t.delegate.editBoxEditingDidBegan&&t.delegate.editBoxEditingDidBegan()},e.addEventListener("focus",r.focus),r.keypress=function(e){e.keyCode===Rr.KEY.enter&&(e.propagationStopped=!0,t.delegate&&t.delegate.editBoxEditingReturn&&t.delegate.editBoxEditingReturn(),i||(t.text=this.value,t._endEditing(),cc.game.canvas.focus()))},e.addEventListener("keypress",r.keypress),r.blur=function(){t.text=this.value,t._endEditing()},e.addEventListener("blur",r.blur),t._addDomToGameContainer()}var Uk,Gk,Vk,Hk,jk,Wk,Xk,qk,Yk,Kk,Qk,Zk,Jk,$k,eR,tR,iR,nR,rR,aR,sR,oR,lR,cR,uR,hR,_R=(ik=Ca("cc.EditBoxComponent"),nk=Fa(100),rk=Ia("UI/EditBox"),ak=ka({type:bh}),sk=ka({type:HC}),ok=ka({type:qC}),lk=ka({type:WC}),ck=ka({type:or}),uk=ka({type:OS}),hk=ka({type:OS}),_k=ka({type:OS}),fk=ka({type:OS}),ik(dk=nk(dk=rk(dk=Ma((Dk=Pk=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"editingDidBegan",mk,_(t)),m(t,"textChanged",vk,_(t)),m(t,"editingDidEnded",yk,_(t)),m(t,"editingReturn",gk,_(t)),t._impl=null,t._textLabel=null,t._placeholderLabel=null,t._background=null,m(t,"_returnType",bk,_(t)),m(t,"_useOriginalSize",Sk,_(t)),m(t,"_string",Tk,_(t)),m(t,"_tabIndex",xk,_(t)),m(t,"_backgroundImage",Ek,_(t)),m(t,"_inputFlag",wk,_(t)),m(t,"_inputMode",Ak,_(t)),m(t,"_fontSize",Ck,_(t)),m(t,"_lineHeight",kk,_(t)),m(t,"_maxLength",Rk,_(t)),m(t,"_fontColor",Ok,_(t)),m(t,"_placeholder",Mk,_(t)),m(t,"_placeholderFontSize",Lk,_(t)),m(t,"_placeholderFontColor",Ik,_(t)),m(t,"_stayOnTop",Fk,_(t)),t}return d(a,R_),l(a,[{key:"onEnable",value:function(){this._impl&&this._impl.onEnable()}},{key:"onDisable",value:function(){this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"_init",value:function(){this._createBackgroundSprite(),this._createLabels(),this.node.on(Zt.SystemEventType.SIZE_CHANGED,this._resizeChildNodes,this);var e=this._impl=new zk;e.setDelegate(this),e.setNode(this.node),e.setInputMode(this._inputMode),e.setMaxLength(this._maxLength),e.setInputFlag(this._inputFlag),e.setReturnType(this._returnType),e.setTabIndex(this._tabIndex),e.setFontColor(this._fontColor),e.setFontSize(this._fontSize),e.setPlaceholderText(this._placeholder),this._updateStayOnTop(),this._updateString(this._string),this._syncSize()}},{key:"__preload",value:function(){this._registerEvent(),this._init()}},{key:"_registerEvent",value:function(){this.node.on(Zt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateStayOnTop",value:function(){this.stayOnTop?this._hideLabels():this._showLabels(),this._impl&&this._impl.stayOnTop(this.stayOnTop)}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node.setAnchorPoint(this.node.getAnchorPoint()),this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.setPosition(2+i,n+e.height,a.node.getPosition().z),a.verticalAlign=this._inputMode===WC.ANY?Zt.VerticalTextAlignment.TOP:Zt.VerticalTextAlignment.CENTER,a.enableWrapText=this._inputMode===WC.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(2+i,n+e.height,r.node.getPosition().z),r.verticalAlign=this._inputMode===WC.ANY?Zt.VerticalTextAlignment.TOP:Zt.VerticalTextAlignment.CENTER,r.enableWrapText=this._inputMode===WC.ANY)}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(cc.SpriteComponent),this._background||(this._background=this.node.addComponent(cc.SpriteComponent))),this._background.type=cc.SpriteComponent.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_createLabels",value:function(){if(!this._textLabel){var e=this.node.getChildByName("TEXT_LABEL");e||(e=new xf("TEXT_LABEL"));var t=e.getComponent(QC);e.parent=this.node,t||(t=e.addComponent(QC)),e.getComponent(cT).setAnchorPoint(0,1),t.color=this._fontColor,t.overflow=QC.Overflow.CLAMP,t.fontSize=this._fontSize,t.lineHeight=this.lineHeight,this._textLabel=t}if(!this._placeholderLabel){var i=this.node.getChildByName("PLACEHOLDER_LABEL");i||(i=new xf("PLACEHOLDER_LABEL"));var n=i.getComponent(QC);n||(n=i.addComponent(QC));var r=i.getComponent(cT);i.parent=this.node,n.color=this._placeholderFontColor,r.setAnchorPoint(0,1),n.overflow=QC.Overflow.CLAMP,n.fontSize=this._placeholderFontSize,n.string=this._placeholder,this._placeholderLabel=n}}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-this.node.width/2,this.node.height/2,e.getPosition().z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.setPosition(-this.node.width/2,this.node.height/2,t.getPosition().z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"_showLabels",value:function(){if(this._textLabel){var e=this._textLabel.string;this._textLabel.node.active=""!==e,this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_hideLabels",value:function(){this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._impl&&(this._impl.setString(e),this._impl.editing||this.stayOnTop||this._showLabels())}}},{key:"_updateLabelStringStyle",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this._inputFlag;if(t||i!==qC.PASSWORD)i===qC.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===qC.INITIAL_CAPS_WORD?e=function(e){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}(e):i===qC.INITIAL_CAPS_SENTENCE&&(e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e));else{for(var n="",r=e.length,a=0;a<r;++a)n+="●";e=n}return e}},{key:"editBoxEditingDidBegan",value:function(){this._hideLabels(),OS.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}},{key:"editBoxEditingDidEnded",value:function(){this.stayOnTop||this._showLabels(),OS.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this)}},{key:"editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,OS.emitEvents(this.textChanged,e,this),this.node.emit("text-changed",this)}},{key:"editBoxEditingReturn",value:function(){OS.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this)}},{key:"_onTouchBegan",value:function(e){this._impl&&this._impl._onTouchBegan(e.touch),e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl._onTouchEnded(),e.propagationStopped=!0}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus()}},{key:"isFocused",value:function(){var e=!1;return this._impl&&(e=this._impl.isFocused()),e}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._impl&&this._updateString(e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e,this._impl&&(this._impl.returnType=this._returnType)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._impl&&(this._impl.setInputFlag(this._inputFlag),this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode=e,this._impl&&this._impl.setInputMode(this._inputMode)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._textLabel&&(this._textLabel.fontSize=this._fontSize),this._impl&&this._impl.setFontSize(this._fontSize))}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._textLabel&&(this._textLabel.lineHeight=this._lineHeight))}},{key:"fontColor",get:function(){return this._fontColor},set:function(e){if(this._fontColor!==e){if(this._fontColor.set(e),this._textLabel){var t=this._textLabel.node.getComponent(_x);t&&(t.color=this._fontColor)}this._impl&&this._impl.setFontColor(this._fontColor)}}},{key:"placeholder",get:function(){return this._placeholder},set:function(e){this._placeholder!==e&&(this._placeholder=e,this._placeholderLabel&&(this._placeholderLabel.string=this._placeholder),this._impl&&this._impl.setPlaceholderText(this._placeholder))}},{key:"placeholderFontSize",get:function(){return this._placeholderFontSize},set:function(e){this._placeholderFontSize!==e&&(this._placeholderFontSize=e,this._placeholderLabel&&(this._placeholderLabel.fontSize=this._placeholderFontSize))}},{key:"placeholderFontColor",get:function(){return this._placeholderFontColor},set:function(e){if(this._placeholderFontColor!==e&&(this._placeholderFontColor=e,this._placeholderLabel)){var t=this._placeholderLabel.node.getComponent(_x);t&&(t.color=this._placeholderFontColor)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength!==e&&(this._maxLength=e,this._impl&&this._impl.setMaxLength(this._maxLength))}},{key:"stayOnTop",get:function(){return this._stayOnTop},set:function(e){this._stayOnTop=e,this._impl&&this._updateStayOnTop()}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex=e,this._impl&&this._impl.setTabIndex(e)}}]),a}(),Pk._EditBoxImpl=zk,Pk.KeyboardReturnType=HC,Pk.InputFlag=qC,Pk.InputMode=WC,c((pk=Dk).prototype,"string",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"string"),pk.prototype),c(pk.prototype,"backgroundImage",[ak],Object.getOwnPropertyDescriptor(pk.prototype,"backgroundImage"),pk.prototype),c(pk.prototype,"returnType",[sk],Object.getOwnPropertyDescriptor(pk.prototype,"returnType"),pk.prototype),c(pk.prototype,"inputFlag",[ok],Object.getOwnPropertyDescriptor(pk.prototype,"inputFlag"),pk.prototype),c(pk.prototype,"inputMode",[lk],Object.getOwnPropertyDescriptor(pk.prototype,"inputMode"),pk.prototype),c(pk.prototype,"fontSize",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"fontSize"),pk.prototype),c(pk.prototype,"lineHeight",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"lineHeight"),pk.prototype),c(pk.prototype,"fontColor",[ck],Object.getOwnPropertyDescriptor(pk.prototype,"fontColor"),pk.prototype),c(pk.prototype,"placeholder",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"placeholder"),pk.prototype),c(pk.prototype,"placeholderFontSize",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"placeholderFontSize"),pk.prototype),c(pk.prototype,"placeholderFontColor",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"placeholderFontColor"),pk.prototype),c(pk.prototype,"maxLength",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"maxLength"),pk.prototype),c(pk.prototype,"stayOnTop",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"stayOnTop"),pk.prototype),c(pk.prototype,"tabIndex",[ka],Object.getOwnPropertyDescriptor(pk.prototype,"tabIndex"),pk.prototype),mk=c(pk.prototype,"editingDidBegan",[uk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vk=c(pk.prototype,"textChanged",[hk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yk=c(pk.prototype,"editingDidEnded",[_k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gk=c(pk.prototype,"editingReturn",[fk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bk=c(pk.prototype,"_returnType",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HC.DEFAULT}}),Sk=c(pk.prototype,"_useOriginalSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Tk=c(pk.prototype,"_string",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xk=c(pk.prototype,"_tabIndex",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ek=c(pk.prototype,"_backgroundImage",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wk=c(pk.prototype,"_inputFlag",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qC.DEFAULT}}),Ak=c(pk.prototype,"_inputMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WC.ANY}}),Ck=c(pk.prototype,"_fontSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),kk=c(pk.prototype,"_lineHeight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Rk=c(pk.prototype,"_maxLength",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Ok=c(pk.prototype,"_fontColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.WHITE.clone()}}),Mk=c(pk.prototype,"_placeholder",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Enter text here..."}}),Lk=c(pk.prototype,"_placeholderFontSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Ik=c(pk.prototype,"_placeholderFontColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.GRAY.clone()}}),Fk=c(pk.prototype,"_stayOnTop",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dk=pk))||dk)||dk)||dk)||dk);cc.EditBoxComponent=_R;var fR,dR,pR,mR,vR,yR,gR,bR,SR,TR,xR=Zt.SystemEventType;(dR=fR||(fR={}))[dR.NONE=0]="NONE",dR[dR.HORIZONTAL=1]="HORIZONTAL",dR[dR.VERTICAL=2]="VERTICAL",dR[dR.GRID=3]="GRID",Rt(fR),(mR=pR||(pR={}))[mR.NONE=0]="NONE",mR[mR.CONTAINER=1]="CONTAINER",mR[mR.CHILDREN=2]="CHILDREN",Rt(pR),(yR=vR||(vR={}))[yR.HORIZONTAL=0]="HORIZONTAL",yR[yR.VERTICAL=1]="VERTICAL",Rt(vR),(bR=gR||(gR={}))[bR.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",bR[bR.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM",Rt(gR),(TR=SR||(SR={}))[TR.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",TR[TR.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT",Rt(SR);var ER,wR,AR,CR,kR,RR,OR,MR,LR,IR,FR,PR,DR,zR,BR,NR,UR,GR,VR,HR,jR,WR,XR=new Xi,qR=new Xi,YR=(Uk=Ca("cc.LayoutComponent"),Gk=Fa(110),Vk=Ia("UI/Layout"),Hk=ka({type:fR}),jk=ka({type:pR}),Wk=ka({type:vR}),Xk=ka({type:gR}),qk=ka({type:SR}),Uk(Yk=Gk(Yk=Vk(Yk=Ma((hR=uR=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._layoutDirty=!0,m(t,"_resizeMode",Qk,_(t)),m(t,"_N$layoutType",Zk,_(t)),m(t,"_N$padding",Jk,_(t)),m(t,"_cellSize",$k,_(t)),m(t,"_startAxis",eR,_(t)),m(t,"_paddingLeft",tR,_(t)),m(t,"_paddingRight",iR,_(t)),m(t,"_paddingTop",nR,_(t)),m(t,"_paddingBottom",rR,_(t)),m(t,"_spacingX",aR,_(t)),m(t,"_spacingY",sR,_(t)),t._layoutSize=new Kn(300,200),m(t,"_verticalDirection",oR,_(t)),m(t,"_horizontalDirection",lR,_(t)),m(t,"_affectedByScale",cR,_(t)),t}return d(a,R_),l(a,[{key:"updateLayout",value:function(){this._layoutDirty&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new Kn)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){cc.director.on(cc.Director.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(xR.SIZE_CHANGED,this._resized,this),this.node.on(xR.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(xR.CHILD_ADDED,this._childAdded,this),this.node.on(xR.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(xR.SIZE_CHANGED,this._resized,this),this.node.off(xR.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(xR.CHILD_ADDED,this._childAdded,this),this.node.off(xR.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.on(xR.SCALE_PART,this._doScaleDirty,this),r.on(xR.SIZE_CHANGED,this._doLayoutDirty,this),r.on(xR.TRANSFORM_CHANGED,this._transformDirty,this),r.on(xR.ANCHOR_CHANGED,this._doLayoutDirty,this),r.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.off(xR.SCALE_PART,this._doScaleDirty,this),r.off(xR.SIZE_CHANGED,this._doLayoutDirty,this),r.off(xR.TRANSFORM_CHANGED,this._transformDirty,this),r.off(xR.ANCHOR_CHANGED,this._doLayoutDirty,this),r.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(xR.SCALE_PART,this._doScaleDirty,this),e.on(xR.SIZE_CHANGED,this._doLayoutDirty,this),e.on(xR.TRANSFORM_CHANGED,this._transformDirty,this),e.on(xR.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(xR.SCALE_PART,this._doScaleDirty,this),e.off(xR.SIZE_CHANGED,this._doLayoutDirty,this),e.off(xR.TRANSFORM_CHANGED,this._transformDirty,this),e.off(xR.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingLeft,l=-r.x*e;this._horizontalDirection===SR.RIGHT_TO_LEFT&&(s=-1,l=(1-r.x)*e,o=this._paddingRight);var c=l+s*o-s*this._spacingX,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=a,y=Array.isArray(v),g=0;for(v=y?v:v[Symbol.iterator]();;){var b;if(y){if(g>=v.length)break;b=v[g++]}else{if((g=v.next()).done)break;b=g.value}b.activeInHierarchy&&m++}var S=this._cellSize.width;this._N$layoutType!==fR.GRID&&this._resizeMode===pR.CHILDREN&&(S=(e-(this._paddingLeft+this._paddingRight)-(m-1)*this._spacingX)/m);var T=a,x=Array.isArray(T),E=0;for(T=x?T:T[Symbol.iterator]();;){var w;if(x){if(E>=T.length)break;w=T[E++]}else{if((E=T.next()).done)break;w=E.value}var A=w;if(A.activeInHierarchy){A.getScale(qR);var C=this._getUsedScaleValue(qR.x),k=this._getUsedScaleValue(qR.y);this._resizeMode===pR.CHILDREN&&(A.width=S/C,this._N$layoutType===fR.GRID&&(A.height=this._cellSize.height/k));var R=A.anchorX,O=A.width*C,M=A.height*k;h<_&&(h=_),h<=M&&(_=h,h=M,p=A.getAnchorPoint().y),this._horizontalDirection===SR.RIGHT_TO_LEFT&&(R=1-A.anchorX),c=c+s*R*O+s*this._spacingX;var L=s*(1-R)*O;if(t){var I=c+L+s*(0<s?this._paddingRight:this._paddingLeft),F=!1;this._horizontalDirection===SR.LEFT_TO_RIGHT&&I>(1-r.x)*e&&(F=!0);var P=!1;this._horizontalDirection===SR.RIGHT_TO_LEFT&&I<-r.x*e&&(P=!0),(F||P)&&(h<=M?(0===_&&(_=h),u+=_,_=h):(u+=h,_=M,h=0),c=l+s*(o+R*O),f++)}var D=i(A,u,f);e>=O+this._paddingLeft+this._paddingRight&&n&&(A.getPosition(XR),A.setPosition(c,D,XR.z));var z=1,B=void 0,N=0===h?M:h;this._verticalDirection===gR.TOP_TO_BOTTOM?(d=d||this.node.getContentSize().height,(B=D+(z=-1)*(N*p+this._paddingBottom))<d&&(d=B)):(d=d||-this.node.getContentSize().height)<(B=D+z*(N*p+this._paddingTop))&&(d=B),c+=L}}return d}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingBottom,l=-r.y*e;this._verticalDirection===gR.TOP_TO_BOTTOM&&(s=-1,l=(1-r.y)*e,o=this._paddingTop);var c=l+s*o-s*this._spacingY,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=a,y=Array.isArray(v),g=0;for(v=y?v:v[Symbol.iterator]();;){var b;if(y){if(g>=v.length)break;b=v[g++]}else{if((g=v.next()).done)break;b=g.value}b.activeInHierarchy&&m++}var S=this._cellSize.height;this._N$layoutType!==fR.GRID&&this._resizeMode===pR.CHILDREN&&(S=(e-(this._paddingTop+this._paddingBottom)-(m-1)*this._spacingY)/m);var T=a,x=Array.isArray(T),E=0;for(T=x?T:T[Symbol.iterator]();;){var w;if(x){if(E>=T.length)break;w=T[E++]}else{if((E=T.next()).done)break;w=E.value}var A=w;if(A){var C=A.getScale(),k=this._getUsedScaleValue(C.x),R=this._getUsedScaleValue(C.y);if(A.activeInHierarchy){this._resizeMode===pR.CHILDREN&&(A.height=S/R,this._N$layoutType===fR.GRID&&(A.width=this._cellSize.width/k));var O=A.anchorY,M=A.width*k,L=A.height*R;h<_&&(h=_),h<=M&&(_=h,h=M,p=A.getAnchorPoint().x),this._verticalDirection===gR.TOP_TO_BOTTOM&&(O=1-A.anchorY),c=c+s*O*L+s*this._spacingY;var I=s*(1-O)*L;if(t){var F=c+I+s*(0<s?this._paddingTop:this._paddingBottom),P=!1;this._verticalDirection===gR.BOTTOM_TO_TOP&&F>(1-r.y)*e&&(P=!0);var D=!1;this._verticalDirection===gR.TOP_TO_BOTTOM&&F<-r.y*e&&(D=!0),(P||D)&&(h<=M?(0===_&&(_=h),u+=_,_=h):(u+=h,_=M,h=0),c=l+s*(o+O*L),f++)}var z=i(A,u,f);e>=L+(this._paddingTop+this._paddingBottom)&&n&&(A.getPosition(XR),A.setPosition(z,c,XR.z));var B=1,N=void 0,U=0===h?M:h;this._horizontalDirection===SR.RIGHT_TO_LEFT?(B=-1,d=d||this.node.getContentSize().width,(N=z+B*(U*p+this._paddingLeft))<d&&(d=N)):(d=d||-this.node.getContentSize().width)<(N=z+B*(U*p+this._paddingRight))&&(d=N),c+=I}}}return d}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.getComponent(cT);s&&(a.activeInHierarchy&&(e?er.union(e,e,s.getBoundingBoxToWorld()):e=s.getBoundingBoxToWorld()))}if(e){var o=this.node.parent.getComponent(cT);if(!o)return;Xi.set(XR,e.x,e.y,0);var l=new Xi;o.convertToNodeSpaceAR(XR,l),Xi.set(l,l.x-this._paddingLeft,l.y-this._paddingBottom,l.z),Xi.set(XR,e.x+e.width,e.y+e.height,0);var c=new Xi;o.convertToNodeSpaceAR(XR,c),Xi.set(c,c.x+this._paddingRight,c.y+this._paddingTop,c.z);var u=cc.size(parseFloat((c.x-l.x).toFixed(2)),parseFloat((c.y-l.y).toFixed(2)));if(this.node.getPosition(XR),0!==u.width){var h=(XR.x-l.x)/u.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==u.height){var _=(XR.y-l.y)/u.height;this.node.anchorY=parseFloat(_.toFixed(2))}this.node.setContentSize(u)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,s=this._paddingBottom;this._verticalDirection===gR.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,s=this._paddingTop);var o=this,l=function(e,t,i){return a+r*(t+e.anchorY*e.height*o._getUsedScaleValue(e.getScale().y)+s+i*n._spacingY)},c=0;if(this._resizeMode===pR.CONTAINER){var u=this._doLayoutHorizontally(i,!0,l,!1);(c=a-u)<0&&(c*=-1),a=-e.y*c,this._verticalDirection===gR.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*c)}this._doLayoutHorizontally(i,!0,l,!0),this._resizeMode===pR.CONTAINER&&this.node.setContentSize(i,c)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,s=this._paddingLeft;this._horizontalDirection===SR.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,s=this._paddingRight);var o=this,l=function(e,t,i){return a+r*(t+e.anchorX*e.width*o._getUsedScaleValue(e.getScale().x)+s+i*n._spacingX)},c=0;if(this._resizeMode===pR.CONTAINER){var u=this._doLayoutVertically(i,!0,l,!1);(c=a-u)<0&&(c*=-1),a=-e.x*c,this._horizontalDirection===SR.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*c)}this._doLayoutVertically(i,!0,l,!0),this._resizeMode===pR.CONTAINER&&this.node.setContentSize(c,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===vR.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===vR.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===pR.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(qR),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(qR.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===pR.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(qR),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(qR.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){if(this._N$layoutType===fR.HORIZONTAL){var e=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(e,!1,function(e){return e.getPosition(XR),XR.y},!0),this.node.width=e}else if(this._N$layoutType===fR.VERTICAL){var t=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(t,!1,function(e){return e.getPosition(XR),XR.x},!0),this.node.height=t}else this._N$layoutType===fR.NONE?this._resizeMode===pR.CONTAINER&&this._doLayoutBasic():this._N$layoutType===fR.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e===Zt.SystemEventType.POSITION_PART&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(){this._layoutDirty=this._layoutDirty||this._affectedByScale}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===fR.NONE&&e===pR.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),a}(),uR.Type=fR,uR.VerticalDirection=gR,uR.HorizontalDirection=SR,uR.ResizeMode=pR,uR.AxisDirection=vR,c((Kk=hR).prototype,"type",[Hk],Object.getOwnPropertyDescriptor(Kk.prototype,"type"),Kk.prototype),c(Kk.prototype,"resizeMode",[jk],Object.getOwnPropertyDescriptor(Kk.prototype,"resizeMode"),Kk.prototype),c(Kk.prototype,"cellSize",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"cellSize"),Kk.prototype),c(Kk.prototype,"startAxis",[Wk],Object.getOwnPropertyDescriptor(Kk.prototype,"startAxis"),Kk.prototype),c(Kk.prototype,"paddingLeft",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"paddingLeft"),Kk.prototype),c(Kk.prototype,"paddingRight",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"paddingRight"),Kk.prototype),c(Kk.prototype,"paddingTop",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"paddingTop"),Kk.prototype),c(Kk.prototype,"paddingBottom",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"paddingBottom"),Kk.prototype),c(Kk.prototype,"spacingX",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"spacingX"),Kk.prototype),c(Kk.prototype,"spacingY",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"spacingY"),Kk.prototype),c(Kk.prototype,"verticalDirection",[Xk],Object.getOwnPropertyDescriptor(Kk.prototype,"verticalDirection"),Kk.prototype),c(Kk.prototype,"horizontalDirection",[qk],Object.getOwnPropertyDescriptor(Kk.prototype,"horizontalDirection"),Kk.prototype),c(Kk.prototype,"padding",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"padding"),Kk.prototype),c(Kk.prototype,"affectedByScale",[ka],Object.getOwnPropertyDescriptor(Kk.prototype,"affectedByScale"),Kk.prototype),Qk=c(Kk.prototype,"_resizeMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pR.NONE}}),Zk=c(Kk.prototype,"_N$layoutType",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fR.NONE}}),Jk=c(Kk.prototype,"_N$padding",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$k=c(Kk.prototype,"_cellSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(40,40)}}),eR=c(Kk.prototype,"_startAxis",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vR.HORIZONTAL}}),tR=c(Kk.prototype,"_paddingLeft",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iR=c(Kk.prototype,"_paddingRight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nR=c(Kk.prototype,"_paddingTop",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rR=c(Kk.prototype,"_paddingBottom",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aR=c(Kk.prototype,"_spacingX",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sR=c(Kk.prototype,"_spacingY",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oR=c(Kk.prototype,"_verticalDirection",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gR.TOP_TO_BOTTOM}}),lR=c(Kk.prototype,"_horizontalDirection",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SR.LEFT_TO_RIGHT}}),cR=c(Kk.prototype,"_affectedByScale",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yk=Kk))||Yk)||Yk)||Yk)||Yk);cc.LayoutComponent=YR,(wR=ER||(ER={}))[wR.BUTT=0]="BUTT",wR[wR.ROUND=1]="ROUND",wR[wR.SQUARE=2]="SQUARE",Rt(ER),(CR=AR||(AR={}))[CR.BEVEL=0]="BEVEL",CR[CR.ROUND=1]="ROUND",CR[CR.MITER=2]="MITER",Rt(AR),(RR=kR||(kR={}))[RR.PT_CORNER=1]="PT_CORNER",RR[RR.PT_LEFT=2]="PT_LEFT",RR[RR.PT_BEVEL=4]="PT_BEVEL",RR[RR.PT_INNERBEVEL=8]="PT_INNERBEVEL",Rt(kR);var KR,QR,ZR,JR,$R,eO,tO,iO,nO,rO,aO,sO,oO,lO=(OR=Ca("cc.GraphicsComponent"),MR=Fa(110),LR=Ia("UI/Render/Graphics"),IR=ka({type:AR}),FR=ka({type:ER}),PR=ka({override:!0,visible:!1}),OR(DR=MR(DR=LR((WR=jR=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).impl=null,e.model=null,m(e,"_lineWidth",BR,_(e)),m(e,"_strokeColor",NR,_(e)),m(e,"_lineJoin",UR,_(e)),m(e,"_lineCap",GR,_(e)),m(e,"_fillColor",VR,_(e)),m(e,"_miterLimit",HR,_(e)),e._instanceMaterialType=OT.ADDCOLOR,e}return d(t,_x),l(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color}}]),l(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){p(S(t.prototype),"__preload",this)&&p(S(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=cc.director.root.ui.getRenderSceneGetter()}},{key:"onEnable",value:function(){p(S(t.prototype),"onEnable",this).call(this),this.model&&(this.model.enabled=!0),this._activateMaterial()}},{key:"onDisable",value:function(){this.model&&(this.model.enabled=!1)}},{key:"onDestroy",value:function(){p(S(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this._getRenderScene().destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.impl&&(this.impl.clear(e),this.model&&(this.model.scene.destroyModel(this.model),this.model=null),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"helpInstanceMaterial",value:function(){var e=null;this._sharedMaterial?e=zb.getInstantiatedMaterial(this._sharedMaterial,new RS,!1):((e=zb.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new RS,!1)).recompileShaders({USE_LOCAL:!0}),e.onLoaded()),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!p(S(t.prototype),"_canRender",this).call(this)&&!!this.model}}]),t}(),jR.LineJoin=AR,jR.LineCap=ER,c((zR=WR).prototype,"lineJoin",[IR],Object.getOwnPropertyDescriptor(zR.prototype,"lineJoin"),zR.prototype),c(zR.prototype,"lineCap",[FR],Object.getOwnPropertyDescriptor(zR.prototype,"lineCap"),zR.prototype),c(zR.prototype,"strokeColor",[ka],Object.getOwnPropertyDescriptor(zR.prototype,"strokeColor"),zR.prototype),c(zR.prototype,"fillColor",[ka],Object.getOwnPropertyDescriptor(zR.prototype,"fillColor"),zR.prototype),c(zR.prototype,"miterLimit",[ka],Object.getOwnPropertyDescriptor(zR.prototype,"miterLimit"),zR.prototype),c(zR.prototype,"color",[PR],Object.getOwnPropertyDescriptor(zR.prototype,"color"),zR.prototype),BR=c(zR.prototype,"_lineWidth",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NR=c(zR.prototype,"_strokeColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.BLACK.clone()}}),UR=c(zR.prototype,"_lineJoin",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AR.MITER}}),GR=c(zR.prototype,"_lineCap",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ER.BUTT}}),VR=c(zR.prototype,"_fillColor",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.WHITE.clone()}}),HR=c(zR.prototype,"_miterLimit",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),DR=zR))||DR)||DR)||DR);cc.GraphicsComponent=lO;var cO,uO,hO=new Nn,_O=new Ui,fO=new Nn,dO=[];(uO=cO||(cO={}))[uO.RECT=0]="RECT",uO[uO.ELLIPSE=1]="ELLIPSE",Rt(cO);var pO,mO,vO,yO,gO,bO,SO,TO,xO,EO,wO,AO,CO,kO,RO,OO,MO,LO=(KR=Ca("cc.MaskComponent"),QR=Fa(110),ZR=Ia("UI/Render/Mask"),JR=ka({type:cO,displayOrder:4}),$R=ka({visible:!1,override:!0}),eO=ka({visible:!1,override:!0}),tO=ka({visible:!1,override:!0}),KR(iO=QR(iO=ZR((oO=sO=function(e){function i(){var e;return y(this,i),m(e=T(this,S(i).call(this)),"_type",rO,_(e)),m(e,"_segments",aO,_(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=OT.ADDCOLOR,e}return d(i,_x),l(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._activateMaterial())}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments=wi(e,3,1e4),this._updateGraphics()}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),l(i,[{key:"onLoad",value:function(){this._createGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){p(S(i.prototype),"onEnable",this).call(this),this._flushVisibility(),this._clearGraphics&&this._clearGraphics.onEnable(),this._updateGraphics(),this._activateMaterial(),this.node.on(Zt.SystemEventType.TRANSFORM_CHANGED,this._nodeStateChange,this),cc.view.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){p(S(i.prototype),"onDisable",this).call(this),this._disableGraphics(),this.node.off(Zt.SystemEventType.TRANSFORM_CHANGED,this._nodeStateChange),cc.view.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){p(S(i.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=_O;this.node.getWorldMatrix(hO),Nn.invert(fO,hO),Ui.transformMat4(a,e,fO);var s=t.getAnchorPoint();a.x+=s.x*n,a.y+=s.y*r;var o=!1;if(this.type===cO.RECT)o=0<=a.x&&0<=a.y&&a.x<=n&&a.y<=r;else if(this.type===cO.ELLIPSE){var l=n/2,c=r/2,u=a.x-.5*n,h=a.y-.5*r;o=u*u/(l*l)+h*h/(c*c)<1}return o}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){e!==Zt.SystemEventType.POSITION_PART&&(p(S(i.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics())}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!p(S(i.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this),t=i.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_parentChanged",value:function(e){return!!p(S(i.prototype),"_parentChanged",this).call(this,e)&&(this._flushVisibility(),!0)}},{key:"_onTextureLoaded",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderData.vertDirty=!0),this.enabledInHierarchy&&this._activateMaterial()}},{key:"_applySpriteFrame",value:function(e){}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=this._clearGraphics=new lO;e.node=new xf("clear-graphics"),e.helpInstanceMaterial(),e._activateMaterial(),e.lineWidth=0;var t=or.WHITE.clone();t.a=0,this._clearGraphics.fillColor=t,this._updateClearGraphics()}if(!this._graphics){var i=this._graphics=new lO;i.node=this.node,i.node.getWorldMatrix(),i.helpInstanceMaterial(),i.lineWidth=0;var n=or.WHITE.clone();n.a=0,i.fillColor=n}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){console.log("resolution changed");var e=cc.visibleRect;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),s=-n*a.x,o=-r*a.y;if(this._type===cO.RECT)t.rect(s,o,n,r);else if(this._type===cO.ELLIPSE){for(var l=function(e,t,i){dO.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)dO.push(cc.v3(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return dO}(cc.v3(s+n/2,o+r/2,0),cc.v3(n/2,r/2,0),this._segments),c=0;c<l.length;++c){var u=l[c];0===c?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},{key:"_flushVisibility",value:function(){this._clearGraphics&&this._clearGraphics.setVisibility(this._visibility),this._graphics&&this._graphics.setVisibility(this._visibility)}},{key:"_activateMaterial",value:function(){}}]),i}(),sO.Type=cO,c((nO=oO).prototype,"type",[JR],Object.getOwnPropertyDescriptor(nO.prototype,"type"),nO.prototype),c(nO.prototype,"segments",[ka],Object.getOwnPropertyDescriptor(nO.prototype,"segments"),nO.prototype),c(nO.prototype,"dstBlendFactor",[$R],Object.getOwnPropertyDescriptor(nO.prototype,"dstBlendFactor"),nO.prototype),c(nO.prototype,"srcBlendFactor",[eO],Object.getOwnPropertyDescriptor(nO.prototype,"srcBlendFactor"),nO.prototype),c(nO.prototype,"color",[tO],Object.getOwnPropertyDescriptor(nO.prototype,"color"),nO.prototype),rO=c(nO.prototype,"_type",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cO.RECT}}),aO=c(nO.prototype,"_segments",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),iO=nO))||iO)||iO)||iO);cc.MaskComponent=LO,(MO=OO||(OO={}))[MO.HORIZONTAL=0]="HORIZONTAL",MO[MO.VERTICAL=1]="VERTICAL",MO[MO.FILLED=2]="FILLED",kt(OO);var IO,FO,PO,DO,zO=(pO=Ca("cc.ProgressBarComponent"),mO=Fa(110),vO=Ia("UI/ProgressBar"),yO=ka({type:ZA}),gO=ka({type:OO}),bO=ka({range:[0,1,.1],slide:!0}),pO(SO=mO(SO=vO((RO=kO=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_barSprite",xO,_(t)),m(t,"_mode",EO,_(t)),m(t,"_totalLength",wO,_(t)),m(t,"_progress",AO,_(t)),m(t,"_reverse",CO,_(t)),t}return d(a,R_),l(a,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===ZA.FillType.RADIAL&&(this._mode=OO.FILLED),this._mode===OO.HORIZONTAL?this.totalLength=n.width:this._mode===OO.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new Ui(0,.5),a=Ai(this._progress),s=this._totalLength*a,o=i,l=0,c=0;switch(this._mode){case OO.HORIZONTAL:this._reverse&&(r=new Ui(1,.5)),o=new Kn(s,i.height),l=this._totalLength,c=i.height;break;case OO.VERTICAL:r=this._reverse?new Ui(.5,1):new Ui(.5,0),o=new Kn(i.width,s),l=i.width,c=this._totalLength}if(this._mode===OO.FILLED)this._barSprite.type!==cc.SpriteComponent.Type.FILLED?cc.warn("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==cc.SpriteComponent.Type.FILLED){var u=r.x-t.x,h=r.y-t.y,_=new Xi(l*u,c*h,0);e.setPosition(n.x+_.x,n.y+_.y,n.z),e.setAnchorPoint(r),e.setContentSize(o)}else cc.warn("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===OO.HORIZONTAL?this.totalLength=i.width:this._mode===OO.VERTICAL?this.totalLength=i.height:this._mode===OO.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===OO.FILLED&&(e=Ai(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),a}(),kO.Mode=OO,c((TO=RO).prototype,"barSprite",[yO],Object.getOwnPropertyDescriptor(TO.prototype,"barSprite"),TO.prototype),c(TO.prototype,"mode",[gO],Object.getOwnPropertyDescriptor(TO.prototype,"mode"),TO.prototype),c(TO.prototype,"totalLength",[ka],Object.getOwnPropertyDescriptor(TO.prototype,"totalLength"),TO.prototype),c(TO.prototype,"progress",[bO],Object.getOwnPropertyDescriptor(TO.prototype,"progress"),TO.prototype),c(TO.prototype,"reverse",[ka],Object.getOwnPropertyDescriptor(TO.prototype,"reverse"),TO.prototype),xO=c(TO.prototype,"_barSprite",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EO=c(TO.prototype,"_mode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.HORIZONTAL}}),wO=c(TO.prototype,"_totalLength",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AO=c(TO.prototype,"_progress",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),CO=c(TO.prototype,"_reverse",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SO=TO))||SO)||SO)||SO);cc.ProgressBarComponent=zO;var BO,NO,UO,GO,VO,HO,jO,WO,XO,qO,YO,KO,QO,ZO,JO,$O,eM,tM,iM,nM=Ca("cc.LabelOutlineComponent")(IO=Fa(110)(IO=Ia("UI/Render/LabelOutline")((PO=c((FO=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_color",PO,_(t)),m(t,"_width",DO,_(t)),t}return d(a,R_),l(a,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(QC);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),a}()).prototype,"_color",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(255,255,255,255)}}),DO=c(FO.prototype,"_width",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(FO.prototype,"color",[ka],Object.getOwnPropertyDescriptor(FO.prototype,"color"),FO.prototype),c(FO.prototype,"width",[ka],Object.getOwnPropertyDescriptor(FO.prototype,"width"),FO.prototype),IO=FO))||IO)||IO)||IO;cc.LabelOutlineComponent=nM;var rM=new up,aM="RICHTEXT_CHILD",sM="RICHTEXT_Image_CHILD";var oM=new qe(function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(nM)},20);oM.get=function(e,t){var i=this._get();i||(i={node:new Rd(aM),comp:null,lineCount:0,styleIndex:0,clickHandler:""});var n=i.node;n||(n=new Rd(aM));var r=n.getComponent(QC);return r||(r=n.addComponent(QC)),r=r,n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof t_?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=Zt.HorizontalTextAlignment.LEFT,r.verticalAlign=Zt.VerticalTextAlignment.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var lM,cM,uM,hM,_M,fM,dM,pM,mM,vM,yM,gM,bM,SM,TM=(BO=Ca("cc.RichTextComponent"),NO=Fa(110),UO=Ia("UI/Render/RichText"),GO=ka({multiline:!0}),VO=ka({type:Zt.HorizontalTextAlignment}),HO=ka({type:u_}),jO=ka({type:Eh}),BO(WO=NO(WO=UO(WO=Ma((iM=tM=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_lineHeight",qO,_(e)),m(e,"_string",YO,_(e)),m(e,"_horizontalAlign",KO,_(e)),m(e,"_fontSize",QO,_(e)),m(e,"_maxWidth",ZO,_(e)),m(e,"_font",JO,_(e)),m(e,"_imageAtlas",$O,_(e)),m(e,"_handleTouchEvent",eM,_(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return d(t,LT),l(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),l(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded()}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.node.removeFromParent(),oM.put(r)}}},{key:"_addEventListeners",value:function(){this.node.on(cc.Node.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(cc.Node.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var t=this;this._labelSegments.forEach(function(e){t._applyTextAttribute(e)})}},{key:"_createFontLabel",value:function(e){return oM.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof u_)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var i=this;cc.loader.load(this._font.nativeUrl,function(e,t){i._layoutDirty=!0,i._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(i,e){var n=this,t=function(e){var t;return 0===n._labelSegmentsCache.length?(t=n._createFontLabel(e),n._labelSegmentsCache.push(t)):(t=n._labelSegmentsCache[0]).node.getComponent(QC).string=e,t.styleIndex=i,n._applyTextAttribute(t),t.node.getContentSize().width};return e?t(e):t}},{key:"_onTouchEnded",value:function(n){var t=this,r=this.node.getComponents(LT),a=this,e=function(){if(o){if(l>=s.length)return"break";c=s[l++]}else{if((l=s.next()).done)return"break";c=l.value}var e=c,i=e.clickHandler;i&&t._containsTouchLocation(e,n.touch.getUILocation())&&(r.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(a,n)}),n.propagationStopped=!0)},s=this._labelSegments,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if("break"===e())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(cT);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var n=this,r=this.node.children,e=function(e){var t=r[e];if((t.name===aM||t.name===sM)&&(t.parent===n.node?t.parent=null:r.splice(e,1),t.name===aM)){var i=n._labelSegments.findIndex(function(e){return e.node===t});-1!==i&&oM.put(n._labelSegments[i])}},t=r.length-1;0<=t;t--)e(t);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==aM&&i.name!==sM||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(QC);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(0<this._lineOffsetX&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),o=this._measureText(i,s);if(!(this._lineOffsetX+o<=this.maxWidth)){if(0<r){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=a}if(n>this.maxWidth)for(var c=yu(e,n,this.maxWidth,this._measureText(i)),u=0;u<c.length;++u){var h=c[u],_=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=_.width,1<c.length&&u<c.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new Rd(sM),r=n.addComponent(ZA);n.setAnchorPoint(0,0),r.type=cc.SpriteComponent.Type.SLICED,r.sizeMode=cc.SpriteComponent.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var s=i.getRect(),o=1,l=s.width,c=s.height,u=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&0<h&&h<this.lineHeight?l*=o=h/c:l*=o=this.lineHeight/c,c*=o,void 0!==u&&0<u&&(l=u),0<this.maxWidth?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,c),a.lineCount=this._lineCount,e.style.event){e.style.event.click&&(a.clickHandler=e.style.event.click)}}else cc.warnID(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=rM.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var s=a.split("\n"),o=0;o<s.length;++o){var l=s[o];if(""!==l)if(i=!1,0<this.maxWidth){var c=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,c,n),1<s.length&&o<s.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),1<s.length&&o<s.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&o===s.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),0<this.maxWidth&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(pu(n)||mu(n))return 1;for(var r=1,a=t+1;a<i&&(!mu(n=e.charAt(a))&&!pu(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,n=this._labelSegments,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.lineCount;t<l&&(e=0,t=l);var c=0;switch(this.horizontalAlign){case Zt.HorizontalTextAlignment.LEFT:c=-this._labelWidth/2;break;case Zt.HorizontalTextAlignment.CENTER:c=-this._linesWidth[l-1]/2;break;case Zt.HorizontalTextAlignment.RIGHT:c=this._labelWidth/2-this._linesWidth[l-1]}var u=o.node.getContentSize(),h=o.node.getPosition();o.node.setPosition(e+c,this.lineHeight*(i-l)-this._labelHeight/2,h.z),l===t&&(e+=u.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return or[t]?or[t]:(new or).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(QC);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=Zt.HorizontalTextAlignment.LEFT,t.verticalAlign=Zt.VerticalTextAlignment.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(QC);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent(nM);a||(a=e.node.addComponent(nM)),a.color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){i.event.click&&(e.clickHandler=i.event.click)}}}}]),t}(),tM.HorizontalAlign=Zt.HorizontalTextAlignment,tM.VerticalAlign=Zt.VerticalTextAlignment,c((XO=iM).prototype,"string",[GO],Object.getOwnPropertyDescriptor(XO.prototype,"string"),XO.prototype),c(XO.prototype,"horizontalAlign",[VO],Object.getOwnPropertyDescriptor(XO.prototype,"horizontalAlign"),XO.prototype),c(XO.prototype,"fontSize",[ka],Object.getOwnPropertyDescriptor(XO.prototype,"fontSize"),XO.prototype),c(XO.prototype,"font",[HO],Object.getOwnPropertyDescriptor(XO.prototype,"font"),XO.prototype),c(XO.prototype,"maxWidth",[ka],Object.getOwnPropertyDescriptor(XO.prototype,"maxWidth"),XO.prototype),c(XO.prototype,"lineHeight",[ka],Object.getOwnPropertyDescriptor(XO.prototype,"lineHeight"),XO.prototype),c(XO.prototype,"imageAtlas",[jO],Object.getOwnPropertyDescriptor(XO.prototype,"imageAtlas"),XO.prototype),c(XO.prototype,"handleTouchEvent",[ka],Object.getOwnPropertyDescriptor(XO.prototype,"handleTouchEvent"),XO.prototype),qO=c(XO.prototype,"_lineHeight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YO=c(XO.prototype,"_string",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),KO=c(XO.prototype,"_horizontalAlign",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zt.HorizontalTextAlignment.LEFT}}),QO=c(XO.prototype,"_fontSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ZO=c(XO.prototype,"_maxWidth",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JO=c(XO.prototype,"_font",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$O=c(XO.prototype,"_imageAtlas",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eM=c(XO.prototype,"_handleTouchEvent",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WO=XO))||WO)||WO)||WO)||WO);cc.RichTextComponent=TM;var xM,EM,wM=new Xi,AM=new Xi,CM=new Xi,kM=new Ui,RM=new or;(EM=xM||(xM={}))[EM.HORIZONTAL=0]="HORIZONTAL",EM[EM.VERTICAL=1]="VERTICAL",Rt(xM);var OM,MM=(lM=Ca("cc.ScrollBarComponent"),cM=Fa(110),uM=Ia("UI/ScrollBar"),hM=ka({type:ZA}),_M=ka({type:xM}),lM(fM=cM(fM=uM((SM=bM=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_scrollView",pM,_(t)),m(t,"_handle",mM,_(t)),m(t,"_direction",vM,_(t)),m(t,"_enableAutoHide",yM,_(t)),m(t,"_autoHideTime",gM,_(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}return d(a,R_),l(a,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,s=0,o=0,l=0,c=0;this._direction===xM.HORIZONTAL?(a=i.width,s=n.width,c=r.width,o=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===xM.VERTICAL&&(a=i.height,s=n.height,c=r.height,o=e.y,l=-this._convertToScrollViewSpace(t).y);var u=this._calculateLength(a,s,c,o),h=this._calculatePosition(a,s,c,l,o,u);this._updateLength(u),this._updateHanlderPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(ZA);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return wM;var t=e.getAnchorPoint(),i=e.getContentSize(),n=new Xi(-t.x*i.width,-t.y*i.height,0);return e.uiTransfromComp.convertToWorldSpaceAR(n,n),t=this._scrollView.node.getAnchorPoint(),i=this._scrollView.node.getContentSize(),n.x+=t.x*i.width,n.y+=t.y*i.height,this._scrollView.node.uiTransfromComp.convertToNodeSpaceAR(n,n),n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(ZA);t&&(RM.set(t.color),RM.a=e,t.color=RM),(t=this._handle.getComponent(ZA))&&(RM.set(t.color),RM.a=e,t.color=RM)}}},{key:"_updateHanlderPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;Xi.set(AM,-e.width*t.x,-e.height*t.y,0);var r=this.node.uiTransfromComp.convertToWorldSpaceAR(AM,CM),a=new Xi;return n.uiTransfromComp.convertToNodeSpaceAR(r,a),this.direction===xM.HORIZONTAL?a=new Xi(a.x,a.y+(e.height-i.height)/2,0):this.direction===xM.VERTICAL&&(a=new Xi(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===xM.HORIZONTAL||e.height<=t.height&&this._direction===xM.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(0<n?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var s=e-t;r&&(s+=Math.abs(r));var o=0;s&&(o=Ai(o=n/s));var l=(i-a)*o;return this._direction===xM.VERTICAL?new Xi(0,l,0):new Xi(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===kM.x&&n.y===kM.y||t.setAnchorPoint(kM),this._direction===xM.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(cc.v2(0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Xi))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),a}(),bM.Direction=xM,c((dM=SM).prototype,"handle",[hM],Object.getOwnPropertyDescriptor(dM.prototype,"handle"),dM.prototype),c(dM.prototype,"direction",[_M],Object.getOwnPropertyDescriptor(dM.prototype,"direction"),dM.prototype),c(dM.prototype,"enableAutoHide",[ka],Object.getOwnPropertyDescriptor(dM.prototype,"enableAutoHide"),dM.prototype),c(dM.prototype,"autoHideTime",[ka],Object.getOwnPropertyDescriptor(dM.prototype,"autoHideTime"),dM.prototype),pM=c(dM.prototype,"_scrollView",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mM=c(dM.prototype,"_handle",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vM=c(dM.prototype,"_direction",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xM.HORIZONTAL}}),yM=c(dM.prototype,"_enableAutoHide",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gM=c(dM.prototype,"_autoHideTime",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fM=dM))||fM)||fM)||fM);cc.ScrollBarComponent=MM;var LM,IM,FM,PM,DM,zM,BM,NM,UM,GM,VM,HM,jM,WM,XM,qM,YM,KM,QM,ZM,JM,$M,eL,tL=Ca("cc.ViewGroupComponent")(OM=Fa(110)(OM=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,R_),t}())||OM)||OM;cc.ViewGroupComponent=tL;var iL,nL,rL=Zt.SystemEventType,aL=1e-4,sL=new Xi,oL=new Xi,lL=function(){return(new Date).getMilliseconds()};(nL=iL||(iL={}))[nL.SCROLL_TO_TOP=0]="SCROLL_TO_TOP",nL[nL.SCROLL_TO_BOTTOM=1]="SCROLL_TO_BOTTOM",nL[nL.SCROLL_TO_LEFT=2]="SCROLL_TO_LEFT",nL[nL.SCROLL_TO_RIGHT=3]="SCROLL_TO_RIGHT",nL[nL.SCROLLING=4]="SCROLLING",nL[nL.BOUNCE_TOP=5]="BOUNCE_TOP",nL[nL.BOUNCE_BOTTOM=6]="BOUNCE_BOTTOM",nL[nL.BOUNCE_LEFT=7]="BOUNCE_LEFT",nL[nL.BOUNCE_RIGHT=8]="BOUNCE_RIGHT",nL[nL.SCROLL_ENDED=9]="SCROLL_ENDED",nL[nL.TOUCH_UP=10]="TOUCH_UP",nL[nL.AUTOSCROLL_ENDED_WITH_THRESHOLD=11]="AUTOSCROLL_ENDED_WITH_THRESHOLD",nL[nL.SCROLL_BEGAN=12]="SCROLL_BEGAN",Rt(iL);var cL,uL,hL,_L,fL,dL,pL,mL,vL,yL,gL,bL,SL,TL,xL,EL={"scroll-to-top":iL.SCROLL_TO_TOP,"scroll-to-bottom":iL.SCROLL_TO_BOTTOM,"scroll-to-left":iL.SCROLL_TO_LEFT,"scroll-to-right":iL.SCROLL_TO_RIGHT,scrolling:iL.SCROLLING,"bounce-bottom":iL.BOUNCE_BOTTOM,"bounce-left":iL.BOUNCE_LEFT,"bounce-right":iL.BOUNCE_RIGHT,"bounce-top":iL.BOUNCE_TOP,"scroll-ended":iL.SCROLL_ENDED,"touch-up":iL.TOUCH_UP,"scroll-ended-with-threshold":iL.AUTOSCROLL_ENDED_WITH_THRESHOLD,"scroll-began":iL.SCROLL_BEGAN},wL=(LM=Ca("cc.ScrollViewComponent"),IM=Fa(110),FM=Ia("UI/ScrollView"),PM=ka({type:xf}),DM=ka({type:MM}),zM=ka({type:MM}),BM=ka({range:[0,1,.1]}),NM=ka({range:[0,10]}),LM(UM=IM(UM=FM((eL=$M=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"horizontal",VM,_(t)),m(t,"vertical",HM,_(t)),m(t,"inertia",jM,_(t)),m(t,"brake",WM,_(t)),m(t,"elastic",XM,_(t)),m(t,"bounceDuration",qM,_(t)),m(t,"scrollEvents",YM,_(t)),m(t,"cancelInnerEvents",KM,_(t)),t._autoScrolling=!1,t._scrolling=!1,m(t,"_content",QM,_(t)),m(t,"_horizontalScrollBar",ZM,_(t)),m(t,"_verticalScrollBar",JM,_(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Xi,t._autoScrollTargetDelta=new Xi,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Xi,t._outOfBoundaryAmount=new Xi,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Xi,t._deltaPos=new Xi,t}return d(a,tL),l(a,[{key:"scrollToBottom",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ui(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t,i){var n=this.getMaxScrollOffset(),r=new Ui(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Xi(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node.getContentSize(),t=this._content.getContentSize(),i=t.width-e.width,n=t.height-e.height;return new Xi(i=0<=i?i:0,n=0<=n?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Ui(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Ui(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Ui(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){e.equals(this.getContentPosition(),aL)||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._content.getPosition(this._contentPos),this._contentPos):sL}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return aL}},{key:"start",value:function(){this._calculateBoundary(),this._content&&cc.director.once(cc.Director.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(rL.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(rL.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.on(rL.POSITION_PART,this._calculateBoundary,this),this.view.on(rL.SCALE_PART,this._calculateBoundary,this),this.view.on(rL.SIZE_CHANGED,this._calculateBoundary,this))),this._showScrollbar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(rL.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(rL.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.off(rL.POSITION_PART,this._calculateBoundary,this),this.view.off(rL.SCALE_PART,this._calculateBoundary,this),this.view.off(rL.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollbar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(rL.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(rL.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(rL.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(rL.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(rL.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(rL.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(rL.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(rL.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(rL.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(rL.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Xi,n=-.1;0,this.vertical?i=new Xi(0,e.getScrollY()*n,0):this.horizontal&&(i=new Xi(e.getScrollY()*n,0,0)),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)&&e&&e.touch){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var n=new Ui(i.getUILocation());if(n.subtract(i.getStartLocation()),7<n.length()&&!this._touchMoved&&e.target!==this.node){var r=new mr(e.getTouches(),e.bubbles);r.type=rL.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent("touch-up");var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(YR);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view.getContentSize(),i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===cc.Event.CAPTURING_PHASE){if(t){var i=t,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(this.node===s)return!(!e.target||!e.target.getComponent(tL));if(s.getComponent(tL))return!0}}return!1}}},{key:"_handleReleaseLogic",value:function(e){var t=e.getUIDelta();Xi.set(this._deltaPos,t.x,t.y,0),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_startInertiaScroll",value:function(e){var t=new Xi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitalSpeed(t.length()),n=new Xi(e);n.normalize();var r=this._content.getContentSize(),a=this.node.getContentSize(),s=r.width-a.width,o=r.height-a.height,l=this._calculateAttenuatedFactor(s),c=this._calculateAttenuatedFactor(o);n.x=n.x*s*(1-this.brake)*l,n.y=n.y*o*c*(1-this.brake),n.z=0;var u=e.length(),h=n.length()/u;if(n.add(e),0<this.brake&&7<h){h=Math.sqrt(h);var _=new Xi(e);_.multiplyScalar(h),n.set(_),n.add(e)}0<this.brake&&3<h&&(i*=h=3),0===this.brake&&1<h&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitalSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,Xi.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Xi,this._getHowMuchOutOfBoundary().equals(sL,aL)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},e))<=0||.5<=e)return new Xi;var t=new Xi;return t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t),e},t),new Xi(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);oL.set(this.getContentPosition()),oL.add(i),this.setContentPosition(oL);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.getAnchorPoint().x*this._content.getContentSize().width}},{key:"_getContentRightBoundary",value:function(){var e=this._content.getContentSize();return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){var e=this._content.getContentSize();return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.getAnchorPoint().y*this._content.getContentSize().height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Xi).equals(sL,aL)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Xi;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(sL,aL)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if("scroll-ended"===e)this._scrollEventEmitMask=0;else if("scroll-to-top"===e||"scroll-to-bottom"===e||"scroll-to-left"===e||"scroll-to-right"===e){var t=1<<EL[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}cc.Component.EventHandler.emitEvents(this.scrollEvents,this,EL[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary(new Xi),t=new Xi(this.getContentPosition());t.add(e),this._content&&(this._content.setPosition(t),this._updateScrollBar(sL))}}},{key:"_hideScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this.verticalScrollBar&&this.verticalScrollBar.hide()}},{key:"_showScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this.verticalScrollBar&&this.verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e&&e.eventPhase===cc.Event.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){var t=e.getUIDelta();Xi.set(this._deltaPos,t.x,t.y,0),this._processDeltaMove(this._deltaPos)}},{key:"_scrollChildren",value:function(e){var t,i=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t));var n="",r=new Xi;if(this._content.getPosition(r),0<i.y)r.y-this._content.anchorY*this._content.height+i.y>this._bottomBoundary&&(n="scroll-to-bottom");else if(i.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+i.y<=this._topBoundary&&(n="scroll-to-top")}else if(i.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+i.x<=this._rightBoundary&&(n="scroll-to-right")}else if(0<i.x){r.x-this._content.anchorX*this._content.width+i.x>=this._leftBoundary&&(n="scroll-to-left")}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent("scroll-began")),this._dispatchEvent("scrolling")),0<n.length&&this._dispatchEvent(n)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent("scroll-ended"),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=lL(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content.getContentSize(),i=this.node.getContentSize();return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){for(e=this._clampDelta(e);5<=this._touchMoveDisplacements.length;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var t=lL();this._touchMoveTimeDeltas.push((t-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=t}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals(sL,aL))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent("bounce-top"),e.y<0&&this._dispatchEvent("bounce-bottom"),0<e.x&&this._dispatchEvent("bounce-right"),e.x<0&&this._dispatchEvent("bounce-left"),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(oL,aL)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(sL,aL)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=function(e){return(e-=1)*e*e*e*e+1}(n));var r=new Xi(this._autoScrollTargetDelta);r.multiplyScalar(n);var a=new Xi(this._autoScrollStartPosition);a.add(r);var s=Math.abs(n-1)<=aL;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent("scroll-ended-with-threshold"),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var o=new Xi(a);o.subtract(this._autoScrollBrakingStartPosition),t&&o.multiplyScalar(i),a.set(this._autoScrollBrakingStartPosition),a.add(o)}else{var l=new Xi(a);l.subtract(this.getContentPosition());var c=this._getHowMuchOutOfBoundary(l);c.equals(sL,aL)||(a.add(c),s=!0)}s&&(this._autoScrolling=!1);var u=new Xi(a);u.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(u),s),this._dispatchEvent("scrolling"),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent("scroll-ended"))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(sL,aL))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new Ui(0,0),new Ui(1,1));var r=this.node.getContentSize(),a=this._content.getContentSize(),s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var l=new Xi,c=0;return i&&(c=a.width-r.width,l.x=o-c*t.x),n&&(c=a.height-r.height,l.y=s-c*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content.getContentSize(),i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new Xi,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(sL)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(sL)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),a}(),$M.EventType=iL,c((GM=eL).prototype,"content",[PM],Object.getOwnPropertyDescriptor(GM.prototype,"content"),GM.prototype),c(GM.prototype,"horizontalScrollBar",[DM],Object.getOwnPropertyDescriptor(GM.prototype,"horizontalScrollBar"),GM.prototype),c(GM.prototype,"verticalScrollBar",[zM],Object.getOwnPropertyDescriptor(GM.prototype,"verticalScrollBar"),GM.prototype),VM=c(GM.prototype,"horizontal",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HM=c(GM.prototype,"vertical",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jM=c(GM.prototype,"inertia",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WM=c(GM.prototype,"brake",[BM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),XM=c(GM.prototype,"elastic",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qM=c(GM.prototype,"bounceDuration",[NM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),YM=c(GM.prototype,"scrollEvents",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KM=c(GM.prototype,"cancelInnerEvents",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QM=c(GM.prototype,"_content",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZM=c(GM.prototype,"_horizontalScrollBar",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JM=c(GM.prototype,"_verticalScrollBar",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UM=GM))||UM)||UM)||UM);cc.ScrollViewComponent=wL;var AL,CL,kL=new Xi;(CL=AL||(AL={}))[CL.Horizontal=0]="Horizontal",CL[CL.Vertical=1]="Vertical",Rt(AL);var RL,OL,ML,LL,IL,FL,PL,DL,zL=(cL=Ca("cc.SliderComponent"),uL=Fa(110),hL=Ia("UI/Slider"),_L=ka({type:ZA}),fL=ka({type:AL}),dL=ka({slide:!0,range:[0,1,.01]}),pL=ka({type:OS}),cL(mL=uL(mL=hL((xL=TL=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"slideEvents",yL,_(t)),m(t,"_handle",gL,_(t)),m(t,"_direction",bL,_(t)),m(t,"_progress",SL,_(t)),t._offset=new Xi,t._dragging=!1,t._touchHandle=!1,t._handlelocalPos=new Xi,t._touchPos=new Xi,t}return d(a,R_),l(a,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(Zt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(Zt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(Zt.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Zt.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Zt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(Zt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(Zt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(Zt.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Zt.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Zt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Zt.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node.uiTransfromComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Xi.set(this._touchPos,t.x,t.y,0),this._handle.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=cc.v2(),e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){cc.Component.EventHandler.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Xi.set(this._touchPos,t.x,t.y,0);var i=this.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,kL);this.direction===AL.Horizontal?this.progress=Ai(.5+(i.x-this._offset.x)/this.node.width):this.progress=Ai(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===AL.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),a}(),TL.Direction=AL,c((vL=xL).prototype,"handle",[_L],Object.getOwnPropertyDescriptor(vL.prototype,"handle"),vL.prototype),c(vL.prototype,"direction",[fL],Object.getOwnPropertyDescriptor(vL.prototype,"direction"),vL.prototype),c(vL.prototype,"progress",[dL],Object.getOwnPropertyDescriptor(vL.prototype,"progress"),vL.prototype),yL=c(vL.prototype,"slideEvents",[pL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gL=c(vL.prototype,"_handle",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bL=c(vL.prototype,"_direction",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AL.Horizontal}}),SL=c(vL.prototype,"_progress",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),mL=vL))||mL)||mL)||mL);cc.SliderComponent=zL;var BL,NL,UL,GL,VL,HL,jL,WL,XL,qL,YL,KL,QL=(RL=Ca("cc.ToggleContainerComponent"),OL=Fa(110),ML=Ia("UI/ToggleContainer"),LL=ka({type:OS}),RL(IL=OL(IL=ML(IL=Ma((PL=c((FL=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"checkEvents",PL,_(t)),m(t,"_allowSwitchOff",DL,_(t)),t._toggleItems=[],t}return d(a,R_),l(a,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(t){this.enabledInHierarchy&&t.isChecked&&(this.toggleItems.forEach(function(e){e!==t&&e.isChecked&&e.enabled&&(e.isChecked=!1)}),this.checkEvents&&OS.emitEvents(this.checkEvents,t))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);-1<t&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var t=!1;return this._toggleItems.forEach(function(e){t&&e.enabled&&(e.isChecked=!1),e.isChecked&&e.enabled&&(t=!0)}),t}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||0<this._toggleItems.length&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),a}()).prototype,"checkEvents",[LL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DL=c(FL.prototype,"_allowSwitchOff",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(FL.prototype,"allowSwitchOff",[ka],Object.getOwnPropertyDescriptor(FL.prototype,"allowSwitchOff"),FL.prototype),IL=FL))||IL)||IL)||IL)||IL);cc.ToggleContainerComponent=QL;var ZL,JL=(BL=Ca("cc.ToggleComponent"),NL=Fa(110),UL=Ia("UI/Toggle"),GL=ka({type:QL}),VL=ka({type:ZA}),HL=ka({type:OS}),BL(jL=NL(jL=UL(jL=Ma((c((WL=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"checkEvents",XL,_(t)),m(t,"_isChecked",qL,_(t)),m(t,"_toggleGroup",YL,_(t)),m(t,"_checkMark",KL,_(t)),t}return d(a,JA),l(a,[{key:"onEnable",value:function(){p(S(a.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){p(S(a.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on("click",this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off("click",this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit("toggle",this),this.checkEvents&&OS.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),a}()).prototype,"isChecked",[ka],Object.getOwnPropertyDescriptor(WL.prototype,"isChecked"),WL.prototype),c(WL.prototype,"toggleGroup",[GL],Object.getOwnPropertyDescriptor(WL.prototype,"toggleGroup"),WL.prototype),c(WL.prototype,"checkMark",[VL],Object.getOwnPropertyDescriptor(WL.prototype,"checkMark"),WL.prototype),XL=c(WL.prototype,"checkEvents",[HL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qL=c(WL.prototype,"_isChecked",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YL=c(WL.prototype,"_toggleGroup",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KL=c(WL.prototype,"_checkMark",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jL=WL))||jL)||jL)||jL)||jL);cc.ToggleComponent=JL;var $L,eI,tI,iI=Ca("cc.UIModelComponent")(ZL=Fa(110)(ZL=Ia("UI/Model")(ZL=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._modelComponent=null,t}return d(a,LT),l(a,[{key:"onLoad",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=cc.director.root.ui.getRenderSceneGetter(),this._modelComponent.recreateModel()):console.warn("Use this component on a node（".concat(this.node&&this.node.name,"） that has a model component"))}},{key:"onDestroy",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._modelComponent.recreateModel())}},{key:"updateAssembler",value:function(e){return!!this._modelComponent&&(e.commitModel.call(e,this,this._modelComponent._getModel(),this._modelComponent.material),!0)}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterial(t);if(null!=i){for(var n=i.passes,r=i.effectAsset,a=i.technique,s=n.length,o=!1,l=0;l<s;l++){if(!n[l].blendState.targets[0].blend)o=!0,n[l].blendState.targets[0].blend=!0,n[l].overridePipelineStates(r.techniques[a].passes[l],{blendState:n[l].blendState})}o&&i._onPassesChange()}}for(var c=0;c<e;c++){var u=this._modelComponent.getMaterial(c);if(null!=u){var h=u.passes,_=Array.isArray(h),f=0;for(h=_?h:h[Symbol.iterator]();;){var d;if(_){if(f>=h.length)break;d=h[f++]}else{if((f=h.next()).done)break;d=f.value}d._priority=Yp.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),a}())||ZL)||ZL)||ZL;cc.UIModelComponent=iI;var nI,rI,aI=new Nn;(rI=nI||(nI={}))[rI.LOADING=0]="LOADING",rI[rI.LOADED=1]="LOADED",rI[rI.ERROR=2]="ERROR";var sI={devicePixelRatio:!(rI[rI.JS_EVALUATED=3]="JS_EVALUATED"),enableDiv:!1};Mr.os===Mr.OS_IOS&&(sI.enableDiv=!0),Mr.isMobile?Mr.browserType===Mr.BROWSER_TYPE_FIREFOX&&(sI.enableBG=!0):Mr.browserType===Mr.BROWSER_TYPE_IE&&(sI.closeHistory=!0);var oI,lI,cI,uI,hI,_I,fI,dI,pI,mI,vI=Ca("cc.WebviewImpl")((tI=eI=function(){function n(){y(this,n),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return l(n,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(St(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(e){var t=this._iframe;if(t){t.src=e;var i=this;t.addEventListener("load",function e(){i._updateVisibility(),t.removeEventListener("load",e)}),this._dispatchEvent(n.EventType.LOADING)}}},{key:"stopLoading",value:function(){cc.logID(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return cc.logID(7801),!0}},{key:"canGoForward",value:function(){return cc.logID(7802),!0}},{key:"goBack",value:function(){try{if(n.Polyfill.closeHistory)return cc.logID(7803);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.back.call(t)}}catch(e){cc.log(e)}}},{key:"goForward",value:function(){try{if(n.Polyfill.closeHistory)return cc.logID(7804);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.forward.call(t)}}catch(e){cc.log(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){cc.logID(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(aI);var t=e.getContentSize();if(this._forceUpdate||this._m00!==aI.m00||this._m01!==aI.m01||this._m04!==aI.m04||this._m05!==aI.m05||this._m12!==aI.m12||this._m13!==aI.m13||this._w!==t.width||this._h!==t.height){this._m00=aI.m00,this._m01=aI.m01,this._m04=aI.m04,this._m05=aI.m05,this._m12=aI.m12,this._m13=aI.m13,this._w=t.width,this._h=t.height;var i=cc.view._scaleX,n=cc.view._scaleY,r=cc.view._devicePixelRatio;i/=r,n/=r;var a=cc.game.container,s=aI.m00*i,o=aI.m01,l=aI.m04,c=aI.m05*n,u=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var _=this._div.clientWidth*i,f=this._div.clientHeight*n,d=e.getAnchorPoint(),p=_*aI.m00*d.x,m=f*aI.m05*d.y,v="matrix("+s+","+-o+","+-l+","+c+","+(aI.m12*i-p+u)+","+-(aI.m13*n-m+h)+")";this._div.style.transform=v,this._div.style["-webkit-transform"]=v,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var y=e.getComponent(_x);y&&this._setOpacity(y.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var e=this._iframe;if(e){var t=this._eventListeners,i=this;t.load=function(){i._dispatchEvent(n.EventType.LOADED)},t.error=function(){i._dispatchEvent(n.EventType.ERROR)},e.addEventListener("load",t.load),e.addEventListener("error",t.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(e,t){n.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),n.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=t+"px",this._div.style.width=e+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),n}(),eI.Polyfill=sI,eI.EventType=nI,$L=tI))||$L,yI=nI;function gI(){}var bI,SI=(oI=Ca("cc.WebviewComponent"),lI=Ia("UI/WebView"),cI=Fa(100),uI=ka({type:OS}),oI(hI=lI(hI=cI((mI=pI=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"webviewEvents",fI,_(e)),m(e,"_url",dI,_(e)),e._impl=null,e._impl=new vI,e}return d(t,LT),l(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),l(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new vI)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(yI.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(yI.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(yI.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(yI.LOADED,gI),e.setEventListener(yI.LOADING,gI),e.setEventListener(yI.ERROR,gI)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){OS.emitEvents(this.webviewEvents,this,yI.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return OS.emitEvents(this.webviewEvents,this,yI.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){OS.emitEvents(this.webviewEvents,this,yI.ERROR),this.node.emit("error",this)}}]),t}(),pI.EventType=yI,c((_I=mI).prototype,"url",[ka],Object.getOwnPropertyDescriptor(_I.prototype,"url"),_I.prototype),fI=c(_I.prototype,"webviewEvents",[uI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dI=c(_I.prototype,"_url",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hI=_I))||hI)||hI)||hI);cc.WebviewComponent=SI;var TI,xI,EI,wI,AI,CI,kI,RI,OI,MI,LI,II,FI,PI,DI=Ca("cc.UIReorderComponent")(bI=Ia("UI/Reorder")(bI=Fa(110)(bI=Pa(bI=Ma(bI=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,LT),t}())||bI)||bI)||bI)||bI)||bI;cc.UIReorderComponent=DI;var zI,BI,NI=new or;(BI=zI||(zI={}))[BI.HORIZONTAL=0]="HORIZONTAL",BI[BI.VERTICAL=1]="VERTICAL",Rt(zI);var UI,GI,VI,HI,jI,WI,XI,qI,YI,KI,QI,ZI,JI,$I,eF,tF,iF,nF,rF,aF,sF,oF,lF,cF,uF,hF,_F,fF,dF,pF,mF,vF=(TI=Ca("cc.PageViewIndicatorComponent"),xI=Fa(110),EI=Ia("UI/PageViewIndicator"),wI=ka({type:bh}),AI=ka({type:zI}),CI=ka({type:Kn}),TI(kI=xI(kI=EI((PI=FI=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"spacing",OI,_(t)),m(t,"_spriteFrame",MI,_(t)),m(t,"_direction",LI,_(t)),m(t,"_cellSize",II,_(t)),t._layout=null,t._pageView=null,t._indicators=[],t}return d(a,R_),l(a,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(YR),this._layout||(this._layout=this.addComponent(YR));var e=this._layout;this.direction===zI.HORIZONTAL?(e.type=YR.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===zI.VERTICAL&&(e.type=YR.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=YR.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new xf;return e.addComponent(ZA).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiComp){var r=n._uiComp;NI.set(r.color),NI.a=127.5,r.color=NI}}if(e[t]._uiComp){var a=e[t]._uiComp;NI.set(a.color),NI.a=255,a.color=NI}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;0<i;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),a}(),FI.Direction=zI,c((RI=PI).prototype,"spriteFrame",[wI],Object.getOwnPropertyDescriptor(RI.prototype,"spriteFrame"),RI.prototype),c(RI.prototype,"direction",[AI],Object.getOwnPropertyDescriptor(RI.prototype,"direction"),RI.prototype),c(RI.prototype,"cellSize",[CI],Object.getOwnPropertyDescriptor(RI.prototype,"cellSize"),RI.prototype),OI=c(RI.prototype,"spacing",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MI=c(RI.prototype,"_spriteFrame",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LI=c(RI.prototype,"_direction",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zI.HORIZONTAL}}),II=c(RI.prototype,"_cellSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(20,20)}}),kI=RI))||kI)||kI)||kI);cc.PageViewIndicatorComponent=vF;var yF,gF,bF,SF,TF,xF,EF=new Ui;(gF=yF||(yF={}))[gF.Unified=0]="Unified",gF[gF.Free=1]="Free",Rt(yF),(SF=bF||(bF={}))[SF.Horizontal=0]="Horizontal",SF[SF.Vertical=1]="Vertical",Rt(bF),(xF=TF||(TF={}))[xF.PAGE_TURNING=0]="PAGE_TURNING",Rt(TF);var wF=(UI=Ca("cc.PageViewComponent"),GI=Fa(110),VI=Ia("UI/PageView"),HI=ka({type:yF}),jI=ka({type:bF}),WI=ka({slide:!0,range:[0,1,.01]}),XI=ka({slide:!0,range:[0,1,.01]}),qI=ka({type:vF}),YI=ka({type:MM,visible:!1,override:!0}),KI=ka({type:MM,visible:!1,override:!0}),QI=ka({visible:!1,override:!0}),ZI=ka({visible:!1,override:!0}),JI=ka({visible:!1,override:!0}),$I=ka({visible:!1,override:!0}),eF=ka({type:OS}),UI(tF=GI(tF=VI((mF=pF=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"autoPageTurningThreshold",nF,_(t)),m(t,"horizontal",rF,_(t)),m(t,"vertical",aF,_(t)),m(t,"cancelInnerEvents",sF,_(t)),m(t,"scrollEvents",oF,_(t)),m(t,"pageTurningSpeed",lF,_(t)),m(t,"pageEvents",cF,_(t)),m(t,"_sizeMode",uF,_(t)),m(t,"_direction",hF,_(t)),m(t,"_scrollThreshold",_F,_(t)),m(t,"_pageTurningEventTiming",fF,_(t)),m(t,"_indicator",dF,_(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Xi,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Xi,t._touchEndPosition=new Xi,t}return d(a,wL),l(a,[{key:"__preload",value:function(){this.node.on(Zt.SystemEventType.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){p(S(a.prototype),"onEnable",this).call(this),this.node.on("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){p(S(a.prototype),"onDisable",this).call(this),this.node.off("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(Zt.SystemEventType.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(this._pages.length<=t?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):cc.warnID(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;e<0||e>=this._pages.length||(t=void 0!==t?t:.3,this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(YR);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===bF.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===yF.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,n=e.length;i<n;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation(EF),Xi.set(this._touchBeganPosition,EF.x,EF.y,0),p(S(a.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){p(S(a.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation(EF),Xi.set(this._touchEndPosition,EF.x,EF.y,0),p(S(a.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation(EF),Xi.set(this._touchEndPosition,EF.x,EF.y,0),p(S(a.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===bF.Horizontal,this.vertical=this.direction===bF.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(YR);if(t){if(this._sizeMode===yF.Free&&0<this._pages.length){var i=this._pages[this._pages.length-1];this.direction===bF.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===bF.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];0<=this._pages.indexOf(i)||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,OS.emitEvents(this.pageEvents,this,TF.PAGE_TURNING),this.node.emit("page-turning",this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===bF.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===bF.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new Xi;if(this._sizeMode===yF.Free)this.direction===bF.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===bF.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===bF.Horizontal?t.x=e*i.width:this.direction===bF.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===bF.Horizontal?0===e.x?0:0<e.x?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===yF.Free){var n=0,r=0;if(this.direction===bF.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===bF.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===bF.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===bF.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new Xi;if(Xi.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=0<i?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var n=this._curPageIdx,r=n+this._getDragDirection(t),a=this.pageTurningSpeed*Math.abs(n-r);if(r<this._pages.length){if(this._isScrollable(t,n,r))return void this.scrollToPage(r,a);var s=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(s))return void this.scrollToPage(r,a)}this.scrollToPage(n,a)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar}}]),a}(),pF.SizeMode=yF,pF.Direction=bF,pF.EventType=TF,c((iF=mF).prototype,"sizeMode",[HI],Object.getOwnPropertyDescriptor(iF.prototype,"sizeMode"),iF.prototype),c(iF.prototype,"direction",[jI],Object.getOwnPropertyDescriptor(iF.prototype,"direction"),iF.prototype),c(iF.prototype,"scrollThreshold",[WI],Object.getOwnPropertyDescriptor(iF.prototype,"scrollThreshold"),iF.prototype),c(iF.prototype,"pageTurningEventTiming",[XI],Object.getOwnPropertyDescriptor(iF.prototype,"pageTurningEventTiming"),iF.prototype),c(iF.prototype,"indicator",[qI],Object.getOwnPropertyDescriptor(iF.prototype,"indicator"),iF.prototype),nF=c(iF.prototype,"autoPageTurningThreshold",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),c(iF.prototype,"verticalScrollBar",[YI],Object.getOwnPropertyDescriptor(iF.prototype,"verticalScrollBar"),iF.prototype),c(iF.prototype,"horizontalScrollBar",[KI],Object.getOwnPropertyDescriptor(iF.prototype,"horizontalScrollBar"),iF.prototype),rF=c(iF.prototype,"horizontal",[QI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),aF=c(iF.prototype,"vertical",[ZI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sF=c(iF.prototype,"cancelInnerEvents",[JI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oF=c(iF.prototype,"scrollEvents",[$I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lF=c(iF.prototype,"pageTurningSpeed",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),cF=c(iF.prototype,"pageEvents",[eF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uF=c(iF.prototype,"_sizeMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yF.Unified}}),hF=c(iF.prototype,"_direction",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bF.Horizontal}}),_F=c(iF.prototype,"_scrollThreshold",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),fF=c(iF.prototype,"_pageTurningEventTiming",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),dF=c(iF.prototype,"_indicator",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tF=iF))||tF)||tF)||tF);cc.PageViewComponent=wF;var AF,CF,kF,RF,OF=0,MF={},LF=function(e){if(void 0===MF[e]){var t=1<<OF;MF[e]=t,OF+=1}};(CF=AF||(AF={}))[CF.OPAQUE=0]="OPAQUE",CF[CF.TRANSPARENT=1]="TRANSPARENT",CF[CF.OVERLAY=2]="OVERLAY",(RF=kF||(kF={}))[RF.DEFAULT=1]="DEFAULT",RF[RF.FORWARD=2]="FORWARD",RF[RF.SHADOWCAST=4]="SHADOWCAST";var IF,FF,PF,DF,zF,BF,NF,UF,GF,VF,HF,jF,WF,XF,qF,YF,KF,QF,ZF,JF,$F,eP,tP,iP,nP,rP,aP,sP=function(){function n(e,t){y(this,n),this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=t,this.data=new Uint16Array(e*t);for(var i=0;i<e*t;++i)this.data[i]=0}return l(n,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=wi(e,0,this.w-1),t=wi(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e/this.w,n=t/this.h,r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;r=wi(r,0,this.w-1),a=wi(a,0,this.h-1),s=wi(s,0,this.w-1),o=wi(o,0,this.h-1);var u=this.get(r,a),h=this.get(s,a),_=this.get(r,o),f=this.get(s,o),d=.5*(h+_);return l+c<=1?f=d-u+d:u=d-f+d,(u*(1-l)+h*l)*(1-c)+(_*(1-l)+f*l)*c}}]),n}(),oP=Ca("cc.TerrainInfo")((PF=c((FF=function(){function e(){y(this,e),m(this,"tileSize",PF,this),m(this,"blockCount",DF,this),m(this,"weightMapSize",zF,this),m(this,"lightMapSize",BF,this),this._tileCount=[0,0],this._vertexCount=[0,0],this._size=new Kn(0,0)}return l(e,[{key:"initialize",value:function(){this._tileCount[0]=32*this.blockCount[0],this._tileCount[1]=32*this.blockCount[1],this._vertexCount[0]=this._tileCount[0]+1,this._vertexCount[1]=this._tileCount[1]+1,this._size.width=this._tileCount[0]*this.tileSize,this._size.height=this._tileCount[1]*this.tileSize}},{key:"tileCount",get:function(){return this._tileCount}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"tileSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),DF=c(FF.prototype,"blockCount",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),zF=c(FF.prototype,"weightMapSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),BF=c(FF.prototype,"lightMapSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),IF=FF))||IF,lP=Ca("cc.TerrainLayer")((GF=c((UF=function e(){y(this,e),m(this,"detailMap",GF,this),m(this,"tileSize",VF,this)}).prototype,"detailMap",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VF=c(UF.prototype,"tileSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NF=UF))||NF,cP=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._model=null,t._meshData=null,t._brushMaterial=null,t._currentMaterial=null,t._currentMaterialLayers=0,t}return d(a,RS),l(a,[{key:"destroy",value:function(){this._invalidMaterial(),null!=this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null),p(S(a.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),(this._currentMaterial=null)!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new zb,this._currentMaterial.initialize({effectAsset:cc.EffectAsset.get("builtin-terrain"),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return cb.get("missing-material")}}]),a}(),uP=Ca("cc.TerrainBlockInfo")((WF=c((jF=function e(){y(this,e),m(this,"layers",WF,this)}).prototype,"layers",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),HF=jF))||HF,hP=function(){function n(e,t,i){y(this,n),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._terrain=e,this._info=e.getBlockInfo(t,i),this._index[0]=t,this._index[1]=i,this._node=new Rd(""),this._node.setParent(this._terrain.node),this._node._objFlags|=cc.Object.Flags.DontSave,this._renderable=this._node.addComponent(cP)}return l(n,[{key:"build",value:function(){for(var e=cc.director.root.device,t=new Float32Array(8712),i=0,n=0;n<33;++n)for(var r=0;r<33;++r){var a=32*this._index[0]+r,s=32*this._index[1]+n,o=this._terrain.getPosition(a,s),l=this._terrain.getNormal(a,s),c=new Ui(r/32,n/32);t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=l.x,t[i++]=l.y,t[i++]=l.z,t[i++]=c.x,t[i++]=c.y}var u=e.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:8*Float32Array.BYTES_PER_ELEMENT*33*33,stride:8*Float32Array.BYTES_PER_ELEMENT});u.update(t);var h=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_NORMAL,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RG32F}];this._renderable._meshData={attributes:h,vertexBuffers:[u],indexBuffer:this._terrain.getSharedIndexBuffer(),primitiveMode:Zt.GFXPrimitiveMode.TRIANGLE_LIST},this._renderable._model=this._renderable._getRenderScene().createModel(CS,this._node),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new $i(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var n=this._terrain.getLayer(this.layers[0]);null!=n&&(i.x=1/n.tileSize),e.setProperty("detailMap0",null!=n?n.detailMap:null)}else e.setProperty("detailMap0",cc.builtinResMgr.get("default-texture"));else if(1===t){var r=this._terrain.getLayer(this.layers[0]),a=this._terrain.getLayer(this.layers[1]);null!=r&&(i.x=1/r.tileSize),null!=a&&(i.y=1/a.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=r?r.detailMap:null),e.setProperty("detailMap1",null!=a?a.detailMap:null)}else if(2===t){var s=this._terrain.getLayer(this.layers[0]),o=this._terrain.getLayer(this.layers[1]),l=this._terrain.getLayer(this.layers[2]);null!=s&&(i.x=1/s.tileSize),null!=o&&(i.y=1/o.tileSize),null!=l&&(i.z=1/l.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=s?s.detailMap:null),e.setProperty("detailMap1",null!=o?o.detailMap:null),e.setProperty("detailMap2",null!=l?l.detailMap:null)}else if(3===t){var c=this._terrain.getLayer(this.layers[0]),u=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),_=this._terrain.getLayer(this.layers[3]);null!=c&&(i.x=1/c.tileSize),null!=u&&(i.y=1/u.tileSize),null!=h&&(i.z=1/h.tileSize),null!=_&&(i.z=1/_.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=c?c.detailMap:null),e.setProperty("detailMap1",null!=u?u.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=_?_.detailMap:null)}e.setProperty("UVScale",i)}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new er;return e.x=32*this._index[0],e.y=32*this._index[1],e.width=32,e.height=32,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return 0<=this.layers[3]?3:0<=this.layers[2]?2:0<=this.layers[1]?1:0}},{key:"_getMaterialDefines",value:function(e){return 0===e?{LAYERS:1}:1===e?{LAYERS:2}:2===e?{LAYERS:3}:3===e?{LAYERS:4}:{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(8712),t=0,i=0;i<33;++i)for(var n=0;n<33;++n){var r=32*this._index[0]+n,a=32*this._index[1]+i,s=this._terrain.getPosition(r,a),o=this._terrain.getNormal(r,a),l=new Ui(n/33,i/33);e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=l.x,e[t++]=l.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new fh,this._weightMap.create(this._terrain.info.weightMapSize,this._terrain.info.weightMapSize,ll.RGBA8888),this._weightMap.setFilters(_l.LINEAR,_l.LINEAR),this._weightMap.setWrapMode(ul.CLAMP_TO_EDGE,ul.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.info.weightMapSize*this._terrain.info.weightMapSize*4),t=0,i=0;i<this._terrain.info.weightMapSize;++i)for(var n=0;n<this._terrain.info.weightMapSize;++n){var r=this._index[0]*this._terrain.info.weightMapSize+n,a=this._index[1]*this._terrain.info.weightMapSize+i,s=this._terrain.getWeight(r,a);e[4*t+0]=Math.floor(255*s.x),e[4*t+1]=Math.floor(255*s.y),e[4*t+2]=Math.floor(255*s.z),e[4*t+3]=Math.floor(255*s.w),t+=1}this._weightMap.uploadData(e.buffer)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"layers",get:function(){return this._info.layers}}]),n}(),_P=(XF=Ca("cc.Terrain"),qF=Ia("Components/Terrain"),YF=ka({type:oP,visible:!0}),KF=ka({type:lP,visible:!0}),QF=ka({visible:!1}),ZF=ka({visible:!1}),JF=ka({visible:!1}),XF($F=qF($F=Ma((tP=c((eP=function(e){function i(){var e;y(this,i),m(e=T(this,S(i).call(this)),"_info",tP,_(e)),m(e,"_layers",iP,_(e)),m(e,"_heights",nP,_(e)),m(e,"_weights",rP,_(e)),m(e,"_blockInfos",aP,_(e)),e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var t=0;t<256;++t)e._layers.push(null);return e}return d(i,R_),l(i,[{key:"build",value:function(e){return this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildImp()}},{key:"rebuild",value:function(e){e.initialize();for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new uP);for(var n=Math.min(this.info.blockCount[0],e.blockCount[0]),r=Math.min(this.info.blockCount[1],e.blockCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._blockInfos[l]}this._blockInfos=t;var c=this._blocks,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}_.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildNormals();for(var f=0;f<this._info.blockCount[1];++f)for(var d=0;d<this._info.blockCount[0];++d)this._blocks.push(new hP(this,d,f));var p=this._blocks,m=Array.isArray(p),v=0;for(p=m?p:p[Symbol.iterator]();;){var y;if(m){if(v>=p.length)break;y=p[v++]}else{if((v=p.next()).done)break;y=v.value}y.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,n=0;n<this._info.vertexCount[1];++n)for(var r=0;r<this._info.vertexCount[0];++r){var a=r/this._info.tileCount[0],s=n/this._info.tileCount[1],o=e.getAt(a*e.w,s*e.h)*t;this._heights[i++]=o}this._buildNormals();var l=this._blocks,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}h._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,n=0;n<e.h;++n)for(var r=0;r<e.w;++r){var a=r/(e.w-1),s=n/(e.h-1),o=a*this._info.size.width,l=s*this._info.size.height,c=this.getHeightAt(o,l);null!=c&&(e.data[i++]=c*t)}}},{key:"onLoad",value:function(){for(var e=cc.director.root.device,t=new Uint16Array(6144),i=0,n=0;n<32;++n)for(var r=0;r<32;++r){var a=33*n+r,s=33*n+r+1,o=33*(n+1)+r,l=33*(n+1)+r+1;t[i++]=a,t[i++]=o,t[i++]=s,t[i++]=s,t[i++]=o,t[i++]=l}this._sharedIndexBuffer=e.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:32*Uint16Array.BYTES_PER_ELEMENT*32*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){var e=this._blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp()}},{key:"update",value:function(e){var t=this._blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._info.tileSize,n=t*this._info.tileSize,r=this.getHeight(e,t);return new Xi(i,r,n)}},{key:"setHeight",value:function(e,t,i){this._heights[t*this._info.vertexCount[0]+e]=i}},{key:"getHeight",value:function(e,t){return this._heights[t*this._info.vertexCount[0]+e]}},{key:"getHeightClamp",value:function(e,t){return e=wi(e,0,this._info.vertexCount[0]-1),t=wi(t,0,this._info.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=wi(r,0,this._info.vertexCount[0]-1),a=wi(a,0,this._info.vertexCount[1]-1),s=wi(s,0,this._info.vertexCount[0]-1),o=wi(o,0,this._info.vertexCount[1]-1);var u=this.getHeight(r,a),h=this.getHeight(s,a),_=this.getHeight(r,o),f=this.getHeight(s,o),d=.5*(h+_);return l+c<=1?f=d-u+d:u=d-f+d,(u*(1-l)+h*l)*(1-c)+(_*(1-l)+f*l)*c}},{key:"_setNormal",value:function(e,t,i){var n=t*this._info.vertexCount[0]+e;this._normals[3*n+0]=i.x,this._normals[3*n+1]=i.y,this._normals[3*n+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this._info.vertexCount[0]+e,n=new Xi;return n.x=this._normals[3*i+0],n.y=this._normals[3*i+1],n.z=this._normals[3*i+2],n}},{key:"getNormalAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=wi(r,0,this._info.vertexCount[0]-1),a=wi(a,0,this._info.vertexCount[1]-1),s=wi(s,0,this._info.vertexCount[0]-1),o=wi(o,0,this._info.vertexCount[1]-1);var u=this.getNormal(r,a),h=this.getNormal(s,a),_=this.getNormal(r,o),f=this.getNormal(s,o),d=new Xi;Xi.add(d,h,_).multiplyScalar(.5),l+c<=1?(f.set(d),f.subtract(u),f.add(d)):(u.set(d),u.subtract(f),u.add(d));var p=new Xi,m=new Xi,v=new Xi;return Xi.lerp(p,u,h,l),Xi.lerp(m,_,f,l),Xi.lerp(v,p,m,c),v}},{key:"setWeight",value:function(e,t,i){var n=t*this.info.weightMapSize*this.info.blockCount[0]+e;this._weights[4*n+0]=255*i.x,this._weights[4*n+1]=255*i.y,this._weights[4*n+2]=255*i.z,this._weights[4*n+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this.info.weightMapSize*this.info.blockCount[0]+e,n=new $i;return n.x=this._weights[4*i+0]/255,n.y=this._weights[4*i+1]/255,n.z=this._weights[4*i+2]/255,n.w=this._weights[4*i+3]/255,n}},{key:"getWeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=wi(r,0,this._info.vertexCount[0]-1),a=wi(a,0,this._info.vertexCount[1]-1),s=wi(s,0,this._info.vertexCount[0]-1),o=wi(o,0,this._info.vertexCount[1]-1);var u=this.getWeight(r,a),h=this.getWeight(s,a),_=this.getWeight(r,o),f=this.getWeight(s,o),d=new $i;$i.add(d,h,_).multiplyScalar(.5),l+c<=1?(f=new $i,$i.subtract(f,d,u).add(d)):(u=new $i,$i.subtract(u,d,f).add(d));var p=new $i,m=new $i,v=new $i;return $i.lerp(p,u,h,l),$i.lerp(m,_,f,l),$i.lerp(v,p,m,c),v}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._info.blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._info.blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"rayCheck",value:function(e,t,i){var n=0,r=e,a=null,s=new Xi;if(s.set(t),s.multiplyScalar(i),t.equals(new Xi(0,1,0))){var o=this.getHeightAt(r.x,r.z);null!=o&&r.y<=o&&(a=new Xi(r.x,o,r.z))}else if(t.equals(new Xi(0,-1,0))){var l=this.getHeightAt(r.x,r.z);null!=l&&r.y>=l&&(a=new Xi(r.x,l,r.z))}else for(;n++<2e3;){var c=this.getHeightAt(r.x,r.z);if(null!=c&&r.y<=c){a=new Xi(r.x,c,r.z);break}r.add(s)}return a}},{key:"_calcuNormal",value:function(e,t){var i,n,r=1,a=this.getPosition(e,t);i=e<this._info.vertexCount[0]-1?this.getPosition(e+1,t):(r*=-1,this.getPosition(e-1,t)),n=t<this._info.vertexCount[1]-1?this.getPosition(e,t+1):(r*=-1,this.getPosition(e,t-1)),i.subtract(a),n.subtract(a);var s=new Xi;return s.set(n),s.cross(i),s.multiplyScalar(r),s.normalize(),s}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this._info.vertexCount[1];++t)for(var i=0;i<this._info.vertexCount[0];++i){var n=this._calcuNormal(i,t);this._normals[3*e+0]=n.x,this._normals[3*e+1]=n.y,this._normals[3*e+2]=n.z,e+=1}}},{key:"_buildImp",value:function(){if(0<this._blocks.length)return!0;if(this._info.initialize(),0===this._info.blockCount[0]||0===this._info.blockCount[1])return!1;var e=this._info.vertexCount[0]*this._info.vertexCount[1];if(this._heights.length!==e){this._heights=new Array(e),this._normals=new Array(3*e);for(var t=0;t<e;++t)this._heights[t]=0,this._normals[3*t+0]=0,this._normals[3*t+1]=1,this._normals[3*t+2]=0}else this._normals=new Array(3*e),this._buildNormals();var i=this.info.weightMapSize*this.info.blockCount[0],n=this.info.weightMapSize*this.info.blockCount[1];if(this._weights.length!==i*n*4){this._weights=new Uint8Array(i*n*4);for(var r=0;r<i*n;++r)this._weights[4*r+0]=255,this._weights[4*r+1]=0,this._weights[4*r+2]=0,this._weights[4*r+3]=0}if(this._blockInfos.length!==this.info.blockCount[0]*this.info.blockCount[1]){this._blockInfos=[];for(var a=0;a<this.info.blockCount[1];++a)for(var s=0;s<this.info.blockCount[0];++s)this._blockInfos.push(new uP)}for(var o=0;o<this.info.blockCount[1];++o)for(var l=0;l<this.info.blockCount[0];++l)this._blocks.push(new hP(this,l,o));var c=this._blocks,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}_.build()}}},{key:"_rebuildHeights",value:function(e){if(this.info.vertexCount[0]===e.vertexCount[0]&&this.info.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=0;for(var n=Math.min(this.info.vertexCount[0],e.vertexCount[0]),r=Math.min(this.info.vertexCount[1],e.vertexCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._heights[l]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var g=this,t=this.info.weightMapSize,a=this.info.weightMapSize*this.info.blockCount[0],i=this.info.weightMapSize*this.info.blockCount[1],n=e.weightMapSize*e.blockCount[0],r=e.weightMapSize*e.blockCount[1];if(n==a&&r==i)return!1;for(var s=new Uint8Array(n*r*4),o=0;o<n*r;++o)s[4*o+0]=255,s[4*o+1]=0,s[4*o+2]=0,s[4*o+3]=0;for(var l=Math.min(e.blockCount[0],this.info.blockCount[0]),c=Math.min(e.blockCount[1],this.info.blockCount[1]),b=function(e,t,i){var n=t*a+e,r=new $i;return r.x=i[4*n+0]/255,r.y=i[4*n+1]/255,r.z=i[4*n+2]/255,r.w=i[4*n+3]/255,r},u=function(e,t,i,n,r){var a=Math.floor(e),s=Math.floor(t),o=a+1,l=s+1,c=e-a,u=t-s,h=b(a+i,s+n,g._weights),_=b(o+i,s+n,g._weights),f=b(a+i,l+n,g._weights),d=b(o+i,l+n,g._weights),p=new $i;$i.add(p,_,f).multiplyScalar(.5),c+u<=1?(d.set(p),d.subtract(h),d.add(p)):(h.set(p),h.subtract(d),h.add(p));var m=new $i,v=new $i,y=new $i;return $i.lerp(m,h,_,c),$i.lerp(v,f,d,c),$i.lerp(y,m,v,u),y},h=0;h<c;++h)for(var _=0;_<l;++_)for(var f=_*t,d=h*t,p=0;p<this.info.weightMapSize;++p)for(var m=0;m<this.info.weightMapSize;++m){var v=void 0;if(e.weightMapSize==t)v=b(m+f,p+d,this._weights);else v=u(m/(this.info.weightMapSize-1)*(t-1),p/(this.info.weightMapSize-1)*(t-1),f,d,this._weights);var y=_*this.info.weightMapSize+m,S=(h*this.info.weightMapSize+p)*n+y;s[4*S+0]=255*v.x,s[4*S+1]=255*v.y,s[4*S+2]=255*v.z,s[4*S+3]=255*v.w}return this._weights=s,!0}},{key:"info",get:function(){return this._info}}]),i}()).prototype,"_info",[YF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oP}}),iP=c(eP.prototype,"_layers",[KF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nP=c(eP.prototype,"_heights",[QF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rP=c(eP.prototype,"_weights",[ZF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Uint8Array}}),aP=c(eP.prototype,"_blockInfos",[JF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$F=eP))||$F)||$F)||$F),fP=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,e,t)))._capacity=void 0,i._vertAttrs=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._mesh=void 0,i._vertCount=0,i._indexCount=0,i._type="particle-batch",i._capacity=0,i._vertAttrs=null,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:qs.INDIRECT,memUsage:Ks.HOST|Ks.DEVICE,size:56,stride:1}),i._subMeshData=null,i._mesh=null,i}return d(n,CS),l(n,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.offset=this._vertSize,this._vertSize+=rl[s.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex(function(e){return e.name===Zt.GFXAttributeName.ATTR_TEX_COORD3}),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,Zt.GFXAttributeName.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Zt.GFXAttributeName.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===Zt.GFXAttributeName.ATTR_TEX_COORD})].offset,this._mesh.copyAttribute(0,Zt.GFXAttributeName.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Zt.GFXAttributeName.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=cc.Color.WHITE._val;for(var s=new Float32Array(t),o=1;o<this._capacity;o++)s.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var c=1;c<this._capacity;c++)for(var u=0;u<this._indexCount;u++)l[c*this._indexCount+u]=l[u]+c*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var f=4*_;l[h++]=f,l[h++]=1+f,l[h++]=2+f,l[h++]=3+f,l[h++]=2+f,l[h++]=1+f}var d=this._device.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return d.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:d,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Zt.GFXPrimitiveMode.TRIANGLE_LIST},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),p(S(n.prototype),"setSubModelMaterial",this).call(this,e,t)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].z,this._vdataF32[r++]=t[3].z,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){p(S(n.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),dP=LF;cc.samplerLib=Yl;var pP=Object.freeze({addStage:dP,samplerLib:Yl,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F}),t.normals&&a.push({name:Zt.GFXAttributeName.ATTR_NORMAL,format:Zt.GFXFormat.RGB32F}),t.uvs&&a.push({name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RG32F}),t.colors&&a.push({name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGB32F});var s=e.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:4*i.length,stride:4*i.length/n});s.update(new Float32Array(i));var o=e.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[s],indexBuffer:o})},get RenderQueue(){return AF},get PassStage(){return kF},Pass:vb,programLib:xm,Light:Px,Camera:IE,Model:CS,ParticleBatchModel:fP,SkinningModel:UE,TextureBufferPool:jg,HeightField:sP,TERRAIN_MAX_LEVELS:4,TERRAIN_MAX_BLEND_LAYERS:4,TERRAIN_MAX_LAYER_COUNT:256,TERRAIN_BLOCK_TILE_COMPLEXITY:32,TERRAIN_BLOCK_VERTEX_COMPLEXITY:33,TERRAIN_BLOCK_VERTEX_SIZE:8,TERRAIN_NORTH_INDEX:0,TERRAIN_SOUTH_INDEX:1,TERRAIN_WEST_INDEX:2,TERRAIN_EAST_INDEX:3,TerrainInfo:oP,TerrainLayer:lP,TerrainVertex:function e(){y(this,e),this.position=new Xi(0,0,0),this.normal=new Xi(0,1,0),this.uv=new Ui(0,0)},TerrainRenderable:cP,TerrainBlockInfo:uP,TerrainBlock:hP,Terrain:_P,get JointsMediumType(){return Vg},selectJointsMediumType:Xg,JointsTexturePool:sb}),mP=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RG32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA32F}],vP=Object.freeze({vfmt:mP}),yP=function e(t,i,n){y(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=n};function gP(e,t,i,n,r){var a=0,s=null;if(r===0<function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}(e,t,i,n))for(a=t;a<i;a+=n)s=DP(a,e[a],e[a+1],s);else for(a=i-n;t<=a;a-=n)s=DP(a,e[a],e[a+1],s);return s&&LP(s,s.next)&&(zP(s),s=s.next),s}function bP(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var i=e,n=!1;do{if(n=!1,i.steiner||!LP(i,i.next)&&0!==MP(i.prev,i,i.next))i=i.next;else{if(zP(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function SP(e,t,i,n,r,a){var s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;if(e){!s&&a&&function(e,t,i,n){var r=e;for(;null===r.z&&(r.z=kP(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next,r!==e;);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,s=0,o=0,l=0,c=1;do{for(i=e,a=e=null,s=0;i;){for(s++,n=i,t=o=0;t<c&&(o++,n=n.nextZ);t++);for(l=c;0<o||0<l&&n;)0===o?(n=(r=n).nextZ,l--):0!==l&&n?i.z<=n.z?(i=(r=i).nextZ,o--):(n=(r=n).nextZ,l--):(i=(r=i).nextZ,o--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,c*=2}while(1<s)}(r)}(e,n,r,a);for(var o=e,l=null,c=null;e.prev!==e.next;)if(l=e.prev,c=e.next,a?xP(e,n,r,a):TP(e))t.push(l.i/i),t.push(e.i/i),t.push(c.i/i),zP(e),e=c.next,o=c.next;else if((e=c)===o){s?1===s?SP(e=EP(e,t,i),t,i,n,r,a,2):2===s&&wP(e,t,i,n,r,a):SP(bP(e),t,i,n,r,a,1);break}}}function TP(e){var t=e.prev,i=e,n=e.next;if(0<=MP(t,i,n))return!1;for(var r=e.next.next;r!==e.prev;){if(OP(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=MP(r.prev,r,r.next))return!1;r=r.next}return!0}function xP(e,t,i,n){var r=e.prev,a=e,s=e.next;if(0<=MP(r,a,s))return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,c=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,u=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,h=kP(o,l,t,i,n),_=kP(c,u,t,i,n),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&OP(r.x,r.y,a.x,a.y,s.x,s.y,f.x,f.y)&&0<=MP(f.prev,f,f.next))return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&OP(r.x,r.y,a.x,a.y,s.x,s.y,f.x,f.y)&&0<=MP(f.prev,f,f.next))return!1;f=f.prevZ}return!0}function EP(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!LP(r,a)&&IP(r,n,n.next,a)&&FP(r,a)&&FP(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),zP(n),zP(n.next),n=e=a),n=n.next}while(n!==e);return n}function wP(e,t,i,n,r,a){var s,o,l=e;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&(o=c,(s=l).next.i!==o.i&&s.prev.i!==o.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&IP(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(s,o)&&FP(s,o)&&FP(o,s)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;for(;i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next,i!==e;);return n}(s,o))){var u=PP(l,c);return l=bP(l,l.next),u=bP(u,u.next),SP(l,t,i,n,r,a),void SP(u,t,i,n,r,a)}c=c.next}l=l.next}while(l!==e)}function AP(e,t){return e.x-t.x}function CP(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,s=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&a<o){if((a=o)===n){if(r===i.y)return i;if(r===i.next.y)return i.next}s=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!s)return null;if(n===a)return s.prev;var l,c=s,u=s.x,h=s.y,_=1/0;i=s.next;for(;i!==c;)n>=i.x&&i.x>=u&&OP(r<h?n:a,r,u,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<_||l===_&&i.x>s.x)&&FP(i,e)&&(s=i,_=l),i=i.next;return s}(e,t)){var i=PP(t,e);bP(i,i.next)}}function kP(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function RP(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}function OP(e,t,i,n,r,a,s,o){return 0<=(r-s)*(t-o)-(e-s)*(a-o)&&0<=(e-s)*(n-o)-(i-s)*(t-o)&&0<=(i-s)*(a-o)-(r-s)*(n-o)}function MP(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function LP(e,t){return e.x===t.x&&e.y===t.y}function IP(e,t,i,n){return!!(LP(e,t)&&LP(i,n)||LP(e,n)&&LP(i,t))||0<MP(e,t,i)!=0<MP(e,t,n)&&0<MP(i,n,e)!=0<MP(i,n,t)}function FP(e,t){return MP(e.prev,e,e.next)<0?0<=MP(e,t,e.next)&&0<=MP(e,e.prev,t):MP(e,t,e.prev)<0||MP(e,e.next,t)<0}function PP(e,t){var i=new yP(e.i,e.x,e.y),n=new yP(t.i,t.x,t.y),r=e.next,a=t.prev;return(e.next=t).prev=e,(i.next=r).prev=i,(n.next=i).prev=n,(a.next=n).prev=a,n}function DP(e,t,i,n){var r=new yP(e,t,i);return n?(r.next=n.next,(r.prev=n).next.prev=r,n.next=r):(r.prev=r).next=r,r}function zP(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function BP(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=gP(e,0,r,i,!0),s=[];if(!a)return s;var o=0,l=0,c=0,u=0,h=0,_=0,f=0;if(n&&(a=function(e,t,i,n){var r,a=[],s=0,o=null;for(s=0,r=t.length;s<r;s++)(o=gP(e,t[s]*n,s<r-1?t[s+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),a.push(RP(o)));if(a.sort(AP),!i)return i;for(s=0;s<a.length;s++)CP(a[s],i),i=bP(i,i.next);return i}(e,t,a,i)),e.length>80*i){o=c=e[0],l=u=e[1];for(var d=i;d<r;d+=i)(h=e[d])<o&&(o=h),(_=e[d+1])<l&&(l=_),c<h&&(c=h),u<_&&(u=_);f=Math.max(c-o,u-l)}return SP(a,s,i,o,l,f),s}var NP=Math.PI,UP=Math.min,GP=Math.max,VP=Math.cos,HP=Math.sin,jP=Math.abs,WP=Math.sign,XP=.5522847493;function qP(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*XP,t-n*XP,i+r,t,i+r),e.bezierCurveTo(t+n*XP,i+r,t+n,i+r*XP,t+n,i),e.bezierCurveTo(t+n,i-r*XP,t+n*XP,i-r,t,i-r),e.bezierCurveTo(t-n*XP,i-r,t-n,i-r*XP,t-n,i),e.close()}for(var YP=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,e,t))).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return d(n,Ui),l(n,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),n}(),KP=function(){function e(){y(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return l(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),QP=function(){function e(){y(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=or.WHITE.clone(),this.lineCap=ER.BUTT,this.strokeColor=or.BLACK.clone(),this.lineJoin=AR.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new Qp(function(){return new $p},16),this._renderDatas=[],this._curPath=null}return l(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,kR.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,kR.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var s=this._curPath,o=s.points[s.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==a?(function e(t,i,n,r,a,s,o,l,c,u,h){var _,f,d,p,m,v,y,g,b,S,T,x,E,w,A,C;10<u||(m=.5*(s+l),v=.5*(o+c),y=.5*((_=.5*(i+r))+(d=.5*(r+s))),g=.5*((f=.5*(n+a))+(p=.5*(a+o))),((A=jP((r-l)*(w=c-n)-(a-c)*(E=l-i)))+(C=jP((s-l)*w-(o-c)*E)))*(A+C)<t.tessTol*(E*E+w*w)?t.addPoint(l,c,0===h?h|kR.PT_BEVEL:h):(e(t,i,n,_,f,y,g,T=.5*(y+(b=.5*(d+m))),x=.5*(g+(S=.5*(p+v))),u+1,0),e(t,T,x,b,S,m,v,l,c,u+1,h)))}(this,o.x,o.y,e,t,i,n,r,a,0,kR.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,s){var o,l,c=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,y=0,g=0,b=0,S=0,T=0;if(u=a-r,s=s||!1)if(jP(u)>=2*NP)u=2*NP;else for(;u<0;)u+=2*NP;else if(jP(u)>=2*NP)u=2*-NP;else for(;0<u;)u-=2*NP;for(l=0|GP(1,UP(jP(u)/(.5*NP)+.5,5)),h=jP(4/3*(1-VP(o=u/l/2))/HP(o)),s||(h=-h),T=0;T<=l;T++)d=t+(_=VP(c=r+u*(T/l)))*n,p=i+(f=HP(c))*n,m=-f*n*h,v=_*n*h,0===T?e.moveTo(d,p):e.bezierCurveTo(y+b,g+S,d-m,p-v,d,p),y=d,g=p,b=m,S=v}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){qP(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){qP(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var s=UP(a,.5*jP(n))*WP(n),o=UP(a,.5*jP(r))*WP(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-XP),t+s*(1-XP),i+r,t+s,i+r),e.lineTo(t+n-s,i+r),e.bezierCurveTo(t+n-s*(1-XP),i+r,t+n,i+r-o*(1-XP),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-XP),t+n-s*(1-XP),i,t+n-s,i),e.lineTo(t+s,i),e.bezierCurveTo(t+s*(1-XP),i,t,i+o*(1-XP),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDatas,i=0,n=t.length;i<n;i++){var r=t[i];r&&r.reset()}this._renderDatas.length=0,e&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,s=r[this.pointsOffset++];s?(s.x=e,s.y=t):(s=new YP(e,t),r.push(s)),s.flags=i,a.push(s)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new KP,this.paths.push(t)),this.pathLength++,this._curPath=t}}]),e}(),ZP=Math.PI,JP=Math.min,$P=Math.max,eD=Math.ceil,tD=Math.acos,iD=Math.cos,nD=Math.sin,rD=Math.atan2,aD=mP,sD=[],oD=[],lD=[],cD=[],uD=null,hD=null,_D=new or,fD=[],dD=0;dD<4;dD++)fD.push(new Xi);function pD(e,t,i){return e<t?t:i<e?i:e}var mD={useModel:!0,createImpl:function(e){return new QP},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!hD)return null;var i=hD.getRenderDatas(),n=i[hD.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(65535<a||131070<3*a)&&(++hD.dataOffset,hD.dataOffset<i.length?n=i[hD.dataOffset]:(n=hD.requestRenderData(),i[hD.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){or.copy(_D,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){or.copy(_D,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=cc.director.root.ui.renderScene;e.model&&(e.model.destroy(),t.destroyModel(e.model),e.model=null);var i=e.impl,n=Zt.GFXPrimitiveMode.TRIANGLE_LIST,r=i&&i.getRenderDatas();if(r){var a=0;sD.length=0,oD.length=0,lD.length=0,cD.length=0;var s=r,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c,h=u.byteCount>>2,_=u.vData;for(a=0;a<h;)sD.push(_[a++]),sD.push(_[a++]),sD.push(_[a++]),oD.push(_[a++]),oD.push(_[a++]),lD.push(_[a++]),lD.push(_[a++]),lD.push(_[a++]),lD.push(_[a++]);h=u.indiceCount;var f=u.iData;for(a=0;a<h;)cD.push(f[a++])}var d=ug({primitiveMode:n,positions:sD,uvs:oD,colors:lD,attributes:aD,indices:cD},void 0,{calculateBounds:!1});e.model=t.createModel(CS,e.node),e.model.initSubModel(0,d.getSubMesh(0),e.material),e.model.enabled=!0,e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(hD=e.impl){var a=function(e,t,i){var n=2*tD(e/(e+i));return $P(2,eD(t/n))}(t,ZP,hD.tessTol);this._calculateJoins(hD,t,n,r);for(var s=hD.paths,o=0,l=hD.pathOffset,c=hD.pathLength;l<c;l++){var u=s[l],h=u.points.length;n===AR.ROUND?o+=2*(h+u.nbevel*(a+2)+1):o+=2*(h+5*u.nbevel+1),u.closed||(i===ER.ROUND?o+=2*(2*a+2):o+=12)}var _=uD=this.getRenderData(e,o);if(_){for(var f=_.vData,d=_.iData,p=hD.pathOffset,m=hD.pathLength;p<m;p++){var v=s[p],y=v.points,g=y.length,b=_.vertexStart,S=void 0,T=void 0,x=0,E=0,w=v.closed;if(E=w?(S=y[g-1],T=y[0],x=0,g):(S=y[0],T=y[1],g-(x=1)),!w){var A=new YP(T.x,T.y);A.subtract(S),A.normalize();var C=A.x,k=A.y;i===ER.BUTT?this._buttCap(S,C,k,t,0):i===ER.SQUARE?this._buttCap(S,C,k,t,t):i===ER.ROUND&&this._roundCapStart(S,C,k,t,a)}for(var R=x;R<E;++R)n===AR.ROUND?this._roundJoin(S,T,t,t,a):0!=(T.flags&(kR.PT_BEVEL|kR.PT_INNERBEVEL))?this._bevelJoin(S,T,t,t):(this._vset(T.x+T.dmx*t,T.y+T.dmy*t),this._vset(T.x-T.dmx*t,T.y-T.dmy*t)),S=T,T=y[R+1];if(w){var O=9*b,M=f.slice(O,O+9);f.set(M,9*_.vertexStart),O+=9,_.vertexStart++,M=f.slice(O,O+9),f.set(M,9*_.vertexStart),_.vertexStart++}else{var L=new YP(T.x,T.y);L.subtract(S),L.normalize();var I=L.x,F=L.y;i===ER.BUTT?this._buttCap(T,I,F,t,0):i===ER.SQUARE?this._buttCap(T,I,F,t,t):i===ER.ROUND&&this._roundCapEnd(T,I,F,t,a)}for(var P=_.indiceStart,D=b+2,z=_.vertexStart;D<z;D++)d[P++]=D-2,d[P++]=D-1,d[P++]=D;if((_.indiceStart=P)!==_.indiceCount){var B=new Array(_.indiceCount-P);_.iData.set(B,P)}}hD=uD=null}}},_expandFill:function(e){if(hD=e.impl){for(var t=hD.paths,i=0,n=hD.pathOffset,r=hD.pathLength;n<r;n++){i+=t[n].points.length}var a=uD=this.getRenderData(e,i);if(a){for(var s=a,o=s.vData,l=s.iData,c=hD.pathOffset,u=hD.pathLength;c<u;c++){var h=t[c],_=h.points,f=_.length;if(0!==f){for(var d=a.vertexStart,p=0;p<f;++p)this._vset(_[p].x,_[p].y);var m=a.indiceStart;if(h.complex){for(var v=[],y=d,g=a.vertexStart;y<g;y++){var b=9*y;v.push(o[b++]),v.push(o[b++]),v.push(o[b++])}var S=BP(v,null,3);if(!S||0===S.length)continue;for(var T=0,x=S.length;T<x;T++)l[m++]=S[T]+d}else for(var E=d,w=d+2,A=s.vertexStart;w<A;w++)l[m++]=E,l[m++]=w-1,l[m++]=w;if((s.indiceStart=m)!==s.indiceCount){var C=new Array(s.indiceCount-m);s.iData.set(C,m)}}}hD=uD=null}}},_calculateJoins:function(e,t,i,n){var r=0;0<t&&(r=1/t);for(var a=e.paths,s=e.pathOffset,o=e.pathLength;s<o;s++)for(var l=a[s],c=l.points,u=c.length,h=c[u-1],_=c[0],f=l.nbevel=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,y=_.dy,g=-_.dx;if(_.dmx=.5*(m+y),_.dmy=.5*(v+g),1e-6<(d=_.dmx*_.dmx+_.dmy*_.dmy)){var b=1/d;600<b&&(b=600),_.dmx*=b,_.dmy*=b}0<_.dx*h.dy-h.dx*_.dy&&(_.flags|=kR.PT_LEFT),d*(p=$P(11,JP(h.len,_.len)*r))*p<1&&(_.flags|=kR.PT_INNERBEVEL),_.flags&kR.PT_CORNER&&(d*n*n<1||i===AR.BEVEL||i===AR.ROUND)&&(_.flags|=kR.PT_BEVEL),0!=(_.flags&(kR.PT_BEVEL|kR.PT_INNERBEVEL))&&l.nbevel++,h=_,_=c[f+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,s=a[a.length-1],o=a[0];s.equals(o)&&(r.closed=!0,a.pop(),s=a[a.length-1]);for(var l=0,c=a.length;l<c;l++){var u=new YP(o.x,o.y);u.subtract(s),s.len=u.length(),(u.x||u.y)&&u.normalize(),s.dx=u.x,s.dy=u.y,s=o,o=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,s=0,o=0,l=0,c=0;return 0!==e?(s=r+t.dy*n,o=a-t.dx*n,l=r+i.dy*n,c=a-i.dx*n):(s=l=r+i.dmx*n,o=c=a+i.dmy*n),[s,o,l,c]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,s=e.y-i*r,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,s=e.y,o=i,l=-t,c=0;c<r;c++){var u=c/(r-1)*ZP,h=iD(u)*n,_=nD(u)*n;this._vset(a-o*h-t*_,s-l*h-i*_),this._vset(a,s)}this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,s=e.y,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n);for(var c=0;c<r;c++){var u=c/(r-1)*ZP,h=iD(u)*n,_=nD(u)*n;this._vset(a,s),this._vset(a-o*h+t*_,s-l*h+i*_)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,s=-e.dx,o=t.dy,l=-t.dx,c=t.x,u=t.y;if(0!=(t.flags&kR.PT_LEFT)){var h=this._chooseBevel(t.flags&kR.PT_INNERBEVEL,e,t,i),_=h[0],f=h[1],d=h[2],p=h[3],m=rD(-s,-a),v=rD(-l,-o);m<v&&(v-=2*ZP),this._vset(_,f),this._vset(c-a*n,t.y-s*n);for(var y=pD(eD((m-v)/ZP)*r,2,r),g=0;g<y;g++){var b=m+g/(y-1)*(v-m),S=c+iD(b)*n,T=u+nD(b)*n;this._vset(c,u),this._vset(S,T)}this._vset(d,p),this._vset(c-o*n,u-l*n)}else{var x=this._chooseBevel(t.flags&kR.PT_INNERBEVEL,e,t,-n),E=x[0],w=x[1],A=x[2],C=x[3],k=rD(s,a),R=rD(l,o);R<k&&(R+=2*ZP),this._vset(c+a*n,u+s*n,0),this._vset(E,w,0);for(var O=pD(eD((R-k)/ZP)*r,2,r),M=0;M<O;M++){var L=k+M/(O-1)*(R-k),I=c+iD(L)*i,F=u+nD(L)*i;this._vset(I,F,0),this._vset(c,u,0)}this._vset(c+o*n,u+l*n),this._vset(A,C)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,s=0,o=0,l=0,c=0,u=0,h=0,_=e.dy,f=-e.dx,d=t.dy,p=-t.dx;if(t.flags&kR.PT_LEFT){var m=this._chooseBevel(t.flags&kR.PT_INNERBEVEL,e,t,i);l=m[0],c=m[1],u=m[2],h=m[3],this._vset(l,c,0),this._vset(t.x-_*n,t.y-f*n,0),this._vset(u,h,0),this._vset(t.x-d*n,t.y-p*n,0)}else{var v=this._chooseBevel(t.flags&kR.PT_INNERBEVEL,e,t,-n);r=v[0],a=v[1],s=v[2],o=v[3],this._vset(t.x+_*i,t.y+f*i,0),this._vset(r,a),this._vset(t.x+d*i,t.y+p*i,0),this._vset(s,o)}},_vset:function(e,t){if(uD){var i=uD,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,or.array(r,_D,n),i.vertexStart++}}},vD={getAssembler:function(e){return mD}};lO.Assembler=vD;var yD=function e(){y(this,e),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0},gD=function(){function t(e){y(this,t),this._letterDefinitions={}}return l(t,[{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),l(t,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new yD;cc.js.mixin(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n],a=this._letterDefinitions[n];cc.js.mixin(a,r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions.hasOwnProperty(e.charCodeAt(0))?this._letterDefinitions[e.charCodeAt(0)]:null}}]),t}();cc.FontAtlas=gD;var bD=function e(){y(this,e),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0},SD=new er,TD=null,xD=[],ED=[],wD=[],AD=[],CD=new Kn,kD=null,RD=null,OD=0,MD=0,LD=0,ID=0,FD=0,PD=1,DD=null,zD="",BD=0,ND=0,UD=new Kn,GD=0,VD=0,HD=0,jD=0,WD=0,XD=!1,qD=0,YD=0,KD=0,QD={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){mA(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,s){var o=e.renderData;if(o){var l=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var c=o.datas,u=t.width,h=t.height,_=i.width,f=i.height,d=0,p=0,m=0,v=0;n?(d=i.x/u,v=(i.x+f)/u,p=(i.y+_)/h,m=i.y/h,c[l].u=d,c[l].v=m,c[l+1].u=d,c[l+1].v=p,c[l+2].u=v,c[l+2].v=m,c[l+3].u=v,c[l+3].v=p):(d=i.x/u,v=(i.x+_)/u,p=(i.y+f)/h,m=i.y/h,c[l].u=d,c[l].v=p,c[l+1].u=v,c[l+1].v=p,c[l+2].u=d,c[l+2].v=m,c[l+3].u=v,c[l+3].v=m),c[l].x=r,c[l].y=a-f*s,c[l+1].x=r+_*s,c[l+1].y=a-f*s,c[l+2].x=r,c[l+2].y=a,c[l+3].x=r+_*s,c[l+3].y=a}}};Ie(QD,{updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&TD!==e&&(TD=e,this._updateProperties(),this._updateContent(),TD.actualFontSize=BD,TD.node.setContentSize(UD),TD.renderData.vertDirty=TD.renderData.uvDirty=!1,TD=null,this._resetProperties())},_updateFontScale:function(){PD=BD/ND},_updateProperties:function(){if(TD){var e=TD.font;if(e){if(DD=e.spriteFrame,RD=e.fntConfig,!(kD=TD.fontAtlas)){kD=new gD(RD);for(var t=RD.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new yD,s=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=s.width,a.height=s.height,a.u=s.x,a.v=s.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,kD.addLetterDefinitions(r,a)}TD.fontAtlas=kD}zD=TD.string.toString(),BD=TD.fontSize,ND=RD.fontSize;var o=TD.node.getContentSize();UD.width=o.width,UD.height=o.height,GD=TD.horizontalAlign,VD=TD.verticalAlign,HD=TD.spacingX,WD=TD.overflow,jD=TD.lineHeight,XD=WD!==Zt.Overflow.NONE&&(WD===Zt.Overflow.RESIZE_HEIGHT||TD.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){DD=RD=kD=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=zD,t=e.length,i=RD.kerningDict,n=xD,r=-1,a=0;a<t;++a){var s=e.charCodeAt(a),o=i[r<<16|65535&s]||0;n[a]=a<t-1?o:0,r=s}},_multilineTextWrap:function(e){var t=zD.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,c=null,u=new Ui;this._updateFontScale();for(var h=kD.letterDefinitions,_=0;_<t;){var f=zD.charAt(_);if("\n"!==f){for(var d=e(zD,_,t),p=o,m=l,v=s,y=n,g=!1,b=0;b<d;++b){var S=_+b;if("\r"!==(f=zD.charAt(S)))if(c=kD&&kD.getLetterDefinitionForChar(f)){var T=y+c.offsetX*PD;if(XD&&0<KD&&0<n&&T+c.width*PD>KD&&!mu(f)){wD.push(s),i++,r-=jD*PD+(n=s=0),g=!0;break}u.x=T,u.y=r-c.offsetY*PD,this._recordLetterInfo(h,u,f,S,i),S+1<xD.length&&S<t-1&&(y+=xD[S+1]),y+=c.xAdvance*PD+HD,v=u.x+c.width*PD,p<u.y&&(p=u.y),m>u.y-c.height*PD&&(m=u.y-c.height*PD)}else this._recordPlaceholderInfo(S,f),console.log("Can't find letter definition in texture atlas "+RD.atlasName+" for letter:"+f);else this._recordPlaceholderInfo(S,f)}g||(n=y,o<p&&(o=p),m<l&&(l=m),a<(s=v)&&(a=s),_+=d)}else wD.push(s),i++,r-=jD*PD+(n=s=0),this._recordPlaceholderInfo(_,f),_++}return wD.push(s),MD=(OD=i+1)*jD*PD,1<OD&&(MD+=0*(OD-1)),UD.width=qD,UD.height=YD,qD<=0&&(UD.width=parseFloat(a.toFixed(2))),YD<=0&&(UD.height=parseFloat(MD.toFixed(2))),ID=UD.height,(FD=0)<o&&(ID=UD.height+o),l<-MD&&(FD=MD+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(pu(n)||"\n"===n||mu(n))return 1;var r=1,a=kD&&kD.getLetterDefinitionForChar(n);if(!a)return r;for(var s=a._xAdvance*PD+HD,o=t+1;o<i&&(n=e.charAt(o),a=kD&&kD.getLetterDefinitionForChar(n));++o){if(s+a._offsetX*PD+a._width*PD>KD&&!mu(n)&&0<KD)return r;if(s+=a._xAdvance*PD+HD,"\n"===n||mu(n)||pu(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=ED.length){var i=new bD;ED.push(i)}ED[e].char=t,ED[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=ED.length){var a=new bD;ED.push(a)}var s=i.charCodeAt(0);ED[n].lineIndex=r,ED[n].char=i,ED[n].valid=e[s].validDefinition,ED[n].positionX=t.x,ED[n].positionY=t.y},_alignText:function(){MD=0,wD.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),WD===Zt.Overflow.SHRINK&&0<BD&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||WD===Zt.Overflow.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),BD=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=BD,i=jD,n=kD,r=0,a=n?n.cloneLetterDefinition():{},s=!0;e();){var o=t-++r;if(s=!1,o<=0)break;var l=o/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),jD=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}jD=i,n&&n.assignLetterDefinitions(a),s||0<=t-r&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return MD>UD.height},_isHorizontalClamp:function(){if(kD){for(var e=kD.letterDefinitions,t=!1,i=0,n=zD.length;i<n;++i){var r=ED[i];if(r.valid){var a=e[r.char],s=r.positionX+a.width/2*PD,o=r.lineIndex;if(0<qD)if(XD){if(wD[o]>UD.width&&(s>UD.width||s<0)){t=!0;break}}else if(s>UD.width){t=!0;break}}}return t}},_isHorizontalClamped:function(e,t){var i=wD[t],n=e>UD.width||e<0;return XD?i>UD.width&&n:n},_updateQuads:function(){if(!TD)return!1;var e=kD?kD.letterDefinitions:{},t=DD,i=TD.node,n=TD.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=UD,s=r.x*a.width,o=r.y*a.height,l=!0,c=0,u=zD.length;c<u;++c){var h=ED[c];if(h.valid){var _=e[h.char.charCodeAt(0)];if(_){SD.height=_.height,SD.width=_.width,SD.x=_.u,SD.y=_.v;var f=h.positionY+LD;if(0<YD){if(ID<f){var d=f-ID;SD.y+=d,SD.height-=d,f-=d}f-_.height*PD<FD&&(SD.height=f<FD?0:f-FD)}var p=h.lineIndex,m=h.positionX+_.width/2*PD+AD[p];if(0<qD&&this._isHorizontalClamped(m,p))if(WD===Zt.Overflow.CLAMP)SD.width=0;else if(WD===Zt.Overflow.SHRINK){if(UD.width>_.width){l=!1;break}SD.width=0}if(DD&&0<SD.height&&0<SD.width){var v=DD.isRotated(),y=DD.getOriginalSize(),g=DD.getRect(),b=DD.getOffset(),S=b.x+(y.width-g.width)/2,T=b.y-(y.height-g.height)/2;if(v){var x=SD.x;SD.x=g.x+g.height-SD.y-SD.height-T,SD.y=x+g.y-S,SD.y<0&&(SD.height=SD.height+T)}else SD.x+=g.x-S,SD.y+=g.y+T;var E=h.positionX+AD[h.lineIndex];this.appendQuad(TD,t,SD,v,E-s,f-o,PD)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(AD.length=0,GD){case Zt.HorizontalTextAlignment.LEFT:for(var e=0;e<OD;++e)AD.push(0);break;case Zt.HorizontalTextAlignment.CENTER:for(var t=0,i=wD.length;t<i;t++)AD.push((UD.width-wD[t])/2);break;case Zt.HorizontalTextAlignment.RIGHT:for(var n=0,r=wD.length;n<r;n++)AD.push(UD.width-wD[n])}switch(VD){case Zt.VerticalTextAlignment.TOP:LD=UD.height;break;case Zt.VerticalTextAlignment.CENTER:LD=(UD.height+MD)/2;break;case Zt.VerticalTextAlignment.BOTTOM:LD=MD}},_setupBMFontOverflowMetrics:function(){var e=UD.width,t=UD.height;WD===Zt.Overflow.RESIZE_HEIGHT&&(t=0),WD===Zt.Overflow.NONE&&(t=e=0),qD=e,YD=t,CD.width=e,CD.height=t,KD=e}});var ZD=QC.Overflow,JD=or.WHITE.clone(),$D=QC.HorizontalAlign,ez=QC.VerticalAlign,tz=function e(){y(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},iz=function e(){y(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},nz=function(){function i(e,t){y(this,i),this.spriteframe=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}return l(i,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.spriteframe.destroy(),this.spriteframe=null}},{key:"_updateProperties",value:function(){if(this.spriteframe=new bh,this.data=QC.CanvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=vu(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height);var t=new Ol(this.canvas);this.spriteframe.texture.image=t}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var o=t.out||JD;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a),this.spriteframe.texture.updateImage()}}}]),i}(),rz=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return d(t,fh),l(t,[{key:"initWithSize",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:ll.RGBA8888;this.destroy(),this.reset({width:e,height:t,format:i}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e._image&&n){var r=this._getGFXDevice();if(r){var a={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e._image.width,height:e._image.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};r.copyTexImagesToTexture([e._image.data],n,[a])}else console.warn("Unable to get device")}}}]),t}(),az=function(){function i(e,t){y(this,i),this.texture=void 0,this._x=2,this._y=2,this._nexty=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._imageAssets=[],this._dirty=!1,this.texture=new rz,this.texture.initWithSize(e,t),this._width=e,this._height=t,cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"insertLetterTexture",value:function(e){var t=e.spriteframe,i=cc.director.root.device;if(!(t&&this.texture&&i&&t._image))return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nexty),this._y+r>this._nexty&&(this._nexty=this._y+r+2),this._nexty>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new iz;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new rz;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new iz;Fe(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var i=this;e.forEach(function(e,t){Fe(i._letterDefinitions[t],e)})}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new nz(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),i}(),sz=new er,oz=null,lz=[],cz=[],uz=[],hz=[],_z=new Kn,fz=null,dz=0,pz=0,mz=0,vz=0,yz=0,gz=1,bz="",Sz=0,Tz=0,xz=new Kn,Ez=0,wz=0,Az=0,Cz=0,kz=0,Rz=!1,Oz=0,Mz=0,Lz=0,Iz="",Fz=!1,Pz={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:JD,isOutlined:!1,out:JD,margin:0},Dz={getAssemblerData:function(){return fz||(fz=new az(1024,1024)),fz.texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&oz!==e&&(oz=e,this._updateFontFamily(e),Pz.fontFamily=Iz,this._updateProperties(),Pz.fontDesc=this._getFontDesc(),this._updateContent(),oz.actualFontSize=Sz,oz.node.setContentSize(xz),oz.renderData.vertDirty=oz.renderData.uvDirty=!1,oz=null,this._resetProperties())},_updateFontScale:function(){gz=Sz/Tz},_updateProperties:function(){if(oz){bz=oz.string.toString(),Sz=oz.fontSize,Tz=Sz;var e=oz.node.getContentSize();xz.width=e.width,xz.height=e.height,Ez=oz.horizontalAlign,wz=oz.verticalAlign,Az=oz.spacingX,kz=oz.overflow,Cz=oz.lineHeight,Fz=oz.isBold,Rz=kz!==ZD.NONE&&(kz===ZD.RESIZE_HEIGHT||oz.enableWrapText);var t=oz.getComponent(nM);t&&t.enabled?(Pz.isOutlined=!0,Pz.margin=t.width,Pz.out=t.color,Pz.out.a=t.color.a*oz.color.a/255):(Pz.isOutlined=!1,Pz.margin=0),Pz.lineHeight=Cz,Pz.fontSize=Sz,Pz.fontFamily=Iz,Pz.color=oz.color,Pz.hash=this._computeHash(Pz),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(i){i.useSystemFont?Iz=i.fontFamily:i.font?i.font._nativeAsset?Iz=i.font._nativeAsset:(Iz=cc.loader.getRes(i.font.nativeUrl))||cc.loader.load(i.font.nativeUrl,function(e,t){Iz=t||"Arial",i.font&&(i.font._nativeAsset=t),i.updateRenderData(!0)}):Iz="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=Sz.toString()+"px ";return e+=Iz,Fz&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=bz.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,c=null,u=new Ui(0,0);this._updateFontScale();for(var h=0;h<t;){var _=bz.charAt(h);if("\n"!==_){for(var f=e(bz,h,t),d=o,p=l,m=s,v=n,y=!1,g=0;g<f;++g){var b=h+g;if("\r"!==(_=bz.charAt(b)))if(c=fz&&fz.getLetterDefinitionForChar(_,Pz)){var S=v+c.offsetX*gz;if(Rz&&0<Lz&&0<n&&S+c.w*gz>Lz&&!mu(_)){uz.push(s),i++,r-=Cz*gz+(n=s=0),y=!0;break}u.x=S,u.y=r-c.offsetY*gz,this._recordLetterInfo(u,_,b,i),b+1<lz.length&&b<t-1&&(v+=lz[b+1]),v+=c.xAdvance*gz+Az,m=u.x+c.w*gz,d<u.y&&(d=u.y),p>u.y-c.h*gz&&(p=u.y-c.h*gz)}else this._recordPlaceholderInfo(b,_);else this._recordPlaceholderInfo(b,_)}y||(n=v,o<d&&(o=d),p<l&&(l=p),a<(s=m)&&(a=s),h+=f)}else uz.push(s),i++,r-=Cz*gz+(n=s=0),this._recordPlaceholderInfo(h,_),h++}return uz.push(s),pz=(dz=i+1)*Cz*gz,1<dz&&(pz+=0*(dz-1)),xz.width=Oz,xz.height=Mz,Oz<=0&&(xz.width=parseFloat(a.toFixed(2))),Mz<=0&&(xz.height=parseFloat(pz.toFixed(2))),vz=xz.height,(yz=0)<o&&(vz=xz.height+o),l<-pz&&(yz=pz+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(pu(n)||"\n"===n||mu(n))return 1;if(fz){var r=1,a=fz.getLetterDefinitionForChar(n,Pz);if(!a)return r;for(var s=a.xAdvance*gz+Az,o=t+1;o<i&&(n=e.charAt(o),a=fz.getLetterDefinitionForChar(n,Pz));++o){if(s+a.offsetX*gz+a.w*gz>Lz&&!mu(n)&&0<Lz)return r;if(s+=a.xAdvance*gz+Az,"\n"===n||mu(n)||pu(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=cz.length){var i=new tz;cz.push(i)}cz[e].char=t,cz[e].hash=t.charCodeAt(0)+Pz.hash,cz[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=cz.length){var r=new tz;cz.push(r)}var a=t.charCodeAt(0)+Pz.hash;cz[i].line=n,cz[i].char=t,cz[i].hash=a;var s=fz&&fz.getLetter(a);cz[i].valid=!!s&&!!s.valid,cz[i].x=e.x,cz[i].y=e.y},_alignText:function(){pz=0,uz.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),Sz=e,t&&this._updateContent()},_isVerticalClamp:function(){return pz>xz.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=bz.length;t<i;++t){var n=cz[t];if(n.valid){var r=fz.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*gz,s=n.line;if(0<Oz)if(Rz){if(uz[s]>xz.width&&(a>xz.width||a<0)){e=!0;break}}else if(a>xz.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=uz[t],n=e>xz.width||e<0;return Rz?i>xz.width&&n:n},_updateQuads:function(){if(oz&&fz){var e=fz.texture,t=oz.node,i=oz.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=xz,r=t.getAnchorPoint(),a=r.x*n.width,s=r.y*n.height,o=!0,l=0,c=bz.length;l<c;++l){var u=cz[l];if(u.valid){var h=fz.getLetter(u.hash);if(h){sz.height=h.h,sz.width=h.w,sz.x=h.u,sz.y=h.v;var _=u.y+mz;if(0<Mz){if(vz<_){var f=_-vz;sz.y+=f,sz.height-=f,_-=f}_-h.h*gz<yz&&(sz.height=_<yz?0:_-yz)}var d=u.line,p=u.x+h.w/2*gz+hz[d];if(0<Oz&&this._isHorizontalClamped(p,d))if(kz===ZD.CLAMP)sz.width=0;else if(kz===ZD.SHRINK){if(xz.width>h.w){o=!1;break}sz.width=0}if(0<sz.height&&0<sz.width){var m=u.x+hz[u.line];this.appendQuad(i,e,sz,!1,m-a,_-s,gz)}}}}return o}},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(hz.length=0,Ez){case $D.LEFT:for(var e=0;e<dz;++e)hz.push(0);break;case $D.CENTER:for(var t=0,i=uz.length;t<i;t++)hz.push((xz.width-uz[t])/2);break;case $D.RIGHT:for(var n=0,r=uz.length;n<r;n++)hz.push(xz.width-uz[n])}switch(wz){case ez.TOP:mz=xz.height;break;case ez.CENTER:mz=(xz.height+pz)/2-(Cz-Sz)/2;break;case ez.BOTTOM:mz=(xz.height+pz)/2-(Cz-Sz)}},_setupBMFontOverflowMetrics:function(){var e=xz.width,t=xz.height;kz===ZD.RESIZE_HEIGHT&&(t=0),kz===ZD.NONE&&(t=e=0),Oz=e,Mz=t,_z.width=e,_z.height=t,Lz=e}},zz=cc.color(255,255,255,255),Bz={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;zz.a=e.color.a,mA(i,t,e.renderData,zz)}},appendQuad:QD.appendQuad};Ie(Bz,Dz);var Nz=QC.Overflow,Uz=or.WHITE.clone(),Gz=cc.js.isChildClassOf(nM,R_),Vz=null,Hz=null,jz=null,Wz="",Xz="",qz=0,Yz=0,Kz=[],Qz=new Kn,Zz=0,Jz=0,$z=0,eB=new or,tB="",iB=Nz.NONE,nB=!1,rB=!1,aB=new or,sB=0,oB=0,lB=!1,cB=!1,uB=!1,hB=new VC,_B={getAssemblerData:function(){var e=document.createElement("canvas"),t={canvas:e,context:e.getContext("2d")};return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(e){cc.game.renderType===cc.game.RENDER_TYPE_CANVAS&&e&&hB.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=qz,e.node.setContentSize(Qz),this.updateVerts(e),e.markForUpdateRenderData(!1),jz=Hz=Vz=null)},updateVerts:function(e){},_updateFontFamly:function(i){i.useSystemFont?tB=i.fontFamily:i.font?i.font._nativeAsset?tB=i.font._nativeAsset:cc.loader.load(i.font.nativeUrl,function(e,t){tB=t||"Arial",i.updateRenderData(!0)}):tB="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){Vz=t.context,Hz=t.canvas,jz=e.spriteFrame,Xz=e.string.toString(),qz=e.fontSize,Yz=qz,iB=e.overflow,Qz.width=e.node.width,Qz.height=e.node.height,Zz=e.lineHeight,Jz=e.horizontalAlign,$z=e.verticalAlign,eB=e.color,lB=e.isBold,cB=e.isItalic,uB=e.isUnderline,nB=iB!==Nz.NONE&&(iB===Nz.RESIZE_HEIGHT||e.enableWrapText);var i=Gz&&e.getComponent(nM);i&&i.enabled?(rB=!0,oB=sB=i.width,(aB=i.color.clone()).a=aB.a*e.color.a/255):(rB=!1,oB=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=Kz.length;return e=Jz===Zt.HorizontalTextAlignment.RIGHT?Qz.width-oB:Jz===Zt.HorizontalTextAlignment.CENTER?Qz.width/2:0+oB,t=$z===Zt.VerticalTextAlignment.TOP?0:$z===Zt.VerticalTextAlignment.CENTER?Qz.height/2-i*(n-1)/2:Qz.height-i*(n-1),cc.v2(e,t)},_updateTexture:function(){if(Vz&&Hz){Vz.clearRect(0,0,Hz.width,Hz.height),Vz.font=Wz;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();Vz.lineJoin="round",Vz.fillStyle="rgba(".concat(eB.r,", ").concat(eB.g,", ").concat(eB.b,", ").concat(eB.a/255,")");for(var n=0;n<Kz.length;++n){if(rB){var r=aB||Uz;Vz.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),Vz.lineWidth=2*sB,Vz.strokeText(Kz[n],t.x,t.y+n*i)}Vz.fillText(Kz[n],t.x,t.y+n*i),uB&&(e=this._calculateUnderlineStartPosition(),Vz.save(),Vz.beginPath(),Vz.lineWidth=qz/8,Vz.strokeStyle="rgba(".concat(eB.r,", ").concat(eB.g,", ").concat(eB.b,", ").concat(eB.a/255,")"),Vz.moveTo(e.x,e.y+n*i-1),Vz.lineTo(e.x+Hz.width,e.y+n*i-1),Vz.stroke(),Vz.restore())}if(jz){var a;a=jz instanceof bh?jz.texture:jz;var s=0===Hz.width||0===Hz.height;a.reset({width:Hz.width,height:Hz.height,mipmapLevel:s?0:1}),s||a.uploadData(Hz)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=Kz.length;return e=0+oB,t=$z===Zt.VerticalTextAlignment.TOP?qz:$z===Zt.VerticalTextAlignment.CENTER?Qz.height/2-i*(n-1)/2+qz/2:Qz.height-i*(n-1),cc.v2(e,t)},_updateLabelDimensions:function(){if(Vz){var e=Xz.split("\n");if(iB===Nz.RESIZE_HEIGHT)Qz.height=Kz.length*this._getLineHeight();else if(iB===Nz.NONE){var t=0,i=0,n=Kz=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=vu(Vz,s);t=o<t?t:o}i=Kz.length*this._getLineHeight(),Qz.width=parseFloat(t.toFixed(2))+2*oB,Qz.height=parseFloat(i.toFixed(2)),cB&&(Qz.width+=Yz*Math.tan(.20943951))}Hz&&(Hz.width=Qz.width,Hz.height=Qz.height)}},_calculateTextBaseline:function(){var e,t;e=Jz===Zt.HorizontalTextAlignment.RIGHT?"right":Jz===Zt.HorizontalTextAlignment.CENTER?"center":"left",t=$z===Zt.VerticalTextAlignment.TOP?"top":$z===Zt.VerticalTextAlignment.CENTER?"middle":"bottom",Vz&&(Vz.textAlign=e,Vz.textBaseline=t)},_calculateSplitedStrings:function(){if(Vz){var e=Xz.split("\n");if(nB){Kz=[];var t=Qz.width-2*oB,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=yu(a,vu(Vz,a),t,this._measureText(Vz));Kz=Kz.concat(s)}}else Kz=e}},_getFontDesc:function(){var e=qz.toString()+"px ";return e+=tB,lB&&(e="bold "+e),cB&&(e="italic "+e),e},_getLineHeight:function(){var e=Zz;return 0|(e=0===e?qz:e*qz/Yz)},_calculateParagraphLength:function(e,t){var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=vu(t,s);i.push(o)}return i},_measureText:function(t){return function(e){return vu(t,e)}},_calculateLabelFont:function(){if(Vz&&(Wz=this._getFontDesc(),Vz.font=Wz,iB===Nz.SHRINK)){var e=Xz.split("\n"),t=this._calculateParagraphLength(e,Vz);Kz=e;var i=0,n=0,r=0;if(nB){var a=Qz.width-2*oB,s=Qz.height-2*oB;if(a<0||s<0)return Wz=this._getFontDesc(),void(Vz.font=Wz);n=1+s,r=1+a;for(var o=qz+1,l=[],c=!0,u=0|o;s<n||a<r;){if(c?o=u/2|0:u=o=u-1,o<=0){cc.logID(4003);break}for(qz=o,Wz=this._getFontDesc(),Vz.font=Wz,Kz=[],i=n=0;i<e.length;++i){var h=0,_=vu(Vz,e[i]);for(l=yu(e[i],_,a,this._measureText(Vz));h<l.length;){r=vu(Vz,l[h]),n+=this._getLineHeight(),++h}Kz=Kz.concat(l)}c&&(s<n?u=0|o:(c=!1,n=1+s))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var f=(Qz.width-2*oB)/r,d=Qz.height/n;qz=Yz*Math.min(1,f,d)|0,Wz=this._getFontDesc(),Vz.font=Wz}}}},fB=or.WHITE.clone(),dB={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)or.array(i,fB,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.datas,r=e.node,a=t.currBufferBatch,s=a.byteOffset>>2,o=a.indiceOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,l=o=0);var c=a.vData,u=a.iData,h=i.vData,_=n[0],f=n[3];r.updateWorldTransform();var d=r._pos,p=r._rot,m=r._scale,v=_.x*m.x,y=f.x*m.x,g=_.y*m.y,b=f.y*m.y,S=p.x,T=p.y,x=p.z,E=p.w,w=S*T,A=x*E,C=S*S-T*T,k=E*E-x*x,R=k+C,O=2*(w-A),M=k-C,L=2*(w+A),I=d.x,F=d.y;h[0]=R*v+O*g+I,h[1]=M*g+L*v+F,h[9]=R*y+O*g+I,h[10]=M*g+L*y+F,h[18]=R*v+O*b+I,h[19]=M*b+L*v+F,h[27]=R*y+O*b+I,h[28]=M*b+L*y+F,c.set(h,s),u[o++]=l,u[o++]=l+1,u[o++]=l+2,u[o++]=l+2,u[o++]=l+1,u[o++]=l+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,s=i.anchorY*r,o=t.datas;o[0].x=-a,o[0].y=-s,o[3].x=n-a,o[3].y=r-s}}};Ie(dB,_B);var pB,mB,vB={getAssembler:function(e){var t=dB;return e.font instanceof __?t=QD:e.cacheMode===QC.CacheMode.CHAR&&(cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?cc.warn("sorry, subdomain does not support CHAR mode currently!"):t=Bz),t}};QC.Assembler=vB,(mB=pB||(pB={}))[mB.DISABLED=0]="DISABLED",mB[mB.CLEAR=1]="CLEAR",mB[mB.ENTER_LEVEL=2]="ENTER_LEVEL",mB[mB.ENABLED=3]="ENABLED",mB[mB.EXIT_LEVEL=4]="EXIT_LEVEL";var yB=function(){function e(){y(this,e),this.stage=pB.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:so.ALWAYS,stencilMask:4294967295,writeMask:4294967295,failOp:lo.KEEP,zFailOp:lo.KEEP,passOp:lo.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return l(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=pB.CLEAR}},{key:"enterLevel",value:function(){this.stage=pB.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=pB.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=pB.DISABLED:this.stage=pB.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;this.stage===pB.DISABLED?(t.stencilTest=!1,t.func=so.ALWAYS,t.failOp=lo.KEEP,t.stencilMask=t.writeMask=4294967295,t.ref=1):(t.stencilTest=!0,this.stage===pB.ENABLED?(t.func=so.EQUAL,t.failOp=lo.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):this.stage===pB.CLEAR?(t.func=so.NEVER,t.failOp=lo.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):this.stage===pB.ENTER_LEVEL&&(t.func=so.NEVER,t.failOp=lo.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()));var i=e.passes[0];if(this._changed(i)){var n=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:n.stencilTest,stencilFuncFront:n.func,stencilReadMaskFront:n.stencilMask,stencilWriteMaskFront:n.writeMask,stencilFailOpFront:n.failOp,stencilZFailOpFront:n.zFailOp,stencilPassOpFront:n.passOp,stencilRefFront:n.ref,stencilTestBack:n.stencilTest,stencilFuncBack:n.func,stencilReadMaskBack:n.stencilMask,stencilWriteMaskBack:n.writeMask,stencilFailOpBack:n.failOp,stencilZFailOpBack:n.zFailOp,stencilPassOpBack:n.passOp,stencilRefBack:n.ref},this._defaultPipelineState.blendState=i.blendState,this._defaultPipelineState.rasterizerState=i.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getInvertedRef",value:function(){for(var e=0,t=0;t<this._maskStack.length-1;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=pB.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}();yB.sharedManager=null,yB.sharedManager=new yB;var gB=yB.sharedManager,bB={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,s=e.node,o=t.datas,l=s.width,c=s.height,u=s.anchorX*l,h=s.anchorY*c;i=-u,n=-h,r=l-u,a=c-h,o[0].x=i,o[0].y=n,o[3].x=r,o[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){gB.pushMask(e),gB.clear(),e.clearGraphics.updateAssembler(t),gB.enterLevel(),e.graphics.updateAssembler(t),gB.enableMask()}},SB={fillBuffers:function(e,t){gB.exitMask()}},TB={getAssembler:function(){return bB}},xB={getAssembler:function(){return SB}};LO.Assembler=TB,LO.PostAssembler=xB;var EB=ZA.FillType,wB=new Nn,AB={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,s=e.fillRange;s<0&&(a+=s,s=-s),s=(s=1<(s=a+s)?1:s)<0?0:s;var o=(a=(a=1<a?1:a)<0?0:a)+(s=(s-=a)<0?0:s);o=1<o?1:o,n&&this.updateUVs(e,a,o),r&&(this.updateVerts&&this.updateVerts(e,a,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,s=n.width,o=n.height,l=n.getRect(),c=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,y=0;switch(n.isRotated()?(c=l.x/s,u=(l.y+l.width)/o,h=f=c,p=v=(l.x+l.height)/s,d=y=u,_=m=l.y/o):(c=l.x/s,u=(l.y+l.height)/o,h=p=c,f=v=(l.x+l.width)/s,_=d=u,m=y=l.y/o),e.fillType){case EB.HORIZONTAL:a[0].u=h+(f-h)*t,a[0].v=_+(d-_)*t,a[1].u=h+(f-h)*i,a[1].v=_+(d-_)*i,a[2].u=p+(v-p)*t,a[2].v=m+(y-m)*t,a[3].u=p+(v-p)*i,a[3].v=m+(y-m)*i;break;case EB.VERTICAL:a[0].u=h+(p-h)*t,a[0].v=_+(m-_)*t,a[1].u=f+(v-f)*t,a[1].v=d+(y-d)*t,a[2].u=h+(p-h)*i,a[2].v=_+(m-_)*i,a[3].u=f+(v-f)*i,a[3].v=d+(y-d)*i;break;default:cc.errorID(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,s=a.width,o=a.height,l=a.anchorX*s,c=a.anchorY*o,u=-l,h=-c,_=s-l,f=o-c,d=0;switch(e.fillType){case EB.HORIZONTAL:d=u+(_-u)*i,u=u+(_-u)*t,_=d;break;case EB.VERTICAL:d=h+(f-h)*i,h=h+(f-h)*t,f=d;break;default:cc.errorID(2626)}r[4].x=u,r[4].y=h,r[5].x=_,r[5].y=h,r[6].x=u,r[6].y=f,r[7].x=_,r[7].y=f,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(wB);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];Xi.transformMat4(a,r,wB)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);for(var u=a.vData,h=0;h<o;h++){var _=r[h];u[s++]=_.x,u[s++]=_.y,u[s++]=_.z,u[s++]=_.u,u[s++]=_.v,or.array(u,n,s),s+=4}var f=a.iData;f[l++]=c,f[l++]=c+1,f[l++]=c+2,f[l++]=c+1,f[l++]=c+3,f[l++]=c+2}(0,t,e.renderData,e.color)}},CB=2*Math.PI,kB=[new Ui,new Ui,new Ui,new Ui],RB=new Array(4),OB=new Array(8),MB=[new Ui,new Ui,new Ui,new Ui],LB=[new Ui,new Ui,new Ui,new Ui],IB=new Ui,FB=[new Ui,new Ui,new Ui,new Ui];function PB(e,t,i,n,r,a,s){var o=Math.sin(a);o=1e-6<Math.abs(o)?o:0;var l=Math.cos(a),c=0,u=0;if(0!==(l=1e-6<Math.abs(l)?l:0)){if(c=o/l,0<(e-r.x)*l){var h=r.y+c*(e-r.x);s[0].x=e,s[0].y=h}if(0<(t-r.x)*l){var _=r.y+c*(t-r.x);s[2].x=t,s[2].y=_}}if(0!==o){if(u=l/o,0<(n-r.y)*o){var f=r.x+u*(n-r.y);s[3].x=f,s[3].y=n}if(0<(i-r.y)*o){var d=r.x+u*(i-r.y);s[1].x=d,s[1].y=i}}}function DB(e,t){var i=t.x-e.x,n=t.y-e.y;if(0==i&&0==n)return 0;if(0==i)return 0<n?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function zB(e,t,i,n,r){var a=RB,s=a[0],o=a[1],l=a[2],c=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;BB((i.x-s)/(l-s),(i.y-o)/(c-o),e,t),BB((n.x-s)/(l-s),(n.y-o)/(c-o),e,t+1),BB((r.x-s)/(l-s),(r.y-o)/(c-o),e,t+2)}function BB(e,t,i,n){var r=OB,a=r[0]+(r[2]-r[0])*e,s=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,c=i[n];c.u=a+(s-a)*t,c.v=o+(l-o)*t}for(var NB={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.datas,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);1<=r;)r-=1;for(;r<0;)r+=1;var s=(r*=CB)+(a*=CB);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,s=-r,o=-a,l=i-r,c=n-a,u=RB;u[0]=s,u[1]=o,u[2]=l,u[3]=c;var h=e.fillCenter,_=IB.x=Math.min(Math.max(0,h.x),1)*(l-s)+s,f=IB.y=Math.min(Math.max(0,h.y),1)*(c-o)+o;kB[0].x=kB[3].x=s,kB[1].x=kB[2].x=l,kB[0].y=kB[1].y=o,kB[2].y=kB[3].y=c;for(var d=0,p=FB;d<p.length;d++){var m=p[d];Ui.set(m,0,0)}_!==u[0]&&Ui.set(FB[0],3,0),_!==u[2]&&Ui.set(FB[2],1,2),f!==u[1]&&Ui.set(FB[1],0,1),f!==u[3]&&Ui.set(FB[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,s=0,o=0,l=OB;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,s=n.y/i,o=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=o,l[1]=l[5]=s):(r=n.x/t,a=(n.x+n.width)/t,s=n.y/i,o=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=o,l[5]=l[7]=s)}(t),PB(RB[0],RB[2],RB[1],RB[3],IB,r,MB),PB(RB[0],RB[2],RB[1],RB[3],IB,r+a,LB);for(var o=0,l=0;l<4;++l){var c=FB[l];if(c)if(CB<=a)i.dataLength=o+3,zB(n,o,IB,kB[c.x],kB[c.y]),o+=3;else{var u=DB(IB,kB[c.x]),h=DB(IB,kB[c.y]);h<u&&(h+=CB),u-=CB,h-=CB;for(var _=0;_<3;++_)s<=u||(r<=u?(i.dataLength=o+3,zB(n,o,IB,kB[c.x],s<=h?LB[l]:kB[c.y]),o+=3):h<=r||(h<=s?(i.dataLength=o+3,zB(n,o,IB,MB[l],kB[c.y])):(i.dataLength=o+3,zB(n,o,IB,MB[l],LB[l])),o+=3)),u+=CB,h+=CB}}i.indiceCount=i.vertexCount=o,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);var u=a.vData;e.getWorldMatrix(pA);for(var h=0;h<o;h++){var _=r[h];Xi.set(dA,_.x,_.y,0),Xi.transformMat4(dA,dA,pA),u[s++]=dA.x,u[s++]=dA.y,u[s++]=dA.z,u[s++]=_.u,u[s++]=_.v,or.array(u,n,s),s+=4}for(var f=a.iData,d=0;d<i.dataLength;d++)f[l+d]=c+d}(e.node,t,e.renderData,e.color)}},UB=[],GB=0;GB<4;GB++)UB.push(new Xi);var VB={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,s=r.indiceOffset,o=r.vertexOffset;r.request()||(r=t.currBufferBatch,o=s=a=0);var l=r.vData,c=r.iData,u=e.renderData.vData,h=i[0],_=i[3];n.updateWorldTransform();var f=n._pos,d=n._rot,p=n._scale,m=h.x*p.x,v=_.x*p.x,y=h.y*p.y,g=_.y*p.y,b=d.x,S=d.y,T=d.z,x=d.w,E=b*S,w=T*x,A=b*b-S*S,C=x*x-T*T,k=C+A,R=2*(E-w),O=C-A,M=2*(E+w),L=f.x,I=f.y;u[0]=k*m+R*y+L,u[1]=O*y+M*m+I,u[9]=k*v+R*y+L,u[10]=O*y+M*v+I,u[18]=k*m+R*g+L,u[19]=O*g+M*m+I,u[27]=k*v+R*g+L,u[28]=O*g+M*v+I,l.set(u,a),c[s++]=o,c[s++]=o+1,c[s++]=o+2,c[s++]=o+2,c[s++]=o+1,c[s++]=o+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,s=i.anchorX*r,o=i.anchorY*a,l=0,c=0,u=0,h=0;if(e.trim)l=-s,c=-o,u=r-s,h=a-o;else{var _=e.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,y=d.height,g=_.getOffset(),b=r/p,S=a/m,T=g.x+(p-v)/2,x=g.x-(p-v)/2;l=T*b-s,c=(g.y+(m-y)/2)*S-o,u=r+x*b-s,h=a+(g.y-(m-y)/2)*S-o}n[0].x=l,n[0].y=c,n[0].z=0,n[3].x=u,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,s=n.b/255,o=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=s,t[i+3]=o,i+=9}},HB=new Xi,jB=new Nn,WB={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e)))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,s=n.anchorX*r,o=n.anchorY*a,l=e.spriteFrame,c=l.insetLeft,u=l.insetRight,h=l.insetTop,_=l.insetBottom,f=r-c-u,d=a-h-_,p=r/(c+u),m=a/(h+_);p=isNaN(p)||1<p?1:p,m=isNaN(m)||1<m?1:m,f=f<0?0:f,d=d<0?0:d,i[0].x=-s,i[0].y=-o,i[1].x=c*p-s,i[1].y=_*m-o,i[2].x=i[1].x+f,i[2].y=i[1].y+d,i[3].x=r-s,i[3].y=a-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,s=n.vertexCount,o=i.indiceOffset,l=i.vertexOffset,c=e.spriteFrame.uvSliced;i.request(s,n.indiceCount)||(i=t.currBufferBatch,l=o=a=0);for(var u=i.vData,h=i.iData,_=4;_<20;++_){var f=r[_],d=c[_-4];u[a++]=f.x,u[a++]=f.y,u[a++]=f.z,u[a++]=d.u,u[a++]=d.v,or.array(u,e.color,a),a+=4}for(var p=0;p<3;++p)for(var m=0;m<3;++m){var v=l+4*p+m;h[o++]=v,h[o++]=v+1,h[o++]=v+4,h[o++]=v+1,h[o++]=v+5,h[o++]=v+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(jB);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var s=i[a],o=i[4+4*n+a];Xi.set(HB,s.x,r.y,0),Xi.transformMat4(o,HB,jB)}}},XB=ZA.Type,qB=ZA.FillType,YB={getAssembler:function(e){var t=VB,i=e;switch(i.type){case XB.SLICED:t=WB;break;case XB.FILLED:t=i.fillType===qB.RADIAL?NB:AB}return t}};ZA.Assembler=YB;var KB=function(){function t(e){y(this,t),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=e}return l(t,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:6,i=this.byteOffset+e*this._vertexFormatBytes,n=this.indiceOffset+t;if(65535<e+this.vertexOffset)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,e,t),!1;var r=this.vData.byteLength,a=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,a=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indiceOffset+=t,this.byteOffset=i,this.dirty=!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),t}();cc.UI={MeshBuffer:KB,UIVertexFormat:vP,barFilled:AB,radialFilled:NB,simple:VB,sliced:WB,ttf:dB,bmfont:QD,letter:Bz,mask:bB,maskEnd:SB,graphics:mD,spriteAssembler:YB,graphicsAssembler:vD,labelAssembler:vB};var QB=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e,null)))._subModel=void 0,t._subModel=new ZB,t}return d(i,CS),l(i,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"initialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),i}(),ZB=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).psos=[],e}return d(t,Yb),l(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){0<this.commandBuffers.length&&this.commandBuffers[0].destroy()}}]),t}(),JB=function(){function e(){y(this,e),this._material=null,this._pass=null,this._psos=void 0,this._psos=null}return l(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),l(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=e.material,this._pass=this._material.passes[0],this._psos=new Ze(function(){return t._pass.createPipelineState()},1),!0)}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var t=this;this._material=null,this._psos&&this._psos.clear(function(e){t._pass.destroyPipelineState(e)})}}]),e}(),$B=function(){function e(){y(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null}return l(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null}}]),e}(),eN=function(){function i(e){var t=this;y(this,i),this._root=e,this.device=void 0,this._screens=[],this._debugScreen=null,this._bufferBatchPool=new Qp(function(){return new KB(t)},128),this._drawBatchPool=new Ze(function(){return new $B},128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=zb.getInstantiatedMaterial(new zb,new cc.RenderableComponent,!1),this._currMeshBuffer=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=-1,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new Ze(function(){var e=t._scene.createModel(QB,null);return e.visFlags|=Xb.ALWAYS,e},2),this._modelInUse=new qx(10),this._batches=new qx(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return l(i,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer}},{key:"debugScreen",get:function(){return this._debugScreen},set:function(e){this._debugScreen=e,this._debugScreen&&this._debugScreen.camera&&(this._debugScreen.camera.view.visibility=this._screens.length+1)}}]),l(i,[{key:"initialize",value:function(){return this._attributes=mP,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:Po.PRIMARY}),!0}},{key:"destroy",value:function(){this._destroyUIMaterials();var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy(this)}var r=this._meshBuffers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.destroy()}this._meshBuffers.splice(0);for(var l=this._uiMaterials.values(),c=l.next();!c.done;){c.value.destroy(),c=l.next()}this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new JB;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){this._screens.push(e),e.camera&&(e.camera.view.visibility=this._screens.length),this._debugScreen&&this._debugScreen.camera&&(this._debugScreen.camera.view.visibility=this._screens.length+1)}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return this._debugScreen&&this._debugScreen.camera&&this._debugScreen.camera.view.visibility===e?this._debugScreen:null}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);if(-1!==t){var i;this._screens.splice(t,1),this._debugScreen&&this._debugScreen.camera&&(this._debugScreen.camera.view.visibility=this._screens.length+1);for(var n=t;n<this._screens.length;n++)(i=this._screens[n].camera)&&(i.view.visibility=n)}}},{key:"update",value:function(e){if(this._renderScreens(),0<this._batches.length)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._modelInUse.get(t).enabled=!1,this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){n.camera&&(n.model.visFlags=n.camera.view.visibility);for(var r=0;r<n.model.subModelNum;r++)n.model.getSubModel(r).priority=e++}else{var a=n.bindingLayout;a.bindTextureView(im.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),a.update();var s=n.bufferBatch.ia;s.firstIndex=n.firstIdx,s.indexCount=n.idxCount;var o=this._uiModelPool.alloc();o.initialize(s,n),o.enabled=!0,o.getSubModel(0).priority=e++,n.camera&&(o.visFlags=n.camera.view.visibility),this._modelInUse.push(o)}}}},{key:"commitComp",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length?arguments[2]:void 0,n=e,r=t;this._currMaterial.hash===n.material.hash&&this._currTexView===r&&this._currCanvas===n.visibility||(this.autoMergeBatches(),this._currMaterial=n.material,this._currTexView=r,this._currCanvas=n.visibility),i&&i.fillBuffers(n,this)}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(yB.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this.getScreen(e.visibility),a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=e.visibility,this._batches.push(a)}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this.getScreen(this._currCanvas);yB.sharedManager.handleMaterial(e);var a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=this._currMeshBuffer,a.material=e,a.texView=this._currTexView,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"_deleteUIMaterial",value:function(e){this._uiMaterials.has(e.hash)&&(this._uiMaterials.get(e.hash).destroy(),this._uiMaterials.delete(e.hash))}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){console.log("111111111"),t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=e.children.length;if(this._preprocess(e),0<i)for(var n=e.children,r=0;r<n.length;++r){var a=n[r];this._walk(a,t)}this._postprocess(e),t+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&this._recursiveScreenNode(i.node)}this._debugScreen&&this._debugScreen.enabledInHierarchy&&this._recursiveScreenNode(this._debugScreen.node)}},{key:"_preprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}},{key:"_postprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.clear(this),this._drawBatchPool.free(t)}this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=-1,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),yB.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}}]),i}(),tN=function(){function t(e){y(this,t),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=e,iA.registerCreateFunc(this),FE.registerCreateFunc(this)}return l(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){0<e?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}}]),l(t,[{key:"initialize",value:function(e){var i=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,cb.initBuiltinRes(this._device),this._pipeline=new SE(this),this._pipeline.initialize(e)?(this._ui=new eN(this),this._ui.initialize()?(cc.view.on("design-resolution-changed",function(){var e=cc.game.canvas.width,t=cc.game.canvas.height;i.resize(e,t)},this),!0):(this.destroy(),!1)):(this.destroy(),!1))}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.isOffscreen||s.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var o=this._views,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;h.camera.isWindowSize&&h.camera.resize(e,t)}}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._views.sort(function(e,t){return e.priority-t.priority});var t=this._views,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.isEnable&&a.window&&(a.window.isOffscreen||!a.window.isOffscreen&&a.window===this._curWindow)&&this._pipeline.render(a)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._views=[]}}]),t}(),iN=function(e){function i(){var e;y(this,i),(e=T(this,S(i).call(this))).invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._compScheduler=void 0,e._nodeActivator=void 0,e._physicsSystem=void 0,e._systems=void 0,e._animationManager=void 0,e.invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new Pp,e._compScheduler=new Hd,e._nodeActivator=new ep,e._physicsSystem=null,e._systems=[];var t=_(e);return cc.game.on(bp.EVENT_SHOW,function(){t._lastUpdate=performance.now()}),cc.game.once(bp.EVENT_ENGINE_INITED,e.init,_(e)),e}return d(i,st),l(i,[{key:"init",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,this.sharedInit(),this._root=new tN(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"sharedInit",value:function(){kr&&kr.setEnabled(!0),cc.AnimationManager?(this._animationManager=new cc.AnimationManager,this._scheduler.scheduleUpdate(this._animationManager,Pp.PRIORITY_SYSTEM,!1)):this._animationManager=null,Ix&&Ix.init(this),cc.loader.init(this)}},{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=i._devicePixelRatio*(e.x-r),o=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?cc.v2(i._viewportRect.width-o,s):cc.v2(s,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=cc.v2(0,0);return i._isRotated?(s.x=r+e.y/i._devicePixelRatio,s.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(s.x=r+e.x*i._devicePixelRatio,s.y=a+n.height-e.y*i._devicePixelRatio),s}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return cc.size(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return cc.size(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),kr&&kr.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){var t=this;this.purgeDirector(),kr&&kr.setEnabled(!0),this._animationManager&&this._scheduler.scheduleUpdate(this._animationManager,cc.Scheduler.PRIORITY_SYSTEM,!1),this._systems.forEach(function(e){t._scheduler.scheduleUpdate(e,e._priority,!1)}),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map(function(e){return cc.game._persistRootNodes[e]}),a=0;a<r.length;a++){var s=r[a];s.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(s.uuid);if(o){var l=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(s,l)}else s.parent=e}var c=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=xe();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var s=0;s<i.length;s++)Vu(i[s],r);if(e)for(var o=0;o<e.length;o++){var l=e[o];!1===n[l]||r[l]||cc.loader.release(l)}for(var c=Object.keys(n),u=0;u<c.length;u++){var h=c[u];!0!==n[h]||r[h]||cc.loader.release(h)}}(c&&c.autoReleaseAssets&&c.dependAssets,e.dependAssets,r),cc.isValid(c)&&c.destroy(),this._scene=null,Ha._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,function(){n.runSceneImmediate(e,t,i)})}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(i,e,n){void 0===n&&(n=e,e=null);var t=this._getSceneUuid(i);if(t)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,i),cc.loader.load({uuid:t.uuid,type:"uuid"},e,function(e,t){e&&cc.errorID(1210,i,e.message),n&&n(e,t)});else{var r='Can not preload the scene "'+i+'" because it is not in the build settings.';n(new Error(r)),cc.error("preloadScene: "+r)}}},{key:"_loadSceneByUuid",value:function(r){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;3<arguments.length&&arguments[3];console.time("LoadScene "+r),cc.AssetLibrary.loadAsset(r,function(e,t){console.timeEnd("LoadScene "+r);var i=cc.director;if(i._loadingScene="",e)e="Failed to load scene: "+e,cc.error(e);else{if(t instanceof cc.SceneAsset){var n=t.scene;return n._id=t._uuid,n._name=t._name,void i.runSceneImmediate(n,s,a)}e="The asset "+r+" is not a scene",cc.error(e)}a&&a(e)})}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this._scheduler=e)}},{key:"registerSystem",value:function(e,t,i,n){var r=new t;return r._id=e,r._priority=n,i.forEach(function(e){We(e).system=r}),this._scheduler.scheduleUpdate(r,n,!1),r.init(),this._systems.push(r),r}},{key:"getSystem",value:function(t){return this._systems.find(function(e){return e._id===t})}},{key:"getAnimationManager",value:function(){return this._animationManager}},{key:"startAnimation",value:function(){this.invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this.invalid=!0}},{key:"mainLoop",value:function(e){this._purgeDirectorInNextLoop?(this._purgeDirectorInNextLoop=!1,this.purgeDirector()):this.invalid||(this.calculateDeltaTime(),this._paused||(this.emit(i.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(this._deltaTime),this._scheduler.update(this._deltaTime),this._compScheduler.lateUpdatePhase(this._deltaTime),this.emit(i.EVENT_AFTER_UPDATE),Ha._deferredDestroy(),null!=window.TWEEN&&window.TWEEN.update(e),this.emit(i.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(i.EVENT_AFTER_DRAW)),kr.frameUpdateListeners(),this._scene&&this._scene.resetHasChangedFlags(),this._totalFrames++)}},{key:"root",get:function(){return this._root}}]),i}();iN.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",iN.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",iN.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",iN.EVENT_BEFORE_UPDATE="director_before_update",iN.EVENT_AFTER_UPDATE="director_after_update",iN.EVENT_BEFORE_DRAW="director_before_draw",iN.EVENT_AFTER_DRAW="director_after_draw",iN.EVENT_BEFORE_PHYSICS="director_before_physics",iN.EVENT_AFTER_PHYSICS="director_after_physics";var nN,rN,aN,sN,oN,lN,cN,uN,hN,_N,fN,dN;cc.director=new iN;cc.Director=iN;var pN,mN,vN,yN,gN,bN,SN,TN,xN,EN,wN,AN,CN,kN,RN,ON,MN,LN,IN,FN,PN,DN,zN,BN,NN,UN,GN,VN,HN,jN,WN,XN,qN,YN,KN,QN,ZN,JN,$N,eU,tU,iU,nU,rU,aU,sU,oU,lU,cU,uU,hU,_U,fU,dU,pU,mU,vU,yU,gU,bU,SU,TU,xU,EU,wU,AU,CU,kU,RU,OU,MU,LU,IU,FU,PU,DU,zU,BU,NU,UU,GU,VU,HU,jU,WU,XU,qU,YU,KU,QU,ZU,JU,$U,eG,tG,iG,nG,rG,aG,sG,oG,lG,cG,uG,hG,_G,fG,dG,pG,mG,vG,yG,gG,bG,SG,TG,xG,EG,wG,AG,CG,kG,RG,OG,MG,LG,IG,FG,PG,DG,zG,BG,NG,UG,GG,VG,HG,jG,WG,XG,qG,YG,KG,QG,ZG,JG,$G,eV,tV,iV,nV,rV,aV,sV,oV,lV,cV,uV,hV,_V,fV,dV,pV,mV,vV,yV,gV,bV,SV,TV,xV,EV,wV,AV,CV,kV,RV,OV,MV,LV,IV,FV,PV,DV,zV,BV,NV,UV,GV,VV,HV,jV,WV,XV,qV,YV,KV,QV,ZV,JV,$V,eH,tH,iH,nH=kt({OFF:0,ON:1}),rH=(nN=Ca("cc.ModelComponent"),rN=Fa(100),aN=Ia("Components/ModelComponent"),sN=ka({type:Dm}),oN=ka({type:nH}),nN(lN=rN(lN=aN(lN=Ma((dN=fN=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._model=null,m(t,"_mesh",uN,_(t)),m(t,"_shadowCastingMode",hN,_(t)),m(t,"_receiveShadows",_N,_(t)),t}return d(a,RS),l(a,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model&&(this._model.inited||this._updateModels(),this._model.enabled=!0)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"onDestroy",value:function(){this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null)}},{key:"_getModel",value:function(){return this._model}},{key:"recreateModel",value:function(){this.isValid&&(this._model&&(this._model.destroy(),this._model.scene.destroyModel(this._model),this._model=null),this._updateModels())}},{key:"_updateModels",value:function(){this.enabledInHierarchy&&this._mesh&&(this._model&&this._model.inited?this._model.destroy():this._createModel(),this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._updateModelParams(),this._model&&(this._model.enabled=!0))}},{key:"_createModel",value:function(){if(this.node.scene){var e=this._getRenderScene();this._model=e.createModel(this._getModelConstructor(),this.node),this._model.visFlags=this.visibility}}},{key:"_getModelConstructor",value:function(){return CS}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node._hasChangedFlags=this._model.transform._hasChangedFlags=!0;for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getSharedMaterial(t),n=this._mesh.renderingMesh;if(n){var r=n.getSubmesh(t);r&&this._model.initSubModel(t,r,i||this._getBuiltinMaterial())}}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(null!=this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return cb.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===nH.OFF?this._model.castShadow=!1:this._shadowCastingMode===nH.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_updateReceiveShadow",value:function(){this.enabledInHierarchy&&this._model}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows=e,this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}}]),a}(),fN.ShadowCastingMode=nH,c((cN=dN).prototype,"mesh",[sN],Object.getOwnPropertyDescriptor(cN.prototype,"mesh"),cN.prototype),c(cN.prototype,"shadowCastingMode",[oN],Object.getOwnPropertyDescriptor(cN.prototype,"shadowCastingMode"),cN.prototype),uN=c(cN.prototype,"_mesh",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hN=c(cN.prototype,"_shadowCastingMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nH.OFF}}),_N=c(cN.prototype,"_receiveShadows",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lN=cN))||lN)||lN)||lN)||lN),aH=(pN=Ca("cc.SkinningModelComponent"),mN=Fa(100),vN=Ia("Components/SkinningModelComponent"),yN=ka(Vb),gN=ka(xf),bN=ka({type:Vb}),SN=ka({type:xf}),pN(TN=mN(TN=Ma(TN=vN((EN=c((xN=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_skeleton",EN,_(t)),m(t,"_skinningRoot",wN,_(t)),t}return d(a,rH),l(a,[{key:"uploadAnimation",value:function(e){this._model&&this._model.uploadAnimation(e)}},{key:"_updateModelParams",value:function(){this._update(),p(S(a.prototype),"_updateModelParams",this).call(this)}},{key:"_onMaterialModified",value:function(e,t){var i=Xg(cc.director.root&&cc.director.root.device),n=this.getMaterial(e)||this._getBuiltinMaterial();n.recompileShaders({CC_USE_SKINNING:i}),p(S(a.prototype),"_onMaterialModified",this).call(this,e,n)}},{key:"_getModelConstructor",value:function(){return UE}},{key:"_getBuiltinMaterial",value:function(){return cb.get("missing-skinning-material")}},{key:"_update",value:function(){var i=this;this._model&&this._model.bindSkeleton(this._skeleton,this._skinningRoot),this._materials.forEach(function(e,t){return e&&i._onMaterialModified(t,e)})}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._update()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._update()}},{key:"model",get:function(){return this._model}},{key:"frameID",set:function(e){this._model&&this._model.setFrameID(e)},get:function(){return this._model?this._model.getFrameID():0}}]),a}()).prototype,"_skeleton",[yN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wN=c(xN.prototype,"_skinningRoot",[gN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(xN.prototype,"skeleton",[bN],Object.getOwnPropertyDescriptor(xN.prototype,"skeleton"),xN.prototype),c(xN.prototype,"skinningRoot",[SN],Object.getOwnPropertyDescriptor(xN.prototype,"skinningRoot"),xN.prototype),TN=xN))||TN)||TN)||TN)||TN),sH=new Ui,oH=(AN=Ca("cc.AvatarUnit"),CN=ka(Dm),kN=ka(Vb),RN=ka(xf),ON=ka(fh),MN=ka({type:fh}),LN=ka({type:aH}),AN((PN=c((FN=function(){function e(){y(this,e),m(this,"mesh",PN,this),m(this,"skeleton",DN,this),m(this,"skinningRoot",zN,this),m(this,"_offset",BN,this),m(this,"_atlasSize",NN,this),m(this,"_albedoMap",UN,this)}return l(e,[{key:"atlasSize",set:function(e){Ui.copy(this._atlasSize,e)},get:function(){return this._atlasSize}},{key:"offset",set:function(e){Ui.copy(this._offset,e)},get:function(){return this._offset}},{key:"albedoMap",get:function(){return this._albedoMap},set:function(e){this._albedoMap!==e&&(this._albedoMap=e,this._albedoMap&&(sH.x=this._albedoMap.width,sH.y=this._albedoMap.height,this.atlasSize=sH))}},{key:"source",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.skinningRoot=e.skinningRoot)},get:function(){return null}}]),e}()).prototype,"mesh",[CN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DN=c(FN.prototype,"skeleton",[kN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zN=c(FN.prototype,"skinningRoot",[RN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BN=c(FN.prototype,"_offset",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ui(0,0)}}),NN=c(FN.prototype,"_atlasSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ui(256,256)}}),UN=c(FN.prototype,"_albedoMap",[ON],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(FN.prototype,"atlasSize",[ka],Object.getOwnPropertyDescriptor(FN.prototype,"atlasSize"),FN.prototype),c(FN.prototype,"offset",[ka],Object.getOwnPropertyDescriptor(FN.prototype,"offset"),FN.prototype),c(FN.prototype,"albedoMap",[MN],Object.getOwnPropertyDescriptor(FN.prototype,"albedoMap"),FN.prototype),c(FN.prototype,"source",[LN],Object.getOwnPropertyDescriptor(FN.prototype,"source"),FN.prototype),IN=FN))||IN),lH=function(e,t){for(var i="",n=t;n&&n!==e;)i="".concat(n.name,"/")+i,n=n.parent;return i},cH=function(e,t){return t?e+t:e.slice(0,-1)},uH=(GN=Ca("cc.AvatarModelComponent"),VN=Fa(100),HN=ka({override:!0,visible:!1}),jN=ka({override:!0,visible:!1}),WN=ka({override:!0,visible:!1}),XN=ka({type:Bt}),qN=ka({type:Gt}),YN=ka({type:[oH]}),GN(KN=VN(KN=Ma((ZN=c((QN=function(e){function g(){var e,t;y(this,g);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(g)).call.apply(e,[this].concat(n))),"_combinedTexSize",ZN,_(t)),t._combinedTex=null,m(t,"_albedoMapName",JN,_(t)),m(t,"_avatarUnits",$N,_(t)),t}return d(g,aH),l(g,[{key:"onLoad",value:function(){p(S(g.prototype),"onLoad",this).call(this),this._combinedTex=new fh,this._combinedTex.onLoaded(),this._combinedTex.setFilters(_l.LINEAR,_l.LINEAR),this.resizeCombinedTexture(),this.combine()}},{key:"onDestroy",value:function(){this._combinedTex&&(this._combinedTex.destroy(),this._combinedTex=null),this._mesh&&(this._mesh.destroy(),this._mesh=null)}},{key:"addAvatarUnit",value:function(e){this._avatarUnits.push(e)}},{key:"clear",value:function(){this._mesh&&this._mesh.destroy()}},{key:"bindTextures",value:function(){if(0<this._albedoMapName.length&&0<this._materials.length){var e=this.material;e&&e.setProperty(this._albedoMapName,this._combinedTex)}}},{key:"combine",value:function(){this.combineTextures(),this.combineSkeletons(),this.combineMeshes(),this.bindTextures()}},{key:"combineTextures",value:function(){var e=!1,t=this._avatarUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.albedoMap){e=!0;break}}if(e){var a=[],s=[],o=[],l=[],c=this._avatarUnits,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}var f=_;if(f){var d=f.offset;if((e=0<=d.x&&0<=d.y)&&f.albedoMap&&f.albedoMap.image&&f.albedoMap.image.data){var p=new nl;p.texOffset.x=d.x,p.texOffset.y=d.y,p.texExtent.width=f.albedoMap.image.width,p.texExtent.height=f.albedoMap.image.height;var m=f.albedoMap.image.data;m instanceof HTMLCanvasElement||m instanceof HTMLImageElement?(a.push(m),s.push(p)):(o.push(m.buffer),l.push(p))}}}var v=this._combinedTex.getGFXTexture(),y=cc.director.root.device;0<o.length&&y.copyBuffersToTexture(o,v,l),0<a.length&&y.copyTexImagesToTexture(a,v,s)}}},{key:"combineSkeletons",value:function(){var e=null,t=this._avatarUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a&&a.skinningRoot){var s=a.skinningRoot;e=e?yg(e,s):s}}if(this._skinningRoot=e){var o=new Vb,l=[],c=this._avatarUnits,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}var f=_;if(f&&f.skeleton&&f.skinningRoot)for(var d=f.skeleton,p=lH(e,f.skinningRoot),m=function(e){var t=cH(p,d.joints[e]);if(0<=o.joints.findIndex(function(e){return e===t}))return"continue";o.joints.push(t),l.push(d.bindposes[e]||new Nn)},v=0;v<d.joints.length;v++)m(v)}var y=x(Array(o.joints.length).keys()).sort(function(e,t){return o.joints[e]>o.joints[t]?1:o.joints[e]<o.joints[t]?-1:0});o.joints=o.joints.map(function(e,t,i){return i[y[t]]}),o.bindposes=l.map(function(e,t,i){return i[y[t]]}),b(S(g.prototype),"skeleton",o,this,!0)}else console.warn("illegal skinning roots")}},{key:"combineMeshes",value:function(){var g=this,e=!1,t=this._avatarUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Dm,e&&this._skinningRoot){for(var b,S=0,T=Zt.GFXFormat.UNKNOWN,x=0,E=Zt.GFXFormat.UNKNOWN,w=new Array(this._avatarUnits.length),a=this._avatarUnits.length,s=function(e){var t=g._avatarUnits[e];if(!t||!t.skeleton||!t.skinningRoot)return"continue";var i=lH(g._skinningRoot,t.skinningRoot);w[e]=t.skeleton.joints.map(function(e){var t=cH(i,e);return g._skeleton.joints.findIndex(function(e){return t===e})})},o=0;o<a;o++)s(o);var l=function(_){var f=g._avatarUnits[_];if(!f||!f.mesh||!f.mesh.data)return"continue";var d=f.offset,e=f.mesh.data.slice(),t=new Dm;t.reset({struct:f.mesh.struct,data:e}),b=new DataView(e.buffer);var i=function(){if(m){if(v>=p.length)return"break";y=p[v++]}else{if((v=p.next()).done)return"break";y=v.value}var e=y;S=e.view.offset,T=Zt.GFXFormat.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(0<=a.name.indexOf(Zt.GFXAttributeName.ATTR_TEX_COORD)){T=a.format;break}S+=rl[a.format].size}T&&mg(b,function(e,t){var i=0===t?"x":"y";return((e=function(e){return e-Math.floor(e)}(e))*f.atlasSize[i]+d[i])/g._combinedTexSize},T,S,e.view.length,e.view.stride,b);var s=w[_];if(!s)return"continue";x=e.view.offset,E=Zt.GFXFormat.UNKNOWN;var o=e.attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===Zt.GFXAttributeName.ATTR_JOINTS){E=h.format;break}x+=rl[h.format].size}E&&mg(b,function(e){return s[e]},E,x,e.view.length,e.view.stride,b)};var p=f.mesh.struct.vertexBundles,m=Array.isArray(p),v=0;e:for(p=m?p:p[Symbol.iterator]();;){var y;switch(i()){case"break":break e;case"continue":continue}}g._mesh.merge(t)};for(o=0;o<a;o++)l(o);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"resizeCombinedTexture",value:function(){this._combinedTex&&(this._combinedTex.destroy(),this._combinedTex.reset({width:this._combinedTexSize,height:this._combinedTexSize,format:ll.RGBA8888}))}},{key:"mesh",get:function(){return this._mesh}},{key:"skeleton",get:function(){return this._skeleton}},{key:"skinningRoot",get:function(){return this._skinningRoot}},{key:"combinedTexSize",get:function(){return this._combinedTexSize},set:function(e){this._combinedTexSize=e}},{key:"albedoMapName",get:function(){return this._albedoMapName},set:function(e){this._albedoMapName!==e&&(this._albedoMapName=e)}},{key:"avatarUnits",get:function(){return this._avatarUnits},set:function(e){this._avatarUnits=e}}]),g}()).prototype,"_combinedTexSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),JN=c(QN.prototype,"_albedoMapName",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$N=c(QN.prototype,"_avatarUnits",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(QN.prototype,"mesh",[HN],Object.getOwnPropertyDescriptor(QN.prototype,"mesh"),QN.prototype),c(QN.prototype,"skeleton",[jN],Object.getOwnPropertyDescriptor(QN.prototype,"skeleton"),QN.prototype),c(QN.prototype,"skinningRoot",[WN],Object.getOwnPropertyDescriptor(QN.prototype,"skinningRoot"),QN.prototype),c(QN.prototype,"combinedTexSize",[XN],Object.getOwnPropertyDescriptor(QN.prototype,"combinedTexSize"),QN.prototype),c(QN.prototype,"albedoMapName",[qN],Object.getOwnPropertyDescriptor(QN.prototype,"albedoMapName"),QN.prototype),c(QN.prototype,"avatarUnits",[YN],Object.getOwnPropertyDescriptor(QN.prototype,"avatarUnits"),QN.prototype),KN=QN))||KN)||KN)||KN),hH={name:Zt.GFXAttributeName.ATTR_BATCH_ID,format:Zt.GFXFormat.R32F,isNormalized:!1},_H={name:Zt.GFXAttributeName.ATTR_BATCH_UV,format:Zt.GFXFormat.RG32F,isNormalized:!1},fH=rl[hH.format].size+rl[_H.format].size,dH=(eU=Ca("cc.SkinningModelUnit"),tU=ka(Dm),iU=ka(Vb),nU=ka(zb),rU=ka({type:aH}),eU((oU=c((sU=function(){function e(){y(this,e),m(this,"mesh",oU,this),m(this,"skeleton",lU,this),m(this,"material",cU,this),m(this,"_offset",uU,this),m(this,"_size",hU,this)}return l(e,[{key:"offset",set:function(e){Ui.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){Ui.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getSharedMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[tU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lU=c(sU.prototype,"skeleton",[iU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cU=c(sU.prototype,"material",[nU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uU=c(sU.prototype,"_offset",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ui(0,0)}}),hU=c(sU.prototype,"_size",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ui(1,1)}}),c(sU.prototype,"offset",[ka],Object.getOwnPropertyDescriptor(sU.prototype,"offset"),sU.prototype),c(sU.prototype,"size",[ka],Object.getOwnPropertyDescriptor(sU.prototype,"size"),sU.prototype),c(sU.prototype,"copyFrom",[rU],Object.getOwnPropertyDescriptor(sU.prototype,"copyFrom"),sU.prototype),aU=sU))||aU),pH=(_U=Ca("cc.BatchedSkinningModelComponent"),fU=Fa(100),dU=Ia("Components/BatchedSkinningModelComponent"),pU=ka({type:[Gt]}),mU=ka({type:[dH]}),vU=ka({override:!0,visible:!1}),yU=ka({override:!0,visible:!1}),_U(gU=fU(gU=Ma(gU=dU((SU=c((bU=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"atlasSize",SU,_(t)),m(t,"batchableTextureNames",TU,_(t)),m(t,"units",xU,_(t)),t._textures={},t._batchMaterial=null,t}return d(a,aH),l(a,[{key:"onLoad",value:function(){p(S(a.prototype),"onLoad",this).call(this),this._batchMaterial=this.getSharedMaterial(0),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),p(S(a.prototype),"onDestroy",this).call(this)}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var _=this,f=this.getMaterial(0);if(f&&this._batchMaterial&&this._batchMaterial.effectAsset){f.copy(this._batchMaterial),this.resizeAtlases();for(var t=f.effectAsset.techniques[f.technique],e=function(l){var c=t.passes[l];if(!c.properties)return"continue";for(var e=function(){var t=h[u];if(c.properties[t].type>=js.SAMPLER1D){var i=null;_.batchableTextureNames.find(function(e){return e===t})?((i=_._textures[t])||(i=_.createTexture(t)),_.cookTextures(i,t,l)):_.units.some(function(e){return i=e.material&&e.material.getProperty(t,l)}),i&&f.setProperty(t,i,l)}else{var e=[],n=_.units,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.material&&e.push(o.material.getProperty(t.slice(0,-3),l))}f.setProperty(t,e,l)}},u=0,h=Object.keys(c.properties);u<h.length;u++)e()},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){var i=new Vb,n=[],e=this.units,t=Array.isArray(e),r=0;for(e=t?e:e[Symbol.iterator]();;){var a;if(t){if(r>=e.length)break;a=e[r++]}else{if((r=e.next()).done)break;a=r.value}var s=a;if(s&&s.skeleton)for(var o=s.skeleton,l=function(e){var t=o.joints[e];if(0<=i.joints.findIndex(function(e){return e===t}))return"continue";i.joints.push(t),n.push(o.bindposes[e]||new Nn)},c=0;c<o.joints.length;c++)l(c)}var u=Array.from(Array(i.joints.length).keys()).sort(function(e,t){return i.joints[e]>i.joints[t]?1:i.joints[e]<i.joints[t]?-1:0});i.joints=i.joints.map(function(e,t,i){return i[u[t]]}),i.bindposes=n.map(function(e,t,i){return i[u[t]]}),this._skeleton&&this._skeleton.destroy(),this.skeleton=i}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){var j=this,e=!1,t=this.units,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Dm,e&&this._skinningRoot){for(var W,X=0,q=Zt.GFXFormat.UNKNOWN,Y=0,K=Zt.GFXFormat.UNKNOWN,Q=new Array(this.units.length),a=this.units.length,s=0;s<a;s++){var o=this.units[s];o&&o.skeleton&&(Q[s]=o.skeleton.joints.map(function(t){return j._skeleton.joints.findIndex(function(e){return t===e})}))}for(var l=function(_){var e=j.units[_];if(!e||!e.mesh||!e.mesh.data)return"continue";var t=JSON.parse(JSON.stringify(e.mesh.struct)),i=0,n=t.vertexBundles,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.attributes.push(hH),o.attributes.push(_H),o.view.offset=i,o.view.length+=o.view.count*fH,o.view.stride+=fH,i+=o.view.length}var l=t.primitives,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var f=h;f.indexView&&(f.indexView.offset=i,i+=f.indexView.length),f.geometricInfo&&(i=4*Math.ceil(i/4),f.geometricInfo.view.offset=i,i+=f.geometricInfo.view.length)}var d=e.mesh.data,p=0,m=new Uint8Array(i);W=new DataView(m.buffer);for(var v=0;v<t.vertexBundles.length;v++){var y=e.mesh.readAttribute(v,Zt.GFXAttributeName.ATTR_TEX_COORD),g=e.mesh.struct.vertexBundles[v].view,b=t.vertexBundles[v].view,S=g.stride,T=b.stride;p=g.offset,i=b.offset;for(var x=0;x<b.count;x++){var E=d.subarray(p,p+S);m.set(E,i),W.setFloat32(i+S,_,cc.sys.isLittleEndian),W.setFloat32(i+S+4,y[2*x],cc.sys.isLittleEndian),W.setFloat32(i+S+8,y[2*x+1],cc.sys.isLittleEndian),i+=T,p+=S}}for(var w=0;w<t.primitives.length;w++){var A=e.mesh.struct.primitives[w],C=t.primitives[w];if(A.indexView&&C.indexView){var k=A.indexView.stride,R=C.indexView.stride;p=A.indexView.offset,i=C.indexView.offset;for(var O=0;O<C.indexView.count;O++){var M=d.subarray(p,p+k);m.set(M,i),i+=R,p+=k}}if(A.geometricInfo&&C.geometricInfo){var L=A.geometricInfo.view.stride,I=C.geometricInfo.view.stride;p=A.geometricInfo.view.offset,i=C.geometricInfo.view.offset;for(var F=0;F<C.geometricInfo.view.count;F++){var P=d.subarray(p,p+L);m.set(P,i),i+=I,p+=L}}}var D=new Dm;D.reset({struct:t,data:m});var z=e.offset,B=e.size,N=function(){if(G){if(V>=U.length)return"break";H=U[V++]}else{if((V=U.next()).done)return"break";H=V.value}var e=H;X=e.view.offset,q=Zt.GFXFormat.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===Zt.GFXAttributeName.ATTR_BATCH_UV){q=a.format;break}X+=rl[a.format].size}q&&mg(W,function(e,t){var i=0===t?"x":"y";return(e=function(e){return e-Math.floor(e)}(e))*B[i]+z[i]},q,X,e.view.length,e.view.stride,W);var s=Q[_];if(!s)return"continue";Y=e.view.offset,K=Zt.GFXFormat.UNKNOWN;var o=e.attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===Zt.GFXAttributeName.ATTR_JOINTS){K=h.format;break}Y+=rl[h.format].size}K&&mg(W,function(e){return s[e]},K,Y,e.view.length,e.view.stride,W)};var U=t.vertexBundles,G=Array.isArray(U),V=0;e:for(U=G?U:U[Symbol.iterator]();;){var H;switch(N()){case"break":break e;case"continue":continue}}j._mesh.merge(D)},c=0;c<a;c++)l(c);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var n=[],r=[],a=[],s=[],o=this.units,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.material){var _=h.material.getProperty(t,i);if(_&&_.image&&_.image.data){var f=new nl;f.texOffset.x=h.offset.x*this.atlasSize,f.texOffset.y=h.offset.y*this.atlasSize,f.texExtent.width=h.size.x*this.atlasSize,f.texExtent.height=h.size.y*this.atlasSize;var d=_.image.data;d instanceof HTMLCanvasElement||d instanceof HTMLImageElement?(n.push(d),r.push(f)):(a.push(d.buffer),s.push(f))}}}var p=e.getGFXTexture(),m=cc.director.root.device;0<a.length&&m.copyBuffersToTexture(a,p,s),0<n.length&&m.copyTexImagesToTexture(n,p,r)}},{key:"createTexture",value:function(e){var t=new fh;return t.setFilters(_l.LINEAR,_l.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:ll.RGBA8888}),t.loaded=!0,this._textures[e]=t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:ll.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){b(S(a.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){b(S(a.prototype),"skeleton",e,this,!0)}}]),a}()).prototype,"atlasSize",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),TU=c(bU.prototype,"batchableTextureNames",[pU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xU=c(bU.prototype,"units",[mU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(bU.prototype,"mesh",[vU],Object.getOwnPropertyDescriptor(bU.prototype,"mesh"),bU.prototype),c(bU.prototype,"skeleton",[yU],Object.getOwnPropertyDescriptor(bU.prototype,"skeleton"),bU.prototype),gU=bU))||gU)||gU)||gU)||gU),mH=kt({ORTHO:0,PERSPECTIVE:1}),vH=kt({SOLID_COLOR:Zo.ALL,DEPTH_ONLY:Zo.DEPTH_STENCIL,DONT_CLEAR:Zo.NONE}),yH=(EU=Ca("cc.CameraComponent"),wU=Ia("Components/CameraComponent"),AU=ka({type:mH}),CU=ka({type:vH}),kU=ka({visible:!1}),RU=ka({type:ph}),EU(OU=wU(OU=Ma((qU=XU=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_projection",LU,_(e)),m(e,"_priority",IU,_(e)),m(e,"_fov",FU,_(e)),m(e,"_orthoHeight",PU,_(e)),m(e,"_near",DU,_(e)),m(e,"_far",zU,_(e)),m(e,"_color",BU,_(e)),m(e,"_depth",NU,_(e)),m(e,"_stencil",UU,_(e)),m(e,"_clearFlags",GU,_(e)),m(e,"_rect",VU,_(e)),m(e,"_screenScale",HU,_(e)),m(e,"_visibility",jU,_(e)),m(e,"_targetTexture",WU,_(e)),e._camera=null,e}return d(t,R_),l(t,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this)}},{key:"onEnable",value:function(){this._camera||this._createCamera(),this._camera.enabled=!0}},{key:"onDisable",value:function(){this._camera&&(this._camera.enabled=!1)}},{key:"onDestroy",value:function(){this._camera&&(this._getRenderScene().destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i||(i=Ey.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t||(t=new Xi),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"_createCamera",value:function(){var t=this;if(this.node.scene){var e=this._getRenderScene();if(!this._camera||!e.cameras.find(function(e){return e===t._camera})){if(this._camera=e.createCamera({name:this.node.name,node:this.node,projection:this._projection,priority:this._priority}),this._camera){this._camera.viewport=this._rect,this._camera.fov=ki(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var i=this._color.r/255,n=this._color.g/255,r=this._color.b/255,a=this._color.a/255;this._camera.clearColor={r:i,g:n,b:r,a:a},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility}this._updateTargetTexture()}}}},{key:"onSceneChanged",value:function(e){this._camera&&this._camera.scene!==e.renderScene&&(this._createCamera(),this._camera.enabled=!0)}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera)if(this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}else this._camera.changeTargetWindow(),this._camera.isWindowSize=!0}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=ki(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture()}}}]),t}(),XU.ProjectionType=mH,LU=c((MU=qU).prototype,"_projection",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mH.PERSPECTIVE}}),IU=c(MU.prototype,"_priority",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FU=c(MU.prototype,"_fov",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),PU=c(MU.prototype,"_orthoHeight",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),DU=c(MU.prototype,"_near",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zU=c(MU.prototype,"_far",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),BU=c(MU.prototype,"_color",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or("#334C78")}}),NU=c(MU.prototype,"_depth",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),UU=c(MU.prototype,"_stencil",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GU=c(MU.prototype,"_clearFlags",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vH.SOLID_COLOR}}),VU=c(MU.prototype,"_rect",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new er(0,0,1,1)}}),HU=c(MU.prototype,"_screenScale",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jU=c(MU.prototype,"_visibility",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TE.GENERAL}}),WU=c(MU.prototype,"_targetTexture",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(MU.prototype,"projection",[AU],Object.getOwnPropertyDescriptor(MU.prototype,"projection"),MU.prototype),c(MU.prototype,"priority",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"priority"),MU.prototype),c(MU.prototype,"fov",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"fov"),MU.prototype),c(MU.prototype,"orthoHeight",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"orthoHeight"),MU.prototype),c(MU.prototype,"near",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"near"),MU.prototype),c(MU.prototype,"far",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"far"),MU.prototype),c(MU.prototype,"color",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"color"),MU.prototype),c(MU.prototype,"depth",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"depth"),MU.prototype),c(MU.prototype,"stencil",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"stencil"),MU.prototype),c(MU.prototype,"clearFlags",[CU],Object.getOwnPropertyDescriptor(MU.prototype,"clearFlags"),MU.prototype),c(MU.prototype,"rect",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"rect"),MU.prototype),c(MU.prototype,"screenScale",[kU],Object.getOwnPropertyDescriptor(MU.prototype,"screenScale"),MU.prototype),c(MU.prototype,"visibility",[ka],Object.getOwnPropertyDescriptor(MU.prototype,"visibility"),MU.prototype),c(MU.prototype,"targetTexture",[RU],Object.getOwnPropertyDescriptor(MU.prototype,"targetTexture"),MU.prototype),OU=MU))||OU)||OU)||OU),gH=kt({LUMINOUS_POWER:0,LUMINANCE:1}),bH=(YU=Ca("cc.LightComponent"),KU=ka({slide:!0,range:[1e3,15e3,1]}),YU((iG=tG=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_color",JU,_(t)),m(t,"_useColorTemperature",$U,_(t)),m(t,"_colorTemperature",eG,_(t)),t._type=Ox.UNKNOWN,t._light=null,t}return d(a,R_),l(a,[{key:"onEnable",value:function(){this._light?this._light.enabled=!0:this._createLight()}},{key:"onDisable",value:function(){this._light&&(this._light.enabled=!1)}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(e){this._light&&(this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.enabled=this.enabledInHierarchy)}},{key:"_destroyLight",value:function(e){this._light=null}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),a}(),tG.Type=Ox,tG.PhotometricTerm=gH,JU=c((ZU=iG).prototype,"_color",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.WHITE.clone()}}),$U=c(ZU.prototype,"_useColorTemperature",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eG=c(ZU.prototype,"_colorTemperature",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),c(ZU.prototype,"color",[ka],Object.getOwnPropertyDescriptor(ZU.prototype,"color"),ZU.prototype),c(ZU.prototype,"useColorTemperature",[ka],Object.getOwnPropertyDescriptor(ZU.prototype,"useColorTemperature"),ZU.prototype),c(ZU.prototype,"colorTemperature",[KU],Object.getOwnPropertyDescriptor(ZU.prototype,"colorTemperature"),ZU.prototype),QU=ZU))||QU),SH=(nG=Ca("cc.DirectionalLightComponent"),rG=Ia("Components/DirectionalLightComponent"),aG=ka({unit:"lx"}),nG(sG=rG(sG=Ma((lG=c((oG=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_illuminance",lG,_(t)),t._type=Ox.DIRECTIONAL,t._light=null,t}return d(a,bH),l(a,[{key:"_createLight",value:function(e){this.node.scene&&((e=e||this._getRenderScene()).mainLight.node.activeInHierarchy?console.warn("there can be only one directional(main) light."):(this._light=e.mainLight,this.illuminance=this._illuminance,p(S(a.prototype),"_createLight",this).call(this,e)))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(this._light.enabled=!1,e=e||this._getRenderScene(),this._light.node=e.defaultMainLightNode,p(S(a.prototype),"_destroyLight",this).call(this,e))}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),a}()).prototype,"_illuminance",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),c(oG.prototype,"illuminance",[aG],Object.getOwnPropertyDescriptor(oG.prototype,"illuminance"),oG.prototype),sG=oG))||sG)||sG)||sG),TH=Ca("cc.EditorCameraComponent")(cG=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._uiEditorCamera=null,t}return d(a,yH),l(a,[{key:"onLoad",value:function(){p(S(a.prototype),"onLoad",this).call(this)}},{key:"onEnable",value:function(){p(S(a.prototype),"onEnable",this).call(this)}},{key:"onDisable",value:function(){p(S(a.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){p(S(a.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;p(S(a.prototype),"_createCamera",this).call(this),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.ui.renderScene.createCamera({name:"Editor UICamera",node:this._camera.node,projection:this._projection,priority:this._priority,isUI:!0,flows:["UIFlow"]}),this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=this._camera.clearFlag)}},{key:"projection",set:function(e){b(S(a.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){b(S(a.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=ki(e))}},{key:"orthoHeight",set:function(e){b(S(a.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){b(S(a.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){b(S(a.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){b(S(a.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=e)}},{key:"depth",set:function(e){b(S(a.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){b(S(a.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){b(S(a.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){b(S(a.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){b(S(a.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}}]),a}())||cG,xH=(uG=Ca("cc.BillboardComponent"),hG=Ia("Components/BillboardComponent"),_G=ka({type:fh}),fG=ka({type:fh}),uG(dG=hG(dG=Ma((mG=c((pG=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_texture",mG,_(e)),m(e,"_height",vG,_(e)),m(e,"_width",yG,_(e)),m(e,"_rotation",gG,_(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=cc.v4(1,1,0,0),e}return d(t,R_),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*Ri(this._rotation))/100},set:function(e){this._rotation=ki(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),l(t,[{key:"onEnable",value:function(){this._model||this.createModel(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"createModel",value:function(){this._mesh=ug({primitiveMode:Zt.GFXPrimitiveMode.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[or.WHITE.r,or.WHITE.g,or.WHITE.b,or.WHITE.a,or.WHITE.r,or.WHITE.g,or.WHITE.b,or.WHITE.a,or.WHITE.r,or.WHITE.g,or.WHITE.b,or.WHITE.a,or.WHITE.r,or.WHITE.g,or.WHITE.b,or.WHITE.a],attributes:[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RG32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=this._getRenderScene().createModel(CS,this.node),null==this._material&&(this._material=new zb,this._material.copy(cb.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}()).prototype,"_texture",[_G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(pG.prototype,"texture",[fG],Object.getOwnPropertyDescriptor(pG.prototype,"texture"),pG.prototype),vG=c(pG.prototype,"_height",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(pG.prototype,"height",[ka],Object.getOwnPropertyDescriptor(pG.prototype,"height"),pG.prototype),yG=c(pG.prototype,"_width",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(pG.prototype,"width",[ka],Object.getOwnPropertyDescriptor(pG.prototype,"width"),pG.prototype),gG=c(pG.prototype,"_rotation",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(pG.prototype,"rotation",[ka],Object.getOwnPropertyDescriptor(pG.prototype,"rotation"),pG.prototype),dG=pG))||dG)||dG)||dG),EH=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RGBA32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD1,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA8,isNormalized:!0}],wH=cc.v3(),AH=cc.v3(),CH=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,e,t)))._capacity=void 0,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=null,i._vertCount=0,i._indexCount=0,i._capacity=100,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:qs.INDIRECT,memUsage:Ks.HOST|Ks.DEVICE,size:56,stride:1}),i}return d(n,CS),l(n,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){for(var e=this._vertSize=0,t=EH;e<t.length;e++){var i=t[e];i.offset=this._vertSize,this._vertSize+=rl[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=1+a,i[n++]=2+a,i[n++]=3+a,i[n++]=2+a,i[n++]=1+a}var s=this._device.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:s,indirectBuffer:this._iaInfoBuffer,attributes:EH,primitiveMode:Zt.GFXPrimitiveMode.TRIANGLE_LIST},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(1<e.length){var n=0;Xi.subtract(wH,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=wH.x,this._vdataF32[n++]=wH.y,this._vdataF32[n++]=wH.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=wH.x,this._vdataF32[n++]=wH.y,this._vdataF32[n++]=wH.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Xi.subtract(wH,e[r-1],e[r]),Xi.subtract(AH,e[r+1],e[r]),Xi.subtract(AH,AH,wH);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=AH.x,this._vdataF32[n++]=AH.y,this._vdataF32[n++]=AH.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=AH.x,this._vdataF32[n++]=AH.y,this._vdataF32[n++]=AH.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}Xi.subtract(wH,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=wH.x,this._vdataF32[n++]=wH.y,this._vdataF32[n++]=wH.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=wH.x,this._vdataF32[n++]=wH.y,this._vdataF32[n++]=wH.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),kH=kt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),RH=(bG=Ca("cc.CurveRange"),SG=ka({type:kH}),TG=ka({type:ng}),xG=ka({type:ng}),EG=ka({type:ng}),bG((DG=PG=function(){function e(){y(this,e),m(this,"mode",CG,this),m(this,"curve",kG,this),m(this,"curveMin",RG,this),m(this,"curveMax",OG,this),m(this,"constant",MG,this),m(this,"constantMin",LG,this),m(this,"constantMax",IG,this),m(this,"multiplier",FG,this)}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case kH.Constant:return this.constant;case kH.Curve:return this.curve.evaluate(e)*this.multiplier;case kH.TwoCurves:return Ci(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case kH.TwoConstants:return Ci(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case kH.Constant:return this.constant;case kH.Curve:return this.multiplier;case kH.TwoConstants:return this.constantMax;case kH.TwoCurves:return this.multiplier}return 0}}]),e}(),PG.Mode=kH,CG=c((AG=DG).prototype,"mode",[SG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kH.Constant}}),kG=c(AG.prototype,"curve",[TG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ng}}),RG=c(AG.prototype,"curveMin",[xG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ng}}),OG=c(AG.prototype,"curveMax",[EG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ng}}),MG=c(AG.prototype,"constant",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LG=c(AG.prototype,"constantMin",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IG=c(AG.prototype,"constantMax",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FG=c(AG.prototype,"multiplier",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wG=AG))||wG),OH=kt({Blend:0,Fixed:1}),MH=(Ca("cc.ColorKey")((NG=c((BG=function e(){y(this,e),m(this,"color",NG,this),m(this,"time",UG,this)}).prototype,"color",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE.clone()}}),UG=c(BG.prototype,"time",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zG=BG)),Ca("cc.AlphaKey")((HG=c((VG=function e(){y(this,e),m(this,"alpha",HG,this),m(this,"time",jG,this)}).prototype,"alpha",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jG=c(VG.prototype,"time",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GG=VG)),Ca("cc.Gradient")((ZG=QG=function(){function e(){y(this,e),m(this,"colorKeys",qG,this),m(this,"alphaKeys",YG,this),m(this,"mode",KG,this),this._color=void 0,this._color=cc.Color.WHITE.clone()}return l(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(or.WHITE),this._color;e=Pi(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(i<=e&&e<n){if(this.mode===OH.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return or.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?or.lerp(this._color,or.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&or.lerp(this._color,this.colorKeys[a].color,or.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Pi(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(i<=e&&e<n){if(this.mode===OH.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return Ci(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?Ci(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?Ci(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),QG.Mode=OH,qG=c((XG=ZG).prototype,"colorKeys",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),YG=c(XG.prototype,"alphaKeys",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),KG=c(XG.prototype,"mode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OH.Blend}}),WG=XG))||WG),LH=kt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),IH=(JG=Ca("cc.GradientRange"),$G=ka({type:LH}),eV=ka({type:MH}),tV=ka({type:MH}),iV=ka({type:MH}),nV=ka({type:LH}),JG((dV=fV=function(){function e(){y(this,e),m(this,"color",sV,this),m(this,"colorMin",oV,this),m(this,"colorMax",lV,this),m(this,"gradient",cV,this),m(this,"gradientMin",uV,this),m(this,"gradientMax",hV,this),m(this,"_mode",_V,this),this._color=cc.Color.WHITE.clone()}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case LH.Color:return this.color;case LH.TwoColors:return or.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case LH.RandomColor:return this.gradient.randomColor();case LH.Gradient:return this.gradient.evaluate(e);case LH.TwoGradients:return or.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),fV.Mode=LH,c((aV=dV).prototype,"mode",[$G],Object.getOwnPropertyDescriptor(aV.prototype,"mode"),aV.prototype),sV=c(aV.prototype,"color",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE.clone()}}),oV=c(aV.prototype,"colorMin",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE.clone()}}),lV=c(aV.prototype,"colorMax",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE.clone()}}),cV=c(aV.prototype,"gradient",[eV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MH}}),uV=c(aV.prototype,"gradientMin",[tV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MH}}),hV=c(aV.prototype,"gradientMax",[iV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MH}}),_V=c(aV.prototype,"_mode",[nV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LH.Color}}),rV=aV))||rV),FH="CC_USE_WORLD_SPACE",PH={CC_USE_WORLD_SPACE:!1},DH=(pV=Ca("cc.LineComponent"),mV=Ia("Components/LineComponent"),vV=ka({type:fh}),yV=ka({type:fh,displayOrder:0}),gV=ka({displayOrder:1}),bV=ka({type:[Xi]}),SV=ka({type:[Xi],displayOrder:2}),TV=ka({type:RH}),xV=ka({type:RH,displayOrder:3}),EV=ka({type:Ui,displayOrder:4}),wV=ka({type:Ui,displayOrder:5}),AV=ka({type:IH}),CV=ka({type:IH,displayOrder:6}),pV(kV=mV(kV=Ma((OV=c((RV=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"_texture",OV,_(e)),e._material=null,m(e,"_worldSpace",MV,_(e)),m(e,"_positions",LV,_(e)),m(e,"_width",IV,_(e)),m(e,"_tile",FV,_(e)),m(e,"_offset",PV,_(e)),m(e,"_color",DV,_(e)),e._model=null,e._tile_offset=cc.v4(),e}return d(t,R_),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(PH[FH]=this.worldSpace,this._material.recompileShaders(PH),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),l(t,[{key:"onEnable",value:function(){this._model||(this._model=this._getRenderScene().createModel(CH,this.node),this._model.setCapacity(100),null==this._material&&(this._material=new zb,this._material.copy(cb.get("default-trail-material")),PH[FH]=this.worldSpace,this._material.recompileShaders(PH)),this._model.setSubModelMaterial(0,this._material)),this._model.enabled=!0,this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}}]),t}()).prototype,"_texture",[vV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(RV.prototype,"texture",[yV],Object.getOwnPropertyDescriptor(RV.prototype,"texture"),RV.prototype),MV=c(RV.prototype,"_worldSpace",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(RV.prototype,"worldSpace",[gV],Object.getOwnPropertyDescriptor(RV.prototype,"worldSpace"),RV.prototype),LV=c(RV.prototype,"_positions",[bV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(RV.prototype,"positions",[SV],Object.getOwnPropertyDescriptor(RV.prototype,"positions"),RV.prototype),IV=c(RV.prototype,"_width",[TV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),c(RV.prototype,"width",[xV],Object.getOwnPropertyDescriptor(RV.prototype,"width"),RV.prototype),FV=c(RV.prototype,"_tile",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.v2(1,1)}}),c(RV.prototype,"tile",[EV],Object.getOwnPropertyDescriptor(RV.prototype,"tile"),RV.prototype),PV=c(RV.prototype,"_offset",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.v2(0,0)}}),c(RV.prototype,"offset",[wV],Object.getOwnPropertyDescriptor(RV.prototype,"offset"),RV.prototype),DV=c(RV.prototype,"_color",[AV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IH}}),c(RV.prototype,"color",[CV],Object.getOwnPropertyDescriptor(RV.prototype,"color"),RV.prototype),kV=RV))||kV)||kV)||kV),zH=(zV=Ca("cc.ColorOvertimeModule"),BV=ka({displayOrder:0}),NV=ka({type:IH,displayOrder:1}),zV((VV=c((GV=function(){function e(){y(this,e),m(this,"enable",VV,this),m(this,"color",HV,this)}return l(e,[{key:"animate",value:function(e){this.enable&&(e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Ii(e.randomSeed+91041))))}}]),e}()).prototype,"enable",[BV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HV=c(GV.prototype,"color",[NV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IH}}),UV=GV))||UV),BH=kt({World:0,Local:1,Custom:2}),NH=kt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),UH=kt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),GH=kt({Base:0,Edge:1,Shell:2,Volume:3}),VH=kt({Random:0,Loop:1,PingPong:2}),HH=kt({Particles:0,Ribbon:1}),jH=kt({Stretch:0,Repeat:1}),WH=new Xi(0,0,-1);function XH(e,t,i,n){return t!==e?(e===BH.World||Nn.invert(i,i),Nn.getRotation(n,i),!0):(vn.set(n,0,0,0,1),!1)}function qH(e,t){Ui.set(e,Math.cos(t),Math.sin(t))}function YH(e){var t=Mi(-1,1),i=Mi(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);Xi.set(e,r,a,t)}function KH(e,t,i){YH(e),Xi.multiplyScalar(e,e,t+(i-t)*Oi())}function QH(e,t,i,n){qH(e,n),e.z=0,Xi.multiplyScalar(e,e,t+(i-t)*Oi())}function ZH(e){for(var t=0;t<e.length;t++){var i=t+Li(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function JH(){var e=Mi(-1,1);return 0===e&&e++,ct(e)}var $H,ej,tj,ij,nj,rj,aj,sj,oj,lj,cj,uj,hj,_j,fj,dj,pj,mj,vj,yj,gj,bj,Sj,Tj,xj,Ej,wj,Aj,Cj,kj,Rj,Oj,Mj=212165,Lj=cc.v3(),Ij=(jV=Ca("cc.ForceOvertimeModule"),WV=ka({displayOrder:0}),XV=ka({type:RH,range:[-1,1],displayOrder:2}),qV=ka({type:RH,range:[-1,1],displayOrder:3}),YV=ka({type:RH,range:[-1,1],displayOrder:4}),KV=ka({type:BH,displayOrder:1}),jV((JV=c((ZV=function(){function e(){y(this,e),m(this,"enable",JV,this),m(this,"x",$V,this),m(this,"y",eH,this),m(this,"z",tH,this),m(this,"space",iH,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new vn,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=XH(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Xi.set(Lj,this.x.evaluate(i,Ii(e.randomSeed+Mj)),this.y.evaluate(i,Ii(e.randomSeed+Mj)),this.z.evaluate(i,Ii(e.randomSeed+Mj)));this.needTransform&&Xi.transformQuat(n,n,this.rotation),Xi.scaleAndAdd(e.velocity,e.velocity,n,t)}}]),e}()).prototype,"enable",[WV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$V=c(ZV.prototype,"x",[XV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),eH=c(ZV.prototype,"y",[qV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),tH=c(ZV.prototype,"z",[YV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),iH=c(ZV.prototype,"space",[KV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.Local}}),QV=ZV))||QV),Fj=23541,Pj=cc.v3(),Dj=($H=Ca("cc.LimitVelocityOvertimeModule"),ej=ka({displayOrder:0}),tj=ka({type:RH,range:[-1,1],displayOrder:4}),ij=ka({type:RH,range:[-1,1],displayOrder:5}),nj=ka({type:RH,range:[-1,1],displayOrder:6}),rj=ka({type:RH,range:[-1,1],displayOrder:3}),aj=ka({displayOrder:7}),sj=ka({displayOrder:2}),oj=ka({type:BH,displayOrder:1}),$H((uj=c((cj=function(){function e(){y(this,e),m(this,"enable",uj,this),m(this,"limitX",hj,this),m(this,"limitY",_j,this),m(this,"limitZ",fj,this),m(this,"limit",dj,this),m(this,"dampen",pj,this),m(this,"separateAxes",mj,this),m(this,"space",vj,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1}return l(e,[{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Pj;this.separateAxes?Xi.set(i,zj(e.ultimateVelocity.x,this.limitX.evaluate(t,Ii(e.randomSeed+Fj)),this.dampen),zj(e.ultimateVelocity.y,this.limitY.evaluate(t,Ii(e.randomSeed+Fj)),this.dampen),zj(e.ultimateVelocity.z,this.limitZ.evaluate(t,Ii(e.randomSeed+Fj)),this.dampen)):(Xi.normalize(i,e.ultimateVelocity),Xi.multiplyScalar(i,i,zj(e.ultimateVelocity.length(),this.limit.evaluate(t,Ii(e.randomSeed+Fj)),this.dampen))),Xi.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[ej],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hj=c(cj.prototype,"limitX",[tj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),_j=c(cj.prototype,"limitY",[ij],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),fj=c(cj.prototype,"limitZ",[nj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),dj=c(cj.prototype,"limit",[rj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),pj=c(cj.prototype,"dampen",[aj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),mj=c(cj.prototype,"separateAxes",[sj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vj=c(cj.prototype,"space",[oj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.Local}}),lj=cj))||lj);function zj(e,t,i){var n=Math.sign(e),r=Math.abs(e);return t<r&&(r=Ci(r,t,i)),r*n}var Bj,Nj,Uj,Gj,Vj,Hj,jj,Wj,Xj,qj,Yj,Kj,Qj,Zj,Jj,$j,eW,tW,iW,nW,rW,aW,sW,oW,lW,cW,uW,hW,_W,fW,dW,pW,mW,vW,yW,gW,bW,SW,TW,xW,EW,wW,AW,CW,kW,RW,OW,MW,LW,IW,FW,PW,DW,zW,BW,NW,UW,GW,VW,HW,jW,WW,XW,qW,YW,KW,QW,ZW,JW,$W,eX,tX,iX,nX,rX,aX,sX,oX,lX,cX,uX,hX,_X,fX,dX,pX,mX,vX,yX,gX,bX,SX,TX,xX,EX,wX,AX,CX,kX,RX,OX,MX,LX,IX,FX,PX,DX,zX,BX=(yj=Ca("cc.RotationOvertimeModule"),gj=ka({displayOrder:0}),bj=ka({displayOrder:1}),Sj=ka({type:RH,range:[-1,1],radian:!0,displayOrder:2}),Tj=ka({type:RH,range:[-1,1],radian:!0,displayOrder:3}),xj=ka({type:RH,range:[-1,1],radian:!0,displayOrder:4}),yj((Aj=c((wj=function(){function e(){y(this,e),m(this,"enable",Aj,this),m(this,"_separateAxes",Cj,this),m(this,"x",kj,this),m(this,"y",Rj,this),m(this,"z",Oj,this)}return l(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){e?console.error("rotation overtime separateAxes is not supported!"):this._separateAxes=e}}]),l(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=Ii(e.randomSeed+125292);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,Ii(e.randomSeed+125292))*t}}]),e}()).prototype,"enable",[gj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cj=c(wj.prototype,"_separateAxes",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(wj.prototype,"separateAxes",[bj],Object.getOwnPropertyDescriptor(wj.prototype,"separateAxes"),wj.prototype),kj=c(wj.prototype,"x",[Sj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Rj=c(wj.prototype,"y",[Tj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Oj=c(wj.prototype,"z",[xj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Ej=wj))||Ej),NX=(Bj=Ca("cc.SizeOvertimeModule"),Nj=ka({displayOrder:0}),Uj=ka({displayOrder:1}),Gj=ka({type:RH,displayOrder:2}),Vj=ka({type:RH,displayOrder:3}),Hj=ka({type:RH,displayOrder:4}),jj=ka({type:RH,displayOrder:5}),Bj((qj=c((Xj=function(){function e(){y(this,e),m(this,"enable",qj,this),m(this,"separateAxes",Yj,this),m(this,"size",Kj,this),m(this,"x",Qj,this),m(this,"y",Zj,this),m(this,"z",Jj,this)}return l(e,[{key:"animate",value:function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,i=Ii(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else Xi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Ii(e.randomSeed+39825)))}}]),e}()).prototype,"enable",[Nj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yj=c(Xj.prototype,"separateAxes",[Uj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Kj=c(Xj.prototype,"size",[Gj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Qj=c(Xj.prototype,"x",[Vj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Zj=c(Xj.prototype,"y",[Hj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Jj=c(Xj.prototype,"z",[jj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Wj=Xj))||Wj),UX=90794,GX=kt({Grid:0}),VX=kt({WholeSheet:0,SingleRow:1}),HX=($j=Ca("cc.TextureAnimationModule"),eW=ka({displayOrder:0}),tW=ka({type:GX}),iW=ka({type:GX,displayOrder:1}),nW=ka({displayOrder:2}),rW=ka({displayOrder:3}),aW=ka({type:VX,displayOrder:4}),sW=ka({type:RH,displayOrder:7}),oW=ka({type:RH,displayOrder:8}),lW=ka({displayOrder:9}),cW=ka({displayOrder:5}),uW=ka({displayOrder:6}),$j((fW=c((_W=function(){function e(){y(this,e),m(this,"_enable",fW,this),m(this,"_mode",dW,this),m(this,"numTilesX",pW,this),m(this,"numTilesY",mW,this),m(this,"animation",vW,this),m(this,"frameOverTime",yW,this),m(this,"startFrame",gW,this),m(this,"cycleCount",bW,this),m(this,"_flipU",SW,this),m(this,"_flipV",TW,this),m(this,"_uvChannelMask",xW,this),m(this,"randomRow",EW,this),m(this,"rowIndex",wW,this),this.ps=null}return l(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,Ii(e.randomSeed+UX))/(this.numTilesX*this.numTilesY);if(this.animation===VX.WholeSheet)e.frameIndex=Pi(this.cycleCount*(this.frameOverTime.evaluate(t,Ii(e.randomSeed+UX))+i),1);else if(this.animation===VX.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=Pi(this.cycleCount*(this.frameOverTime.evaluate(t,Ii(e.randomSeed+UX))+i),1),a=Math.floor(Math.random()*this.numTilesY)*n,s=a+n;e.frameIndex=Ci(a,s,r)}else{var o=this.rowIndex*n,l=o+n;e.frameIndex=Ci(o,l,Pi(this.cycleCount*(this.frameOverTime.evaluate(t,Ii(e.randomSeed+UX))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps&&this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e===GX.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(_W.prototype,"enable",[eW],Object.getOwnPropertyDescriptor(_W.prototype,"enable"),_W.prototype),dW=c(_W.prototype,"_mode",[tW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GX.Grid}}),c(_W.prototype,"mode",[iW],Object.getOwnPropertyDescriptor(_W.prototype,"mode"),_W.prototype),pW=c(_W.prototype,"numTilesX",[nW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mW=c(_W.prototype,"numTilesY",[rW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vW=c(_W.prototype,"animation",[aW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VX.WholeSheet}}),yW=c(_W.prototype,"frameOverTime",[sW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),gW=c(_W.prototype,"startFrame",[oW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),bW=c(_W.prototype,"cycleCount",[lW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SW=c(_W.prototype,"_flipU",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TW=c(_W.prototype,"_flipV",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xW=c(_W.prototype,"_uvChannelMask",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),EW=c(_W.prototype,"randomRow",[cW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wW=c(_W.prototype,"rowIndex",[uW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hW=_W))||hW),jX=197866,WX=cc.v3(),XX=(AW=Ca("cc.VelocityOvertimeModule"),CW=ka({displayOrder:0}),kW=ka({type:RH,range:[-1,1],displayOrder:2}),RW=ka({type:RH,range:[-1,1],displayOrder:3}),OW=ka({type:RH,range:[-1,1],displayOrder:4}),MW=ka({type:RH,range:[-1,1],displayOrder:5}),LW=ka({type:BH,displayOrder:1}),AW((PW=c((FW=function(){function e(){y(this,e),m(this,"enable",PW,this),m(this,"x",DW,this),m(this,"y",zW,this),m(this,"z",BW,this),m(this,"speedModifier",NW,this),m(this,"space",UW,this),this.rotation=void 0,this.needTransform=void 0,this.rotation=new vn,this.speedModifier.constant=1,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=XH(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Xi.set(WX,this.x.evaluate(t,Ii(e.randomSeed+jX)),this.y.evaluate(t,Ii(e.randomSeed+jX)),this.z.evaluate(t,Ii(e.randomSeed+jX)));this.needTransform&&Xi.transformQuat(i,i,this.rotation),Xi.add(e.animatedVelocity,e.animatedVelocity,i),Xi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Xi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Ii(e.randomSeed+jX)))}}]),e}()).prototype,"enable",[CW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DW=c(FW.prototype,"x",[kW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),zW=c(FW.prototype,"y",[RW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),BW=c(FW.prototype,"z",[OW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),NW=c(FW.prototype,"speedModifier",[MW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),UW=c(FW.prototype,"space",[LW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.Local}}),IW=FW))||IW),qX=(GW=Ca("cc.Burst"),VW=ka({type:RH}),GW((WW=c((jW=function(){function e(){y(this,e),m(this,"_time",WW,this),m(this,"minCount",XW,this),m(this,"maxCount",qW,this),m(this,"_repeatCount",YW,this),m(this,"repeatInterval",KW,this),m(this,"count",QW,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=1,this._curTime=0}return l(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),l(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount){var i=Pi(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=0<i?i:0;var n=Pi(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(jW.prototype,"time",[ka],Object.getOwnPropertyDescriptor(jW.prototype,"time"),jW.prototype),XW=c(jW.prototype,"minCount",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),qW=c(jW.prototype,"maxCount",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),YW=c(jW.prototype,"_repeatCount",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(jW.prototype,"repeatCount",[ka],Object.getOwnPropertyDescriptor(jW.prototype,"repeatCount"),jW.prototype),KW=c(jW.prototype,"repeatInterval",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QW=c(jW.prototype,"count",[VW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),HW=jW))||HW),YX=new Xi(0,0,0),KX=new Array,QX=new Xi(.5,.5,.5),ZX=(ZW=Ca("cc.ShapeModule"),JW=ka({displayOrder:13}),$W=ka({displayOrder:14}),eX=ka({displayOrder:15}),tX=ka({displayOrder:6}),iX=ka({displayOrder:5}),nX=ka({displayOrder:0}),rX=ka({type:UH,displayOrder:1}),aX=ka({type:GH,displayOrder:2}),sX=ka({displayOrder:16}),oX=ka({displayOrder:17}),lX=ka({displayOrder:18}),cX=ka({displayOrder:19}),uX=ka({displayOrder:3}),hX=ka({displayOrder:4}),_X=ka({type:VH,displayOrder:7}),fX=ka({displayOrder:9}),dX=ka({type:RH,displayOrder:10}),pX=ka({displayOrder:11}),mX=ka({displayOrder:12}),ZW((c((yX=function(){function e(){y(this,e),m(this,"enable",gX,this),m(this,"shapeType",bX,this),m(this,"emitFrom",SX,this),m(this,"alignToDirection",TX,this),m(this,"randomDirectionAmount",xX,this),m(this,"sphericalDirectionAmount",EX,this),m(this,"randomPositionAmount",wX,this),m(this,"radius",AX,this),m(this,"radiusThickness",CX,this),m(this,"arcMode",kX,this),m(this,"arcSpread",RX,this),m(this,"arcSpeed",OX,this),m(this,"length",MX,this),m(this,"boxThickness",LX,this),m(this,"_position",IX,this),m(this,"_rotation",FX,this),m(this,"_scale",PX,this),m(this,"_arc",DX,this),m(this,"_angle",zX,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Nn,this.quat=new vn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return l(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return Ri(this._arc)},set:function(e){this._arc=ki(e)}},{key:"angle",get:function(){return Math.round(100*Ri(this._angle))/100},set:function(e){this._angle=ki(e)}}]),l(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case UH.Box:!function(e,t,i,n){switch(e){case GH.Volume:!function(e,t){Xi.set(e,Mi(-t.x,t.x),Mi(-t.y,t.y),Mi(-t.z,t.z))}(i,QX);break;case GH.Shell:KX.splice(0,KX.length),KX.push(Mi(-.5,.5)),KX.push(Mi(-.5,.5)),KX.push(.5*JH()),ZH(KX),JX(KX,t),Xi.set(i,KX[0],KX[1],KX[2]);break;case GH.Edge:KX.splice(0,KX.length),KX.push(Mi(-.5,.5)),KX.push(.5*JH()),KX.push(.5*JH()),ZH(KX),JX(KX,t),Xi.set(i,KX[0],KX[1],KX[2]);break;default:console.warn(e+" is not supported for box emitter.")}Xi.copy(n,WH)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case UH.Circle:!function(e,t,i,n,r){QH(n,e*(1-t),e,i),Xi.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case UH.Cone:!function(e,t,i,n,r,a,s,o){switch(e){case GH.Base:QH(s,t*(1-i),t,n),Ui.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Xi.normalize(o,o),s.z=0;break;case GH.Shell:qH(s,n),Ui.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r),Xi.normalize(o,o),Ui.multiplyScalar(s,s,t),s.z=0;break;case GH.Volume:QH(s,t*(1-i),t,n),Ui.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Xi.normalize(o,o),s.z=0,Xi.add(s,s,Xi.multiplyScalar(YX,o,a*Oi()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case UH.Sphere:!function(e,t,i,n,r){switch(e){case GH.Volume:KH(n,t*(1-i),t),Xi.copy(r,n),Xi.normalize(r,r);break;case GH.Shell:YH(n),Xi.multiplyScalar(n,n,t),Xi.copy(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case UH.Hemisphere:!function(e,t,i,n,r){switch(e){case GH.Volume:KH(n,t*(1-i),t),0<n.z&&(n.z*=-1),Xi.copy(r,n),Xi.normalize(r,r);break;case GH.Shell:YH(n),Xi.multiplyScalar(n,n,t),0<n.z&&(n.z*=-1),Xi.copy(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(0<this.randomPositionAmount&&(e.position.x+=Mi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=Mi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=Mi(-this.randomPositionAmount,this.randomPositionAmount)),Xi.transformQuat(e.velocity,e.velocity,this.quat),Xi.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount){var t=Xi.normalize(YX,e.position);Xi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){vn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Nn.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===VH.Random)return Mi(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case VH.Loop:return Pi(e,this._arc);case VH.PingPong:return Di(e,this._arc)}}}]),e}()).prototype,"position",[JW],Object.getOwnPropertyDescriptor(yX.prototype,"position"),yX.prototype),c(yX.prototype,"rotation",[$W],Object.getOwnPropertyDescriptor(yX.prototype,"rotation"),yX.prototype),c(yX.prototype,"scale",[eX],Object.getOwnPropertyDescriptor(yX.prototype,"scale"),yX.prototype),c(yX.prototype,"arc",[tX],Object.getOwnPropertyDescriptor(yX.prototype,"arc"),yX.prototype),c(yX.prototype,"angle",[iX],Object.getOwnPropertyDescriptor(yX.prototype,"angle"),yX.prototype),gX=c(yX.prototype,"enable",[nX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bX=c(yX.prototype,"shapeType",[rX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UH.Box}}),SX=c(yX.prototype,"emitFrom",[aX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GH.Volume}}),TX=c(yX.prototype,"alignToDirection",[sX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xX=c(yX.prototype,"randomDirectionAmount",[oX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EX=c(yX.prototype,"sphericalDirectionAmount",[lX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wX=c(yX.prototype,"randomPositionAmount",[cX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AX=c(yX.prototype,"radius",[uX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),CX=c(yX.prototype,"radiusThickness",[hX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kX=c(yX.prototype,"arcMode",[_X],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VH.Random}}),RX=c(yX.prototype,"arcSpread",[fX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),OX=c(yX.prototype,"arcSpeed",[dX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),MX=c(yX.prototype,"length",[pX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LX=c(yX.prototype,"boxThickness",[mX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(0,0,0)}}),IX=c(yX.prototype,"_position",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(0,0,0)}}),FX=c(yX.prototype,"_rotation",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(0,0,0)}}),PX=c(yX.prototype,"_scale",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(1,1,1)}}),DX=c(yX.prototype,"_arc",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ki(360)}}),zX=c(yX.prototype,"_angle",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ki(25)}}),vX=yX))||vX);function JX(e,t){0<t.x&&(e[0]+=.5*Mi(-t.x,t.x),e[0]=wi(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*Mi(-t.y,t.y),e[1]=wi(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*Mi(-t.z,t.z),e[2]=wi(e[2],-.5,.5))}var $X,eq,tq,iq,nq,rq,aq,sq,oq,lq,cq,uq,hq,_q,fq,dq,pq,mq,vq,yq,gq,bq,Sq,Tq,xq,Eq,wq,Aq,Cq,kq,Rq,Oq,Mq,Lq,Iq,Fq,Pq,Dq,zq,Bq,Nq,Uq,Gq,Vq,Hq,jq,Wq,Xq,qq,Yq=function e(t){y(this,e),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.particleSystem=t,this.position=new Xi(0,0,0),this.velocity=new Xi(0,0,0),this.animatedVelocity=new Xi(0,0,0),this.ultimateVelocity=new Xi(0,0,0),this.angularVelocity=new Xi(0,0,0),this.axisOfRotation=new Xi(0,0,0),this.rotation=new Xi(0,0,0),this.startSize=new Xi(0,0,0),this.size=new Xi(0,0,0),this.startColor=cc.Color.WHITE.clone(),this.color=cc.Color.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0},Kq=new Xi,Qq=new Ui,Zq=new Nn,Jq=[0,0,1,0,0,1,1,1],$q="CC_USE_WORLD_SPACE",eY="CC_USE_BILLBOARD",tY="CC_USE_STRETCHED_BILLBOARD",iY="CC_USE_HORIZONTAL_BILLBOARD",nY="CC_USE_VERTICAL_BILLBOARD",rY="CC_USE_MESH",aY=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD1,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD2,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA8,isNormalized:!0}],sY=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD1,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD2,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA8,isNormalized:!0},{name:Zt.GFXAttributeName.ATTR_COLOR1,format:Zt.GFXFormat.RGB32F}],oY=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD1,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD2,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA8,isNormalized:!0},{name:Zt.GFXAttributeName.ATTR_TEX_COORD3,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_NORMAL,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_COLOR1,format:Zt.GFXFormat.RGBA8,isNormalized:!0}],lY=($X=Ca("cc.ParticleSystemRenderer"),eq=ka({type:NH,displayOrder:0}),tq=ka({displayOrder:1}),iq=ka({displayOrder:2}),nq=ka({type:NH,displayOrder:3}),rq=ka({displayOrder:4}),aq=ka({displayOrder:5}),sq=ka({displayOrder:6}),oq=ka({type:cc.ParticleSystemComponent,visible:!1}),lq=ka({type:Dm,displayOrder:7}),cq=ka({type:zb,displayOrder:8}),uq=ka({type:zb,displayOrder:9}),$X((c((_q=function(){function e(){y(this,e),m(this,"_renderMode",fq,this),m(this,"_velocityScale",dq,this),m(this,"_lengthScale",pq,this),m(this,"_mesh",mq,this),m(this,"_particleSystem",vq,this),this._defines=void 0,this._trailDefines=void 0,this._model=void 0,this.frameTile_velLenScale=void 0,this._node_scale=void 0,this.attrs=void 0,this._vertAttrs=[],this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new $i(1,1,0,0),this._node_scale=new $i,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return l(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===NH.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}}]),l(e,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this._particles=new Qp(function(){return new Yq(t)},16),this._setVertexAttrib(),this.onEnable(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this._particleSystem&&(null==this._model&&(this._model=this._particleSystem._getRenderScene().createModel(fP,this._particleSystem.node),this._model.visFlags=this._particleSystem.visibility),this._model.inited||(this._model.setCapacity(this._particleSystem.capacity),this._model.node=this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDestroy",value:function(){this._particleSystem._getRenderScene().destroyModel(this._model),this._model=null}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this._particleSystem.node.getWorldMatrix(Zq),this._particleSystem.scaleSpace){case BH.Local:this._particleSystem.node.getScale(this._node_scale);break;case BH.World:this._particleSystem.node.getWorldScale(this._node_scale)}(this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat).setProperty("scale",this._node_scale),this._particleSystem.velocityOvertimeModule.enable&&this._particleSystem.velocityOvertimeModule.update(this._particleSystem._simulationSpace,Zq),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.update(this._particleSystem._simulationSpace,Zq),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,Xi.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this._particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this._particleSystem.sizeOvertimeModule.enable&&this._particleSystem.sizeOvertimeModule.animate(i),this._particleSystem.colorOverLifetimeModule.enable&&this._particleSystem.colorOverLifetimeModule.animate(i),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.animate(i,e),this._particleSystem.velocityOvertimeModule.enable?this._particleSystem.velocityOvertimeModule.animate(i):Xi.copy(i.ultimateVelocity,i.velocity),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.animate(i),this._particleSystem.rotationOvertimeModule.enable&&this._particleSystem.rotationOvertimeModule.animate(i,e),this._particleSystem.textureAnimationModule.enable&&this._particleSystem.textureAnimationModule.animate(i),Xi.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===NH.StrecthedBillboard,i=0;i<this._particles.length;++i){var n=this._particles.data[i],r=0;this._particleSystem.textureAnimationModule.enable&&(r=n.frameIndex),e=4*i;var a=0;if(this._renderMode!==NH.Mesh)for(var s=0;s<4;++s)a=0,this.attrs[a++]=n.position,Kq.x=Jq[2*s],Kq.y=Jq[2*s+1],Kq.z=r,this.attrs[a++]=Kq,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this.attrs[a++]=t?n.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else a=0,this.attrs[a++]=n.position,Kq.z=r,this.attrs[a++]=Kq,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=Qq,this.attrs[a++]=n.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this._updateMaterialParams()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this._particleSystem.trailModule._trailModel&&1===e&&this._particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case NH.StrecthedBillboard:this._vertAttrs=sY.slice();break;case NH.Mesh:this._vertAttrs=oY.slice();break;default:this._vertAttrs=aY.slice()}}},{key:"_updateMaterialParams",value:function(){if(this._particleSystem){null!=this._particleSystem.sharedMaterial&&-1===this._particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this._particleSystem.setMaterial(null,0,!1),null==this._particleSystem.sharedMaterial&&null==this._defaultMat&&(this._defaultMat=zb.getInstantiatedMaterial(cb.get("default-particle-material"),this._particleSystem,!0));var e=this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat;this._particleSystem._simulationSpace===BH.World?this._defines[$q]=!0:this._defines[$q]=!1,this._renderMode===NH.Billboard?(this._defines[eY]=!0,this._defines[tY]=!1,this._defines[iY]=!1,this._defines[nY]=!1,this._defines[rY]=!1):this._renderMode===NH.StrecthedBillboard?(this._defines[eY]=!1,this._defines[tY]=!0,this._defines[iY]=!1,this._defines[nY]=!1,this._defines[rY]=!1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===NH.HorizontalBillboard?(this._defines[eY]=!1,this._defines[tY]=!1,this._defines[iY]=!0,this._defines[nY]=!1,this._defines[rY]=!1):this._renderMode===NH.VerticalBillboard?(this._defines[eY]=!1,this._defines[tY]=!1,this._defines[iY]=!1,this._defines[nY]=!0,this._defines[rY]=!1):this._renderMode===NH.Mesh?(this._defines[eY]=!1,this._defines[tY]=!1,this._defines[iY]=!1,this._defines[nY]=!1,this._defines[rY]=!0):console.warn("particle system renderMode ".concat(this._renderMode," not support.")),this._particleSystem.textureAnimationModule.enable&&Ui.set(this.frameTile_velLenScale,this._particleSystem.textureAnimationModule.numTilesX,this._particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,this._particleSystem.sharedMaterial||this._defaultMat)}}},{key:"_updateTrailMaterial",value:function(){if(this._particleSystem.trailModule.enable){this._particleSystem._simulationSpace===BH.World||this._particleSystem.trailModule.space===BH.World?this._trailDefines[$q]=!0:this._trailDefines[$q]=!1;var e=this.trailMaterial;null===e&&null===this._defaultTrailMat&&(this._defaultTrailMat=zb.getInstantiatedMaterial(cb.get("default-trail-material"),this._particleSystem,!0)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this._particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model&&this._model.setVertexAttributes(this._renderMode===NH.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[eq],Object.getOwnPropertyDescriptor(_q.prototype,"renderMode"),_q.prototype),c(_q.prototype,"velocityScale",[tq],Object.getOwnPropertyDescriptor(_q.prototype,"velocityScale"),_q.prototype),c(_q.prototype,"lengthScale",[iq],Object.getOwnPropertyDescriptor(_q.prototype,"lengthScale"),_q.prototype),fq=c(_q.prototype,"_renderMode",[nq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NH.Billboard}}),dq=c(_q.prototype,"_velocityScale",[rq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pq=c(_q.prototype,"_lengthScale",[aq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mq=c(_q.prototype,"_mesh",[sq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vq=c(_q.prototype,"_particleSystem",[oq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(_q.prototype,"mesh",[lq],Object.getOwnPropertyDescriptor(_q.prototype,"mesh"),_q.prototype),c(_q.prototype,"particleMaterial",[cq],Object.getOwnPropertyDescriptor(_q.prototype,"particleMaterial"),_q.prototype),c(_q.prototype,"trailMaterial",[uq],Object.getOwnPropertyDescriptor(_q.prototype,"trailMaterial"),_q.prototype),hq=_q))||hq);Object.assign(lY,{uv:Jq});var cY,uY,hY,_Y,fY,dY,pY,mY,vY,yY,gY,bY,SY,TY,xY,EY,wY,AY,CY,kY,RY,OY,MY,LY,IY,FY,PY,DY,zY,BY,NY,UY,GY,VY,HY,jY,WY,XY,qY,YY,KY,QY,ZY,JY,$Y,eK,tK,iK,nK,rK,aK,sK,oK,lK,cK,uK,hK,_K,fK,dK,pK,mK,vK,yK,gK,bK,SK,TK,xK,EK,wK,AK,CK,kK={position:cc.v3(),velocity:cc.v3()},RK=cc.quat(),OK=cc.mat4(),MK=cc.v3(),LK=cc.v3(),IK=cc.color(),FK=function(){function t(e){for(y(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:cc.v3(),lifetime:0,width:0,velocity:cc.v3(),color:cc.color()})}return l(t,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),PK=(yq=Ca("cc.TrailModule"),gq=ka({displayOrder:0}),bq=ka({type:HH,displayOrder:1}),Sq=ka({type:RH,displayOrder:3}),Tq=ka({displayOrder:5}),xq=ka({type:BH,displayOrder:6}),Eq=ka({displayOrder:7}),wq=ka({type:jH,displayOrder:8}),Aq=ka({displayOrder:9}),Cq=ka({type:RH,displayOrder:10}),kq=ka({displayOrder:11}),Rq=ka({type:IH,displayOrder:12}),Oq=ka({type:IH,displayOrder:13}),Mq=ka({type:BH}),Lq=ka({type:cc.ParticleSystemComponent,visible:!1}),yq((c((Fq=function(){function a(){y(this,a),m(this,"_enable",Pq,this),m(this,"mode",Dq,this),m(this,"lifeTime",zq,this),m(this,"_minParticleDistance",Bq,this),m(this,"existWithParticles",Nq,this),m(this,"textureMode",Uq,this),m(this,"widthFromParticle",Gq,this),m(this,"widthRatio",Vq,this),m(this,"colorFromParticle",Hq,this),m(this,"colorOverTrail",jq,this),m(this,"colorOvertime",Wq,this),m(this,"_space",Xq,this),m(this,"_particleSystem",qq,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:Zt.GFXAttributeName.ATTR_POSITION,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD,format:Zt.GFXFormat.RGBA32F},{name:Zt.GFXAttributeName.ATTR_TEX_COORD1,format:Zt.GFXFormat.RGB32F},{name:Zt.GFXAttributeName.ATTR_COLOR,format:Zt.GFXFormat.RGBA8,isNormalized:!0}],this._vertSize=0;var e=this._vertAttrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._vertSize+=rl[r.format].size}this._particleTrail=new Map}return l(a,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.renderer._updateTrailMaterial()}}]),l(a,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;var i=0,n=this._particleSystem.bursts,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}i+=s.getMaxCount(this._particleSystem)}this._trailNum=Math.ceil(this._particleSystem.startLifetime.getMax()*this.lifeTime.getMax()*60*(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration+i)),this._trailSegments=new Ze(function(){return new FK(Math.ceil(t._particleSystem.startLifetime.getMax()*t.lifeTime.getMax()*60))},Math.ceil(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!0)}},{key:"onDisable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!1)}},{key:"destroy",value:function(){this._trailModel&&(this._particleSystem._getRenderScene().destroyModel(this._trailModel),this._trailModel=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.renderer.trailMaterial;e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===BH.World&&this._particleSystem._simulationSpace===BH.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(OK),this._particleSystem.node.getWorldRotation(RK)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);i||(i=this._trailSegments.alloc(),this._particleTrail.set(e,i));var n=i.getElement(i.end-1);if(this._needTransform?Xi.transformMat4(MK,e.position,OK):Xi.copy(MK,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),Xi.squaredDistance(n.position,MK)<this._minSquaredDistance))&&(n=i.addElement())){Xi.copy(n.position,MK),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);Xi.subtract(a.velocity,n.position,a.position)}else if(2<r){var s=i.getElement(i.end-2),o=i.getElement(i.end-3);Xi.subtract(MK,o.position,s.position),Xi.subtract(LK,n.position,s.position),Xi.subtract(s.velocity,LK,MK),Xi.equals(Xi.ZERO,s.velocity)&&Xi.copy(s.velocity,MK)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this._particleTrail.get(r);if(-1!==a.start){var s=4*this.vbOffset/this._vertSize,o=a.start>=a.end?a.end+a.trailElements.length:a.end,l=o-a.start,c=1/l,u=a.trailElements[a.start];this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1,1),s,1,0,4);for(var h=a.start+1;h<o;h++){var _=a.trailElements[h%a.trailElements.length],f=h-a.start;this._fillVertexBuffer(_,this.colorOverTrail.evaluate(1-f/l,1),s,1-f*c,f,5)}if(this._needTransform?Xi.transformMat4(kK.position,r.position,OK):Xi.copy(kK.position,r.position),1==l){var d=a.getElement(a.end-1);Xi.subtract(d.velocity,kK.position,d.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=d.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=d.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=d.velocity.z,this._vbF32[this.vbOffset-4]=d.velocity.x,this._vbF32[this.vbOffset-3]=d.velocity.y,this._vbF32[this.vbOffset-2]=d.velocity.z,Xi.subtract(kK.velocity,kK.position,d.position)}else if(2<l){var p=a.getElement(a.end-1),m=a.getElement(a.end-2);Xi.subtract(MK,m.position,p.position),Xi.subtract(LK,kK.position,p.position),Xi.subtract(p.velocity,LK,MK),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Xi.subtract(kK.velocity,kK.position,p.position)}kK.width=r.size.x,kK.color=r.color,Xi.equals(kK.velocity,Xi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(kK,this.colorOverTrail.evaluate(0,1),s,0,l,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&0<this._trailModel.subModelNum){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,t.inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=cc.director.root.device,t=e.createBuffer({usage:qs.VERTEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:qs.INDEX|qs.TRANSFER_DST,memUsage:Ks.HOST|Ks.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:qs.INDIRECT,memUsage:Ks.HOST|Ks.DEVICE,size:56,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:n,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Zt.GFXPrimitiveMode.TRIANGLE_LIST},this._trailModel=this._particleSystem._getRenderScene().createModel(CS,this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,IK.set(e.color),IK.multiply(t),this._vbUint32[this.vbOffset++]=IK._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=IK._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}}]),a}()).prototype,"enable",[gq],Object.getOwnPropertyDescriptor(Fq.prototype,"enable"),Fq.prototype),Pq=c(Fq.prototype,"_enable",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Dq=c(Fq.prototype,"mode",[bq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HH.Particles}}),zq=c(Fq.prototype,"lifeTime",[Sq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Bq=c(Fq.prototype,"_minParticleDistance",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),c(Fq.prototype,"minParticleDistance",[Tq],Object.getOwnPropertyDescriptor(Fq.prototype,"minParticleDistance"),Fq.prototype),c(Fq.prototype,"space",[xq],Object.getOwnPropertyDescriptor(Fq.prototype,"space"),Fq.prototype),Nq=c(Fq.prototype,"existWithParticles",[Eq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Uq=c(Fq.prototype,"textureMode",[wq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jH.Stretch}}),Gq=c(Fq.prototype,"widthFromParticle",[Aq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vq=c(Fq.prototype,"widthRatio",[Cq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),Hq=c(Fq.prototype,"colorFromParticle",[kq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jq=c(Fq.prototype,"colorOverTrail",[Rq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IH}}),Wq=c(Fq.prototype,"colorOvertime",[Oq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IH}}),Xq=c(Fq.prototype,"_space",[Mq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.World}}),qq=c(Fq.prototype,"_particleSystem",[Lq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Iq=Fq))||Iq),DK=new Nn,zK=(cY=Ca("cc.ParticleSystemComponent"),uY=Ia("Components/ParticleSystemComponent"),hY=Fa(99),_Y=ka({displayOrder:1}),fY=ka({type:IH,displayOrder:8}),dY=ka({type:BH,displayOrder:9}),pY=ka({type:RH,displayOrder:10}),mY=ka({type:RH,range:[-1,1],displayOrder:11}),vY=ka({type:RH,range:[-1,1],radian:!0,displayOrder:12}),yY=ka({type:RH,displayOrder:6}),gY=ka({type:RH,displayOrder:7}),bY=ka({displayOrder:0}),SY=ka({displayOrder:2}),TY=ka({displayOrder:3}),xY=ka({type:BH,displayOrder:4}),EY=ka({displayOrder:5}),wY=ka({displayOrder:2}),AY=ka({type:RH,range:[-1,1],displayOrder:13}),CY=ka({type:RH,displayOrder:14}),kY=ka({type:RH,displayOrder:15}),RY=ka({type:[qX],displayOrder:16}),OY=ka({type:zb,displayName:"Materials",visible:!1,override:!0}),MY=ka({type:zH,displayOrder:23}),LY=ka({type:ZX,displayOrder:17}),IY=ka({type:NX,displayOrder:21}),FY=ka({type:XX,displayOrder:18}),PY=ka({type:Ij,displayOrder:19}),DY=ka({type:Dj,displayOrder:20}),zY=ka({type:BX,displayOrder:22}),BY=ka({type:HX,displayOrder:24}),NY=ka({type:PK,displayOrder:25}),UY=ka({type:lY,displayOrder:26}),cY(GY=uY(GY=hY(GY=Ma((c((VY=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"startColor",HY,_(e)),m(e,"scaleSpace",jY,_(e)),m(e,"startSize",WY,_(e)),m(e,"startSpeed",XY,_(e)),m(e,"startRotation",qY,_(e)),m(e,"startDelay",YY,_(e)),m(e,"startLifetime",KY,_(e)),m(e,"duration",QY,_(e)),m(e,"loop",ZY,_(e)),m(e,"simulationSpeed",JY,_(e)),m(e,"playOnAwake",$Y,_(e)),m(e,"gravityModifier",eK,_(e)),m(e,"rateOverTime",tK,_(e)),m(e,"rateOverDistance",iK,_(e)),m(e,"bursts",nK,_(e)),m(e,"colorOverLifetimeModule",rK,_(e)),m(e,"shapeModule",aK,_(e)),m(e,"sizeOvertimeModule",sK,_(e)),m(e,"velocityOvertimeModule",oK,_(e)),m(e,"forceOvertimeModule",lK,_(e)),m(e,"limitVelocityOvertimeModule",cK,_(e)),m(e,"rotationOvertimeModule",uK,_(e)),m(e,"textureAnimationModule",hK,_(e)),m(e,"trailModule",_K,_(e)),m(e,"renderer",fK,_(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,m(e,"_prewarm",dK,_(e)),m(e,"_capacity",pK,_(e)),m(e,"_simulationSpace",mK,_(e)),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSize.constant=1,e.startSpeed.constant=1,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Xi,e._curWPos=new Xi,e._customData1=new Ui,e._customData2=new Ui,e._subEmitters=[],e}return d(t,RS),l(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return p(S(t.prototype),"sharedMaterials",this)},set:function(e){b(S(t.prototype),"sharedMaterials",e,this,!0)}}]),l(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.onInit(this),this.textureAnimationModule.onInit(this),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_getModel",value:function(){return this.renderer._model}},{key:"recreateModel",value:function(){if(this.isValid){var e=this.renderer;e&&e._model&&(e._model.destroy(),e._model=null,e.onEnable(),e._updateModel(),e._updateMaterialParams(),e._updateTrailMaterial())}}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.renderer.clear(),this.trailModule.clear())}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){Ui.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){Ui.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.visFlags=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var n=this.renderer._getFreeParticle();if(null===n)return;var r=Ii(Li(0,lt));switch(this.shapeModule.enable?this.shapeModule.emit(n):(Xi.set(n.position,0,0,0),Xi.copy(n.velocity,WH)),Xi.multiplyScalar(n.velocity,n.velocity,this.startSpeed.evaluate(this._time/this.duration,r)),this._simulationSpace){case BH.Local:break;case BH.World:this.node.getWorldMatrix(DK),Xi.transformMat4(n.position,n.position,DK);var a=new vn;this.node.getWorldRotation(a),Xi.transformQuat(n.velocity,n.velocity,a);break;case BH.Custom:}Xi.copy(n.ultimateVelocity,n.velocity),Xi.set(n.rotation,this.startRotation.evaluate(this._time/this.duration,r),0,0),Xi.set(n.startSize,this.startSize.evaluate(this._time/this.duration,r),1,1),n.startSize.y=n.startSize.x,Xi.copy(n.size,n.startSize),n.startColor.set(this.startColor.evaluate(this._time/this.duration,r)),n.color.set(n.startColor),n.startLifetime=this.startLifetime.evaluate(this._time/this.duration,r)+t,n.remainingLifetime=n.startLifetime,n.randomSeed=Li(0,233280),this.renderer._setNewParticle(n)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=kH.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=Xi.distance(this._curWPos,this._oldWPos);if(Xi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}var a=this.bursts,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),Xi.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[_Y],Object.getOwnPropertyDescriptor(VY.prototype,"capacity"),VY.prototype),HY=c(VY.prototype,"startColor",[fY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IH}}),jY=c(VY.prototype,"scaleSpace",[dY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.Local}}),WY=c(VY.prototype,"startSize",[pY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),XY=c(VY.prototype,"startSpeed",[mY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),qY=c(VY.prototype,"startRotation",[vY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),YY=c(VY.prototype,"startDelay",[yY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),KY=c(VY.prototype,"startLifetime",[gY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),QY=c(VY.prototype,"duration",[bY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ZY=c(VY.prototype,"loop",[SY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),c(VY.prototype,"prewarm",[TY],Object.getOwnPropertyDescriptor(VY.prototype,"prewarm"),VY.prototype),c(VY.prototype,"simulationSpace",[xY],Object.getOwnPropertyDescriptor(VY.prototype,"simulationSpace"),VY.prototype),JY=c(VY.prototype,"simulationSpeed",[EY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$Y=c(VY.prototype,"playOnAwake",[wY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eK=c(VY.prototype,"gravityModifier",[AY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),tK=c(VY.prototype,"rateOverTime",[CY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),iK=c(VY.prototype,"rateOverDistance",[kY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RH}}),nK=c(VY.prototype,"bursts",[RY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),c(VY.prototype,"sharedMaterials",[OY],Object.getOwnPropertyDescriptor(VY.prototype,"sharedMaterials"),VY.prototype),rK=c(VY.prototype,"colorOverLifetimeModule",[MY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zH}}),aK=c(VY.prototype,"shapeModule",[LY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZX}}),sK=c(VY.prototype,"sizeOvertimeModule",[IY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NX}}),oK=c(VY.prototype,"velocityOvertimeModule",[FY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XX}}),lK=c(VY.prototype,"forceOvertimeModule",[PY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ij}}),cK=c(VY.prototype,"limitVelocityOvertimeModule",[DY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Dj}}),uK=c(VY.prototype,"rotationOvertimeModule",[zY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BX}}),hK=c(VY.prototype,"textureAnimationModule",[BY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HX}}),_K=c(VY.prototype,"trailModule",[NY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new PK}}),fK=c(VY.prototype,"renderer",[UY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new lY}}),dK=c(VY.prototype,"_prewarm",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pK=c(VY.prototype,"_capacity",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),mK=c(VY.prototype,"_simulationSpace",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.Local}}),GY=VY))||GY)||GY)||GY)||GY),BK=function(){function e(){y(this,e)}return l(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Ze(function(){return cc.instantiate(e)},1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach(function(e){e.clear(function(e){e.destroy()})}),this.particleSystemPool.clear()}},{key:"play",value:function(e){var t=e.getComponentsInChildren(cc.ParticleSystemComponent),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(cc.ParticleSystemComponent),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.stop()}}}]),e}();BK.particleSystemPool=new Map,BK.registeredSceneEvent=!1;var NK,UK,GK,VK,HK,jK,WK,XK,qK,YK,KK,QK,ZK,JK,$K=(vK=Ca("cc.SphereLightComponent"),yK=Ia("Components/SphereLightComponent"),gK=ka({unit:"lm"}),bK=ka({unit:"cd/m²"}),SK=ka({type:gH}),vK(TK=yK(TK=Ma((EK=c((xK=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_size",EK,_(t)),m(t,"_luminance",wK,_(t)),m(t,"_term",AK,_(t)),m(t,"_range",CK,_(t)),t._type=Ox.SPHERE,t._light=null,t}return d(a,bH),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.sphereLights.find(function(e){return e===t._light})||(this._light=e.createSphereLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,p(S(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(e||(e=this._getRenderScene()),e.destroySphereLight(this._light),p(S(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*Fx(this._size)},set:function(e){this._luminance=e/Fx(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),a}()).prototype,"_size",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),wK=c(xK.prototype,"_luminance",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Fx(.15)}}),AK=c(xK.prototype,"_term",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gH.LUMINOUS_POWER}}),CK=c(xK.prototype,"_range",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(xK.prototype,"luminousPower",[gK],Object.getOwnPropertyDescriptor(xK.prototype,"luminousPower"),xK.prototype),c(xK.prototype,"luminance",[bK],Object.getOwnPropertyDescriptor(xK.prototype,"luminance"),xK.prototype),c(xK.prototype,"term",[SK],Object.getOwnPropertyDescriptor(xK.prototype,"term"),xK.prototype),c(xK.prototype,"size",[ka],Object.getOwnPropertyDescriptor(xK.prototype,"size"),xK.prototype),c(xK.prototype,"range",[ka],Object.getOwnPropertyDescriptor(xK.prototype,"range"),xK.prototype),TK=xK))||TK)||TK)||TK),eQ=(NK=Ca("cc.SpotLightComponent"),UK=Ia("Components/SpotLightComponent"),GK=ka({unit:"lm"}),VK=ka({unit:"cd/m²"}),HK=ka({type:gH}),jK=ka({slide:!0,range:[2,180,1]}),NK(WK=UK(WK=Ma((qK=c((XK=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_size",qK,_(t)),m(t,"_luminance",YK,_(t)),m(t,"_term",KK,_(t)),m(t,"_range",QK,_(t)),m(t,"_spotAngle",ZK,_(t)),t._type=Ox.SPOT,t._light=null,t}return d(a,bH),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e||(e=this._getRenderScene()),this._light&&e.spotLights.find(function(e){return e===t._light})||(this._light=e.createSpotLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,p(S(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(e||(e=this._getRenderScene()),e.destroySpotLight(this._light),p(S(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*Fx(this._size)},set:function(e){this._luminance=e/Fx(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=ki(e))}}]),a}()).prototype,"_size",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),YK=c(XK.prototype,"_luminance",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Fx(.15)}}),KK=c(XK.prototype,"_term",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gH.LUMINOUS_POWER}}),QK=c(XK.prototype,"_range",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZK=c(XK.prototype,"_spotAngle",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),c(XK.prototype,"luminousPower",[GK],Object.getOwnPropertyDescriptor(XK.prototype,"luminousPower"),XK.prototype),c(XK.prototype,"luminance",[VK],Object.getOwnPropertyDescriptor(XK.prototype,"luminance"),XK.prototype),c(XK.prototype,"term",[HK],Object.getOwnPropertyDescriptor(XK.prototype,"term"),XK.prototype),c(XK.prototype,"size",[ka],Object.getOwnPropertyDescriptor(XK.prototype,"size"),XK.prototype),c(XK.prototype,"range",[ka],Object.getOwnPropertyDescriptor(XK.prototype,"range"),XK.prototype),c(XK.prototype,"spotAngle",[jK],Object.getOwnPropertyDescriptor(XK.prototype,"spotAngle"),XK.prototype),WK=XK))||WK)||WK)||WK);cc.CameraComponent=yH,cc.EditorComponent=TH,cc.RenderableComponent=RS,cc.ModelComponent=rH,cc.SkinningModelComponent=aH,cc.AvatarModelComponent=uH,cc.AvatarUnit=oH,cc.BatchedSkinningModelComponent=pH,cc.SkinningModelUnit=dH,cc.LightComponent=bH,cc.DirectionalLightComponent=SH,cc.SphereLightComponent=$K,cc.SpotLightComponent=eQ,cc.ParticleSystemComponent=zK,cc.BillboardComponent=xH,cc.LineComponent=DH,cc.ParticleUtils=BK,cc.geometry=og,cc.utils=Ag;var tQ,iQ=Ca("cc.Counter")(JK=function(){function n(e,t,i){y(this,n),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}return l(n,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),l(n,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=this._opts.average?this._averageValue:this._value;return e?Math.round(100*t)/100:Math.round(t)}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}]),n}())||JK,nQ=Ca("cc.PerfCounter")(tQ=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._time=void 0,n._time=i,n}return d(r,iQ),l(r,[{key:"start",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,(this._opts.average||1e3)<i&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),r}())||tQ,rQ=function(){function e(){y(this,e),this._stats=null,this._showFPS=!1,this._fontSize=22,this._lineHeight=this._fontSize+2,this._left=10,this._right=10,this._top=10,this._bottom=10,this._rootNode=null,this._device=null,this._canvas=void 0,this._ctx=void 0,this._texture=null,this._textureView=null,this._region=new nl,this._canvasArr=[this._canvas],this._regionArr=[this._region],this._canvasDone=!1,this._statsDone=!1,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new nl}return l(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),cc.director.off(cc.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),cc.director.off(cc.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),cc.director.off(cc.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),cc.director.off(cc.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),cc.director.off(cc.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this.initDevice(),this.generateCanvas(),this.generateStats(),this._rootNode&&(this._rootNode.active=!0),cc.director.on(cc.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),cc.director.on(cc.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),cc.director.on(cc.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),cc.director.on(cc.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),cc.director.on(cc.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"initDevice",value:function(){this._device||(this._device=cc.director.root.device)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._canvas.width=350,this._canvas.height=200,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx&&(this._ctx.font="".concat(this._fontSize,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:So.TEX2D,usage:xo.SAMPLED,format:Zt.GFXFormat.RGBA8,width:350,height:200,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:Ro.TV2D,format:Zt.GFXFormat.RGBA8}),this._region.texExtent.width=350,this._region.texExtent.height=200)}}},{key:"generateStats",value:function(){if(!this._statsDone){this._stats=null;var e=cc.director.getCurrentTime(),t={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500},draws:{desc:"Draw call"},tricount:{desc:"Triangle"},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}};this._ctx.textAlign="left";for(var i=0,n=0,r=Object.keys(t);n<r.length;n++){var a=r[n];this._ctx.fillText(t[a].desc,this._left,this._top+i*this._lineHeight),t[a].counter=new nQ(a,t[a],e),i++}this._ctx.textAlign="end",this._stats=t}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new xf("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new xf("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=yH.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=TE.PROFILER,t.clearFlags=Zo.DEPTH|Zo.STENCIL,t.priority=1073741928;var i=new xf("Profiler_Root");i.parent=this._rootNode;var n=i.addComponent("cc.ModelComponent");n.mesh=ug({positions:[-.3,-.2,0,-.3,.2,0,.3,.2,0,.3,-.2,0],indices:[0,2,1,0,3,2],uvs:[0,1,0,0,1,0,1,1]});var r=new zb;r.initialize({effectName:"util/profiler"}),r.setProperty("offset",new $i(-.9,-.9,0,0));var a=r.passes[0],s=a.getBinding("mainTexture");a.bindTextureView(s,this._textureView),n.material=r,n.visibility=Xb.PROFILER}}},{key:"beforeUpdate",value:function(){if(this._stats){this.generateNode();var e=cc.director._lastUpdate;this.getCounter("frame").end(e),this.getCounter("frame").start(e),this.getCounter("logic").start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=cc.director.getCurrentTime();cc.director.isPaused()?this.getCounter("frame").start(e):this.getCounter("logic").end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=cc.director.getCurrentTime();this.getCounter("physics").start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=cc.director.getCurrentTime();this.getCounter("physics").end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=cc.director.getCurrentTime();this.getCounter("render").start(e)}}},{key:"afterDraw",value:function(){if(this._stats){var e=cc.director.getCurrentTime();this.getCounter("fps").frame(e),this.getCounter("draws").value=this._device.numDrawCalls,this.getCounter("bufferMemory").value=this._device.memoryStatus.bufferSize/1048576,this.getCounter("textureMemory").value=this._device.memoryStatus.textureSize/1048576,this.getCounter("tricount").value=this._device.numTris,this.getCounter("render").end(e);var t=this._left+this._ctx.measureText("GFX Texture Mem(M)").width;this._ctx.clearRect(t,0,this._canvas.width-t,this._canvas.height);for(var i=0,n=0,r=Object.keys(this._stats);n<r.length;n++){var a=r[n],s=this._stats[a];s.counter.sample(e),this._ctx.fillText(s.counter.human(!("Framerate (FPS)"===s.desc)),this._canvas.width-this._right,this._top+i*this._lineHeight),i++}this._canvasArr[0]=this._canvas,this.updateTexture()}}},{key:"getCounter",value:function(e){return this._stats[e].counter}},{key:"updateTexture",value:function(){cc.director.root.device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}]),e}(),aQ=new rQ;cc.profiler=aQ,cc.math=dr;var sQ=new Xi;cc.pipelineUtils={WorldNode3DToLocalNodeUI:function(e,t,i,n){n||(n=new Xi),e.worldToScreen(t,sQ),sQ.x=sQ.x/cc.view.getScaleX(),sQ.y=sQ.y/cc.view.getScaleY();var r=i.getComponent(cT);if(!r)return n;r.convertToNodeSpaceAR(sQ,n);var a=i.getPosition();return n.add(a),n},WorldNode3DToWorldNodeUI:function(e,t,i){return i||(i=new Xi),e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}},cc.RenderPassStage=Xp;var oQ=function(){function t(e){y(this,t),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}return l(t,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),t}();cc.NodePool=oQ;var lQ={};function cQ(e){return e*e}function uQ(e){return e*(2-e)}function hQ(e){return e*e*e}function _Q(e){return--e*e*e+1}function fQ(e){return e*e*e*e}function dQ(e){return 1- --e*e*e*e}function pQ(e){return e*e*e*e*e}function mQ(e){return--e*e*e*e*e+1}function vQ(e){return 1-Math.cos(e*Math.PI/2)}function yQ(e){return Math.sin(e*Math.PI/2)}function gQ(e){return 0===e?0:Math.pow(1024,e-1)}function bQ(e){return 1===e?1:1-Math.pow(2,-10*e)}function SQ(e){return 1-Math.sqrt(1-e*e)}function TQ(e){return Math.sqrt(1- --e*e)}function xQ(e){return e*e*(2.70158*e-1.70158)}function EQ(e){return--e*e*(2.70158*e+1.70158)+1}function wQ(e){return 1-AQ(1-e)}function AQ(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}Zt.replaceProperty(lQ,"vmath",[{name:"vec2",newName:"Vec2",target:dr,targetName:"math"},{name:"vec3",newName:"Vec3",target:dr,targetName:"math"},{name:"vec4",newName:"Vec4",target:dr,targetName:"math"},{name:"quat",newName:"Quat",target:dr,targetName:"math"},{name:"mat3",newName:"Mat3",target:dr,targetName:"math"},{name:"mat4",newName:"Mat4",target:dr,targetName:"math"},{name:"color4",newName:"Color",target:dr,targetName:"math"},{name:"rect",newName:"Rect",target:dr,targetName:"math"},{name:"approx",newName:"approx",target:dr,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:dr,targetName:"math"},{name:"equals",newName:"equals",target:dr,targetName:"math"},{name:"clamp",newName:"clamp",target:dr,targetName:"math"},{name:"clamp01",newName:"clamp01",target:dr,targetName:"math"},{name:"lerp",newName:"lerp",target:dr,targetName:"math"},{name:"toRadian",newName:"toRadian",target:dr,targetName:"math"},{name:"toDegree",newName:"toDegree",target:dr,targetName:"math"},{name:"random",newName:"random",target:dr,targetName:"math"},{name:"randomRange",newName:"randomRange",target:dr,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:dr,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:dr,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:dr,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:dr,targetName:"math"},{name:"repeat",newName:"repeat",target:dr,targetName:"math"},{name:"pingPong",newName:"pingPong",target:dr,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:dr,targetName:"math"}]),cc.vmath=lQ;var CQ=DQ(cQ,uQ),kQ=DQ(hQ,_Q),RQ=DQ(fQ,dQ),OQ=DQ(pQ,mQ),MQ=DQ(vQ,yQ),LQ=DQ(gQ,bQ),IQ=DQ(SQ,TQ),FQ=DQ(xQ,EQ),PQ=DQ(wQ,AQ);function DQ(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var zQ=Object.freeze({constant:function(){return 0},linear:function(e){return e},quadIn:cQ,quadOut:uQ,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:hQ,cubicOut:_Q,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:fQ,quartOut:dQ,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:pQ,quintOut:mQ,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:vQ,sineOut:yQ,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:gQ,expoOut:bQ,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:SQ,circOut:TQ,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},elasticOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},elasticInOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)},backIn:xQ,backOut:EQ,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)},bounceIn:wQ,bounceOut:AQ,bounceInOut:function(e){return e<.5?.5*wQ(2*e):.5*AQ(2*e-1)+.5},smooth:function(e){return e<=0?0:1<=e?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:CQ,cubicOutIn:kQ,quartOutIn:RQ,quintOutIn:OQ,sineOutIn:MQ,expoOutIn:LQ,circOutIn:IQ,backOutIn:FQ,bounceOutIn:PQ});function BQ(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}cc.bezier=BQ;var NQ=Math.cos,UQ=Math.acos,GQ=Math.max,VQ=2*Math.PI,HQ=Math.sqrt;function jQ(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function WQ(e,t){var i=function(e,t){var i,n,r,a,s=t-0,o=t-e[0],l=3*s,c=3*o,u=3*(t-e[2]),h=1/(c-s-u+(t-1)),_=(l-6*o+u)*h,f=1/3*_,d=(c-l)*h,p=1/3*(3*d-_*_),m=1/3*p,v=(2*_*_*_-9*_*d+s*h*27)/27,y=v/2,g=y*y+m*m*m;if(g<0){var b=1/3*-p,S=HQ(b*b*b),T=-v/(2*S),x=UQ(T<-1?-1:1<T?1:T),E=2*jQ(S);return n=E*NQ(x*(1/3))-f,r=E*NQ((x+VQ)*(1/3))-f,a=E*NQ((x+2*VQ)*(1/3))-f,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?GQ(n,r,a):GQ(n,r):0<=a&&a<=1?GQ(n,a):n:0<=r&&r<=1?0<=a&&a<=1?GQ(r,a):r:a}if(0==g)return r=-(i=y<0?jQ(-y):-jQ(y))-f,0<=(n=2*i-f)&&n<=1?0<=r&&r<=1?GQ(n,r):n:r;var w=HQ(g);return n=(i=jQ(-y+w))-jQ(y+w)-f}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}cc.bezierByTime=WQ;var XQ,qQ,YQ,KQ,QQ=1e-6;function ZQ(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+QQ<a)n=r-1;else{if(!(a<t-QQ))return r;i=r+1}}return~i}(qQ=XQ||(XQ={}))[qQ.Loop=2]="Loop",qQ[qQ.ShouldWrap=4]="ShouldWrap",qQ[qQ.PingPong=22]="PingPong",qQ[qQ.Reverse=36]="Reverse",(KQ=YQ||(YQ={}))[KQ.Default=0]="Default",KQ[KQ.Normal=1]="Normal",KQ[KQ.Reverse=XQ.Reverse]="Reverse",KQ[KQ.Loop=XQ.Loop]="Loop",KQ[KQ.LoopReverse=XQ.Loop|XQ.Reverse]="LoopReverse",KQ[KQ.PingPong=XQ.PingPong]="PingPong",KQ[KQ.PingPongReverse=XQ.PingPong|XQ.Reverse]="PingPongReverse",Rt(YQ);var JQ,$Q=function(){function t(e){y(this,t),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return l(t,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),t}();var eZ=function(){function s(e){var t,i;y(this,s),this.ratios=void 0;for(var n=!(this._findRatio=void 0),r=1,a=(this.ratios=e).length;r<a;r++)if(t=e[r]-e[r-1],1===r)i=t;else if(1e-6<Math.abs(t-i)){n=!1;break}this._findRatio=n?sZ:ZQ}return l(s,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),s}();cc.RatioSampler=eZ;var tZ=function(){function r(e,t){y(this,r),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._stepfiedValues=void 0,this._duration=void 0,this._duration=t,this._values=e.values;var i=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?r.Linear:r.Bezier(e):r.Linear};void 0!==e.easingMethod?this.type=i(e.easingMethod):void 0!==e.easingMethods?this.types=e.easingMethods.map(i):this.type=null;var n=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=fZ(n))}return l(r,null,[{key:"Bezier",value:function(e){return e}}]),l(r,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,s=r-i,o=(e-i)/s;a&&(o=aZ(o,a));var l=this._values[t],c=this._values[n];return this._lerp(l,c,o,s*this._duration)}return this.valueAt(t)}},{key:"empty",value:function(){return 0===this._values.length}}]),r}();tZ.Linear=null,cc.AnimCurve=tZ;var iZ=function(){function e(){y(this,e),this.events=[]}return l(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}(),nZ=Ca("cc.CurveValueAdapter")(JQ=function(){function e(){y(this,e)}return l(e,[{key:"forTarget",value:function(e){return{set:function(e){}}}}]),e}())||JQ;function rZ(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function aZ(e,t){if("string"==typeof t){var i=zQ[t];i?e=i(e):z(3906,t)}else Array.isArray(t)&&(e=WQ(t,e));return e}function sZ(e,t){var i=e.length-1;if(0==i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(r<t)return i;var a=(t=(t-n)/(r-n))/(1/i),s=0|a;return a-s<1e-6?s:1+s-a<1e-6?1+s:~(1+s)}cc.CurveValueAdapter=nZ,cc.sampleAnimationCurve=rZ;var oZ,lZ,cZ,uZ,hZ,_Z,fZ=function(){function t(e,t,i,n){return e.lerp(t,i,n)}return function(e){if(null!==e){if("number"==typeof e)return Ci;if("object"===fe(e)&&e.constructor){if(e instanceof Si)return function(n){var r=new n;return function(e,t,i){return n.lerp(r,e,t,i),r}}(e.constructor);if(e.constructor===Number)return Ci;if(function(e){return"function"==typeof e.lerp}(e))return t}}}}();function dZ(e){return"string"==typeof e}function pZ(e){return"number"==typeof e}function mZ(e,t){return e instanceof t}cc.isPropertyModifier=dZ,cc.isElementModifier=pZ,cc.isCustomTargetModifier=mZ;var vZ=Ca("cc.HierachyModifier")((cZ=c((lZ=function(){function t(e){y(this,t),m(this,"path",cZ,this),this.path=e||""}return l(t,[{key:"get",value:function(e){if(!(e instanceof xf))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getChildByPath(this.path);if(!t)throw new Error('Node "'.concat(e.name,'" has no path "').concat(this.path,'"'));return t}}]),t}()).prototype,"path",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oZ=lZ))||oZ;cc.HierachyModifier=vZ;var yZ=Ca("cc.ComponentModifier")((_Z=c((hZ=function(){function t(e){y(this,t),m(this,"component",_Z,this),this.component=e||""}return l(t,[{key:"get",value:function(e){if(!(e instanceof xf))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getComponent(this.component);if(!t)throw new Error('Node "'.concat(e.name,'" has no component "').concat(this.component,'"'));return t}}]),t}()).prototype,"component",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uZ=hZ))||uZ;cc.ComponentModifier=yZ;var gZ,bZ,SZ,TZ,xZ,EZ,wZ,AZ,CZ,kZ,RZ,OZ,MZ,LZ,IZ,FZ=function(){function s(e,t,i){var n;y(this,s),this._isProxy=void 0,this._assignmentOrProxy=void 0;for(var r=0;r<t.length;++r){var a=t[r];if(pZ(a)||dZ(a))if(r!==t.length-1||i){if(!(a in e))throw new Error('Target object has no property "'.concat(a,'"'));e=e[a]}else n=a;else e=a.get(e)}if(void 0!==n)this._assignmentOrProxy={object:e,propertyOrElement:n},this._isProxy=!1;else{if(!i)throw new Error("Bad animation curve.");this._assignmentOrProxy=i.forTarget(e),this._isProxy=!0}}return l(s,[{key:"setValue",value:function(e){this._isProxy?this._assignmentOrProxy.set(e):this._assignmentOrProxy.object[this._assignmentOrProxy.propertyOrElement]=e}}]),s}();cc.BoundTarget=FZ;var PZ=(gZ=Ca("cc.AnimationClip"),bZ=ka({visible:!1}),gZ((IZ=LZ=function(e){function o(){var e,t;y(this,o);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(o)).call.apply(e,[this].concat(n))),"sample",xZ,_(t)),m(t,"speed",EZ,_(t)),m(t,"wrapMode",wZ,_(t)),m(t,"curveDatas",AZ,_(t)),m(t,"_curves",CZ,_(t)),m(t,"events",kZ,_(t)),m(t,"_duration",RZ,_(t)),m(t,"_keys",OZ,_(t)),t._ratioSamplers=[],t._runtimeCurves=void 0,t._runtimeEvents=void 0,t.frameRate=0,m(t,"_stepness",MZ,_(t)),t._hash=0,t}return d(o,es),l(o,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._migrateCurveDatas()}},{key:"getPropertyCurves",value:function(e){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateCurveDatas",value:function(){this._migrateCurveDatas(),delete this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+1e-6<a)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"_createPropertyCurves",value:function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new eZ(e.map(function(e){return e/t._duration}))}),this._runtimeCurves=this._curves.map(function(e){return{curve:new tZ(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys]}}),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var n=this;var r=[],a=[],e=function(){if(o){if(l>=s.length)return"break";c=s[l++]}else{if((l=s.next()).done)return"break";c=l.value}var e=c,t=e.frame/n._duration,i=r.findIndex(function(e){return e===t});i<0&&(i=r.length,r.push(t),a.push({events:[]})),a[i].events.push({functionName:e.func,parameters:e.params})},s=this.events.sort(function(e,t){return e.frame-t.frame}),o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if("break"===e())break}this._runtimeEvents={ratios:r,eventGroups:a}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_migrateCurveDatas",value:function(){var _=this;if(this.curveDatas){for(var e=0,t=Object.keys(this.curveDatas);e<t.length;e++){var i=t[e],n=new vZ;n.path=i;var r=this.curveDatas[i];if(r.props)for(var a=0,s=Object.keys(r.props);a<s.length;a++){var o=s[a],l=r.props[o];this._curves.push({modifiers:[n,o],data:l})}if(r.comps)for(var c=0,u=Object.keys(r.comps);c<u.length;c++){var h=u[c],f=new yZ;f.component=h;for(var d=r.comps[h],p=0,m=Object.keys(d);p<m.length;p++){var v=m[p],y=d[v];this._curves.push({modifiers:[n,f,v],data:y})}}}delete this.curveDatas,Object.defineProperty(this,"curveDatas",{get:function(){var e={},t=_._curves,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(0!==a.modifiers.length&&mZ(a.modifiers[0],vZ)){var s=null,o=void 0;if(2===a.modifiers.length&&dZ(a.modifiers[1]))o=a.modifiers[1];else{if(3!==a.modifiers.length||!mZ(a.modifiers[1],yZ)||!dZ(a.modifiers[2]))continue;s=a.modifiers[1].component,o=a.modifiers[2]}var l=a.modifiers[0].path;l in e||(e[l]={});var c=e[l],u=void 0;if(s){"comps"in c||(c.comps={});var h=c.comps;s in h||(h[s]={}),u=h[s]}else"props"in c||(c.props={}),u=c.props;u[o]=a.data}}return e}})}}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){return this._hash||(this._hash=Bs(JSON.stringify(this.curveDatas),666)),this._hash}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}}],[{key:"createWithSpriteFrames",value:function(e,t){if(!Array.isArray(e))return z(3905),null;var i=new o;i.sample=t||i.sample,i.duration=e.length/i.sample;for(var n=1/i.sample,r=new Array(e.length),a=new Array(r.length),s=0;s<e.length;s++)r[s]=s*n,a[s]=e[s];return i.keys=[r],i.curveDatas={"/":{comps:{"cc.SpriteComponent":{spriteFrame:{keys:0,values:a}}}}},i}}]),o}(),LZ.WrapMode=YQ,xZ=c((TZ=IZ).prototype,"sample",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),EZ=c(TZ.prototype,"speed",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wZ=c(TZ.prototype,"wrapMode",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YQ.Normal}}),AZ=c(TZ.prototype,"curveDatas",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),CZ=c(TZ.prototype,"_curves",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kZ=c(TZ.prototype,"events",[bZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RZ=c(TZ.prototype,"_duration",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OZ=c(TZ.prototype,"_keys",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MZ=c(TZ.prototype,"_stepness",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SZ=TZ))||SZ);cc.AnimationClip=PZ;var DZ,zZ=function(){function e(){y(this,e),this._blendTargets=[]}return l(e,[{key:"refPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.find(function(e){return e.target===t});e||(e={target:t,properties:[]},this._blendTargets.push(e));var n=e.properties,r=n.find(function(e){return e.name===i});return r||(r={name:i,weight:0,value:void 0,refCount:0},n.push(r)),++r.refCount,r}},{key:"derefPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.findIndex(function(e){return e.target===t});if(!(e<0)){var n=this._blendTargets[e].properties,r=n.findIndex(function(e){return e.name===i});if(!(r<0)){var a=n[r];--a.refCount,0<a.refCount||(2<=n.length?n.splice(r,1):this._blendTargets.splice(e,1))}}}},{key:"apply",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.target,s=r.properties,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;0!==u.weight&&(a instanceof xf?"position"===u.name?a.setPosition(u.value):"rotation"===u.name?a.setRotation(u.value):a.setScale(u.value):a[u.name]=u.value)}}}},{key:"clear",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n.properties,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.weight=0}}}}]),e}(),BZ=Ca(DZ=function(){function e(){y(this,e),this._anims=new ae([]),this._delayEvents=[],this._blendState=new zZ,this._crossFades=[],cc.director._scheduler&&cc.director._scheduler.enableForTarget(this)}return l(e,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){oe(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update(e)}this._blendState.clear();var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var o=s[a.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var l=this._delayEvents,c=0,u=l.length;c<u;c++){var h=l[c];h.target[h.func].apply(h.target,h.args)}l.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);0<=t?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):z(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),e}())||DZ;cc.AnimationManager=BZ;var NZ,UZ,GZ=function(){function e(){y(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return l(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(V(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();function VZ(e,t,i){return i.value||(i.value=new Xi),0===i.weight&&Xi.zero(i.value),0===t?i.value:1===t?Xi.copy(i.value,e):Xi.scaleAndAdd(i.value,i.value,e,t)}function HZ(e,t,i){if(i.value||(i.value=new vn),0===i.weight&&vn.identity(i.value),0===t)return i.value;if(1===t)return vn.copy(i.value,e);var n=t/(i.weight+t);return vn.slerp(i.value,i.value,e,n)}(UZ=NZ||(NZ={}))[UZ.NodePosition=0]="NodePosition",UZ[UZ.NodeScale=1]="NodeScale",UZ[UZ.NodeRotation=2]="NodeRotation",UZ[UZ.None=3]="None";var jZ=function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(y(this,n),this._curve=void 0,this._boundTarget=void 0,this._curveValueProxy=void 0,this._rootTarget=void 0,this._rootTargetProperty=void 0,this._isNodeTarget=void 0,this._propertySpecialization=void 0,this._blendTarget=void 0,this._blendFunction=void 0,this._cached=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=new FZ(t,e.modifiers,e.valueAdapter),this._rootTarget=t,this._isNodeTarget=t instanceof xf,this._propertySpecialization=NZ.None,this._blendFunction=null,this._isNodeTarget&&1===e.modifiers.length)switch(e.modifiers[0]){case"position":this._propertySpecialization=NZ.NodePosition,this._blendFunction=VZ;break;case"rotation":this._propertySpecialization=NZ.NodeRotation,this._blendFunction=HZ;break;case"scale":this._propertySpecialization=NZ.NodeScale,this._blendFunction=VZ}this._blendTarget=i}return l(n,[{key:"attachToBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=e.refPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"dettachFromBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=null,e.derefPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){if(!this._blendFunction||!this._blendTarget||this._blendTarget.refCount<=1)switch(this._propertySpecialization){case NZ.NodePosition:this._rootTarget.setPosition(e);break;case NZ.NodeRotation:this._rootTarget.setRotation(e);break;case NZ.NodeScale:this._rootTarget.setScale(e);break;default:this._boundTarget.setValue(e)}else this._blendTarget.value=this._blendFunction(e,t,this._blendTarget),this._blendTarget.weight+=t}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),n}();var WZ,XZ,qZ,YZ,KZ,QZ=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._lastframeEventOn=!1,i._wrapMode=YQ.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new $Q,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._curveLoaded=!1,i._ignoreIndex=-1,i._clip=e,i._name=t||e&&e.name,i}return d(n,GZ),l(n,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&XQ.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&XQ.ShouldWrap,i=(this.wrapMode&XQ.Reverse)===XQ.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),l(n,[{key:"initialize",value:function(n){var r=this;if(!this._curveLoaded){this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=n;var e=this._clip;this.duration=e.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,(this.wrapMode&XQ.Loop)===XQ.Loop?this.repeatCount=1/0:this.repeatCount=1;for(var a=e.getPropertyCurves(n),t=function(e){var t=a[e],i=r._samplerSharedGroups.find(function(e){return e.sampler===t.sampler});i||(i=function(e){return{sampler:e,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}}}(t.sampler),r._samplerSharedGroups.push(i));try{i.curves.push(new jZ(t,n))}catch(e){}},i=0;i<a.length;++i)t(i)}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];cc.director.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var n=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,function(e){t.call(i,e),n._lastframeEventOn=!1})):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&XQ.PingPong)===XQ.PingPong&&(e-(0|e)==0&&0<e&&(e-=1),1&e&&(i=!i));return(t&XQ.Reverse)===XQ.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new $Q;var i=!1,n=this.duration,r=this.repeatCount,a=0<e?e/n:-e/n;if(r<=a){i=!0;var s=(a=r)-(0|r);0===s&&(s=1),e=s*n*(0<e?1:-1)}if(n<e){var o=e%n;e=0==o?n:o}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,c=this._wrapMode&XQ.ShouldWrap;c&&(l=this._needReverse(a));var u=l?-1:1;return this.speed<0&&(u*=-1),c&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=u,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new $Q(t),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.time,t=this.duration;t<e?0===(e%=t)&&(e=t):e<0&&0!==(e%=t)&&(e+=t);var i=e/t;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(0<this.time&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.attachToBlendState(e)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.dettachFromBlendState(e)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,cc.director.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||cc.director.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){cc.director.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){cc.director.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){for(var t=0,i=this._samplerSharedGroups.length;t<i;++t){var n=this._samplerSharedGroups[t],r=n.sampler,a=n.samplerResultCache,s=0,o=!1;r?(s=r.sample(e))<0&&((s=~s)<=0?s=0:s>=r.ratios.length?s=r.ratios.length-1:(o=!0,a.from=s-1,a.fromRatio=r.ratios[a.from],a.to=s,a.toRatio=r.ratios[a.to])):s=0;for(var l=0,c=n.curves.length;l<c;++l){n.curves[l].applySample(e,s,o,a,this.weight)}}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new $Q(e));var r=this.wrapMode,a=ZZ(e.iterations),s=this._lastWrapInfoEvent,o=ZZ(s.iterations),l=s.frameIndex,c=s.direction,u=-1!==o&&a!==o;if(l===n&&u&&1===t)this._fireEvent(0);else if(l!==n||u){i=c;do{if(l!==n){if(-1===i&&0===l&&0<n?((r&XQ.PingPong)===XQ.PingPong?i*=-1:l=t,o++):1===i&&l===t-1&&n<t-1&&((r&XQ.PingPong)===XQ.PingPong?i*=-1:l=-1,o++),l===n)break;if(a<o)break}l+=i,cc.director.getAnimationManager().pushDelayEvent(this,"_fireEvent",[l])}while(l!==n&&-1<l&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],n=this._targetNode.components,r=i.events,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=l.functionName,u=n,h=Array.isArray(u),_=0;for(u=h?u:u[Symbol.iterator]();;){var f;if(h){if(_>=u.length)break;f=u[_++]}else{if((_=u.next()).done)break;f=_.value}var d=f,p=d[c];"function"==typeof p&&p.apply(d,l.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),n}();function ZZ(e){return e-(0|e)==0&&(e-=1),0|e}function JZ(e,r,u,h){var t,i,a,s,o,_=new r,f=new r,d=new r;return Ca(e)((a=c((i=function(){function n(e,t,i){y(this,n),m(this,"dataPoint",a,this),m(this,"inTangent",s,this),m(this,"outTangent",o,this),this.dataPoint=e||new r,this.inTangent=t||new r,this.outTangent=i||new r}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint;f=u(f,this.outTangent,i),d=u(d,e.inTangent,i);var a=t*t*t,s=t*t,o=a-2*s+t,l=-2*a+3*s,c=a-s;return _=u(_,n,2*a-3*s+1),_=h(_,_,f,o),_=h(_,_,r,l),_=h(_,_,d,c)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),s=c(i.prototype,"inTangent",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),o=c(i.prototype,"outTangent",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),t=i))||t}cc.AnimationState=QZ;var $Z=JZ("cc.CubicSplineVec2Value",Ui,Ui.multiplyScalar,Ui.scaleAndAdd);cc.CubicSplineVec2Value=$Z;var eJ=JZ("cc.CubicSplineVec3Value",Xi,Xi.multiplyScalar,Xi.scaleAndAdd);cc.CubicSplineVec3Value=eJ;var tJ=JZ("cc.CubicSplineVec4Value",$i,$i.multiplyScalar,$i.scaleAndAdd);cc.CubicSplineVec4Value=tJ;var iJ=JZ("cc.CubicSplineQuatValue",vn,vn.multiplyScalar,vn.scaleAndAdd);cc.CubicSplineQuatValue=iJ;var nJ=Ca("cc.CubicSplineNumberValue")((qZ=c((XZ=function(){function n(e,t,i){y(this,n),m(this,"dataPoint",qZ,this),m(this,"inTangent",YZ,this),m(this,"outTangent",KZ,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,s=t*t;return n*(2*a-3*s+1)+this.outTangent*i*(a-2*s+t)+r*(-2*a+3*s)+e.inTangent*i*(a-s)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YZ=c(XZ.prototype,"inTangent",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KZ=c(XZ.prototype,"outTangent",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WZ=XZ))||WZ;cc.CubicSplineNumberValue=nJ;var rJ,aJ,sJ,oJ,lJ,cJ,uJ,hJ,_J,fJ,dJ,pJ,mJ,vJ,yJ=function(e){function i(){var e;return y(this,i),(e=T(this,S(i).call(this)))._managedStates=[],e._fadings=[],e}return d(i,GZ),l(i,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){if(0===n){r=a;break}var s=this._fadings[a];s.easeTime+=e;var o=Ai(s.easeTime/s.easeDuration),l=o*n;n*=1-o,s.target.state&&(s.target.state.weight+=l)}if(r!==this._fadings.length){for(var c=r;c<this._fadings.length;++c){var u=this._fadings[c];--u.target.reference,u.target.reference<=0&&(u.target.state&&u.target.state.stop(),oe(this._managedStates,u.target))}this._fadings.splice(r)}}}},{key:"crossFade",value:function(t,e){0===e&&this.clear();var i=this._managedStates.find(function(e){return e.state===t});i||(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}},{key:"onPlay",value:function(){p(S(i.prototype),"onPlay",this).call(this),cc.director.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){p(S(i.prototype),"onPause",this).call(this),cc.director.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}}},{key:"onResume",value:function(){p(S(i.prototype),"onResume",this).call(this),cc.director.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}}},{key:"onStop",value:function(){p(S(i.prototype),"onStop",this).call(this),cc.director.getAnimationManager().removeCrossFade(this),this.clear()}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}}]),i}();(vJ=Zt.EventType||(Zt.EventType={})).PLAY="play",vJ.STOP="stop",vJ.PAUSE="pause",vJ.RESUME="resume",vJ.LASTFRAME="lastframe",vJ.FINISHED="finished",Rt(Zt.EventType);var gJ=(rJ=Ca("cc.AnimationComponent"),aJ=Fa(99),sJ=Ia("Components/AnimationComponent"),oJ=ka({type:[PZ]}),lJ=ka({type:PZ}),cJ=ka({type:[PZ]}),rJ(uJ=aJ(uJ=Ma(uJ=sJ((mJ=pJ=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"playOnLoad",_J,_(t)),t._callbackTable=xe(!0),t._crossFade=new yJ,t._nameToState=xe(!0),m(t,"_clips",fJ,_(t)),m(t,"_defaultClip",dJ,_(t)),t}return d(a,R_),l(a,[{key:"onLoad",value:function(){this.clips=this._clips;for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}}},{key:"start",value:function(){this._crossFade.play(),this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade.stop();for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=null}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.3,i=this._nameToState[e];i&&this._crossFade.crossFade(i,t)}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return le(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(t,e){for(var i,n=0,r=Object.keys(this._nameToState);n<r.length;n++){var a=r[n];if((i=this._nameToState[a]).clip===t)break}if(t===this._defaultClip){if(!e)return void P(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void P(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var n=st.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var r=0,a=Object.keys(this._nameToState);r<a.length;r++){var s=a[r];this._nameToState[s]._lastframeEventOn=!0}return n}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var n=this._nameToState,r=0,a=Object.keys(n);r<a.length;r++){n[a[r]]._lastframeEventOn=!1}st.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_createState",value:function(e,t){return new QZ(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];xJ(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s&&this._removeStateOfAutomaticClip(s)}var o=e,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;h&&this.createState(h)}var _=e.find(function(e){return xJ(e,t._defaultClip)});this._defaultClip=_||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){(this._defaultClip=t)&&(0<=this._clips.findIndex(function(e){return xJ(e,t)})||(this._clips.push(t),this.createState(t)))}}]),a}(),pJ.EventType=Zt.EventType,c((hJ=mJ).prototype,"clips",[oJ],Object.getOwnPropertyDescriptor(hJ.prototype,"clips"),hJ.prototype),c(hJ.prototype,"defaultClip",[lJ],Object.getOwnPropertyDescriptor(hJ.prototype,"defaultClip"),hJ.prototype),_J=c(hJ.prototype,"playOnLoad",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fJ=c(hJ.prototype,"_clips",[cJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dJ=c(hJ.prototype,"_defaultClip",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uJ=hJ))||uJ)||uJ)||uJ)||uJ),bJ=gJ.prototype,SJ=bJ.on,TJ=bJ.off;function xJ(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}$a(gJ,[rt,st]),gJ.prototype.on=SJ,gJ.prototype.off=TJ,cc.AnimationComponent=gJ;var EJ,wJ=new Nn;function AJ(e,t){for(var i=e,n="";null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)}function CJ(e,t,i){for(Nn.identity(i);e!==t;)Nn.fromRTS(wJ,e.rotation,e.position,e.scale),Nn.multiply(i,wJ,i),e=e.parent}function kJ(e,t){if(!(e instanceof aH))return!1;var i=e.skinningRoot;if(i===t)return!0;if(i&&i.getComponent(gJ))return!1;for(var n=e.node;n&&!n.getComponent(gJ);)n=n.parent;return n===t}var RJ=Ca("cc.SkeletalAnimationClip")(EJ=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).convertedData={},t._converted=!1,t}return d(a,PZ),l(a,[{key:"getPropertyCurves",value:function(e){return this.hash,e.getComponent(cc.SkeletalAnimationComponent)?this._convertToSkeletalCurves(e):console.warn("skeletal clip in non-skeletal component"),p(S(a.prototype),"getPropertyCurves",this).call(this,e)}},{key:"_convertToSkeletalCurves",value:function(e){var i=this;if(!this._converted){var r={};this.curves.forEach(function(e){if(!e.valueAdapter&&mZ(e.modifiers[0],vZ)&&dZ(e.modifiers[1])){var t=e.modifiers[0].path,i=r[t];i||(i=r[t]={props:{}});var n=e.modifiers[1];i.props[n]=e.data}}),this.convertedData=r,this.curves=[];for(var t=new Array(Math.ceil(this.sample*this._duration/this.speed)+1),n=0;n<t.length;n++)t[n]=n;var a=Object.keys(this.convertedData).sort(),s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l,u=this.convertedData[c];if(u.props){var h=u.props,_=h.position,f=h.rotation,d=h.scale;this._convertToUniformSample(_,t),this._convertToUniformSample(f,t),this._convertToUniformSample(d,t),this._convertToWorldSpace(c,u.props)}}var p=[],m=e.getComponentsInChildren(RS),v=Array.isArray(m),y=0;for(m=v?m:m[Symbol.iterator]();;){var g;if(v){if(y>=m.length)break;g=m[y++]}else{if((y=m.next()).done)break;g=y.value}var b=g;if(kJ(b,e)){var S=AJ(b.node,e),T=Ee(b);p.push({modifiers:[new vZ(S),new yZ(T),"frameID"],data:{keys:0,values:t,interpolate:!1}})}}this.curves=p,this._keys=[t.map(function(e,t){return t*i.speed/i.sample})],this._duration=this._keys[0][t.length-1],this._converted=!0}}},{key:"_convertToUniformSample",value:function(a,e){var s=this,o=this._keys[a.keys];a.keys=0,a.values=e.map(function(e,t){if(!o||1===o.length)return a.values[0].clone();var i=t*s.speed/s.sample,n=o.findIndex(function(e){return i<e});n<0?(n=o.length-1,i=o[n]):0===n&&(n=1);var r=a.values[n-1].clone();return r.lerp(a.values[n],(i-o[n-1])/(o[n]-o[n-1])),r})}},{key:"_convertToWorldSpace",value:function(e,t){var i=t.position.values,n=t.rotation.values,r=t.scale.values,a=i.map(function(){return new Nn}),s=e.lastIndexOf("/"),o=null;if(0<s){var l=e.substring(0,s),c=this.convertedData[l];if(!c||!c.props)return void console.warn("no data for parent bone?");o=c.props.worldMatrix.values}for(var u=0;u<i.length;u++){var h=i[u],_=n[u],f=r[u],d=a[u];Nn.fromRTS(d,_,h,f),o&&Nn.multiply(d,o[u],d)}Object.keys(t).forEach(function(e){return delete t[e]}),t.worldMatrix={keys:0,interpolate:!1,values:a}}}]),a}())||EJ;cc.SkeletalAnimationClip=RJ;var OJ=new Nn;var MJ,LJ,IJ,FJ,PJ,DJ,zJ,BJ,NJ,UJ,GJ,VJ,HJ,jJ,WJ,XJ,qJ=function(e){function a(){return y(this,a),T(this,S(a).apply(this,arguments))}return d(a,QZ),l(a,[{key:"onPlay",value:function(){p(S(a.prototype),"onPlay",this).call(this);var e=this._targetNode.getComponentsInChildren(aH),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.skinningRoot===this._targetNode&&r.uploadAnimation(this.clip)}}},{key:"rebuildSocketCurves",value:function(e){if(this._samplerSharedGroups.length){for(var t,i=this._samplerSharedGroups[0].curves,n=0;n<i.length;n++){var r=i[n].curveDetail;3===(t=r.modifiers).length&&t[0]instanceof vZ&&t[1]instanceof yZ&&"frameID"===t[2]||i.splice(n--,1)}for(var a=0;a<e.length;++a){var s=this._buildSocketData(e[a]);s&&i.push(s)}}}},{key:"_buildSocketData",value:function(e){if(!this._targetNode)return null;var t=this._targetNode,i=t.getChildByPath(e.path);if(!i||!e.target)return null;for(var n=e.path,r=this.clip.convertedData,a=n,s=r[a],o=i;!s||!s.props;){var l=a.lastIndexOf("/");if(s=r[a=a.substring(0,l)],o=o.parent,l<0)return null}var c={matrix:{keys:0,interpolate:!1,values:s.props.worldMatrix.values.map(function(e){return e.clone()})}},u=c.matrix.values;CJ(i,o,OJ);for(var h=0;h<u.length;h++){var _=u[h];Nn.multiply(_,_,OJ)}var f=this.clip.duration,d=new vZ;return new jZ({curve:new tZ(c.matrix,f),modifiers:[d,"matrix"]},e.target)}}]),a}();cc.SkeletalAnimationState=qJ;var YJ=(MJ=Ca("cc.SkeletalAnimationComponent.Socket"),LJ=ka(xf),MJ((PJ=c((FJ=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;y(this,e),m(this,"path",PJ,this),m(this,"target",DJ,this),this.path=t,this.target=i}).prototype,"path",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DJ=c(FJ.prototype,"target",[LJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IJ=FJ))||IJ),KJ=new Nn;function QJ(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],n=0;n<e.children.length;n++){var r=e.children[n];if(r){var a=t?"".concat(t,"/").concat(r.name):r.name;i.push(a),QJ(r,a,i)}}return i}var ZJ,JJ,$J,e$,t$=(zJ=Ca("cc.SkeletalAnimationComponent"),BJ=Fa(99),NJ=Ia("Components/SkeletalAnimationComponent"),UJ=ka({type:[YJ]}),GJ=ka({type:[YJ]}),zJ(VJ=BJ(VJ=Ma(VJ=NJ((XJ=WJ=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_sockets",jJ,_(t)),t}return d(a,gJ),l(a,[{key:"start",value:function(){p(S(a.prototype),"start",this).call(this),this.sockets=this._sockets}},{key:"querySockets",value:function(){var e=[];if(!this._defaultClip)return e;for(var t=Object.keys(this._defaultClip.convertedData).sort().reduce(function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e},[]),i=0;i<t.length;i++){var n=t[i],r=this.node.getChildByPath(n);r&&(e.push(n),QJ(r,n,e))}return e}},{key:"rebuildSocketAnimations",value:function(){var e=this._sockets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this.node.getChildByPath(r.path),s=r.target;a&&s&&(s.name="".concat(r.path.substring(r.path.lastIndexOf("/")+1)," Socket"),s.parent=this.node,CJ(a,this.node,KJ),s.matrix=KJ)}for(var o=0,l=Object.keys(this._nameToState);o<l.length;o++){var c=l[o];this._nameToState[c].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(t){var e=this._sockets.find(function(e){return e.path===t});if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new cc.Node;return i.parent=this.node,this._sockets.push(new YJ(t,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new qJ(e,t)}},{key:"_doCreateState",value:function(e,t){e instanceof RJ||console.warn("non-skeletal clip in skeletal component");var i=p(S(a.prototype),"_doCreateState",this).call(this,e,t);return i.rebuildSocketCurves(this._sockets),i}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this.rebuildSocketAnimations()}}]),a}(),WJ.Socket=YJ,jJ=c((HJ=XJ).prototype,"_sockets",[UJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(HJ.prototype,"sockets",[GJ],Object.getOwnPropertyDescriptor(HJ.prototype,"sockets"),HJ.prototype),VJ=HJ))||VJ)||VJ)||VJ)||VJ);cc.SkeletalAnimationComponent=t$;var i$=Ca("cc.UniformCurveValueAdapter")(($J=c((JJ=function(e){function t(){var e;return y(this,t),m(e=T(this,S(t).call(this)),"passIndex",$J,_(e)),m(e,"uniformName",e$,_(e)),e}return d(t,nZ),l(t,[{key:"forTarget",value:function(e){var t=e.passes[this.passIndex],i=t.getHandle(this.uniformName);if(void 0===i)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));return{set:function(e){t.setUniform(i,e)}}}}]),t}()).prototype,"passIndex",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e$=c(JJ.prototype,"uniformName",[ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZJ=JJ))||ZJ;cc.UniformCurveValueAdapter=i$,Zt.replaceProperty(gJ.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return gJ.prototype.removeState.call(this,e.name)}}]),cc.easing=zQ,cc.renderer=pP;var n$=cc;cc.primitives=Ww;var r$,a$,s$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.BINDING_LAYOUT)))._device=void 0,t._bindingUnits=[],t._isDirty=!1,t._device=e,t}return d(i,$o),l(i,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Io.UNIFORM_BUFFER?s.buffer!==t&&(s.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Io.SAMPLER?s.sampler!==t&&(s.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Io.SAMPLER?s.texView!==t&&(s.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.binding===e)return a}return null}}]),i}(),o$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuBindingLayout=null,t}return d(i,s$),l(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),l(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.type,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.type,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=Gs.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case Io.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case Io.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}();function l$(e,t){switch(e){case Zt.GFXFormat.R8:return t.UNSIGNED_BYTE;case Zt.GFXFormat.R8SN:return t.BYTE;case Zt.GFXFormat.R8UI:return t.UNSIGNED_BYTE;case Zt.GFXFormat.R8I:return t.BYTE;case Zt.GFXFormat.R16F:return r$.HALF_FLOAT_OES;case Zt.GFXFormat.R16UI:return t.UNSIGNED_SHORT;case Zt.GFXFormat.R16I:return t.SHORT;case Zt.GFXFormat.R32F:return t.FLOAT;case Zt.GFXFormat.R32UI:return t.UNSIGNED_INT;case Zt.GFXFormat.R32I:return t.INT;case Zt.GFXFormat.RG8:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RG8SN:return t.BYTE;case Zt.GFXFormat.RG8UI:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RG8I:return t.BYTE;case Zt.GFXFormat.RG16F:return r$.HALF_FLOAT_OES;case Zt.GFXFormat.RG16UI:return t.UNSIGNED_SHORT;case Zt.GFXFormat.RG16I:return t.SHORT;case Zt.GFXFormat.RG32F:return t.FLOAT;case Zt.GFXFormat.RG32UI:return t.UNSIGNED_INT;case Zt.GFXFormat.RG32I:return t.INT;case Zt.GFXFormat.RGB8:case Zt.GFXFormat.SRGB8:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RGB8SN:return t.BYTE;case Zt.GFXFormat.RGB8UI:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RGB8I:return t.BYTE;case Zt.GFXFormat.RGB16F:return r$.HALF_FLOAT_OES;case Zt.GFXFormat.RGB16UI:return t.UNSIGNED_SHORT;case Zt.GFXFormat.RGB16I:return t.SHORT;case Zt.GFXFormat.RGB32F:return t.FLOAT;case Zt.GFXFormat.RGB32UI:return t.UNSIGNED_INT;case Zt.GFXFormat.RGB32I:return t.INT;case Zt.GFXFormat.RGBA8:case Zt.GFXFormat.SRGB8_A8:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RGBA8SN:return t.BYTE;case Zt.GFXFormat.RGBA8UI:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RGBA8I:return t.BYTE;case Zt.GFXFormat.RGBA16F:return r$.HALF_FLOAT_OES;case Zt.GFXFormat.RGBA16UI:return t.UNSIGNED_SHORT;case Zt.GFXFormat.RGBA16I:return t.SHORT;case Zt.GFXFormat.RGBA32F:return t.FLOAT;case Zt.GFXFormat.RGBA32UI:return t.UNSIGNED_INT;case Zt.GFXFormat.RGBA32I:return t.INT;case Zt.GFXFormat.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Zt.GFXFormat.R11G11B10F:return t.FLOAT;case Zt.GFXFormat.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Zt.GFXFormat.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Zt.GFXFormat.RGB10A2:return t.UNSIGNED_BYTE;case Zt.GFXFormat.RGB10A2UI:return t.UNSIGNED_INT;case Zt.GFXFormat.RGB9E5:return t.UNSIGNED_BYTE;case Zt.GFXFormat.D16:case Zt.GFXFormat.D16S8:return t.UNSIGNED_SHORT;case Zt.GFXFormat.D24:return t.UNSIGNED_INT;case Zt.GFXFormat.D24S8:return r$.UNSIGNED_INT_24_8_WEBGL;case Zt.GFXFormat.D32F:case Zt.GFXFormat.D32F_S8:return t.FLOAT;case Zt.GFXFormat.BC1:case Zt.GFXFormat.BC1_SRGB:case Zt.GFXFormat.BC2:case Zt.GFXFormat.BC2_SRGB:case Zt.GFXFormat.BC3:case Zt.GFXFormat.BC3_SRGB:case Zt.GFXFormat.BC4:return t.UNSIGNED_BYTE;case Zt.GFXFormat.BC4_SNORM:return t.BYTE;case Zt.GFXFormat.BC5:return t.UNSIGNED_BYTE;case Zt.GFXFormat.BC5_SNORM:return t.BYTE;case Zt.GFXFormat.BC6H_SF16:case Zt.GFXFormat.BC6H_UF16:return t.FLOAT;case Zt.GFXFormat.BC7:case Zt.GFXFormat.BC7_SRGB:case Zt.GFXFormat.ETC_RGB8:case Zt.GFXFormat.ETC2_RGB8:case Zt.GFXFormat.ETC2_SRGB8:case Zt.GFXFormat.ETC2_RGB8_A1:case Zt.GFXFormat.ETC2_SRGB8_A1:case Zt.GFXFormat.ETC2_RGB8:case Zt.GFXFormat.ETC2_SRGB8:case Zt.GFXFormat.EAC_R11:return t.UNSIGNED_BYTE;case Zt.GFXFormat.EAC_R11SN:return t.BYTE;case Zt.GFXFormat.EAC_RG11:return t.UNSIGNED_BYTE;case Zt.GFXFormat.EAC_RG11SN:return t.BYTE;case Zt.GFXFormat.PVRTC_RGB2:case Zt.GFXFormat.PVRTC_RGBA2:case Zt.GFXFormat.PVRTC_RGB4:case Zt.GFXFormat.PVRTC_RGBA4:case Zt.GFXFormat.PVRTC2_2BPP:case Zt.GFXFormat.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function c$(e,t){switch(e){case Zt.GFXFormat.A8:return t.ALPHA;case Zt.GFXFormat.L8:return t.LUMINANCE;case Zt.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case Zt.GFXFormat.RGB8:case Zt.GFXFormat.RGB16F:case Zt.GFXFormat.RGB32F:return t.RGB;case Zt.GFXFormat.RGBA8:case Zt.GFXFormat.RGBA16F:case Zt.GFXFormat.RGBA32F:return t.RGBA;case Zt.GFXFormat.R5G6B5:return t.RGB565;case Zt.GFXFormat.RGB5A1:return t.RGB5_A1;case Zt.GFXFormat.RGBA4:return t.RGBA4;case Zt.GFXFormat.D16:return t.DEPTH_COMPONENT;case Zt.GFXFormat.D16S8:return t.DEPTH_STENCIL;case Zt.GFXFormat.D24:return t.DEPTH_COMPONENT;case Zt.GFXFormat.D24S8:return t.DEPTH_STENCIL;case Zt.GFXFormat.D32F:return t.DEPTH_COMPONENT;case Zt.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case Zt.GFXFormat.BC1:return r$.COMPRESSED_RGB_S3TC_DXT1_EXT;case Zt.GFXFormat.BC1_ALPHA:return r$.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Zt.GFXFormat.BC1_SRGB:return r$.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Zt.GFXFormat.BC1_SRGB_ALPHA:return r$.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Zt.GFXFormat.BC2:return r$.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Zt.GFXFormat.BC2_SRGB:return r$.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Zt.GFXFormat.BC3:return r$.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Zt.GFXFormat.BC3_SRGB:return r$.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Zt.GFXFormat.ETC_RGB8:return r$.COMPRESSED_RGB_ETC1_WEBGL;case Zt.GFXFormat.PVRTC_RGB2:return r$.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Zt.GFXFormat.PVRTC_RGBA2:return r$.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Zt.GFXFormat.PVRTC_RGB4:return r$.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Zt.GFXFormat.PVRTC_RGBA4:return r$.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function u$(e,t){switch(e){case Zt.GFXFormat.A8:return t.ALPHA;case Zt.GFXFormat.L8:return t.LUMINANCE;case Zt.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case Zt.GFXFormat.RGB8:case Zt.GFXFormat.RGB16F:case Zt.GFXFormat.RGB32F:return t.RGB;case Zt.GFXFormat.RGBA8:case Zt.GFXFormat.RGBA16F:case Zt.GFXFormat.RGBA32F:return t.RGBA;case Zt.GFXFormat.R5G6B5:return t.RGB;case Zt.GFXFormat.RGB5A1:case Zt.GFXFormat.RGBA4:return t.RGBA;case Zt.GFXFormat.D16:return t.DEPTH_COMPONENT;case Zt.GFXFormat.D16S8:return t.DEPTH_STENCIL;case Zt.GFXFormat.D24:return t.DEPTH_COMPONENT;case Zt.GFXFormat.D24S8:return t.DEPTH_STENCIL;case Zt.GFXFormat.D32F:return t.DEPTH_COMPONENT;case Zt.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case Zt.GFXFormat.BC1:return r$.COMPRESSED_RGB_S3TC_DXT1_EXT;case Zt.GFXFormat.BC1_ALPHA:return r$.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Zt.GFXFormat.BC1_SRGB:return r$.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Zt.GFXFormat.BC1_SRGB_ALPHA:return r$.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Zt.GFXFormat.BC2:return r$.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Zt.GFXFormat.BC2_SRGB:return r$.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Zt.GFXFormat.BC3:return r$.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Zt.GFXFormat.BC3_SRGB:return r$.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Zt.GFXFormat.ETC_RGB8:return r$.COMPRESSED_RGB_ETC1_WEBGL;case Zt.GFXFormat.ETC2_RGB8:return r$.COMPRESSED_RGB8_ETC2;case Zt.GFXFormat.ETC2_SRGB8:return r$.COMPRESSED_SRGB8_ETC2;case Zt.GFXFormat.ETC2_RGB8_A1:return r$.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zt.GFXFormat.ETC2_SRGB8_A1:return r$.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zt.GFXFormat.ETC2_RGBA8:return r$.COMPRESSED_RGBA8_ETC2_EAC;case Zt.GFXFormat.ETC2_SRGB8_A8:return r$.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Zt.GFXFormat.EAC_R11:return r$.COMPRESSED_R11_EAC;case Zt.GFXFormat.EAC_R11SN:return r$.COMPRESSED_SIGNED_R11_EAC;case Zt.GFXFormat.EAC_RG11:return r$.COMPRESSED_RG11_EAC;case Zt.GFXFormat.EAC_RG11SN:return r$.COMPRESSED_SIGNED_RG11_EAC;case Zt.GFXFormat.PVRTC_RGB2:return r$.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Zt.GFXFormat.PVRTC_RGBA2:return r$.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Zt.GFXFormat.PVRTC_RGB4:return r$.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Zt.GFXFormat.PVRTC_RGBA4:return r$.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function h$(e,t){switch(e){case js.BOOL:return t.BOOL;case js.BOOL2:return t.BOOL_VEC2;case js.BOOL3:return t.BOOL_VEC3;case js.BOOL4:return t.BOOL_VEC4;case js.INT:return t.INT;case js.INT2:return t.INT_VEC2;case js.INT3:return t.INT_VEC3;case js.INT4:return t.INT_VEC4;case js.UINT:return t.UNSIGNED_INT;case js.FLOAT:return t.FLOAT;case js.FLOAT2:return t.FLOAT_VEC2;case js.FLOAT3:return t.FLOAT_VEC3;case js.FLOAT4:return t.FLOAT_VEC4;case js.MAT2:return t.FLOAT_MAT2;case js.MAT3:return t.FLOAT_MAT3;case js.MAT4:return t.FLOAT_MAT4;case js.SAMPLER2D:return t.SAMPLER_2D;case js.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),js.UNKNOWN}}function _$(e,t){switch(e){case t.BOOL:return js.BOOL;case t.BOOL_VEC2:return js.BOOL2;case t.BOOL_VEC3:return js.BOOL3;case t.BOOL_VEC4:return js.BOOL4;case t.INT:return js.INT;case t.INT_VEC2:return js.INT2;case t.INT_VEC3:return js.INT3;case t.INT_VEC4:return js.INT4;case t.UNSIGNED_INT:return js.UINT;case t.FLOAT:return js.FLOAT;case t.FLOAT_VEC2:return js.FLOAT2;case t.FLOAT_VEC3:return js.FLOAT3;case t.FLOAT_VEC4:return js.FLOAT4;case t.FLOAT_MAT2:return js.MAT2;case t.FLOAT_MAT3:return js.MAT3;case t.FLOAT_MAT4:return js.MAT4;case t.SAMPLER_2D:return js.SAMPLER2D;case t.SAMPLER_CUBE:return js.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),js.UNKNOWN}}function f$(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function d$(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}(a$=r$||(r$={}))[a$.RGBA16F_EXT=34842]="RGBA16F_EXT",a$[a$.RGB16F_EXT=34843]="RGB16F_EXT",a$[a$.RGBA32F_EXT=34836]="RGBA32F_EXT",a$[a$.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",a$[a$.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",a$[a$.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",a$[a$.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",a$[a$.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",a$[a$.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",a$[a$.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",a$[a$.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",a$[a$.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",a$[a$.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",a$[a$.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",a$[a$.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",a$[a$.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",a$[a$.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",a$[a$.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",a$[a$.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",a$[a$.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",a$[a$.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",a$[a$.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",a$[a$.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",a$[a$.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",a$[a$.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",a$[a$.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",a$[a$.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",a$[a$.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",a$[a$.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",a$[a$.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC";var p$,m$,v$=[512,513,514,515,516,517,518,519],y$=[0,7680,7681,7682,7683,5386,34055,34056],g$=[32774,32778,32779,32774,32774],b$=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(m$=p$||(p$={}))[m$.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",m$[m$.END_RENDER_PASS=1]="END_RENDER_PASS",m$[m$.BIND_STATES=2]="BIND_STATES",m$[m$.DRAW=3]="DRAW",m$[m$.UPDATE_BUFFER=4]="UPDATE_BUFFER",m$[m$.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",m$[m$.COUNT=6]="COUNT";var S$=function e(t){y(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},T$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,p$.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=Zo.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return d(t,S$),l(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),x$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,p$.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return d(t,S$),l(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),E$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,p$.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return d(t,S$),l(t,[{key:"clear",value:function(){}}]),t}(),w$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,p$.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return d(t,S$),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),A$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,p$.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return d(t,S$),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),C$=function(){function e(){y(this,e),this.cmds=new qx(1),this.beginRenderPassCmds=new qx(1),this.bindStatesCmds=new qx(1),this.drawCmds=new qx(1),this.updateBufferCmds=new qx(1),this.copyBufferToTextureCmds=new qx(1)}return l(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function k$(e,t,i,n,r){if(t.usage&qs.UNIFORM)i instanceof Float32Array?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&qs.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r))}}var R$=new Array(p$.COUNT);function O$(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<p$.COUNT;++r)R$[r]=0;for(var a,s,o,l=null,c=null,u=!1,h=null,_=i.TRIANGLES,f=0;f<t.cmds.length;++f){var d=t.cmds.array[f],p=R$[d]++;switch(d){case p$.BEGIN_RENDER_PASS:var m=t.beginRenderPassCmds.array[p],v=0;if(m.gpuFramebuffer){n.glFramebuffer!==m.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,m.gpuFramebuffer.glFramebuffer),n.glFramebuffer=m.gpuFramebuffer.glFramebuffer),n.viewport.left===m.renderArea.x&&n.viewport.top===m.renderArea.y&&n.viewport.width===m.renderArea.width&&n.viewport.height===m.renderArea.height||(i.viewport(m.renderArea.x,m.renderArea.y,m.renderArea.width,m.renderArea.height),n.viewport.left=m.renderArea.x,n.viewport.top=m.renderArea.y,n.viewport.width=m.renderArea.width,n.viewport.height=m.renderArea.height),n.scissorRect.x===m.renderArea.x&&n.scissorRect.y===m.renderArea.y&&n.scissorRect.width===m.renderArea.width&&n.scissorRect.height===m.renderArea.height||(i.scissor(m.renderArea.x,m.renderArea.y,m.renderArea.width,m.renderArea.height),n.scissorRect.x=m.renderArea.x,n.scissorRect.y=m.renderArea.y,n.scissorRect.width=m.renderArea.width,n.scissorRect.height=m.renderArea.height);var y=m.gpuFramebuffer.gpuRenderPass,g=m.clearColors.length;e.WEBGL_draw_buffers||(g=1);for(var b=0;b<g;++b){var S=y.colorAttachments[b];if(S.format!==Zt.GFXFormat.UNKNOWN)switch(S.loadOp){case zo.LOAD:break;case zo.CLEAR:if(m.clearFlag&Zo.COLOR){n.bs.targets[0].blendColorMask!==po.ALL&&i.colorMask(!0,!0,!0,!0);var T=m.clearColors[0];i.clearColor(T.r,T.g,T.b,T.a),v|=i.COLOR_BUFFER_BIT}break;case zo.DISCARD:}}if(y.depthStencilAttachment&&y.depthStencilAttachment.format!==Zt.GFXFormat.UNKNOWN){switch(y.depthStencilAttachment.depthLoadOp){case zo.LOAD:break;case zo.CLEAR:m.clearFlag&Zo.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(m.clearDepth),v|=i.DEPTH_BUFFER_BIT);break;case zo.DISCARD:}if(rl[y.depthStencilAttachment.format].hasStencil)switch(y.depthStencilAttachment.stencilLoadOp){case zo.LOAD:break;case zo.CLEAR:m.clearFlag&Zo.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(m.clearStencil),v|=i.STENCIL_BUFFER_BIT);break;case zo.DISCARD:}}if(v&&i.clear(v),v&i.COLOR_BUFFER_BIT){var x=n.bs.targets[0].blendColorMask;if(x!==po.ALL){var E=(x&po.R)!==po.NONE,w=(x&po.G)!==po.NONE,A=(x&po.B)!==po.NONE,C=(x&po.A)!==po.NONE;i.colorMask(E,w,A,C)}}v&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),v&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case p$.BIND_STATES:var k=t.bindStatesCmds.array[p];if(u=!1,k.gpuPipelineState){if(l=k.gpuPipelineState,_=k.gpuPipelineState.glPrimitive,k.gpuPipelineState.gpuShader){var R=k.gpuPipelineState.gpuShader.glProgram;n.glProgram!==R&&(i.useProgram(R),n.glProgram=R,u=!0),c=k.gpuPipelineState.gpuShader}var O=k.gpuPipelineState.rs;if(O){if(n.rs.cullMode!==O.cullMode){switch(O.cullMode){case ro.NONE:i.disable(i.CULL_FACE);break;case ro.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case ro.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}n.rs.cullMode=O.cullMode}n.rs.isFrontFaceCCW!==O.isFrontFaceCCW&&(i.frontFace(O.isFrontFaceCCW?i.CCW:i.CW),n.rs.isFrontFaceCCW=O.isFrontFaceCCW),n.rs.depthBias===O.depthBias&&n.rs.depthBiasSlop===O.depthBiasSlop||(i.polygonOffset(O.depthBias,O.depthBiasSlop),n.rs.depthBias=O.depthBias,n.rs.depthBiasSlop=O.depthBiasSlop),n.rs.lineWidth!==O.lineWidth&&(i.lineWidth(O.lineWidth),n.rs.lineWidth=O.lineWidth)}var M=k.gpuPipelineState.dss;M&&(n.dss.depthTest!==M.depthTest&&(M.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=M.depthTest),n.dss.depthWrite!==M.depthWrite&&(i.depthMask(M.depthWrite),n.dss.depthWrite=M.depthWrite),n.dss.depthFunc!==M.depthFunc&&(i.depthFunc(v$[M.depthFunc]),n.dss.depthFunc=M.depthFunc),n.dss.stencilTestFront===M.stencilTestFront&&n.dss.stencilTestBack===M.stencilTestBack||(M.stencilTestFront||M.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=M.stencilTestFront,n.dss.stencilTestBack=M.stencilTestBack),n.dss.stencilFuncFront===M.stencilFuncFront&&n.dss.stencilRefFront===M.stencilRefFront&&n.dss.stencilReadMaskFront===M.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,v$[M.stencilFuncFront],M.stencilRefFront,M.stencilReadMaskFront),n.dss.stencilFuncFront=M.stencilFuncFront,n.dss.stencilRefFront=M.stencilRefFront,n.dss.stencilReadMaskFront=M.stencilReadMaskFront),n.dss.stencilFailOpFront===M.stencilFailOpFront&&n.dss.stencilZFailOpFront===M.stencilZFailOpFront&&n.dss.stencilPassOpFront===M.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,y$[M.stencilFailOpFront],y$[M.stencilZFailOpFront],y$[M.stencilPassOpFront]),n.dss.stencilFailOpFront=M.stencilFailOpFront,n.dss.stencilZFailOpFront=M.stencilZFailOpFront,n.dss.stencilPassOpFront=M.stencilPassOpFront),n.dss.stencilWriteMaskFront!==M.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,M.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=M.stencilWriteMaskFront),n.dss.stencilFuncBack===M.stencilFuncBack&&n.dss.stencilRefBack===M.stencilRefBack&&n.dss.stencilReadMaskBack===M.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,v$[M.stencilFuncBack],M.stencilRefBack,M.stencilReadMaskBack),n.dss.stencilFuncBack=M.stencilFuncBack,n.dss.stencilRefBack=M.stencilRefBack,n.dss.stencilReadMaskBack=M.stencilReadMaskBack),n.dss.stencilFailOpBack===M.stencilFailOpBack&&n.dss.stencilZFailOpBack===M.stencilZFailOpBack&&n.dss.stencilPassOpBack===M.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,y$[M.stencilFailOpBack],y$[M.stencilZFailOpBack],y$[M.stencilPassOpBack]),n.dss.stencilFailOpBack=M.stencilFailOpBack,n.dss.stencilZFailOpBack=M.stencilZFailOpBack,n.dss.stencilPassOpBack=M.stencilPassOpBack),n.dss.stencilWriteMaskBack!==M.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,M.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=M.stencilWriteMaskBack));var L=k.gpuPipelineState.bs;if(L){n.bs.isA2C!==L.isA2C&&(L.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=L.isA2C),n.bs.blendColor[0]===L.blendColor[0]&&n.bs.blendColor[1]===L.blendColor[1]&&n.bs.blendColor[2]===L.blendColor[2]&&n.bs.blendColor[3]===L.blendColor[3]||(i.blendColor(L.blendColor[0],L.blendColor[1],L.blendColor[2],L.blendColor[3]),n.bs.blendColor[0]=L.blendColor[0],n.bs.blendColor[1]=L.blendColor[1],n.bs.blendColor[2]=L.blendColor[2],n.bs.blendColor[3]=L.blendColor[3]);var I=L.targets[0],F=n.bs.targets[0];F.blend!==I.blend&&(I.blend?i.enable(i.BLEND):i.disable(i.BLEND),F.blend=I.blend),F.blendEq===I.blendEq&&F.blendAlphaEq===I.blendAlphaEq||(i.blendEquationSeparate(g$[I.blendEq],g$[I.blendAlphaEq]),F.blendEq=I.blendEq,F.blendAlphaEq=I.blendAlphaEq),F.blendSrc===I.blendSrc&&F.blendDst===I.blendDst&&F.blendSrcAlpha===I.blendSrcAlpha&&F.blendDstAlpha===I.blendDstAlpha||(i.blendFuncSeparate(b$[I.blendSrc],b$[I.blendDst],b$[I.blendSrcAlpha],b$[I.blendDstAlpha]),F.blendSrc=I.blendSrc,F.blendDst=I.blendDst,F.blendSrcAlpha=I.blendSrcAlpha,F.blendDstAlpha=I.blendDstAlpha),F.blendColorMask!==I.blendColorMask&&(i.colorMask((I.blendColorMask&po.R)!==po.NONE,(I.blendColorMask&po.G)!==po.NONE,(I.blendColorMask&po.B)!==po.NONE,(I.blendColorMask&po.A)!==po.NONE),F.blendColorMask=I.blendColorMask)}}if(k.gpuBindingLayout&&c){var P=k.gpuBindingLayout.gpuBindings,D=Array.isArray(P),z=0;for(P=D?P:P[Symbol.iterator]();;){var B;if(D){if(z>=P.length)break;B=P[z++]}else{if((z=P.next()).done)break;B=z.value}var N=B;switch(N.type){case Io.UNIFORM_BUFFER:if(N.gpuBuffer&&N.gpuBuffer.buffer){var U=null,G=c.glBlocks,V=Array.isArray(G),H=0;for(G=V?G:G[Symbol.iterator]();;){var j;if(V){if(H>=G.length)break;j=G[H++]}else{if((H=G.next()).done)break;j=H.value}var W=j;if(W.binding===N.binding){U=W;break}}if(U&&N.gpuBuffer.vf32){var X=U.glActiveUniforms,q=Array.isArray(X),Y=0;for(X=q?X:X[Symbol.iterator]();;){var K;if(q){if(Y>=X.length)break;K=X[Y++]}else{if((Y=X.next()).done)break;K=Y.value}var Q=K;switch(Q.glType){case i.BOOL:case i.INT:for(var Z=0;Z<Q.array.length;++Z){var J=Q.begin+Z;if(N.gpuBuffer.vf32[J]!==Q.array[Z]){for(var $=Z,ee=Q.begin+Z;$<Q.array.length;++$,++ee)Q.array[$]=N.gpuBuffer.vf32[ee];i.uniform1iv(Q.glLoc,Q.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var te=0;te<Q.array.length;++te){var ie=Q.begin+te;if(N.gpuBuffer.vf32[ie]!==Q.array[te]){for(var ne=te,re=Q.begin+te;ne<Q.array.length;++ne,++re)Q.array[ne]=N.gpuBuffer.vf32[re];i.uniform2iv(Q.glLoc,Q.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var ae=0;ae<Q.array.length;++ae){var se=Q.begin+ae;if(N.gpuBuffer.vf32[se]!==Q.array[ae]){for(var oe=ae,le=Q.begin+ae;oe<Q.array.length;++oe,++le)Q.array[oe]=N.gpuBuffer.vf32[le];i.uniform3iv(Q.glLoc,Q.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var ce=0;ce<Q.array.length;++ce){var ue=Q.begin+ce;if(N.gpuBuffer.vf32[ue]!==Q.array[ce]){for(var he=ce,_e=Q.begin+ce;he<Q.array.length;++he,++_e)Q.array[he]=N.gpuBuffer.vf32[_e];i.uniform4iv(Q.glLoc,Q.array);break}}break;case i.FLOAT:for(var fe=0;fe<Q.array.length;++fe){var de=Q.begin+fe;if(N.gpuBuffer.vf32[de]!==Q.array[fe]){for(var pe=fe,me=Q.begin+fe;pe<Q.array.length;++pe,++me)Q.array[pe]=N.gpuBuffer.vf32[me];i.uniform1fv(Q.glLoc,Q.array);break}}break;case i.FLOAT_VEC2:for(var ve=0;ve<Q.array.length;++ve){var ye=Q.begin+ve;if(N.gpuBuffer.vf32[ye]!==Q.array[ve]){for(var ge=ve,be=Q.begin+ve;ge<Q.array.length;++ge,++be)Q.array[ge]=N.gpuBuffer.vf32[be];i.uniform2fv(Q.glLoc,Q.array);break}}break;case i.FLOAT_VEC3:for(var Se=0;Se<Q.array.length;++Se){var Te=Q.begin+Se;if(N.gpuBuffer.vf32[Te]!==Q.array[Se]){for(var xe=Se,Ee=Q.begin+Se;xe<Q.array.length;++xe,++Ee)Q.array[xe]=N.gpuBuffer.vf32[Ee];i.uniform3fv(Q.glLoc,Q.array);break}}break;case i.FLOAT_VEC4:for(var we=0;we<Q.array.length;++we){var Ae=Q.begin+we;if(N.gpuBuffer.vf32[Ae]!==Q.array[we]){for(var Ce=we,ke=Q.begin+we;Ce<Q.array.length;++Ce,++ke)Q.array[Ce]=N.gpuBuffer.vf32[ke];i.uniform4fv(Q.glLoc,Q.array);break}}break;case i.FLOAT_MAT2:for(var Re=0;Re<Q.array.length;++Re){var Oe=Q.begin+Re;if(N.gpuBuffer.vf32[Oe]!==Q.array[Re]){for(var Me=Re,Le=Q.begin+Re;Me<Q.array.length;++Me,++Le)Q.array[Me]=N.gpuBuffer.vf32[Le];i.uniformMatrix2fv(Q.glLoc,!1,Q.array);break}}break;case i.FLOAT_MAT3:for(var Ie=0;Ie<Q.array.length;++Ie){var Fe=Q.begin+Ie;if(N.gpuBuffer.vf32[Fe]!==Q.array[Ie]){for(var Pe=Ie,De=Q.begin+Ie;Pe<Q.array.length;++Pe,++De)Q.array[Pe]=N.gpuBuffer.vf32[De];i.uniformMatrix3fv(Q.glLoc,!1,Q.array);break}}break;case i.FLOAT_MAT4:for(var ze=0;ze<Q.array.length;++ze){var Be=Q.begin+ze;if(N.gpuBuffer.vf32[Be]!==Q.array[ze]){for(var Ne=ze,Ue=Q.begin+ze;Ne<Q.array.length;++Ne,++Ue)Q.array[Ne]=N.gpuBuffer.vf32[Ue];i.uniformMatrix4fv(Q.glLoc,!1,Q.array);break}}}}}}break;case Io.SAMPLER:if(N.gpuSampler){var Ge=null,Ve=c.glSamplers,He=Array.isArray(Ve),je=0;for(Ve=He?Ve:Ve[Symbol.iterator]();;){var We;if(He){if(je>=Ve.length)break;We=Ve[je++]}else{if((je=Ve.next()).done)break;We=je.value}var Xe=We;if(Xe.binding===N.binding){Ge=Xe;break}}if(Ge){var qe=Ge.units,Ye=Array.isArray(qe),Ke=0;for(qe=Ye?qe:qe[Symbol.iterator]();;){var Qe;if(Ye){if(Ke>=qe.length)break;Qe=qe[Ke++]}else{if((Ke=qe.next()).done)break;Qe=Ke.value}var Ze=Qe,Je=null;if(N.gpuTexView&&0<N.gpuTexView.gpuTexture.size){n.texUnit!==Ze&&(i.activeTexture(i.TEXTURE0+Ze),n.texUnit=Ze);var $e=N.gpuTexView.gpuTexture;switch(Ge.glType){case i.SAMPLER_2D:(Je=n.glTex2DUnits[Ze]).glTexture!==$e.glTexture&&($e.glTexture?i.bindTexture(i.TEXTURE_2D,$e.glTexture):i.bindTexture(i.TEXTURE_2D,e.nullTex2D.gpuTexture.glTexture),Je.glTexture=$e.glTexture);break;case i.SAMPLER_CUBE:(Je=n.glTexCubeUnits[Ze]).glTexture!==$e.glTexture&&($e.glTexture?i.bindTexture(i.TEXTURE_CUBE_MAP,$e.glTexture):i.bindTexture(i.TEXTURE_CUBE_MAP,e.nullTexCube.gpuTexture.glTexture),Je.glTexture=$e.glTexture);break;default:console.error("Unsupported GL Texture type.")}if(Je){var et=N.gpuSampler;s=$e.isPowerOf2?(a=et.glWrapS,et.glWrapT):(a=i.CLAMP_TO_EDGE,i.CLAMP_TO_EDGE),o=$e.isPowerOf2?et.glMinFilter:et.glMinFilter===i.LINEAR||et.glMinFilter===i.LINEAR_MIPMAP_NEAREST||et.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,$e.glWrapS!==a&&(i.texParameteri($e.glTarget,i.TEXTURE_WRAP_S,a),$e.glWrapS=a),$e.glWrapT!==s&&(i.texParameteri($e.glTarget,i.TEXTURE_WRAP_T,s),$e.glWrapT=s),$e.glMinFilter!==o&&(i.texParameteri($e.glTarget,i.TEXTURE_MIN_FILTER,o),$e.glMinFilter=o),$e.glMagFilter!==et.glMagFilter&&(i.texParameteri($e.glTarget,i.TEXTURE_MAG_FILTER,et.glMagFilter),$e.glMagFilter=et.glMagFilter)}}}}}else console.error("Not found sampler on binding unit "+N.binding)}}}if(k.gpuInputAssembler&&c&&(u||h!==k.gpuInputAssembler))if(h=k.gpuInputAssembler,e.useVAO){var tt=e.OES_vertex_array_object,it=h.glVAOs.get(c.glProgram);if(!it){it=tt.createVertexArrayOES(),h.glVAOs.set(c.glProgram,it),tt.bindVertexArrayOES(it),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);var nt=void 0,rt=c.glInputs,at=Array.isArray(rt),st=0;for(rt=at?rt:rt[Symbol.iterator]();;){var ot;if(at){if(st>=rt.length)break;ot=rt[st++]}else{if((st=rt.next()).done)break;ot=st.value}var lt=ot;nt=null;var ct=h.glAttribs,ut=Array.isArray(ct),ht=0;for(ct=ut?ct:ct[Symbol.iterator]();;){var _t;if(ut){if(ht>=ct.length)break;_t=ct[ht++]}else{if((ht=ct.next()).done)break;_t=ht.value}var ft=_t;if(ft.name===lt.name){nt=ft;break}}if(nt){n.glArrayBuffer!==nt.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,nt.glBuffer),n.glArrayBuffer=nt.glBuffer);for(var dt=0;dt<nt.componentCount;++dt){var pt=lt.glLoc+dt,mt=nt.offset+nt.size*dt;i.enableVertexAttribArray(pt),n.glCurrentAttribLocs[pt]=!0,i.vertexAttribPointer(pt,nt.count,nt.glType,nt.isNormalized,nt.stride,mt)}}}var vt=h.gpuIndexBuffer;vt&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,vt.glBuffer),tt.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==it&&(tt.bindVertexArrayOES(it),n.glVAO=it)}else{for(var yt=0;yt<e.maxVertexAttributes;++yt)n.glCurrentAttribLocs[yt]=!1;var gt=c.glInputs,bt=Array.isArray(gt),St=0;for(gt=bt?gt:gt[Symbol.iterator]();;){var Tt;if(bt){if(St>=gt.length)break;Tt=gt[St++]}else{if((St=gt.next()).done)break;Tt=St.value}var xt=Tt,Et=null,wt=h.glAttribs,At=Array.isArray(wt),Ct=0;for(wt=At?wt:wt[Symbol.iterator]();;){var kt;if(At){if(Ct>=wt.length)break;kt=wt[Ct++]}else{if((Ct=wt.next()).done)break;kt=Ct.value}var Rt=kt;if(Rt.name===xt.name){Et=Rt;break}}if(Et){n.glArrayBuffer!==Et.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,Et.glBuffer),n.glArrayBuffer=Et.glBuffer);for(var Ot=0;Ot<Et.componentCount;++Ot){var Mt=xt.glLoc+Ot,Lt=Et.offset+Et.size*Ot;!n.glEnabledAttribLocs[Mt]&&0<=Mt&&(i.enableVertexAttribArray(Mt),n.glEnabledAttribLocs[Mt]=!0),n.glCurrentAttribLocs[Mt]=!0,i.vertexAttribPointer(Mt,Et.count,Et.glType,Et.isNormalized,Et.stride,Lt)}}}var It=h.gpuIndexBuffer;It&&n.glElementArrayBuffer!==It.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,It.glBuffer),n.glElementArrayBuffer=It.glBuffer);for(var Ft=0;Ft<e.maxVertexAttributes;++Ft)n.glEnabledAttribLocs[Ft]!==n.glCurrentAttribLocs[Ft]&&(i.disableVertexAttribArray(Ft),n.glEnabledAttribLocs[Ft]=!1)}if(l){var Pt=l.dynamicStates,Dt=Array.isArray(Pt),zt=0;for(Pt=Dt?Pt:Pt[Symbol.iterator]();;){var Bt;if(Dt){if(zt>=Pt.length)break;Bt=Pt[zt++]}else{if((zt=Pt.next()).done)break;Bt=zt.value}switch(Bt){case Wo.VIEWPORT:k.viewport&&(n.viewport.left===k.viewport.left&&n.viewport.top===k.viewport.top&&n.viewport.width===k.viewport.width&&n.viewport.height===k.viewport.height||(i.viewport(k.viewport.left,k.viewport.top,k.viewport.width,k.viewport.height),n.viewport.left=k.viewport.left,n.viewport.top=k.viewport.top,n.viewport.width=k.viewport.width,n.viewport.height=k.viewport.height));break;case Wo.SCISSOR:k.scissor&&(n.scissorRect.x===k.scissor.x&&n.scissorRect.y===k.scissor.y&&n.scissorRect.width===k.scissor.width&&n.scissorRect.height===k.scissor.height||(i.scissor(k.scissor.x,k.scissor.y,k.scissor.width,k.scissor.height),n.scissorRect.x=k.scissor.x,n.scissorRect.y=k.scissor.y,n.scissorRect.width=k.scissor.width,n.scissorRect.height=k.scissor.height));break;case Wo.LINE_WIDTH:k.lineWidth&&n.rs.lineWidth!==k.lineWidth&&(i.lineWidth(k.lineWidth),n.rs.lineWidth=k.lineWidth);break;case Wo.DEPTH_BIAS:k.depthBias&&(n.rs.depthBias===k.depthBias.constantFactor&&n.rs.depthBiasSlop===k.depthBias.slopeFactor||(i.polygonOffset(k.depthBias.constantFactor,k.depthBias.slopeFactor),n.rs.depthBias=k.depthBias.constantFactor,n.rs.depthBiasSlop=k.depthBias.slopeFactor));break;case Wo.BLEND_CONSTANTS:k.blendConstants&&(n.bs.blendColor[0]===k.blendConstants[0]&&n.bs.blendColor[1]===k.blendConstants[1]&&n.bs.blendColor[2]===k.blendConstants[2]&&n.bs.blendColor[3]===k.blendConstants[3]||(i.blendColor(k.blendConstants[0],k.blendConstants[1],k.blendConstants[2],k.blendConstants[3]),n.bs.blendColor[0]=k.blendConstants[0],n.bs.blendColor[1]=k.blendConstants[1],n.bs.blendColor[2]=k.blendConstants[2],n.bs.blendColor[3]=k.blendConstants[3]));break;case Wo.STENCIL_WRITE_MASK:if(k.stencilWriteMask)switch(k.stencilWriteMask.face){case qo.FRONT:n.dss.stencilWriteMaskFront!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask);break;case qo.BACK:n.dss.stencilWriteMaskBack!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask);break;case qo.ALL:n.dss.stencilWriteMaskFront===k.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===k.stencilWriteMask.writeMask||(i.stencilMask(k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask)}break;case Wo.STENCIL_COMPARE_MASK:if(k.stencilCompareMask)switch(k.stencilCompareMask.face){case qo.FRONT:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,v$[n.dss.stencilFuncFront],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask);break;case qo.BACK:n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,v$[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask);break;case qo.ALL:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask&&n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFunc(v$[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask,n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask)}}}}break;case p$.DRAW:var Nt=t.drawCmds.array[p];if(h&&c)if(h.gpuIndirectBuffer){if(h.gpuIndirectBuffer){var Ut=h.gpuIndirectBuffer.indirects,Gt=Array.isArray(Ut),Vt=0;for(Ut=Gt?Ut:Ut[Symbol.iterator]();;){var Ht;if(Gt){if(Vt>=Ut.length)break;Ht=Ut[Vt++]}else{if((Vt=Ut.next()).done)break;Ht=Vt.value}var jt=Ht,Wt=h.gpuIndexBuffer;if(Wt&&-1<jt.indexCount){var Xt=jt.firstIndex*Wt.stride;i.drawElements(_,jt.indexCount,h.glIndexType,Xt)}else i.drawArrays(_,jt.firstVertex,jt.vertexCount)}}}else{var qt=h.gpuIndexBuffer;if(qt&&-1<Nt.drawInfo.indexCount){var Yt=Nt.drawInfo.firstIndex*qt.stride;i.drawElements(_,Nt.drawInfo.indexCount,h.glIndexType,Yt)}else i.drawArrays(_,Nt.drawInfo.firstVertex,Nt.drawInfo.vertexCount)}break;case p$.UPDATE_BUFFER:var Kt=t.updateBufferCmds.array[p];k$(e,Kt.gpuBuffer,Kt.buffer,Kt.offset,Kt.size);break;case p$.COPY_BUFFER_TO_TEXTURE:var Qt=t.copyBufferToTextureCmds.array[p];M$(e,[Qt.gpuBuffer.buffer],Qt.gpuTexture,Qt.regions)}}}function M$(e,t,i,n){var r=e.gl,a=0,s=0,o=1,l=1,c=0,u=rl[i.format],h=u.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var _=e.stateCache.glTex2DUnits[e.stateCache.texUnit];_.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_2D,i.glTexture),_.glTexture=i.glTexture);var f=n,d=Array.isArray(f),p=0;for(f=d?f:f[Symbol.iterator]();;){var m;if(d){if(p>=f.length)break;m=f[p++]}else{if((p=f.next()).done)break;m=p.value}var v=m;for(o=v.texExtent.width,l=v.texExtent.height,a=v.texSubres.baseMipLevel;a<v.texSubres.levelCount;++a){var y=u.type!==el.FLOAT||h?new Uint8Array(t[s++]):new Float32Array(t[s++]);h?i.glInternelFmt!==r$.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,a,v.texOffset.x,v.texOffset.y,o,l,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,a,i.glInternelFmt,o,l,0,y):r.texSubImage2D(r.TEXTURE_2D,a,v.texOffset.x,v.texOffset.y,o,l,i.glFormat,i.glType,y),o=Math.max(1,o>>1),l=Math.max(1,o>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];g.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,i.glTexture),g.glTexture=i.glTexture);var b=n,S=Array.isArray(b),T=0;for(b=S?b:b[Symbol.iterator]();;){var x;if(S){if(T>=b.length)break;x=b[T++]}else{if((T=b.next()).done)break;x=T.value}var E=x;s=0;var w=E.texSubres.baseArrayLayer+E.texSubres.layerCount;for(c=E.texSubres.baseArrayLayer;c<w;++c){o=E.texExtent.width,l=E.texExtent.height;var A=E.texSubres.baseMipLevel+E.texSubres.levelCount;for(a=E.texSubres.baseMipLevel;a<A;++a){var C=u.type!==el.FLOAT||h?new Uint8Array(t[s++]):new Float32Array(t[s++]);h?i.glInternelFmt!==r$.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,E.texOffset.x,E.texOffset.y,o,l,i.glFormat,C):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,i.glInternelFmt,o,l,0,C):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,E.texOffset.x,E.texOffset.y,o,l,i.glFormat,i.glType,C),o=Math.max(1,o>>1),l=Math.max(1,o>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Co.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var L$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuBuffer=null,t._uniformBuffer=null,t._indirectBuffer=null,t}return d(i,Mm),l(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),l(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._usage&qs.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&qs.UNIFORM&&0<this._size&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&qs.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&qs.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Ks.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&qs.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&qs.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&qs.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer))):(t.usage&qs.INDIRECT||t.usage&qs.TRANSFER_DST||t.usage&qs.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBuffer&&(function(e,t){t.glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._status=Gs.UNREADY}},{key:"resize",value:function(e){var t=this._size;this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,0<this._size&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Ks.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&qs.VERTEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&qs.INDEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&qs.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer)):(t.usage&qs.INDIRECT||t.usage&qs.TRANSFER_DST||t.usage&qs.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size))}},{key:"update",value:function(e,t,i){var n;n=void 0!==i?i:this._usage&qs.INDIRECT?0:e.byteLength,k$(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),I$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.COMMAND_ALLOCATOR)))._device=void 0,t._device=e,t}return d(i,$o),i}(),F$=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new qx(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return l(n,[{key:"alloc",value:function(e){return new e}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),P$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new F$(T$,16),t.bindStatesCmdPool=new F$(x$,16),t.drawCmdPool=new F$(E$,16),t.updateBufferCmdPool=new F$(w$,16),t.copyBufferToTextureCmdPool=new F$(A$,16),t}return d(i,I$),l(i,[{key:"initialize",value:function(e){return this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Gs.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),D$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).cmdPackage=new C$,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return d(i,Lm),l(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=Gs.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=Gs.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(T$);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i,s.clearColors.length=n.length;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(p$.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===Po.PRIMARY&&this._isInRenderPass||this._type===Po.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(E$);if(e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(p$.DRAW),++this._numDrawCalls,this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e.indexCount/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(e.indexCount-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===Po.PRIMARY&&!this._isInRenderPass||this._type===Po.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(w$);if(a){var s;s=void 0!==n?n:e.usage&qs.INDIRECT?0:t.byteLength;var o=t;a.gpuBuffer=r,a.buffer=o,a.offset=void 0!==i?i:0,a.size=s,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(p$.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===Po.PRIMARY&&!this._isInRenderPass||this._type===Po.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(A$);s&&(s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(p$.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var c=n.cmdPackage.drawCmds.array[l];++c.refCount,this.cmdPackage.drawCmds.push(c)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var f=n.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(x$);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(p$.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),z$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuFramebuffer=null,t}return d(i,Im),l(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),l(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=rl[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)switch(c){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:e.isOffscreen,glFramebuffer:null};return this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._isOffscreen&&this._gpuFramebuffer&&function(e,t){t.glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)}(this._device,this._gpuFramebuffer),this._gpuFramebuffer=null,this._status=Gs.UNREADY}}]),i}(),B$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuInputAssembler=null,t}return d(i,Cg),l(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),l(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=l$(a.format,i),c=rl[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:c,count:rl[a.format].count,stride:o.stride,componentCount:d$(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=c}}(this._device,this._gpuInputAssembler),this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.OES_vertex_array_object.deleteVertexArrayOES(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=Gs.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),N$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuPipelineLayout=null,t}return d(i,kg),l(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),l(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Gs.UNREADY}}]),i}(),U$=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],G$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuPipelineState=null,t}return d(i,Fg),l(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),l(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.is,this._rs=e.rs,this._dss=e.dss,this._bs=e.bs,this._dynamicStates=e.dynamicStates||[],this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:U$[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rs,dss:e.dss,bs:e.bs,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=Gs.UNREADY}}]),i}(),V$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return d(i,Pg),l(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Gs.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;O$(this._device,s.cmdPackage),this.numDrawCalls+=s.numDrawCalls,this.numTris+=s.numTris}}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),H$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuRenderPass=null,t}return d(i,Dg),l(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),l(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=Gs.UNREADY}}]),i}(),j$=[10497,33648,33071,33071],W$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuSampler=null,t._state=new zg,t}return d(i,Bg),l(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===vo.LINEAR||n===vo.ANISOTROPIC?a===vo.LINEAR||a===vo.ANISOTROPIC?9987:a===vo.POINT?9985:9729:a===vo.LINEAR||a===vo.ANISOTROPIC?9986:a===vo.POINT?9984:9728,i=r===vo.LINEAR||r===vo.ANISOTROPIC?9729:9728;var s=j$[this._state.addressU],o=j$[this._state.addressV],l=j$[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:s,glWrapT:o,glWrapR:l},this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=Gs.UNREADY}}]),i}(),X$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuShader=null,t}return d(i,Ng),l(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){var s=e.gl,t=function(){if(l){if(c>=o.length)return"break";u=o[c++]}else{if((c=o.next()).done)return"break";u=c.value}var e=u,t=0,i="",n=1;switch(e.type){case Mo.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case Mo.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);if(r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),!s.getShaderParameter(e.glShader,s.COMPILE_STATUS)))return console.error(i+" in '"+a.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null,{v:void 0}},o=a.gpuStages,l=Array.isArray(o),c=0;e:for(o=l?o:o[Symbol.iterator]();;){var u,i=t();switch(i){case"break":break e;default:if("object"===fe(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),_=0;for(r=h?r:r[Symbol.iterator]();;){var f;if(h){if(_>=r.length)break;f=r[_++]}else{if((_=r.next()).done)break;f=_.value}var d=f;s.attachShader(a.glProgram,d.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS)){console.info("Shader '"+a.name+"' compilation successed.");var p=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(p);for(var m=0;m<p;++m){var v=s.getActiveAttrib(a.glProgram,m);if(v){var y=void 0,g=v.name.indexOf("[");y=-1!==g?v.name.substr(0,g):v.name;var b=s.getAttribLocation(a.glProgram,y),S=_$(v.type,s),T=f$(v.type,s);a.glInputs[m]={binding:b,name:y,type:S,stride:T,count:v.size,size:T*v.size,glType:v.type,glLoc:b}}}if(0<a.blocks.length){a.glBlocks=new Array(a.blocks.length);for(var x=0;x<a.blocks.length;++x){var E=a.blocks[x],w={binding:E.binding,name:E.name,size:0,glUniforms:new Array(E.members.length),glActiveUniforms:[],isUniformPackage:!0};a.glBlocks[x]=w;for(var A=0;A<E.members.length;++A){var C=E.members[A],k=h$(C.type,s),R=f$(k,s),O=R*C.count,M=w.size/4,L=new Array(O/4);L.fill(0),w.glUniforms[A]={binding:-1,name:C.name,type:C.type,stride:R,count:C.count,size:O,offset:w.size,glType:k,glLoc:-1,array:L,begin:M},w.size+=O}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var I=0;I<a.samplers.length;++I){var F=a.samplers[I];a.glSamplers[I]={binding:F.binding,name:F.name,type:F.type,units:[],glType:h$(F.type,s),glLoc:-1}}}for(var P=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),D=0,z=[],B=0;B<P;++B){var N=s.getActiveUniform(a.glProgram,B);if(N){var U=s.getUniformLocation(a.glProgram,N.name);if(U){var G=void 0,V=N.name.indexOf("[");if(G=-1!==V?N.name.substr(0,V):N.name,N.type===s.SAMPLER_2D||N.type===s.SAMPLER_CUBE){var H=a.glSamplers,j=Array.isArray(H),W=0;for(H=j?H:H[Symbol.iterator]();;){var X;if(j){if(W>=H.length)break;X=H[W++]}else{if((W=H.next()).done)break;X=W.value}var q=X;if(q.name===G){for(var Y=0;Y<N.size;++Y)q.units.push(D+Y);q.glLoc=U,D+=N.size,z.push(q);break}}}else{var K=a.glBlocks,Q=Array.isArray(K),Z=0;for(K=Q?K:K[Symbol.iterator]();;){var J;if(Q){if(Z>=K.length)break;J=K[Z++]}else{if((Z=K.next()).done)break;J=Z.value}var $=J,ee=$.glUniforms,te=Array.isArray(ee),ie=0;for(ee=te?ee:ee[Symbol.iterator]();;){var ne;if(te){if(ie>=ee.length)break;ne=ee[ie++]}else{if((ie=ee.next()).done)break;ne=ie.value}var re=ne;if(re.name===G){re.glLoc=U,$.glActiveUniforms.push(re);break}}}}}}}if(z.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);for(var ae=0,se=z;ae<se.length;ae++){var oe=se[ae];s.uniform1iv(oe.glLoc,oe.units)}}}else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var le=a.gpuStages,ce=Array.isArray(le),ue=0;for(le=ce?le:le[Symbol.iterator]();;){var he;if(ce){if(ue>=le.length)break;he=le[ue++]}else{if((ue=le.next()).done)break;he=ue.value}var _e=he;_e.glShader&&(s.deleteShader(_e.glShader),_e.glShader=null)}}}}(this._device,this._gpuShader),this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=Gs.UNREADY}}]),i}(),q$=function e(){y(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTex2DUnits=void 0,this.glTexCubeUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTex2DUnits=new Array(16),this.glTexCubeUnits=new Array(16),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Rg,this.dss=new Og,this.bs=new Lg,this.glEnabledAttribLocs=new Array(16),this.glCurrentAttribLocs=new Array(16),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<16;++t)this.glTex2DUnits[t]={glTexture:null},this.glTexCubeUnits[t]={glTexture:null}};function Y$(e){return 0<e&&0==(e&e-1)}var K$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuTexture=null,t}return d(i,Ug),l(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=Y$(this._width)&&Y$(this._height),this._size=sl(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&Co.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case So.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?Ro.TV1D:Ro.TV1D_ARRAY:Ro.TV1D;break;case So.TEX2D:var i=Co.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?Ro.TV2D:i&Co.CUBEMAP?Ro.CUBE:Ro.TV2D_ARRAY:Ro.TV2D;break;case So.TEX3D:t=Ro.TV3D;break;default:t=Ro.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;switch(t.glInternelFmt=c$(t.format,i),t.glFormat=u$(t.format,i),t.glType=l$(t.format,i),t.viewType){case Ro.TV2D:if(t.viewType=Ro.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===wo.X1){var n=i.createTexture();if(n&&0<t.size){t.glTexture=n;var r=e.stateCache.glTex2DUnits[e.stateCache.texUnit];r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture);var a=t.width,s=t.height;if(rl[t.format].isCompressed)if(t.glInternelFmt!==r$.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=al(t.format,a,s,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,a,s,0,c),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}else{var u=al(t.format,2,2,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,h)}else for(var _=0;_<t.mipLevel;++_)i.texImage2D(i.TEXTURE_2D,_,t.glInternelFmt,a,s,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),s=Math.max(1,s>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case Ro.CUBE:t.viewType=Ro.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var f=i.createTexture();if(f&&0<t.size){t.glTexture=f;var d=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),d.glTexture=t.glTexture),rl[t.format].isCompressed)if(t.glInternelFmt!==r$.COMPRESSED_RGB_ETC1_WEBGL)for(var p=0;p<6;++p)for(var m=t.width,v=t.height,y=0;y<t.mipLevel;++y){var g=al(t.format,m,v,1),b=new Uint8Array(g);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+p,y,t.glInternelFmt,m,v,0,b),m=Math.max(1,m>>1),v=Math.max(1,v>>1)}else for(var S=0;S<6;++S){var T=al(t.format,2,2,1),x=new Uint8Array(T);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+S,0,t.glInternelFmt,2,2,0,x)}else for(var E=0;E<6;++E)for(var w=t.width,A=t.height,C=0;C<t.mipLevel;++C)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+E,C,t.glInternelFmt,w,A,0,t.glFormat,t.glType,null),w=Math.max(1,w>>1),A=Math.max(1,A>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Ro.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTexture&&(function(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=Gs.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=sl(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;switch(t.glInternelFmt=c$(t.format,i),t.glFormat=u$(t.format,i),t.glType=l$(t.format,i),t.viewType){case Ro.TV2D:if(t.viewType=Ro.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===wo.X1){var n=e.stateCache.glTex2DUnits[e.stateCache.texUnit];n.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),n.glTexture=t.glTexture);var r=t.width,a=t.height;if(rl[t.format].isCompressed){if(t.glInternelFmt!==r$.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var o=al(t.format,r,a,1),l=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternelFmt,r,a,0,l),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,r,a,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}break;case Ro.CUBE:t.viewType=Ro.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var u=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),u.glTexture=t.glTexture),rl[t.format].isCompressed){if(t.glInternelFmt!==r$.COMPRESSED_RGB_ETC1_WEBGL)for(var h=0;h<6;++h)for(var _=t.width,f=t.height,d=0;d<t.mipLevel;++d){var p=al(t.format,_,f,1),m=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+h,d,t.glInternelFmt,_,f,0,m),_=Math.max(1,_>>1),f=Math.max(1,f>>1)}}else for(var v=0;v<6;++v)for(var y=t.width,g=t.height,b=0;b<t.mipLevel;++b)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,b,t.glInternelFmt,y,g,0,t.glFormat,t.glType,null),y=Math.max(1,y>>1),g=Math.max(1,g>>1);break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Ro.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=Gs.UNREADY}}]),i}(),Q$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuTextureView=null,t}return d(i,Om),l(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),l(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=Gs.UNREADY}}]),i}(),Z$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Ns.WINDOW)))._device=void 0,t._title="",t._left=0,t._top=0,t._width=0,t._height=0,t._nativeWidth=0,t._nativeHeight=0,t._colorFmt=Zt.GFXFormat.UNKNOWN,t._depthStencilFmt=Zt.GFXFormat.UNKNOWN,t._isOffscreen=!1,t._renderPass=null,t._colorTex=null,t._colorTexView=null,t._depthStencilTex=null,t._depthStencilTexView=null,t._framebuffer=null,t._device=e,t}return d(i,$o),l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),i}(),J$=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return d(t,Z$),l(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:zo.CLEAR,storeOp:No.STORE,sampleCount:1,beginLayout:Go.COLOR_ATTACHMENT_OPTIMAL,endLayout:Go.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:zo.CLEAR,depthStoreOp:No.STORE,stencilLoadOp:zo.CLEAR,stencilStoreOp:No.STORE,sampleCount:1,beginLayout:Go.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Go.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==Zt.GFXFormat.UNKNOWN&&(this._colorTex=this._device.createTexture({type:So.TEX2D,usage:xo.COLOR_ATTACHMENT|xo.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Co.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:Ro.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==Zt.GFXFormat.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:So.TEX2D,usage:xo.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Co.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Ro.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=Gs.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=Gs.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Ro.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:Ro.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),$$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).stateCache=new q$,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return d(t,Rl),l(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),l(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=ml.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=Zt.GFXFormat.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Zt.GFXFormat.D24S8:this._depthStencilFmt=Zt.GFXFormat.D24:8===this._stencilBits?this._depthStencilFmt=Zt.GFXFormat.D16S8:this._depthStencilFmt=Zt.GFXFormat.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[yl.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[yl.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[yl.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[yl.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[yl.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[yl.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[yl.FORMAT_D24S8]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[yl.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[yl.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[yl.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[yl.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[yl.FORMAT_ASTC]=!0,l+="astc "),this._features[yl.MSAA]=!1,this._OES_vertex_array_object&&(this._useVAO=!1),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:Ko.GRAPHICS}),this._mainWindow=this.createWindow({title:this._webGLRC.canvas.title,left:this._webGLRC.canvas.offsetLeft,top:this._webGLRC.canvas.offsetTop,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new K$(this),this.nullTex2D.initialize({type:So.TEX2D,usage:xo.SAMPLED,format:Zt.GFXFormat.RGBA8,width:2,height:2,flags:Co.GEN_MIPMAP}),this.nullTexCube=new K$(this),this.nullTexCube.initialize({type:So.TEX2D,usage:xo.SAMPLED,format:Zt.GFXFormat.RGBA8,width:2,height:2,arrayLayer:6,flags:Co.CUBEMAP|Co.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},u=new Uint8Array(this.nullTex2D.size);return u.fill(0),this.copyBuffersToTexture([u],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new L$(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new K$(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new Q$(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new W$(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new o$(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new X$(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new B$(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new H$(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new z$(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new N$(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new G$(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new P$(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new D$(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new V$(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new J$(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){M$(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=0,s=0,o=0;switch(i.glTarget){case r.TEXTURE_2D:var l=e.stateCache.glTex2DUnits[e.stateCache.texUnit];l.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_2D,i.glTexture),l.glTexture=i.glTexture);var c=n,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var _;if(u){if(h>=c.length)break;_=c[h++]}else{if((h=c.next()).done)break;_=h.value}var f=_;for(a=f.texSubres.baseMipLevel;a<f.texSubres.levelCount;++a)r.texSubImage2D(r.TEXTURE_2D,a,f.texOffset.x,f.texOffset.y,i.glFormat,i.glType,t[s++])}break;case r.TEXTURE_CUBE_MAP:var d=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];d.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,i.glTexture),d.glTexture=i.glTexture);var p=n,m=Array.isArray(p),v=0;for(p=m?p:p[Symbol.iterator]();;){var y;if(m){if(v>=p.length)break;y=p[v++]}else{if((v=p.next()).done)break;y=v.value}var g=y,b=g.texSubres.baseArrayLayer+g.texSubres.layerCount;for(o=g.texSubres.baseArrayLayer;o<b;++o){var S=g.texSubres.baseMipLevel+g.texSubres.levelCount;for(a=g.texSubres.baseMipLevel;a<S;++a)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,g.texOffset.x,g.texOffset.y,i.glFormat,i.glType,t[s++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Co.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u,_=h.buffOffset+h.buffTexHeight*h.buffStride,f=h.texExtent.width,d=h.texExtent.height,p=al(Zt.GFXFormat.RGBA8,f,d,1),m=s.subarray(_,_+p);n.readPixels(h.texOffset.x,h.texOffset.y,f,d,n.RGBA,n.UNSIGNED_BYTE,m)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGLRC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();return cc.WebGLGFXDevice=$$,Zt.AffineTransform=Yn,Zt.AnimCurve=tZ,Zt.AnimationClip=PZ,Zt.AnimationComponent=gJ,Zt.AnimationManager=BZ,Zt.AnimationState=QZ,Zt.Asset=es,Zt.AssetLibrary=Kh,Zt.AvatarModelComponent=uH,Zt.AvatarUnit=oH,Zt.BaseNode=W_,Zt.BatchedSkinningModelComponent=pH,Zt.BillboardComponent=xH,Zt.BitmapFont=__,Zt.BlockInputEventsComponent=qS,Zt.ButtonComponent=JA,Zt.CCBoolean=Ut,Zt.CCClass=vi,Zt.CCFloat=Nt,Zt.CCInteger=Bt,Zt.CCObject=Ha,Zt.CCString=Gt,Zt.CameraComponent=yH,Zt.CanvasComponent=dT,Zt.CanvasPool=VC,Zt.CircularPool=Hy,Zt.Color=or,Zt.Component=R_,Zt.ComponentModifier=yZ,Zt.CubicSplineNumberValue=nJ,Zt.CubicSplineQuatValue=iJ,Zt.CubicSplineVec2Value=$Z,Zt.CubicSplineVec3Value=eJ,Zt.CubicSplineVec4Value=tJ,Zt.CurveValueAdapter=nZ,Zt.Downloader=eu,Zt.EditBoxComponent=_R,Zt.EffectAsset=wm,Zt.Enum=kt,Zt.Event=ot,Zt.EventAcceleration=vr,Zt.EventHandler=OS,Zt.EventInfo=iZ,Zt.EventKeyboard=yr,Zt.EventMouse=pr,Zt.EventTarget=st,Zt.EventTouch=mr,Zt.FixedArray=jy,Zt.Font=t_,Zt.GraphicsComponent=lO,Zt.HierachyModifier=vZ,Zt.HtmlTextParser=up,Zt.ICurveInstance=jZ,Zt.ImageAsset=Ol,Zt.JavaScript=Ms,Zt.JsonAsset=Rh,Zt.LabelAtlas=A_,Zt.LabelComponent=QC,Zt.LabelOutlineComponent=nM,Zt.Layers=lf,Zt.LayoutComponent=YR,Zt.LightComponent=bH,Zt.LineComponent=DH,Zt.LinkedArray=Wy,Zt.Loader=Iu,Zt.LoadingItems=sc,Zt.MaskComponent=LO,Zt.Mat3=un,Zt.Mat4=Nn,Zt.Material=zb,Zt.Mesh=Dm,Zt.MeshBuffer=KB,Zt.MissingScript=IS,Zt.ModelComponent=rH,Zt.Node=xf,Zt.NodeActivator=ep,Zt.NodePool=oQ,Zt.PageViewComponent=wF,Zt.PageViewIndicatorComponent=vF,Zt.ParticleSystemComponent=zK,Zt.PhysicsMaterial=Hb,Zt.Pipeline=hc,Zt.Pool=Ze,Zt.Prefab=Rs,Zt.PrefabInfo=hp,Zt.PrivateNode=Rd,Zt.Profiler=rQ,Zt.ProgressBarComponent=zO,Zt.Quat=vn,Zt.RatioSampler=eZ,Zt.RawAsset=Ja,Zt.Rect=er,Zt.RecyclePool=Qp,Zt.RenderTexture=ph,Zt.RenderableComponent=RS,Zt.RichTextComponent=TM,Zt.Scene=Ad,Zt.SceneAsset=zs,Zt.Script=Os,Zt.ScrollBarComponent=MM,Zt.ScrollViewComponent=wL,Zt.Size=Kn,Zt.SkeletalAnimationClip=RJ,Zt.SkeletalAnimationComponent=t$,Zt.SkeletalAnimationState=qJ,Zt.Skeleton=Vb,Zt.SkinningModelComponent=aH,Zt.SkinningModelUnit=dH,Zt.SliderComponent=zL,Zt.Socket=YJ,Zt.SpriteAtlas=Eh,Zt.SpriteComponent=ZA,Zt.SpriteFrame=bh,Zt.StencilManager=yB,Zt.SystemEvent=Zr,Zt.TTFFont=u_,Zt.TextAsset=kh,Zt.Texture2D=fh,Zt.ToggleComponent=JL,Zt.ToggleContainerComponent=QL,Zt.Touch=Nr,Zt.TrivialTexture=oh,Zt.TypeScript=Ds,Zt.TypedArrayPool=Qy,Zt.UIComponent=LT,Zt.UIModelComponent=iI,Zt.UIRenderComponent=_x,Zt.UIReorderComponent=DI,Zt.UITransformComponent=cT,Zt.UIVertexFormat=vP,Zt.UniformCurveValueAdapter=i$,Zt.ValueType=Si,Zt.Vec2=Ui,Zt.Vec3=Xi,Zt.Vec4=$i,Zt.ViewGroupComponent=tL,Zt.WebviewComponent=SI,Zt.WidgetComponent=px,Zt._decorator=Ua,Zt.barFilled=AB,Zt.bezier=BQ,Zt.bezierByTime=WQ,Zt.bmfont=QD,Zt.builtinResMgr=cb,Zt.cclegacy=n$,Zt.computeRatioByType=aZ,Zt.deserialize=ou,Zt.easing=zQ,Zt.effects=ob,Zt.eventManager=kr,Zt.find=Cd,Zt.fragmentText=yu,Zt.geometry=og,Zt.getPathFromRoot=AJ,Zt.getWorldTransformUntilRoot=CJ,Zt.graphics=mD,Zt.graphicsAssembler=vD,Zt.instantiate=pp,Zt.isCustomTargetModifier=mZ,Zt.isElementModifier=pZ,Zt.isPropertyModifier=dZ,Zt.isUnicodeCJK=pu,Zt.isUnicodeSpace=mu,Zt.js=Qe,Zt.labelAssembler=vB,Zt.letter=Bz,Zt.loader=Zu,Zt.macro=Rr,Zt.mask=bB,Zt.maskEnd=SB,Zt.math=dr,Zt.misc=Ct,Zt.path=re,Zt.primitives=Ww,Zt.profiler=aQ,Zt.radialFilled=NB,Zt.renderer=pP,Zt.safeMeasureText=vu,Zt.sampleAnimationCurve=rZ,Zt.screen=Rp,Zt.setDefaultLogTimes=function(e){0<e&&(hr=e)},Zt.simple=VB,Zt.sliced=WB,Zt.spriteAssembler=YB,Zt.systemEvent=Jr,Zt.textureUtil=ah,Zt.ttf=dB,Zt.url=Zl,Zt.utils=Ag,Zt.vmath=lQ,Zt.widgetManager=Ix,Zt}({});
